import{c as zt,h as bs,i as ys,r as a,p as gs,d as vs,s as Cs,e as Ns,a as ws,b as js,u as Ds,f as oe,g as Kt,k as Ke,l as ka,n as jt,o as Dt,j as e,m as U,B as ve}from"./index-SThGP-UZ.js";import{N as Na,P as wa,L as ja,C as Ss,a as Ms}from"./PostpartumExitDialog-DQiCXUxP.js";import{D as Fs,A as Da}from"./DataEntryForm-C6Jv8bxR.js";import{D as ks}from"./DeletionDialog-C6up7S7T.js";import{u as Is,i as Ia,D as mt,a as ft,b as At,c as Bt,d as Sa,e as Rt}from"./useCycleData-DQN_kvv9.js";import{c as Ts,u as Es,C as Ps}from"./useFertilityChart-D6sn-E8m.js";import{c as $s,g as Os}from"./computePeakStatuses-DuBnmQQE.js";import{L as _t,I as Lt}from"./label-vmCeSukg.js";import{l as qt}from"./badge-NjDKYZGp.js";import{C as Qt,a as As,P as Bs}from"./useBackClose-B75B8Nzp.js";import"./peak-mode-button-DESZS8hz.js";import"./eye-DAicHzhc.js";const Ma=zt("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]),Rs=zt("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),Fa=zt("CheckCircle2",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),_s=zt("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]);function Ls(){!bs.current&&ys();const[p]=a.useState(gs.current);return p}const zs="metrics",Vs="summary",Gt=async(p,i)=>{if(!p||!i||typeof i!="object")throw new Error("A valid userId and data object are required to save metrics.");const k=vs(Ns,`users/${p}/${zs}`,Vs);await Cs(k,i,{merge:!0})},Zt=20;function Us({cycleCount:p,deduction:i}){return typeof i=="number"&&Number.isFinite(i)?i:(typeof p=="number"&&Number.isFinite(p)?p:0)>=12?20:21}function Hs({computedCpmData:p,cpmSelection:i,isManualCpm:k,manualCpmBaseValue:$,manualCpmValue:_e,formatNumber:q}){const _=typeof p.shortestCycle?.duration=="number"&&Number.isFinite(p.shortestCycle.duration)?p.shortestCycle.duration:null,Ce=typeof p.value=="number"&&Number.isFinite(p.value)?p.value:null,K=k&&i==="manual",O=i==="auto",le=i==="none",D=K?$:O?_:null,ie=K?_e:O?Ce:null,ae=q(D,{maximumFractionDigits:0}),G=q(ie,{maximumFractionDigits:2}),Ne=`Ciclo más corto: ${ae??"—"}`,Le=`CPM = ${G??"—"}`;let X="Sin datos disponibles",B=!0;if(typeof ie=="number"&&Number.isFinite(ie)){if(K)typeof $=="number"&&Number.isFinite($)?(X=`${q($,{maximumFractionDigits:0})??`${$}`} − ${Zt}`,B=!1):(X="Valor definido manualmente",B=!0);else if(O&&typeof _=="number"&&Number.isFinite(_)){const ce=Us({cycleCount:p.cycleCount??0,deduction:p.deduction});X=`${q(_,{maximumFractionDigits:0})??`${_}`} − ${ce}`,B=!1}}return(typeof ie!="number"||!Number.isFinite(ie))&&(X="Sin datos disponibles",B=!0),{title:"CPM",baseText:Ne,finalText:Le,microCopy:X,microCopyMuted:B,modeLabel:le?"Sin usar":K?"Manual":"Auto",microCopyId:"cpm-metric-microcopy",baseValue:D,finalValue:ie,baseFormatted:ae,finalFormatted:G,isManual:K}}function Ws({computedT8Data:p,t8Selection:i,isManualT8:k,manualT8BaseValue:$,manualT8Value:_e,formatNumber:q}){const _=typeof p.earliestCycle?.riseDay=="number"&&Number.isFinite(p.earliestCycle.riseDay)?p.earliestCycle.riseDay:null,Ce=typeof p.value=="number"&&Number.isFinite(p.value)?p.value:null,K=p&&typeof p.canCompute=="boolean"?p.canCompute:!0,O=k&&i==="manual",le=i==="auto"&&K,D=i==="none",ie=O?$:le?_:null,ae=O?_e:le?Ce:null,G=q(ie,{maximumFractionDigits:0}),Ne=q(ae,{maximumFractionDigits:0}),Le=`Día de subida: ${G??"—"}`,X=`T-8 = ${Ne??"—"}`;let B="Sin datos disponibles",de=!0;return typeof ae=="number"&&Number.isFinite(ae)&&(O?typeof $=="number"&&Number.isFinite($)?(B=`${q($,{maximumFractionDigits:0})??`${$}`} − 8`,de=!1):(B="Valor definido manualmente",de=!0):le&&typeof _=="number"&&Number.isFinite(_)&&(B=`${q(_,{maximumFractionDigits:0})??`${_}`} − 8`,de=!1)),(typeof ae!="number"||!Number.isFinite(ae))&&(B="Sin datos disponibles",de=!0),{title:"T-8",baseText:Le,finalText:X,microCopy:B,microCopyMuted:de,modeLabel:D?"Sin usar":O?"Manual":"Auto",microCopyId:"t8-metric-microcopy",baseValue:ie,finalValue:ae,baseFormatted:G,finalFormatted:Ne,isManual:O}}const Js=({cycleData:p,onEdit:i,onTogglePeak:k,currentPeakIsoDate:$,onEditStartDate:_e=()=>{},handleOpenCpmDialog:q=()=>{},handleOpenT8Dialog:_=()=>{},cpmMetric:Ce={},t8Metric:K={}})=>{const O=p.records||[],[le,D]=a.useState(null),[ie,ae]=a.useState({clientX:0,clientY:0}),[G,Ne]=a.useState(!1),[Le,X]=a.useState(!1),[B,de]=a.useState([]),ce=a.useRef(!0),we=a.useRef(null),Oe=a.useRef(null),qe=a.useRef(new Map),pt=a.useRef(null),me=Ls(),y=p.startDate?oe(p.startDate):null,E=Dt(new Date),Y=a.useMemo(()=>$s(O),[O]);a.useEffect(()=>{const n=qe.current,u=new Map,m=[];O.forEach(x=>{if(!x)return;let h=x.cycleDay;if(!h&&y&&x.isoDate)try{h=jt(oe(x.isoDate),y)+1}catch{h=null}if(!h)return;const T=JSON.stringify({temp:x.displayTemperature??x.temperature_chart??null,symbol:x.fertility_symbol??null,sensation:x.mucus_sensation??x.mucusSensation??"",appearance:x.mucus_appearance??x.mucusAppearance??"",observations:x.observations??"",relations:x.had_relations??x.hadRelations??!1,updatedAt:x.updatedAt??x.timestamp??null});if(u.set(h,T),n.size>0){const j=n.get(h);(!j||j!==T)&&m.push(h)}}),qe.current=u,!me&&m.length&&de(x=>{const h=new Set(x),T=h.size;return m.forEach(j=>h.add(j)),h.size===T?x:Array.from(h)})},[y,me,O]),a.useEffect(()=>{if(me||B.length===0)return;const n=setTimeout(()=>{de([])},1400);return pt.current=n,()=>{pt.current&&clearTimeout(pt.current)}},[me,B]);const Q=28,Fe=140,H=Fe+15,se=H*2,je=a.useMemo(()=>{const n=O.reduce((u,m)=>{const x=m?.cycleDay??null;if(x)return Math.max(u,x);if(!y||!m?.isoDate)return u;try{const h=oe(m.isoDate),T=jt(h,y)+1;return Number.isFinite(T)?Math.max(u,T):u}catch(h){return console.error("Error calculating record day for wheel:",h),u}},0);return Math.max(p.currentDay,n,Q)},[p.currentDay,O,y,Q]),W=Math.max(je-Q,0),S=W>0,Ie=a.useMemo(()=>S?Math.max(0,Math.min(Math.max(p.currentDay-Q,0),W)):0,[p.currentDay,S,W,Q]),[I,Z]=a.useState(Ie);a.useEffect(()=>{ce.current||(ce.current=!0)},[Ie,I]),a.useEffect(()=>{if(!S){ce.current=!0,Z(0);return}Z(n=>{const u=Math.min(n,W),m=Math.max(0,Math.min(Math.max(p.currentDay-Q,0),W)),x=p.currentDay>=u+1&&p.currentDay<=u+Q;return ce.current?x?u!==n?u:n:m:(ce.current=!0,m)})},[S,W,p.currentDay,Q]);const Te=a.useCallback(n=>Math.max(0,Math.min(n,W)),[W]),A=a.useCallback(n=>{!S||n===0||Z(u=>Te(u+n))},[Te,S]),ee=a.useRef(0),R=a.useRef(0),fe=a.useCallback(n=>{!S||n===0||(R.current+=n,!ee.current&&(ee.current=requestAnimationFrame(()=>{const u=Math.sign(R.current);Z(m=>Te(m+u)),R.current=0,ee.current=0})))},[S,Te]),L=a.useCallback(n=>{if(!S)return;n.preventDefault();const u=Math.abs(n.deltaY)>Math.abs(n.deltaX)?n.deltaY:n.deltaX;u!==0&&fe(u>0?1:-1)},[A,S]),Ee=a.useCallback(n=>{S&&(we.current=n.touches?.[0]?.clientX??null)},[S]),te=a.useCallback(n=>{if(!S||we.current===null)return;const u=n.touches?.[0]?.clientX??null;if(u===null)return;const m=u-we.current;Math.abs(m)<24||(fe(m<0?1:-1),we.current=u)},[A,S]),Ge=a.useCallback(()=>{we.current=null},[]),z=a.useCallback(n=>({...Os(n),...n==="spot"?{pattern:"url(#spotting-pattern-dashboard)"}:{}}),[]),ze=a.useMemo(()=>O.reduce((n,u)=>{if(!u)return n;const m=Number(u.cycleDay);if(Number.isFinite(m)&&m>0)return n.has(m)||n.set(m,u),n;if(!y||!u.isoDate)return n;try{const x=oe(u.isoDate),h=jt(x,y)+1;Number.isFinite(h)&&h>0&&!n.has(h)&&n.set(h,{...u,cycleDay:h})}catch(x){console.error("Error mapping record by day for wheel:",x)}return n},new Map),[O,y]),St={main:"#b4a9b0",light:"#c1b6bd",glow:"rgba(212, 194, 206, 0.16)",border:"#c1b6bd"},Ft=Array.from({length:Q},(n,u)=>{const m=I+u+1,x=ze.get(m)??null,h=y?ka(y,m-1):null,T=h?Ke(h,"yyyy-MM-dd"):null,j=h?Ia(Dt(h),E):!1,ue=x?{...x,cycleDay:x.cycleDay??m}:null,V=(u+I)/Q*2*Math.PI-Math.PI/2,Ve=H+Fe*Math.cos(V),kt=H+Fe*Math.sin(V);let Be=m<=p.currentDay&&ue?z(ue.fertility_symbol):St;!ue&&m<p.currentDay?Be={main:"transparent",light:"transparent",glow:"rgba(180, 169, 176, 0.1)",border:"rgba(180, 169, 176, 0.4)"}:(j||m>p.currentDay)&&(Be={main:"transparent",light:"transparent",glow:"rgba(251, 192, 203, 0.1)",border:"rgba(252, 170, 185, 0.35)"});const It=m===p.currentDay;It&&(ue?Be={...z(ue.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:Be={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const Xe=T&&Y[T]||null;return{x:Ve,y:kt,day:m,colors:Be,isActive:m<=p.currentDay,isToday:It,hasRecord:!!ue,record:ue,isoDate:T,canShowPlaceholder:!!(!ue&&T&&!j),peakStatus:Xe}}),We=a.useMemo(()=>new Set(B),[B]),xt=I*360/Q,Qe=-xt*Math.PI/180,ht=Math.cos(Qe),Je=Math.sin(Qe),De=a.useCallback((n,u)=>{const m=n-H,x=u-H;return{x:H+m*ht-x*Je,y:H+m*Je+x*ht}},[H,ht,Je]),bt=2*Math.PI/Q,ne=-Math.PI/2-bt/2,Se=Fe-18,Pe=Fe+10,pe=H+Se*Math.cos(ne),Ae=H+Se*Math.sin(ne),xe=H+Pe*Math.cos(ne),Me=H+Pe*Math.sin(ne);a.useEffect(()=>{S&&D(null)},[I,S]);const Ze=(n,u)=>{if(u.stopPropagation(),!Oe.current){D(null);return}const m=Oe.current.getBoundingClientRect();let x,h;u.touches&&u.touches[0]?(x=u.touches[0].clientX,h=u.touches[0].clientY):(x=u.clientX,h=u.clientY);const T=n.canShowPlaceholder&&n.isoDate?{id:`placeholder-${n.isoDate}`,isoDate:n.isoDate,cycleDay:n.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:n.peakStatus,peak_marker:n.peakStatus==="P"?"peak":null}:null,j=n.record?{...n.record,cycleDay:n.record.cycleDay??n.day,peakStatus:n.peakStatus,peak_marker:n.record.peak_marker??(n.peakStatus==="P"?"peak":null)}:T;if(j&&$&&j.isoDate===$&&(j.peak_marker="peak",j.peakStatus=j.peakStatus||"P"),!j){D(null);return}ae({clientX:x-m.left,clientY:h-m.top}),D(j)};return a.useEffect(()=>{if(!le)return;const n=u=>{Oe.current&&!Oe.current.contains(u.target)&&D(null)};return document.addEventListener("mousedown",n),document.addEventListener("touchstart",n),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}},[le]),e.jsxs("div",{className:"relative flex flex-col space-y-4",children:[e.jsxs(U.div,{className:"relative overflow-hidden px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-titulo mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:_e,className:"inline-flex items-center gap-1.5 rounded-full bg-white/60 px-3 py-1.5 text-sm font-semibold text-subtitulo shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white",title:"Editar fecha de inicio del ciclo",children:[e.jsx(Ms,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(U.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.2,delay:.1},children:[e.jsxs("div",{className:"relative overflow-hidden rounded-[75px]   p-4  mb-4",children:[e.jsxs("div",{className:"pointer-events-none absolute inset-0",children:[e.jsx("div",{className:"absolute inset-0 "}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 h-1/2 "})]}),e.jsx("div",{className:"relative text-center flex-shrink-0",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(U.div,{ref:Oe,className:"relative inline-flex items-center justify-center mb-4 drop-shadow-[0_15px_35px_rgba(221,86,101,0.22)]",style:{width:se,height:se},initial:{opacity:0},animate:{opacity:1},transition:{duration:.18,ease:"easeOut"},onWheel:L,onTouchStart:Ee,onTouchMove:te,onTouchEnd:Ge,children:[e.jsxs("svg",{className:"w-full h-full wheel-no-tap",viewBox:`0 0 ${se} ${se}`,onClick:()=>D(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"78%",fx:"30%",fy:"20%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFE7E8",stopOpacity:"0.98"}),e.jsx("stop",{offset:"60%",stopColor:"#FFC0C1",stopOpacity:"0.95"}),e.jsx("stop",{offset:"100%",stopColor:"#FFB5B3",stopOpacity:"0.95"})]}),e.jsxs("filter",{id:"circleDepthShadow",children:[e.jsx("feDropShadow",{dx:"0",dy:"10",stdDeviation:"10",floodColor:"rgba(221,86,101,0.22)",floodOpacity:"1"}),e.jsx("feDropShadow",{dx:"0",dy:"4",stdDeviation:"4",floodColor:"rgba(221,86,101,0.18)",floodOpacity:"1"})]}),e.jsx("filter",{id:"dotShadow",x:"-30%",y:"-30%",width:"160%",height:"160%",colorInterpolationFilters:"sRGB",children:e.jsx("feDropShadow",{dx:"0",dy:"0.8",stdDeviation:"0.8",floodColor:"#000",floodOpacity:"0.22"})}),e.jsx("filter",{id:"whiteSymbolShadow",children:e.jsx("feDropShadow",{dx:"0",dy:"0.5",stdDeviation:"0.8",floodColor:"rgba(189,16,44,0.3)"})}),e.jsx("filter",{id:"activePointHighlight",children:e.jsx("feDropShadow",{dx:"0",dy:"-1",stdDeviation:"0.5",floodColor:"rgba(255,255,255,0.7)",floodOpacity:"1"})}),e.jsxs("filter",{id:"bevel",children:[e.jsx("feFlood",{floodColor:"rgba(255,255,255,0.4)",result:"top"}),e.jsx("feFlood",{floodColor:"rgba(0,0,0,0.2)",result:"bottom"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"top"}),e.jsx("feMergeNode",{in:"bottom"}),e.jsx("feMergeNode",{})]})]})]}),e.jsx("circle",{cx:H,cy:H,r:Fe-28,fill:"url(#ringGlow)",stroke:"rgba(255,225,228,0.8)",strokeWidth:1.2,filter:"url(#circleDepthShadow)"}),S&&e.jsx("line",{x1:pe,y1:Ae,x2:xe,y2:Me,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(U.g,{transition:{type:"tween",duration:.18,ease:[.2,.8,.2,1]},initial:!1,animate:ce.current?{rotate:-xt}:!1,style:{transformOrigin:"center",transformBox:"view-box",willChange:"transform"},children:Ft.map((n,u)=>e.jsxs("g",{children:[e.jsx("g",{filter:n.isActive?"url(#activePointHighlight)":n.isToday?"url(#bevel)":void 0,children:e.jsx(U.circle,{cx:n.x,cy:n.y,r:n.isToday?12:11,fill:n.colors.pattern||(n.isActive?n.colors.main:"rgba(255,255,255,0.001)"),stroke:n.colors.border&&n.colors.border!=="none"?n.colors.border:"rgba(255,255,255,0.3)",strokeWidth:n.colors.border&&n.colors.border!=="none"?n.isToday?2.2:1.2:0,filter:n.fertilitysymbol==="white"?"url(#whiteSymbolShadow)":n.isActive?"url(#dotShadow)":void 0,strokeLinecap:"round",onClick:m=>Ze(n,m),initial:!1,whileTap:me||!ce.current?void 0:{y:2,scale:.75,opacity:.95,transition:{duration:.08,ease:"easeOut"}},style:{cursor:"pointer"}})}),!me&&We.has(n.day)&&e.jsxs(U.g,{pointerEvents:"none",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{transformOrigin:`${n.x}px ${n.y}px`},children:[e.jsx(U.circle,{cx:n.x,cy:n.y-12,r:4,fill:n.colors.main,initial:{y:-18,scale:.5,opacity:0},animate:{y:[-18,0,2],scale:[.5,1.05,.8],opacity:[0,1,0]},transition:{duration:.6,ease:"easeOut",times:[0,.6,1]}}),e.jsx(U.circle,{cx:n.x,cy:n.y,r:n.isToday?12:10,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:2,fill:"none",initial:{scale:.5,opacity:.9},animate:{scale:1.4,opacity:0},transition:{duration:.55,ease:[.16,1,.3,1],delay:.05}}),e.jsx(U.circle,{cx:n.x,cy:n.y,r:n.isToday?14:12,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:1.5,fill:"none",initial:{scale:.6,opacity:.6},animate:{scale:1.9,opacity:0},transition:{duration:.9,ease:"easeOut",delay:.1}})]},`dot-splash-${n.day}`),n.isToday&&e.jsx("circle",{cx:n.x,cy:n.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}})]},u))}),Ft.map((n,u)=>{if(!n.peakStatus)return null;const{x:m,y:x}=De(n.x,n.y);return n.peakStatus==="P"?e.jsx("text",{x:m,y:x+4,textAnchor:"middle",fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none"},children:"✖"}):e.jsx("text",{x:m,y:x+4,textAnchor:"middle",fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:n.peakStatus})})]}),le&&e.jsx("div",{onClick:n=>n.stopPropagation(),children:e.jsx(Ps,{point:le,position:ie,chartWidth:Oe.current?.clientWidth||0,chartHeight:Oe.current?.clientHeight||0,onEdit:i,onClose:()=>D(null),onTogglePeak:k,currentPeakIsoDate:$})}),e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:e.jsxs(U.div,{className:"flex flex-col items-center gap-2",initial:{opacity:0},animate:{opacity:1},transition:{duration:.1,delay:.1,ease:"easeOut"},children:[e.jsx("div",{className:"flex items-center justify-center ",children:e.jsx("p",{className:"text-6xl font-semibold text-fertiliapp-fuerte leading-none",children:p.currentDay})}),e.jsx("p",{className:"mt-1 text-[15px] font-medium uppercase tracking-wide text-fertiliapp-fuerte",children:"DÍA DEL CICLO"})]})})]}),S&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full text-fertiliapp-fuerte shadow-xs transition hover:border hover:bg-fertiliapp-fuerte/20",onClick:()=>A(-1),disabled:I===0,children:e.jsx(As,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-fertiliapp-fuerte",children:["Día ",I+1]}),e.jsx("span",{className:"text-xs text-fertiliapp-fuerte",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-fertiliapp-fuerte",children:["Día ",Math.min(I+Q,je)]})]}),e.jsx("input",{type:"range",min:0,max:W,value:I,onChange:n=>Z(Te(Number(n.target.value))),className:"w-40 range-fertiliapp"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full text-fertiliapp-fuerte shadow-xs transition hover:border hover:bg-fertiliapp-fuerte/20",onClick:()=>fe(1),disabled:I===W,children:e.jsx(Qt,{className:"w-4 h-4"})})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0 items-start",children:[e.jsxs(U.div,{className:`relative overflow-hidden rounded-3xl bg-white/60 border border-secundario-suave shadow-[0_14px_35px_rgba(148,163,184,0.18)] backdrop-blur-md p-1 transition-[width] duration-300 ease-in-out mx-auto ${G?"w-full":"w-[80%]"}`,initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.2,delay:.1},children:[e.jsxs("button",{type:"button",onClick:()=>Ne(n=>!n),className:"group flex w-full items-center justify-between gap-3 rounded-2xl px-3 py-2 text-left transition",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-700 tracking-tight uppercase",children:"SÍMBOLOS"}),e.jsx("div",{className:"absolute top-4.5 right-4 w-1.5 h-1.5 bg-secundario rounded-full"})]}),e.jsx(Da,{initial:!1,children:G&&e.jsx(U.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},className:"grid grid-cols-2 gap-2.5 rounded-3xl bg-white/40 p-2 overflow-hidden",children:[{label:"Menstrual",color:"#fb7185"},{label:"Moco (Fértil)",color:"#fdf5f8",stroke:"#fb7185"},{label:"Seco",color:"#67C5A4"},{label:"Moco (No fértil)",color:"#F7B944"},{label:"Spotting",color:"#fb7185",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(n=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[n.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-5 h-5 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-5 h-5 rounded-full border ${n.pattern?"pattern-bg":""}`,style:{backgroundColor:n.color,borderColor:n.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${n.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:n.label})]},n.label))},"symbols")})]}),e.jsxs(U.div,{className:`relative overflow-hidden rounded-3xl bg-white/60 border border-secundario-suave shadow-[0_14px_35px_rgba(148,163,184,0.18)] backdrop-blur-md p-1 transition-[width] duration-300 ease-in-out mx-auto ${Le?"w-full":"w-[80%]"}`,initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.2,delay:.1},children:[e.jsxs("button",{type:"button",onClick:()=>X(n=>!n),className:"group flex w-full items-center justify-between gap-3 rounded-2xl px-3 py-2 text-left transition",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-800 tracking-tight uppercase",children:"CÁLCULO"}),e.jsx("div",{className:"absolute top-4.5 right-4 w-1.5 h-1.5 bg-secundario rounded-full"})]}),e.jsx(Da,{initial:!1,children:Le&&e.jsxs(U.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},className:"grid grid-cols-2 gap-2.5 rounded-3xl bg-white/40 p-2 overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:q,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (Ciclo más corto)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"Ciclo más corto"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:Ce?.baseFormatted??"—"})})]}),e.jsxs("button",{type:"button",onClick:q,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (resultado)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"CPM"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:Ce?.finalFormatted??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:Ce?.modeLabel??"Auto"})]}),e.jsxs("button",{type:"button",onClick:_,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (Día de subida)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"Día de subida"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:K?.baseFormatted??"—"})})]}),e.jsxs("button",{type:"button",onClick:_,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (resultado)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"T-8"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:K?.finalFormatted??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:K?.modeLabel??"Auto"})]})]},"calc-card")})]})]})]})]})},Xs=({onAddRecord:p,onAddCycle:i})=>{const[k,$]=a.useState(!1);return e.jsxs("div",{className:"fixed right-4 top-12 md:top-6 flex flex-col-reverse items-end space-y-2 z-50",children:[k&&e.jsxs("div",{className:"flex flex-col space-y-2 mt-1",children:[e.jsxs(U.button,{onClick:p,className:"flex items-center gap-1 px-4 h-10 rounded-full bg-fertiliapp-fuerte hover:brightness-50 text-white/90 shadow-sm shadow-[#DD5665]",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(244, 114, 182, 0.28))"},children:[e.jsx(_s,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]}),e.jsxs(U.button,{onClick:i,className:"flex items-center gap-3 px-4 h-10 rounded-full bg-white/80 hover:brightness-50 text-fertiliapp-fuerte shadow-sm shadow-[#DD5665]",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(244, 114, 182, 0.2))"},children:[e.jsx(Rs,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]})]}),e.jsx(U.button,{onClick:()=>$(!k),className:"flex items-center justify-center rounded-full bg-white/80 border border-fertiliapp-fuerte text-fertiliapp-fuerte hover:brightness-95 shadow-sm shadow-[#5BA9B8] w-12 h-12 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300 focus-visible:ring-offset-2",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 4px 12px rgba(221, 86, 101, 0.35))"},children:e.jsx(U.span,{animate:{rotate:k?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(Bs,{className:"h-5 w-5"})})})]})},on=()=>{const p=ws(),{currentCycle:i,archivedCycles:k,addOrUpdateDataPoint:$,startNewCycle:_e,isLoading:q,updateCycleDates:_,checkCycleOverlap:Ce,refreshData:K,setCycleIgnoreForAutoCalculations:O,undoCurrentCycle:le}=Is(),{toast:D}=js(),[ie,ae]=a.useState(!1),[G,Ne]=a.useState(()=>i?.startDate||""),[Le,X]=a.useState(""),[B,de]=a.useState(null),[ce,we]=a.useState(null),[Oe,qe]=a.useState(!1),[pt,me]=a.useState(!1),{user:y,preferences:E,savePreferences:Y}=Ds(),[Q,Fe]=a.useState(!1),[ke,H]=a.useState(""),[se,je]=a.useState(""),[W,S]=a.useState(""),[Ie,I]=a.useState(""),[Z,Te]=a.useState(null),[A,ee]=a.useState(null),[R,fe]=a.useState(null),[L,Ee]=a.useState(!1),[te,Ge]=a.useState("auto"),[z,ze]=a.useState("auto"),[St,Mt]=a.useState(!1),[Ft,We]=a.useState(!1),[xt,Qe]=a.useState(!1),[ht,Je]=a.useState(!1),[De,bt]=a.useState(""),[ne,Se]=a.useState(""),[Pe,pe]=a.useState(""),[Ae,xe]=a.useState(""),[Me,Ze]=a.useState(null),[n,u]=a.useState(null),[m,x]=a.useState(null),[h,T]=a.useState(!1),[j,ue]=a.useState("auto"),[V,Ve]=a.useState("auto"),[kt,Be]=a.useState(!1),[It,Xe]=a.useState(!1),[ea,Vt]=a.useState(!1),[ta,aa]=a.useState([]),[Ta,Ut]=a.useState(!1),[Ht,sa]=a.useState(!1),et=a.useRef(!1),tt=a.useRef(!1),Wt=a.useRef(null),na=a.useRef(!1),ra=a.useRef(!1),he=a.useMemo(()=>y?.uid?`rnf_manual_cpm_${y.uid}`:null,[y?.uid]),be=a.useMemo(()=>y?.uid?`rnf_manual_cpm_base_${y.uid}`:null,[y?.uid]),ye=a.useMemo(()=>y?.uid?`rnf_manual_t8_${y.uid}`:null,[y?.uid]),ge=a.useMemo(()=>y?.uid?`rnf_manual_t8_base_${y.uid}`:null,[y?.uid]),at=a.useMemo(()=>{if(!i?.id||i?.endDate||!i?.startDate)return null;const t=oe(i.startDate);if(!Kt(t))return null;const s=Ke(ka(t,-1),"yyyy-MM-dd"),o=k.filter(r=>r?.endDate===s);return o.length?o.sort((r,c)=>(c.startDate||"").localeCompare(r.startDate||""))[0]:null},[k,i]),Jt=a.useMemo(()=>{if(!at?.startDate||!at?.endDate)return"";const t=oe(at.startDate),s=oe(at.endDate);if(!Kt(t)||!Kt(s))return"";const o=r=>Ke(r,"dd MMM yy",{locale:qt}).replace(".","");return`${o(t)} - ${o(s)}`},[at]),Ea=a.useMemo(()=>`¿Quieres unir el ciclo actual al ciclo anterior${Jt?` (${Jt})`:""}? Esta acción no se puede deshacer.`,[Jt]),yt=a.useCallback(async t=>{if(!(!y?.uid||!Y)&&["auto","manual","none"].includes(t))try{await Y({cpmMode:t})}catch(s){console.error("Failed to persist CPM mode",s)}},[Y,y?.uid]),gt=a.useCallback(async t=>{if(!(!y?.uid||!Y)&&["auto","manual","none"].includes(t))try{await Y({t8Mode:t})}catch(s){console.error("Failed to persist T-8 mode",s)}},[Y,y?.uid]);a.useEffect(()=>{et.current=!1},[he]),a.useEffect(()=>{tt.current=!1},[ye]),a.useEffect(()=>{if(!be){ee(null);return}const t=E?.manualCpmBase;if(t!==void 0){if(typeof t=="number"&&Number.isFinite(t)){if(ee(t),typeof window<"u")try{localStorage.setItem(be,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual CPM base value to local storage",s)}}else if(ee(null),typeof window<"u")try{localStorage.removeItem(be)}catch(s){console.error("Failed to clear manual CPM base value from local storage",s)}return}if(!(typeof window>"u"))try{const s=localStorage.getItem(be);if(s){const o=JSON.parse(s);o&&typeof o.value=="number"&&Number.isFinite(o.value)?ee(o.value):ee(null)}else ee(null)}catch(s){console.error("Failed to restore manual CPM base value from local storage",s)}},[be,E?.manualCpmBase]),a.useEffect(()=>{if(!ge){u(null);return}const t=E?.manualT8Base;if(t!==void 0){if(typeof t=="number"&&Number.isFinite(t)){if(u(t),typeof window<"u")try{localStorage.setItem(ge,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual T-8 base value to local storage",s)}}else if(u(null),typeof window<"u")try{localStorage.removeItem(ge)}catch(s){console.error("Failed to clear manual T-8 base value from local storage",s)}return}if(!(typeof window>"u"))try{const s=localStorage.getItem(ge);if(s){const o=JSON.parse(s);o&&typeof o.value=="number"&&Number.isFinite(o.value)?u(o.value):u(null)}else u(null)}catch(s){console.error("Failed to restore manual T-8 base value from local storage",s)}},[ge,E?.manualT8Base]);const st=a.useCallback(async({finalValue:t,baseValue:s})=>{if(!y?.uid||!Y)return;const o=t==null?null:Number(t),r=s===void 0?void 0:s==null?null:Number(s),c={manualCpm:o};r!==void 0&&(c.manualCpmBase=r);try{await Y(c),he&&typeof window<"u"&&(c.manualCpm===null?localStorage.removeItem(he):localStorage.setItem(he,JSON.stringify({value:c.manualCpm}))),r!==void 0&&be&&typeof window<"u"&&(r===null?localStorage.removeItem(be):localStorage.setItem(be,JSON.stringify({value:r}))),await Gt(y.uid,{manual:{cpm:{value:o,base:r===void 0?A:r}},manualUpdatedAt:new Date().toISOString()})}catch(l){throw console.error("Failed to persist manual CPM value in profile",l),l}},[be,A,he,Y,y?.uid]),nt=a.useCallback(async({finalValue:t,baseValue:s})=>{if(!y?.uid||!Y)return;const o=t==null?null:Number(t),r=s===void 0?void 0:s==null?null:Number(s),c={manualT8:o};r!==void 0&&(c.manualT8Base=r);try{await Y(c),ye&&typeof window<"u"&&(c.manualT8===null?localStorage.removeItem(ye):localStorage.setItem(ye,JSON.stringify({value:c.manualT8}))),r!==void 0&&ge&&typeof window<"u"&&(r===null?localStorage.removeItem(ge):localStorage.setItem(ge,JSON.stringify({value:r}))),await Gt(y.uid,{manual:{t8:{value:o,riseDay:r===void 0?n:r}},manualUpdatedAt:new Date().toISOString()})}catch(l){throw console.error("Failed to persist manual T-8 value in profile",l),l}},[ge,n,ye,Y,y?.uid]);a.useEffect(()=>{if(!he){fe(null),Ee(!1),et.current=!1;return}const t=E?.manualCpm;if(typeof t=="number"&&Number.isFinite(t)){if(fe(t),Ee(!0),typeof window<"u")try{localStorage.setItem(he,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual CPM value to local storage",s)}return}if(t===null&&(fe(null),Ee(!1),typeof window<"u"))try{localStorage.removeItem(he)}catch(s){console.error("Failed to clear manual CPM value from local storage",s)}},[he,E?.manualCpm]),a.useEffect(()=>{if(!ye){x(null),T(!1),tt.current=!1;return}const t=E?.manualT8;if(typeof t=="number"&&Number.isFinite(t)){if(x(t),T(!0),typeof window<"u")try{localStorage.setItem(ye,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual T-8 value to local storage",s)}return}if(t===null&&(x(null),T(!1),typeof window<"u"))try{localStorage.removeItem(ye)}catch(s){console.error("Failed to clear manual T-8 value from local storage",s)}},[ye,E?.manualT8]),a.useEffect(()=>{if(!he||et.current||!y?.uid)return;if(E?.manualCpm!==void 0){et.current=!0;return}if(typeof window>"u"){et.current=!0;return}try{const s=localStorage.getItem(he);if(s){const o=JSON.parse(s);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){fe(o.value),Ee(!0);let r=A;try{if(be){const c=localStorage.getItem(be);if(c){const l=JSON.parse(c);l&&typeof l.value=="number"&&Number.isFinite(l.value)?r=l.value:r=null}}}catch(c){console.error("Failed to read manual CPM base value from local storage",c)}ee(typeof r=="number"&&Number.isFinite(r)?r:null),st({finalValue:o.value,baseValue:r}).catch(c=>console.error("Failed to migrate manual CPM value to profile storage",c))}}}catch(s){console.error("Failed to restore manual CPM value from local storage",s)}finally{et.current=!0}},[be,A,he,st,E?.manualCpm,y?.uid]),a.useEffect(()=>{if(!ye||tt.current||!y?.uid)return;if(E?.manualT8!==void 0){tt.current=!0;return}if(typeof window>"u"){tt.current=!0;return}try{const s=localStorage.getItem(ye);if(s){const o=JSON.parse(s);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){x(o.value),T(!0);let r=n;try{if(ge){const c=localStorage.getItem(ge);if(c){const l=JSON.parse(c);l&&typeof l.value=="number"&&Number.isFinite(l.value)?r=l.value:r=null}}}catch(c){console.error("Failed to read manual T-8 base value from local storage",c)}u(typeof r=="number"&&Number.isFinite(r)?r:null),nt({finalValue:o.value,baseValue:r}).catch(c=>console.error("Failed to migrate manual T-8 value to profile storage",c))}}}catch(s){console.error("Failed to restore manual T-8 value from local storage",s)}finally{tt.current=!0}},[ge,n,ye,nt,E?.manualT8,y?.uid]),a.useEffect(()=>{Ne(i?.startDate||"")},[i?.startDate]);const Xt=a.useCallback(t=>{if(!t?.startDate)return null;try{const s=oe(t.startDate);if(Number.isNaN(s.getTime()))return null;const o=Ke(s,"dd/MM/yyyy",{locale:qt});if(!t.endDate)return`${o} - En curso`;const r=oe(t.endDate);if(Number.isNaN(r.getTime()))return o;const c=Ke(r,"dd/MM/yyyy",{locale:qt});return`${o} - ${c}`}catch{return null}},[]),Tt=a.useMemo(()=>{const t=[];if(Array.isArray(k)&&k.length>0&&k.forEach((s,o)=>{const r=Xt(s);t.push({...s,displayName:s.name||r||`Ciclo archivado ${o+1}`,dateRangeLabel:r,source:"archived",ignoredForAutoCalculations:!!s.ignoredForAutoCalculations})}),i?.id){const s=Xt(i);t.push({...i,displayName:i.name||s||"Ciclo actual",dateRangeLabel:s,source:"current",ignoredForAutoCalculations:!!i.ignoredForAutoCalculations})}return t},[k,i,Xt]),N=a.useMemo(()=>{const o=[...Tt.map(d=>{if(!d.startDate||!d.endDate)return null;try{const w=oe(d.startDate),M=oe(d.endDate);if(Number.isNaN(w.getTime())||Number.isNaN(M.getTime())||Ia(w,M))return null;const f=jt(Dt(M),Dt(w))+1;return!Number.isFinite(f)||f<=0?null:{...d,duration:f,ignoredForAutoCalculations:!!d.ignoredForAutoCalculations}}catch(w){return console.error("Failed to compute cycle duration for CPM calculation",w),null}}).filter(Boolean)].sort((d,w)=>{const M=typeof d.duration=="number"&&Number.isFinite(d.duration)?d.duration:Number.POSITIVE_INFINITY,f=typeof w.duration=="number"&&Number.isFinite(w.duration)?w.duration:Number.POSITIVE_INFINITY;return M-f}).map(d=>{const w=!!d.ignoredForAutoCalculations;return{...d,isIgnored:w,isIncluded:!w}}),r=o.filter(d=>d.isIncluded),c=o.length-r.length,l=r.length;if(l<6)return{value:null,cycleCount:l,shortestCycle:null,deduction:null,canCompute:!1,cyclesConsidered:o,ignoredCount:c};const b=r[0]??null,C=l>=12?20:21,v=typeof b?.duration=="number"&&Number.isFinite(b.duration)?Math.max(1,b.duration-C):null;return{value:v,cycleCount:l,shortestCycle:b,deduction:C,canCompute:v!==null,cyclesConsidered:o,ignoredCount:c}},[Tt]),g=a.useMemo(()=>{const t=f=>{if(f==null||f==="")return null;const F=Number.parseFloat(String(f).replace(",","."));return Number.isFinite(F)?F:null},s=f=>{if(!f)return null;const F=t(f.temperature),P=t(f.temperature_corrected);return f.use_corrected&&P!==null?P:F!==null?F:P!==null?P:null},o=f=>{const F=[f?.temperature_chart,f?.temperature_raw,f?.temperature_corrected];for(const P of F){const re=t(P);if(re!==null)return re}if(Array.isArray(f?.measurements)){const re=f.measurements.find($e=>$e&&$e.selected&&s($e)!==null)||f.measurements.find($e=>s($e)!==null);if(re){const $e=s(re);if($e!==null)return $e}}return null},r=f=>{if(!f)return null;try{const F=oe(f);return Number.isNaN(F.getTime())?null:F}catch{return null}},c=Tt.filter(f=>f&&f.startDate&&Array.isArray(f.data)&&f.data.length>0).sort((f,F)=>{const P=r(f.startDate),re=r(F.startDate);return!P&&!re?0:P?re?re-P:-1:1}),l=[],b=[];for(const f of c){const F=f.data.filter(wt=>wt&&wt.isoDate).map(wt=>({...wt,displayTemperature:o(wt)}));if(F.length===0)continue;const{ovulationDetails:P}=Ts(F);if(!P?.confirmed)continue;const re=Number.isInteger(P?.ovulationIndex)?P.ovulationIndex:Number.isInteger(P?.confirmationIndex)?P.confirmationIndex:null;if(re==null||re<0||re>=F.length)continue;const $e=F[re],$t=Number($e?.cycleDay);if(!Number.isFinite($t)||$t<=0)continue;const hs=Math.max(1,$t-8),Ot=!!f.ignoredForAutoCalculations,Ca={cycleId:f.id,riseDay:$t,t8Day:hs,displayName:f.displayName||f.name||"Ciclo sin nombre",dateRangeLabel:f.dateRangeLabel,isIgnored:Ot,isIncluded:!Ot,ignoredForAutoCalculations:Ot};l.push(Ca),!Ot&&b.length<12&&b.push(Ca)}const C=b.length,v=l.reduce((f,F)=>f+(F.isIgnored?1:0),0);if(C===0)return{value:null,cycleCount:C,earliestCycle:null,cyclesConsidered:l,canCompute:!1,rawValue:null,ignoredCount:v};const d=b.reduce((f,F)=>F.t8Day<f.t8Day?F:f),w=d.t8Day,M=C>=6;return{value:M?w:null,cycleCount:C,earliestCycle:d,cyclesConsidered:l,canCompute:M,rawValue:w,ignoredCount:v}},[Tt]);a.useEffect(()=>{if(na.current||!E)return;let t=E?.cpmMode;["auto","manual","none"].includes(t)||(t=L?"manual":N.canCompute?"auto":"none"),Ge(t),ze(t),na.current=!0},[N.canCompute,L,E]),a.useEffect(()=>{if(ra.current||!E)return;let t=E?.t8Mode;["auto","manual","none"].includes(t)||(t=h?"manual":g.canCompute?"auto":"none"),ue(t),Ve(t),ra.current=!0},[g.canCompute,h,E]),a.useEffect(()=>{if(!y?.uid){Wt.current=null;return}const t=l=>typeof l=="number"&&Number.isFinite(l)?l:null,s=l=>l?{id:l.id??null,name:l.name??null,displayName:l.displayName??null,startDate:l.startDate??null,endDate:l.endDate??null,duration:t(l.duration),source:l.source??null,dateRangeLabel:l.dateRangeLabel??null}:null,o=l=>l?{id:l.id??null,name:l.name??null,displayName:l.displayName??null,startDate:l.startDate??null,endDate:l.endDate??null,riseDay:t(l.riseDay),t8Day:t(l.t8Day),source:l.source??null,dateRangeLabel:l.dateRangeLabel??null}:null,r={automatic:{cpm:{value:t(N?.value),cycleCount:t(N?.cycleCount)??0,ignoredCount:t(N?.ignoredCount)??0,deduction:t(N?.deduction),canCompute:!!N?.canCompute,shortestCycle:s(N?.shortestCycle)},t8:{value:t(g?.value),cycleCount:t(g?.cycleCount)??0,ignoredCount:t(g?.ignoredCount)??0,canCompute:!!g?.canCompute,riseDay:t(g?.earliestCycle?.riseDay),earliestCycle:o(g?.earliestCycle)}}},c=JSON.stringify(r);Wt.current!==c&&(Wt.current=c,Gt(y.uid,{...r,automaticUpdatedAt:new Date().toISOString()}).catch(l=>{console.error("Failed to persist automatic metrics snapshot",l)}))},[N,g,y?.uid]);const J=a.useMemo(()=>{const t=N.cycleCount??0,s=`${t} ciclo${t===1?"":"s"}`,o=6,r=["auto","manual","none"].includes(te)?te:"auto",c=r==="manual"&&L?"Manual":r==="auto"&&N.canCompute?"Automático":r==="none"?"Sin usar":"Automático",l=N.cyclesConsidered??[],b=!!N.canCompute,C=N.ignoredCount??0,v=typeof N.deduction=="number"&&Number.isFinite(N.deduction)?N.deduction:null,d=N.shortestCycle??null,w=typeof N.value=="number"&&Number.isFinite(N.value)?N.value:null;let M;if(t===0)M=C>0?"Todos los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos finalizados con fecha de finalización.";else if(!b)M=`Hay ${s} finalizado${t===1?"":"s"}. Se necesitan ${o} para calcular el CPM automáticamente.`,C>0&&(M+=` (${C} ciclo${C===1?"":"s"} ignorado${C===1?"":"s"}).`);else{const f=d?.dateRangeLabel||d?.displayName||d?.name||"Ciclo sin nombre",F=typeof d?.duration=="number"&&Number.isFinite(d.duration)?`${d.duration} días`:"duración desconocida",P=[`Calculado con ${s}.`,`Ciclo más corto: ${f} (${F}).`];v!==null&&P.push(`Deducción aplicada: ${v} días.`),w!==null&&P.push(`Resultado: ${w} días.`),C>0&&P.push(`${C} ciclo${C===1?"":"s"} ignorado${C===1?"":"s"}.`),M=P.join(" ")}return{sourceLabel:c,summary:M,highlightLabel:s,cycleCount:t,requiredCycles:o,canCompute:b,detailsAvailable:l.length>0,cycles:l,deduction:v,shortestCycle:d,value:w,ignoredCount:C}},[N,te,L]),Yt=a.useMemo(()=>{const t=g.cycleCount,s=`${t} ciclo${t===1?"":"s"}`,o=6,r=["auto","manual","none"].includes(j)?j:"auto",c=r==="manual"&&h?"Manual":r==="auto"&&g.canCompute?"Automático":r==="none"?"Sin usar":"Automático",l=g.ignoredCount??0,b=g.earliestCycle?.displayName||g.earliestCycle?.name||"Ciclo sin nombre",C=g.earliestCycle?.riseDay,v=typeof C=="number"&&Number.isFinite(C)?`Día ${C}`:"día desconocido",d=g.earliestCycle?.t8Day,w=typeof d=="number"&&Number.isFinite(d)?`T-8 Día ${d}`:null;let M;if(t===0)M=l>0?"Los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos con ovulación confirmada por temperatura.";else if(!g.canCompute)M=`Hay ${s} con ovulación confirmada por temperatura (se necesitan ${o}).`,l>0&&(M+=` ${l} ciclo${l===1?"":"s"} ignorado${l===1?"":"s"}.`);else{const f=[`${b} (${v}${w?` → ${w}`:""}).`];l>0&&f.push(`${l} ciclo${l===1?"":"s"} ignorado${l===1?"":"s"}.`),M=f.join(" ")}return{sourceLabel:c,summary:M,highlightLabel:s,cycleCount:t,requiredCycles:o,ignoredCount:l}},[g,h,j]),Ue=a.useCallback((t,s)=>typeof t!="number"||!Number.isFinite(t)?null:t.toLocaleString("es-ES",s),[]),Pa=a.useMemo(()=>Hs({computedCpmData:N,cpmSelection:te,isManualCpm:L,manualCpmBaseValue:A,manualCpmValue:R,formatNumber:Ue}),[N,te,Ue,L,A,R]),$a=a.useMemo(()=>Ws({computedT8Data:g,t8Selection:j,isManualT8:h,manualT8BaseValue:n,manualT8Value:m,formatNumber:Ue}),[g,Ue,h,n,m,j]),Oa=Ue(J.value,{maximumFractionDigits:1})??(typeof J.value=="number"&&Number.isFinite(J.value)?`${J.value}`:"—");Ue(R,{maximumFractionDigits:1})??(typeof R=="number"&&Number.isFinite(R)&&`${R}`);const oa=["auto","manual","none"].includes(te)?te:"auto",rt=oa==="manual"?L?"manual":"none":oa==="auto"?"auto":"none";rt==="manual"||rt==="auto"&&N.canCompute;const Aa=rt==="manual"?"Manual":rt==="auto"?"Automático":"Sin usar",Ba=Ue(g.value,{maximumFractionDigits:0})??(typeof g.value=="number"&&Number.isFinite(g.value)?`${g.value}`:"—");Ue(m,{maximumFractionDigits:0})??(typeof m=="number"&&Number.isFinite(m)&&`${m}`);const la=["auto","manual","none"].includes(j)?j:"auto",ot=la==="manual"?h?"manual":"none":la==="auto"?"auto":"none";ot==="manual"||ot==="auto"&&g.canCompute;const Ra=ot==="manual"?"Manual":ot==="auto"?"Automático":"Sin usar";a.useMemo(()=>Z||(se.trim()?"final":ke.trim()?"base":null),[ke,Z,se]);const ia=a.useMemo(()=>{if(z==="manual"){if(W||Ie)return!0;const t=ke.trim()!==""&&!W,s=se.trim()!==""&&!Ie;return!t&&!s}return!1},[z,W,ke,Ie,se]),_a=a.useMemo(()=>!!(L||ke.trim()||se.trim()),[L,ke,se]);a.useMemo(()=>Me||(ne.trim()?"final":De.trim()?"base":null),[De,Me,ne]);const ca=a.useMemo(()=>{if(V==="manual"){if(Pe||Ae)return!0;const t=De.trim()!==""&&!Pe,s=ne.trim()!==""&&!Ae;return!t&&!s}return!1},[Pe,De,Ae,ne,V]),La=a.useMemo(()=>!!(h||De.trim()||ne.trim()),[h,De,ne]),ua=a.useCallback(t=>{if(!t)return;const s=t.cycleId||t.id;if(s){if(i?.id&&s===i.id){p("/");return}p(`/cycle/${s}`)}},[i?.id,p]),da=a.useCallback(async(t,s)=>{if(t){aa(o=>o.includes(t)?o:[...o,t]);try{await O(t,s),D({title:s?"Ciclo ignorado":"Ciclo incluido",description:s?"El ciclo se excluyó del cálculo automático.":"El ciclo se volvió a incluir en el cálculo automático."})}catch{}finally{aa(o=>o.filter(r=>r!==t))}}},[O,D]),lt=a.useCallback((t,s)=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),s())},[]),za=a.useCallback(()=>{const t=typeof N.shortestCycle?.duration=="number"&&Number.isFinite(N.shortestCycle.duration)?N.shortestCycle.duration:null,s=typeof N.value=="number"&&Number.isFinite(N.value)?N.value:null,o=typeof A=="number"&&Number.isFinite(A),r=typeof R=="number"&&Number.isFinite(R),c=L&&o?A:t,l=L&&r?R:s;H(typeof c=="number"&&Number.isFinite(c)?String(c):""),je(typeof l=="number"&&Number.isFinite(l)?String(l):""),S(""),I(""),Te(null),ze(te),Mt(!1),Fe(!0)},[N,te,L,A,R]),Et=a.useCallback(()=>{Mt(!1),We(!1),Qe(!1),Fe(!1)},[]),Va=a.useCallback(t=>{const{value:s}=t.target;if(H(s),Te("base"),S(""),I(""),!s.trim()){je("");return}const o=Number.parseInt(s,10);if(!Number.isFinite(o)){S("El ciclo más corto debe ser ≥ 1"),je("");return}if(o<1){S("El día de subida debe ser ≥ 1"),je("");return}const r=Math.max(1,o-Zt);je(String(r))},[]),Ua=a.useCallback(t=>{const{value:s}=t.target;if(je(s),Te("final"),I(""),S(""),!s.trim())return;const o=s.replace(",","."),r=Number.parseFloat(o);if(!Number.isFinite(r)){I("Introduce un número válido.");return}if(r<1){I("El CPM debe ser ≥ 1");return}},[]),ma=a.useCallback(async()=>{if(W||Ie)return!1;const t=ke.trim(),s=se.trim(),o=Z??(s?"final":t?"base":null);if(!o)return I("Introduce un valor."),!1;let r=A,c;if(o==="base"){if(!t)return S("Introduce un número entero válido."),!1;const v=Number.parseInt(t,10);if(!Number.isFinite(v))return S("Introduce un número entero válido."),!1;const d=Math.max(1,v-Zt);r=v,c=d,je(String(d)),I("")}else{if(!s)return I("Introduce un valor."),!1;const v=s.replace(",","."),d=Number.parseFloat(v);if(!Number.isFinite(d)||d<1)return I("El CPM debe ser ≥ 1 día"),!1;if(c=d,!t)r=null;else{const w=Number.parseInt(t,10);if(!Number.isFinite(w)||w<1)return S("Introduce un número entero válido."),!1;r=w}}const l=R,b=L,C=A;fe(c),Ee(!0),ee(typeof r=="number"&&Number.isFinite(r)?r:null);try{return await st({finalValue:c,baseValue:r}),Fe(!1),D({title:"CPM actualizado",description:"El CPM manual se guardó en tu perfil."}),!0}catch(v){return console.error("Failed to save manual CPM value",v),fe(l),ee(C),Ee(b),I("No se pudo guardar el CPM. Inténtalo de nuevo."),!1}},[L,W,ke,A,Z,Ie,se,R,st,D]),fa=a.useCallback(async()=>{const t=R,s=L,o=A;fe(null),ee(null),Ee(!1),H(""),je(""),S(""),I(""),Te(null);try{await st({finalValue:null,baseValue:null}),D({title:"CPM borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(r){console.error("Failed to delete manual CPM value",r),fe(t),ee(o),Ee(s),I("No se pudo borrar el CPM. Inténtalo de nuevo.")}},[L,A,R,st,D]),Ha=a.useCallback(async()=>{Qe(!0);try{await fa(),We(!1);const t=J.canCompute?"auto":"none";Ge(t),ze(t),await yt(t)}finally{Qe(!1)}},[J.canCompute,fa,yt]),it=a.useCallback(t=>{ze(t)},[]),Wa=a.useCallback(async()=>{const t=z;if(t==="manual"){if(!await ma())return;Ge("manual"),ze("manual"),await yt("manual");return}const s=["auto","none"].includes(t)?t:"auto";Ge(s),ze(s),await yt(s),Et()},[z,Et,ma,yt]),Ja=a.useCallback(()=>{const t=typeof n=="number"&&Number.isFinite(n),s=typeof m=="number"&&Number.isFinite(m),o=h&&t?n:null,r=h&&s?m:null;bt(typeof o=="number"&&Number.isFinite(o)?String(o):""),Se(typeof r=="number"&&Number.isFinite(r)?String(r):""),pe(""),xe(""),Ze(null),Ve(j),Be(!1),Je(!0)},[h,n,m,j]),Pt=a.useCallback(()=>{Je(!1),Be(!1),Xe(!1),Vt(!1)},[]),Xa=a.useCallback(t=>{const{value:s}=t.target;if(bt(s),Ze("base"),pe(""),xe(""),!s.trim()){Se("");return}const o=Number.parseInt(s,10);if(!Number.isFinite(o)){pe("Introduce un número entero válido."),Se("");return}if(o<1){pe("Introduce un número entero válido."),Se("");return}const r=Math.max(1,o-8);Se(String(r))},[]),Ya=a.useCallback(t=>{const{value:s}=t.target;if(Se(s),Ze("final"),xe(""),pe(""),!s.trim())return;const o=Number.parseInt(s,10);(!Number.isFinite(o)||o<1)&&xe("El T-8 debe ser ≥ 1")},[]),pa=a.useCallback(async()=>{if(Pe||Ae)return!1;const t=De.trim(),s=ne.trim(),o=Me??(s?"final":t?"base":null);if(!o)return xe("Introduce un valor."),!1;let r=n,c;if(o==="base"){if(!t)return pe("Introduce un número entero válido."),!1;const v=Number.parseInt(t,10);if(!Number.isFinite(v)||v<1)return pe("Introduce un número entero válido."),!1;const d=Math.max(1,v-8);r=v,c=d,Se(String(d)),xe("")}else{if(!s)return xe("Introduce un valor."),!1;const v=Number.parseInt(s,10);if(!Number.isFinite(v)||v<1)return xe("El T-8 debe ser ≥ 1"),!1;if(c=v,!t)r=null;else{const d=Number.parseInt(t,10);if(!Number.isFinite(d)||d<1)return pe("Introduce un número entero válido."),!1;r=d}}const l=m,b=h,C=n;x(c),T(!0),u(typeof r=="number"&&Number.isFinite(r)?r:null);try{return await nt({finalValue:c,baseValue:r}),Je(!1),D({title:"T-8 actualizado",description:"El T-8 manual se guardó en tu perfil."}),!0}catch(v){return console.error("Failed to save manual T-8 value",v),x(l),u(C),T(b),xe("No se pudo guardar el T-8. Inténtalo de nuevo."),!1}},[h,Pe,De,n,Me,Ae,ne,m,nt,D]),xa=a.useCallback(async()=>{const t=m,s=h,o=n;x(null),u(null),T(!1),bt(""),Se(""),pe(""),xe(""),Ze(null);try{await nt({finalValue:null,baseValue:null}),D({title:"T-8 borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(r){console.error("Failed to delete manual T-8 value",r),x(t),u(o),T(s),pe("No se pudo borrar el T-8. Inténtalo de nuevo.")}},[h,n,m,nt,D]),Ka=a.useCallback(async()=>{Vt(!0);try{await xa(),Xe(!1);const t=g.canCompute?"auto":"none";ue(t),Ve(t),await gt(t)}finally{Vt(!1)}},[g.canCompute,xa,gt]),ct=a.useCallback(t=>{Ve(t)},[]),qa=a.useCallback(async()=>{const t=V;if(t==="manual"){if(!await pa())return;ue("manual"),Ve("manual"),await gt("manual");return}const s=["auto","none"].includes(t)?t:"auto";ue(s),Ve(s),await gt(s),Pt()},[Pt,pa,gt,V]),Re=a.useCallback(()=>{de(null),we(null),qe(!1)},[]),Ga=a.useCallback(()=>{Ne(i?.startDate||""),X(""),Re(),ae(!0)},[i?.startDate,Re]),He=a.useCallback(()=>{ae(!1),X(""),Re(),Ne(i?.startDate||"")},[i?.startDate,Re]),Qa=a.useCallback(async()=>{if(i?.id){sa(!0);try{await le(i.id),Ut(!1),He()}catch(t){console.error("Failed to undo cycle",t)}finally{sa(!1)}}},[i?.id,He,le]),Za=a.useCallback(()=>{Re()},[Re]),es=a.useCallback(async()=>{if(!G){X("La fecha de inicio es obligatoria");return}if(i?.id){X(""),me(!0);try{const t=Ce?await Ce(i.id,G):null;if(t){de(G),we(t),qe(!0),me(!1);return}await _(i.id,G),await K({silent:!0}),D({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),He()}catch(t){console.error("Error updating start date from dashboard:",t),X("No se pudo actualizar la fecha de inicio"),D({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{me(!1)}}},[G,i?.id,Ce,_,K,D,He]),ts=a.useCallback(async()=>{if(!i?.id||!B){Re();return}me(!0),qe(!1);try{await _(i.id,B),await K({silent:!0}),D({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),He()}catch(t){console.error("Error forcing start date from dashboard:",t),X("No se pudo actualizar la fecha de inicio"),D({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{me(!1),Re()}},[i?.id,B,_,K,D,He,Re]),[as,Ye]=a.useState(!1),[ss,ha]=a.useState(!1),[ba,ut]=a.useState(!1),[ya,vt]=a.useState(!1),[Ct,Nt]=a.useState(null),[ns,dt]=a.useState(null),rs=!!(Ct&&String(Ct.id||"").startsWith("placeholder-")),os=a.useMemo(()=>i?.data?.find(s=>s?.peak_marker==="peak")?.isoDate||null,[i?.data]),ga=a.useCallback(()=>{Ye(!1),Nt(null),dt(null)},[]),va=a.useCallback(async()=>{vt(!1),typeof Y=="function"&&await Y({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[Y]),ls=a.useCallback(t=>{Nt(t)},[]),is=a.useCallback((t,s=null)=>{Nt(t),dt(s??null),Ye(!0)},[]),cs=a.useCallback(async(t,s=!0)=>{if(!i?.id||!t?.isoDate)return;const o=c=>{if(c==null||c==="")return null;const l=parseFloat(String(c).replace(",","."));return Number.isFinite(l)?l:null},r=s??!(t.peak_marker==="peak"||t.peakStatus==="P");try{const c=t.timestamp?Ke(oe(t.timestamp),"HH:mm"):Ke(new Date,"HH:mm");let l=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:t.time??c,time_corrected:t.time_corrected??c,selected:!0,use_corrected:t.use_corrected??!1}];l.length===0&&(l=[{temperature:null,temperature_corrected:null,time:c,time_corrected:c,selected:!0,use_corrected:!1}]);const b=l.map((d,w)=>{const M=d.time||c,f=d.time_corrected||M;return{temperature:o(d.temperature??d.temperature_raw),time:M,selected:w===0?!0:!!d.selected,temperature_corrected:o(d.temperature_corrected),time_corrected:f,use_corrected:!!d.use_corrected}});b.some(d=>d.selected)||(b[0].selected=!0);const C={isoDate:t.isoDate,measurements:b,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",ignored:t.ignored??!1,peak_marker:r?"peak":null},v=t?.id&&!String(t.id).startsWith("placeholder-")?t:null;await $(C,v)}catch(c){console.error("Error toggling peak marker from dashboard:",c)}},[$,i?.id]),us=a.useMemo(()=>{if(!i?.startDate)return null;try{return jt(Dt(new Date),oe(i.startDate))+1}catch(t){return console.error("Error calculating current day:",t),null}},[i?.startDate]),ds=a.useMemo(()=>{const t=[],s=b=>["auto","manual","none"].includes(b)?b:"auto",o=(b,C,v)=>{const d=Number(C);if(!Number.isFinite(d)||d<0)return;const w=Number(v),M=Number.isFinite(w)&&w>0,f=M?b==="CPM"?`ciclo base: ${w}`:`base ${b}: ${w}`:null;t.push({source:b,day:Math.max(1,d),reason:f?`Manual desde dashboard (${f})`:"Manual desde dashboard",kind:"calculator",isManual:!0,manualBase:M?w:null})},r=(b,C,v)=>{if(!v)return;const d=Number(C);Number.isFinite(d)&&t.push({source:b,day:Math.max(1,d),reason:"Automático desde dashboard",kind:"calculator"})},c=s(te);c==="manual"?o("CPM",R,A):c==="auto"&&r("CPM",N?.value,N?.canCompute);const l=s(j);return l==="manual"?o("T8",m,n):l==="auto"&&r("T8",g?.value,g?.canCompute),t},[N?.canCompute,N?.value,g?.canCompute,g?.value,te,A,R,n,m,j]),ms=a.useMemo(()=>({calculators:{cpm:te!=="none",t8:j!=="none"}}),[te,j]),fs=a.useMemo(()=>{const t=[];return Array.isArray(k)&&k.length>0&&t.push(...k),i&&t.push(i),t},[k,i]);if(Es(i?.data??[],!1,"portrait",void 0,i?.id,5,!1,ms,fs,ds,!1),q&&!i?.id)return e.jsx("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:e.jsx("div",{className:"w-full rounded-3xl  p-4 text-center shadow-sm",children:e.jsx("p",{className:"text-sm font-semibold text-fertiliapp-fuerte",children:"Cargando..."})})});if(!i?.id)return e.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[e.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[e.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>ut(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),e.jsx(Na,{isOpen:ba,onClose:()=>ut(!1),onConfirm:async t=>{await _e(t),ut(!1),dt(null),Ye(!0),E?.fertilityStartConfig?.postpartum===!0&&vt(!0)},currentCycleRecords:i?.data??[]}),e.jsx(wa,{isOpen:ya,onClose:()=>vt(!1),onConfirm:va})]});if(!i?.startDate)return e.jsx("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:e.jsx("div",{className:"w-full rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:e.jsx("p",{className:"text-sm font-semibold text-slate-800",children:"Cargando..."})})});const ps=async(t,{keepFormOpen:s=!1}={})=>{ha(!0);try{await $(t,Ct),s||(Ye(!1),Nt(null),dt(null))}finally{ha(!1)}},xs=async t=>{await _e(t),ut(!1),dt(null),Ye(!0),E?.fertilityStartConfig?.postpartum===!0&&vt(!0)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mx-auto flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] w-full flex-col space-y-4 px-4 pb-10 pt-4",children:e.jsxs(U.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex flex-1 flex-col gap-3",children:[e.jsx(Js,{cycleData:{...i,currentDay:us,records:i.data},onEdit:is,onTogglePeak:cs,currentPeakIsoDate:os,onEditStartDate:Ga,handleOpenCpmDialog:za,handleOpenT8Dialog:Ja,cpmMetric:Pa,t8Metric:$a}),e.jsx(mt,{open:Q,onOpenChange:t=>{t||Et()},children:e.jsxs(ft,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col overflow-hidden rounded-3xl border border-rose-100 bg-white/95 p-0 text-gray-800 shadow-xl",children:[e.jsxs(At,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(Bt,{children:"Editar CPM"}),e.jsx(Sa,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${rt==="manual"||rt==="auto"?"bg-rose-100 text-rose-700":"bg-gray-100 text-gray-600"}`,children:Aa})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>it("auto"),onKeyDown:t=>lt(t,()=>it("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${z==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-fertiliapp-suave"} ${J.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:J.canCompute&&J.value!==null?`CPM automático: ${Oa} días`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${z==="auto"?"border-emerald-400 bg-emerald-400":"border-fertiliapp-suave bg-white"}`,children:z==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>Mt(t=>!t),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":St,children:J.highlightLabel})]}),J.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:J.summary}),!J.detailsAvailable&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."}),St&&J.detailsAvailable&&e.jsx("div",{className:"mt-2 space-y-2",children:J.cycles.length>0?e.jsx("ul",{className:"space-y-1",children:J.cycles.map((t,s)=>{const o=t.cycleId||t.id||`${t.displayName||t.name||t.startDate||"cycle"}-${s}`,r=typeof t.duration=="number"&&Number.isFinite(t.duration)?`${t.duration} días`:"duración desconocida",c=!!(J.shortestCycle&&J.shortestCycle===t),l=t.cycleId||t.id,b=!!(t.isIgnored||t.ignoredForAutoCalculations),C=l?ta.includes(l):!1,v=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${b?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/50"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${v} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>ua(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(Qt,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Duración: ",r]}),c&&e.jsx("span",{className:"rounded-full bg-rose-100 px-2 py-0.5 font-semibold text-rose-600",children:"Ciclo más corto"})]}),b&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(ve,{type:"button",variant:"outline",size:"xs",disabled:!l||C,onClick:()=>l&&da(l,!b),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:b?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":b?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":b,children:C?e.jsxs(e.Fragment,{children:[e.jsx(ja,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):b?e.jsx(Ma,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(Fa,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":z==="manual",onClick:()=>it("manual"),onKeyDown:t=>lt(t,()=>it("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${z==="manual"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${z==="manual"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:z==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_t,{htmlFor:"manual-cpm-base",className:"text-xs text-gray-600",children:"Ciclo más corto"}),e.jsx(Lt,{id:"manual-cpm-base",type:"number",inputMode:"numeric",step:"1",min:"1",value:ke,onChange:Va,placeholder:"Introduce un entero","aria-describedby":Z?"manual-cpm-helper":void 0}),W&&e.jsx("p",{className:"text-xs text-red-500",children:W})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_t,{htmlFor:"manual-cpm-final",className:"text-xs text-gray-600",children:"CPM obtenido"}),e.jsx(Lt,{id:"manual-cpm-final",type:"number",inputMode:"decimal",step:"0.1",min:"1",value:se,onChange:Ua,placeholder:"Introduce el valor","aria-describedby":Z?"manual-cpm-helper":void 0}),Ie&&e.jsx("p",{className:"text-xs text-red-500",children:Ie})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:[Z&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-cpm-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:Z==="base"?"Usando Ciclo más corto como base":"Usando CPM (final)"})}),e.jsx(ve,{type:"button",variant:"outline",onClick:()=>We(!0),disabled:!_a,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"})]}),ia&&z==="manual"&&!L&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":z==="none",onClick:()=>it("none"),onKeyDown:t=>lt(t,()=>it("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${z==="none"?"border-emerald-300 bg-emerald-50/60":"border-dashed border-rose-200 bg-white/70 hover:border-rose-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${z==="none"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:z==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(Rt,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(ve,{type:"button",variant:"secondary",onClick:Et,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(ve,{type:"button",onClick:Wa,disabled:ia,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(mt,{open:Ft,onOpenChange:We,children:e.jsxs(ft,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(At,{children:e.jsx(Bt,{children:"¿Estás segura de que quieres borrar el valor manual de CPM?"})}),e.jsxs(Rt,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(ve,{type:"button",variant:"secondary",onClick:()=>We(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(ve,{type:"button",variant:"destructive",onClick:Ha,disabled:xt,className:"w-full sm:w-auto",children:xt?"Borrando…":"Borrar"})]})]})}),e.jsx(mt,{open:ht,onOpenChange:t=>{t||Pt()},children:e.jsxs(ft,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col rounded-3xl border border-rose-100 bg-white/95 text-gray-800 shadow-xl overflow-hidden p-0",children:[e.jsxs(At,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(Bt,{children:"Editar T-8"}),e.jsx(Sa,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${ot==="manual"||ot==="auto"?"bg-rose-100 text-rose-700":"bg-gray-100 text-gray-600"}`,children:Ra})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>ct("auto"),onKeyDown:t=>lt(t,()=>ct("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${V==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"} ${g.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:g.canCompute&&g.value!==null?`T-8 automático: Día ${Ba}`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${V==="auto"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:V==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>Be(t=>!t),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":kt,children:Yt.highlightLabel})]}),Yt.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:Yt.summary}),g.cycleCount===0&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."}),kt&&g.cycleCount>0&&e.jsx("div",{className:"mt-2 space-y-2",children:g.cyclesConsidered.length>0?e.jsx("ul",{className:"space-y-1",children:g.cyclesConsidered.map((t,s)=>{const o=t.cycleId||`${t.displayName}-${t.riseDay}-${s}`,r=typeof t.riseDay=="number"&&Number.isFinite(t.riseDay)?t.riseDay:"—",c=t.cycleId||t.id,l=!!(t.isIgnored||t.ignoredForAutoCalculations),b=c?ta.includes(c):!1,C=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${l?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/40"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${C} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>ua(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(Qt,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Día de subida: ",r]}),Number.isFinite(t.t8Day)&&e.jsxs("span",{children:["T-8: Día ",t.t8Day]})]}),l&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(ve,{type:"button",variant:"outline",size:"icon",disabled:!c||b,onClick:()=>c&&da(c,!l),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:l?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":l?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":l,children:b?e.jsxs(e.Fragment,{children:[e.jsx(ja,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):l?e.jsx(Ma,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(Fa,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":V==="manual",onClick:()=>ct("manual"),onKeyDown:t=>lt(t,()=>ct("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${V==="manual"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${V==="manual"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:V==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_t,{htmlFor:"manual-t8-base",className:"text-xs text-gray-600",children:"Ciclo con subida (día)"}),e.jsx(Lt,{id:"manual-t8-base",type:"number",inputMode:"numeric",step:"1",min:"1",value:De,onChange:Xa,placeholder:"Día de subida","aria-describedby":Me?"manual-t8-helper":void 0}),Pe&&e.jsx("p",{className:"text-xs text-red-500",children:Pe})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_t,{htmlFor:"manual-t8-final",className:"text-xs text-gray-600",children:"T-8 manual (día)"}),e.jsx(Lt,{id:"manual-t8-final",type:"number",inputMode:"numeric",step:"1",min:"1",value:ne,onChange:Ya,placeholder:"Día del T-8","aria-describedby":Me?"manual-t8-helper":void 0}),Ae&&e.jsx("p",{className:"text-xs text-red-500",children:Ae})]})]}),e.jsx("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:Me&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-t8-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:Me==="base"?"Usando día de subida como base":"Usando T-8 manual"})})}),e.jsx(ve,{type:"button",variant:"outline",onClick:()=>Xe(!0),disabled:!La,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"}),ca&&V==="manual"&&!h&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":V==="none",onClick:()=>ct("none"),onKeyDown:t=>lt(t,()=>ct("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${V==="none"?"border-emerald-300 bg-emerald-50/60":"border-dashed border-rose-200 bg-white/70 hover:border-rose-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${V==="none"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:V==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(Rt,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(ve,{type:"button",variant:"secondary",onClick:Pt,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(ve,{type:"button",onClick:qa,disabled:ca,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(mt,{open:It,onOpenChange:Xe,children:e.jsxs(ft,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(At,{children:e.jsx(Bt,{children:"¿Estás segura de que quieres borrar el valor manual de T-8?"})}),e.jsxs(Rt,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(ve,{type:"button",variant:"secondary",onClick:()=>Xe(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(ve,{type:"button",variant:"destructive",onClick:Ka,disabled:ea,className:"w-full sm:w-auto",children:ea?"Borrando…":"Borrar"})]})]})}),e.jsx(mt,{open:ie,onOpenChange:t=>{t||He()},children:e.jsx(ft,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Ss,{cycle:i,startDate:G,endDate:i.endDate,otherCycles:[...k??[],i].filter(Boolean),onStartDateChange:t=>Ne(t),onSave:es,onCancel:He,isProcessing:pt||q||Ht,dateError:Le,includeEndDate:!1,showOverlapDialog:Oe,overlapCycle:ce,onConfirmOverlap:ts,onCancelOverlap:Za,onClearError:()=>X(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",onUndoCycle:at?()=>Ut(!0):void 0,isUndoingCycle:Ht,className:"w-full"})})})]})}),e.jsx(ks,{isOpen:Ta,onClose:()=>Ut(!1),onConfirm:Qa,title:"Deshacer ciclo",confirmLabel:"Deshacer ciclo",cancelLabel:"Cancelar",description:Ea,isProcessing:Ht}),e.jsx(mt,{open:as,onOpenChange:t=>{t?Ye(!0):ga()},children:e.jsx(ft,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Fs,{onSubmit:ps,onCancel:ga,initialData:Ct,cycleStartDate:i.startDate,cycleEndDate:i.endDate,isProcessing:ss,isEditing:!!Ct&&!rs,cycleData:i.data,onDateSelect:ls,initialSectionKey:ns})})}),e.jsx(Xs,{onAddRecord:()=>{Nt(null),dt(null),Ye(!0)},onAddCycle:()=>ut(!0)}),e.jsx(Na,{isOpen:ba,onClose:()=>ut(!1),onConfirm:xs,currentCycleStartDate:i.startDate,currentCycleRecords:i?.data??[]}),e.jsx(wa,{isOpen:ya,onClose:()=>vt(!1),onConfirm:va})]})};export{on as default};
