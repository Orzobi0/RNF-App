import{c as H,v as T,a as U,u as z,b as F,r,k as N,f,j as s,L as R,t as J,o as S,n as V}from"./index-Do8Ydwb3.js";import{D as W}from"./DeletionDialog-eRV-pJhK.js";import{u as Z}from"./useCycleData-Dq0sFEDe.js";import{a as C,H as G}from"./HeaderIconButton-B7WKOykb.js";import{RecordsExperience as K}from"./RecordsPage-DlKFVGTf.js";import{A as Q}from"./arrow-left-BKoATTuF.js";import{P as X}from"./useBackClose-CETyKRQ2.js";import"./PostpartumExitDialog-D68MswuQ.js";import"./badge-DykpjFnT.js";import"./DataEntryForm-BoWzh_6Y.js";import"./label-BrdHOCTF.js";import"./computePeakStatuses-DaIqHORZ.js";import"./peak-mode-button-Dr3pvIZC.js";import"./eye-COo0Vokr.js";const Y=H("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),ee=(c,n)=>{const a=S(f(c)),l=S(f(n));return V(a,l)+1},ae=(c,n)=>!c||!Array.isArray(c)||!n?[]:[...c].sort((l,m)=>f(l.isoDate)-f(m.isoDate)).map(l=>({...l,ignored:l.ignored||!1,cycleDay:ee(l.isoDate,n)})),he=()=>{const{cycleId:c}=T(),n=U(),{user:a}=z(),{getCycleById:l,isLoading:m,addOrUpdateDataPoint:g,deleteRecord:v,updateCycleDates:x,deleteCycle:b,checkCycleOverlap:L,refreshData:j}=Z(),{toast:d}=F(),[t,w]=r.useState(null),[I,h]=r.useState(!1),[k,E]=r.useState(!1),p=t?`${N(f(t.startDate),"dd/MM/yyyy")} - ${t.endDate?N(f(t.endDate),"dd/MM/yyyy"):"En curso"}`:"",D=r.useCallback(e=>{if(!a||!e?.id)return;const i={...e,data:(e.data||[]).map(({cycleDay:u,...o})=>o)};localStorage.setItem(`fertilityData_cycle_${a.uid}_${e.id}`,JSON.stringify(i))},[a]),y=r.useCallback(async()=>{if(!a||!c)return null;const e=await l(c);return e&&(D(e),w(e)),e},[c,l,D,a]);r.useEffect(()=>{(async()=>{if(!a)return;let i=await l(c);if(!i){const u=localStorage.getItem(`fertilityData_cycle_${a.uid}_${c}`);if(u){const o=JSON.parse(u);i={...o,data:ae(o.data||[],o.startDate)}}}i?(D(i),w(i)):(d({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),n("/archived-cycles"))})()},[c,a,l,d,n]);const P=r.useCallback(async(e,i)=>{if(!t?.id||!a)return;const u=!!i;await g(e,i,t.id),await y()&&d({title:u?"Registro actualizado":"Nuevo registro añadido",description:"Datos del ciclo actualizados."})},[t?.id,a,g,y,d]),A=r.useCallback(async e=>{!t?.id||!a||(await v(e,t.id),await y(),d({title:"Registro eliminado",description:"El registro ha sido eliminado."}))},[t?.id,a,v,y,d]),O=r.useCallback(async(e,i,u)=>{const o=e??t?.id;!a||!o||await x(o,i,u)},[t?.id,a,x]),$=r.useCallback(async e=>{await j(e),await y()},[j,y]),q=()=>{h(!0)},M=r.useCallback(async()=>{if(!(!t?.id||!a)){E(!0);try{await b(t.id),d({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),n("/archived-cycles")}catch(e){console.error(e),d({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{E(!1),h(!1)}}},[t?.id,b,n,d,a]),_=r.useCallback(()=>s.jsx(C,{asChild:!0,className:"shrink-0 text-fertiliapp-fuerte",children:s.jsxs(R,{to:"/archived-cycles","aria-label":"Volver a mis ciclos",children:[s.jsx(Q,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Mis ciclos"})]})}),[]),B=r.useCallback(({openDateEditor:e,openAddRecord:i,isProcessing:u,isUpdatingDates:o})=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(C,{type:"button",onClick:e,"aria-pressed":o,disabled:o,"aria-label":"Editar fechas del ciclo",children:s.jsx(Y,{className:"h-4 w-4"})}),s.jsx(C,{asChild:!0,children:s.jsx(R,{to:`/chart/${c}`,"aria-label":"Ver gráfica del ciclo",children:s.jsx(J,{className:"h-4 w-4"})})}),s.jsx(G,{type:"button",onClick:i,disabled:u,"aria-label":"Añadir registro al ciclo",children:s.jsx(X,{className:"h-4 w-4"})})]}),[c]);return m&&!t||!t?s.jsx("div",{className:"flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:s.jsx("p",{children:"Cargando detalles del ciclo..."})}):s.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[s.jsx(K,{cycle:t,isLoading:m,addOrUpdateDataPoint:P,deleteRecord:A,updateCycleDates:O,checkCycleOverlap:L,refreshData:$,includeEndDate:!0,headerActions:B,topAccessory:_,onRequestDeleteCycle:q,isDeletingCycle:k,dateEditorDeleteDescription:p?`Se eliminará el ciclo ${p} y todos sus registros asociados.`:"Se eliminará este ciclo y todos sus registros asociados."}),s.jsx(W,{isOpen:I,onClose:()=>h(!1),onConfirm:M,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:p?`¿Estás seguro de que quieres eliminar el ciclo ${p}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:k})]})};export{he as default};
