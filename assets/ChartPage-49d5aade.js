import{c as Wt,m as je,j as e,r as g,l as Ye,g as nt,n as Gt,f as mt,k as Nt,J as Ht,q as Ut,K as zt,u as Vt,M as yt,B as ot,L as kt,X as Yt}from"./index-a7b876ee.js";import{g as qt,i as Kt,b as Xt,D as Jt}from"./computePeakStatuses-93cb3295.js";import{u as Zt,C as Qt,a as es,b as ts,c as ss}from"./useFertilityChart-08cb569a.js";import{u as rs,D as as,a as os}from"./useCycleData-3c889a19.js";import{C as bt,S as ns,a as ls,b as is,c as cs,d as ds}from"./checkbox-7666851b.js";import{L as us}from"./label-c685ab7e.js";import{A as fs}from"./arrow-left-e68f1409.js";import{E as hs,a as ps}from"./eye-a5e52431.js";import"./input-4ca4bf6c.js";import"./badge-a7e9b0c3.js";const ms=Wt("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),xs=Wt("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),gs=({padding:o,chartWidth:u,chartHeight:f,tempMin:p,tempMax:N,tempRange:m,getY:L,getX:P,allDataPoints:y=[],responsiveFontSize:h,isFullScreen:ae,showLeftLabels:H=!1,reduceMotion:K=!1,graphBottomY:U,chartAreaHeight:k,rowsZoneHeight:T})=>{const d={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.3,ease:"easeOut"}}},D=[];if(m>0){const I=m<=2.5?.1:.5;for(let w=p;w<=N+1e-9;w+=I)D.push(parseFloat(w.toFixed(1)))}else for(let I=35.8;I<=37.2+1e-9;I+=.1)D.push(parseFloat(I.toFixed(1)));const J=K?"g":je.g;return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"bgGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fffbfc"}),e.jsx("stop",{offset:"50%",stopColor:"#fff5f7"}),e.jsx("stop",{offset:"100%",stopColor:"#fff1f3"})]}),e.jsxs("linearGradient",{id:"dataZoneGradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255, 255, 255, 0.6)"}),e.jsx("stop",{offset:"20%",stopColor:"rgba(255, 250, 252, 0.75)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(254, 242, 244, 0.85)"})]}),e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsxs("filter",{id:"softShadow",children:[e.jsx("feGaussianBlur",{in:"SourceAlpha",stdDeviation:"2"}),e.jsx("feOffset",{dx:"0",dy:"1",result:"offsetblur"}),e.jsx("feComponentTransfer",{children:e.jsx("feFuncA",{type:"linear",slope:"0.2"})}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"pointGlow",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsx("filter",{id:"textShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.8)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]})]}),e.jsx("rect",{x:o.left,y:o.top,width:u-o.left-o.right,height:k,fill:"url(#bgGradientChart)",opacity:2,rx:12,style:{filter:"drop-shadow(0 4px 12px rgba(244, 114, 182, 0.1))"}}),e.jsx("rect",{x:o.left,y:o.top,width:u-o.left-o.right,height:k,fill:"white",stroke:"url(#tempLineGradientChart)",strokeWidth:"1",strokeOpacity:"0.2",rx:"12",style:{filter:"url(#softShadow)"}}),e.jsx("rect",{x:o.left,y:U,width:u-o.left-o.right,height:T,fill:"url(#dataZoneGradient)",rx:"8",style:{filter:"drop-shadow(0 -1px 2px rgba(244, 114, 182, 0.05))"}}),D.map((I,w)=>{const oe=L(I),R=I.toFixed(1).endsWith(".0")||I.toFixed(1).endsWith(".5"),xe=R?I.toFixed(1):`.${I.toFixed(1).split(".")[1]}`;return e.jsxs(J,{...K?{}:{variants:d},children:[e.jsx("line",{x1:o.left,y1:oe,x2:u-o.right,y2:oe,stroke:R?"#f9a8d4":"#fce7f3",strokeWidth:R?1.5:1,opacity:R?.5:.3,strokeDasharray:R?"0":"4,4",style:{filter:R?"drop-shadow(0 1px 3px rgba(244, 114, 182, 0.15))":"none",opacity:R?1:.7}}),H&&e.jsx("text",{x:o.left-h(1),y:oe+h(.35),textAnchor:"end",fontSize:h(R?1.1:1),fontWeight:R?"700":"600",fill:R?"#be185d":"#db2777",opacity:R?.9:.7,style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:xe}),e.jsx("text",{x:u-o.right+h(1),y:oe+h(.35),textAnchor:"start",fontSize:h(R?1.1:1),fontWeight:R?"700":"600",fill:R?"#be185d":"#db2777",opacity:R?.9:.7,style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:xe})]},`temp-tick-${w}`)}),y.map((I,w)=>{const oe=P(w);return e.jsx("line",{x1:oe,y1:o.top,x2:oe,y2:U,stroke:"#fce7f3",strokeWidth:"1",opacity:"0.6",style:{filter:"drop-shadow(0 0 1px rgba(244, 114, 182, 0.05))"}},`day-grid-${w}`)}),e.jsx("rect",{x:o.left,y:o.top,width:u-o.left-o.right,height:k,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"2",strokeOpacity:"0.4",rx:"12"}),e.jsx("rect",{x:o.left+1,y:o.top+1,width:u-o.left-o.right-2,height:k-2,fill:"none",stroke:"white",strokeWidth:"0.5",rx:"11",opacity:"0.9"}),H&&e.jsx(J,{...K?{}:{variants:d},children:e.jsx("text",{x:o.left+h(1.2),y:o.top+h(1.5),textAnchor:"middle",fontSize:h(1.4),fontWeight:"800",fill:"#be185d",style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:"°C"})})]})},ys=({data:o,allDataPoints:u,getX:f,getY:p,baselineY:N,temperatureField:m="temperature",reduceMotion:L=!1})=>{if(!o||o.length<2)return null;let P="",y=null;const h=[];if(u.forEach((K,U)=>{const k=o.find(T=>T.id===K.id);if(k&&k[m]!==null&&k[m]!==void 0&&!k.ignored){const T=f(U),d=p(k[m]);h.push({x:T,y:d}),y!==null&&U===y+1?P+=` L ${T} ${d}`:P+=`${P?" ":""}M ${T} ${d}`,y=U}}),h.length<2)return null;const ae=P.includes("L"),H=h.length>1?h.map(({x:K,y:U},k)=>`${k===0?"M":"L"} ${K} ${U}`).join(" "):"";return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsx("filter",{id:"lineShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"3",floodColor:"rgba(244, 114, 182, 0.4)"})})]}),ae&&(L?e.jsx("path",{d:P,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"}}):e.jsx(je.path,{d:P,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.4},transition:{duration:.8,ease:"easeInOut",delay:.2}})),H&&(L?e.jsx("path",{d:H,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65}):e.jsx(je.path,{d:H,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.65},transition:{duration:.8,ease:"easeInOut"}})),ae&&(L?e.jsx("path",{d:P,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"}}):e.jsx(je.path,{d:P,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1,ease:"easeInOut",delay:.4}}))]})},Ot="#1565C0",Pt="#2E7D32",Bt="#6A1B9A",bs="rgba(148, 163, 184, 0.35)",ws="rgba(226, 232, 240, 0.6)",js="rgba(148, 163, 184, 0.5)",Ft="✖",Ct="#7f1d1d",It="#ec4899",Tt="drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))",ks="#be185d",Cs="#2563eb",Is="#be185d",Ss=o=>{if(!o)return"";const[u,f]=o.split("/");return`${parseInt(u,10)}/${parseInt(f,10)}`},St=(o="",u,f,p="–")=>{if(!o)return[p,""];if(o.length<=u)return[o,""];if(f){const y=o.slice(0,u),h=o.slice(u,u*2);return[y,h]}const N=y=>{if(!y)return["",""];if(y.length<=u)return[y,""];const h=y.indexOf(" ",u);return h===-1?[y.slice(0,u),y.slice(u)]:[y.slice(0,h),y.slice(h+1)]},[m,L]=N(o),[P]=N(L.trimStart());return[m,P]},vt=(o="",u,f="–")=>o?o.split(/\s+/).slice(0,u).join(" "):f,vs=({data:o,getX:u,getY:f,isFullScreen:p,orientation:N,responsiveFontSize:m,onPointInteraction:L,clearActivePoint:P,activePoint:y,padding:h,chartHeight:ae,chartWidth:H,temperatureField:K="temperature_chart",textRowHeight:U,compact:k=!1,reduceMotion:T=!1,showInterpretation:d=!1,ovulationDetails:D=null,firstHighIndex:J=null,baselineIndices:I=[],graphBottomLift:w=0,graphBottomY:oe,rowsZoneHeight:R})=>{const xe={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},he={hidden:{opacity:0,scale:.3},visible:{opacity:1,scale:1,transition:{duration:.6,ease:[.34,1.56,.64,1],type:"spring",stiffness:120,damping:12}}},Z=oe,Te=Math.max(1,Math.floor(R/((p?9:7.5)+(p?1:.75)))),ne=Math.max(U,Te),De=Z+ne*1,v=Z+ne*2,ge=Z+ne*3,ke=Z+ne*(p?5:4.5),Y=Z+ne*(p?7:6),Le=Z+ne*(p?9:7.5),Ae=H-h.left-h.right,ye=ne*(p?2:1.5),_e=T?"g":je.g,Oe=Array.isArray(o)?o.length:0,Ge=g.useMemo(()=>Ye(new Date),[]),He=g.useMemo(()=>{if(!d)return new Map;const a=Array.isArray(D==null?void 0:D.highSequenceIndices)?D.highSequenceIndices:[],i=new Map;return a.forEach((x,le)=>{const _=Number(x);Number.isInteger(_)&&_>=0&&_<Oe&&!i.has(_)&&i.set(_,le+1)}),i},[d,D,Oe]),lt=g.useMemo(()=>{if(!d)return new Map;const a=Array.isArray(I)?I:[];if(!a.length)return new Map;const i=new Set,x=[],le=$=>{const A=Number($);Number.isInteger(A)&&A>=0&&A<Oe&&!i.has(A)&&(i.add(A),x.push(A))};if(a.forEach($=>{le($)}),J!=null){const $=Number(J);Number.isInteger($)&&le($-1)}if(!x.length)return new Map;const _=[...x].sort(($,A)=>$-A),pe=new Map;let F=1;for(let $=_.length-1;$>=0&&!(F>6);$-=1)pe.set(_[$],F),F+=1;return pe},[d,I,Oe,J]);return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsx("filter",{id:"rowShadowChart",x:"-10%",y:"-10%",width:"120%",height:"120%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"4",floodColor:"rgba(244, 114, 182, 0.2)"})}),e.jsxs("filter",{id:"pointGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("radialGradient",{id:"tempPointGradientChart",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FDF2F8"}),e.jsx("stop",{offset:"50%",stopColor:"#F9A8D4"}),e.jsx("stop",{offset:"85%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#DB2777"})]}),e.jsxs("radialGradient",{id:"tempPointIgnoredGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFFFFF"}),e.jsx("stop",{offset:"80%",stopColor:"#F8FAFC"}),e.jsx("stop",{offset:"100%",stopColor:"#E2E8F0"})]}),e.jsxs("radialGradient",{id:"ovulationPointGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#dbeafe"}),e.jsx("stop",{offset:"50%",stopColor:"#93c5fd"}),e.jsx("stop",{offset:"85%",stopColor:"#3b82f6"}),e.jsx("stop",{offset:"100%",stopColor:"#2563eb"})]})]}),!k&&e.jsxs("g",{children:[e.jsx("rect",{x:h.left,y:ke-ye/2,width:Ae,height:ye,fill:"rgba(239, 246, 255, 0.4)",stroke:"rgba(59, 130, 246, 0.08)",strokeWidth:.5,rx:3,style:{filter:"drop-shadow(0 1px 1px rgba(59, 130, 246, 0.03))"}}),e.jsx("rect",{x:h.left,y:Y-ye/2,width:Ae,height:ye,fill:"rgba(236, 253, 245, 0.4)",stroke:"rgba(16, 185, 129, 0.08)",strokeWidth:.5,rx:3,style:{filter:"drop-shadow(0 1px 1px rgba(16, 185, 129, 0.03))"}}),e.jsx("rect",{x:h.left,y:Le-ye/2,width:Ae,height:ye,fill:"rgba(245, 243, 255, 0.4)",stroke:"rgba(139, 92, 246, 0.08)",strokeWidth:.5,rx:3,style:{filter:"drop-shadow(0 1px 1px rgba(139, 92, 246, 0.03))"}})]}),p&&N!=="portrait"&&e.jsx(je.g,{variants:xe,children:[{label:"Fecha",row:1,color:p?"#374151":"#6B7280"},{label:"Día",row:2,color:p?"#374151":"#6B7280"},{label:"Símbolo",row:3,color:p?"#374151":"#6B7280"},{label:"Sens.",row:p?5:4.5,color:Ot},{label:"Apar.",row:p?7:6,color:Pt},{label:"Observ.",row:p?9:7.5,color:Bt}].map(({label:a,row:i,color:x})=>e.jsx("text",{x:h.left-m(.5),y:Z+ne*i,textAnchor:"end",fontSize:m(1.05),fontWeight:"700",fill:x,style:{filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:a},a))}),o.map((a,i)=>{const x=u(i),le=a[K]!=null?f(a[K]):Z,_=a.temperature_raw,pe=a.temperature_corrected,F=a.use_corrected&&_!=null&&pe!=null&&Math.abs(pe-_)>.01,$=F?f(_):null,A="#60666f",Q=a[K]!=null,Ce=!!(a.had_relations??a.hadRelations);Q||a.mucus_sensation||a.mucus_appearance||a.fertility_symbol;const Ue=String(a.id||"").startsWith("placeholder-"),Pe=D==null?void 0:D.peakDayIndex,de=d&&Pe!=null&&!a.ignored&&Q&&i===Pe,fe=qt(a.fertility_symbol);let Me="transparent";if(fe!=null&&fe.color){const we=fe.color.replace(/^bg-/,"");we==="red-500"?Me="#ef4444":we==="white"?Me="#ffffff":we==="green-500"?Me="#22c55e":we==="pink-300"?Me="#f9a8d4":we==="yellow-400"&&(Me="#facc15")}const Ne=a.isoDate?Kt(Ye(nt(a.isoDate)),Ye(new Date)):!1,z=m(p?1.8:2),ze=ge-z*.75+z/2+2,be=a.peakStatus?String(a.peakStatus).toUpperCase():null,ue=be==="P"||be==="X",Ke=be&&!ue,Re=ue?Ft:be||"–",$e=ue||["1","2","3"].includes(be),Xe=!Ue&&fe.value!=="none",Je=!!a.isoDate&&!Ne?{pointerEvents:"all",style:{cursor:"pointer"},onClick:we=>L(a,i,we)}:{},Ie=(a.isoDate?Xt(nt(a.isoDate),Ge):!1)?Is:A,We=He.has(i),Ze=We?He.get(i):null,Qe=lt.has(i),Ee=Qe?lt.get(i):null,ie=m(p?.75:1.2),Ve=Math.max(.5,ie*.18),Be=le-ie*(p?2.6:1.8),Se=le+ie*(p?1.9:1.6),ve=p?4:7,S=2,[et,tt]=St(p?vt(a.mucus_sensation,S,Ne?"":"–"):a.mucus_sensation,ve,!1,Ne?"":"–"),[st,rt]=St(p?vt(a.mucus_appearance,S,Ne?"":"–"):a.mucus_appearance,ve,!1,Ne?"":"–"),[at,ct]=St(p?vt(a.observations,S,""):a.observations,ve,!1,"");return e.jsxs(_e,{...T?{}:{variants:xe},...Je,children:[Q&&e.jsxs(_e,{...T?{}:{variants:he},children:[F&&$!==null&&e.jsxs("g",{pointerEvents:"none",children:[e.jsx("line",{x1:x,y1:$,x2:x,y2:le,stroke:bs,strokeWidth:1,strokeDasharray:"4 4"}),e.jsx("circle",{cx:x,cy:$,r:3,fill:ws,stroke:js,strokeWidth:1}),e.jsx("circle",{cx:x,cy:$,r:1,fill:"rgba(255, 255, 255, 0.6)"})]}),e.jsx("circle",{cx:x,cy:le,r:de?3.5:2.8,fill:a.ignored?"url(#tempPointIgnoredGradient)":de?"url(#ovulationPointGradient)":"url(#tempPointGradientChart)",stroke:a.use_corrected?"#941616":a.ignored?"#94A3B8":de?"#1d4ed8":"#E91E63",strokeWidth:a.ignored?1.5:de?2.2:2,style:{filter:de?"drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3))":"drop-shadow(0 2px 3px rgba(244, 114, 182, 0.25))",cursor:"pointer"},pointerEvents:"all",onClick:we=>L(a,i,we)}),!a.ignored&&e.jsx("circle",{cx:x,cy:le,r:de?1.2:.9,fill:de?"rgba(239, 246, 255, 0.95)":"rgba(255, 255, 255, 0.9)",style:{filter:de?"drop-shadow(0 1px 3px rgba(37, 99, 235, 0.45))":"drop-shadow(0 1px 2px rgba(244, 114, 182, 0.3))"}}),d&&Q&&!a.ignored&&We&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x,y:Be,textAnchor:"middle",fontSize:ie,fontWeight:"900",fill:ks,strokeWidth:Ve,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Ze})}),d&&Q&&!a.ignored&&Qe&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x,y:Se,textAnchor:"middle",fontSize:ie,fontWeight:"800",fill:Cs,stroke:"#ffffff",strokeWidth:Ve,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.85))"},children:Ee})})]}),e.jsx("text",{x,y:De,textAnchor:"middle",fontSize:m(1.05),fontWeight:"900",fill:Ie,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Ss(a.date)}),e.jsx("text",{x,y:v,textAnchor:"middle",fontSize:m(1),fontWeight:"900",fill:Ie,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:a.cycleDay}),Xe?e.jsxs("g",{children:[e.jsx("rect",{x:x-z/2+1,y:ge-z*.75+1,width:z,height:z,fill:"rgba(0, 0, 0, 0.1)",rx:z*.3,opacity:.5}),e.jsx("rect",{x:x-z/2-4,y:ge-z*.75,width:z*1.4,height:z,fill:fe.pattern==="spotting-pattern"?"url(#spotting-pattern-chart)":Me,stroke:fe.value==="white"?"#CBD5E1":"rgba(233, 30, 99, 0.4)",strokeWidth:fe.value==="white"?2:1,rx:z*.2,style:{filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.25))"}}),be&&e.jsx("g",{pointerEvents:"none",children:ue?e.jsx("text",{x,y:ze,textAnchor:"middle",fontSize:m(1.35),fontWeight:"900",fill:It,stroke:"#fff",strokeWidth:1.5,paintOrder:"stroke",style:{filter:Tt},children:Ft}):e.jsx("text",{x,y:ze,textAnchor:"middle",fontSize:m(be?1.1:1),fontWeight:"800",fill:Ct,style:{filter:"drop-shadow(0 1px 1px rgba(255,255,255,0.9))"},children:be})})]}):e.jsxs("g",{children:[$e&&e.jsx("rect",{x:x-z/2-4,y:ge-z*.75,width:z*1.4,height:z,fill:"transparent",stroke:ue?It:Ct,strokeWidth:1,rx:z*.2}),e.jsx("text",{x,y:ze,textAnchor:"middle",fontSize:m(ue?1.35:Ke?1.1:1),fill:ue?It:Ke?Ct:A,fontWeight:ue?"900":Ke?"800":"500",style:{filter:ue?Tt:Ke?"drop-shadow(0 1px 1px rgba(255,255,255,0.9))":"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Re})]}),!k&&e.jsxs("text",{x,y:ke,textAnchor:"middle",fontSize:m(.9),fontWeight:"700",fill:Ot,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x,dy:0,children:et}),tt&&e.jsx("tspan",{x,dy:m(1.1),children:tt})]}),!k&&e.jsxs("text",{x,y:Y,textAnchor:"middle",fontSize:m(.9),fontWeight:"700",fill:Pt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x,dy:0,children:st}),rt&&e.jsx("tspan",{x,dy:m(1.1),children:rt})]}),!k&&e.jsxs("text",{x,y:Le,textAnchor:"middle",fontSize:m(.9),fontWeight:"700",fill:Bt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x,dy:0,children:at}),ct&&e.jsx("tspan",{x,dy:m(1.1),children:ct})]})]},`pt-${i}-${a.isoDate||a.timestamp}`)})]})},Ms="#1565C0",Ns="#2E7D32",Rs="#6A1B9A",Es=({padding:o,chartHeight:u,tempMin:f,tempMax:p,tempRange:N,getY:m,responsiveFontSize:L,textRowHeight:P,isFullScreen:y,graphBottomY:h,rowsZoneHeight:ae})=>{const H={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},K=[];if(N>0){const I=N<=2.5?.1:.5;for(let w=f;w<=p+1e-9;w+=I)K.push(parseFloat(w.toFixed(1)))}else for(let I=35.8;I<=37.2+1e-9;I+=.1)K.push(parseFloat(I.toFixed(1)));const U=h,d=Math.max(1,Math.floor(ae/((y?9:7.5)+(y?1:.75)))),D=Math.max(P,d),J=g.useMemo(()=>[{label:"Fecha",row:1,color:"#374151",icon:null},{label:"Día",row:2,color:"#374151",icon:null},{label:"Símbolo",row:3,color:"#374151",icon:null},{label:"Sens.",row:y?5:4.5,color:Ms,icon:"◊"},{label:"Apar.",row:y?7:6,color:Ns,icon:"○"},{label:"Observ.",row:y?9:7.5,color:Rs,icon:"✦"}],[y]);return e.jsxs("svg",{width:o.left,height:u,className:"font-sans pointer-events-none",children:[e.jsx("defs",{children:e.jsx("filter",{id:"textShadowLegend",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.9)"})})}),K.map((I,w)=>{const oe=m(I),R=I.toFixed(1).endsWith(".0")||I.toFixed(1).endsWith(".5"),xe=R?I.toFixed(1):`.${I.toFixed(1).split(".")[1]}`;return e.jsx(je.g,{variants:H,children:e.jsx("text",{x:o.left-L(1.2),y:oe+L(.35),textAnchor:"end",fontSize:L(R?1.15:1),fontWeight:R?"800":"700",fill:R?"#be185d":"#db2777",opacity:R?1:.85,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:xe})},`temp-tick-fixed-${w}`)}),e.jsx(je.g,{variants:H,children:J.map(({label:I,row:w,color:oe,icon:R})=>e.jsxs("g",{children:[R&&e.jsx("text",{x:o.left-L(2.8),y:U+D*w,textAnchor:"middle",fontSize:L(.8),fontWeight:"600",fill:oe,opacity:.7,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:R}),e.jsx("text",{x:o.left-L(.8),y:U+D*w,textAnchor:"end",fontSize:L(1.05),fontWeight:"800",fill:oe,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:I})]},I))})]})},Dt="#be123c",Ls="rgba(252, 231, 243, 0.40)",As="rgba(244, 114, 182, 0.08)",Os="0 1px 1px rgba(244, 114, 182, 0.03)",Ps=({allDataPoints:o=[],getX:u,padding:f,chartWidth:p,textRowHeight:N,isFullScreen:m,responsiveFontSize:L})=>{const P=(m?2:1.5)*N,y=Math.max(P,28),h=f||{left:0,right:0},ae=Number.isFinite(p)&&p>0?p:0,H=Math.min(Math.max(y*.46,14),15),K=ae>0?{width:ae,minWidth:ae}:{width:"100%",minWidth:"100%"},U=g.useMemo(()=>!Array.isArray(o)||!u?[]:o.map((k,T)=>{if(!!!((k==null?void 0:k.had_relations)??(k==null?void 0:k.hadRelations)))return null;const D=u(T)-((f==null?void 0:f.left)??0);if(!Number.isFinite(D))return null;const J=(k==null?void 0:k.isoDate)||`day-${T}`;return{key:`${J}-${T}`,x:D,isoDate:J}}).filter(Boolean),[o,u]);return e.jsxs("div",{className:"relative w-full",style:{height:y,minHeight:y,...K,flexShrink:0,position:"relative",marginTop:-7},children:[e.jsx("div",{className:"absolute inset-y-0",style:{width:h.left,left:0},children:e.jsx("div",{className:"h-full flex items-center justify-end pr-3",children:e.jsx("span",{className:"font-sans font-bold select-none",style:{fontSize:L(1.05),fontWeight:"800",color:Dt},children:"RS"})})}),e.jsx("div",{className:"absolute inset-y-0 rounded-xl",style:{left:h.left,right:h.right,backgroundColor:Ls,border:`0.5px solid ${As}`,borderRadius:6,boxShadow:Os}}),e.jsx("div",{className:"absolute inset-y-0",style:{left:h.left,right:h.right},children:U.map(({key:k,x:T,isoDate:d})=>e.jsx("span",{className:"absolute font-semibold select-none",style:{left:T,top:"50%",transform:"translate(-50%, -50%)",fontSize:H,color:Dt,textShadow:"0 1px 1px rgba(0, 0, 0, 0.05)",lineHeight:1},role:"img","aria-label":`Relación registrada el ${d}`,children:"❤"},k))})]})},Bs=({data:o,isFullScreen:u,orientation:f,onToggleIgnore:p,onEdit:N,onTogglePeak:m,cycleId:L,initialScrollIndex:P=0,visibleDays:y=5,showInterpretation:h=!1,reduceMotion:ae=!1,forceLandscape:H=!1,currentPeakIsoDate:K=null,showRelationsRow:U=!1,fertilityStartConfig:k=null,fertilityCalculatorCycles:T=[],fertilityCalculatorCandidates:d=null,onShowPhaseInfo:D=null,isArchivedCycle:J=!1,cycleEndDate:I=null})=>{const{chartRef:w,tooltipRef:oe,dimensions:R,activePoint:xe,activeIndex:he,tooltipPosition:Z,allDataPoints:b,validDataForLine:qe,tempMin:Te,tempMax:ne,tempRange:De,padding:v,textRowHeight:ge,getY:ke,getX:Y,handlePointInteraction:Le,handleToggleIgnore:Ae,responsiveFontSize:ye,clearActivePoint:_e,baselineTemp:Oe,baselineStartIndex:Ge,baselineIndices:He,firstHighIndex:lt,ovulationDetails:a,fertilityStart:i,hasTemperatureData:x,hasAnyObservation:le,graphBottomInset:_,todayIndex:pe}=Zt(o,u,f,p,L,y,H,k,T,d),F=g.useRef(null);if(!F.current){const s=Math.random().toString(36).slice(2,10);F.current=`fertility-chart-${L??"default"}-${s}`}const $=F.current;if(!b||b.length===0)return e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-pink-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),e.jsx("p",{className:"text-slate-400 font-medium",children:"No hay datos para mostrar en el gráfico"})]});const A=R.width,Q=R.height,Ce=Q-v.bottom-(_||0),Ue=Math.max(Q-Ce,0),Pe=Oe!=null?ke(Oe):null,de=!!(a!=null&&a.confirmed),fe=Oe!=null,Me=Y(0),Ne=b.length>0?Y(b.length-1):A-v.right,z=de?"#F59E0B":"#94A3B8",ze=de?"6 4":"4 4",be=de?1:.7,ue=3,Ke=A===0,Re=he!=null?Y(he):null,$e=he!=null?he>0?Y(he-1):Re:null,Xe=he!=null?he<b.length-1?Y(he+1):Re:null,it=Math.max((A-v.left-v.right)/Math.max(b.length,1),0),Je=he!=null?Math.max((Xe!=null&&$e!=null?Xe-$e:0)||it,it,0):0,ft=g.useMemo(()=>{const s=new Map;return qe.forEach(l=>{l&&l.id!=null&&s.set(l.id,l)}),s},[qe]),Ie=g.useMemo(()=>Number.isInteger(i==null?void 0:i.fertileStartFinalIndex)?i.fertileStartFinalIndex:null,[i]),We=Math.max(Q-v.top-v.bottom-(_||0),0),Ze=g.useCallback(s=>!Number.isFinite(s)||!b.length||s<=0?v.left:Y(s),[b,Y,v.left]),Qe=g.useCallback(s=>!Number.isFinite(s)||!b.length||s>=b.length-1?A-v.right:Y(s+1),[b,A,Y,v.right]),Ee=g.useCallback((s,l,{inclusiveEnd:c=!0}={})=>{if(!Number.isFinite(s)||!Number.isFinite(l)||b.length===0)return null;const j=B=>Math.max(0,Math.min(b.length-1,Math.floor(B))),M=B=>Math.max(0,Math.min(b.length-1,Math.floor(B))),ee=B=>Math.max(0,Math.min(b.length,Math.floor(B))),O=j(s),X=c?M(l):ee(l),te=O<=0?v.left:Ze(O);let se;c?se=X>=b.length-1?A-v.right:Qe(X):X<=0?se=v.left:X>=b.length?se=A-v.right:se=Ze(X);const W=Math.max(se-te,0);return W<=0?null:{x:te,width:W}},[b,A,Ze,Qe,v.left,v.right]),ie=b.length>0?b.length-1:null,Ve=g.useMemo(()=>{var c;if(!J||!I||ie==null)return null;const s=typeof I=="string"?I:null;if(!s)return null;const l=b.findIndex(j=>(j==null?void 0:j.isoDate)===s);if(l>=0)return Math.min(l,ie);for(let j=b.length-1;j>=0;j-=1){const M=(c=b[j])==null?void 0:c.isoDate;if(typeof M=="string"&&M<=s)return Math.min(j,ie)}return null},[J,I,b,ie]),Be=g.useMemo(()=>ie==null?null:J?Number.isInteger(Ve)?Math.min(Ve,ie):ie:Number.isInteger(pe)?Math.min(pe,ie):ie,[Ve,J,pe,ie]),Se=We>0?v.top+We*.5:null,ve=Se!=null?Math.max(Ce-Se,0):0,S=g.useMemo(()=>{var Fe;if(!h||!le)return null;const s=i==null?void 0:i.debug,l=Number.isInteger(s==null?void 0:s.mucusInfertileStartIndex)?s.mucusInfertileStartIndex:null,c=Number.isInteger((Fe=i==null?void 0:i.fertileWindow)==null?void 0:Fe.temperatureInfertileStartIndex)?i.fertileWindow.temperatureInfertileStartIndex:null,j=Number.isInteger(s==null?void 0:s.postOvulatoryStartIndex)?s.postOvulatoryStartIndex:null,M={confirmed:!!(a!=null&&a.confirmed),rule:(a==null?void 0:a.rule)??null,baselineTemp:(a==null?void 0:a.baselineTemp)??null,baselineIndices:Array.isArray(a==null?void 0:a.baselineIndices)?a.baselineIndices:[],firstHighIndex:Number.isInteger(a==null?void 0:a.firstHighIndex)?a.firstHighIndex:null,highSequenceIndices:Array.isArray(a==null?void 0:a.highSequenceIndices)?a.highSequenceIndices:[],confirmationIndex:Number.isInteger(a==null?void 0:a.confirmationIndex)?a.confirmationIndex:null,startIndex:c},ee={peakDayIndex:Number.isInteger(a==null?void 0:a.peakDayIndex)?a.peakDayIndex:null,thirdDayIndex:Number.isInteger(a==null?void 0:a.thirdDayIndex)?a.thirdDayIndex:null,startIndex:c},O=c!=null,X=l!=null;if(!O&&!X)return null;const te=Number.isInteger(j)?j:null;if(te==null)return null;let se="pending",W="",B="Postovulatoria (pendiente)",me="Postovulatoria pendiente, a la espera del segundo criterio.";if(O&&X)se="absolute",B="Infertilidad absoluta",me="Infertilidad absoluta (postovulatoria con doble criterio alcanzado)",W="Infertilidad absoluta";else if(O){const V=M.rule||"regla desconocida",q=M.confirmationIndex!=null?`D${M.confirmationIndex+1}`:"—";W=`Postovulatoria (pendiente): falta moco. Temperatura con regla ${V} confirmada en ${q}.`,me=W,B="Postovulatoria (temperatura)"}else W=`Postovulatoria (pendiente): falta temperatura (método moco alcanzado vía ${ee.thirdDayIndex!=null?"3° día":"P+4"}).`,me=W,B="Postovulatoria (moco)";return{phase:"postOvulatory",status:se,startIndex:te,reasons:{type:"post",status:se,mucus:ee,temperature:M},message:W,label:B,tooltip:me}},[h,le,a,i]),et=g.useMemo(()=>{var se,W,B,me,Fe;if(!h||We<=0||Se==null||ve<=0||b.length===0)return[];const s=[],l=b.length-1,c=Number.isInteger(Be)&&Be>=0?Math.min(Be,l):l,j=Number.isInteger(Ie),M=Number.isFinite(S==null?void 0:S.startIndex);if(!j&&!M){const V=Math.min(c,l);if(V<0)return s;const q=Ee(0,V);return q&&s.push({key:"relative-default",phase:"relativeInfertile",status:"default",bounds:q,startIndex:0,endIndex:V,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (preovulatoria: sin día fértil por CPM/T-8 ni signos de moco fértil)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:null,aggregate:(i==null?void 0:i.aggregate)??null,bipScore:((se=i==null?void 0:i.debug)==null?void 0:se.bipScore)??null}}),s}if(!j&&M){const V=S.startIndex,q=Math.min(V-1,c);if(q>=0){const E=Ee(0,q);E&&s.push({key:"no-fertile-window",phase:"nodata",status:"no-fertile-window",bounds:E,startIndex:0,endIndex:q,displayLabel:"Sin ventana fértil identificable",tooltip:"Sin ventana fértil identificable",message:"Sin ventana fértil identificable",reasons:{type:"nofertile",status:"no-fertile-window",message:"No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."}})}if(Number.isFinite(S.startIndex)&&S.startIndex<=l){const E=S.status==="absolute"?l:Math.min(l,c),C=Ee(S.startIndex,E);C&&s.push({key:"post",phase:S.phase,status:S.status,bounds:C,startIndex:S.startIndex,endIndex:E,displayLabel:S.label,tooltip:S.tooltip,message:S.message,reasons:S.reasons})}return s}if(j&&Ie>0){const V=Math.min(Ie-1,c);if(V>=0){const q=Ee(0,V);q&&s.push({key:"relative",phase:"relativeInfertile",status:"default",bounds:q,startIndex:0,endIndex:V,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (fase relativamente infértil preovulatoria)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:Ie,aggregate:(i==null?void 0:i.aggregate)??null,bipScore:((W=i==null?void 0:i.debug)==null?void 0:W.bipScore)??null}})}}const ee=j?Math.max(Ie,0):0,O=S==null?void 0:S.startIndex,X=Number.isFinite(O)&&O!=null?Math.min(O-1,l):l,te=Math.min(X,c);if(te>=ee){const V=Ee(ee,te);if(V){const q=Number.isInteger((B=i==null?void 0:i.debug)==null?void 0:B.explicitStartDay)?i.debug.explicitStartDay:null,E=((me=i==null?void 0:i.aggregate)==null?void 0:me.usedCandidates)??[],C=E.some(ce=>(ce==null?void 0:ce.kind)==="profile"),re=E.some(ce=>(ce==null?void 0:ce.kind)==="calculator");let G=null;j&&q!=null&&q===Ie?G="marker":C?G="profiles":re&&(G="calculator"),s.push({key:"fertile",phase:"fertile",status:"default",bounds:V,startIndex:ee,endIndex:te,displayLabel:"Fértil",tooltip:"Fértil",message:"Fértil",reasons:{type:"fertile",startIndex:ee,endIndex:te,source:G,details:(i==null?void 0:i.debug)??null,notes:((Fe=i==null?void 0:i.aggregate)==null?void 0:Fe.notes)??[],statusSummary:(i==null?void 0:i.currentAssessment)??null,dailyAssessments:(i==null?void 0:i.dailyAssessments)??[],window:(i==null?void 0:i.fertileWindow)??null,aggregate:(i==null?void 0:i.aggregate)??null}})}}if(S&&Number.isFinite(S.startIndex)&&S.startIndex<=l){const V=S.status==="absolute"?l:Math.min(l,c),q=Ee(S.startIndex,V);q&&s.push({key:"post",phase:S.phase,status:S.status,bounds:q,startIndex:S.startIndex,endIndex:V,displayLabel:S.label,tooltip:S.tooltip,message:S.message,reasons:S.reasons})}return s},[h,We,Se,ve,b.length,Ie,i,S,le,Ee,Be]),tt=`${$}-phase-relative-gradient`,st=`${$}-phase-fertile-gradient`,rt=`${$}-phase-post-pending-gradient`,at=`${$}-phase-post-absolute-gradient`,ct=s=>s.phase==="relativeInfertile"?"#065F46":s.phase==="fertile"?"#9D174D":s.phase==="postOvulatory"?s.status==="pending"?"#075985":"#1E3A8A":s.phase==="nodata"?"#475569":"hsl(var(--foreground))",we="0 1px 1px var(--phase-text-shadow, rgba(15, 23, 42, 0.2))",ht=g.useMemo(()=>{if(!h||!(a!=null&&a.confirmed))return null;const s=Array.isArray(a==null?void 0:a.highSequenceIndices)?a.highSequenceIndices:[];if(s.length<2)return null;const l=s.map(c=>{if(c==null||c<0||c>=b.length)return null;const j=b[c],M=ft.get(j==null?void 0:j.id);return!M||!Number.isFinite(M.displayTemperature)?null:{x:Y(c),y:ke(M.displayTemperature)}}).filter(Boolean);return l.length<2?null:l.map(({x:c,y:j},M)=>`${M===0?"M":"L"} ${c} ${j}`).join(" ")},[h,a,b,ft,Y,ke]),[dt,wt]=g.useState({w:typeof window<"u"?window.innerWidth:0,h:typeof window<"u"?window.innerHeight:0}),jt=dt.w<dt.h;g.useEffect(()=>{const s=()=>wt({w:window.innerWidth,h:window.innerHeight});return window.addEventListener("resize",s),window.addEventListener("orientationchange",s),()=>{window.removeEventListener("resize",s),window.removeEventListener("orientationchange",s)}},[]),g.useEffect(()=>{if(!w.current)return;const s=w.current.clientWidth/y;w.current.scrollLeft=Math.max(0,s*P)},[P,y,R.width,f]);const xt=u&&H&&jt,gt=xt,t="w-full h-full bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",n=u?`${t} min-h-full ${gt?"overflow-y-auto overflow-x-hidden":"overflow-x-auto overflow-y-visible"}`:`${t} overflow-x-auto overflow-y-visible border border-pink-100/50`,r=!u||f==="portrait";return e.jsx(je.div,{className:"relative w-full h-full",initial:!1,children:e.jsxs(je.div,{ref:w,className:`relative p-0 ${u?"":"rounded-2xl"} ${n}`,style:{touchAction:"auto",boxShadow:u?"inset 0 1px 3px rgba(244, 114, 182, 0.1)":"0 8px 32px rgba(244, 114, 182, 0.12), 0 2px 8px rgba(244, 114, 182, 0.08)",...xt?{position:"absolute",top:0,left:0,width:`${dt.h}px`,height:`${dt.w}px`,transform:"rotate(90deg) translateY(-100%)",transformOrigin:"top left"}:{}},initial:!1,children:[Ke&&e.jsx("div",{className:"flex items-center justify-center w-full h-full text-slate-400",children:"Cargando..."}),e.jsxs("div",{className:"inline-block",style:{width:A,height:Q},children:[r&&e.jsx("div",{className:"absolute left-0 top-0 h-full bg-transparent pointer-events-none z-10",style:{width:v.left},children:e.jsx(Es,{padding:v,chartHeight:Q,tempMin:Te,tempMax:ne,tempRange:De,getY:ke,responsiveFontSize:ye,textRowHeight:ge,isFullScreen:u,graphBottomY:Ce,rowsZoneHeight:Ue})}),e.jsxs(je.svg,{width:A,height:Q,className:"font-sans flex-shrink-0",viewBox:`0 0 ${A} ${Q}`,preserveAspectRatio:"xMidYMid meet",initial:!1,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#F472B6"}),e.jsx("stop",{offset:"50%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#E91E63"})]}),e.jsxs("linearGradient",{id:"tempAreaGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(244, 114, 182, 0.18)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(244, 114, 182, 0.02)"})]}),e.jsxs("linearGradient",{id:tt,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-rel)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-rel)",stopOpacity:"var(--phase-rel-stop, 0.28)"})]}),e.jsxs("linearGradient",{id:st,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-fertile)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-fertile)",stopOpacity:"var(--phase-fertile-stop, 0.27)"})]}),e.jsxs("linearGradient",{id:rt,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post)",stopOpacity:"var(--phase-post-stop, 0.45)"})]}),e.jsxs("linearGradient",{id:at,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post-abs)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post-abs)",stopOpacity:"var(--phase-post-abs-stop, 0.7)"})]}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"chartShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"baselineGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("rect",{width:"100%",height:"100%",fill:"transparent"}),e.jsx(gs,{padding:v,chartWidth:A,chartHeight:Q,tempMin:Te,tempMax:ne,tempRange:De,getY:ke,getX:Y,allDataPoints:b,responsiveFontSize:ye,isFullScreen:u,showLeftLabels:!r,reduceMotion:ae,graphBottomY:Ce,chartAreaHeight:Math.max(Q-v.top-v.bottom-(_||0),0),rowsZoneHeight:Ue}),h&&et.length>0&&Se!=null&&ve>0&&e.jsx("g",{children:et.map(s=>{const l=Se,c=ve,M=(()=>s.phase==="postOvulatory"?s.status==="pending"?`url(#${rt})`:`url(#${at})`:s.phase==="relativeInfertile"?`url(#${tt})`:s.phase==="fertile"?`url(#${st})`:s.phase==="nodata"?"rgba(203, 213, 225, 0.2)":`url(#${st})`)(),ee=u?14:13,O=Math.max(ye(1.1),ee),X=s.bounds.width<120,te=Math.max(s.bounds.width-16,0),se=Math.max(O*.58,1),W=Math.max(1,Math.floor(te/se)),B=s.tooltip??s.displayLabel??s.message??"";let me=s.displayLabel??s.message??"";if(X&&me.length>W){const G=Math.max(W-1,1);me=`${me.slice(0,G).trimEnd()}${me.length>G?"…":""}`}const Fe=X?s.bounds.x+8:s.bounds.x+s.bounds.width/2,V=X?"start":"middle",q=l+c/2,E=ct(s),C=G=>{typeof(G==null?void 0:G.stopPropagation)=="function"&&G.stopPropagation(),typeof D=="function"&&D({phase:s.phase,status:s.status,reasons:s.reasons,message:s.message,startIndex:s.startIndex,endIndex:s.endIndex,label:s.displayLabel??s.message??null})},re=G=>{(G.key==="Enter"||G.key===" ")&&(G.preventDefault(),C(G))};return e.jsxs("g",{children:[e.jsx("rect",{x:s.bounds.x,y:l,width:s.bounds.width,height:c,fill:M,pointerEvents:"none"}),e.jsxs("text",{x:Fe,y:q,fill:E,fontSize:O,fontWeight:600,dominantBaseline:"middle",textAnchor:V,role:"button","aria-label":B,tabIndex:0,onClick:C,onKeyDown:re,style:{cursor:"pointer",userSelect:"none",lineHeight:1.2,textShadow:we},pointerEvents:"auto",children:[e.jsx("title",{children:B}),me]})]},s.key)})}),h&&fe&&Pe!==null&&(ae?e.jsx("line",{x1:Me,y1:Pe,x2:Ne,y2:Pe,stroke:z,strokeWidth:ue,strokeDasharray:ze,opacity:be}):e.jsx(je.path,{d:`M ${Me} ${Pe} L ${Ne} ${Pe}`,stroke:z,strokeWidth:ue,strokeDasharray:ze,opacity:be,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:be},transition:{duration:4,ease:"easeInOut",delay:.5}})),e.jsx(ys,{data:qe,allDataPoints:b,getX:Y,getY:ke,baselineY:Ce,temperatureField:"displayTemperature",reduceMotion:ae}),ht&&e.jsx("g",{pointerEvents:"none",children:e.jsx("path",{d:ht,fill:"none",stroke:"#cc0e93",strokeWidth:4,strokeLinecap:"round",strokeLinejoin:"round",opacity:.9})}),he!==null&&Re!==null&&Je>0&&e.jsx("g",{pointerEvents:"none",children:(()=>{const s=Ce,l=Math.max(3,Math.min(14,Je*.4)),c=Math.max(l*2,ge*.85);return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:Re,y1:0,x2:Re,y2:s,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:l}),e.jsx("line",{x1:Re,y1:s,x2:Re,y2:Q,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:c})]})})()}),e.jsx(vs,{data:b,getX:Y,getY:ke,isFullScreen:u,orientation:f,responsiveFontSize:ye,onPointInteraction:Le,clearActivePoint:_e,activePoint:xe,padding:v,chartHeight:Q,chartWidth:A,temperatureField:"displayTemperature",textRowHeight:ge,graphBottomY:Ce,rowsZoneHeight:Ue,compact:!1,reduceMotion:ae,showInterpretation:h,ovulationDetails:a,baselineStartIndex:Ge,firstHighIndex:lt,baselineIndices:He,graphBottomLift:_})]})]}),U&&e.jsx(Ps,{allDataPoints:b,getX:Y,padding:v,chartWidth:A,textRowHeight:ge,isFullScreen:u,responsiveFontSize:ye}),xe&&e.jsx(je.div,{ref:oe,initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:10},transition:{duration:.12,ease:"easeOut"},children:e.jsx(Qt,{point:xe,position:Z,chartWidth:A,chartHeight:Q,onToggleIgnore:Ae,onEdit:N,onClose:_e,onTogglePeak:m,currentPeakIsoDate:K})})]})})};function Fs(o,u){if(!o||!u)return[];const f=typeof o=="string"?nt(o):o;return[...Array(u)].map((p,N)=>{const m=Gt(f,N),L=mt(m,"yyyy-MM-dd"),P=mt(m,"dd/MM"),y=Nt(Ye(m),Ye(f))+1;return{date:P,isoDate:L,cycleDay:y,temperature:null,mucusSensation:null,mucusAppearance:null,had_relations:!1,hadRelations:!1,id:`placeholder-${L}`,ignored:!1,peak_marker:null}})}const Ts=({isOpen:o,onClose:u,children:f,ariaLabel:p,containerClassName:N="",backdropClassName:m="bg-black/40"})=>{if(g.useEffect(()=>{if(!o)return;const y=H=>{H.key==="Escape"&&typeof u=="function"&&u()};document.addEventListener("keydown",y);const{body:h}=document,ae=h.style.overflow;return h.style.overflow="hidden",()=>{document.removeEventListener("keydown",y),h.style.overflow=ae}},[o,u]),!o||typeof document>"u")return null;const L=()=>{typeof u=="function"&&u()},P=y=>{y.stopPropagation()};return Ht.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center px-4 py-8",children:[e.jsx("div",{className:`absolute inset-0 ${m}`,onClick:L,"aria-hidden":"true"}),e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":p??void 0,className:`relative z-[101] w-full max-w-md overflow-hidden rounded-3xl bg-white shadow-2xl shadow-rose-200/50 focus:outline-none focus-visible:ring-2 focus-visible:ring-pink-200 ${N}`,onClick:P,children:f})]}),document.body)},_t="fertility-chart-settings",pt=o=>o?String(o).toUpperCase().replace(/-/g,""):"",Ds=o=>{const u=pt(o);return u==="T8"?"T-8":u==="CPM"?"CPM":o??""},ut=()=>({methods:{alemanas:!0,oms:!0,creighton:!0},calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"conservador"}),$t={showRelationsRow:!1,fertilityStartConfig:ut()},_s=[{key:"alemanas",label:"Alemanas"},{key:"oms",label:"OMS"},{key:"creighton",label:"Creighton"}],$s=[{key:"cpm",label:"CPM"},{key:"t8",label:"T-8"}],Rt={conservador:"Conservador",consenso:"Consenso",permisivo:"Permisivo"},Mt=o=>{const u=ut(),f={methods:{...u.methods},calculators:{...u.calculators},postpartum:u.postpartum,combineMode:u.combineMode};if(o&&typeof o=="object"){Object.keys(f.methods).forEach(N=>{var m;typeof((m=o==null?void 0:o.methods)==null?void 0:m[N])=="boolean"&&(f.methods[N]=o.methods[N])});let p=!1;if(Object.keys(f.calculators).forEach(N=>{var m;typeof((m=o==null?void 0:o.calculators)==null?void 0:m[N])=="boolean"&&(f.calculators[N]=o.calculators[N],p=!0)}),Object.prototype.hasOwnProperty.call(Rt,o.combineMode)&&(f.combineMode=o.combineMode),typeof o.postpartum=="boolean"?f.postpartum=o.postpartum:o.postpartum!=null&&(f.postpartum=!!o.postpartum),!p){const{alemanas:N,oms:m,creighton:L}=f.methods;N?(f.calculators.cpm=!0,f.calculators.t8=!0):(m||L)&&(f.calculators.cpm=!1,f.calculators.t8=!1)}}else{const{alemanas:p,oms:N,creighton:m}=f.methods;p?(f.calculators.cpm=!0,f.calculators.t8=!0):(N||m)&&(f.calculators.cpm=!1,f.calculators.t8=!1)}return f},Js=()=>{var gt;const{cycleId:o}=Ut(),u=zt(),{currentCycle:f,archivedCycles:p,isLoading:N,addOrUpdateDataPoint:m,toggleIgnoreRecord:L,getCycleById:P}=rs(),[y,h]=g.useState(null),[ae,H]=g.useState(!1),[K,U]=g.useState(!1),k=!o||o===f.id,T=k?null:p.find(t=>t.id===o);g.useEffect(()=>{if(k){h(null),H(!1),U(!1);return}if(T){h(null),H(!1),U(!1);return}let t=!0;return H(!0),P(o).then(n=>{t&&(n?(h(n),U(!1)):(h(null),U(!0)))}).catch(()=>{t&&(h(null),U(!0))}).finally(()=>{t&&H(!1)}),()=>{t=!1}},[k,T,P,o]);const d=k?f:T||y,D=!k&&!T,J=!k&&(d==null?void 0:d.id),I=k?N&&!(f!=null&&f.id):ae||N&&!T&&!y,{preferences:w}=Vt(),oe=w==null?void 0:w.manualCpm,R=w==null?void 0:w.manualCpmBase,xe=w==null?void 0:w.manualT8,he=w==null?void 0:w.manualT8Base,Z=["auto","manual","none"].includes(w==null?void 0:w.cpmMode)?w.cpmMode:"auto",b=["auto","manual","none"].includes(w==null?void 0:w.t8Mode)?w.t8Mode:"auto",qe=g.useMemo(()=>{if(!J||!(d!=null&&d.startDate))return"";const t=s=>{if(!s)return null;try{return mt(nt(s),"dd/MM/yyyy")}catch(l){return console.error("Error formatting cycle date",l),s}},n=t(d.startDate),r=t(d.endDate)??"Sin fecha de fin";return n?`Ciclo ${n} - ${r}`:""},[J,d==null?void 0:d.startDate,d==null?void 0:d.endDate]),Te=g.useMemo(()=>{const t=[];return Array.isArray(p)&&p.length>0&&t.push(...p),f!=null&&f.id&&t.push(f),d!=null&&d.id&&!t.some(n=>(n==null?void 0:n.id)===d.id)&&t.push(d),t},[p,f,d]),[ne,De]=g.useState(typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait"),[v,ge]=g.useState(!1),[ke,Y]=g.useState(!1),[Le,Ae]=g.useState(null),[ye,_e]=g.useState(null),[Oe,Ge]=g.useState(!1),[He,lt]=g.useState(!1),[a,i]=g.useState(!1),[x,le]=g.useState(null),[_,pe]=g.useState(()=>{const t={showRelationsRow:$t.showRelationsRow,fertilityStartConfig:Mt($t.fertilityStartConfig)};if(typeof window>"u")return t;try{const n=window.localStorage.getItem(_t);if(n){const r=JSON.parse(n),s={...t,...r};return typeof(r==null?void 0:r.showRelationsRow)=="boolean"?s.showRelationsRow=r.showRelationsRow:(r==null?void 0:r.showRelationsRow)!=null&&(s.showRelationsRow=!!r.showRelationsRow),s.fertilityStartConfig=Mt(r==null?void 0:r.fertilityStartConfig),s}}catch(n){console.warn("No se pudieron cargar los ajustes del gráfico.",n)}return t}),F=g.useMemo(()=>Mt(_.fertilityStartConfig),[_.fertilityStartConfig]),$=g.useMemo(()=>({...F,calculators:{...F.calculators,cpm:F.calculators.cpm&&Z!=="none",t8:F.calculators.t8&&b!=="none"}}),[F,Z,b]);g.useEffect(()=>{if(!(typeof window>"u"))try{const t={..._,fertilityStartConfig:F};window.localStorage.setItem(_t,JSON.stringify(t))}catch(t){console.warn("No se pudieron guardar los ajustes del gráfico.",t)}},[_,F]);const A=g.useRef(!1),Q=!!(Le&&String(Le.id||"").startsWith("placeholder-"));if(g.useEffect(()=>{const t=async()=>{var r,s;const n=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);if(ge(n),!n){try{const l=typeof window<"u"?(r=window.screen)==null?void 0:r.orientation:null;await((s=l==null?void 0:l.unlock)==null?void 0:s.call(l))}catch{}De("portrait")}};return document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("MSFullscreenChange",t),()=>{document.removeEventListener("fullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.removeEventListener("MSFullscreenChange",t)}},[]),g.useLayoutEffect(()=>{window.dispatchEvent(new Event("resize"))},[ne,v]),I)return e.jsx(yt,{children:e.jsx("div",{className:"flex h-full flex-col items-center justify-center space-y-4 bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-pink-600",children:e.jsx("p",{children:"Cargando…"})})});if(!(d!=null&&d.id))return o&&K?e.jsx(yt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-pink-600",children:[e.jsx("p",{children:"No se encontró el ciclo solicitado."}),e.jsx(ot,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow",children:e.jsx(kt,{to:"/archived-cycles",children:"Volver a Mis Ciclos"})})]})}):e.jsx(yt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-pink-600",children:[e.jsx("p",{children:"No hay ciclo activo."}),e.jsx(ot,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow",children:e.jsx(kt,{to:"/records",children:"Ir a Mis Registros"})})]})});const Ce=28,Ue=10,Pe=25,de=nt(d.startDate),fe=d.data||[],Me=g.useMemo(()=>{const t=Array.isArray(fe)?fe.find(n=>(n==null?void 0:n.peak_marker)==="peak"):null;return(t==null?void 0:t.isoDate)||null},[fe]),Ne=fe.reduce((t,n)=>{const r=nt(n.isoDate);return r>t?r:t},de),z=Ye(new Date),ze=Ne>z?Ne:z,be=Nt(Ye(ze),de),ue=Math.max(Ce,be+1),Re=Fs(de,ue).map(t=>{const n=fe.find(r=>r.isoDate===t.isoDate);return n?{...n,date:t.date}:t}),$e=v?ne==="portrait"?Ue:Pe:ne==="portrait"?Ue:Ce;let Xe=0;if(ne!=="landscape"){const t=Nt(new Date,Ye(de)),n=Math.min(Math.max(t,0),ue-1);let r=Math.min(ue,n+1);n<$e-1&&(r=Math.min(ue,$e)),Xe=Math.max(0,r-$e)}const it={background:"linear-gradient(to br, #fff1f2 0%, #fce7f3 50%, #ffe4e6 100%)"},Je="var(--bottom-nav-safe)",ft=v?{...it,height:"100dvh",maxHeight:"100dvh",paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"}:{...it,height:`calc(100dvh - ${Je})`,maxHeight:`calc(100dvh - ${Je})`,paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"},Ie=(t,n=null)=>{Ae(t),_e(n??null),Y(!0)},We=async(t,n)=>{try{if(await L(t,n),D){const r=await P(t);r&&h(r)}}catch(r){console.error("Error toggling ignore state:",r)}},Ze=t=>{pe(n=>({...n,showRelationsRow:t===!0}))},Qe=(t,n)=>{pe(r=>{var j;const s=r.fertilityStartConfig??ut(),l=n===!0;if(((j=s.methods)==null?void 0:j[t])===l)return r;const c={...s,methods:{...s.methods,[t]:l}};return t==="alemanas"&&l&&(c.calculators={...s.calculators,cpm:!0,t8:!0}),{...r,fertilityStartConfig:c}})},Ee=(t,n)=>{pe(r=>{var c;const s=r.fertilityStartConfig??ut(),l=n===!0;return((c=s.calculators)==null?void 0:c[t])===l?r:{...r,fertilityStartConfig:{...s,calculators:{...s.calculators,[t]:l}}}})},ie=t=>{Object.prototype.hasOwnProperty.call(Rt,t)&&pe(n=>{const r=n.fertilityStartConfig??ut();return r.combineMode===t?n:{...n,fertilityStartConfig:{...r,combineMode:t}}})},Ve=t=>{pe(n=>{const r=n.fertilityStartConfig??ut(),s=t===!0;return r.postpartum===s?n:{...n,fertilityStartConfig:{...r,postpartum:s}}})},Be=(gt=u==null?void 0:u.state)==null?void 0:gt.fertilityCalculatorCandidates,Se=d==null?void 0:d.fertilityCalculatorCandidates,ve=g.useMemo(()=>{const t=[Array.isArray(Be)?Be:null,Array.isArray(Se)?Se:null].find(n=>Array.isArray(n)&&n.length>0);return t?t.map(n=>{if(!n)return null;const{source:r,day:s,reason:l}=n;if(r!=="CPM"&&r!=="T8")return null;const c=Number(s);return Number.isFinite(c)?{source:r,day:c,reason:typeof l=="string"?l:""}:null}).filter(Boolean):null},[Be,Se]),S=g.useMemo(()=>{const t=es(Te),n=ts(Te,ss),r=[];return Z==="auto"&&t&&r.push(t),b==="auto"&&n&&r.push(n),r},[Te,Z,b]),et=g.useMemo(()=>{const t=[],n=(r,s,l,c)=>{if(r!=="manual")return;const j=Number(l);if(!Number.isFinite(j)||j<=0)return;const M=Number(c),ee=Number.isFinite(M)&&M>0,O=ee?Number.isInteger(M)?`${M}`:`${Number(M.toFixed(2))}`:null,X=ee?s==="CPM"?`ciclo base: ${O} días`:`base ${Ds(s)}: ${O}`:null,te=X?`Manual desde dashboard (${X})`:"Manual desde dashboard";t.push({source:s,day:Math.max(1,j),reason:te,kind:"calculator",isManual:!0,manualBase:ee?M:null})};return n(Z,"CPM",oe,R),n(b,"T8",xe,he),t},[Z,oe,R,xe,he,b]),tt=g.useMemo(()=>{const t=new Map;(Array.isArray(ve)?ve:[]).forEach(l=>{const c=pt(l==null?void 0:l.source);c&&t.set(c,l)});const n=new Map;et.forEach(l=>{const c=pt(l==null?void 0:l.source);c&&n.set(c,l)});const r=Z==="manual"?n.get("CPM")??t.get("CPM")??null:Z==="auto"?S.find(l=>pt(l==null?void 0:l.source)==="CPM")??null:null,s=b==="manual"?n.get("T8")??t.get("T8")??null:b==="auto"?S.find(l=>pt(l==null?void 0:l.source)==="T8")??null:null;return[r,s].filter(Boolean)},[S,Z,et,ve,b]),st=async(t,n=!0)=>{if(!(d!=null&&d.id)||!(t!=null&&t.isoDate))return;const r=l=>{if(l==null||l==="")return null;const c=parseFloat(String(l).replace(",","."));return Number.isFinite(c)?c:null},s=n??!(t.peak_marker==="peak"||t.peakStatus==="P");Ge(!0);try{const l=t.timestamp?mt(nt(t.timestamp),"HH:mm"):mt(new Date,"HH:mm");let c=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:l,time_corrected:t.time_corrected??l,selected:!0,use_corrected:t.use_corrected??!1}];c.length===0&&(c=[{temperature:null,temperature_corrected:null,time:l,time_corrected:l,selected:!0,use_corrected:!1}]);const j=c.map((O,X)=>{const te=O.time||l,se=O.time_corrected||te;return{temperature:r(O.temperature??O.temperature_raw),time:te,selected:X===0?!0:!!O.selected,temperature_corrected:r(O.temperature_corrected),time_corrected:se,use_corrected:!!O.use_corrected}});j.some(O=>O.selected)||(j[0].selected=!0);const M={isoDate:t.isoDate,measurements:j,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",had_relations:t.had_relations??t.hadRelations??!1,ignored:t.ignored??!1,peak_marker:s?"peak":null},ee=t!=null&&t.id&&!String(t.id).startsWith("placeholder-")?t:null;await m(M,ee,d.id)}catch(l){console.error("Error toggling peak marker:",l)}finally{Ge(!1)}},rt=async(t,{keepFormOpen:n=!1}={})=>{if(d!=null&&d.id){Ge(!0);try{if(await m(t,Le,d.id),D){const r=await P(d.id);r&&h(r)}n||(Y(!1),Ae(null),_e(null))}finally{Ge(!1)}}},at=()=>{Y(!1),Ae(null),_e(null)},ct=t=>{Ae(t)},we=()=>{lt(t=>!t)},ht=g.useCallback(()=>{le(null)},[]),dt=t=>{if(t.preventDefault(),A.current){A.current=!1;return}we()},wt=t=>{t.pointerType==="touch"&&(t.preventDefault(),A.current=!0,we())},jt=g.useCallback((t={})=>{var V,q;if(!t)return;const n=t.phase??null,r=t.reasons??{},s=(r==null?void 0:r.aggregate)??null,l=Array.isArray(s==null?void 0:s.usedCandidates)?s.usedCandidates:[],c=(r==null?void 0:r.window)??(r==null?void 0:r.fertileWindow)??null,j=Number.isInteger(r==null?void 0:r.startIndex)?r.startIndex:Number.isInteger(r==null?void 0:r.fertileStartFinalIndex)?r.fertileStartFinalIndex:null,M=(s==null?void 0:s.selectedMode)??(F==null?void 0:F.combineMode)??null,ee=(()=>{var C;return(r==null?void 0:r.source)==="marker"||((C=r==null?void 0:r.details)==null?void 0:C.explicitStartDay)!=null?"Ajustado por marcadores":{conservador:"Modo conservador",consenso:"Modo consenso",permisivo:"Modo permisivo"}[M]??null})(),O=E=>((E==null?void 0:E.source)??(E==null?void 0:E.originalSource)??"").toString().toUpperCase(),X=()=>{const E=Number.isInteger(j)?j+1:null;return E?{candidate:l.find(re=>Number.isFinite(re==null?void 0:re.day)&&Math.round(re.day)===E)??l[0]??null,dayNumber:E}:{candidate:null,dayNumber:null}},te=(E="start")=>{const{candidate:C,dayNumber:re}=X();if(!C||!re)return null;const G=O(C),ce=(C==null?void 0:C.base)??(C==null?void 0:C.baseCycle)??(C==null?void 0:C.shortestCycle)??(C==null?void 0:C.referenceCycle)??(C==null?void 0:C.finalValue)??(C==null?void 0:C.baseValue)??null;if(G==="CPM")return E==="start"?`Iniciado por cálculo (ciclo más corto: día ${re}).`:ce?`Fin por cálculo del ciclo más corto (ciclo de ${ce} días).`:`Fin por cálculo del ciclo más corto (día ${re}).`;if(G==="T8"||G==="T-8"){const At=`día ${re}`;return E==="start"?`Iniciado por cálculo (día de subida en ciclos anteriores: T-8 = ${At}).`:`Fin por cálculo según el día de subida de temperatura (T-8 = ${At}).`}const Et=((C==null?void 0:C.reason)??"").toUpperCase(),Lt=Et.includes("S")||Et.includes("BIP");return E==="start"?Lt?`Iniciado por presencia de sensación fértil (día ${re}).`:`Iniciado por moco fértil (día ${re}).`:Lt?`Fin por presencia de sensación fértil (día ${re}).`:`Fin por presencia de moco fértil (día ${re}).`};let se=null,W="",B="",me=[],Fe=null;if(n==="relativeInfertile")W="Relativamente infértil",Number.isInteger(j)?B=te("end")??"Fin de fase relativamente infértil.":B="A la espera de cambio en la sensación o apariencia del moco.";else if(n==="fertile"){W="Fértil";const E=te("start")??"Inicio de fase fértil.",C=Number.isFinite(c==null?void 0:c.endIndex),re=Number.isInteger(c==null?void 0:c.mucusInfertileStartIndex),G=Number.isInteger(c==null?void 0:c.temperatureInfertileStartIndex);let ce=null;C?re&&G?ce="Fin determinado por moco y temperatura.":re?ce="Fin determinado por determinación de día pico.":G&&(ce="Fin determinado por curva de temperatura."):ce="A la espera de cierre por determinación de día pico o temperatura.",B=ce?`${E} ${ce}`:E}else if(n==="postOvulatory"){W="Infértil postovulatoria";const E=Number.isInteger((V=r==null?void 0:r.temperature)==null?void 0:V.startIndex)||Number.isInteger(c==null?void 0:c.temperatureInfertileStartIndex),C=Number.isInteger((q=r==null?void 0:r.mucus)==null?void 0:q.startIndex)||Number.isInteger(c==null?void 0:c.mucusInfertileStartIndex);E&&C?B="Determinada por moco y temperatura (doble criterio).":C?B="Determinada por moco.":E&&(B="Determinada por temperatura."),B||(B="Infertilidad postovulatoria."),(r==null?void 0:r.status)==="pending"&&(Fe="Pendiente completar el segundo criterio.")}else if(n==="nodata")((r==null?void 0:r.status)??(t==null?void 0:t.status)??null)==="no-fertile-window"?(W="Sin ventana fértil identificable",B="No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."):(W="Sin datos suficientes",B="Añade registros de sensación, moco o temperatura para interpretar el ciclo.");else if(t!=null&&t.message)W=t.message;else return;W&&(!se&&typeof(t==null?void 0:t.message)=="string"&&t.message.trim().length>0&&(se=t.message),le({header:se,title:W,body:B,reasons:me,note:Fe,modeLabel:ee}))},[F,le]),xt=async()=>{var r;const t=document.documentElement,n=typeof window<"u"?(r=window.screen)==null?void 0:r.orientation:null;if(v){if(n!=null&&n.unlock)try{await n.unlock()}catch(s){console.error(s)}try{const s=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen,l=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;s&&l&&await s.call(document)}catch(s){console.error(s)}De("portrait"),ge(!1)}else{const s=t.requestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullscreen,l=!!s,c=!!(n!=null&&n.lock);if(!l&&!c){window.alert("La pantalla completa no está disponible en este dispositivo.");return}let j=!1,M=!1;try{s&&(await s.call(t),j=!0)}catch(O){console.error(O)}if(c)try{await n.lock("landscape"),M=!0}catch(O){console.error(O)}j||M?(De("landscape"),ge(!0)):(De("portrait"),ge(!1))}};return e.jsx(yt,{hideBottomNav:v,children:e.jsxs("div",{className:v?"fixed inset-0 z-50 h-[100dvh] w-[100dvw] overflow-y-auto overflow-x-hidden":"relative w-full h-full overflow-y-auto overflow-x-hidden",style:ft,children:[J&&!v&&e.jsx(ot,{asChild:!0,variant:"ghost",className:"absolute top-4 left-4 z-10 bg-white/80 text-slate-700 hover:bg-[#E27DBF]/20",children:e.jsxs(kt,{to:`/cycle/${d.id}`,className:"flex items-center gap-1",children:[e.jsx(fs,{className:"h-4 w-4"}),qe&&e.jsx("span",{className:"ml-1 text-xs font-semibold text-slate-700 sm:text-sm",children:qe})]})}),e.jsx(ot,{onClick:()=>i(t=>!t),variant:"ghost",size:"icon",className:"absolute top-16 right-4 z-10 p-2 rounded-full bg-white/80 shadow-lg shadow-slate-300/50 text-slate-700 hover:bg-[#E27DBF]/20","aria-label":"Ajustes del gráfico",children:e.jsx(xs,{className:"h-4 w-4"})}),e.jsx(ot,{onClick:dt,onPointerUp:wt,variant:"ghost",size:"icon",className:`absolute top-4 right-20 z-10 p-2 rounded-full transition-colors ${He?"bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg shadow-pink-300/50 border-pink-400":"bg-white/80 text-slate-600 hover:bg-pink-50/80 shadow-md border-pink-200/50"}`,children:He?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(ps,{className:"h-4 w-4"})}),e.jsx(ot,{onClick:xt,className:"absolute top-4 right-4 z-10 bg-white/80 rounded-full text-slate-600 hover:bg-pink-50/80 shadow-md border border-pink-200/50 backdrop-blur-sm","aria-label":v?"Salir de pantalla completa":"Rotar gráfico",children:e.jsx(ms,{className:"w-4 h-4"})}),e.jsx(Bs,{data:Re,isFullScreen:v,orientation:ne,onToggleIgnore:We,onEdit:Ie,onTogglePeak:st,cycleId:d.id,initialScrollIndex:Xe,visibleDays:$e,showInterpretation:He,reduceMotion:!0,forceLandscape:ne==="landscape",currentPeakIsoDate:Me,showRelationsRow:_.showRelationsRow,fertilityStartConfig:$,fertilityCalculatorCycles:Te,fertilityCalculatorCandidates:tt,onShowPhaseInfo:jt,isArchivedCycle:!k,cycleEndDate:(d==null?void 0:d.endDate)??null}),a&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/30",onClick:()=>i(!1),"aria-hidden":"true"}),e.jsx("div",{className:`fixed top-0 right-0 z-50 h-dvh w-72 sm:w-80 transform transition-transform duration-300 ease-in-out ${a?"translate-x-0":"translate-x-full"}`,role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col gap-6 border-l border-rose-100/60 bg-white p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-700",children:"Ajustes del gráfico"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Personaliza la visualización de filas adicionales en la gráfica."})]}),e.jsx(ot,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-slate-600",onClick:()=>i(!1),"aria-label":"Cerrar ajustes del gráfico",children:"×"})]}),e.jsxs("div",{className:"space-y-4 overflow-y-auto pr-1",children:[e.jsxs("div",{className:"rounded-xl border border-rose-100/70 bg-rose-50/40 p-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"max-w-xs",children:[e.jsx(us,{htmlFor:"toggle-relations-row",className:"text-sm font-semibold text-slate-700",children:"Mostrar fila de Relaciones (RS)"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Añade una fila dedicada a las relaciones sexuales debajo de la gráfica."})]}),e.jsx(bt,{id:"toggle-relations-row",checked:_.showRelationsRow,onCheckedChange:Ze,className:"mt-1"})]}),e.jsxs("div",{className:"rounded-xl border border-purple-100/70 bg-purple-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Perfiles sintotérmicos"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Activa los métodos que quieras considerar para detectar el inicio fértil."})]}),e.jsx("div",{className:"space-y-2",children:_s.map(t=>{var n;return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-sm text-slate-700",children:t.label}),e.jsx(bt,{checked:!!((n=F.methods)!=null&&n[t.key]),onCheckedChange:r=>Qe(t.key,r)})]},t.key)})})]}),e.jsxs("div",{className:"rounded-xl border border-amber-100/70 bg-amber-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Calculadoras complementarias"}),e.jsx("p",{className:"text-xs text-slate-500",children:"CPM y T-8 se combinan con los perfiles activos, salvo que actives el modo posparto."})]}),F.postpartum&&e.jsx("p",{className:"text-xs font-medium text-rose-500",children:"El modo posparto está activo: CPM y T-8 se omiten del cálculo final."}),e.jsx("div",{className:"space-y-2",children:$s.map(t=>{var n;return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-sm text-slate-700",children:t.label}),e.jsx(bt,{checked:!!((n=F.calculators)!=null&&n[t.key]),onCheckedChange:r=>Ee(t.key,r)})]},t.key)})})]}),e.jsxs("div",{className:"rounded-xl border border-sky-100/70 bg-sky-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Modo de combinación"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Determina cómo se elige el inicio fértil a partir de los candidatos disponibles."})]}),e.jsxs(ns,{value:F.combineMode,onValueChange:ie,children:[e.jsx(ls,{className:"w-full bg-white/80 border-slate-200 text-sm text-slate-700",children:e.jsx(is,{placeholder:"Selecciona un modo"})}),e.jsx(cs,{className:"bg-white border-slate-200 text-slate-700",children:Object.entries(Rt).map(([t,n])=>e.jsx(ds,{value:t,className:"text-sm",children:n},t))})]}),e.jsxs("div",{className:"flex items-start justify-between gap-3 pt-1",children:[e.jsxs("div",{className:"max-w-[65%]",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-700",children:"Modo posparto"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Ignora automáticamente CPM y T-8."})]}),e.jsx(bt,{checked:!!F.postpartum,onCheckedChange:Ve,className:"mt-1"})]})]})]})]})}),e.jsx(Ts,{isOpen:!!x,onClose:ht,ariaLabel:"Detalle de interpretación del ciclo",containerClassName:"p-6",children:x&&e.jsxs("div",{className:"space-y-4 text-left",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[x.header&&e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-pink-600",children:x.header}),e.jsx("h2",{className:"text-lg font-semibold text-slate-800",children:x.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[x.modeLabel&&e.jsx("span",{className:"rounded-full border border-rose-100 bg-rose-50 px-3 py-1 text-[11px] font-semibold text-rose-700",children:x.modeLabel}),e.jsx("button",{type:"button",onClick:ht,className:"rounded-full p-1 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-200","aria-label":"Cerrar detalle de interpretación",children:e.jsx(Yt,{className:"h-5 w-5"})})]})]}),x.body&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-600",children:x.body}),Array.isArray(x.reasons)&&x.reasons.length>0&&e.jsx("ul",{className:"list-disc space-y-1 pl-5 text-sm text-slate-600",children:x.reasons.map((t,n)=>e.jsx("li",{children:t},`${t}-${n}`))}),x.note&&e.jsx("p",{className:"text-xs text-slate-500",children:x.note})]})}),e.jsx(as,{open:ke,onOpenChange:t=>{t||at()},children:e.jsx(os,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Jt,{onSubmit:rt,onCancel:at,initialData:Le,cycleStartDate:d.startDate,cycleEndDate:d.endDate,isProcessing:Oe,isEditing:!!Le&&!Q,cycleData:d.data,onDateSelect:ct,initialSectionKey:ye})})})]})})};export{Js as default};
