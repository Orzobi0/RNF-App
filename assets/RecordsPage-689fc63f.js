import{c as Kt,r as n,g as v,f,j as r,I as D,B as Ce,N as La,b as Oa,Q as y,l as K,S as Ra,O as Vt,n as Pa,m as ve}from"./index-2f41c8cd.js";import{L as ot,T as za,P as Ba,N as Ha,C as Va}from"./NewCycleDialog-c52b1f5b.js";import{T as Ua,j as Xa,h as $a,e as qa,c as Ya,m as Ut,k as De,i as Oe,l as Ga,A as Wa,n as Ka,D as Qa,F as Xt}from"./computePeakStatuses-8ec0bab9.js";import{e as it,P as Za}from"./badge-4c7d2230.js";import{D as Ja}from"./DeletionDialog-31da8265.js";import{u as es,D as ts,a as as}from"./useCycleData-9f76d19f.js";import"./OverlapWarningDialog-038e0dd4.js";import"./input-c95d25ec.js";import"./label-270ed458.js";import"./checkbox-2e1f35be.js";import"./eye-fe5b932b.js";const lt=Kt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),ss=Kt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),rs=({isoDate:x,cycleDay:C,details:i,peakStatus:Q,isPeakDay:fe,onEdit:b,onDelete:me,onAdd:R,onToggleRelations:Ne,isProcessing:N})=>{var _e,te,Ee,z;const Re=!!(i!=null&&i.record),Se=n.useMemo(()=>{if(!x)return null;try{return v(f(x),"dd/MM/yyyy",{locale:it})}catch{return null}},[x]),pe=((_e=i==null?void 0:i.symbolInfo)==null?void 0:_e.label)||"Sin símbolo",Pe=((te=i==null?void 0:i.symbolInfo)==null?void 0:te.value)||"none",ze=((Ee=i==null?void 0:i.symbolInfo)==null?void 0:Ee.pattern)==="spotting-pattern"?"spotting-pattern-icon":"",je=()=>{!(i!=null&&i.record)||!b||b(i.record,null)},Z=()=>{var w;!((w=i==null?void 0:i.record)!=null&&w.id)||!me||me(i.record.id)},Be=()=>{!x||!R||R(x)},A=(w,B=null)=>{if(i!=null&&i.record&&b){b(i.record,w,B);return}x&&R&&R(x,w,B)},He=()=>{!x||!Ne||Ne(x)},P=(w,B={})=>w&&typeof w=="string"&&w.trim().length>0||typeof w=="number"?w:B.placeholder||"—",Ve=i!=null&&i.hasTemperature?`${i.displayTemp} °C`:"—",Ue=(i==null?void 0:i.timeValue)||"—",Xe=!!(i!=null&&i.timeValue),$e=i!=null&&i.hasMucusSensation?i.mucusSensation:"—",qe=i!=null&&i.hasMucusAppearance?i.mucusAppearance:"—",ke=(z=i==null?void 0:i.observationsText)==null?void 0:z.trim(),J=!!(i!=null&&i.hasRelations);let ee=null,he=null;Q&&(Q==="P"||fe?(ee="Día pico",he="peak"):(ee=`+${Q}`,he="post-peak"));const Ye=()=>{switch(Pe){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!x)return r.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const e="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return r.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Se,C?` · D${C}`:""]}),ee&&r.jsx("span",{className:D("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:ee})]}),r.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:()=>A("symbol","fertilitySymbol"),className:D("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ye(),ze),title:pe,"aria-label":pe}),Re?r.jsxs(r.Fragment,{children:[r.jsxs(Ce,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:je,disabled:N,children:[N?r.jsx(ot,{className:"h-4 w-4 animate-spin"}):r.jsx(ss,{className:"h-4 w-4"}),r.jsx("span",{className:"sr-only",children:"Editar registro"})]}),r.jsxs(Ce,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Z,disabled:N,children:[N?r.jsx(ot,{className:"h-4 w-4 animate-spin"}):r.jsx(za,{className:"h-4 w-4"}),r.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):r.jsxs(Ce,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:Be,disabled:N,children:[N&&r.jsx(ot,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),r.jsxs("div",{className:"mt-4 space-y-3",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("button",{type:"button",onClick:()=>A("temperature","temperature"),className:D(e,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[r.jsx(Ua,{className:"h-5 w-5 opacity-80"}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("span",{className:"font-semibold",children:P(Ve)}),(i==null?void 0:i.showCorrectedIndicator)&&r.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),r.jsxs("button",{type:"button",onClick:()=>A("temperature","time"),className:D(e,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Xe?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[r.jsx(Xa,{className:"h-5 w-5 opacity-80"}),r.jsx("span",{className:"font-semibold",children:P(Ue)})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("button",{type:"button",onClick:()=>A("sensation","mucusSensation"),className:D(e,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[r.jsx($a,{className:"h-5 w-5 opacity-80"}),r.jsx("span",{className:"font-semibold",children:P($e)})]}),r.jsxs("button",{type:"button",onClick:()=>A("appearance","mucusAppearance"),className:D(e,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[r.jsx(qa,{className:"h-5 w-5 opacity-80"}),r.jsx("span",{className:"font-semibold",children:P(qe)})]})]}),r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsxs("button",{type:"button",onClick:()=>A("observations","observations"),className:D(e,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",ke?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[r.jsx(lt,{className:"h-5 w-5 opacity-80"}),r.jsx("span",{className:"truncate",children:P(ke,{placeholder:"-"})})]}),r.jsx("button",{type:"button",onClick:He,disabled:N,className:D("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",J?"border-rose-500 bg-rose-50":"border-slate-200 bg-white",N&&"opacity-70 cursor-not-allowed"),title:J?"Hubo relaciones":"Sin relaciones","aria-label":J?"Hubo relaciones":"Sin relaciones",children:r.jsx(La,{className:D("h-4 w-4",J?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},ns=x=>Xt.find(C=>C.value===x)||Xt[0],$t=10,qt=60,Yt=400,Gt=120,Wt=85,os=5,ye=160,is=x=>{if(x==null||x==="")return null;const C=Number(typeof x=="string"?x.replace(",","."):x);return Number.isFinite(C)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(C):null},ls=({cycle:x,headerTitle:C,headerIcon:i=lt,headerActions:Q,topAccessory:fe,includeEndDate:b=!1,addOrUpdateDataPoint:me,deleteRecord:R,isLoading:Ne,updateCycleDates:N,checkCycleOverlap:Re,forceShiftNextCycleStart:Se,forceUpdateCycleStart:pe,startNewCycle:Pe,refreshData:ze,afterRecordsContent:je=null,onRequestDeleteCycle:Z=null,dateEditorDeleteTitle:Be="Eliminar ciclo",dateEditorDeleteDescription:A="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:He="Eliminar ciclo",isDeletingCycle:P=!1}={})=>{const{currentCycle:Ve,addOrUpdateDataPoint:Ue,deleteRecord:Xe,isLoading:$e,updateCycleDates:qe,checkCycleOverlap:ke,forceUpdateCycleStart:J,forceShiftNextCycleStart:ee,startNewCycle:he,refreshData:Ye}=es(),e=x??Ve,_e=Ne??$e,te=me||(async(a,s)=>{if(e!=null&&e.id)return Ue(a,s,e.id)}),Ee=R||(async a=>{if(e!=null&&e.id)return Xe(a,e.id)}),z=N||(async(a,s,t)=>qe(a??(e==null?void 0:e.id),s,t)),w=Re??ke,B=pe||(async(a,s)=>J(a??(e==null?void 0:e.id),s)),Ge=Se||(async(a,s,t)=>ee(a??(e==null?void 0:e.id),s,t)),Qt=Pe??he,Me=ze??Ye,{toast:k}=Oa(),[Zt,H]=n.useState(!1),[We,ae]=n.useState(null),[se,Ke]=n.useState(null),[re,ne]=n.useState(!1),[Jt,ct]=n.useState(!1),[V,Ae]=n.useState(()=>(e==null?void 0:e.startDate)||""),[U,Te]=n.useState(()=>(e==null?void 0:e.endDate)||""),[ea,T]=n.useState(""),[F,ut]=n.useState(null),[Qe,dt]=n.useState(null),[Ze,ft]=n.useState(!1),[ta,mt]=n.useState(null),[aa,Je]=n.useState(!1),[et,xe]=n.useState(!1),[m,X]=n.useState(null),[sa,$]=n.useState(null),[ra,be]=n.useState(null),[na,oe]=n.useState(null),[oa,tt]=n.useState(!1),pt=n.useMemo(()=>{if(!(e!=null&&e.startDate))return null;const a=f(e.startDate);if(!y(a))return null;const s=v(a,"dd/MM/yyyy");let t="En curso";if(e!=null&&e.endDate){const o=f(e.endDate);y(o)&&(t=v(o,"dd/MM/yyyy"))}return`${s} - ${t}`},[e==null?void 0:e.endDate,e==null?void 0:e.startDate]),ia=n.useMemo(()=>C||((e==null?void 0:e.type)==="current"||!(e!=null&&e.endDate)?"Ciclo actual":pt??"Mis registros"),[e==null?void 0:e.endDate,e==null?void 0:e.type,pt,C]),ht=!0,Fe=n.useRef(null),xt=n.useRef(null),bt=n.useRef(0),[gt,wt]=n.useState(0),Ie=n.useCallback(()=>{const a=Fe.current;if(!a){bt.current=0,wt(0);return}const t=a.getBoundingClientRect().height;bt.current=t,wt(o=>Math.abs(o-t)>.5?t:o)},[]);n.useLayoutEffect(()=>{let a=window.requestAnimationFrame(Ie);const s=()=>{a&&window.cancelAnimationFrame(a),a=window.requestAnimationFrame(Ie)};window.addEventListener("resize",s);let t;return typeof ResizeObserver<"u"&&(t=new ResizeObserver(()=>{a&&window.cancelAnimationFrame(a),a=window.requestAnimationFrame(Ie)}),Fe.current&&t.observe(Fe.current)),()=>{window.removeEventListener("resize",s),t&&t.disconnect(),a&&window.cancelAnimationFrame(a)}},[Ie]);const vt=n.useMemo(()=>Math.max(Math.round(gt+$t),$t),[gt]);n.useEffect(()=>{Ae((e==null?void 0:e.startDate)||""),Te((e==null?void 0:e.endDate)||"")},[e==null?void 0:e.startDate,e==null?void 0:e.endDate]);const ie=n.useMemo(()=>{var a;return(a=e==null?void 0:e.data)!=null&&a.length?[...e.data].filter(s=>s==null?void 0:s.isoDate).sort((s,t)=>{const o=f(s.isoDate);return f(t.isoDate)-o}).map(s=>s.isoDate):[]},[e==null?void 0:e.data]);n.useEffect(()=>{const a=xt.current;a&&a.scrollTo({top:0,behavior:"auto"})},[]);const le=n.useMemo(()=>{var a;return(a=e==null?void 0:e.data)!=null&&a.length?e.data.map(s=>{if(!(s!=null&&s.isoDate))return null;const t=f(s.isoDate);return y(t)?t:null}).filter(Boolean):[]},[e==null?void 0:e.data]),Dt=n.useMemo(()=>new Set(ie),[ie]),at=n.useMemo(()=>Ya((e==null?void 0:e.data)??[]),[e==null?void 0:e.data]),ce=n.useMemo(()=>{var s;const a=new Map;return(s=e==null?void 0:e.data)!=null&&s.length&&e.data.forEach(t=>{var Ht;if(!(t!=null&&t.isoDate))return;const o=((Ht=t.measurements)==null?void 0:Ht.find(nt=>nt==null?void 0:nt.selected))||(t.temperature_chart||t.temperature_raw?{temperature:t.temperature_chart??t.temperature_raw,temperature_corrected:t.temperature_corrected??null,time:t.timestamp?v(f(t.timestamp),"HH:mm"):null,use_corrected:t.use_corrected??!1}:null),c=(o==null?void 0:o.use_corrected)??t.use_corrected??!1,u=(o==null?void 0:o.temperature_corrected)??t.temperature_corrected??null,p=(o==null?void 0:o.temperature)??t.temperature_chart??t.temperature_raw??null,h=is(c&&u!==null&&u!==void 0&&u!==""?u:p??u),g=h!==null,j=c&&u!==null&&u!==void 0&&u!=="";let M=null;o!=null&&o.time?M=o.time:t.timestamp&&y(f(t.timestamp))&&(M=v(f(t.timestamp),"HH:mm"));const G=t.mucusSensation??t.mucus_sensation??"",W=t.mucusAppearance??t.mucus_appearance??"",O=!!G,we=!!W,Ma=O||we,zt=t.observations||"",Aa=!!zt,Ta=!!(t.had_relations??t.hadRelations??!1),Bt=at[t.isoDate]||null,Fa=t.peak_marker==="peak"||Bt==="P",Ia=ns(t.fertility_symbol);a.set(t.isoDate,{record:t,symbolInfo:Ia,hasTemperature:g,displayTemp:h,showCorrectedIndicator:j,timeValue:M,hasMucus:Ma,hasMucusSensation:O,hasMucusAppearance:we,mucusSensation:G,mucusAppearance:W,hasObservations:Aa,observationsText:zt,hasRelations:Ta,peakStatus:Bt,isPeakDay:Fa})}),a},[e==null?void 0:e.data,at]),d=n.useMemo(()=>{if(!(e!=null&&e.startDate))return null;const a=f(e.startDate);if(!y(a))return null;let s;if(e!=null&&e.endDate)s=f(e.endDate);else{const t=K(new Date),o=[a,t];le.length&&o.push(Ut(le)),s=Ut(o)}return y(s)?{from:a,to:s}:{from:a,to:a}},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,le]),la=n.useMemo(()=>{const a={};return d&&(a.outsideCycle=s=>De(s,d.from)||Oe(s,d.to),a.insideCycleNoRecord=s=>{if(De(s,d.from)||Oe(s,d.to))return!1;const t=v(s,"yyyy-MM-dd");return!Dt.has(t)}),le.length&&(a.hasRecord=le),a},[d,le,Dt]),ca=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:D(Ra({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-2xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"rounded-2xl border border-rose-400 text-rose-600 focus:ring-2 focus:ring-rose-300 focus:ring-offset-2",day_today:"rounded-2xl ring-1 ring-rose-300 text-rose-700 font-semibold bg-transparent"}),[]),[yt,st]=n.useState(()=>m&&y(f(m))?f(m):d!=null&&d.to?d.to:K(new Date)),ge=n.useRef(!1),_=n.useRef(null),ua=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1}),S=n.useRef(null),Ct=n.useRef(null),Nt=n.useRef(null),St=n.useRef(0),[da,fa]=n.useState(0),[jt,kt]=n.useState(!1),I=n.useCallback(a=>{St.current=a,fa(a)},[]),_t=n.useCallback(()=>new Promise(a=>{requestAnimationFrame(()=>{requestAnimationFrame(a)})}),[]),ue=n.useCallback((a,{duration:s=ye}={})=>{_.current&&(cancelAnimationFrame(_.current),_.current=null);const t=St.current,o=a-t;return Math.abs(o)<.5||s<=0?(I(a),Promise.resolve()):new Promise(c=>{const u=h=>1-Math.pow(1-h,3),p=performance.now(),l=h=>{const g=h-p,j=Math.min(1,g/s),M=t+o*u(j);if(I(M),j<1){_.current=requestAnimationFrame(l);return}_.current=null,c()};_.current=requestAnimationFrame(l)})},[I]),ma=n.useMemo(()=>({labelDay:a=>{const s=v(a,"yyyy-MM-dd"),t=ce.get(s),o=v(a,"d MMM",{locale:it});if(!t)return o;const c=[];if(t.hasTemperature&&t.hasMucus?c.push("temperatura y moco"):t.hasTemperature?c.push("temperatura"):t.hasMucus&&c.push("moco"),t.hasRelations&&c.push("RS"),t.peakStatus){const u=t.peakStatus==="P"?"pico ✖":`pico +${t.peakStatus}`;c.push(u)}return c.length?`${o}: ${c.join("; ")}`:o}}),[ce]),pa=n.useCallback(({date:a,activeModifiers:s})=>{const t=v(a,"yyyy-MM-dd"),o=ce.get(t),c=(o==null?void 0:o.hasTemperature)??!1,u=(o==null?void 0:o.hasMucus)??!1;o==null||o.hasRelations;const p=(o==null?void 0:o.peakStatus)??null,l=o==null?void 0:o.symbolInfo,h=l==null?void 0:l.value,g=s.selected,j=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",c?"bg-amber-500":"bg-transparent",c&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),M=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",u?"bg-teal-500":"bg-transparent",u&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),G=!!(h&&h!=="none"),W=D("relative z-10 text-[1.15rem] leading-none",s.outside||s.outsideCycle?"text-slate-300":g?G?"text-white":"text-rose-600":"text-slate-700"),O=p==="P"?"✖":p?`+${p}`:null,we=G?D("pointer-events-none absolute inset-0 rounded-full transition-opacity",(l==null?void 0:l.color)??"",(l==null?void 0:l.pattern)==="spotting-pattern"?"calendar-spotting-dot":"",h==="white"?"ring-1 ring-slate-300/70":"",g?"opacity-50":"opacity-25"):null;return r.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[r.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[we&&r.jsx("span",{className:we,"aria-hidden":"true"}),r.jsx("span",{className:W,children:v(a,"d")})]}),r.jsxs("div",{className:"mt-[0.22rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[r.jsx("span",{className:j}),r.jsx("span",{className:M})]}),O&&r.jsx("span",{"aria-hidden":"true",className:D("pointer-events-none absolute -top-[1px] right-[1px] rounded-sm px-[2px] text-[0.55rem] font-semibold leading-none text-rose-500 shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",g?"bg-rose-100/90 text-rose-700":"bg-white/90"),children:O})]})},[ce]),L=n.useMemo(()=>{if(!(e!=null&&e.startDate))return[];const a=f(e.startDate);if(!y(a))return[];const s=K(a),t=K(new Date);let o=d!=null&&d.to?K(d.to):t;Oe(o,t)&&(o=t),De(o,s)&&(o=s);const c=Vt(o,s)+1;if(c<=0)return[];const u=[];for(let p=c-1;p>=0;p-=1){const l=Pa(s,p),h=v(l,"yyyy-MM-dd"),g=Vt(l,s)+1,j=ce.get(h)||null;u.push({isoDate:h,date:l,cycleDay:g,details:j})}return u},[e==null?void 0:e.startDate,d,ce]),Et=n.useMemo(()=>new Set(L.map(a=>a.isoDate)),[L]),ha=n.useMemo(()=>{const a=new Map;return L.forEach(s=>{a.set(s.isoDate,s)}),a},[L]),de=m&&ha.get(m)||null,q=(de==null?void 0:de.details)??null,Mt=(q==null?void 0:q.peakStatus)??(m?at[m]??null:null),xa=(q==null?void 0:q.isPeakDay)??Mt==="P",Le=n.useMemo(()=>{const a=d!=null&&d.to?v(K(d.to),"yyyy-MM-dd"):null;return b?a??ie[0]??null:ie.length?ie[0]:a},[b,d,ie]);n.useEffect(()=>{if(!(m&&Et.has(m))){if(!Le){m!==null&&X(null);return}m!==Le&&X(Le)}},[m,Et,Le]);const At=n.useCallback(a=>{if(!a)return;const s=v(a,"yyyy-MM-dd");d&&(De(a,d.from)||Oe(a,d.to))||X(s)},[d]);n.useEffect(()=>{if(!m)return;const a=f(m);y(a)&&st(s=>s&&s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()?s:a)},[m]);const Tt=n.useCallback(a=>{st(s=>{const t=s??(d==null?void 0:d.to)??K(new Date);return Ga(t,a==="next"?1:-1)})},[d]);n.useEffect(()=>{const a=Ct.current;if(!a)return;const s=a.querySelector(".records-calendar-day-grid");s&&(Nt.current=s)},[yt,ht,I]);const rt=n.useCallback(async a=>{var p;if(ge.current)return;ge.current=!0;const s=Nt.current,t=((p=s==null?void 0:s.getBoundingClientRect())==null?void 0:p.width)??0,o=a==="next"?-Gt:Gt,c=t?a==="next"?-t:t:o,u=-c;try{await ue(c,{duration:ye}),Tt(a),I(u),await _t(),await ue(0,{duration:ye})}finally{ge.current=!1}},[ue,Tt,I,_t]),E=n.useCallback(()=>{ut(null),dt(null),ft(!1),mt(null),Je(!1)},[]);n.useEffect(()=>()=>{_.current&&(cancelAnimationFrame(_.current),_.current=null),S.current&&(S.current(),S.current=null)},[]);const Ft=n.useCallback(()=>{Ae((e==null?void 0:e.startDate)||""),Te((e==null?void 0:e.endDate)||""),T(""),E(),ct(!0)},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,E]),Y=n.useCallback(()=>{ct(!1),T(""),E(),Ae((e==null?void 0:e.startDate)||""),Te((e==null?void 0:e.endDate)||"")},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,E]),ba=n.useCallback(()=>{Z&&(Y(),Z())},[Y,Z]),ga=n.useCallback(a=>{var p;if(ge.current||a.pointerType==="mouse"&&a.button!==0||!a.target.closest(".records-calendar-day-grid"))return;const t=ua.current;t.active=!0,t.pointerId=a.pointerId,t.startX=a.clientX,t.startTime=performance.now(),t.dragging=!1;const o=l=>{if(!t.active||l.pointerId!==t.pointerId)return;const h=l.clientX-t.startX;if(!t.dragging&&Math.abs(h)>os&&(t.dragging=!0,kt(!0)),!t.dragging)return;const g=Math.max(-Wt,Math.min(Wt,h));l.preventDefault(),I(g)},c=async l=>{var O;if(!t.active||l.pointerId!==t.pointerId)return;(O=S.current)==null||O.call(S),S.current=null,t.active=!1;const h=l.clientX-t.startX,g=performance.now()-t.startTime,j=g>0?h/g*1e3:0,M=h<=-qt||j<=-Yt,G=h>=qt||j>=Yt,W=t.dragging;if(t.dragging=!1,kt(!1),ge.current){await ue(0,{duration:ye});return}if(W&&M){await rt("next");return}if(W&&G){await rt("prev");return}await ue(0,{duration:ye})},u=()=>{window.removeEventListener("pointermove",o,{capture:!0}),window.removeEventListener("pointerup",c,{capture:!0}),window.removeEventListener("pointercancel",c,{capture:!0})};(p=S.current)==null||p.call(S),S.current=u,window.addEventListener("pointermove",o,{capture:!0,passive:!1}),window.addEventListener("pointerup",c,{capture:!0}),window.addEventListener("pointercancel",c,{capture:!0})},[rt,ue,ht,I]),wa=n.useCallback(()=>{E()},[E]),va=n.useCallback(async()=>{if(!V){T("La fecha de inicio es obligatoria");return}if(b&&U&&U<V){T("La fecha de fin no puede ser anterior al inicio");return}if(e!=null&&e.id){T(""),xe(!0);try{const a=w?await w(e.id,V,b&&U||void 0):null;if(a){ut(V),dt((b&&U||void 0)??null),ft(!!b),mt(a),Je(!0),xe(!1);return}await z(e.id,V,b&&U||void 0),await Me({silent:!0}),k({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),Y()}catch(a){console.error("Error updating start date from records page:",a),T("No se pudieron actualizar las fechas"),k({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{xe(!1)}}},[V,U,b,e==null?void 0:e.id,w,z,Me,k,Y]),Da=n.useCallback(async()=>{if(!(e!=null&&e.id)||!F){E();return}xe(!0),Je(!1);try{const a=e.startDate,s=e.endDate??void 0,t=F!==a,o=t&&F&&a&&De(f(F),f(a)),c=Ze?Qe??void 0:void 0,u=Ze&&Qe!==null&&c!==s;if(o&&await B(e.id,F),u&&c&&Ge){const p=t?F:a;await Ge(e.id,c,p)}await z(e.id,t?F:void 0,c),await Me({silent:!0}),k({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),Y()}catch(a){console.error("Error adjusting cycle dates from records page:",a),T("No se pudieron actualizar las fechas"),k({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{xe(!1),E()}},[e==null?void 0:e.id,e==null?void 0:e.startDate,e==null?void 0:e.endDate,F,Ze,Qe,B,Ge,z,Me,k,Y,E]),It=n.useCallback(()=>{H(!1),ae(null),$(null),be(null),oe(null)},[]),Lt=n.useCallback((a,s=null,t=null)=>{a&&(ae(a),$(a.isoDate??null),be(s),oe(t??null),a.isoDate&&X(a.isoDate),H(!0))},[]),ya=n.useCallback((a,s=null,t=null)=>Lt(a,t,s),[Lt]),Ca=a=>{var t;const s=(t=e==null?void 0:e.data)==null?void 0:t.find(o=>o.id===a);Ke(s||null)},Na=n.useCallback(a=>{ae(a)},[]),Sa=n.useCallback((a,s=null,t=null)=>{a&&(X(a),ae(null),$(a),be(t),oe(s),H(!0))},[]),Ot=n.useCallback(()=>{const a=L.length?L[0].isoDate:(e==null?void 0:e.startDate)||null,s=m||a||null;ae(null),$(s),be(null),oe(null),s&&X(s),H(!0)},[L,e==null?void 0:e.startDate,m]),Rt=n.useCallback((a,s={})=>{var u,p;const t=((u=e==null?void 0:e.data)==null?void 0:u.find(l=>l.isoDate===a))||null,o=t!=null&&t.timestamp&&y(f(t.timestamp))?v(f(t.timestamp),"HH:mm"):v(new Date,"HH:mm"),c=(p=t==null?void 0:t.measurements)!=null&&p.length?t.measurements.map((l,h)=>{const g=(l==null?void 0:l.time)||(l!=null&&l.timestamp&&y(f(l.timestamp))?v(f(l.timestamp),"HH:mm"):o);return{temperature:(l==null?void 0:l.temperature)??(l==null?void 0:l.temperature_raw)??"",temperature_corrected:(l==null?void 0:l.temperature_corrected)??"",time:g,time_corrected:(l==null?void 0:l.time_corrected)||g,use_corrected:!!(l!=null&&l.use_corrected),selected:!!((l==null?void 0:l.selected)??h===0)}}):[{temperature:"",temperature_corrected:"",time:o,time_corrected:o,use_corrected:!1,selected:!0}];return{isoDate:a,measurements:c,mucusSensation:(t==null?void 0:t.mucusSensation)??(t==null?void 0:t.mucus_sensation)??"",mucusAppearance:(t==null?void 0:t.mucusAppearance)??(t==null?void 0:t.mucus_appearance)??"",fertility_symbol:(t==null?void 0:t.fertility_symbol)??(t==null?void 0:t.fertilitySymbol)??"none",observations:(t==null?void 0:t.observations)??"",peak_marker:(t==null?void 0:t.peak_marker)??null,ignored:(t==null?void 0:t.ignored)??!1,...s}},[e==null?void 0:e.data]),ja=async(a,{keepFormOpen:s=!1}={})=>{ne(!0);try{await te(a,We),s||(H(!1),ae(null),$(null),be(null),oe(null))}catch{k({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{ne(!1),s&&$((a==null?void 0:a.isoDate)??null)}},ka=n.useCallback(async a=>{var c;if(!a)return;const s=((c=e==null?void 0:e.data)==null?void 0:c.find(u=>u.isoDate===a))||null,t=!!((s==null?void 0:s.had_relations)??(s==null?void 0:s.hadRelations)??!1),o=Rt(a,{had_relations:!t,hadRelations:!t});ne(!0);try{await te(o,s)}catch{k({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{ne(!1)}},[te,Rt,e==null?void 0:e.data,k]),_a=async()=>{if(se){ne(!0);try{const a=se.isoDate;await Ee(se.id),Ke(null),$(null),a&&m===a&&X(a)}catch{k({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{ne(!1)}}},Pt={openDateEditor:Ft,openAddRecord:Ot,isProcessing:re,isUpdatingDates:et,cycle:e},Ea=typeof Q=="function"?Q(Pt):r.jsxs(r.Fragment,{children:[r.jsxs(Ce,{type:"button",variant:"outline",size:"icon",onClick:Ft,className:"border-fertiliapp-suave rounded-full bg-secundario text-white hover:brightness-95",disabled:re||et,"aria-label":b?"Editar fechas del ciclo":"Editar fecha de inicio",children:[r.jsx(Ba,{className:"h-4 w-4"}),r.jsx("span",{className:"sr-only",children:b?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),r.jsxs(Ce,{type:"button",size:"icon",onClick:Ot,className:"rounded-full border border-fertiliapp-fuerte bg-white/80 hover:brightness-95 text-fertiliapp-fuerte shadow-md",disabled:re,style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},"aria-label":"Añadir registro",children:[r.jsx(Za,{className:"h-4 w-4"}),r.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]});return typeof fe=="function"&&fe({...Pt}),_e&&!(e!=null&&e.id)?r.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:r.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):e!=null&&e.id?r.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[r.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[r.jsx("div",{ref:Fe,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:r.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:r.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[r.jsx(ve.div,{className:"flex flex-col gap-4",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:r.jsxs("div",{className:"flex flex-wrap items-center gap-1 justify-between sm:justify-start",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(i,{className:"h-7 w-7 text-subtitulo"}),r.jsx("span",{className:"text-2xl sm:text-2xl font-bold text-subtitulo",children:ia})]}),r.jsx("div",{className:"flex items-center gap-1",children:Ea})]})}),Jt&&r.jsx(ve.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:r.jsx(Va,{cycle:e,startDate:V,endDate:b?U:e==null?void 0:e.endDate,onStartDateChange:a=>Ae(a),onEndDateChange:b?a=>Te(a):void 0,onSave:va,onCancel:Y,isProcessing:et,dateError:ea,includeEndDate:b,showOverlapDialog:aa,overlapCycle:ta,onConfirmOverlap:Da,onCancelOverlap:wa,onClearError:()=>T(""),saveLabel:b?"Guardar fechas":"Guardar cambios",title:b?"Editar fechas del ciclo":"Editar fecha de inicio",description:b?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:Z?ba:void 0,deleteTitle:Be,deleteDescription:A,deleteLabel:He,isDeletingCycle:P})}),r.jsx(Wa,{initial:!1,children:r.jsx(ve.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:r.jsx("div",{ref:Ct,onPointerDown:ga,"data-calendar-dragging":jt?"true":"false",className:D("w-full max-w-sm rounded-3xl bg-white/40 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:transition-transform [&_.records-calendar-day-grid]:duration-200 [&_.records-calendar-day-grid]:ease-out [&_.records-calendar-day-grid]:[transform:translateX(var(--calendar-drag-x,0px))] data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:duration-0 data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:ease-linear",jt?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${da}px`},children:r.jsx(Ka,{mode:"single",locale:it,month:yt??void 0,onMonthChange:st,selected:m&&y(f(m))?f(m):void 0,onSelect:At,onDayClick:At,modifiers:la,labels:ma,components:{DayContent:pa},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-rose-200 [&_button[aria-selected=true]]:bg-rose-200 [&_button[aria-selected=true]]:rounded-2xl",classNames:ca,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),r.jsxs("div",{ref:xt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:vt,maxHeight:`calc(100dvh - ${vt}px - var(--bottom-nav-safe, 0px))`,WebkitOverflowScrolling:"touch"},children:[r.jsx(ve.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 pb-[calc(var(--bottom-nav-safe,0px))] sm:px-2 lg:px-4",children:L.length===0?r.jsx(ve.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:r.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[r.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-rose-500 shadow-inner",children:r.jsx(lt,{className:"h-8 w-8"})}),r.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),r.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):r.jsx(rs,{isoDate:m,cycleDay:(de==null?void 0:de.cycleDay)??null,details:q,peakStatus:Mt,isPeakDay:xa,onEdit:ya,onDelete:Ca,onAdd:Sa,onToggleRelations:ka,isProcessing:re})}),je&&r.jsx("div",{className:"pt-4 space-y-4",children:je})]})]}),r.jsx(ts,{open:Zt,onOpenChange:a=>{a?H(!0):It()},children:r.jsx(as,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:r.jsx(Qa,{onSubmit:ja,onCancel:It,initialData:We,cycleStartDate:e==null?void 0:e.startDate,cycleEndDate:e==null?void 0:e.endDate,isProcessing:re,isEditing:!!We,cycleData:e==null?void 0:e.data,onDateSelect:Na,defaultIsoDate:sa,focusedField:ra,initialSectionKey:na})})}),r.jsx(Ja,{isOpen:!!se,onClose:()=>Ke(null),onConfirm:_a,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:se?`¿Estás seguro de que quieres eliminar el registro del ${v(f(se.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:re})]}):r.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[r.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[r.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),r.jsx("button",{onClick:()=>tt(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),r.jsx(Ha,{isOpen:oa,onClose:()=>tt(!1),onConfirm:async a=>{await Qt(a),tt(!1),oe(null),H(!0)}})]})},vs=()=>r.jsx(ls,{});export{ls as RecordsExperience,vs as default};
