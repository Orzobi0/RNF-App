import{r as L,j as a,m as Pe,k as ct,f as Qe,W as St,B as rt,q as pt}from"./index-ByFXgX-t.js";import{l as Mt,B as kt}from"./badge-CetW1kHg.js";import{C as dt,X as Nt,a as mt,P as st,T as Tt,D as Pt}from"./peak-mode-button-DTRv1E4U.js";import{a as Ct,c as At}from"./computePeakStatuses-hwVxT-Am.js";const Jt=({point:t,position:n,chartWidth:l,chartHeight:y,onToggleIgnore:h,onEdit:r,onClose:m,onTogglePeak:I,currentPeakIsoDate:S})=>{if(!t)return null;const v=.7,j=200,F=120,x=j*v,D=F*v,A=L.useRef(null),[W,P]=L.useState(D),[C,G]=L.useState(!1);L.useEffect(()=>{if(A.current){const e=A.current.getBoundingClientRect();e?.height&&P(e.height)}else P(D);G(!1)},[t,D]);const w=10,K=12,z=Number.isFinite(n?.svgX)?n.svgX:n.clientX,R=Number.isFinite(n?.clientY)?n.clientY:n.svgY,O=Number.isFinite(n?.viewportWidth)?n.viewportWidth:l,de=Number.isFinite(n?.viewportHeight)?n.viewportHeight:y,_=Number.isFinite(n?.scrollLeft)?n.scrollLeft:0,u=Number.isFinite(n?.scrollTop)?n.scrollTop:0,k=_,b=_+O,p=u,M=u+de,T=b-x-w,E=k+w,B=l-x-w;let Z=Math.max(E,w),V=Math.min(T,B);V<Z&&(V=Z);const se=M-W-w,xe=p+w,$=y-W-w;let ee=Math.max(xe,w),q=Math.min(se,$);q<ee&&(q=ee);let te=z+K;if(te>V){te=V;const e=z-x-K;e>=Z&&(te=e)}te=Math.max(Z,Math.min(te,V));let X=R-W-K;X<ee&&(X=R+K),X=Math.max(ee,Math.min(X,q));const he=!t.id||String(t.id).startsWith("placeholder-"),Ce=t.temperature_chart??t.displayTemperature??null,ie=Ct(t.fertility_symbol),ne=t.timestamp||t.isoDate,re=e=>{if(e==null)return null;const i=String(e).trim();return i.length?i:null},ye=e=>{if(!e)return null;try{const i=Qe(e),f=i.getTime();return Number.isNaN(f)?null:ct(i,"HH:mm")}catch{return null}},Le=(()=>{if(!Array.isArray(t.measurements)||t.measurements.length===0)return null;const e=t.measurements.filter(Boolean);if(!e.length)return null;const i=[...e.filter(f=>f?.selected),...e.filter(f=>!f?.selected)];for(const f of i){const H=!!f?.use_corrected?re(f?.time_corrected)??re(f?.time):re(f?.time);if(H)return H}return null})(),le=(t.use_corrected?[re(t.time_corrected),re(t.time)]:[re(t.time)]).find(Boolean)??ye(t.timestamp),oe=Le??le,pe=t.mucus_sensation??t.mucusSensation??"",ke=t.mucus_appearance??t.mucusAppearance??"",Ae=t.observations??"",De=!!(t.had_relations??t.hadRelations),je=ie&&ie.value!=="none",Ie=Ce!=null,$e=!!(t.ignored&&Ie),ze=!!(pe&&pe.trim()||ke&&ke.trim()),We=!!(Ae&&Ae.trim()),ve=!(Ie||je||ze||We||De),Fe=t.peakStatus||(t.peak_marker==="peak"?"P":null),Q=Fe&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[Fe]||null,Re=!!(I&&t.isoDate),Ne=!!S,ce=Ne&&t.isoDate===S||Fe==="P"||t.peak_marker==="peak",ge=ce?"remove":Ne?"update":"assign",Se=ge==="assign"?"Asignar día pico":ge==="update"?"Actualizar día pico":"Quitar día pico",Be=Se,s=async()=>{if(!(!I||C)){G(!0);try{await I(t,!ce),m&&m()}catch(e){console.error("Error toggling peak marker from tooltip:",e)}finally{G(!1)}}},c=()=>{g()},g=e=>{r&&(r(t,e),m&&m())},d=(e=>{switch(e){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(t.fertility_symbol);return a.jsxs(Pe.div,{initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:X,left:te,width:x,height:W},children:[a.jsx("div",{ref:A,className:"origin-top-left",style:{transform:`scale(${v})`,width:j,minHeight:F},children:a.jsx("div",{className:"relative tooltip-surface--gradient backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden",children:a.jsxs("div",{className:"p-2",children:[a.jsxs("div",{className:"mb-2 flex items-center justify-between gap-1",children:[a.jsxs("div",{className:"flex items-center gap-1 flex-1 min-w-0",children:[a.jsx("div",{className:"w-3.5 h-3.5 bg-fertiliapp-fuerte rounded-full flex items-center justify-center shadow-lg shrink-0",children:a.jsx(dt,{className:"w-1 h-1 text-white",fill:"currentColor"})}),a.jsxs("div",{className:"min-w-0 flex-1",children:[a.jsxs("div",{className:"flex items-baseline gap-1 min-w-0",children:[a.jsx("h3",{className:"font-bold text-left text-[17px] leading-none text-gray-800 tabular-nums tracking-normal shrink-0",children:ne?ct(Qe(ne),"dd/MM",{locale:Mt}):"Fecha"}),a.jsxs("span",{className:"text-[14px] leading-none text-fertiliapp-fuerte font-semibold whitespace-nowrap tabular-nums shrink-0",children:["Día ",t.cycleDay||"N/A"]})]}),Q&&a.jsx("div",{className:"mt-1 flex justify-start",children:a.jsx(kt,{className:"bg-tarjeta text-fertiliapp-fuerte border border-fertiliapp-suave px-2 py-0 text-[11px]",children:Q})})]})]}),a.jsxs("div",{className:"flex items-center gap-0.5 shrink-0",children:[a.jsx("div",{className:`w-6 h-6 rounded-full flex items-center justify-center bg-fertiliapp-suave/70 pointer-events-none ${De?"opacity-100":"opacity-0"}`,"aria-hidden":"true",title:De?"Relaciones registradas":void 0,children:a.jsx(St,{className:"w-3.5 h-3.5 text-fertiliapp-fuerte",fill:"currentColor"})}),a.jsx(rt,{variant:"ghost",onClick:m,className:"p-0 text-gray-600 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-suave rounded-full w-[26px] h-[26px] transition-all duration-200","aria-label":"Cerrar",title:"Cerrar",children:a.jsx(Nt,{size:18})})]})]}),ve?a.jsxs("div",{className:"pt-1 space-y-3",children:[a.jsx(Pe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:a.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(Re||r)&&a.jsxs(Pe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[Re&&a.jsx(mt,{mode:ge,size:"sm",onClick:s,pending:C,"aria-label":Be,title:Se,className:"shrink-0"}),r&&a.jsxs(rt,{onClick:c,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[a.jsx(st,{className:"h-4 w-4"}),a.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-1",children:[Ie&&a.jsx(Pe.button,{type:"button",onClick:()=>g("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-temp-suave rounded-2xl p-1 border border-temp focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-temp",disabled:!r,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-temp rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Tt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsx("span",{className:$e?"text-md font-bold text-gray-400 line-through decoration-1":"text-md font-bold text-gray-800",children:parseFloat(Ce).toFixed(2)}),a.jsx("span",{className:$e?"text-md text-gray-400":"text-md text-gray-600",children:"°C"}),t.use_corrected&&a.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),oe&&a.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:oe})]})})]})}),je&&a.jsx(Pe.button,{type:"button",onClick:()=>g("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${d.light} rounded-3xl p-1 ${d.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!r,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-6 h-6 ${d.bg} rounded-lg flex items-center justify-center shadow-lg ${d.glow} shadow-lg`,children:a.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:`text-md font-semibold ${d.text}`,children:ie.label})})]})}),a.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[a.jsx(Pe.button,{type:"button",onClick:()=>g("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-sensacion-suave rounded-3xl p-1 border border-sensacion focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!r,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-sensacion rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Pt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-sensacion-fuerte",children:pe||"-"})})]})}),a.jsx(Pe.button,{type:"button",onClick:()=>g("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-apariencia-suave rounded-3xl p-1 border border-apariencia focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!r,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-apariencia rounded-lg flex items-center justify-center shadow-md",children:a.jsx(dt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-apariencia-fuerte",children:ke||"-"})})]})}),We&&a.jsx(Pe.button,{type:"button",onClick:()=>g("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-observaciones-suave rounded-3xl p-1 border border-observaciones focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!r,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-observaciones rounded-lg flex items-center justify-center shadow-md",children:a.jsx(st,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-sm font-semibold text-observaciones-fuerte",children:Ae})})]})})]})]}),(r||h&&!he&&t.id||Re&&!he)&&a.jsxs(Pe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[Re&&!he&&a.jsx(mt,{mode:ge,size:"sm",onClick:s,pending:C,"aria-label":Be,title:Se,className:"shrink-0"}),a.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:r&&a.jsxs(rt,{onClick:c,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[a.jsx(st,{className:"h-4 w-4 mr-1.5"}),a.jsx("span",{className:"font-medium",children:he?"Añadir datos":""})]})})]})]})]})})}),a.jsx("div",{className:"absolute -inset-2 tooltip-glow rounded-3xl blur-xl -z-10"})]})},Dt=({baselineTemp:t,firstHighIndex:n,processedData:l,isValid:y,findPreviousValidIndex:h})=>{if(n==null)return{confirmed:!1};const r=w=>w?.calcTemperature!=null?w.calcTemperature:w?.displayTemperature,m=w=>w?.ignoredForCalc!=null?w.ignoredForCalc:w?.ignored,I=t+.2,S=[],v=[],j=new Set,F=w=>{w==null||j.has(w)||(j.add(w),v.push(w))};let x=0,D=!1,A=null,W=!1;const P=typeof h=="function"?h(n-1):n>0?n-1:null,C=()=>P!=null?[P,...v]:[...v],G=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:C(),highSequenceIndices:[...v]});for(let w=n;w<l.length;w+=1){const z=l[w];if(!z)break;if(m(z))continue;if(!y(z))break;const R=r(z);if(!Number.isFinite(R))break;const O=R<=t&&R>=t-.05;if(R<t-.05)return F(w),G();if(R>t){if(F(w),S.push({index:w,temp:R}),!D&&S.length===3&&S[2].temp<I&&(W=!0),!D&&S.length===4&&S[2].temp>=I)return{confirmed:!0,confirmationIndex:S[3].index,usedIndices:C(),highSequenceIndices:[...v],rule:"pp-4-high"};if(!D&&W&&S.length===5)return{confirmed:!0,confirmationIndex:S[4].index,usedIndices:C(),highSequenceIndices:[...v],rule:"pp-ex1-5-high"};if(D){if(W=!1,S.length===3&&A==null)if(R>=I)A=w;else return G();if(A!=null&&S.length>=4){const _=S[S.length-1].index;if(_!==A)return{confirmed:!0,confirmationIndex:_,usedIndices:C(),highSequenceIndices:[...v],rule:"pp-ex2-5-high"}}}continue}if(O){if(x+=1,F(w),x>=2)return G();if(S.length>0&&S.length<3&&!D){D=!0;continue}break}break}return{confirmed:!1,usedIndices:C(),highSequenceIndices:[...v]}},Je={0:0,1:.4,2:.8,3:1},jt={M:.8,F:1,"M+":1,white:.4},Ft=(t,n=0,l=1)=>!Number.isFinite(t)||t<n?n:t>l?l:t,_t=t=>t?String(t).toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),""):"",gt=t=>_t(t).replace(/\s+/g," ").trim(),bt=(t,n=[])=>{if(!t)return null;let l=null;return n.forEach((y,h)=>{const{patterns:r=[],level:m,descriptor:I,negatedLevel:S,allowedModifiers:v=null,disallowedModifiers:j=null,selectionScore:F,forceSelection:x=!1}=y||{};r.forEach(D=>{if(!D)return;const A=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${D})(?=$|[^a-z0-9])`,"g");let W;for(;(W=A.exec(t))!==null;){const P=W[1]?W[1].trim():null;if(v&&!v.includes(P)||j&&j.includes(P))continue;let C=m;P==="no"?C=S??1:P==="muy"?C=Math.min(3,m+1):(P==="poco"||P==="leve")&&(C=Math.max(0,m-1));const G=F??C+h*.001,w=typeof I=="function"?I({modifier:P}):I;(!l||x||C>l.level||C===l.level&&G>l.selectionScore)&&(l={level:C,baseLevel:m,descriptor:w,modifier:P,selectionScore:G,force:x})}})}),l},Bt=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],Lt=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:t})=>t==="no"?"no filante":t==="poco"||t==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],xt=t=>{if(t==null)return null;if(typeof t=="number"&&Number.isFinite(t)){const l=Math.round(t);if(l>=0&&l<=3)return l}const n=String(t).trim();return/^[0-3]$/.test(n)?Number.parseInt(n,10):null},yt=t=>{const n=xt(t);if(n!=null)return{level:n,reason:`S${n}`,descriptor:`S${n}`,hasInput:!0};const l=t!=null?String(t).trim():"",y=gt(t),h=l.length>0;if(!y)return{level:0,reason:null,descriptor:null,hasInput:h};if(/^s\s*0?$/.test(y))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(y==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const r=bt(y,Bt);return r?{level:Math.max(0,Math.min(3,r.level)),reason:r.descriptor,descriptor:r.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:h}},It=t=>{const n=xt(t);if(n!=null)return{level:n,reason:`M${n}`,descriptor:`M${n}`,hasInput:!0};const l=t!=null?String(t).trim():"",y=gt(t),h=l.length>0;if(!y)return{level:0,reason:null,descriptor:null,hasInput:h};if(/^m\s*0$/.test(y))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(l))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const r=bt(y,Lt);return r?{level:Math.max(0,Math.min(3,r.level)),reason:r.descriptor,descriptor:r.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:h}},Et=t=>String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Rt=({appearance:t,observations:n,fertilitySymbol:l})=>{const y=[t,n,l].map(r=>String(r||"").toUpperCase()),h=r=>{if(!r)return!1;const I=`(?:^|[^\\p{L}\\p{N}])${Et(r)}(?=$|[^\\p{L}\\p{N}])`,S=new RegExp(I,"u");return y.some(v=>S.test(v))};return h("M+")?"M+":h("M")?"M":h("F")||h("FER")?"F":String(l||"").toLowerCase()==="white"?"white":"none"},Ht=t=>{if(t==null)return"";const n=String(t).trim().toUpperCase();return n==="P"||n==="PEAK"?"P":n==="1"||n==="P1"||n==="P+1"?"1":n==="2"||n==="P2"||n==="P+2"?"2":n==="3"||n==="P3"||n==="P+3"?"3":""},Ze=t=>!Number.isFinite(t)||t<0?0:t>3?3:t,$t=(t,n,l)=>{const y=t?.mucusSensation??t?.mucus_sensation,h=t?.mucusAppearance??t?.mucus_appearance,r=t?.fertility_symbol??t?.fertilitySymbol,m=t?.observations??t?.notes,I=t?.peak_marker??t?.peakMarker??null,S=typeof I=="string"?I.trim().toLowerCase()==="peak":!1,v=yt(y),j=It(h);let F=Ze(v.level),x=Ze(j.level);const D=[];v.reason&&D.push(`S:${v.reason}`),j.reason&&D.push(`M:${j.reason}`);const A=Rt({appearance:h,observations:m,fertilitySymbol:r}),W=A;let P=A;P==="white"&&(x=Math.max(x,1)),P==="M"&&(x=Math.max(x,2)),P==="M+"&&(x=Math.max(x,3)),P==="F"&&(x=Math.max(x,3),F=Math.max(F,3));const C=Je[F]??0,G=Je[x]??0,w=Math.max(C,G);P&&P!=="none"&&D.push(`symbol:${P}`);const K=jt[P]??0,z=Ft(Math.max(w,K)),R=n!=null&&Number.isFinite(n)?w>=n+.4-1e-9:!1;R&&D.push("cambioBIP");const O={hasSensation:!!v.hasInput,hasAppearance:!!j.hasInput,hasSymbol:r!=null&&String(r).trim()!==""&&String(r).trim().toLowerCase()!=="none",hasObservation:m!=null&&String(m).trim()!==""};O.hasAny=O.hasSensation||O.hasAppearance||O.hasSymbol||O.hasObservation;const de=Ht(t?.normalizedPeakStatus??t?.peakStatus??t?.peak_marker);return{index:l,S:F,M:x,symbolDetected:P,rawSymbol:W,isPeakMarked:S,scoreCore:w,scoreFertil:z,hasChangeBIP:R,reasons:D,entryFlags:O,descriptors:{sensation:v.descriptor??v.reason??null,appearance:j.descriptor??j.reason??null},normalizedPeakStatus:de}},zt=(t=[])=>{if(!Array.isArray(t)||t.length===0)return{days:[],bipScore:0};const n=[];for(let h=0;h<Math.min(6,t.length);h+=1){const r=t[h];if(!r||String(r?.fertility_symbol||"").toLowerCase()==="red")continue;const I=yt(r?.mucusSensation??r?.mucus_sensation),S=It(r?.mucusAppearance??r?.mucus_appearance),v=Je[Ze(I.level)]??0,j=Je[Ze(S.level)]??0;n.push(Math.max(v,j))}const l=n.length>0?Math.max(...n):0;return{days:t.map((h,r)=>$t(h,l,r)),bipScore:l}},Wt=t=>{for(let n=0;n<t.length;n+=1){const l=t[n];if(l){if(l.isPeakMarked)return{source:"Interno",day:n+1,reason:"P",kind:"profile"};if(l.symbolDetected==="white"||l.rawSymbol==="white")return{source:"Interno",day:n+1,reason:"white",kind:"profile"};if(l.symbolDetected==="M+"||l.symbolDetected==="F")return{source:"Interno",day:n+1,reason:"M+",kind:"profile"};if(l.symbolDetected==="M")return{source:"Interno",day:n+1,reason:"M",kind:"profile"};if(l.M>=2||l.S>=2)return{source:"Interno",day:n+1,reason:"S/M>=2",kind:"profile"}}}return null},Ot=(t,n)=>{const l=t.filter(r=>r&&Number.isFinite(r.day)).map(r=>({...r}));if(l.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:n,usedCandidates:[],notes:["Sin candidatos disponibles"]};const y=[...l].sort((r,m)=>{const I=Number.isFinite(r.day)?r.day:Number.POSITIVE_INFINITY,S=Number.isFinite(m.day)?m.day:Number.POSITIVE_INFINITY;return I-S}),h=Math.min(...y.map(r=>Math.round(r.day)));return{status:h!=null?"ok":"indeterminado",selectedDay:h??null,selectedMode:n,usedCandidates:y,notes:[]}},qt=({processedData:t=[],config:n={},calculatorCandidates:l=[],context:y={}})=>{const{calculators:h={cpm:!0,t8:!0},postpartum:r=!1,combineMode:m="estandar"}=n||{},S=new Set(["estandar"]).has(m)?m:"estandar",{postPeakStartIndex:v=null,temperatureInfertileStartIndex:j=null,temperatureConfirmationIndex:F=null,temperatureRule:x=null,todayIndex:D=null}=y||{},{days:A,bipScore:W}=zt(t),P=Array.isArray(A)?A.length:0,C=e=>Number.isInteger(e)&&e>=0&&e<P,G=e=>{const i=e?.peak_marker??e?.peakMarker??null;return typeof i=="string"&&i.trim().toLowerCase()==="peak"},K=(()=>{if(!Array.isArray(t)||t.length===0)return null;for(let e=t.length-1;e>=0;e-=1)if(G(t[e]))return e;return null})(),z=C(K)?K:null,R=[],O=e=>{!e||!Number.isFinite(e.day)||R.push({originalSource:e.originalSource??e.source,...e,kind:e.kind??"profile"})};O(Wt(A));const de=[],_=[];r&&de.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),r||l.forEach(e=>{if(!e)return;const i=typeof e.source=="string"?e.source.toUpperCase().replace(/-/g,""):"";if(!(i==="CPM"&&h.cpm||i==="T8"&&h.t8))return;const N={...e,source:i,kind:"calculator"};O(N)});const u=R.map(e=>({...e})),b=Ot(R,S);b.ignoredCalculatorCandidates=_,b.notes=Array.from(new Set([...b.notes??[],...de].filter(Boolean)));const p=e=>{if(!Number.isFinite(e))return null;const i=Math.max(1,Math.round(e));return t.length>0?Math.min(i,t.length):i},M=Number.isFinite(b.selectedDay)?p(b.selectedDay):null;if(M!=null&&M!==b.selectedDay){const e=`El día calculado (${b.selectedDay}) supera la duración del ciclo. Se usa ${M}.`;b.notes=Array.from(new Set([...b.notes??[],e])),b.selectedDay=M}let T=null;M!=null&&M>=1&&(T=M-1);const E=A.length>0?A.length-1:null,B=Number.isInteger(T)&&T>=0?T:null;let U=null;if(B!=null&&E!=null&&E>=B)if(Number.isInteger(v)){const e=Math.max(B,Math.min(v-1,E));U=e>=B?e:B}else if(C(z)){const e=Math.min(E,z+2),i=Math.max(B,e);U=i>=B?i:B}else U=E;const Z=e=>e===0?"P":e===-1?"P−1":e===-2?"P−2":e===1?"P+1":e===2?"P+2":null,V=e=>Number.isInteger(e)?E==null||E<0?e>=0?e:null:e<0?null:e>E?E:e:null,se=e=>{if(!Number.isInteger(e)||e<0||e>=t.length)return null;const i=t[e]?.isoDate;if(!i)return null;try{const f=Qe(i);return Number.isNaN(f?.getTime?.())?null:f}catch{return null}},xe=e=>{const i=se(e);if(!i)return null;try{return ct(i,"dd/MM")}catch{return null}};let $=null,me=null;if(C(z)){const e=z+3;C(e)&&($=e);const i=z+4;C(i)&&(me=i);const f=V(z),N=se(f);if(N)for(let H=f+1;H<t.length;H+=1){const Y=se(H);if(!Y)continue;const J=pt(Y,N);if($==null&&J>=3&&($=V(H)),me==null&&J>=4&&(me=V(H)),r){if(me!=null)break}else if($!=null)break}}const ee=V(F),q=V(j);let te=ee;if(te==null&&q!=null){const e=V(q-1);e!=null&&e>=0&&(te=e)}const X=(r?me:$)??null,he=null,Ce=[X,q].filter(e=>Number.isInteger(e)),ie=Ce.length>0?Math.min(...Ce):null,ne=Number.isInteger(X),re=Number.isInteger(q),ye=ne&&re?Math.max(X,q):null;if(B!=null&&E!=null&&E>=B)if(Number.isInteger(ie)){const e=Math.max(B,ie-1);U=Math.min(e,E)}else U=E;const we=U??E??null,Le=ie,Ee=r?"P+4":"P+3";let le=null;ne&&re?le=`${Ee} y T+3`:ne?le=Ee:re&&(le=x??"Temperatura");const oe={estandar:"modo estándar",marcador:"marcador explícito"},pe=b?.selectedMode??S??"estandar",ke=b?.usedCandidates??[],Ae=ke.some(e=>e?.kind==="profile"),De=ke.some(e=>e?.kind==="calculator"),je=A.some(e=>e?.entryFlags?.hasAppearance||e?.entryFlags?.hasSensation||e?.symbolDetected&&e.symbolDetected!=="none");let Ie=`Fase fértil abierta (${oe[pe]??pe}).`;pe==="marcador"?Ie="Fase fértil abierta (ajustada por tus marcadores).":Ae&&je?Ie="Fase fértil abierta (basada en tus observaciones de moco).":De&&!Ae&&(Ie="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const $e=ne&&re,ze="Infertilidad absoluta postovulatoria",Ve=`Ventana cerrada por doble criterio: ${le??"criterio indeterminado"}.`,ve=V(z),Fe=xe(ve),_e=xe(te),Q="Infertilidad estimada por moco",Re=Fe?`Fase de infertilidad alcanzada por determinación de día pico el ${Fe}.`:"Fase de infertilidad alcanzada por determinación de día pico.",Ne="Infertilidad estimada por temperatura",Oe=_e?`Infertilidad estimada por temperatura desde el ${_e}.`:"Infertilidad estimada por temperatura.",ce=new Array(A.length).fill(null);let ge=null,Se=0,Be=null;const s={inicio:0,aumento:1,alta:2,muyAlta:3},c=e=>{if(!e)return[];const i=[];if(Number.isFinite(e.M)&&e.M>0){const f=e.descriptors?.appearance;i.push(`M${e.M}${f?` (${f})`:""}`)}if(Number.isFinite(e.S)&&e.S>0){const f=e.descriptors?.sensation;i.push(`S${e.S}${f?` (${f})`:""}`)}return e.symbolDetected&&e.symbolDetected!=="none"&&(e.symbolDetected==="white"?i.push("white"):i.push(`símbolo ${e.symbolDetected}`)),e.hasChangeBIP&&i.push("cambio BIP"),i},g=["inicio","aumento","alta","muyAlta"];for(let e=0;e<A.length;e+=1){const i=A[e];if(!i){ce[e]=null;continue}const f=Number.isInteger(ie),N=f?e>=ie:!1,H=Number.isInteger(ye)?e>=ye:!1,Y=B!=null&&we!=null&&e>=B&&(f?e<ie:e<=we)&&!N,J=Number.isInteger(D)&&D!=null?e>D:!1;if(!Y){if(Se=0,ge=null,!(N||we!=null&&e>we)||!f){ce[e]=null;continue}const Ke=!!i.entryFlags?.hasAny,nt=Ke?null:"Sin registro hoy; estimación basada en días adyacentes.";let Xe=null,Ye=null,Ue=null;if(H&&$e?(Xe=ze,Ye=Ve,Ue="absolute"):ne&&e>=X?(Xe=Q,Ye=Re,Ue="mucus"):re&&e>=q&&(Xe=Ne,Ye=Oe,Ue="temperature"),!Ue){ce[e]=null;continue}ce[e]={index:e,state:"infertil",status:Ue,title:Xe,header:Xe,body:Ye,detail:le,hasRecord:Ke,inherited:!1,note:nt,isFertile:!1,phase:"postOvulatory",label:Xe,summaryText:Ye,reasonsList:[],reasonsText:"",showFertilityStatus:!J};continue}const ue=!!i.entryFlags?.hasAny;let be=0;i.isPeakMarked||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3||i.M>=3?be=3:i.M>=2||i.S>=2||i.symbolDetected==="M"?be=2:(i.M>=1||i.S>=1||i.hasChangeBIP)&&(be=1),ue?(Se=0,ge=be):Se+=1;const Ge=i.M>=2||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3;let Te=be,ae=null;{if(!ue){const Ke=ge??be,nt=Math.floor(Se/2);Te=Math.max(0,Ke-nt)}const tt=Math.max(0,Math.min(3,Te));ae=g[tt]}const ut=c(i),He=ut.join("; "),qe=ve!=null?e-ve:null,et=qe!=null?Z(qe):null,vt=ue?null:"Sin registro hoy; estimación basada en días adyacentes.";ae!=="waiting"&&(qe===0||qe===1||qe===2?(ae="muyAlta",Te=Math.max(Te,3)):qe===3?(s[ae]<s.alta&&(ae="alta"),Te=Math.max(Te,2)):Be!=null&&e-Be<=3&&(s[ae]<s.aumento&&(ae="aumento"),Te=Math.max(Te,1))),(ae==="alta"||ae==="muyAlta"||Ge)&&(Be=e);let Me,fe;switch(ae){case"waiting":Me="Fertilidad en espera de confirmación por temperatura",fe=`Final de moco alcanzado (≥${Ee}). Ventana mantenida hasta confirmación térmica (T+3).`;break;case"aumento":Me="Aumento de fertilidad",fe=He?`Signos en aumento: ${He}.`:"Signos en aumento.";break;case"alta":Me="Fertilidad alta",fe=He?`Signos fértiles claros (${He}).`:"Signos fértiles claros.";break;case"muyAlta":{Me="Fertilidad muy alta",fe=`Día de máxima fertilidad${et?` (${et})`:""}.`,fe+=He?` Signos pico: ${He}.`:" Signos pico presentes.";break}default:Me="Ventana fértil abierta",fe="Hoy sin signos destacables, a la espera de registrar más datos.";break}ue||(ae==="alta"?(Me="Fertilidad estimada alta",fe=`${fe} Sin datos apuntados este día; se estima en base a días cercanos.`):ae==="muyAlta"?(Me="Fertilidad estimada muy alta",fe=`${fe} Sin datos apuntados este día; se estima en base a días cercanos.`):(ae==="aumento"||ae==="inicio")&&(Me="Ventana fértil abierta (sin registro hoy)",fe=`${fe} Sin datos apuntados este día; se estima en base a días cercanos.`));const wt={index:e,state:ae,level:ae==="waiting"?be:Te,title:Me,header:Ie,body:fe,reasonsList:ut,reasonsText:He,hasRecord:ue,inherited:!ue,note:vt,isFertile:!0,phase:"fertile",label:Me,summaryText:fe,delta:et,showFertilityStatus:!J,reasonParts:{symbol:i.symbolDetected??null,appearance:i.descriptors?.appearance??null,sensation:i.descriptors?.sensation??null}};ce[e]=wt}we!=null&&(U=we);let o=null;if(Number.isInteger(D)&&ce.length>0){const e=Math.min(Math.max(D,0),ce.length-1);let i=null;for(let f=e;f>=0;f-=1){const N=ce[f];if(N&&(i||(i=N),N.isFertile)){o=N;break}}!o&&i&&(o=i)}const d={bipScore:W,effectivePeakIndex:z,candidatesBeforeAggregate:u,closureDetail:le,waitingStartIndex:he,pPlus3Index:$,pPlus4Index:me,temperatureConfirmationIndex:te,temperatureInfertileIndex:q,temperatureRule:x??null,mucusInfertileStartIndex:X,postOvulatoryStartIndex:Le,firstEstimateIndex:ie,absoluteStartIndex:ye};return{fertileStartFinalIndex:T,fertileWindow:B!=null&&U!=null?{startIndex:B,endIndex:U,waitingStartIndex:he,closureDetail:le,temperatureConfirmationIndex:te,temperatureInfertileStartIndex:q,mucusInfertileStartIndex:X,postOvulatoryStartIndex:Le,temperatureRule:x??null}:null,dailyAssessments:ce,currentAssessment:o,candidates:u,aggregate:b,debug:d}},ft=t=>{if(!t)return null;try{const n=new Date(t);return Number.isNaN(n.getTime())?null:n}catch{return null}},Xt=(t=[])=>{if(!Array.isArray(t)||t.length===0)return null;const l=t.map(m=>{if(!m?.startDate||!m?.endDate)return null;const I=ft(m.startDate),S=ft(m.endDate);if(!I||!S||S<I)return null;const v=Math.round((S-I)/(1e3*60*60*24))+1;if(!Number.isFinite(v)||v<=0)return null;const j=!!m?.ignoredForAutoCalculations;return{duration:v,ignored:j}}).filter(Boolean).filter(m=>!m.ignored);if(l.length<6)return null;const y=l.reduce((m,I)=>I.duration<m.duration?I:m),h=l.length>=12?20:21,r=y.duration-h;return Number.isFinite(r)?{source:"CPM",day:Math.max(1,Math.round(r)),reason:`ciclo_mas_corto=${y.duration}`,kind:"calculator"}:null},it=t=>{if(t==null||t==="")return null;const n=Number.parseFloat(String(t).replace(",","."));return Number.isFinite(n)?n:null},Yt=t=>{const n=[t?.temperature_chart,t?.temperature_raw,t?.temperature_corrected];for(const l of n){const y=it(l);if(y!==null)return y}if(Array.isArray(t?.measurements)){const l=r=>{if(!r)return null;const m=it(r.temperature),I=it(r.temperature_corrected);return r.use_corrected&&I!==null?I:m!==null?m:I!==null?I:null},h=t.measurements.find(r=>r&&r.selected&&l(r)!==null)||t.measurements.find(r=>l(r)!==null);if(h){const r=l(h);if(r!==null)return r}}return null},Ut=(t=[],n)=>{if(!Array.isArray(t)||t.length===0||typeof n!="function")return null;const l=[];if(t.forEach(h=>{if(!h?.data||!Array.isArray(h.data)||!h.startDate)return;const r=h.data.filter(x=>x&&x.isoDate).map(x=>({...x,displayTemperature:Yt(x)}));if(r.length===0)return;const{ovulationDetails:m}=n(r);if(!m?.confirmed)return;const I=Number.isInteger(m?.ovulationIndex)?m.ovulationIndex:Number.isInteger(m?.confirmationIndex)?m.confirmationIndex:null;if(I==null||I<0||I>=r.length)return;const S=r[I],v=Number(S?.cycleDay);if(!Number.isFinite(v)||v<=0)return;const j=Math.max(1,Math.round(v-8)),F={riseDay:v,t8Day:j,ignored:!!h?.ignoredForAutoCalculations};!F.ignored&&l.length<12&&l.push(F)}),l.length<6)return null;const y=l.reduce((h,r)=>r.t8Day<h.t8Day?r:h);return{source:"T8",day:Math.max(1,Math.round(y.t8Day)),reason:`t8=${y.t8Day}`,kind:"calculator"}},at={calculators:{cpm:!0,t8:!0},combineMode:"estandar"},lt=36.1,ot=37.5,ht=(t=[],n={})=>{const{postpartum:l=!1}=n,y=u=>u?.calcTemperature!=null?u.calcTemperature:u?.displayTemperature,h=u=>u?.ignoredForCalc!=null?u.ignoredForCalc:u?.ignored,r=u=>u&&y(u)!=null&&!h(u),m=u=>r(u)&&Number.isFinite(y(u)),I=6,S=.05,v=!1,j=(u,k=m)=>{if(!Number.isInteger(u))return null;for(let b=u;b>=0;b-=1){const p=t[b];if(k(p))return b}return null},F=(u,k=m)=>{if(!Array.isArray(u)||u.length===0)return[];const b=new Set,p=[];return u.forEach(M=>{const T=Number(M);if(!Number.isInteger(T)||T<0||T>=t.length||b.has(T))return;const E=t[T];k(E)&&(b.add(T),p.push(T))}),p},x=u=>{if(!u||u.length!==I)return null;const k=u.map(M=>M.temp);if(k.some(M=>!Number.isFinite(M)))return null;const b=k.reduce((M,T)=>T>M?T:M,k[0]),p=k.reduce((M,T)=>T>=b-S&&T<b?M+1:M,0);return p>=2?null:{baselineTemp:b,baselineStartIndex:u[0].index,baselineIndices:u.map(M=>M.index),baselineBorderlineCount:p}},D=u=>{const k=[];for(let b=u;b<t.length;b+=1){const p=t[b];if(!r(p))continue;const M=y(p);if(Number.isFinite(M)&&(k.push({index:b,temp:M}),k.length>I&&k.shift(),k.length===I)){const T=x(k);if(!T)continue;let E=null;for(let B=b+1;B<t.length;B+=1){const U=t[B];if(!r(U))continue;const Z=y(U);if(Number.isFinite(Z)&&Z>T.baselineTemp){E=B;break}}return{baselineTemp:T.baselineTemp,baselineStartIndex:T.baselineStartIndex,baselineIndices:T.baselineIndices,baselineBorderlineCount:T.baselineBorderlineCount,firstHighIndex:E}}}return null},A={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let W=null,P=null,C=null,G=[],w=A,K=0;const z=({baselineTemp:u,firstHighIndex:k})=>{if(k==null)return{confirmed:!1};const b=u+.2,p=[],M=[],T=new Set,E=$=>{$==null||T.has($)||(T.add($),M.push($))};let B=!1,U=0,Z=!1;const V=j(k-1),se=()=>V!=null?[V,...M]:[...M],xe=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:se(),highSequenceIndices:[...M]});for(let $=k;$<t.length;$++){const me=t[$];if(!me)break;if(h(me))continue;const q=y(me);if(!Number.isFinite(q))break;if(q>u){if(E($),p.push({index:$,temp:q}),B){if(p.length===3)return q>=b?{confirmed:!0,confirmationIndex:$,usedIndices:se(),highSequenceIndices:[...M],rule:"german-2nd-exception"}:xe();continue}if(p.length===3&&p[2].temp>=b)return{confirmed:!0,confirmationIndex:p[2].index,usedIndices:se(),highSequenceIndices:[...M],rule:"3-high"};if(p.length===4&&p[2].temp<b&&p[3].temp>u)return{confirmed:!0,confirmationIndex:p[3].index,usedIndices:se(),highSequenceIndices:[...M],rule:"german-3+1"};if(p.length===5&&p[3].temp>u&&p[4].temp>=b)return{confirmed:!0,confirmationIndex:p[4].index,usedIndices:se(),highSequenceIndices:[...M],rule:"5-high"};continue}if(q<=u&&q>=u-.05&&p.length>0&&p.length<3){if(U+=1,E($),U>=2)return xe();B=!0;continue}if(!Z&&!B&&p.length>0&&p.length<3){Z=!0,E($);continue}break}return{confirmed:!1,usedIndices:se(),highSequenceIndices:[...M]}};for(;K<t.length;){const u=D(K);if(!u)break;if(W=u.baselineTemp,P=u.baselineStartIndex,G=Array.isArray(u.baselineIndices)?[...u.baselineIndices]:[],C=u.firstHighIndex,u.baselineBorderlineCount,C==null){K=P+1;continue}const k=l?Dt({...u,processedData:t,isValid:r,findPreviousValidIndex:j}):z(u);if(k?.requireRebaseline){K=P+1;continue}if(k?.confirmed){const b=k.highSequenceIndices?.length?k.highSequenceIndices[0]:null,p=Number.isInteger(k.confirmationIndex)?Math.max(0,Math.min(k.confirmationIndex,t.length-1)):null;let M=null;p!=null&&(M=Math.max(0,Math.min(p,t.length-1))),w={confirmed:!0,confirmationIndex:p,infertileStartIndex:M,rule:k.rule,highSequenceIndices:k.highSequenceIndices??k.usedIndices,usedIndices:k.usedIndices,ovulationIndex:C??b??null};break}K=P+1}const R=F(G),O=F(w?.highSequenceIndices),de=F(w?.usedIndices),_={...w,highSequenceIndices:O,usedIndices:de};if(v){const u=b=>{const p=t[b];return p?{index:b,isoDate:p.isoDate,displayTemperature:p.displayTemperature,calcTemperature:y(p),ignored:p.ignored,ignoredForCalc:h(p),use_corrected:p.use_corrected,temperature_raw:p.temperature_raw??null,temperature_corrected:p.temperature_corrected??null,temperature_chart:p.temperature_chart??null}:null},k=(b,p)=>{console.groupCollapsed(`${b} (${p.length})`),p.forEach(M=>console.log(u(M))),console.groupEnd()};console.groupCollapsed("[fertility] Ovulation metrics debug"),console.log("baselineTemp",W),console.log("baselineIndices",R),console.log("firstHighIndex",C),console.log("ovulationDetails",{rule:_?.rule,confirmationIndex:_?.confirmationIndex,highSequenceIndices:O,usedIndices:de}),k("baselineIndices",R),k("highSequenceIndices",O),k("usedIndices",de),console.groupEnd()}return{baselineTemp:W,baselineStartIndex:P,firstHighIndex:C,baselineIndices:R,ovulationDetails:_}},Zt=(t,n,l,y,h,r=5,m=!1,I=null,S=[],v=null,j=!1,F=!1)=>{const x=L.useRef(null),D=L.useRef(null),[A,W]=L.useState({width:0,height:0,viewportWidth:0,viewportHeight:0}),[P,C]=L.useState(null),[G,w]=L.useState({x:0,y:0}),[K,z]=L.useState(null),R=L.useCallback(()=>{C(null),z(null)},[]),O=s=>{if(s==null)return"";const c=String(s).trim().toUpperCase();return c==="P"||c==="PEAK"?"P":c==="1"||c==="P1"||c==="P+1"?"1":c==="2"||c==="P2"||c==="P+2"?"2":c==="3"||c==="P3"||c==="P+3"?"3":""},de=L.useMemo(()=>At(t),[t]),_=L.useMemo(()=>{const s=o=>{if(o==null||o==="")return null;const d=parseFloat(String(o).replace(",","."));return Number.isFinite(d)?d:null},c=o=>{if(!o)return null;const d=s(o.temperature),e=s(o.temperature_corrected);return o.use_corrected&&e!==null?e:d!==null?d:e!==null?e:null},g=o=>{if(!o)return null;const d=s(o.temperature_chart),e=s(o.temperature_raw),i=s(o.temperature_corrected);if(o.use_corrected&&i!==null)return i;if(d!==null)return d;if(e!==null)return e;if(i!==null)return i;if(Array.isArray(o.measurements)){const N=o.measurements.find(H=>H&&H.selected&&c(H)!==null)||o.measurements.find(H=>c(H)!==null);if(N)return c(N)}return null};return t.map(o=>{const d=g(o),e=Array.isArray(o?.measurements)?o.measurements.some(ue=>ue?.ignored):!1,i=o?.isoDate,f=o?.peak_marker??o?.peakStatus??null,N=i?de[i]??f:f,H=O(N),Y=s(d),J=!!(o?.ignored||e);return{...o,displayTemperature:Y,calcTemperature:J?null:Y,ignoredForCalc:J,peakStatus:N??null,normalizedPeakStatus:H}})},[t,de]),u=L.useMemo(()=>{if(!Array.isArray(_)||_.length===0)return null;const s=new Date;let c=null;return _.forEach((g,o)=>{if(g?.isoDate)try{const d=Qe(g.isoDate);if(Number.isNaN(d?.getTime?.()))return;pt(d,s)<=0&&(c=o)}catch{}}),c},[_]);L.useLayoutEffect(()=>{const s=()=>{if(!x.current)return;const g=x.current.parentElement||x.current;let o=g.clientWidth||600,d=g.clientHeight||400,e=x.current.clientWidth>0?x.current.clientWidth:o,i,f,N,H;if(n){let Y=window.innerWidth,J=window.innerHeight;if(F){const ue=x.current?.clientWidth||g?.clientWidth||o,be=x.current?.clientHeight||g?.clientHeight||d;Y=ue,J=be}if(m&&J>Y&&([Y,J]=[J,Y]),e=Y,N=Y,H=J,l==="portrait"&&!m){const ue=Math.max(30,Y*.05);i=(Y-ue)/r*t.length}else i=Y/r*t.length;f=J}else i=e/r*t.length,f=d,N=e,H=d;W({width:i,height:f,viewportWidth:N,viewportHeight:H})};s(),window.addEventListener("resize",s);let c;if(x.current){const g=x.current.parentElement||x.current;c=new ResizeObserver(s),c.observe(g)}return()=>{window.removeEventListener("resize",s),c&&c.disconnect()}},[n,t.length,r,l,m,F]);const k=L.useMemo(()=>_.filter(s=>s&&s.isoDate&&!s.ignored&&s.displayTemperature!==null&&s.displayTemperature!==void 0),[_]),b=L.useMemo(()=>_.filter(s=>s&&s.isoDate),[_]),p=k.length>0,M=L.useMemo(()=>!Array.isArray(_)||_.length===0?!1:_.some(s=>s?s.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(e=>{const i=s?.[e];return i!=null&&String(i).trim()!==""})||(()=>{const e=s?.fertility_symbol??s?.fertilitySymbol;return e==null?!1:String(e).trim()!==""})()||(()=>{const e=s?.observations??s?.notes;return e==null?!1:String(e).trim()!==""})()?!0:O(s?.normalizedPeakStatus??s?.peakStatus??s?.peak_marker)!=="":!1),[_]),T=L.useMemo(()=>{const s=I??{},c=(i,f)=>typeof i=="boolean"?i:f,g={cpm:c(s?.calculators?.cpm,at.calculators.cpm),t8:c(s?.calculators?.t8,at.calculators.t8)},d=new Set(["estandar"]).has(s?.combineMode)?s.combineMode:at.combineMode,e=!!s?.postpartum;return{calculators:g,combineMode:d,postpartum:e}},[I]),E=L.useMemo(()=>{if(Array.isArray(v)&&v.length>0)return v.map(o=>{if(!o)return null;const{source:d,day:e,reason:i}=o,f=typeof d=="string"?d.toUpperCase().replace(/-/g,""):"";if(f!=="CPM"&&f!=="T8")return null;const N=Number(e);return Number.isFinite(N)?{source:f,originalSource:d??f,day:N,reason:typeof i=="string"?i:"",kind:"calculator"}:null}).filter(Boolean);const s=Array.isArray(S)?S:[];if(!s.length)return[];const c=Xt(s),g=Ut(s,ht);return[c,g].filter(Boolean)},[v,S]),{peakDayIndex:B,thirdDayIndex:U,peakInfertilityStartIndex:Z}=L.useMemo(()=>{if(!b.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const s=b.map(o=>o?.normalizedPeakStatus??O(o?.peakStatus??o?.peak_marker));let c=null,g=null;if(s.forEach((o,d)=>{o==="P"&&c==null&&(c=d),o==="3"&&g==null&&(g=d)}),c==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(g!=null){const o=b.length-1,d=Math.min(g+1,o);return{peakDayIndex:c,thirdDayIndex:g,peakInfertilityStartIndex:d}}return{peakDayIndex:c,thirdDayIndex:null,peakInfertilityStartIndex:null}},[b]),{baselineTemp:V,baselineStartIndex:se,firstHighIndex:xe,baselineIndices:$,ovulationDetails:me}=L.useMemo(()=>ht(_,{postpartum:T.postpartum}),[_,T.postpartum]),ee=L.useMemo(()=>({...me??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:V,baselineIndices:$,baselineStartIndex:se,firstHighIndex:xe,peakDayIndex:B,peakInfertilityStartIndex:Z,thirdDayIndex:U}),[me,V,$,se,xe,B,Z,U]),q=L.useMemo(()=>qt({processedData:_,config:T,calculatorCandidates:E,context:{postPeakStartIndex:Z,peakThirdDayIndex:ee?.thirdDayIndex??null,temperatureInfertileStartIndex:ee?.infertileStartIndex??null,temperatureConfirmationIndex:ee?.confirmationIndex??null,temperatureRule:ee?.rule??null,todayIndex:u}}),[_,T,E,ee?.thirdDayIndex,ee?.infertileStartIndex,ee?.confirmationIndex,ee?.rule,B,Z,u]),te=L.useMemo(()=>_.map((s,c)=>{if(!s)return s;const g=Number.isInteger(u)?c>u:!1;return{...s,isFutureDay:g}}),[_,u]),X=L.useMemo(()=>te.filter(s=>s&&s.isoDate),[te]),{tempMin:he,tempMax:Ce}=L.useMemo(()=>{const s=k.map(N=>N.displayTemperature).filter(N=>N!=null);if(s.length===0)return{tempMin:lt,tempMax:ot};const c=ot-lt,g=Math.min(...s),o=Math.max(...s);let d=Math.min(g,lt),e=Math.max(o,ot);const i=N=>Math.floor(N*10)/10,f=N=>Math.ceil(N*10)/10;if(d=i(d),e=f(e),e-d<c){const N=(d+e)/2;d=i(N-c/2),e=f(N+c/2)}return Math.abs(d-g)<1e-9&&(d=i(d-.1)),Math.abs(e-o)<1e-9&&(e=f(e+.1)),{tempMin:parseFloat(d.toFixed(1)),tempMax:parseFloat(e.toFixed(1))}},[k]),ie=Ce-he,ne=A.width,re=A.viewportHeight||A.height,ye=A.viewportWidth||ne,we=(s,c,g)=>Math.min(g,Math.max(s,c)),Le=F?11:9,Ee=(s=1)=>{if(F){const o=(A.viewportWidth||ye||ne||1)/Math.max(Number(r)||1,1),e=we(11,o*.33,15)*s;return we(10,e,18)}if(!n)return Le*s;const c=Math.min(ne,re);return Math.max(8,Math.min(Le*s,c/(X.length>0?40/s:40)))},le=Math.round(Ee(n?F?1.45:1.6:2)),oe=m||l==="landscape",pe=F&&n&&oe&&r>=28,ke=n?9:7.5,Ae=ke+(j?n?2:1.5:0),De=n?1:.75,je=Math.round(le*(ke+De)),Ie=Math.round(le*(Ae+De)),$e=je,ze=j?Math.max(0,Ie-je):0,We=j?Ie:je,Ve=Math.max(re-We,le*(n?10:8)),ve=We+Math.max(Ve,0),Fe=ve+ze,_e={top:n?Math.max(oe?6:12,re*(oe?.015:.03)):12,right:n?Math.max(oe?35:30,Math.min(ne,ye)*(oe?.02:.05)):50,bottom:Math.max(0,$e-1),left:n?Math.max(oe?45:20,Math.min(ne,ye)*(oe?.02:.05)):50},Q=pe?{..._e,left:Math.max(34,Math.round(_e.left*.78)),right:Math.max(18,Math.round(_e.right*.6))}:_e,Ne=Math.max(0,Math.round(le*4)),Oe=ve-Q.bottom-Ne,ce=L.useCallback(s=>{const c=ve-Q.top-Q.bottom-Ne;return s==null||ie===0||c<=0?Oe:Oe-(s-he)/ie*c},[ve,Q.top,Q.bottom,Ne,ie,Oe,he]),ge=L.useCallback(s=>{const c=pe?2:n&&!(m||l==="landscape")?5:10,g=n&&!(m||l==="landscape")?25:0,o=pe?4:15,d=pe?0:n?Math.max(oe?8:18,Math.min(ne,ye)*(oe?.01:.05)):20,e=Q.right+o,i=ne-Q.left-e-c-d*2-g*(X.length-1);if(i<=0)return Q.left+c+d+g*s;const f=X.length>1?X.length-1:1;return f===0||X.length===0?Q.left+c+d+g*s:Q.left+c+d+s*(i/(X.length===1?1:f))+g*s},[n,m,l,Q.left,Q.right,ne,ye,X.length,oe]),Se=(s,c,g)=>{if(!s){R();return}const o=x.current.getBoundingClientRect();let d,e;if(g.type.startsWith("touch")){const Ge=g.changedTouches[0];d=Ge.clientX,e=Ge.clientY}else d=g.clientX,e=g.clientY;const i=ge(c),f=s.displayTemperature??s.temperature_chart??null,N=ce(f),H=x.current,Y=H?.scrollLeft??0,J=H?.scrollTop??0,ue=H?.clientWidth??o.width??0,be=H?.clientHeight??o.height??0;w({svgX:i,svgY:N,clientX:d-o.left+Y,clientY:e-o.top+J,scrollLeft:Y,scrollTop:J,viewportWidth:ue,viewportHeight:be}),z(c),C(s)};L.useEffect(()=>{const s=c=>{if(!x.current?.contains(c.target)&&D.current&&!D.current.contains(c.target)){const g=x.current?.querySelectorAll("circle, text, rect");let o=!1;if(g){for(let d of g)if(d.contains(c.target)){o=!0;break}}o||R()}};return P&&(document.addEventListener("mousedown",s),document.addEventListener("touchstart",s)),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("touchstart",s)}},[P,R]);const Be=s=>{y&&s&&(y(h,s),R())};return{chartRef:x,tooltipRef:D,dimensions:{...A,contentHeight:ve,scrollableContentHeight:Fe,extraScrollableHeight:ze,viewportHeight:re},activePoint:P,activeIndex:K,tooltipPosition:G,processedData:te,validDataForLine:k,allDataPoints:X,tempMin:he,tempMax:Ce,tempRange:ie,padding:Q,textRowHeight:le,setActivePoint:C,setActiveIndex:z,getY:ce,getX:ge,handlePointInteraction:Se,clearActivePoint:R,handleToggleIgnore:Be,responsiveFontSize:Ee,baselineTemp:V,baselineStartIndex:se,baselineIndices:$,firstHighIndex:xe,ovulationDetails:ee,fertilityStart:q,hasTemperatureData:p,hasAnyObservation:M,graphBottomInset:Ne,todayIndex:u}};export{Jt as C,Xt as a,Ut as b,ht as c,Zt as u};
