import{c as rn,m as Ue,j as e,R as yn,r as i,l as ft,f as ut,K as on,n as bn,g as Lt,k as Xt,M as wn,q as jn,N as In,u as Cn,O as Pt,B as wt,L as Gt,X as Sn}from"./index-DH3_E9Yn.js";import{b as Mn,g as kn,i as vn,d as Nn,D as Rn}from"./computePeakStatuses-P1dm--_1.js";import{u as Ln,C as Dn,a as An,b as En,c as On}from"./useFertilityChart-4bfisnfz.js";import{u as Pn,D as Tn,a as $n}from"./useCycleData-BKkKqmXq.js";import{C as zt,S as Bn,a as Fn,b as _n,d as Wn,e as Gn}from"./checkbox-2dsJVv6E.js";import{L as zn}from"./label-UHMSfazx.js";import{A as Hn}from"./arrow-left-BQ6O3nF8.js";import{E as Un,a as Yn}from"./eye-CYxb1UHs.js";import"./input-DQhpSuZa.js";import"./badge-CdG7NQBE.js";const Vn=rn("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),qn=rn("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),Xn=({padding:s,chartWidth:o,chartHeight:x,tempMin:h,tempMax:$,tempRange:g,getY:G,getX:_,allDataPoints:S=[],visibleRange:w=null,responsiveFontSize:B,isFullScreen:ee,showLeftLabels:q=!1,reduceMotion:z=!1,isScrolling:R=!1,graphBottomY:J,chartAreaHeight:u,rowsZoneHeight:F})=>{const O={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.3,ease:"easeOut"}}},te=[];if(g>0){const T=g<=2.5?.1:.5;for(let ye=h;ye<=$+1e-9;ye+=T)te.push(parseFloat(ye.toFixed(1)))}else for(let T=35.8;T<=37.2+1e-9;T+=.1)te.push(parseFloat(T.toFixed(1)));const b=S.length,L=b>60||R,ue=z||L?"g":Ue.g,ne=Number.isInteger(w?.startIndex)?w.startIndex:0,le=Number.isInteger(w?.endIndex)?w.endIndex:Math.max(b-1,0),f=b?Math.max(0,Math.min(b-1,ne)):0,fe=b?Math.max(f,Math.min(b-1,le)):-1;return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"bgGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fffbfc"}),e.jsx("stop",{offset:"50%",stopColor:"#fff5f7"}),e.jsx("stop",{offset:"100%",stopColor:"#fff1f3"})]}),e.jsxs("linearGradient",{id:"dataZoneGradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fff7fb"}),e.jsx("stop",{offset:"50%",stopColor:"#ffe4f0"}),e.jsx("stop",{offset:"100%",stopColor:"#fff7fb"})]}),e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsxs("filter",{id:"softShadow",children:[e.jsx("feGaussianBlur",{in:"SourceAlpha",stdDeviation:"2"}),e.jsx("feOffset",{dx:"0",dy:"1",result:"offsetblur"}),e.jsx("feComponentTransfer",{children:e.jsx("feFuncA",{type:"linear",slope:"0.2"})}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"pointGlow",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsx("filter",{id:"textShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.8)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]})]}),e.jsx("rect",{x:s.left,y:s.top,width:o-s.left-s.right,height:u,fill:"url(#bgGradientChart)",opacity:2,rx:12,style:{filter:"drop-shadow(0 4px 12px rgba(244, 114, 182, 0.1))"}}),e.jsx("rect",{x:s.left,y:s.top,width:o-s.left-s.right,height:u,fill:"white",stroke:"url(#tempLineGradientChart)",strokeWidth:"1",strokeOpacity:"0.2",rx:"12",style:{filter:"url(#softShadow)"}}),e.jsx("rect",{x:s.left,y:J,width:o-s.left-s.right,height:F,fill:"url(#dataZoneGradient)",rx:"8",style:{filter:"drop-shadow(0 -1px 2px rgba(244, 114, 182, 0.05))"}}),te.map((T,ye)=>{const je=G(T),m=T.toFixed(1).endsWith(".0")||T.toFixed(1).endsWith(".5"),he=m?T.toFixed(1):`.${T.toFixed(1).split(".")[1]}`;return e.jsxs(ue,{...z||L?{}:{variants:O},children:[e.jsx("line",{x1:s.left,y1:je,x2:o-s.right,y2:je,stroke:m?"#f9a8d4":"#fce7f3",strokeWidth:m?1.5:1,opacity:m?.5:.3,strokeDasharray:m?"0":"4,4",style:{filter:m&&!L?"drop-shadow(0 1px 3px rgba(244, 114, 182, 0.15))":"none",opacity:m?1:.7}}),q&&e.jsx("text",{x:s.left-B(1),y:je+B(.35),textAnchor:"end",fontSize:B(m?1.1:1),fontWeight:m?"700":"600",fill:m?"#be185d":"#db2777",opacity:m?.9:.7,style:{filter:L?"none":"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:he}),e.jsx("text",{x:o-s.right+B(1),y:je+B(.35),textAnchor:"start",fontSize:B(m?1.1:1),fontWeight:m?"700":"600",fill:m?"#be185d":"#db2777",opacity:m?.9:.7,style:{filter:L?"none":"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:he})]},`temp-tick-${ye}`)}),b>0&&Array.from({length:fe-f+1},(T,ye)=>{const je=f+ye,m=_(je);return e.jsx("line",{x1:m,y1:s.top,x2:m,y2:J,stroke:"#fce7f3",strokeWidth:"1",opacity:"0.6",style:{filter:L?"none":"drop-shadow(0 0 1px rgba(244, 114, 182, 0.05))"}},`day-grid-${je}`)}),e.jsx("rect",{x:s.left,y:s.top,width:o-s.left-s.right,height:u,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"2",strokeOpacity:"0.4",rx:"12"}),e.jsx("rect",{x:s.left+1,y:s.top+1,width:o-s.left-s.right-2,height:u-2,fill:"none",stroke:"white",strokeWidth:"0.5",rx:"11",opacity:"0.9"}),q&&e.jsx(ue,{...z||L?{}:{variants:O},children:e.jsx("text",{x:s.left+B(1.2),y:s.top+B(1.5),textAnchor:"middle",fontSize:B(1.4),fontWeight:"800",fill:"#be185d",style:{filter:L?"none":"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:"°C"})})]})},Kn=({data:s,allDataPoints:o,getX:x,getY:h,baselineY:$,temperatureField:g="temperature",reduceMotion:G=!1})=>{if(!s||s.length<2)return null;let _="",S=null;const w=[];if(o.forEach((q,z)=>{const R=s.find(J=>J.id===q.id);if(R&&R[g]!==null&&R[g]!==void 0&&!R.ignored){const J=x(z),u=h(R[g]);w.push({x:J,y:u}),S!==null&&z===S+1?_+=` L ${J} ${u}`:_+=`${_?" ":""}M ${J} ${u}`,S=z}}),w.length<2)return null;const B=_.includes("L"),ee=w.length>1?w.map(({x:q,y:z},R)=>`${R===0?"M":"L"} ${q} ${z}`).join(" "):"";return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsx("filter",{id:"lineShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"3",floodColor:"rgba(244, 114, 182, 0.4)"})})]}),B&&(G?e.jsx("path",{d:_,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"}}):e.jsx(Ue.path,{d:_,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.4},transition:{duration:.8,ease:"easeInOut",delay:.2}})),ee&&(G?e.jsx("path",{d:ee,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65}):e.jsx(Ue.path,{d:ee,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.65},transition:{duration:.8,ease:"easeInOut"}})),B&&(G?e.jsx("path",{d:_,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"}}):e.jsx(Ue.path,{d:_,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1,ease:"easeInOut",delay:.4}}))]})},Jt="var(--color-sensacion-fuerte)",Qt="var(--color-apariencia-fuerte)",en="var(--color-observaciones-fuerte)",Ht="#be123c",Zn="rgba(148, 163, 184, 0.35)",Jn="rgba(226, 232, 240, 0.6)",Qn="rgba(148, 163, 184, 0.5)",tn="✖",Ut="#7f1d1d",Yt="#ec4899",es="drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))",ts="#be185d",ns="#2563eb",ss="#be185d",as="rgba(244, 114, 182, 0.35)",rs=s=>{if(!s)return"";const[o,x]=s.split("/");return`${parseInt(o,10)}/${parseInt(x,10)}`},Kt='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',os=()=>{if(typeof document>"u")return(x,h)=>{const $=/(\d+(?:\.\d+)?)px/.exec(h||""),g=$?Number($[1]):12;return x.length*g*.6};const o=document.createElement("canvas").getContext("2d");return o?(x,h)=>(o.font=h,o.measureText(x).width):(x,h)=>{const $=/(\d+(?:\.\d+)?)px/.exec(h||""),g=$?Number($[1]):12;return x.length*g*.6}},is=(s,o,x)=>`${o} ${s}px ${x}`,nn=(s="",{maxWidth:o,maxLines:x=2,fontSize:h,fontWeight:$=700,fontFamily:g=Kt,fallback:G="–",measureTextWidth:_})=>{if(!s)return[G,...Array.from({length:Math.max(0,x-1)},()=>"")];const S=is(h,$,g),w=u=>_(u,S),B=String(s).trim(),ee=/\s/.test(B),q=ee?B.split(/\s+/):Array.from(B),z=ee?" ":"",R=[],J=u=>{const F=Array.from(u);let O="";for(;F.length;){const te=O+F[0];if(w(te)<=o||!O){if(O=te,F.shift(),w(O)>o&&O.length>1){F.unshift(...Array.from(O.slice(1))),O=O[0];break}}else break}return[O,F.join("")]};for(;q.length&&R.length<x;){let u="";for(;q.length;){const F=q[0],O=u?`${u}${z}${F}`:F;if(w(O)<=o){u=O,q.shift();continue}if(!u)if(ee){const[te,b]=J(F);u=te,b?q[0]=b:q.shift()}else{const[te,b]=J(F);u=te,b?q[0]=b:q.shift()}break}R.push(u),!u&&q.length&&R.push(q.shift())}if(q.length&&R.length){const u=R.length-1;let F=R[u]||"";for(;F&&w(`${F}…`)>o;)F=F.slice(0,-1);R[u]=F?`${F}…`:"…"}for(;R.length<x;)R.push("");return R};function Vt(s="",o,x="–"){return s?s.split(/\s+/).slice(0,o).join(" "):x}const ls=({data:s,getX:o,getY:x,isFullScreen:h,orientation:$,responsiveFontSize:g,onPointInteraction:G,clearActivePoint:_,activePoint:S,visibleRange:w=null,padding:B,chartHeight:ee,chartWidth:q,temperatureField:z="temperature_chart",textRowHeight:R,compact:J=!1,reduceMotion:u=!1,isScrolling:F=!1,showInterpretation:O=!1,ovulationDetails:te=null,firstHighIndex:b=null,baselineIndices:Te=[],graphBottomLift:L=0,graphBottomY:ue,rowsZoneHeight:ne,showRelationsRow:le=!1})=>{const f={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},fe={hidden:{opacity:0,scale:.3},visible:{opacity:1,scale:1,transition:{duration:.6,ease:[.34,1.56,.64,1],type:"spring",stiffness:120,damping:12}}},T=ue,ye=h?9:7.5,je=h?1:.75,m=le?ye+(h?2:1.5):null,he=ye+je,Ge=Math.max(1,Math.floor(ne/he)),H=Math.max(R,Ge),jt=T+H*1,At=T+H*2,Le=T+H*3,qe=T+H*(h?5:4.5),Xe=T+H*(h?7:6),It=T+H*(h?9:7.5),lt=le?It+H*(h?2:1.5):null,ge=Array.isArray(s)?s.length:0,v=ge>60||F,tt=u||v?"g":Ue.g,Ke=q-B.left-B.right,nt=H*(h?2:1.5),be=Math.min(Math.max(nt*.46,14),12),Ze=Number.isInteger(w?.startIndex)?w.startIndex:0,$e=Number.isInteger(w?.endIndex)?w.endIndex:Math.max(ge-1,0),Be=ge?Math.max(0,Math.min(ge-1,Ze)):0,pe=ge?Math.max(Be,Math.min(ge-1,$e)):-1,Ct=i.useMemo(()=>ft(new Date),[]),De=i.useMemo(()=>os(),[]),Ye=i.useRef(new Map),Ae=ge>0?Ke/ge:Ke,we=2,me=Math.min(12,Math.max(4,Ae*.12)),ae=Math.max(0,Ae-me*2),Ce=g(.95),Fe=g(.9),ze=g(.9),ve=g(.9),st=g(.8),ht=g(.8),ct=g(.8),pt=i.useMemo(()=>{if(!O)return new Map;const N=Array.isArray(te?.highSequenceIndices)?te.highSequenceIndices:[],l=new Map;return N.forEach((y,xe)=>{const X=Number(y);Number.isInteger(X)&&X>=0&&X<ge&&!l.has(X)&&l.set(X,xe+1)}),l},[O,te,ge]),mt=i.useMemo(()=>{if(!O)return new Map;const N=Array.isArray(Te)?Te:[];if(!N.length)return new Map;const l=new Set,y=[],xe=Q=>{const oe=Number(Q);Number.isInteger(oe)&&oe>=0&&oe<ge&&!l.has(oe)&&(l.add(oe),y.push(oe))};if(N.forEach(Q=>{xe(Q)}),b!=null){const Q=Number(b);Number.isInteger(Q)&&xe(Q-1)}if(!y.length)return new Map;const X=[...y].sort((Q,oe)=>Q-oe),re=new Map;let Ie=1;for(let Q=X.length-1;Q>=0&&!(Ie>6);Q-=1)re.set(X[Q],Ie),Ie+=1;return re},[O,Te,ge,b]),at=v?"none":"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))",Ve=v?"none":"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))",Ee=v?"none":"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))",dt=v?"none":es,Ne=v?"none":"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.25))",xt=v?"none":"drop-shadow(0 1px 3px rgba(37, 99, 235, 0.45))",gt=v?"none":"drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3))",Je=i.useCallback((N,l,y,xe)=>{const X=nn(N,{maxWidth:ae,maxLines:3,fontSize:y,fontWeight:700,fontFamily:Kt,fallback:l,measureTextWidth:De});return X[2]?{lines:nn(N,{maxWidth:ae,maxLines:3,fontSize:xe,fontWeight:700,fontFamily:Kt,fallback:l,measureTextWidth:De}),fontSize:xe}:{lines:X,fontSize:y}},[ae,De]);i.useEffect(()=>{Ye.current.clear()},[ge,ae,Fe,ze,ve]);const rt=i.useCallback((N,l,y,xe,X)=>{const re=Ye.current.get(N);if(re)return re;const Ie=Je(l,y,xe,X);return Ye.current.set(N,Ie),Ie},[Je]),St=i.useMemo(()=>!ge||pe<Be?[]:Array.from({length:pe-Be+1},(N,l)=>Be+l),[pe,Be,ge]);return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsx("filter",{id:"rowShadowChart",x:"-10%",y:"-10%",width:"120%",height:"120%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"4",floodColor:"rgba(244, 114, 182, 0.2)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#fb7185"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"pointGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("radialGradient",{id:"tempPointGradientChart",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FDF2F8"}),e.jsx("stop",{offset:"50%",stopColor:"#F9A8D4"}),e.jsx("stop",{offset:"85%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#DB2777"})]}),e.jsxs("radialGradient",{id:"tempPointIgnoredGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFFFFF"}),e.jsx("stop",{offset:"80%",stopColor:"#F8FAFC"}),e.jsx("stop",{offset:"100%",stopColor:"#E2E8F0"})]}),e.jsxs("radialGradient",{id:"ovulationPointGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#dbeafe"}),e.jsx("stop",{offset:"50%",stopColor:"#93c5fd"}),e.jsx("stop",{offset:"85%",stopColor:"#3b82f6"}),e.jsx("stop",{offset:"100%",stopColor:"#2563eb"})]})]}),h&&$!=="portrait"&&e.jsx(tt,{...u||v?{}:{variants:f},children:[{label:"Fecha",row:1,color:h?"#374151":"#6B7280"},{label:"Día",row:2,color:h?"#374151":"#6B7280"},{label:"Símbolo",row:3,color:h?"#374151":"#6B7280"},{label:"Sens.",row:h?5:4.5,color:Jt},{label:"Apar.",row:h?7:6,color:Qt},{label:"Observ.",row:h?9:7.5,color:en},...le&&m!=null?[{label:"RS",row:m,color:Ht}]:[]].map(({label:N,row:l,color:y})=>e.jsx("text",{x:B.left-g(.5),y:T+H*l,textAnchor:"end",fontSize:g(1.05),fontWeight:"700",fill:y,style:{filter:at,fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:N},N))}),St.map(N=>{const l=s[N];if(!l)return null;const y=o(N),xe=l[z]!=null?x(l[z]):T,X=l.temperature_raw,re=l.temperature_corrected,Ie=l.use_corrected&&X!=null&&re!=null&&Math.abs(re-X)>.01,Q=Ie?x(X):null,oe="#60666f",Oe=l[z]!=null,W=!!(l.had_relations??l.hadRelations);Oe||l.mucus_sensation||l.mucus_appearance||l.fertility_symbol;const Mt=String(l.id||"").startsWith("placeholder-"),yt=te?.peakDayIndex,Se=O&&yt!=null&&!l.ignored&&Oe&&N===yt,ot=Mn(l.fertility_symbol),it=kn(ot.value),kt=ot.pattern==="spotting-pattern"?"url(#spotting-pattern-chart)":it.main,vt=it.border==="none"?"none":it.border||as,Nt=it.border==="none"?0:ot.value==="white"?1.6:1,He=l.isoDate?vn(ft(ut(l.isoDate)),ft(new Date)):!1,ce=g(h?1.8:2),_e=Le-ce*.75+ce/2+2,Me=l.peakStatus?String(l.peakStatus).toUpperCase():null,Pe=Me==="P"||Me==="X",t=Me&&!Pe,r=Pe?tn:Me||"–",a=Pe||["1","2","3"].includes(Me),j=!Mt&&ot.value!=="none",n=!!l.isoDate&&!He?{pointerEvents:"all",style:{cursor:"pointer"},onClick:bt=>G(l,N,bt)}:{},c=(l.isoDate?Nn(ut(l.isoDate),Ct):!1)?ss:oe,A=pt.has(N),k=A?pt.get(N):null,ie=mt.has(N),se=ie?mt.get(N):null,P=g(h?.75:1.2),U=Math.max(.5,P*.18),D=xe-P*(h?2.6:1.8),I=xe+P*(h?1.9:1.6),p=h?Vt(l.mucus_sensation,we,He?"":"–"):l.mucus_sensation,E=h?Vt(l.mucus_appearance,we,He?"":"–"):l.mucus_appearance,C=h?Vt(l.observations,we,""):l.observations,Y=`${l.isoDate||l.id||N}`,K=rt(`${Y}-sens-${ae}-${Fe}-${st}-${p??""}`,p,He?"":"–",Fe,st),de=rt(`${Y}-apar-${ae}-${ze}-${ht}-${E??""}`,E,He?"":"–",ze,ht),Re=rt(`${Y}-obs-${ae}-${ve}-${ct}-${C??""}`,C,"",ve,ct),[ke,Z,We]=K.lines,[Qe,Et,et]=de.lines,[Rt,$t,Bt]=Re.lines,ln=K.fontSize,cn=de.fontSize,dn=Re.fontSize,Ft=(bt,Wt,gn)=>Math.max(1,[bt,Wt,gn].filter(Zt=>Zt&&String(Zt).trim()!=="").length),un=Ft(ke,Z,We),fn=Ft(Qe,Et,et),hn=Ft(Rt,$t,Bt),_t=(bt,Wt)=>bt-(Wt-1)*Ce/2,pn=_t(qe,un),mn=_t(Xe,fn),xn=_t(It,hn);return e.jsxs(tt,{...u||v?{}:{variants:f},...n,children:[Oe&&e.jsxs(tt,{...u||v?{}:{variants:fe},children:[Ie&&Q!==null&&e.jsxs("g",{pointerEvents:"none",children:[e.jsx("line",{x1:y,y1:Q,x2:y,y2:xe,stroke:Zn,strokeWidth:1,strokeDasharray:"4 4"}),e.jsx("circle",{cx:y,cy:Q,r:3,fill:Jn,stroke:Qn,strokeWidth:1}),e.jsx("circle",{cx:y,cy:Q,r:1,fill:"rgba(255, 255, 255, 0.6)"})]}),e.jsx("circle",{cx:y,cy:xe,r:Se?3.5:2.8,fill:l.ignored?"url(#tempPointIgnoredGradient)":Se?"url(#ovulationPointGradient)":"url(#tempPointGradientChart)",stroke:l.use_corrected?"#941616":l.ignored?"#94A3B8":Se?"#1d4ed8":"#E91E63",strokeWidth:l.ignored?1.5:Se?2.2:2,style:{filter:Se?gt:Ne,cursor:"pointer"},pointerEvents:"all",onClick:bt=>G(l,N,bt)}),!l.ignored&&e.jsx("circle",{cx:y,cy:xe,r:Se?1.2:.9,fill:Se?"rgba(239, 246, 255, 0.95)":"rgba(255, 255, 255, 0.9)",style:{filter:Se?xt:Ve}}),O&&Oe&&!l.ignored&&A&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:y,y:D,textAnchor:"middle",fontSize:P,fontWeight:"900",fill:ts,strokeWidth:U,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:Ve},children:k})}),O&&Oe&&!l.ignored&&ie&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:y,y:I,textAnchor:"middle",fontSize:P,fontWeight:"800",fill:ns,stroke:"#ffffff",strokeWidth:U,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:Ve},children:se})})]}),e.jsx("text",{x:y,y:jt,textAnchor:"middle",fontSize:g(1.05),fontWeight:"900",fill:c,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ve},children:rs(l.date)}),e.jsx("text",{x:y,y:At,textAnchor:"middle",fontSize:g(1),fontWeight:"900",fill:c,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ve},children:l.cycleDay}),j?e.jsxs("g",{children:[e.jsx("rect",{x:y-ce/2+1,y:Le-ce*.75+1,width:ce,height:ce,fill:"rgba(0, 0, 0, 0.1)",rx:ce*.3,opacity:.5}),e.jsx("rect",{x:y-ce/2-4,y:Le-ce*.75,width:ce*1.4,height:ce,fill:kt,stroke:vt,strokeWidth:Nt,rx:ce*.2,style:{filter:Ne}}),Me&&e.jsx("g",{pointerEvents:"none",children:Pe?e.jsx("text",{x:y,y:_e,textAnchor:"middle",fontSize:g(1.35),fontWeight:"900",fill:Yt,stroke:"#fff",strokeWidth:1.5,paintOrder:"stroke",style:{filter:dt},children:tn}):e.jsx("text",{x:y,y:_e,textAnchor:"middle",fontSize:g(Me?1.1:1),fontWeight:"800",fill:Ut,style:{filter:Ee},children:Me})})]}):e.jsxs("g",{children:[a&&e.jsx("rect",{x:y-ce/2-4,y:Le-ce*.75,width:ce*1.4,height:ce,fill:"transparent",stroke:Pe?Yt:Ut,strokeWidth:1,rx:ce*.2}),e.jsx("text",{x:y,y:_e,textAnchor:"middle",fontSize:g(Pe?1.35:t?1.1:1),fill:Pe?Yt:t?Ut:oe,fontWeight:Pe?"900":t?"800":"500",style:{filter:Pe?dt:t?Ee:Ve},children:r})]}),!J&&e.jsxs("text",{x:y,y:pn,textAnchor:"middle",fontSize:ln,fontWeight:"700",fill:Jt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ee},children:[e.jsx("tspan",{x:y,dy:0,children:ke}),Z&&e.jsx("tspan",{x:y,dy:Ce,children:Z}),We&&e.jsx("tspan",{x:y,dy:Ce,children:We})]}),!J&&e.jsxs("text",{x:y,y:mn,textAnchor:"middle",fontSize:cn,fontWeight:"700",fill:Qt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ee},children:[e.jsx("tspan",{x:y,dy:0,children:Qe}),Et&&e.jsx("tspan",{x:y,dy:Ce,children:Et}),et&&e.jsx("tspan",{x:y,dy:Ce,children:et})]}),!J&&e.jsxs("text",{x:y,y:xn,textAnchor:"middle",fontSize:dn,fontWeight:"700",fill:en,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ee},children:[e.jsx("tspan",{x:y,dy:0,children:Rt}),$t&&e.jsx("tspan",{x:y,dy:Ce,children:$t}),Bt&&e.jsx("tspan",{x:y,dy:Ce,children:Bt})]}),le&&lt!=null&&W&&e.jsx("g",{transform:`translate(${y-be/2}, ${lt-be/2})`,role:"img","aria-label":`Relación registrada el ${l.isoDate||`día ${N+1}`}`,children:e.jsx(on,{width:be,height:be,color:Ht,fill:Ht})})]},`pt-${N}-${l.isoDate||l.timestamp}`)})]})},cs=(s,o)=>{if(s.data!==o.data||s.getX!==o.getX||s.getY!==o.getY||s.isFullScreen!==o.isFullScreen||s.orientation!==o.orientation||s.responsiveFontSize!==o.responsiveFontSize||s.onPointInteraction!==o.onPointInteraction||s.clearActivePoint!==o.clearActivePoint||s.chartHeight!==o.chartHeight||s.chartWidth!==o.chartWidth||s.temperatureField!==o.temperatureField||s.textRowHeight!==o.textRowHeight||s.compact!==o.compact||s.reduceMotion!==o.reduceMotion||s.isScrolling!==o.isScrolling||s.showInterpretation!==o.showInterpretation||s.ovulationDetails!==o.ovulationDetails||s.firstHighIndex!==o.firstHighIndex||s.baselineIndices!==o.baselineIndices||s.graphBottomLift!==o.graphBottomLift||s.graphBottomY!==o.graphBottomY||s.rowsZoneHeight!==o.rowsZoneHeight||s.showRelationsRow!==o.showRelationsRow)return!1;const x=s.visibleRange,h=o.visibleRange;if(x?.startIndex!==h?.startIndex||x?.endIndex!==h?.endIndex)return!1;const $=s.padding,g=o.padding;return!($!==g&&(!$||!g||$.left!==g.left||$.right!==g.right||$.top!==g.top||$.bottom!==g.bottom))},ds=yn.memo(ls,cs),us="var(--color-sensacion-fuerte)",fs="var(--color-apariencia-fuerte)",hs="var(--color-observaciones-fuerte)",ps=({padding:s,chartHeight:o,tempMin:x,tempMax:h,tempRange:$,getY:g,responsiveFontSize:G,textRowHeight:_,isFullScreen:S,graphBottomY:w,rowsZoneHeight:B,showRelationsRow:ee=!1})=>{const q={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},z=[];if($>0){const L=$<=2.5?.1:.5;for(let ue=x;ue<=h+1e-9;ue+=L)z.push(parseFloat(ue.toFixed(1)))}else for(let L=35.8;L<=37.2+1e-9;L+=.1)z.push(parseFloat(L.toFixed(1)));const R=w,J=S?9:7.5,u=S?1:.75,F=ee?J+(S?2:1.5):null,O=J+u,te=Math.max(1,Math.floor(B/O)),b=Math.max(_,te),Te=i.useMemo(()=>{const L=[{label:"Fecha",row:1,color:"#374151",icon:null},{label:"Día",row:2,color:"#374151",icon:null},{label:"Símbolo",row:3,color:"#374151",icon:null},{label:"Sens.",row:S?5:4.5,color:us,icon:{type:"text",value:"◊"}},{label:"Apar.",row:S?7:6,color:fs,icon:{type:"text",value:"○"}},{label:"Obs.",row:S?9:7.5,color:hs,icon:{type:"text",value:"✦"}}];return ee&&F!=null&&L.push({label:"RS",row:F,color:"#f44336",icon:{type:"heart"}}),L},[S,F,ee]);return e.jsxs("svg",{width:s.left,height:o,className:"font-sans pointer-events-none",children:[e.jsx("defs",{children:e.jsx("filter",{id:"textShadowLegend",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.9)"})})}),z.map((L,ue)=>{const ne=g(L),le=L.toFixed(1).endsWith(".0")||L.toFixed(1).endsWith(".5"),f=le?L.toFixed(1):`.${L.toFixed(1).split(".")[1]}`;return e.jsx(Ue.g,{variants:q,children:e.jsx("text",{x:s.left-G(1.2),y:ne+G(.35),textAnchor:"end",fontSize:G(le?1.15:1),fontWeight:le?"800":"700",fill:le?"#be185d":"#db2777",opacity:le?1:.85,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:f})},`temp-tick-fixed-${ue}`)}),e.jsx(Ue.g,{variants:q,children:Te.map(({label:L,row:ue,color:ne,icon:le})=>{const f=s.left-G(2.8),fe=R+b*ue,T=G(.95);return e.jsxs("g",{children:[le?.type==="text"&&e.jsx("text",{x:f,y:fe,textAnchor:"middle",fontSize:G(.8),fontWeight:"600",fill:ne,opacity:.7,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:le.value}),le?.type==="heart"&&e.jsx("g",{transform:`translate(${f-T/2}, ${fe-T/2})`,opacity:.7,children:e.jsx(on,{width:T,height:T,color:ne,fill:ne,"aria-hidden":"true"})}),e.jsx("text",{x:s.left-G(.8),y:R+b*ue,textAnchor:"end",fontSize:G(1.05),fontWeight:"800",fill:ne,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:L})]},L)})})]})},ms=({data:s,isFullScreen:o,orientation:x,onToggleIgnore:h,onEdit:$,onTogglePeak:g,cycleId:G,initialScrollIndex:_=0,visibleDays:S=5,showInterpretation:w=!1,reduceMotion:B=!1,forceLandscape:ee=!1,currentPeakIsoDate:q=null,showRelationsRow:z=!1,fertilityStartConfig:R=null,fertilityCalculatorCycles:J=[],fertilityCalculatorCandidates:u=null,onShowPhaseInfo:F=null,isArchivedCycle:O=!1,cycleEndDate:te=null})=>{const{chartRef:b,tooltipRef:Te,dimensions:L,activePoint:ue,activeIndex:ne,tooltipPosition:le,allDataPoints:f,validDataForLine:fe,tempMin:T,tempMax:ye,tempRange:je,padding:m,textRowHeight:he,getY:Ge,getX:H,handlePointInteraction:jt,handleToggleIgnore:At,responsiveFontSize:Le,clearActivePoint:qe,baselineTemp:Xe,baselineStartIndex:It,baselineIndices:lt,firstHighIndex:ge,ovulationDetails:V,fertilityStart:v,hasAnyObservation:tt,graphBottomInset:Ke,todayIndex:nt}=Ln(s,o,x,h,G,S,ee,R,J,u,z),be=i.useRef(null);if(!be.current){const n=Math.random().toString(36).slice(2,10);be.current=`fertility-chart-${G??"default"}-${n}`}const Ze=be.current,$e=i.useCallback((n,d)=>{const c=n>=20?1:2,A=Math.ceil(n*c),k=Math.min(A,24);return Math.max(k,12)},[]),Be=i.useMemo(()=>{const n=f.length;if(!n)return{startIndex:0,endIndex:-1};const d=$e(S,n),c=Math.max(0,Math.floor(_)-d),A=Math.min(n-1,Math.floor(_)+S+d);return{startIndex:c,endIndex:A}},[f.length,$e,_,S]),[pe,Ct]=i.useState(Be),De=i.useRef(null),[Ye,Ae]=i.useState(!1),we=i.useRef(null);if(!f||f.length===0)return e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-pink-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),e.jsx("p",{className:"text-slate-400 font-medium",children:"No hay datos para mostrar en el gráfico"})]});const me=L.width,ae=L.contentHeight??L.height,Ce=L.scrollableContentHeight??ae,Fe=ae-m.bottom-(Ke||0),ze=Math.max(ae-Fe,0),ve=Xe!=null?Ge(Xe):null,st=!!V?.confirmed,ht=Xe!=null&&st,ct=H(0),pt=f.length>0?H(f.length-1):me-m.right,mt=st?"#F59E0B":"#94A3B8",at=st?"6 4":"4 4",Ve=st?1:.7,Ee=3,dt=me===0,Ne=ne!=null?H(ne):null,xt=ne!=null?ne>0?H(ne-1):Ne:null,gt=ne!=null?ne<f.length-1?H(ne+1):Ne:null,Je=Math.max((me-m.left-m.right)/Math.max(f.length,1),0),rt=ne!=null?Math.max((gt!=null&&xt!=null?gt-xt:0)||Je,Je,0):0,St=i.useMemo(()=>{const n=new Map;return fe.forEach(d=>{d&&d.id!=null&&n.set(d.id,d)}),n},[fe]),N=i.useMemo(()=>Number.isInteger(v?.fertileStartFinalIndex)?v.fertileStartFinalIndex:null,[v]),l=Math.max(ae-m.top-m.bottom-(Ke||0),0),y=i.useCallback(n=>!Number.isFinite(n)||!f.length||n<=0?m.left:H(n),[f,H,m.left]),xe=i.useCallback(n=>!Number.isFinite(n)||!f.length||n>=f.length-1?me-m.right:H(n+1),[f,me,H,m.right]),X=i.useCallback((n,d,{inclusiveEnd:c=!0}={})=>{if(!Number.isFinite(n)||!Number.isFinite(d)||f.length===0)return null;const A=p=>Math.max(0,Math.min(f.length-1,Math.floor(p))),k=p=>Math.max(0,Math.min(f.length-1,Math.floor(p))),ie=p=>Math.max(0,Math.min(f.length,Math.floor(p))),se=A(n),P=c?k(d):ie(d),U=se<=0?m.left:y(se);let D;c?D=P>=f.length-1?me-m.right:xe(P):P<=0?D=m.left:P>=f.length?D=me-m.right:D=y(P);const I=Math.max(D-U,0);return I<=0?null:{x:U,width:I}},[f,me,y,xe,m.left,m.right]),re=f.length>0?f.length-1:null,Ie=i.useMemo(()=>{if(!O||!te||re==null)return null;const n=typeof te=="string"?te:null;if(!n)return null;const d=f.findIndex(c=>c?.isoDate===n);if(d>=0)return Math.min(d,re);for(let c=f.length-1;c>=0;c-=1){const A=f[c]?.isoDate;if(typeof A=="string"&&A<=n)return Math.min(c,re)}return null},[O,te,f,re]),Q=i.useMemo(()=>re==null?null:O?Number.isInteger(Ie)?Math.min(Ie,re):re:Number.isInteger(nt)?Math.min(nt,re):re,[Ie,O,nt,re]),oe=l>0?m.top+l*.5:null,Oe=oe!=null?Math.max(Fe-oe,0):0,W=i.useMemo(()=>{if(!w||!tt)return null;const n=v?.debug,d=Number.isInteger(n?.mucusInfertileStartIndex)?n.mucusInfertileStartIndex:null,c=Number.isInteger(v?.fertileWindow?.temperatureInfertileStartIndex)?v.fertileWindow.temperatureInfertileStartIndex:null,A=[d,c].filter(et=>Number.isInteger(et)).sort((et,Rt)=>et-Rt)[0],k=Number.isInteger(A)?A:Number.isInteger(n?.postOvulatoryStartIndex)?n.postOvulatoryStartIndex:null,ie=Number.isInteger(d)&&Number.isInteger(c)?Math.max(d,c):null,se=Number.isInteger(ie)?ie:Number.isInteger(n?.absoluteStartIndex)?n.absoluteStartIndex:null,P={confirmed:!!V?.confirmed,rule:V?.rule??null,baselineTemp:V?.baselineTemp??null,baselineIndices:Array.isArray(V?.baselineIndices)?V.baselineIndices:[],firstHighIndex:Number.isInteger(V?.firstHighIndex)?V.firstHighIndex:null,highSequenceIndices:Array.isArray(V?.highSequenceIndices)?V.highSequenceIndices:[],confirmationIndex:Number.isInteger(V?.confirmationIndex)?V.confirmationIndex:null,startIndex:c},U={peakDayIndex:Number.isInteger(V?.peakDayIndex)?V.peakDayIndex:null,thirdDayIndex:Number.isInteger(V?.thirdDayIndex)?V.thirdDayIndex:null,startIndex:d},D=c!=null,I=d!=null;if(!D&&!I)return null;const p=Number.isInteger(k)?k:null;if(p==null)return null;let E="pending",C="",Y="Infertilidad postovulatoria",K="Fase postovulatoria: se ha cumplido un criterio de cierre; falta el segundo para confirmar la infertilidad absoluta.";const de="Infertilidad absoluta",Re="Fase postovulatoria alcanzada (se ha confirmado día pico y subida de temperatura).",ke="Confirmación completa: doble criterio (día pico + temperatura).";let Z=Y,We=K,Qe=C,Et="pending";return D&&I?(E="absolute",Y=de,K=ke,C=Re,Number.isInteger(c)&&(!Number.isInteger(d)||c<=d)?(P.rule,Qe=`Temperatura confirmada el ${P.confirmationIndex!=null?`D${P.confirmationIndex+1}`:"—"}. A la espera de determinación del día pico.`,We=Qe,Z="Infertilidad estimada por temperatura"):(Qe=`Alcanzado ${U.thirdDayIndex!=null?"3° día postpico":"4º día postpico"} tras alcanzar día pico el ${U.peakDayIndex+1} del ciclo`,We=Qe,Z="Infertilidad estimada por moco")):D?(P.rule,C=`Temperatura confirmada el ${P.confirmationIndex!=null?`D${P.confirmationIndex+1}`:"—"}. A la espera de determinación del día pico.`,K=C,Y="Infertilidad estimada por temperatura",Qe=C,We=K,Z=Y):(C=`Alcanzado ${U.thirdDayIndex!=null?"3° día postpico":"4º día postpico"} tras seleccionar día pico el ${U.peakDayIndex+1} del ciclo`,K=C,Y="Infertilidad estimada por moco",Qe=C,We=K,Z=Y),{phase:"postOvulatory",status:E,startIndex:p,absoluteStartIndex:se,estimated:{status:Et,label:Z,tooltip:We,message:Qe},absolute:{label:de,tooltip:ke,message:Re},reasons:{type:"post",status:E,mucus:U,temperature:P},message:C,label:Y,tooltip:K}},[w,tt,V,v]),Mt=i.useMemo(()=>{if(!w||l<=0||oe==null||Oe<=0||f.length===0)return[];const n=[],d=f.length-1,c=Number.isInteger(Q)&&Q>=0?Math.min(Q,d):d,A=(I,p)=>{if(!W)return;const E=W.startIndex,C=Number.isInteger(W.absoluteStartIndex)?W.absoluteStartIndex:null,Y=W.estimated??W,K=W.absolute??W,de=C??E,Re=W.status==="absolute"?d:Math.min(d,p);if(C!=null&&C>E){const ke=Math.min(C-1,p),Z=X(E,ke);Z&&I.push({key:"post-pending",phase:"postOvulatory",status:Y.status??"pending",bounds:Z,startIndex:E,endIndex:ke,displayLabel:Y.label,tooltip:Y.tooltip,message:Y.message,reasons:W.reasons})}if(de<=Re){const ke=X(de,Re);ke&&I.push({key:"post-absolute",phase:"postOvulatory",status:C!=null?"absolute":W.status,bounds:ke,startIndex:de,endIndex:Re,displayLabel:C!=null?K.label:W.label,tooltip:C!=null?K.tooltip:W.tooltip,message:C!=null?K.message:W.message,reasons:W.reasons})}},k=Number.isInteger(N),ie=Number.isFinite(W?.startIndex);if(!k&&!ie){const I=Math.min(c,d);if(I<0)return n;const p=X(0,I);return p&&n.push({key:"relative-default",phase:"relativeInfertile",status:"default",bounds:p,startIndex:0,endIndex:I,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (preovulatoria: sin día fértil por CPM/T-8 ni signos de moco fértil)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:null,aggregate:v?.aggregate??null,bipScore:v?.debug?.bipScore??null}}),n}if(!k&&ie){const I=W.startIndex,p=Math.min(I-1,c);if(p>=0){const E=X(0,p);E&&n.push({key:"no-fertile-window",phase:"nodata",status:"no-fertile-window",bounds:E,startIndex:0,endIndex:p,displayLabel:"Sin ventana fértil identificable",tooltip:"Sin ventana fértil identificable",message:"Sin ventana fértil identificable",reasons:{type:"nofertile",status:"no-fertile-window",message:"No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."}})}return Number.isFinite(W.startIndex)&&W.startIndex<=d&&A(n,c),n}if(k&&N>0){const I=Math.min(N-1,c);if(I>=0){const p=X(0,I);p&&n.push({key:"relative",phase:"relativeInfertile",status:"default",bounds:p,startIndex:0,endIndex:I,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (fase relativamente infértil preovulatoria)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:N,aggregate:v?.aggregate??null,bipScore:v?.debug?.bipScore??null}})}}const se=k?Math.max(N,0):0,P=W?.startIndex,U=Number.isFinite(P)&&P!=null?Math.min(P-1,d):d,D=Math.min(U,c);if(D>=se){const I=X(se,D);if(I){const p=Number.isInteger(v?.debug?.explicitStartDay)?v.debug.explicitStartDay:null,E=v?.aggregate?.usedCandidates??[],C=E.some(de=>de?.kind==="profile"),Y=E.some(de=>de?.kind==="calculator");let K=null;k&&p!=null&&p===N?K="marker":C?K="profiles":Y&&(K="calculator"),n.push({key:"fertile",phase:"fertile",status:"default",bounds:I,startIndex:se,endIndex:D,displayLabel:"Fértil",tooltip:"Fértil",message:"Fértil",reasons:{type:"fertile",startIndex:se,endIndex:D,source:K,details:v?.debug??null,notes:v?.aggregate?.notes??[],statusSummary:v?.currentAssessment??null,dailyAssessments:v?.dailyAssessments??[],window:v?.fertileWindow??null,aggregate:v?.aggregate??null}})}}return W&&Number.isFinite(W.startIndex)&&W.startIndex<=d&&A(n,c),n},[w,l,oe,Oe,f.length,N,v,W,tt,X,Q]),yt=`${Ze}-phase-relative-gradient`,Se=`${Ze}-phase-fertile-gradient`,ot=`${Ze}-phase-post-pending-gradient`,it=`${Ze}-phase-post-absolute-gradient`,kt=n=>n.phase==="relativeInfertile"?"#065F46":n.phase==="fertile"?"#9D174D":n.phase==="postOvulatory"?n.status==="pending"?"#075985":"#1E3A8A":n.phase==="nodata"?"#475569":"hsl(var(--foreground))",vt="0 1px 1px var(--phase-text-shadow, rgba(15, 23, 42, 0.2))",Nt=i.useMemo(()=>{if(!w||!V?.confirmed)return null;const n=Array.isArray(V?.highSequenceIndices)?V.highSequenceIndices:[];if(n.length<2)return null;const d=n.map(c=>{if(c==null||c<0||c>=f.length)return null;const A=f[c],k=St.get(A?.id);return!k||!Number.isFinite(k.displayTemperature)?null:{x:H(c),y:Ge(k.displayTemperature)}}).filter(Boolean);return d.length<2?null:d.map(({x:c,y:A},k)=>`${k===0?"M":"L"} ${c} ${A}`).join(" ")},[w,V,f,St,H,Ge]),[He,ce]=i.useState({w:typeof window<"u"?window.innerWidth:0,h:typeof window<"u"?window.innerHeight:0}),_e=He.w<He.h;i.useEffect(()=>{const n=()=>ce({w:window.innerWidth,h:window.innerHeight});return window.addEventListener("resize",n),window.addEventListener("orientationchange",n),()=>{window.removeEventListener("resize",n),window.removeEventListener("orientationchange",n)}},[]);const Me=i.useCallback((n=0)=>{const d=b.current;if(!d)return;const c=f.length;if(!c){Ct({startIndex:0,endIndex:-1});return}const A=d.clientWidth||1,ie=A/Math.max(S,1)||1,se=$e(S,c),P=Math.floor(n/ie),U=Math.floor((n+A)/ie);let D=P-se,I=U+se;D=Math.max(0,D),I=Math.min(c-1,I),Ct(p=>p.startIndex===D&&p.endIndex===I?p:{startIndex:D,endIndex:I})},[f.length,$e,S]);i.useEffect(()=>{if(!b.current)return;const n=b.current.clientWidth/S;b.current.scrollLeft=Math.max(0,n*_),Me(b.current.scrollLeft)},[_,S,L.width,x,Me]),i.useEffect(()=>{const n=b.current;if(!n)return;const d=()=>{Ae(!0),we.current&&window.clearTimeout(we.current),we.current=window.setTimeout(()=>Ae(!1),140),!De.current&&(De.current=window.requestAnimationFrame(()=>{De.current=null,Me(n.scrollLeft)}))};return n.addEventListener("scroll",d,{passive:!0}),Me(n.scrollLeft),()=>{n.removeEventListener("scroll",d),we.current&&window.clearTimeout(we.current),De.current&&(window.cancelAnimationFrame(De.current),De.current=null)}},[Me]);const Pe=o&&ee&&_e,t=ee?"landscape":x,r=Pe,a="w-full h-full bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",j=o?`${a} h-full ${r?"overflow-y-auto overflow-x-auto":"overflow-x-auto overflow-y-auto"}`:`${a} overflow-x-auto overflow-y-visible border border-pink-100/50`,M=!o||t==="portrait";return e.jsx(Ue.div,{className:"relative w-full h-full",initial:!1,children:e.jsxs(Ue.div,{ref:b,className:`relative p-0 ${o?"":"rounded-2xl"} ${j}`,style:{touchAction:"auto",boxShadow:o?"inset 0 1px 3px rgba(244, 114, 182, 0.1)":"0 8px 32px rgba(244, 114, 182, 0.12), 0 2px 8px rgba(244, 114, 182, 0.08)",...Pe?{position:"absolute",top:"50%",left:"50%",width:`${He.h}px`,height:`${He.w}px`,transform:"translate(-50%, -50%) rotate(90deg)",transformOrigin:"center center"}:{}},initial:!1,children:[dt&&e.jsx("div",{className:"flex items-center justify-center w-full h-full text-slate-400",children:"Cargando..."}),e.jsx("div",{className:"inline-block",style:{width:me,height:ae},children:e.jsx("div",{className:"relative h-full overflow-y-auto",style:{height:ae,maxHeight:Ce},children:e.jsxs("div",{className:"relative",style:{width:me,height:Ce},children:[M&&e.jsx("div",{className:"absolute left-0 top-0 h-full bg-transparent pointer-events-none z-10",style:{width:m.left},children:e.jsx(ps,{padding:m,chartHeight:Ce,tempMin:T,tempMax:ye,tempRange:je,getY:Ge,responsiveFontSize:Le,textRowHeight:he,isFullScreen:o,graphBottomY:Fe,rowsZoneHeight:ze,showRelationsRow:z})}),e.jsxs(Ue.svg,{width:me,height:Ce,className:"font-sans flex-shrink-0",viewBox:`0 0 ${me} ${Ce}`,preserveAspectRatio:"xMidYMid meet",initial:!1,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#F472B6"}),e.jsx("stop",{offset:"50%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#E91E63"})]}),e.jsxs("linearGradient",{id:"tempAreaGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(244, 114, 182, 0.18)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(244, 114, 182, 0.02)"})]}),e.jsxs("linearGradient",{id:yt,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-rel)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-rel)",stopOpacity:"var(--phase-rel-stop, 0.28)"})]}),e.jsxs("linearGradient",{id:Se,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-fertile)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-fertile)",stopOpacity:"var(--phase-fertile-stop, 0.27)"})]}),e.jsxs("linearGradient",{id:ot,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post)",stopOpacity:"var(--phase-post-stop, 0.45)"})]}),e.jsxs("linearGradient",{id:it,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post-abs)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post-abs)",stopOpacity:"var(--phase-post-abs-stop, 0.7)"})]}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"chartShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"baselineGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("rect",{width:"100%",height:"100%",fill:"transparent"}),e.jsx(Xn,{padding:m,chartWidth:me,chartHeight:ae,tempMin:T,tempMax:ye,tempRange:je,getY:Ge,getX:H,allDataPoints:f,visibleRange:pe,responsiveFontSize:Le,isFullScreen:o,showLeftLabels:!M,reduceMotion:B,isScrolling:Ye,graphBottomY:Fe,chartAreaHeight:Math.max(ae-m.top-m.bottom-(Ke||0),0),rowsZoneHeight:ze}),w&&Mt.length>0&&oe!=null&&Oe>0&&e.jsx("g",{children:Mt.map(n=>{const d=oe,c=Oe,k=n.phase==="postOvulatory"?n.status==="pending"?`url(#${ot})`:`url(#${it})`:n.phase==="relativeInfertile"?`url(#${yt})`:n.phase==="fertile"?`url(#${Se})`:n.phase==="nodata"?"rgba(203, 213, 225, 0.2)":`url(#${Se})`,ie=o?14:13,se=Math.max(Le(1.1),ie),P=n.bounds.width<120,U=Math.max(n.bounds.width-16,0),D=Math.max(se*.58,1),I=Math.max(1,Math.floor(U/D)),p=n.tooltip??n.displayLabel??n.message??"";let E=n.displayLabel??n.message??"";if(P&&E.length>I){const Z=Math.max(I-1,1);E=`${E.slice(0,Z).trimEnd()}${E.length>Z?"…":""}`}const C=P?n.bounds.x+8:n.bounds.x+n.bounds.width/2,Y=P?"start":"middle",K=d+c/2,de=kt(n),Re=Z=>{typeof Z?.stopPropagation=="function"&&Z.stopPropagation(),typeof F=="function"&&F({phase:n.phase,status:n.status,reasons:n.reasons,message:n.message,startIndex:n.startIndex,endIndex:n.endIndex,label:n.displayLabel??n.message??null})},ke=Z=>{(Z.key==="Enter"||Z.key===" ")&&(Z.preventDefault(),Re(Z))};return e.jsxs("g",{children:[e.jsx("rect",{x:n.bounds.x,y:d,width:n.bounds.width,height:c,fill:k,pointerEvents:"none"}),e.jsxs("text",{x:C,y:K,fill:de,fontSize:se,fontWeight:600,dominantBaseline:"middle",textAnchor:Y,role:"button","aria-label":p,tabIndex:0,onClick:Re,onKeyDown:ke,style:{cursor:"pointer",userSelect:"none",lineHeight:1.2,textShadow:vt},pointerEvents:"auto",children:[e.jsx("title",{children:p}),E]})]},n.key)})}),w&&ht&&ve!==null&&(B?e.jsx("line",{x1:ct,y1:ve,x2:pt,y2:ve,stroke:mt,strokeWidth:Ee,strokeDasharray:at,opacity:Ve}):e.jsx(Ue.path,{d:`M ${ct} ${ve} L ${pt} ${ve}`,stroke:mt,strokeWidth:Ee,strokeDasharray:at,opacity:Ve,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:Ve},transition:{duration:4,ease:"easeInOut",delay:.5}})),e.jsx(Kn,{data:fe,allDataPoints:f,getX:H,getY:Ge,baselineY:Fe,temperatureField:"displayTemperature",reduceMotion:B}),Nt&&e.jsx("g",{pointerEvents:"none",children:e.jsx("path",{d:Nt,fill:"none",stroke:"#cc0e93",strokeWidth:4,strokeLinecap:"round",strokeLinejoin:"round",opacity:.9})}),ne!==null&&Ne!==null&&rt>0&&e.jsx("g",{pointerEvents:"none",children:(()=>{const n=Fe,d=Math.max(3,Math.min(14,rt*.4)),c=Math.max(d*2,he*.85);return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:Ne,y1:0,x2:Ne,y2:n,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:d}),e.jsx("line",{x1:Ne,y1:n,x2:Ne,y2:ae,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:c})]})})()}),e.jsx(ds,{data:f,getX:H,getY:Ge,isFullScreen:o,orientation:t,responsiveFontSize:Le,onPointInteraction:jt,clearActivePoint:qe,activePoint:ue,visibleRange:pe,padding:m,chartHeight:ae,chartWidth:me,temperatureField:"displayTemperature",textRowHeight:he,graphBottomY:Fe,rowsZoneHeight:ze,compact:!1,reduceMotion:B,isScrolling:Ye,showInterpretation:w,ovulationDetails:V,baselineStartIndex:It,firstHighIndex:ge,baselineIndices:lt,graphBottomLift:Ke,showRelationsRow:z})]})]})})}),ue&&e.jsx(Ue.div,{ref:Te,initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:10},transition:{duration:.12,ease:"easeOut"},children:e.jsx(Dn,{point:ue,position:le,chartWidth:me,chartHeight:ae,onToggleIgnore:At,onEdit:$,onClose:qe,onTogglePeak:g,currentPeakIsoDate:q})})]})})};function xs(s,o){if(!s||!o)return[];const x=typeof s=="string"?ut(s):s;return[...Array(o)].map((h,$)=>{const g=bn(x,$),G=Lt(g,"yyyy-MM-dd"),_=Lt(g,"dd/MM"),S=Xt(ft(g),ft(x))+1;return{date:_,isoDate:G,cycleDay:S,temperature:null,mucusSensation:null,mucusAppearance:null,had_relations:!1,hadRelations:!1,id:`placeholder-${G}`,ignored:!1,peak_marker:null}})}const gs=({isOpen:s,onClose:o,children:x,ariaLabel:h,containerClassName:$="",backdropClassName:g="bg-black/40"})=>{if(i.useEffect(()=>{if(!s)return;const S=ee=>{ee.key==="Escape"&&typeof o=="function"&&o()};document.addEventListener("keydown",S);const{body:w}=document,B=w.style.overflow;return w.style.overflow="hidden",()=>{document.removeEventListener("keydown",S),w.style.overflow=B}},[s,o]),!s||typeof document>"u")return null;const G=()=>{typeof o=="function"&&o()},_=S=>{S.stopPropagation()};return wn.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center px-4 py-8",children:[e.jsx("div",{className:`absolute inset-0 ${g}`,onClick:G,"aria-hidden":"true"}),e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":h??void 0,className:`relative z-[101] w-full max-w-md overflow-hidden rounded-3xl bg-white shadow-2xl shadow-rose-200/50 focus:outline-none focus-visible:ring-2 focus-visible:ring-pink-200 ${$}`,onClick:_,children:x})]}),document.body)},sn="fertility-chart-settings",Ot=s=>s?String(s).toUpperCase().replace(/-/g,""):"",ys=s=>{const o=Ot(s);return o==="T8"?"T-8":o==="CPM"?"CPM":s??""},Dt=()=>({calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"estandar"}),an={showRelationsRow:!0,fertilityStartConfig:Dt()},bs=[{key:"cpm",label:"CPM"},{key:"t8",label:"T-8"}],Tt={conservador:"Conservador",estandar:"Estándar"},qt=s=>{const o=Dt(),x={calculators:{...o.calculators},postpartum:o.postpartum,combineMode:o.combineMode};return s&&typeof s=="object"&&(Object.keys(x.calculators).forEach(h=>{typeof s?.calculators?.[h]=="boolean"&&(x.calculators[h]=s.calculators[h])}),Object.prototype.hasOwnProperty.call(Tt,s.combineMode)&&(x.combineMode=s.combineMode),typeof s.postpartum=="boolean"?x.postpartum=s.postpartum:s.postpartum!=null&&(x.postpartum=!!s.postpartum)),x},Ls=()=>{const{cycleId:s}=jn(),o=In(),{currentCycle:x,archivedCycles:h,isLoading:$,addOrUpdateDataPoint:g,toggleIgnoreRecord:G,getCycleById:_}=Pn(),[S,w]=i.useState(null),[B,ee]=i.useState(!1),[q,z]=i.useState(!1),R=!s||s===x.id,J=R?null:h.find(t=>t.id===s);i.useEffect(()=>{if(R){w(null),ee(!1),z(!1);return}if(J){w(null),ee(!1),z(!1);return}let t=!0;return ee(!0),_(s).then(r=>{t&&(r?(w(r),z(!1)):(w(null),z(!0)))}).catch(()=>{t&&(w(null),z(!0))}).finally(()=>{t&&ee(!1)}),()=>{t=!1}},[R,J,_,s]);const u=R?x:J||S,F=!R&&!J,O=!R&&u?.id,te=R?$&&!x?.id:B||$&&!J&&!S,{preferences:b,savePreferences:Te}=Cn(),L=b?.manualCpm,ue=b?.manualCpmBase,ne=b?.manualT8,le=b?.manualT8Base,f=["auto","manual","none"].includes(b?.cpmMode)?b.cpmMode:"auto",fe=["auto","manual","none"].includes(b?.t8Mode)?b.t8Mode:"auto",T=i.useMemo(()=>{if(!O||!u?.startDate)return"";const t=j=>{if(!j)return null;try{return Lt(ut(j),"dd/MM/yyyy")}catch(M){return console.error("Error formatting cycle date",M),j}},r=t(u.startDate),a=t(u.endDate)??"Sin fecha de fin";return r?`Ciclo ${r} - ${a}`:""},[O,u?.startDate,u?.endDate]),ye=i.useMemo(()=>{const t=[];return Array.isArray(h)&&h.length>0&&t.push(...h),x?.id&&t.push(x),u?.id&&!t.some(r=>r?.id===u.id)&&t.push(u),t},[h,x,u]),[je,m]=i.useState(typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait"),[he,Ge]=i.useState(!1),[H,jt]=i.useState(!1),[At,Le]=i.useState(!1),[qe,Xe]=i.useState(null),[It,lt]=i.useState(null),[ge,V]=i.useState(!1),[v,tt]=i.useState(!1),[Ke,nt]=i.useState(!1),[be,Ze]=i.useState(null),[$e,Be]=i.useState(()=>{const t={showRelationsRow:an.showRelationsRow,fertilityStartConfig:qt(an.fertilityStartConfig)};if(typeof window>"u")return t;try{const r=window.localStorage.getItem(sn);if(r){const a=JSON.parse(r),j={...t,...a};return typeof a?.showRelationsRow=="boolean"?j.showRelationsRow=a.showRelationsRow:a?.showRelationsRow!=null&&(j.showRelationsRow=!!a.showRelationsRow),j.fertilityStartConfig=qt(a?.fertilityStartConfig),j}}catch(r){console.warn("No se pudieron cargar los ajustes del gráfico.",r)}return t});i.useEffect(()=>{b&&Be(t=>{const r=t.fertilityStartConfig??Dt(),a={...r};let j=!1;return typeof b.showRelationsRow=="boolean"&&t.showRelationsRow!==b.showRelationsRow&&(j=!0),Object.prototype.hasOwnProperty.call(Tt,b.combineMode)&&r.combineMode!==b.combineMode&&(a.combineMode=b.combineMode,j=!0),j?{...t,showRelationsRow:typeof b.showRelationsRow=="boolean"?b.showRelationsRow:t.showRelationsRow,fertilityStartConfig:a}:t})},[b]);const pe=i.useMemo(()=>qt($e.fertilityStartConfig),[$e.fertilityStartConfig]),Ct=i.useMemo(()=>({...pe,calculators:{...pe.calculators,cpm:pe.calculators.cpm&&f!=="none",t8:pe.calculators.t8&&fe!=="none"}}),[pe,f,fe]);i.useEffect(()=>{if(!(typeof window>"u"))try{const t={...$e,fertilityStartConfig:pe};window.localStorage.setItem(sn,JSON.stringify(t))}catch(t){console.warn("No se pudieron guardar los ajustes del gráfico.",t)}},[$e,pe]);const De=i.useRef(!1),Ye=i.useRef(0),Ae=i.useRef(null),we=i.useRef(null),me=!!(qe&&String(qe.id||"").startsWith("placeholder-"));if(i.useEffect(()=>{if(typeof document>"u")return;const t=document.body,r=document.documentElement;if(he){Ae.current===null&&(Ae.current=t.style.overflow),we.current===null&&(we.current=r.style.overflow),t.style.overflow="hidden",r.style.overflow="hidden";return}return Ae.current!==null&&(t.style.overflow=Ae.current,Ae.current=null),we.current!==null&&(r.style.overflow=we.current,we.current=null),()=>{Ae.current!==null&&(t.style.overflow=Ae.current,Ae.current=null),we.current!==null&&(r.style.overflow=we.current,we.current=null)}},[he]),i.useLayoutEffect(()=>{window.dispatchEvent(new Event("resize"))},[je,he]),i.useEffect(()=>{if(typeof window>"u")return;const t=()=>{if(H)return;const r=window.innerWidth>window.innerHeight?"landscape":"portrait";m(a=>a===r?a:r),window.dispatchEvent(new Event("resize"))};return window.addEventListener("resize",t),window.addEventListener("orientationchange",t),t(),()=>{window.removeEventListener("resize",t),window.removeEventListener("orientationchange",t)}},[H]),te)return e.jsx(Pt,{children:e.jsx("div",{className:"flex h-full flex-col items-center justify-center space-y-4 bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-fertiliapp-fuerte",children:e.jsx("p",{children:"Cargando…"})})});if(!u?.id)return s&&q?e.jsx(Pt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-fertiliapp-fuerte",children:[e.jsx("p",{children:"No se encontró el ciclo solicitado."}),e.jsx(wt,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl text-white shadow",children:e.jsx(Gt,{to:"/archived-cycles",children:"Volver a Mis Ciclos"})})]})}):e.jsx(Pt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-fertiliapp-fuerte",children:[e.jsx("p",{children:"No hay ciclo activo."}),e.jsx(wt,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl text-white shadow",children:e.jsx(Gt,{to:"/records",children:"Ir a Mis Registros"})})]})});const ae=28,Ce=10,Fe=25,ze=ut(u.startDate),ve=u.data||[],st=i.useMemo(()=>(Array.isArray(ve)?ve.find(r=>r?.peak_marker==="peak"):null)?.isoDate||null,[ve]),ht=ve.reduce((t,r)=>{const a=ut(r.isoDate);return a>t?a:t},ze),ct=ft(new Date),pt=ht>ct?ht:ct,mt=Xt(ft(pt),ze),at=Math.max(ae,mt+1),Ee=xs(ze,at).map(t=>{const r=ve.find(a=>a.isoDate===t.isoDate);return r?{...r,date:t.date}:t}),dt=H?"landscape":je,Ne=he?dt==="portrait"?Ce:Fe:dt==="portrait"?Ce:ae;let xt=0;if(dt!=="landscape"){const t=Xt(new Date,ft(ze)),r=Math.min(Math.max(t,0),at-1);let a=Math.min(at,r+1);r<Ne-1&&(a=Math.min(at,Ne)),xt=Math.max(0,a-Ne)}const gt={backgroundColor:"#fff7fb",backgroundImage:`
      radial-gradient(120% 120% at 0% 0%, rgba(251,113,133,0.18) 0, transparent 55%),
      radial-gradient(110% 110% at 100% 0%, rgba(244,114,182,0.16) 0, transparent 55%),
      radial-gradient(130% 130% at 0% 100%, rgba(251,113,133,0.08) 0, transparent 60%),
      radial-gradient(140% 140% at 100% 100%, rgba(255,255,255,0.9) 0, rgba(255,247,250,0.3) 40%, transparent 70%)
    `},Je="calc(var(--app-vh, 1vh) * 100)",rt="var(--bottom-nav-safe)",St=he?{...gt,height:Je,maxHeight:Je,paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"}:{...gt,height:`calc(${Je} - ${rt})`,maxHeight:`calc(${Je} - ${rt})`,paddingTop:"env(safe-area-inset-top)"},N=(t,r=null)=>{Xe(t),lt(r??null),Le(!0)},l=async(t,r)=>{try{if(await G(t,r),F){const a=await _(t);a&&w(a)}}catch(a){console.error("Error toggling ignore state:",a)}},y=t=>{const r=t===!0;Be(a=>({...a,showRelationsRow:r})),typeof Te=="function"&&Te({showRelationsRow:r}).catch(a=>{console.error("Failed to persist relations row preference",a)})},xe=(t,r)=>{Be(a=>{const j=a.fertilityStartConfig??Dt(),M=r===!0;return j.calculators?.[t]===M?a:{...a,fertilityStartConfig:{...j,calculators:{...j.calculators,[t]:M}}}})},X=t=>{Object.prototype.hasOwnProperty.call(Tt,t)&&(Be(r=>{const a=r.fertilityStartConfig??Dt();return a.combineMode===t?r:{...r,fertilityStartConfig:{...a,combineMode:t}}}),typeof Te=="function"&&Te({combineMode:t}).catch(r=>{console.error("Failed to persist combine mode preference",r)}))},re=t=>{Be(r=>{const a=r.fertilityStartConfig??Dt(),j=t===!0;return a.postpartum===j?r:{...r,fertilityStartConfig:{...a,postpartum:j}}})},Ie=o?.state?.fertilityCalculatorCandidates,Q=u?.fertilityCalculatorCandidates,oe=i.useMemo(()=>{const t=[Array.isArray(Ie)?Ie:null,Array.isArray(Q)?Q:null].find(r=>Array.isArray(r)&&r.length>0);return t?t.map(r=>{if(!r)return null;const{source:a,day:j,reason:M}=r;if(a!=="CPM"&&a!=="T8")return null;const n=Number(j);return Number.isFinite(n)?{source:a,day:n,reason:typeof M=="string"?M:""}:null}).filter(Boolean):null},[Ie,Q]),Oe=i.useMemo(()=>{const t=An(ye),r=En(ye,On),a=[];return f==="auto"&&t&&a.push(t),fe==="auto"&&r&&a.push(r),a},[ye,f,fe]),W=i.useMemo(()=>{const t=[],r=(a,j,M,n)=>{if(a!=="manual")return;const d=Number(M);if(!Number.isFinite(d)||d<=0)return;const c=Number(n),A=Number.isFinite(c)&&c>0,k=A?Number.isInteger(c)?`${c}`:`${Number(c.toFixed(2))}`:null,ie=A?j==="CPM"?`ciclo base: ${k} días`:`base ${ys(j)}: ${k}`:null,se=ie?`Manual desde dashboard (${ie})`:"Manual desde dashboard";t.push({source:j,day:Math.max(1,d),reason:se,kind:"calculator",isManual:!0,manualBase:A?c:null})};return r(f,"CPM",L,ue),r(fe,"T8",ne,le),t},[f,L,ue,ne,le,fe]),Mt=i.useMemo(()=>{const t=new Map;(Array.isArray(oe)?oe:[]).forEach(M=>{const n=Ot(M?.source);n&&t.set(n,M)});const r=new Map;W.forEach(M=>{const n=Ot(M?.source);n&&r.set(n,M)});const a=f==="manual"?r.get("CPM")??t.get("CPM")??null:f==="auto"?Oe.find(M=>Ot(M?.source)==="CPM")??null:null,j=fe==="manual"?r.get("T8")??t.get("T8")??null:fe==="auto"?Oe.find(M=>Ot(M?.source)==="T8")??null:null;return[a,j].filter(Boolean)},[Oe,f,W,oe,fe]),yt=async(t,r=!0)=>{if(!u?.id||!t?.isoDate)return;const a=M=>{if(M==null||M==="")return null;const n=parseFloat(String(M).replace(",","."));return Number.isFinite(n)?n:null},j=r??!(t.peak_marker==="peak"||t.peakStatus==="P");V(!0);try{const M=t.timestamp?Lt(ut(t.timestamp),"HH:mm"):Lt(new Date,"HH:mm");let n=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:M,time_corrected:t.time_corrected??M,selected:!0,use_corrected:t.use_corrected??!1}];n.length===0&&(n=[{temperature:null,temperature_corrected:null,time:M,time_corrected:M,selected:!0,use_corrected:!1}]);const d=n.map((k,ie)=>{const se=k.time||M,P=k.time_corrected||se;return{temperature:a(k.temperature??k.temperature_raw),time:se,selected:ie===0?!0:!!k.selected,temperature_corrected:a(k.temperature_corrected),time_corrected:P,use_corrected:!!k.use_corrected}});d.some(k=>k.selected)||(d[0].selected=!0);const c={isoDate:t.isoDate,measurements:d,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",had_relations:t.had_relations??t.hadRelations??!1,ignored:t.ignored??!1,peak_marker:j?"peak":null},A=t?.id&&!String(t.id).startsWith("placeholder-")?t:null;await g(c,A,u.id)}catch(M){console.error("Error toggling peak marker:",M)}finally{V(!1)}},Se=i.useCallback(()=>{Le(!1),Xe(null),lt(null)},[]),ot=async(t,{keepFormOpen:r=!1}={})=>{if(u?.id){V(!0),r&&(Ye.current=Date.now()+500);try{if(await g(t,qe,u.id),F){const a=await _(u.id);a&&w(a)}r||(Le(!1),Xe(null),lt(null))}finally{V(!1)}}},it=t=>{Xe(t)},kt=()=>{tt(t=>!t)},vt=i.useCallback(()=>{Ze(null)},[]),Nt=t=>{if(t.preventDefault(),De.current){De.current=!1;return}kt()},He=t=>{t.pointerType==="touch"&&(t.preventDefault(),De.current=!0,kt())},ce=i.useCallback(t=>{if(t){Le(!0);return}Date.now()<Ye.current||Se()},[Se]),_e=i.useCallback(t=>{if(!Number.isInteger(t)||t<0||t>=Ee.length)return"—";const r=Ee[t],a=r?.isoDate??r?.date;if(!a)return"—";try{const j=typeof a=="string"?ut(a):a;return Lt(j,"dd/MM")}catch(j){return console.error("Error formatting date from index",j),"—"}},[Ee]),Me=i.useCallback((t={})=>{if(!t)return;const r=t.phase??null,a=t.reasons??{},j=a?.aggregate??null,M=Array.isArray(j?.usedCandidates)?j.usedCandidates:[],n=Array.isArray(j?.ignoredCalculatorCandidates)?j.ignoredCalculatorCandidates:[],d=a?.window??a?.fertileWindow??null,c=Number.isInteger(a?.startIndex)?a.startIndex:Number.isInteger(a?.fertileStartFinalIndex)?a.fertileStartFinalIndex:null,A=j?.selectedMode??pe?.combineMode??null,k=a?.source==="marker"||a?.details?.explicitStartDay!=null?"Ajustado por marcadores":{conservador:"Conservador",estandar:"Estándar"}[A]??null,ie=p=>(p?.source??p?.originalSource??"").toString().toUpperCase(),se=()=>{const p=Number.isInteger(c)?c+1:null;return p?{candidate:M.find(C=>Number.isFinite(C?.day)&&Math.round(C.day)===p)??M[0]??null,dayNumber:p}:{candidate:null,dayNumber:null}},P=()=>{const{candidate:p}=se(),E=ie(p);if(E==="CPM")return"alcanzar valor CPM";if(E==="T8"||E==="T-8")return"alcanzar valor T-8";if(a?.source==="marker"||a?.details?.explicitStartDay!=null)return"marcador";const C=(p?.reason??"").toUpperCase(),Y=C.includes("S")||C.includes("BIP");return!C&&!E?null:Y?"cambio en la sensación":"presencia de moco"};let U="",D="",I=null;if(r==="relativeInfertile"){U="Relativamente infértil";const p=Number.isInteger(c),E=A==="estandar"&&Array.isArray(n)&&n.length>0,C=P(),Y=_e(c);p?(D=`Fin de fase por ${C??"—"}.`,I=Y!=="—"?`Inicio fértil: ${Y}.`:null):A==="conservador"?D="A la espera de cálculo (CPM/T-8) o signos de moco/sensación.":E?D="Referencia alcanzada (CPM/T-8). A la espera de signos de moco/sensación.":D="A la espera de signos de moco/sensación."}else if(r==="fertile"){U="Fase fértil";const p=P()??"—",C=_e(c)??"—",Y=Number.isFinite(d?.endIndex),K=Number.isInteger(d?.mucusInfertileStartIndex),de=Number.isInteger(d?.temperatureInfertileStartIndex);D=`Iniciada el ${C} por ${p}.`,Y?K&&de?I="Finalizada por doble criterio.":K?I="Finalizada por día pico.":de&&(I="Finalizada por temperatura."):I="A la espera de cierre por día pico y/o confirmación de temperatura."}else if(r==="postOvulatory"){const p=(t?.displayLabel??t?.label??"").toLowerCase(),E=t?.status??a?.status??null,C=_e(Number.isInteger(a?.temperature?.confirmationIndex)?a.temperature.confirmationIndex:Number.isInteger(a?.temperature?.startIndex)?a.temperature.startIndex:d?.temperatureInfertileStartIndex),Y=_e(a?.mucus?.peakDayIndex),K=_e(Number.isInteger(a?.mucus?.infertileStartIndex)?a.mucus.infertileStartIndex:t?.startIndex),de=_e(t?.startIndex);if(E==="absolute"||t?.displayLabel==="Infertilidad absoluta")U="Infertilidad postovulatoria confirmada",D=`Comienza el ${de}.`,I=`Confirmada por temperatura (${C}) y 3.º/4.º día postpico (${K}).`;else if(p.includes("moco")){U="Infertilidad post-pico";const Re=Number.isInteger(a?.mucus?.infertileStartIndex)?a.mucus.infertileStartIndex:Number.isInteger(t?.startIndex)?t.startIndex:null,ke=Number.isInteger(a?.mucus?.peakDayIndex)?a.mucus.peakDayIndex:null;let Z="día postpico";if(Number.isInteger(Re)&&Number.isInteger(ke)){const We=Re-ke;We===3?Z="3.º día postpico":We===4&&(Z="4.º día postpico")}D=`Alcanzada el ${de} por ${Z}. Día pico: ${Y}.`,I="A la espera de confirmación por temperatura."}else p.includes("temperatura")?(U="Infertilidad postovulatoria por temperatura",D=`Temperatura confirmada el ${C}.`,I="A la espera de determinación del día pico."):(U="Fase postovulatoria",D="Interpretación postovulatoria disponible.",I=E==="pending"?"Pendiente completar el segundo criterio.":null)}else if(r==="nodata")(a?.status??t?.status??null)==="no-fertile-window"?(U="Sin ventana fértil identificable",D="No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."):(U="Sin datos suficientes",D="Añade registros de sensación, moco o temperatura para interpretar el ciclo.");else if(t?.message)U=t.message;else return;U&&Ze({title:U,message:D,description:I,modeLabel:k})},[pe,_e,Ee.length,Ze]),Pe=()=>{if(!he){Ge(!0),jt(!0);return}jt(!1);const t=typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait";m(t),Ge(!1)};return e.jsx(Pt,{hideBottomNav:he,children:e.jsxs("div",{className:he?"fixed inset-0 z-50 h-app w-[100vw] overflow-y-auto overflow-x-hidden":"relative w-full h-full overflow-y-auto overflow-x-hidden",style:St,children:[O&&!he&&e.jsx(wt,{asChild:!0,variant:"ghost",className:"absolute top-4 left-4 z-10 bg-white/20 text-slate-700 hover:brightness-95",children:e.jsxs(Gt,{to:`/cycle/${u.id}`,className:"flex items-center gap-1",children:[e.jsx(Hn,{className:"h-4 w-4"}),T&&e.jsx("span",{className:"ml-1 text-xs font-semibold text-slate-700 sm:text-sm",children:T})]})}),e.jsx(wt,{onClick:()=>nt(t=>!t),variant:"ghost",size:"icon",className:"absolute top-16 right-4 z-10 p-2 rounded-full bg-white/20 shadow-lg shadow-secundario text-secundario border hover:brightness-95","aria-label":"Ajustes",children:e.jsx(qn,{className:"h-4 w-4"})}),e.jsx(wt,{onClick:Nt,onPointerUp:He,variant:"ghost",size:"icon",className:`absolute top-4 right-20 z-10 p-2 rounded-full transition-colors ${v?"bg-fertiliapp-fuerte text-white shadow-lg shadow-fertiliapp-fuerte/50 border-fertiliapp-fuerte/70":"bg-white/20 text-fertiliapp-fuerte border border-fertiliapp-fuerte hover:brightness-95 shadow-md"}`,children:v?e.jsx(Un,{className:"h-4 w-4"}):e.jsx(Yn,{className:"h-4 w-4"})}),e.jsx(wt,{onClick:Pe,className:"absolute top-4 right-4 z-10 bg-white/20 rounded-full text-slate-600 hover:bg-pink-50/80 shadow-md border border-slate-400/50 backdrop-blur-sm","aria-label":he?"Salir de pantalla completa":"Rotar gráfico",children:e.jsx(Vn,{className:"w-4 h-4"})}),e.jsx(ms,{data:Ee,isFullScreen:he,orientation:je,onToggleIgnore:l,onEdit:N,onTogglePeak:yt,cycleId:u.id,initialScrollIndex:xt,visibleDays:Ne,showInterpretation:v,reduceMotion:!0,forceLandscape:H||je==="landscape",currentPeakIsoDate:st,showRelationsRow:$e.showRelationsRow,fertilityStartConfig:Ct,fertilityCalculatorCycles:ye,fertilityCalculatorCandidates:Mt,onShowPhaseInfo:Me,isArchivedCycle:!R,cycleEndDate:u?.endDate??null}),Ke&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/30",onClick:()=>nt(!1),"aria-hidden":"true"}),e.jsx("div",{className:`fixed top-0 right-0 z-50 h-app w-72 sm:w-80 transform transition-transform duration-300 ease-in-out ${Ke?"translate-x-0":"translate-x-full"}`,role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col gap-6 border-xl rounded-xl border-rose-100/60 bg-white p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-titulo",children:"Ajustes del gráfico"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Personaliza la visualización del gráfico"})]}),e.jsx(wt,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-slate-600",onClick:()=>nt(!1),"aria-label":"Cerrar ajustes del gráfico",children:"×"})]}),e.jsxs("div",{className:"space-y-4 overflow-y-auto pr-1",children:[e.jsxs("div",{className:"rounded-2xl border border-rose-100/70 bg-rose-50/40 p-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"max-w-xs",children:[e.jsx(zn,{htmlFor:"toggle-relations-row",className:"text-sm font-semibold text-slate-700",children:"Mostrar fila RS"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Añade una fila dedicada a las relaciones sexuales debajo de la gráfica."})]}),e.jsx(zt,{id:"toggle-relations-row",checked:$e.showRelationsRow,onCheckedChange:y,className:"mt-1"})]}),e.jsxs("div",{className:"rounded-2xl border border-amber-100/70 bg-amber-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Calculadoras complementarias"}),e.jsx("p",{className:"text-xs text-slate-500",children:"CPM y T-8 se combinan con los perfiles activos, salvo que actives el modo posparto."})]}),pe.postpartum&&e.jsx("p",{className:"text-xs font-medium text-rose-500",children:"El modo posparto está activo: CPM y T-8 se omiten del cálculo final."}),e.jsx("div",{className:"space-y-2",children:bs.map(t=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-sm text-slate-700",children:t.label}),e.jsx(zt,{checked:!!pe.calculators?.[t.key],onCheckedChange:r=>xe(t.key,r)})]},t.key))})]}),e.jsxs("div",{className:"rounded-2xl border border-sky-100/70 bg-sky-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Modo de combinación"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Determina cómo se elige el inicio fértil a partir de los candidatos disponibles."})]}),e.jsxs(Bn,{value:pe.combineMode,onValueChange:X,children:[e.jsx(Fn,{className:"w-full bg-white/80 border-slate-200 text-sm rounded-3xl text-slate-700",children:e.jsx(_n,{placeholder:"Selecciona un modo"})}),e.jsx(Wn,{className:"bg-white border-slate-200 text-slate-700 rounded-3xl",children:Object.entries(Tt).map(([t,r])=>e.jsx(Gn,{value:t,className:"text-sm rounded-3xl",children:r},t))})]}),e.jsxs("div",{className:"flex items-start justify-between gap-3 pt-1",children:[e.jsxs("div",{className:"max-w-[65%]",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-700",children:"Modo posparto"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Ignora automáticamente CPM y T-8."})]}),e.jsx(zt,{checked:!!pe.postpartum,onCheckedChange:re,className:"mt-1"})]})]})]})]})}),e.jsx(gs,{isOpen:!!be,onClose:vt,ariaLabel:"Detalle de interpretación del ciclo",containerClassName:"p-6",children:be&&e.jsxs("div",{className:"space-y-3 text-left",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-fertiliapp-fuerte",children:be.title}),be.modeLabel&&e.jsx("span",{className:"rounded-full border border-secundario bg-secundario-suave px-3 py-1 text-[11px] font-semibold text-secundario-fuerte",children:be.modeLabel})]}),e.jsx("button",{type:"button",onClick:vt,className:"rounded-full p-1 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-200","aria-label":"Cerrar detalle de interpretación",children:e.jsx(Sn,{className:"h-5 w-5"})})]}),be.message&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-700",children:be.message}),be.description&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-500",children:be.description})]})}),e.jsx(Tn,{open:At,onOpenChange:ce,children:e.jsx($n,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",onInteractOutside:t=>{Date.now()<Ye.current&&t.preventDefault()},onPointerDownOutside:t=>{Date.now()<Ye.current&&t.preventDefault()},children:e.jsx(Rn,{onSubmit:ot,onCancel:Se,initialData:qe,cycleStartDate:u.startDate,cycleEndDate:u.endDate,isProcessing:ge,isEditing:!!qe&&!me,cycleData:u.data,onDateSelect:it,initialSectionKey:It})})})]})})};export{Ls as default};
