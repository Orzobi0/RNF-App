import{h as B,a as F,u as J,b as V,r as o,f as S,p as m,j as t,B as g,L as R,g as H,s as $,d as W}from"./index-9c052d95.js";import{D as G}from"./DeletionDialog-4d81e29b.js";import{u as K}from"./useCycleData-5c7fca7c.js";import{RecordsExperience as Q}from"./RecordsPage-c24ba616.js";import{A as X}from"./arrow-left-e3d1f6f1.js";import{P as Y}from"./pencil-d686d72a.js";import{P as Z}from"./badge-4d2a43e0.js";import"./CycleDatesEditor-13f0a133.js";import"./OverlapWarningDialog-691979ea.js";import"./computePeakStatuses-53226450.js";import"./input-38433acf.js";import"./label-79a0a783.js";import"./checkbox-33f1ec29.js";import"./eye-2851a226.js";const ee=(r,d)=>{const a=$(m(r)),l=$(m(d));return W(a,l)+1},se=(r,d)=>!r||!Array.isArray(r)||!d?[]:[...r].sort((l,h)=>m(l.isoDate)-m(h.isoDate)).map(l=>({...l,ignored:l.ignored||!1,cycleDay:ee(l.isoDate,d)})),ge=()=>{const{cycleId:r}=B(),d=F(),{user:a}=J(),{getCycleById:l,isLoading:h,addOrUpdateDataPoint:x,deleteRecord:b,updateCycleDates:k,deleteCycle:v,checkCycleOverlap:A,forceUpdateCycleStart:D,refreshData:j}=K(),{toast:u}=V(),[e,N]=o.useState(null),[L,y]=o.useState(!1),[w,E]=o.useState(!1),f=e?`${S(m(e.startDate),"dd/MM/yyyy")} - ${e.endDate?S(m(e.endDate),"dd/MM/yyyy"):"En curso"}`:"",C=o.useCallback(s=>{if(!a||!(s!=null&&s.id))return;const i={...s,data:(s.data||[]).map(({cycleDay:n,...c})=>c)};localStorage.setItem(`fertilityData_cycle_${a.uid}_${s.id}`,JSON.stringify(i))},[a]),p=o.useCallback(async()=>{if(!a||!r)return null;const s=await l(r);return s&&(C(s),N(s)),s},[r,l,C,a]);o.useEffect(()=>{(async()=>{if(!a)return;let i=await l(r);if(!i){const n=localStorage.getItem(`fertilityData_cycle_${a.uid}_${r}`);if(n){const c=JSON.parse(n);i={...c,data:se(c.data||[],c.startDate)}}}i?(C(i),N(i)):(u({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),d("/archived-cycles"))})()},[r,a,l,u,d]);const O=o.useCallback(async(s,i)=>{if(!(e!=null&&e.id)||!a)return;const n=!!i;await x(s,i,e.id),await p()&&u({title:n?"Registro actualizado":"Nuevo registro añadido",description:"Datos del ciclo actualizados."})},[e==null?void 0:e.id,a,x,p,u]),P=o.useCallback(async s=>{!(e!=null&&e.id)||!a||(await b(s,e.id),await p(),u({title:"Registro eliminado",description:"El registro ha sido eliminado."}))},[e==null?void 0:e.id,a,b,p,u]),U=o.useCallback(async(s,i,n)=>{const c=s??(e==null?void 0:e.id);!a||!c||await k(c,i,n)},[e==null?void 0:e.id,a,k]),I=o.useCallback(async(s,i)=>{const n=s??(e==null?void 0:e.id);!a||!n||await D(n,i)},[e==null?void 0:e.id,a,D]),q=o.useCallback(async s=>{await j(s),await p()},[j,p]),z=()=>{y(!0)},M=o.useCallback(async()=>{if(!(!(e!=null&&e.id)||!a)){E(!0);try{await v(e.id),u({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),d("/archived-cycles")}catch(s){console.error(s),u({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{E(!1),y(!1)}}},[e==null?void 0:e.id,v,d,u,a]),T=o.useCallback(()=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(g,{asChild:!0,variant:"outline",size:"icon",className:"shrink-0 rounded-full border-pink-300 text-pink-600 hover:bg-pink-50 hover:border-pink-400",children:t.jsxs(R,{to:"/archived-cycles","aria-label":"Volver a mis ciclos",children:[t.jsx(X,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:"Mis ciclos"})]})}),t.jsx("div",{className:"items-center justify-center px-4 py-3",children:t.jsxs("h2",{className:"text-2xl font-semibold text-rose-700 truncate",children:[e!=null&&e.name?`${e.name} · `:"",f]})})]}),[e==null?void 0:e.name,f]),_=o.useCallback(({openDateEditor:s,openAddRecord:i,isProcessing:n,isUpdatingDates:c})=>t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(g,{asChild:!0,variant:"outline",size:"icon",className:"border-pink-300 text-pink-600 rounded-full hover:bg-pink-50 hover:border-pink-400",children:t.jsx(R,{to:`/chart/${r}`,"aria-label":"Ver gráfica del ciclo",children:t.jsx(H,{className:"h-4 w-4"})})}),t.jsx(g,{type:"button",variant:"outline",size:"icon",onClick:s,"aria-pressed":c,className:"border-pink-300 text-pink-600 rounded-full hover:bg-pink-50 hover:border-pink-400",disabled:c,"aria-label":"Editar fechas del ciclo",children:t.jsx(Y,{className:"h-4 w-4"})}),t.jsx(g,{type:"button",size:"icon",onClick:i,className:"rounded-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow",disabled:n,"aria-label":"Añadir registro al ciclo",children:t.jsx(Z,{className:"h-4 w-4"})})]}),[r]);return h&&!e||!e?t.jsx("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-pink-600",children:t.jsx("p",{children:"Cargando detalles del ciclo..."})}):t.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),t.jsx(Q,{cycle:e,isLoading:h,addOrUpdateDataPoint:O,deleteRecord:P,updateCycleDates:U,checkCycleOverlap:A,forceUpdateCycleStart:I,refreshData:q,includeEndDate:!0,headerActions:_,topAccessory:T,headerTitle:"Mis registros",onRequestDeleteCycle:z,isDeletingCycle:w,dateEditorDeleteDescription:f?`Se eliminará el ciclo ${f} y todos sus registros asociados.`:"Se eliminará este ciclo y todos sus registros asociados."}),t.jsx(G,{isOpen:L,onClose:()=>y(!1),onConfirm:M,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:f?`¿Estás seguro de que quieres eliminar el ciclo ${f}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:w})]})};export{ge as default};
