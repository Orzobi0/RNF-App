import{c as ce,o as n,j as e,B as d,k as f,C as Q,f as y,g as H,r as E}from"./index-ByFXgX-t.js";import{b as X,c as _,d as U,e as ee,i as we,u as de}from"./useBackClose-BFeNma-P.js";import{O as ue}from"./DeletionDialog-Da12udM-.js";import{l as O,i as G}from"./badge-CetW1kHg.js";import{T as De}from"./DataEntryForm-B10-vrnA.js";import{i as ne,D as fe,a as me,b as he,c as xe,d as ye,e as pe}from"./useCycleData-BwqH7MfP.js";const Re=ce("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]),Pe=ce("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),oe=s=>{if(!s)return"";const i=new Date(s);if(Number.isNaN(i.getTime()))return s;const m=String(i.getDate()).padStart(2,"0"),h=String(i.getMonth()+1).padStart(2,"0"),u=String(i.getFullYear());return`${m}/${h}/${u}`},Fe=({cycle:s,startDate:i,endDate:m,onStartDateChange:h,onEndDateChange:u,onSave:j,onCancel:A,isProcessing:r=!1,dateError:k="",includeEndDate:R=!0,showOverlapDialog:p=!1,overlapCycle:$=null,overlapImpactPreview:o=null,onConfirmOverlap:x,onCancelOverlap:v,title:c="Editar fechas del ciclo",description:I="Actualiza las fechas de inicio y fin del ciclo. Guarda los cambios cuando termines.",saveLabel:V="Guardar",cancelLabel:Y="Cancelar",onClearError:C,className:Z="mb-6 mx-auto w-full max-w-xl",onDeleteCycle:N,deleteTitle:J="Eliminar ciclo",deleteDescription:L="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",deleteLabel:l="Eliminar ciclo",isDeletingCycle:g=!1,onUndoCycle:P,isUndoingCycle:F=!1,otherCycles:ge=[]})=>{const te=s?.startDate?oe(s.startDate):null,be=s?.endDate?oe(s.endDate):"En curso",ae=te?`Fecha actual: ${te}${R?` — ${be}`:""}`:null,b=t=>{if(!t)return null;const a=y(t);return H(a)?n(a):null},B=b(i),T=b(m),w=b(s?.startDate),se=b(s?.endDate),le=n(new Date),re=(t,a)=>a||(t?ne(t,le)?t:le:null),ie=(s?.data??[]).map(t=>b(t?.isoDate)).filter(Boolean),D=ge.filter(t=>t?.id&&s?.id&&t.id!==s.id).map(t=>{const a=b(t?.startDate),K=b(t?.endDate);return a?{from:a,to:re(a,K)??a}:null}).filter(Boolean),S=w?{from:w,to:re(w,se)??w}:void 0,q=(t,a)=>!!(a?.from&&G(t,a.from)),W=(t,a)=>a?.to?G(t,a.to)&&!G(a.from,a.to):!1,z=(t,a)=>!a?.from||!a?.to||G(a.from,a.to)?!1:ne(t,a.from)&&we(t,a.to),M=(t,a,K)=>a.some(Ne=>K(t,Ne)),je=t=>{C&&C(),h?.(t.target.value)},ve=t=>{C&&C(),u?.(t.target.value)},Ce=t=>{t.preventDefault(),j?.()};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`${Z} rounded-3xl border border-rose-100 bg-white/90 p-5 shadow-md`,children:e.jsx("form",{onSubmit:Ce,className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-titulo mb-1",children:c}),e.jsx("p",{className:"text-sm text-slate-600",children:I}),ae&&e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:ae}),e.jsxs("div",{className:`grid ${R?"grid-cols-2 gap-4":"grid-cols-1 gap-4"}`,children:[e.jsxs("label",{className:"flex h-full flex-col text-sm text-slate-700",children:["Inicio del ciclo",e.jsxs(X,{children:[e.jsx(_,{asChild:!0,children:e.jsxs(d,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-fertiliapp-suave bg-white text-left font-normal text-slate-800",children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),B?f(B,"PPP",{locale:O}):"Selecciona una fecha"]})}),e.jsx(U,{className:"w-auto p-0",align:"start",children:e.jsx(ee,{mode:"single",selected:B,onSelect:t=>{t&&je({target:{value:f(n(t),"yyyy-MM-dd")}})},locale:O,initialFocus:!0,defaultMonth:B??w??new Date,enableSwipeNavigation:!0,modifiers:{hasRecord:ie,inActiveCycleStart:t=>q(t,S),inActiveCycleMiddle:t=>z(t,S),inActiveCycleEnd:t=>W(t,S),inOtherCycleStart:t=>M(t,D,q),inOtherCycleMiddle:t=>M(t,D,z),inOtherCycleEnd:t=>M(t,D,W)},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycleStart:"in-cycle-range-start",inActiveCycleMiddle:"in-cycle-range-middle",inActiveCycleEnd:"in-cycle-range-end",inOtherCycleStart:"in-other-cycle-range-start",inOtherCycleMiddle:"in-other-cycle-range-middle",inOtherCycleEnd:"in-other-cycle-range-end"}})})]})]}),R&&e.jsxs("label",{className:"flex h-full flex-col text-sm text-slate-700",children:["Fin del ciclo",e.jsxs(X,{children:[e.jsx(_,{asChild:!0,children:e.jsxs(d,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-fertiliapp-suave bg-white text-left font-normal text-slate-800",children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),T?f(T,"PPP",{locale:O}):"Selecciona una fecha"]})}),e.jsx(U,{className:"w-auto p-0",align:"start",children:e.jsx(ee,{mode:"single",selected:T,onSelect:t=>{t&&ve({target:{value:f(n(t),"yyyy-MM-dd")}})},locale:O,initialFocus:!0,defaultMonth:T??se??w??new Date,enableSwipeNavigation:!0,modifiers:{hasRecord:ie,inActiveCycleStart:t=>q(t,S),inActiveCycleMiddle:t=>z(t,S),inActiveCycleEnd:t=>W(t,S),inOtherCycleStart:t=>M(t,D,q),inOtherCycleMiddle:t=>M(t,D,z),inOtherCycleEnd:t=>M(t,D,W)},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycleStart:"in-cycle-range-start",inActiveCycleMiddle:"in-cycle-range-middle",inActiveCycleEnd:"in-cycle-range-end",inOtherCycleStart:"in-other-cycle-range-start",inOtherCycleMiddle:"in-other-cycle-range-middle",inOtherCycleEnd:"in-other-cycle-range-end"}})})]})]})]}),k&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:k}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-3 justify-center",children:[e.jsx(d,{type:"button",variant:"outline",onClick:A,className:"border-slate-200 text-titulo hover:brightness-95",disabled:r||F,children:Y}),e.jsx(d,{type:"submit",className:"bg-fertiliapp-fuerte text-white shadow hover:brightness-95",disabled:r||F,children:V})]}),P&&e.jsxs("div",{className:"mt-4 rounded-3xl bg-slate-200 border-slate-200 p-4 text-left",children:[e.jsx("h3",{className:"font-semibold text-slate-800 mb-2",children:"Deshacer ciclo"}),e.jsx("p",{className:"text-sm text-slate-700 mb-3",children:"Une el ciclo actual con el anterior y mueve todos los registros."}),e.jsx(d,{type:"button",onClick:P,disabled:r||F,className:"w-full sm:w-auto bg-slate-400  font-semibold hover:brightness-95 text-white shadow-md",children:F?"Deshaciendo…":"Deshacer ciclo"})]}),N&&e.jsxs("div",{className:"mt-6 rounded-3xl bg-slate-200 p-4 text-left",children:[e.jsx("h3",{className:"font-semibold text-slate-800 mb-2",children:J}),L&&e.jsx("p",{className:"text-sm text-slate-600 mb-3",children:L}),e.jsxs(d,{type:"button",onClick:N,disabled:r||g||F,className:"w-full sm:w-auto bg-slate-500 hover:brightness-95 text-white shadow-md",children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),l]})]})]})})}),e.jsx(ue,{isOpen:p,conflictCycle:$,title:o?"Este cambio ajustará otros ciclos":void 0,description:o?"Revisa el impacto antes de confirmar.":void 0,confirmLabel:o?"Aplicar cambios":void 0,affectedCycles:o?.affectedCycles||[],impactSummary:o?.impactSummary,adjustedCyclesPreview:o?.adjustedCyclesPreview||[],onCancel:v,onConfirm:x})]})},$e=({isOpen:s,onClose:i,onConfirm:m,onPreview:h,currentCycleStartDate:u,currentCycleRecords:j=[],initialStartDate:A})=>{const[r,k]=E.useState(A||f(new Date,"yyyy-MM-dd")),[R,p]=E.useState(!1),[$,o]=E.useState(null),[x,v]=E.useState(null);de(s,i),E.useEffect(()=>{s&&(k(A||f(new Date,"yyyy-MM-dd")),p(!1),o(null),v(null))},[A,s]);const c=!u,I=E.useMemo(()=>{if(c||!r||!j.length)return!1;const l=n(y(r));return H(l)?j.some(g=>{if(!g?.isoDate)return!1;const P=n(y(g.isoDate));return H(P)?P.getTime()>=l.getTime():!1}):!1},[j,c,r]),V=async()=>{if(h){const l=await h(r);if(l){v(l),o(r),p(!0);return}}if(!c&&I){o(r),p(!0);return}m(r)},Y=()=>{$&&(p(!1),m($),o(null),v(null))},C=c?"":f(y(u),"dd/MM/yyyy"),Z=(()=>{if(c)return"";const l=new Date(r);return l.setDate(l.getDate()-1),f(l,"dd/MM/yyyy")})(),N=r?n(y(r)):null,J=j.map(l=>{if(!l?.isoDate)return null;const g=n(y(l.isoDate));return H(g)?g:null}).filter(Boolean),L=u?{from:n(y(u)),to:n(new Date)}:void 0;return e.jsxs(e.Fragment,{children:[e.jsx(fe,{open:s,onOpenChange:i,children:e.jsxs(me,{className:"bg-white border-pink-100 text-gray-800 rounded-3xl",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Iniciar nuevo ciclo"}),e.jsx(ye,{className:"text-gray-600",children:c?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${C} - ${Z}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsxs(X,{children:[e.jsx(_,{asChild:!0,children:e.jsxs(d,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-gray-200 bg-gray-50 text-left font-normal text-gray-800",children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),N?f(N,"PPP",{locale:O}):"Selecciona una fecha"]})}),e.jsx(U,{className:"w-auto p-0",align:"start",children:e.jsx(ee,{mode:"single",selected:N,onSelect:l=>{l&&k(f(n(l),"yyyy-MM-dd"))},locale:O,initialFocus:!0,disabled:[{after:n(new Date)},...c?[]:[{before:n(y(u))}]],modifiers:{hasRecord:J,inActiveCycle:L},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycle:"in-cycle-soft-outline"}})})]})]}),e.jsxs(pe,{className:"sm:justify-end",children:[e.jsx(d,{variant:"outline",onClick:i,className:"border-gray-300 text-subtitulo hover:brightness-95",children:"Cancelar"}),e.jsx(d,{variant:"primary",onClick:V,className:"bg-fertiliapp-fuerte hover:brightness-95 text-white",children:c?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})}),e.jsx(ue,{isOpen:R,onCancel:()=>{p(!1),o(null),v(null)},onConfirm:Y,conflictCycle:c?null:{startDate:u,endDate:null},message:"Este nuevo ciclo actual coincide en fechas con el ciclo anterior. Los registros se pasarán al nuevo ciclo si continúas. ¿Deseas continuar?",title:x?"Este cambio ajustará otros ciclos":void 0,description:x?"Se aplicarán ajustes en ciclos y/o registros antes de guardar.":void 0,confirmLabel:x?"Aplicar cambios":void 0,affectedCycles:x?.affectedCycles||[],impactSummary:x?.impactSummary,adjustedCyclesPreview:x?.adjustedCyclesPreview||[]})]})},Le=({isOpen:s,onClose:i,onConfirm:m})=>(de(s,i),e.jsx(fe,{open:s,onOpenChange:h=>{h||i()},children:e.jsxs(me,{className:"bg-white/95 backdrop-blur border border-fertiliapp-fuerte text-slate-700",children:[e.jsxs(he,{children:[e.jsx(xe,{className:"text-lg font-semibold text-fertiliapp-fuerte",children:"Modo postparto activado"}),e.jsx(ye,{className:"text-slate-600",children:"Se ha añadido un nuevo ciclo. ¿Deseas desactivar el modo postparto?"})]}),e.jsxs(pe,{className:"sm:justify-end gap-2",children:[e.jsx(d,{type:"button",variant:"outline",onClick:i,className:"border-pink-200 text-fertiliapp-fuerte hover:bg-pink-50 hover:text-fertiliapp-fuerte",children:"No"}),e.jsx(d,{type:"button",onClick:m,className:"bg-fertiliapp-fuerte hover:brightness-95 text-white shadow-lg",children:"Sí"})]})]})}));export{Fe as C,Re as L,$e as N,Le as P,Pe as a};
