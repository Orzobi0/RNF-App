import{c as on,m as ze,j as e,R as bn,r as c,l as dt,f as ct,K as ln,n as wn,g as Lt,k as $t,M as In,q as jn,N as Cn,u as Sn,O as Tt,B as St,L as zt,X as kn}from"./index-DKDve1bt.js";import{a as vn,g as Mn,i as Nn,C as Ht}from"./computePeakStatuses-DDireWCn.js";import{i as Rn,D as Ln}from"./DataEntryForm-BA2ItfuX.js";import{u as Dn,C as An,a as En,b as On,c as Pn}from"./useFertilityChart-CT4cpUOn.js";import{u as Tn,D as $n,a as Bn}from"./useCycleData-B59yyua_.js";import{L as Fn}from"./label-CjCq2AfR.js";import{A as _n}from"./arrow-left-B-zvaJsb.js";import{E as Wn,a as Gn}from"./eye-B04h8Q7I.js";import"./input-3y406qNm.js";import"./badge-Bv0PJFOO.js";const zn=on("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),Hn=on("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),Un=({padding:s,chartWidth:i,chartHeight:m,tempMin:h,tempMax:O,tempRange:x,getY:H,getX:G,allDataPoints:S=[],visibleRange:w=null,responsiveFontSize:F,isFullScreen:Q,showLeftLabels:q=!1,reduceMotion:z=!1,isScrolling:N=!1,graphBottomY:Z,chartAreaHeight:u,rowsZoneHeight:_})=>{const L={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.3,ease:"easeOut"}}},ee=[];if(x>0){const $=x<=2.5?.1:.5;for(let xe=h;xe<=O+1e-9;xe+=$)ee.push(parseFloat(xe.toFixed(1)))}else for(let $=35.8;$<=37.2+1e-9;$+=.1)ee.push(parseFloat($.toFixed(1)));const y=S.length,D=y>60||N,ce=z||D?"g":ze.g,te=Number.isInteger(w?.startIndex)?w.startIndex:0,oe=Number.isInteger(w?.endIndex)?w.endIndex:Math.max(y-1,0),f=y?Math.max(0,Math.min(y-1,te)):0,de=y?Math.max(f,Math.min(y-1,oe)):-1;return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"bgGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fffbfc"}),e.jsx("stop",{offset:"50%",stopColor:"#fff5f7"}),e.jsx("stop",{offset:"100%",stopColor:"#fff1f3"})]}),e.jsxs("linearGradient",{id:"dataZoneGradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fff7fb"}),e.jsx("stop",{offset:"50%",stopColor:"#ffe4f0"}),e.jsx("stop",{offset:"100%",stopColor:"#fff7fb"})]}),e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsxs("filter",{id:"softShadow",children:[e.jsx("feGaussianBlur",{in:"SourceAlpha",stdDeviation:"2"}),e.jsx("feOffset",{dx:"0",dy:"1",result:"offsetblur"}),e.jsx("feComponentTransfer",{children:e.jsx("feFuncA",{type:"linear",slope:"0.2"})}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"pointGlow",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsx("filter",{id:"textShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.8)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]})]}),e.jsx("rect",{x:s.left,y:s.top,width:i-s.left-s.right,height:u,fill:"url(#bgGradientChart)",opacity:2,rx:12,style:{filter:"drop-shadow(0 4px 12px rgba(244, 114, 182, 0.1))"}}),e.jsx("rect",{x:s.left,y:s.top,width:i-s.left-s.right,height:u,fill:"white",stroke:"url(#tempLineGradientChart)",strokeWidth:"1",strokeOpacity:"0.2",rx:"12",style:{filter:"url(#softShadow)"}}),e.jsx("rect",{x:s.left,y:Z,width:i-s.left-s.right,height:_,fill:"url(#dataZoneGradient)",rx:"8",style:{filter:"drop-shadow(0 -1px 2px rgba(244, 114, 182, 0.05))"}}),ee.map(($,xe)=>{const we=H($),p=$.toFixed(1).endsWith(".0")||$.toFixed(1).endsWith(".5"),ue=p?$.toFixed(1):`.${$.toFixed(1).split(".")[1]}`;return e.jsxs(ce,{...z||D?{}:{variants:L},children:[e.jsx("line",{x1:s.left,y1:we,x2:i-s.right,y2:we,stroke:p?"#f9a8d4":"#fce7f3",strokeWidth:p?1.5:1,opacity:p?.5:.3,strokeDasharray:p?"0":"4,4",style:{filter:p&&!D?"drop-shadow(0 1px 3px rgba(244, 114, 182, 0.15))":"none",opacity:p?1:.7}}),q&&e.jsx("text",{x:s.left-F(1),y:we+F(.35),textAnchor:"end",fontSize:F(p?1.1:1),fontWeight:p?"700":"600",fill:p?"#be185d":"#db2777",opacity:p?.9:.7,style:{filter:D?"none":"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:ue}),e.jsx("text",{x:i-s.right+F(1),y:we+F(.35),textAnchor:"start",fontSize:F(p?1.1:1),fontWeight:p?"700":"600",fill:p?"#be185d":"#db2777",opacity:p?.9:.7,style:{filter:D?"none":"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:ue})]},`temp-tick-${xe}`)}),y>0&&Array.from({length:de-f+1},($,xe)=>{const we=f+xe,p=G(we);return e.jsx("line",{x1:p,y1:s.top,x2:p,y2:Z,stroke:"#fce7f3",strokeWidth:"1",opacity:"0.6",style:{filter:D?"none":"drop-shadow(0 0 1px rgba(244, 114, 182, 0.05))"}},`day-grid-${we}`)}),e.jsx("rect",{x:s.left,y:s.top,width:i-s.left-s.right,height:u,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"2",strokeOpacity:"0.4",rx:"12"}),e.jsx("rect",{x:s.left+1,y:s.top+1,width:i-s.left-s.right-2,height:u-2,fill:"none",stroke:"white",strokeWidth:"0.5",rx:"11",opacity:"0.9"}),q&&e.jsx(ce,{...z||D?{}:{variants:L},children:e.jsx("text",{x:s.left+F(1.2),y:s.top+F(1.5),textAnchor:"middle",fontSize:F(1.4),fontWeight:"800",fill:"#be185d",style:{filter:D?"none":"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:"°C"})})]})},Yn=({data:s,allDataPoints:i,getX:m,getY:h,baselineY:O,temperatureField:x="temperature",reduceMotion:H=!1})=>{if(!s||s.length<2)return null;let G="",S=null;const w=[];if(i.forEach((q,z)=>{const N=s.find(Z=>Z.id===q.id);if(N&&N[x]!==null&&N[x]!==void 0&&!N.ignored){const Z=m(z),u=h(N[x]);w.push({x:Z,y:u}),S!==null&&z===S+1?G+=` L ${Z} ${u}`:G+=`${G?" ":""}M ${Z} ${u}`,S=z}}),w.length<2)return null;const F=G.includes("L"),Q=w.length>1?w.map(({x:q,y:z},N)=>`${N===0?"M":"L"} ${q} ${z}`).join(" "):"";return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsx("filter",{id:"lineShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"3",floodColor:"rgba(244, 114, 182, 0.4)"})})]}),F&&(H?e.jsx("path",{d:G,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"}}):e.jsx(ze.path,{d:G,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.4},transition:{duration:.8,ease:"easeInOut",delay:.2}})),Q&&(H?e.jsx("path",{d:Q,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65}):e.jsx(ze.path,{d:Q,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.65},transition:{duration:.8,ease:"easeInOut"}})),F&&(H?e.jsx("path",{d:G,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"}}):e.jsx(ze.path,{d:G,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1,ease:"easeInOut",delay:.4}}))]})},Qt="var(--color-sensacion-fuerte)",en="var(--color-apariencia-fuerte)",tn="var(--color-observaciones-fuerte)",Ut="#be123c",Vn="rgba(148, 163, 184, 0.35)",qn="rgba(226, 232, 240, 0.6)",Xn="rgba(148, 163, 184, 0.5)",nn="✖",Yt="#7f1d1d",Vt="#ec4899",Kn="drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))",Zn="#be185d",Jn="#2563eb",Qn="#be185d",es="rgba(244, 114, 182, 0.35)",ts=s=>{if(!s)return"";const[i,m]=s.split("/");return`${parseInt(i,10)}/${parseInt(m,10)}`},Xt='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',ns=()=>{if(typeof document>"u")return(m,h)=>{const O=/(\d+(?:\.\d+)?)px/.exec(h||""),x=O?Number(O[1]):12;return m.length*x*.6};const i=document.createElement("canvas").getContext("2d");return i?(m,h)=>(i.font=h,i.measureText(m).width):(m,h)=>{const O=/(\d+(?:\.\d+)?)px/.exec(h||""),x=O?Number(O[1]):12;return m.length*x*.6}},ss=(s,i,m)=>`${i} ${s}px ${m}`,sn=(s="",{maxWidth:i,maxLines:m=2,fontSize:h,fontWeight:O=700,fontFamily:x=Xt,fallback:H="–",measureTextWidth:G})=>{if(!s)return[H,...Array.from({length:Math.max(0,m-1)},()=>"")];const S=ss(h,O,x),w=u=>G(u,S),F=String(s).trim(),Q=/\s/.test(F),q=Q?F.split(/\s+/):Array.from(F),z=Q?" ":"",N=[],Z=u=>{const _=Array.from(u);let L="";for(;_.length;){const ee=L+_[0];if(w(ee)<=i||!L){if(L=ee,_.shift(),w(L)>i&&L.length>1){_.unshift(...Array.from(L.slice(1))),L=L[0];break}}else break}return[L,_.join("")]};for(;q.length&&N.length<m;){let u="";for(;q.length;){const _=q[0],L=u?`${u}${z}${_}`:_;if(w(L)<=i){u=L,q.shift();continue}if(!u)if(Q){const[ee,y]=Z(_);u=ee,y?q[0]=y:q.shift()}else{const[ee,y]=Z(_);u=ee,y?q[0]=y:q.shift()}break}N.push(u),!u&&q.length&&N.push(q.shift())}if(q.length&&N.length){const u=N.length-1;let _=N[u]||"";for(;_&&w(`${_}…`)>i;)_=_.slice(0,-1);N[u]=_?`${_}…`:"…"}for(;N.length<m;)N.push("");return N};function qt(s="",i,m="–"){return s?s.split(/\s+/).slice(0,i).join(" "):m}const as=({data:s,getX:i,getY:m,isFullScreen:h,orientation:O,responsiveFontSize:x,onPointInteraction:H,clearActivePoint:G,activePoint:S,visibleRange:w=null,padding:F,chartHeight:Q,chartWidth:q,temperatureField:z="temperature_chart",textRowHeight:N,compact:Z=!1,reduceMotion:u=!1,isScrolling:_=!1,showInterpretation:L=!1,ovulationDetails:ee=null,firstHighIndex:y=null,baselineIndices:ke=[],graphBottomLift:D=0,graphBottomY:ce,rowsZoneHeight:te,showRelationsRow:oe=!1})=>{const f={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},de={hidden:{opacity:0,scale:.3},visible:{opacity:1,scale:1,transition:{duration:.6,ease:[.34,1.56,.64,1],type:"spring",stiffness:120,damping:12}}},$=ce,xe=h?9:7.5,we=h?1:.75,p=oe?xe+(h?2:1.5):null,ue=xe+we,Fe=Math.max(1,Math.floor(te/ue)),U=Math.max(N,Fe),vt=$+U*1,Dt=$+U*2,Re=$+U*3,Ke=$+U*(h?5:4.5),Ze=$+U*(h?7:6),Mt=$+U*(h?9:7.5),ut=oe?Mt+U*(h?2:1.5):null,pe=Array.isArray(s)?s.length:0,R=pe>60||_,nt=u||R?"g":ze.g,Je=q-F.left-F.right,_e=U*(h?2:1.5),Ie=Math.min(Math.max(_e*.46,14),12),Qe=Number.isInteger(w?.startIndex)?w.startIndex:0,Pe=Number.isInteger(w?.endIndex)?w.endIndex:Math.max(pe-1,0),We=pe?Math.max(0,Math.min(pe-1,Qe)):0,se=pe?Math.max(We,Math.min(pe-1,Pe)):-1,Nt=c.useMemo(()=>dt(new Date),[]),Le=c.useMemo(()=>ns(),[]),He=c.useRef(new Map),De=pe>0?Je/pe:Je,ge=2,fe=Math.min(12,Math.max(4,De*.12)),ae=Math.max(0,De-fe*2),je=x(.95),Te=x(.9),$e=x(.9),ve=x(.9),st=x(.8),ft=x(.8),ht=x(.8),pt=c.useMemo(()=>{if(!L)return new Map;const k=Array.isArray(ee?.highSequenceIndices)?ee.highSequenceIndices:[],d=new Map;return k.forEach((g,he)=>{const X=Number(g);Number.isInteger(X)&&X>=0&&X<pe&&!d.has(X)&&d.set(X,he+1)}),d},[L,ee,pe]),at=c.useMemo(()=>{if(!L)return new Map;const k=Array.isArray(ke)?ke:[];if(!k.length)return new Map;const d=new Set,g=[],he=K=>{const Ne=Number(K);Number.isInteger(Ne)&&Ne>=0&&Ne<pe&&!d.has(Ne)&&(d.add(Ne),g.push(Ne))};if(k.forEach(K=>{he(K)}),y!=null){const K=Number(y);Number.isInteger(K)&&he(K-1)}if(!g.length)return new Map;const X=[...g].sort((K,Ne)=>K-Ne),ne=new Map;let ye=1;for(let K=X.length-1;K>=0&&!(ye>6);K-=1)ne.set(X[K],ye),ye+=1;return ne},[L,ke,pe,y]),Rt=R?"none":"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))",Ge=R?"none":"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))",Ue=R?"none":"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))",yt=R?"none":Kn,Me=R?"none":"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.25))",At=R?"none":"drop-shadow(0 1px 3px rgba(37, 99, 235, 0.45))",et=R?"none":"drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3))",rt=c.useCallback((k,d,g,he)=>{const X=sn(k,{maxWidth:ae,maxLines:3,fontSize:g,fontWeight:700,fontFamily:Xt,fallback:d,measureTextWidth:Le});return X[2]?{lines:sn(k,{maxWidth:ae,maxLines:3,fontSize:he,fontWeight:700,fontFamily:Xt,fallback:d,measureTextWidth:Le}),fontSize:he}:{lines:X,fontSize:g}},[ae,Le]);c.useEffect(()=>{He.current.clear()},[pe,ae,Te,$e,ve]);const Ye=c.useCallback((k,d,g,he,X)=>{const ne=He.current.get(k);if(ne)return ne;const ye=rt(d,g,he,X);return He.current.set(k,ye),ye},[rt]),bt=c.useMemo(()=>!pe||se<We?[]:Array.from({length:se-We+1},(k,d)=>We+d),[se,We,pe]);return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsx("filter",{id:"rowShadowChart",x:"-10%",y:"-10%",width:"120%",height:"120%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"4",floodColor:"rgba(244, 114, 182, 0.2)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#fb7185"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"pointGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("radialGradient",{id:"tempPointGradientChart",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FDF2F8"}),e.jsx("stop",{offset:"50%",stopColor:"#F9A8D4"}),e.jsx("stop",{offset:"85%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#DB2777"})]}),e.jsxs("radialGradient",{id:"tempPointIgnoredGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFFFFF"}),e.jsx("stop",{offset:"80%",stopColor:"#F8FAFC"}),e.jsx("stop",{offset:"100%",stopColor:"#E2E8F0"})]}),e.jsxs("radialGradient",{id:"ovulationPointGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#dbeafe"}),e.jsx("stop",{offset:"50%",stopColor:"#93c5fd"}),e.jsx("stop",{offset:"85%",stopColor:"#3b82f6"}),e.jsx("stop",{offset:"100%",stopColor:"#2563eb"})]})]}),h&&O!=="portrait"&&e.jsx(nt,{...u||R?{}:{variants:f},children:[{label:"Fecha",row:1,color:h?"#374151":"#6B7280"},{label:"Día",row:2,color:h?"#374151":"#6B7280"},{label:"Símbolo",row:3,color:h?"#374151":"#6B7280"},{label:"Sens.",row:h?5:4.5,color:Qt},{label:"Apar.",row:h?7:6,color:en},{label:"Observ.",row:h?9:7.5,color:tn},...oe&&p!=null?[{label:"RS",row:p,color:Ut}]:[]].map(({label:k,row:d,color:g})=>e.jsx("text",{x:F.left-x(.5),y:$+U*d,textAnchor:"end",fontSize:x(1.05),fontWeight:"700",fill:g,style:{filter:Rt,fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:k},k))}),bt.map(k=>{const d=s[k];if(!d)return null;const g=i(k),he=d[z]!=null?m(d[z]):$,X=d.temperature_raw,ne=d.temperature_corrected,ye=d.use_corrected&&X!=null&&ne!=null&&Math.abs(ne-X)>.01,K=ye?m(X):null,Ne="#60666f",Ce=d[z]!=null,Ve=d.use_corrected&&ne!=null&&d[z]===ne,A=d.ignored||d.use_corrected&&!Ve,ot=!!(d.had_relations??d.hadRelations);Ce||d.mucus_sensation||d.mucus_appearance||d.fertility_symbol;const wt=String(d.id||"").startsWith("placeholder-"),mt=ee?.peakDayIndex,Be=L&&mt!=null&&!A&&Ce&&k===mt,qe=vn(d.fertility_symbol),xt=Mn(qe.value),Et=qe.pattern==="spotting-pattern"?"url(#spotting-pattern-chart)":xt.main,It=xt.border==="none"?"none":xt.border||es,it=xt.border==="none"?0:qe.value==="white"?1.6:1,lt=d.isoDate?Nn(dt(ct(d.isoDate)),dt(new Date)):!1,ie=x(h?1.8:2),Xe=Re-ie*.75+ie/2+2,me=d.peakStatus?String(d.peakStatus).toUpperCase():null,Ae=me==="P"||me==="X",gt=me&&!Ae,t=Ae?nn:me||"–",o=Ae||["1","2","3"].includes(me),a=!wt&&qe.value!=="none",r=!!d.isoDate&&!lt?{pointerEvents:"all",style:{cursor:"pointer"},onClick:Ct=>H(d,k,Ct)}:{},j=(d.isoDate?Rn(ct(d.isoDate),Nt):!1)?Qn:Ne,E=pt.has(k),re=E?pt.get(k):null,P=at.has(k),B=P?at.get(k):null,V=x(h?.75:1.2),v=Math.max(.5,V*.18),I=he-V*(h?2.6:1.8),b=he+V*(h?1.9:1.6),C=h?qt(d.mucus_sensation,ge,lt?"":"–"):d.mucus_sensation,M=h?qt(d.mucus_appearance,ge,lt?"":"–"):d.mucus_appearance,T=h?qt(d.observations,ge,""):d.observations,W=`${d.isoDate||d.id||k}`,le=Ye(`${W}-sens-${ae}-${Te}-${st}-${C??""}`,C,lt?"":"–",Te,st),be=Ye(`${W}-apar-${ae}-${$e}-${ft}-${M??""}`,M,lt?"":"–",$e,ft),Se=Ye(`${W}-obs-${ae}-${ve}-${ht}-${T??""}`,T,"",ve,ht),[J,Ee,Oe]=le.lines,[Pt,tt,jt]=be.lines,[Zt,Bt,Ft]=Se.lines,cn=le.fontSize,dn=be.fontSize,un=Se.fontSize,_t=(Ct,Gt,yn)=>Math.max(1,[Ct,Gt,yn].filter(Jt=>Jt&&String(Jt).trim()!=="").length),fn=_t(J,Ee,Oe),hn=_t(Pt,tt,jt),pn=_t(Zt,Bt,Ft),Wt=(Ct,Gt)=>Ct-(Gt-1)*je/2,mn=Wt(Ke,fn),xn=Wt(Ze,hn),gn=Wt(Mt,pn);return e.jsxs(nt,{...u||R?{}:{variants:f},...r,children:[Ce&&e.jsxs(nt,{...u||R?{}:{variants:de},children:[ye&&K!==null&&e.jsxs("g",{pointerEvents:"none",children:[e.jsx("line",{x1:g,y1:K,x2:g,y2:he,stroke:Vn,strokeWidth:1,strokeDasharray:"4 4"}),e.jsx("circle",{cx:g,cy:K,r:3,fill:qn,stroke:Xn,strokeWidth:1}),e.jsx("circle",{cx:g,cy:K,r:1,fill:"rgba(255, 255, 255, 0.6)"})]}),e.jsx("circle",{cx:g,cy:he,r:Be?3.5:2.8,fill:A?"url(#tempPointIgnoredGradient)":Be?"url(#ovulationPointGradient)":"url(#tempPointGradientChart)",stroke:d.use_corrected&&Ve?"#941616":A?"#94A3B8":Be?"#1d4ed8":"#E91E63",sstrokeWidth:A?1.5:Be?2.2:2,style:{filter:Be?et:Me,cursor:"pointer"},pointerEvents:"all",onClick:Ct=>H(d,k,Ct)}),!A&&e.jsx("circle",{cx:g,cy:he,r:Be?1.2:.9,fill:Be?"rgba(239, 246, 255, 0.95)":"rgba(255, 255, 255, 0.9)",style:{filter:Be?At:Ge}}),L&&Ce&&!A&&E&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:g,y:I,textAnchor:"middle",fontSize:V,fontWeight:"900",fill:Zn,strokeWidth:v,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:Ge},children:re})}),L&&Ce&&!A&&P&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:g,y:b,textAnchor:"middle",fontSize:V,fontWeight:"800",fill:Jn,stroke:"#ffffff",strokeWidth:v,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:Ge},children:B})})]}),e.jsx("text",{x:g,y:vt,textAnchor:"middle",fontSize:x(1.05),fontWeight:"900",fill:j,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ge},children:ts(d.date)}),e.jsx("text",{x:g,y:Dt,textAnchor:"middle",fontSize:x(1),fontWeight:"900",fill:j,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ge},children:d.cycleDay}),a?e.jsxs("g",{children:[e.jsx("rect",{x:g-ie/2+1,y:Re-ie*.75+1,width:ie,height:ie,fill:"rgba(0, 0, 0, 0.1)",rx:ie*.3,opacity:.5}),e.jsx("rect",{x:g-ie/2-4,y:Re-ie*.75,width:ie*1.4,height:ie,fill:Et,stroke:It,strokeWidth:it,rx:ie*.2,style:{filter:Me}}),me&&e.jsx("g",{pointerEvents:"none",children:Ae?e.jsx("text",{x:g,y:Xe,textAnchor:"middle",fontSize:x(1.35),fontWeight:"900",fill:Vt,stroke:"#fff",strokeWidth:1.5,paintOrder:"stroke",style:{filter:yt},children:nn}):e.jsx("text",{x:g,y:Xe,textAnchor:"middle",fontSize:x(me?1.1:1),fontWeight:"800",fill:Yt,style:{filter:Ue},children:me})})]}):e.jsxs("g",{children:[o&&e.jsx("rect",{x:g-ie/2-4,y:Re-ie*.75,width:ie*1.4,height:ie,fill:"transparent",stroke:Ae?Vt:Yt,strokeWidth:1,rx:ie*.2}),e.jsx("text",{x:g,y:Xe,textAnchor:"middle",fontSize:x(Ae?1.35:gt?1.1:1),fill:Ae?Vt:gt?Yt:Ne,fontWeight:Ae?"900":gt?"800":"500",style:{filter:Ae?yt:gt?Ue:Ge},children:t})]}),!Z&&e.jsxs("text",{x:g,y:mn,textAnchor:"middle",fontSize:cn,fontWeight:"700",fill:Qt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ue},children:[e.jsx("tspan",{x:g,dy:0,children:J}),Ee&&e.jsx("tspan",{x:g,dy:je,children:Ee}),Oe&&e.jsx("tspan",{x:g,dy:je,children:Oe})]}),!Z&&e.jsxs("text",{x:g,y:xn,textAnchor:"middle",fontSize:dn,fontWeight:"700",fill:en,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ue},children:[e.jsx("tspan",{x:g,dy:0,children:Pt}),tt&&e.jsx("tspan",{x:g,dy:je,children:tt}),jt&&e.jsx("tspan",{x:g,dy:je,children:jt})]}),!Z&&e.jsxs("text",{x:g,y:gn,textAnchor:"middle",fontSize:un,fontWeight:"700",fill:tn,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:Ue},children:[e.jsx("tspan",{x:g,dy:0,children:Zt}),Bt&&e.jsx("tspan",{x:g,dy:je,children:Bt}),Ft&&e.jsx("tspan",{x:g,dy:je,children:Ft})]}),oe&&ut!=null&&ot&&e.jsx("g",{transform:`translate(${g-Ie/2}, ${ut-Ie/2})`,role:"img","aria-label":`Relación registrada el ${d.isoDate||`día ${k+1}`}`,children:e.jsx(ln,{width:Ie,height:Ie,color:Ut,fill:Ut})})]},`pt-${k}-${d.isoDate||d.timestamp}`)})]})},rs=(s,i)=>{if(s.data!==i.data||s.getX!==i.getX||s.getY!==i.getY||s.isFullScreen!==i.isFullScreen||s.orientation!==i.orientation||s.responsiveFontSize!==i.responsiveFontSize||s.onPointInteraction!==i.onPointInteraction||s.clearActivePoint!==i.clearActivePoint||s.chartHeight!==i.chartHeight||s.chartWidth!==i.chartWidth||s.temperatureField!==i.temperatureField||s.textRowHeight!==i.textRowHeight||s.compact!==i.compact||s.reduceMotion!==i.reduceMotion||s.isScrolling!==i.isScrolling||s.showInterpretation!==i.showInterpretation||s.ovulationDetails!==i.ovulationDetails||s.firstHighIndex!==i.firstHighIndex||s.baselineIndices!==i.baselineIndices||s.graphBottomLift!==i.graphBottomLift||s.graphBottomY!==i.graphBottomY||s.rowsZoneHeight!==i.rowsZoneHeight||s.showRelationsRow!==i.showRelationsRow)return!1;const m=s.visibleRange,h=i.visibleRange;if(m?.startIndex!==h?.startIndex||m?.endIndex!==h?.endIndex)return!1;const O=s.padding,x=i.padding;return!(O!==x&&(!O||!x||O.left!==x.left||O.right!==x.right||O.top!==x.top||O.bottom!==x.bottom))},os=bn.memo(as,rs),is="var(--color-sensacion-fuerte)",ls="var(--color-apariencia-fuerte)",cs="var(--color-observaciones-fuerte)",ds=({padding:s,chartHeight:i,tempMin:m,tempMax:h,tempRange:O,getY:x,responsiveFontSize:H,textRowHeight:G,isFullScreen:S,graphBottomY:w,rowsZoneHeight:F,showRelationsRow:Q=!1})=>{const q={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},z=[];if(O>0){const D=O<=2.5?.1:.5;for(let ce=m;ce<=h+1e-9;ce+=D)z.push(parseFloat(ce.toFixed(1)))}else for(let D=35.8;D<=37.2+1e-9;D+=.1)z.push(parseFloat(D.toFixed(1)));const N=w,Z=S?9:7.5,u=S?1:.75,_=Q?Z+(S?2:1.5):null,L=Z+u,ee=Math.max(1,Math.floor(F/L)),y=Math.max(G,ee),ke=c.useMemo(()=>{const D=[{label:"Fecha",row:1,color:"#374151",icon:null},{label:"Día",row:2,color:"#374151",icon:null},{label:"Símbolo",row:3,color:"#374151",icon:null},{label:"Sens.",row:S?5:4.5,color:is,icon:{type:"text",value:"◊"}},{label:"Apar.",row:S?7:6,color:ls,icon:{type:"text",value:"○"}},{label:"Obs.",row:S?9:7.5,color:cs,icon:{type:"text",value:"✦"}}];return Q&&_!=null&&D.push({label:"RS",row:_,color:"#f44336",icon:{type:"heart"}}),D},[S,_,Q]);return e.jsxs("svg",{width:s.left,height:i,className:"font-sans pointer-events-none",children:[e.jsx("defs",{children:e.jsx("filter",{id:"textShadowLegend",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.9)"})})}),z.map((D,ce)=>{const te=x(D),oe=D.toFixed(1).endsWith(".0")||D.toFixed(1).endsWith(".5"),f=oe?D.toFixed(1):`.${D.toFixed(1).split(".")[1]}`;return e.jsx(ze.g,{variants:q,children:e.jsx("text",{x:s.left-H(1.2),y:te+H(.35),textAnchor:"end",fontSize:H(oe?1.15:1),fontWeight:oe?"800":"700",fill:oe?"#be185d":"#db2777",opacity:oe?1:.85,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:f})},`temp-tick-fixed-${ce}`)}),e.jsx(ze.g,{variants:q,children:ke.map(({label:D,row:ce,color:te,icon:oe})=>{const f=s.left-H(2.8),de=N+y*ce,$=H(.95);return e.jsxs("g",{children:[oe?.type==="text"&&e.jsx("text",{x:f,y:de,textAnchor:"middle",fontSize:H(.8),fontWeight:"600",fill:te,opacity:.7,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:oe.value}),oe?.type==="heart"&&e.jsx("g",{transform:`translate(${f-$/2}, ${de-$/2})`,opacity:.7,children:e.jsx(ln,{width:$,height:$,color:te,fill:te,"aria-hidden":"true"})}),e.jsx("text",{x:s.left-H(.8),y:N+y*ce,textAnchor:"end",fontSize:H(1.05),fontWeight:"800",fill:te,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:D})]},D)})})]})},us=({data:s,isFullScreen:i,orientation:m,onToggleIgnore:h,onEdit:O,onTogglePeak:x,cycleId:H,initialScrollIndex:G=0,visibleDays:S=5,showInterpretation:w=!1,reduceMotion:F=!1,forceLandscape:Q=!1,currentPeakIsoDate:q=null,showRelationsRow:z=!1,fertilityStartConfig:N=null,fertilityCalculatorCycles:Z=[],fertilityCalculatorCandidates:u=null,onShowPhaseInfo:_=null,isArchivedCycle:L=!1,cycleEndDate:ee=null})=>{const{chartRef:y,tooltipRef:ke,dimensions:D,activePoint:ce,activeIndex:te,tooltipPosition:oe,allDataPoints:f,validDataForLine:de,tempMin:$,tempMax:xe,tempRange:we,padding:p,textRowHeight:ue,getY:Fe,getX:U,handlePointInteraction:vt,handleToggleIgnore:Dt,responsiveFontSize:Re,clearActivePoint:Ke,baselineTemp:Ze,baselineStartIndex:Mt,baselineIndices:ut,firstHighIndex:pe,ovulationDetails:Y,fertilityStart:R,hasAnyObservation:nt,graphBottomInset:Je,todayIndex:_e}=Dn(s,i,m,h,H,S,Q,N,Z,u,z),Ie=c.useRef(null);if(!Ie.current){const n=Math.random().toString(36).slice(2,10);Ie.current=`fertility-chart-${H??"default"}-${n}`}const Qe=Ie.current,Pe=c.useCallback((n,r)=>{const l=n>=20?1:2,j=Math.ceil(n*l),E=Math.min(j,24);return Math.max(E,12)},[]),We=c.useMemo(()=>{const n=f.length;if(!n)return{startIndex:0,endIndex:-1};const r=Pe(S,n),l=Math.max(0,Math.floor(G)-r),j=Math.min(n-1,Math.floor(G)+S+r);return{startIndex:l,endIndex:j}},[f.length,Pe,G,S]),[se,Nt]=c.useState(We),Le=c.useRef(null),[He,De]=c.useState(!1),ge=c.useRef(null);if(!f||f.length===0)return e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-pink-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),e.jsx("p",{className:"text-slate-400 font-medium",children:"No hay datos para mostrar en el gráfico"})]});const fe=D.width,ae=D.contentHeight??D.height,je=D.scrollableContentHeight??ae,Te=ae-p.bottom-(Je||0),$e=Math.max(ae-Te,0),ve=Ze!=null?Fe(Ze):null,st=!!Y?.confirmed,ft=Ze!=null&&st,ht=U(0),pt=f.length>0?U(f.length-1):fe-p.right,at=st?"#F59E0B":"#94A3B8",Rt=st?"6 4":"4 4",Ge=st?1:.7,Ue=3,yt=fe===0,Me=te!=null?U(te):null,At=te!=null?te>0?U(te-1):Me:null,et=te!=null?te<f.length-1?U(te+1):Me:null,rt=Math.max((fe-p.left-p.right)/Math.max(f.length,1),0),Ye=te!=null?Math.max((et!=null&&At!=null?et-At:0)||rt,rt,0):0,bt=c.useMemo(()=>{const n=new Map;return de.forEach(r=>{r&&r.id!=null&&n.set(r.id,r)}),n},[de]),k=c.useMemo(()=>Number.isInteger(R?.fertileStartFinalIndex)?R.fertileStartFinalIndex:null,[R]),d=Math.max(ae-p.top-p.bottom-(Je||0),0),g=c.useCallback(n=>!Number.isFinite(n)||!f.length||n<=0?p.left:U(n),[f,U,p.left]),he=c.useCallback(n=>!Number.isFinite(n)||!f.length||n>=f.length-1?fe-p.right:U(n+1),[f,fe,U,p.right]),X=c.useCallback((n,r,{inclusiveEnd:l=!0}={})=>{if(!Number.isFinite(n)||!Number.isFinite(r)||f.length===0)return null;const j=b=>Math.max(0,Math.min(f.length-1,Math.floor(b))),E=b=>Math.max(0,Math.min(f.length-1,Math.floor(b))),re=b=>Math.max(0,Math.min(f.length,Math.floor(b))),P=j(n),B=l?E(r):re(r),V=P<=0?p.left:g(P);let v;l?v=B>=f.length-1?fe-p.right:he(B):B<=0?v=p.left:B>=f.length?v=fe-p.right:v=g(B);const I=Math.max(v-V,0);return I<=0?null:{x:V,width:I}},[f,fe,g,he,p.left,p.right]),ne=f.length>0?f.length-1:null,ye=c.useMemo(()=>{if(!L||!ee||ne==null)return null;const n=typeof ee=="string"?ee:null;if(!n)return null;const r=f.findIndex(l=>l?.isoDate===n);if(r>=0)return Math.min(r,ne);for(let l=f.length-1;l>=0;l-=1){const j=f[l]?.isoDate;if(typeof j=="string"&&j<=n)return Math.min(l,ne)}return null},[L,ee,f,ne]),K=c.useMemo(()=>ne==null?null:L?Number.isInteger(ye)?Math.min(ye,ne):ne:Number.isInteger(_e)?Math.min(_e,ne):ne,[ye,L,_e,ne]),Ne=c.useMemo(()=>L?Number.isInteger(ye)?ye:Number.isInteger(K)?K:null:Number.isInteger(_e)?_e:null,[ye,L,K,_e]),Ce=d>0?p.top+d*.5:null,Ve=Ce!=null?Math.max(Te-Ce,0):0,A=c.useMemo(()=>{if(!w||!nt)return null;const n=R?.debug,r=Number.isInteger(n?.mucusInfertileStartIndex)?n.mucusInfertileStartIndex:null,l=Number.isInteger(R?.fertileWindow?.temperatureInfertileStartIndex)?R.fertileWindow.temperatureInfertileStartIndex:null,j=[r,l].filter(tt=>Number.isInteger(tt)).sort((tt,jt)=>tt-jt)[0],E=Number.isInteger(j)?j:Number.isInteger(n?.postOvulatoryStartIndex)?n.postOvulatoryStartIndex:null,re=Number.isInteger(r)&&Number.isInteger(l)?Math.max(r,l):null,P=Number.isInteger(re)?re:Number.isInteger(n?.absoluteStartIndex)?n.absoluteStartIndex:null,B={confirmed:!!Y?.confirmed,rule:Y?.rule??null,baselineTemp:Y?.baselineTemp??null,baselineIndices:Array.isArray(Y?.baselineIndices)?Y.baselineIndices:[],firstHighIndex:Number.isInteger(Y?.firstHighIndex)?Y.firstHighIndex:null,highSequenceIndices:Array.isArray(Y?.highSequenceIndices)?Y.highSequenceIndices:[],confirmationIndex:Number.isInteger(Y?.confirmationIndex)?Y.confirmationIndex:null,startIndex:l},V={peakDayIndex:Number.isInteger(Y?.peakDayIndex)?Y.peakDayIndex:null,thirdDayIndex:Number.isInteger(Y?.thirdDayIndex)?Y.thirdDayIndex:null,startIndex:r},v=l!=null,I=r!=null;if(!v&&!I)return null;const b=Number.isInteger(E)?E:null;if(b==null)return null;let C="pending",M="",T="Infertilidad postovulatoria",W="Fase postovulatoria: se ha cumplido un criterio de cierre; falta el segundo para confirmar la infertilidad absoluta.";const le="Infertilidad absoluta",be="Fase postovulatoria alcanzada (se ha confirmado día pico y subida de temperatura).",Se="Confirmación completa: doble criterio (día pico + temperatura).";let J=T,Ee=W,Oe=M,Pt="pending";return v&&I?(C="absolute",T=le,W=Se,M=be,Number.isInteger(l)&&(!Number.isInteger(r)||l<=r)?(B.rule,Oe=`Temperatura confirmada el ${B.confirmationIndex!=null?`D${B.confirmationIndex+1}`:"—"}. A la espera de determinación del día pico.`,Ee=Oe,J="Infertilidad estimada por temperatura"):(Oe=`Alcanzado ${V.thirdDayIndex!=null?"3° día postpico":"4º día postpico"} tras alcanzar día pico el ${V.peakDayIndex+1} del ciclo`,Ee=Oe,J="Infertilidad estimada por moco")):v?(B.rule,M=`Temperatura confirmada el ${B.confirmationIndex!=null?`D${B.confirmationIndex+1}`:"—"}. A la espera de determinación del día pico.`,W=M,T="Infertilidad estimada por temperatura",Oe=M,Ee=W,J=T):(M=`Alcanzado ${V.thirdDayIndex!=null?"3° día postpico":"4º día postpico"} tras seleccionar día pico el ${V.peakDayIndex+1} del ciclo`,W=M,T="Infertilidad estimada por moco",Oe=M,Ee=W,J=T),{phase:"postOvulatory",status:C,startIndex:b,absoluteStartIndex:P,estimated:{status:Pt,label:J,tooltip:Ee,message:Oe},absolute:{label:le,tooltip:Se,message:be},reasons:{type:"post",status:C,mucus:V,temperature:B},message:M,label:T,tooltip:W}},[w,nt,Y,R]),ot=c.useMemo(()=>{if(!w||d<=0||Ce==null||Ve<=0||f.length===0)return[];const n=[],r=f.length-1,l=Number.isInteger(K)&&K>=0?Math.min(K,r):r,j=(I,b)=>{if(!A)return;const C=A.startIndex,M=Number.isInteger(A.absoluteStartIndex)?A.absoluteStartIndex:null,T=A.estimated??A,W=A.absolute??A,le=M??C,be=A.status==="absolute"?r:Math.min(r,b);if(M!=null&&M>C){const Se=Math.min(M-1,b),J=X(C,Se);J&&I.push({key:"post-pending",phase:"postOvulatory",status:T.status??"pending",bounds:J,startIndex:C,endIndex:Se,displayLabel:T.label,tooltip:T.tooltip,message:T.message,reasons:A.reasons})}if(le<=be){const Se=X(le,be);Se&&I.push({key:"post-absolute",phase:"postOvulatory",status:M!=null?"absolute":A.status,bounds:Se,startIndex:le,endIndex:be,displayLabel:M!=null?W.label:A.label,tooltip:M!=null?W.tooltip:A.tooltip,message:M!=null?W.message:A.message,reasons:A.reasons})}},E=Number.isInteger(k),re=Number.isFinite(A?.startIndex);if(!E&&!re){const I=Math.min(l,r);if(I<0)return n;const b=X(0,I);return b&&n.push({key:"relative-default",phase:"relativeInfertile",status:"default",bounds:b,startIndex:0,endIndex:I,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (preovulatoria: sin día fértil por CPM/T-8 ni signos de moco fértil)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:null,aggregate:R?.aggregate??null,bipScore:R?.debug?.bipScore??null}}),n}if(!E&&re){const I=A.startIndex,b=Math.min(I-1,l);if(b>=0){const C=X(0,b);C&&n.push({key:"no-fertile-window",phase:"nodata",status:"no-fertile-window",bounds:C,startIndex:0,endIndex:b,displayLabel:"Sin ventana fértil identificable",tooltip:"Sin ventana fértil identificable",message:"Sin ventana fértil identificable",reasons:{type:"nofertile",status:"no-fertile-window",message:"No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."}})}return Number.isFinite(A.startIndex)&&A.startIndex<=r&&j(n,l),n}if(E&&k>0){const I=Math.min(k-1,l);if(I>=0){const b=X(0,I);b&&n.push({key:"relative",phase:"relativeInfertile",status:"default",bounds:b,startIndex:0,endIndex:I,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (fase relativamente infértil preovulatoria)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:k,aggregate:R?.aggregate??null,bipScore:R?.debug?.bipScore??null}})}}const P=E?Math.max(k,0):0,B=A?.startIndex,V=Number.isFinite(B)&&B!=null?Math.min(B-1,r):r,v=Math.min(V,l);if(v>=P){const I=X(P,v);if(I){const b=Number.isInteger(R?.debug?.explicitStartDay)?R.debug.explicitStartDay:null,C=R?.aggregate?.usedCandidates??[],M=C.some(le=>le?.kind==="profile"),T=C.some(le=>le?.kind==="calculator");let W=null;E&&b!=null&&b===k?W="marker":M?W="profiles":T&&(W="calculator"),n.push({key:"fertile",phase:"fertile",status:"default",bounds:I,startIndex:P,endIndex:v,displayLabel:"Fértil",tooltip:"Fértil",message:"Fértil",reasons:{type:"fertile",startIndex:P,endIndex:v,source:W,details:R?.debug??null,notes:R?.aggregate?.notes??[],statusSummary:R?.currentAssessment??null,dailyAssessments:R?.dailyAssessments??[],window:R?.fertileWindow??null,aggregate:R?.aggregate??null}})}}return A&&Number.isFinite(A.startIndex)&&A.startIndex<=r&&j(n,l),n},[w,d,Ce,Ve,f.length,k,R,A,nt,X,K]),wt=`${Qe}-phase-relative-gradient`,mt=`${Qe}-phase-fertile-gradient`,Be=`${Qe}-phase-post-pending-gradient`,qe=`${Qe}-phase-post-absolute-gradient`,xt=n=>n.phase==="relativeInfertile"?"#065F46":n.phase==="fertile"?"#9D174D":n.phase==="postOvulatory"?n.status==="pending"?"#075985":"#1E3A8A":n.phase==="nodata"?"#475569":"hsl(var(--foreground))",Et="0 1px 1px var(--phase-text-shadow, rgba(15, 23, 42, 0.2))",It=c.useMemo(()=>{if(!w||!Y?.confirmed)return null;const n=Array.isArray(Y?.highSequenceIndices)?Y.highSequenceIndices:[];if(n.length<2)return null;const r=n.map(l=>{if(l==null||l<0||l>=f.length)return null;const j=f[l],E=bt.get(j?.id);return!E||!Number.isFinite(E.displayTemperature)?null:{x:U(l),y:Fe(E.displayTemperature)}}).filter(Boolean);return r.length<2?null:r.map(({x:l,y:j},E)=>`${E===0?"M":"L"} ${l} ${j}`).join(" ")},[w,Y,f,bt,U,Fe]),[it,lt]=c.useState({w:typeof window<"u"?window.innerWidth:0,h:typeof window<"u"?window.innerHeight:0}),ie=it.w<it.h;c.useEffect(()=>{const n=()=>lt({w:window.innerWidth,h:window.innerHeight});return window.addEventListener("resize",n),window.addEventListener("orientationchange",n),()=>{window.removeEventListener("resize",n),window.removeEventListener("orientationchange",n)}},[]);const Xe=c.useCallback((n=0)=>{const r=y.current;if(!r)return;const l=f.length;if(!l){Nt({startIndex:0,endIndex:-1});return}const j=r.clientWidth||1,re=j/Math.max(S,1)||1,P=Pe(S,l),B=Math.floor(n/re),V=Math.floor((n+j)/re);let v=B-P,I=V+P;v=Math.max(0,v),I=Math.min(l-1,I),Nt(b=>b.startIndex===v&&b.endIndex===I?b:{startIndex:v,endIndex:I})},[f.length,Pe,S]);c.useEffect(()=>{if(!y.current)return;const n=y.current.clientWidth/S;y.current.scrollLeft=Math.max(0,n*G),Xe(y.current.scrollLeft)},[G,S,D.width,m,Xe]),c.useEffect(()=>{const n=y.current;if(!n)return;const r=()=>{De(!0),ge.current&&window.clearTimeout(ge.current),ge.current=window.setTimeout(()=>De(!1),140),!Le.current&&(Le.current=window.requestAnimationFrame(()=>{Le.current=null,Xe(n.scrollLeft)}))};return n.addEventListener("scroll",r,{passive:!0}),Xe(n.scrollLeft),()=>{n.removeEventListener("scroll",r),ge.current&&window.clearTimeout(ge.current),Le.current&&(window.cancelAnimationFrame(Le.current),Le.current=null)}},[Xe]);const me=i&&Q&&ie,Ae=Q?"landscape":m,gt=me,t="w-full h-full bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",o=i?`${t} h-full ${gt?"overflow-y-auto overflow-x-auto":"overflow-x-auto overflow-y-auto"}`:`${t} overflow-x-auto overflow-y-visible border border-pink-100/50`,a=!i||Ae==="portrait";return e.jsx(ze.div,{className:"relative w-full h-full",initial:!1,children:e.jsxs(ze.div,{ref:y,className:`relative p-0 ${i?"":"rounded-2xl"} ${o}`,style:{touchAction:"auto",boxShadow:i?"inset 0 1px 3px rgba(244, 114, 182, 0.1)":"0 8px 32px rgba(244, 114, 182, 0.12), 0 2px 8px rgba(244, 114, 182, 0.08)",...me?{position:"absolute",top:"50%",left:"50%",width:`${it.h}px`,height:`${it.w}px`,transform:"translate(-50%, -50%) rotate(90deg)",transformOrigin:"center center"}:{}},initial:!1,children:[yt&&e.jsx("div",{className:"flex items-center justify-center w-full h-full text-slate-400",children:"Cargando..."}),e.jsx("div",{className:"inline-block",style:{width:fe,height:ae},children:e.jsx("div",{className:"relative h-full overflow-y-auto",style:{height:ae,maxHeight:je},children:e.jsxs("div",{className:"relative",style:{width:fe,height:je},children:[a&&e.jsx("div",{className:"absolute left-0 top-0 h-full bg-transparent pointer-events-none z-10",style:{width:p.left},children:e.jsx(ds,{padding:p,chartHeight:je,tempMin:$,tempMax:xe,tempRange:we,getY:Fe,responsiveFontSize:Re,textRowHeight:ue,isFullScreen:i,graphBottomY:Te,rowsZoneHeight:$e,showRelationsRow:z})}),e.jsxs(ze.svg,{width:fe,height:je,className:"font-sans flex-shrink-0",viewBox:`0 0 ${fe} ${je}`,preserveAspectRatio:"xMidYMid meet",initial:!1,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#F472B6"}),e.jsx("stop",{offset:"50%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#E91E63"})]}),e.jsxs("linearGradient",{id:"tempAreaGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(244, 114, 182, 0.18)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(244, 114, 182, 0.02)"})]}),e.jsxs("linearGradient",{id:wt,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-rel)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-rel)",stopOpacity:"var(--phase-rel-stop, 0.28)"})]}),e.jsxs("linearGradient",{id:mt,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-fertile)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-fertile)",stopOpacity:"var(--phase-fertile-stop, 0.27)"})]}),e.jsxs("linearGradient",{id:Be,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post)",stopOpacity:"var(--phase-post-stop, 0.45)"})]}),e.jsxs("linearGradient",{id:qe,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post-abs)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post-abs)",stopOpacity:"var(--phase-post-abs-stop, 0.7)"})]}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"chartShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"baselineGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("rect",{width:"100%",height:"100%",fill:"transparent"}),e.jsx(Un,{padding:p,chartWidth:fe,chartHeight:ae,tempMin:$,tempMax:xe,tempRange:we,getY:Fe,getX:U,allDataPoints:f,visibleRange:se,responsiveFontSize:Re,isFullScreen:i,showLeftLabels:!a,reduceMotion:F,isScrolling:He,graphBottomY:Te,chartAreaHeight:Math.max(ae-p.top-p.bottom-(Je||0),0),rowsZoneHeight:$e}),w&&ot.length>0&&Ce!=null&&Ve>0&&e.jsx("g",{children:ot.map(n=>{const r=Ce,l=Ve,E=n.phase==="postOvulatory"?n.status==="pending"?`url(#${Be})`:`url(#${qe})`:n.phase==="relativeInfertile"?`url(#${wt})`:n.phase==="fertile"?`url(#${mt})`:n.phase==="nodata"?"rgba(203, 213, 225, 0.2)":`url(#${mt})`,re=i?14:13,P=Math.max(Re(1.1),re),B=n.bounds.width<120,V=Math.max(n.bounds.width-16,0),v=Math.max(P*.58,1),I=Math.max(1,Math.floor(V/v)),b=n.tooltip??n.displayLabel??n.message??"";let C=n.displayLabel??n.message??"";if(B&&C.length>I){const J=Math.max(I-1,1);C=`${C.slice(0,J).trimEnd()}${C.length>J?"…":""}`}const M=B?n.bounds.x+8:n.bounds.x+n.bounds.width/2,T=B?"start":"middle",W=r+l/2,le=xt(n),be=J=>{typeof J?.stopPropagation=="function"&&J.stopPropagation(),typeof _=="function"&&_({phase:n.phase,status:n.status,reasons:n.reasons,message:n.message,startIndex:n.startIndex,endIndex:n.endIndex,limitIndex:Ne,label:n.displayLabel??n.message??null})},Se=J=>{(J.key==="Enter"||J.key===" ")&&(J.preventDefault(),be(J))};return e.jsxs("g",{children:[e.jsx("rect",{x:n.bounds.x,y:r,width:n.bounds.width,height:l,fill:E,pointerEvents:"none"}),e.jsxs("text",{x:M,y:W,fill:le,fontSize:P,fontWeight:600,dominantBaseline:"middle",textAnchor:T,role:"button","aria-label":b,tabIndex:0,onClick:be,onKeyDown:Se,style:{cursor:"pointer",userSelect:"none",lineHeight:1.2,textShadow:Et},pointerEvents:"auto",children:[e.jsx("title",{children:b}),C]})]},n.key)})}),w&&ft&&ve!==null&&(F?e.jsx("line",{x1:ht,y1:ve,x2:pt,y2:ve,stroke:at,strokeWidth:Ue,strokeDasharray:Rt,opacity:Ge}):e.jsx(ze.path,{d:`M ${ht} ${ve} L ${pt} ${ve}`,stroke:at,strokeWidth:Ue,strokeDasharray:Rt,opacity:Ge,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:Ge},transition:{duration:4,ease:"easeInOut",delay:.5}})),e.jsx(Yn,{data:de,allDataPoints:f,getX:U,getY:Fe,baselineY:Te,temperatureField:"displayTemperature",reduceMotion:F}),It&&e.jsx("g",{pointerEvents:"none",children:e.jsx("path",{d:It,fill:"none",stroke:"#cc0e93",strokeWidth:4,strokeLinecap:"round",strokeLinejoin:"round",opacity:.9})}),te!==null&&Me!==null&&Ye>0&&e.jsx("g",{pointerEvents:"none",children:(()=>{const n=Te,r=Math.max(3,Math.min(14,Ye*.4)),l=Math.max(r*2,ue*.85);return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:Me,y1:0,x2:Me,y2:n,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:r}),e.jsx("line",{x1:Me,y1:n,x2:Me,y2:ae,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:l})]})})()}),e.jsx(os,{data:f,getX:U,getY:Fe,isFullScreen:i,orientation:Ae,responsiveFontSize:Re,onPointInteraction:vt,clearActivePoint:Ke,activePoint:ce,visibleRange:se,padding:p,chartHeight:ae,chartWidth:fe,temperatureField:"displayTemperature",textRowHeight:ue,graphBottomY:Te,rowsZoneHeight:$e,compact:!1,reduceMotion:F,isScrolling:He,showInterpretation:w,ovulationDetails:Y,baselineStartIndex:Mt,firstHighIndex:pe,baselineIndices:ut,graphBottomLift:Je,showRelationsRow:z})]})]})})}),ce&&e.jsx(ze.div,{ref:ke,initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:10},transition:{duration:.12,ease:"easeOut"},children:e.jsx(An,{point:ce,position:oe,chartWidth:fe,chartHeight:ae,onToggleIgnore:Dt,onEdit:O,onClose:Ke,onTogglePeak:x,currentPeakIsoDate:q})})]})})};function fs(s,i){if(!s||!i)return[];const m=typeof s=="string"?ct(s):s;return[...Array(i)].map((h,O)=>{const x=wn(m,O),H=Lt(x,"yyyy-MM-dd"),G=Lt(x,"dd/MM"),S=$t(dt(x),dt(m))+1;return{date:G,isoDate:H,cycleDay:S,temperature:null,mucusSensation:null,mucusAppearance:null,had_relations:!1,hadRelations:!1,id:`placeholder-${H}`,ignored:!1,peak_marker:null}})}const hs=({isOpen:s,onClose:i,children:m,ariaLabel:h,containerClassName:O="",backdropClassName:x="bg-black/40"})=>{if(c.useEffect(()=>{if(!s)return;const S=Q=>{Q.key==="Escape"&&typeof i=="function"&&i()};document.addEventListener("keydown",S);const{body:w}=document,F=w.style.overflow;return w.style.overflow="hidden",()=>{document.removeEventListener("keydown",S),w.style.overflow=F}},[s,i]),!s||typeof document>"u")return null;const H=()=>{typeof i=="function"&&i()},G=S=>{S.stopPropagation()};return In.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center px-4 py-8",children:[e.jsx("div",{className:`absolute inset-0 ${x}`,onClick:H,"aria-hidden":"true"}),e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":h??void 0,className:`relative z-[101] w-full max-w-md overflow-hidden rounded-3xl bg-white shadow-2xl shadow-rose-200/50 focus:outline-none focus-visible:ring-2 focus-visible:ring-pink-200 ${O}`,onClick:G,children:m})]}),document.body)},an="fertility-chart-settings",Ot=s=>s?String(s).toUpperCase().replace(/-/g,""):"",ps=s=>{const i=Ot(s);return i==="T8"?"T-8":i==="CPM"?"CPM":s??""},ms=s=>s==="conservador"?"estandar":s==="estandar"?s:null,Kt=()=>({calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"estandar"}),rn={showRelationsRow:!0,fertilityStartConfig:Kt()},xs=[{key:"cpm",label:"CPM"},{key:"t8",label:"T-8"}],kt=s=>{const i=Kt(),m={calculators:{...i.calculators},postpartum:i.postpartum,combineMode:i.combineMode};if(s&&typeof s=="object"){Object.keys(m.calculators).forEach(O=>{typeof s?.calculators?.[O]=="boolean"&&(m.calculators[O]=s.calculators[O])});const h=ms(s.combineMode);h&&(m.combineMode=h),typeof s.postpartum=="boolean"?m.postpartum=s.postpartum:s.postpartum!=null&&(m.postpartum=!!s.postpartum)}return m},Ms=()=>{const{cycleId:s}=jn(),i=Cn(),{currentCycle:m,archivedCycles:h,isLoading:O,addOrUpdateDataPoint:x,toggleIgnoreRecord:H,getCycleById:G}=Tn(),[S,w]=c.useState(null),[F,Q]=c.useState(!1),[q,z]=c.useState(!1),N=!s||s===m.id,Z=N?null:h.find(t=>t.id===s);c.useEffect(()=>{if(N){w(null),Q(!1),z(!1);return}if(Z){w(null),Q(!1),z(!1);return}let t=!0;return Q(!0),G(s).then(o=>{t&&(o?(w(o),z(!1)):(w(null),z(!0)))}).catch(()=>{t&&(w(null),z(!0))}).finally(()=>{t&&Q(!1)}),()=>{t=!1}},[N,Z,G,s]);const u=N?m:Z||S,_=!N&&!Z,L=!N&&u?.id,ee=N?O&&!m?.id:F||O&&!Z&&!S,{preferences:y,savePreferences:ke}=Sn(),D=y?.manualCpm,ce=y?.manualCpmBase,te=y?.manualT8,oe=y?.manualT8Base,f=["auto","manual","none"].includes(y?.cpmMode)?y.cpmMode:"auto",de=["auto","manual","none"].includes(y?.t8Mode)?y.t8Mode:"auto",$=c.useMemo(()=>{if(!L||!u?.startDate)return"";const t=n=>{if(!n)return null;try{return Lt(ct(n),"dd/MM/yyyy")}catch(r){return console.error("Error formatting cycle date",r),n}},o=t(u.startDate),a=t(u.endDate)??"Sin fecha de fin";return o?`Ciclo ${o} - ${a}`:""},[L,u?.startDate,u?.endDate]),xe=c.useMemo(()=>{const t=[];return Array.isArray(h)&&h.length>0&&t.push(...h),m?.id&&t.push(m),u?.id&&!t.some(o=>o?.id===u.id)&&t.push(u),t},[h,m,u]),[we,p]=c.useState(typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait"),[ue,Fe]=c.useState(!1),[U,vt]=c.useState(!1),[Dt,Re]=c.useState(!1),[Ke,Ze]=c.useState(null),[Mt,ut]=c.useState(null),[pe,Y]=c.useState(!1),[R,nt]=c.useState(!1),[Je,_e]=c.useState(!1),[Ie,Qe]=c.useState(null),[Pe,We]=c.useState(()=>{const t={showRelationsRow:rn.showRelationsRow,fertilityStartConfig:kt(rn.fertilityStartConfig)};if(typeof window>"u")return t;try{const o=window.localStorage.getItem(an);if(o){const a=JSON.parse(o),n={...t,...a};return typeof a?.showRelationsRow=="boolean"?n.showRelationsRow=a.showRelationsRow:a?.showRelationsRow!=null&&(n.showRelationsRow=!!a.showRelationsRow),n.fertilityStartConfig=kt(a?.fertilityStartConfig),n}}catch(o){console.warn("No se pudieron cargar los ajustes del gráfico.",o)}return t});c.useEffect(()=>{y&&We(t=>{const o=kt(t.fertilityStartConfig),a=kt(y.fertilityStartConfig);let n=!1;return typeof y.showRelationsRow=="boolean"&&t.showRelationsRow!==y.showRelationsRow&&(n=!0),o.combineMode!==a.combineMode&&(n=!0),o.postpartum!==a.postpartum&&(n=!0),Object.keys(o.calculators??{}).some(r=>o.calculators?.[r]!==a.calculators?.[r])&&(n=!0),n?{...t,showRelationsRow:typeof y.showRelationsRow=="boolean"?y.showRelationsRow:t.showRelationsRow,fertilityStartConfig:a}:t})},[y]);const se=c.useMemo(()=>kt(Pe.fertilityStartConfig),[Pe.fertilityStartConfig]),Nt=c.useMemo(()=>({...se,calculators:{...se.calculators,cpm:se.calculators.cpm&&f!=="none",t8:se.calculators.t8&&de!=="none"}}),[se,f,de]);c.useEffect(()=>{if(!(typeof window>"u"))try{const t={...Pe,fertilityStartConfig:se};window.localStorage.setItem(an,JSON.stringify(t))}catch(t){console.warn("No se pudieron guardar los ajustes del gráfico.",t)}},[Pe,se]);const Le=c.useRef(!1),He=c.useRef(0),De=c.useRef(null),ge=c.useRef(null),fe=!!(Ke&&String(Ke.id||"").startsWith("placeholder-"));if(c.useEffect(()=>{if(typeof document>"u")return;const t=document.body,o=document.documentElement;if(ue){De.current===null&&(De.current=t.style.overflow),ge.current===null&&(ge.current=o.style.overflow),t.style.overflow="hidden",o.style.overflow="hidden";return}return De.current!==null&&(t.style.overflow=De.current,De.current=null),ge.current!==null&&(o.style.overflow=ge.current,ge.current=null),()=>{De.current!==null&&(t.style.overflow=De.current,De.current=null),ge.current!==null&&(o.style.overflow=ge.current,ge.current=null)}},[ue]),c.useLayoutEffect(()=>{window.dispatchEvent(new Event("resize"))},[we,ue]),c.useEffect(()=>{if(typeof window>"u")return;const t=()=>{if(U)return;const o=window.innerWidth>window.innerHeight?"landscape":"portrait";p(a=>a===o?a:o),window.dispatchEvent(new Event("resize"))};return window.addEventListener("resize",t),window.addEventListener("orientationchange",t),t(),()=>{window.removeEventListener("resize",t),window.removeEventListener("orientationchange",t)}},[U]),ee)return e.jsx(Tt,{children:e.jsx("div",{className:"flex h-full flex-col items-center justify-center space-y-4 bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-fertiliapp-fuerte",children:e.jsx("p",{children:"Cargando…"})})});if(!u?.id)return s&&q?e.jsx(Tt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-fertiliapp-fuerte",children:[e.jsx("p",{children:"No se encontró el ciclo solicitado."}),e.jsx(St,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl text-white shadow",children:e.jsx(zt,{to:"/archived-cycles",children:"Volver a Mis Ciclos"})})]})}):e.jsx(Tt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-fertiliapp-fuerte",children:[e.jsx("p",{children:"No hay ciclo activo."}),e.jsx(St,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl text-white shadow",children:e.jsx(zt,{to:"/records",children:"Ir a Mis Registros"})})]})});const ae=28,je=10,Te=25,$e=ct(u.startDate),ve=u.data||[],st=c.useMemo(()=>(Array.isArray(ve)?ve.find(o=>o?.peak_marker==="peak"):null)?.isoDate||null,[ve]),ft=ve.reduce((t,o)=>{const a=ct(o.isoDate);return a>t?a:t},$e),ht=dt(new Date),pt=!N,at=pt&&u?.endDate?dt(ct(u.endDate)):null,Rt=pt?at??ft:ft>ht?ft:ht,Ge=$t(dt(Rt),$e),Ue=Math.max(ae,Ge+1),yt=at?$t(at,$e)+1:null,Me=yt?Math.min(Ue,yt):Ue,et=fs($e,Me).map(t=>{const o=ve.find(a=>a.isoDate===t.isoDate);return o?{...o,date:t.date}:t}),rt=U?"landscape":we,Ye=ue?rt==="portrait"?je:Te:rt==="portrait"?je:ae;let bt=0;if(rt!=="landscape"){const t=$t(new Date,dt($e)),o=Math.min(Math.max(t,0),Me-1);let a=Math.min(Me,o+1);o<Ye-1&&(a=Math.min(Me,Ye)),bt=Math.max(0,a-Ye)}const k={backgroundColor:"#fff7fb",backgroundImage:`
      radial-gradient(120% 120% at 0% 0%, rgba(251,113,133,0.18) 0, transparent 55%),
      radial-gradient(110% 110% at 100% 0%, rgba(244,114,182,0.16) 0, transparent 55%),
      radial-gradient(130% 130% at 0% 100%, rgba(251,113,133,0.08) 0, transparent 60%),
      radial-gradient(140% 140% at 100% 100%, rgba(255,255,255,0.9) 0, rgba(255,247,250,0.3) 40%, transparent 70%)
    `},d="calc(var(--app-vh, 1vh) * 100)",g="var(--bottom-nav-safe)",he=ue?{...k,height:d,maxHeight:d,paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"}:{...k,height:`calc(${d} - ${g})`,maxHeight:`calc(${d} - ${g})`,paddingTop:"env(safe-area-inset-top)"},X=(t,o=null)=>{Ze(t),ut(o??null),Re(!0)},ne=async(t,o)=>{try{if(await H(t,o),_){const a=await G(t);a&&w(a)}}catch(a){console.error("Error toggling ignore state:",a)}},ye=t=>{const o=t===!0;We(a=>({...a,showRelationsRow:o})),typeof ke=="function"&&ke({showRelationsRow:o}).catch(a=>{console.error("Failed to persist relations row preference",a)})},K=(t,o)=>{let a=null;We(n=>{const r=kt(n.fertilityStartConfig),l=o===!0;return r.calculators?.[t]===l?n:(a={...r,calculators:{...r.calculators,[t]:l}},{...n,fertilityStartConfig:a})}),a&&typeof ke=="function"&&ke({fertilityStartConfig:a}).catch(n=>{console.error("Failed to persist calculator preference",n)})},Ne=t=>{let o=null;We(a=>{const n=kt(a.fertilityStartConfig),r=t===!0;if(n.postpartum===r)return a;const j={...n.calculators??Kt().calculators,cpm:!r,t8:!r};return o={...n,postpartum:r,calculators:j},{...a,fertilityStartConfig:o}}),o&&typeof ke=="function"&&ke({fertilityStartConfig:o}).catch(a=>{console.error("Failed to persist postpartum preference",a)})},Ce=i?.state?.fertilityCalculatorCandidates,Ve=u?.fertilityCalculatorCandidates,A=c.useMemo(()=>{const t=[Array.isArray(Ce)?Ce:null,Array.isArray(Ve)?Ve:null].find(o=>Array.isArray(o)&&o.length>0);return t?t.map(o=>{if(!o)return null;const{source:a,day:n,reason:r}=o;if(a!=="CPM"&&a!=="T8")return null;const l=Number(n);return Number.isFinite(l)?{source:a,day:l,reason:typeof r=="string"?r:""}:null}).filter(Boolean):null},[Ce,Ve]),ot=c.useMemo(()=>{const t=En(xe),o=On(xe,Pn),a=[];return f==="auto"&&t&&a.push(t),de==="auto"&&o&&a.push(o),a},[xe,f,de]),wt=c.useMemo(()=>{const t=[],o=(a,n,r,l)=>{if(a!=="manual")return;const j=Number(r);if(!Number.isFinite(j)||j<=0)return;const E=Number(l),re=Number.isFinite(E)&&E>0,P=re?Number.isInteger(E)?`${E}`:`${Number(E.toFixed(2))}`:null,B=re?n==="CPM"?`ciclo base: ${P} días`:`base ${ps(n)}: ${P}`:null,V=B?`Manual desde dashboard (${B})`:"Manual desde dashboard";t.push({source:n,day:Math.max(1,j),reason:V,kind:"calculator",isManual:!0,manualBase:re?E:null})};return o(f,"CPM",D,ce),o(de,"T8",te,oe),t},[f,D,ce,te,oe,de]),mt=c.useMemo(()=>{const t=new Map;(Array.isArray(A)?A:[]).forEach(r=>{const l=Ot(r?.source);l&&t.set(l,r)});const o=new Map;wt.forEach(r=>{const l=Ot(r?.source);l&&o.set(l,r)});const a=f==="manual"?o.get("CPM")??t.get("CPM")??null:f==="auto"?ot.find(r=>Ot(r?.source)==="CPM")??null:null,n=de==="manual"?o.get("T8")??t.get("T8")??null:de==="auto"?ot.find(r=>Ot(r?.source)==="T8")??null:null;return[a,n].filter(Boolean)},[ot,f,wt,A,de]),Be=async(t,o=!0)=>{if(!u?.id||!t?.isoDate)return;const a=r=>{if(r==null||r==="")return null;const l=parseFloat(String(r).replace(",","."));return Number.isFinite(l)?l:null},n=o??!(t.peak_marker==="peak"||t.peakStatus==="P");Y(!0);try{const r=t.timestamp?Lt(ct(t.timestamp),"HH:mm"):Lt(new Date,"HH:mm");let l=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:r,time_corrected:t.time_corrected??r,selected:!0,use_corrected:t.use_corrected??!1}];l.length===0&&(l=[{temperature:null,temperature_corrected:null,time:r,time_corrected:r,selected:!0,use_corrected:!1}]);const j=l.map((P,B)=>{const V=P.time||r,v=P.time_corrected||V;return{temperature:a(P.temperature??P.temperature_raw),time:V,selected:B===0?!0:!!P.selected,temperature_corrected:a(P.temperature_corrected),time_corrected:v,use_corrected:!!P.use_corrected}});j.some(P=>P.selected)||(j[0].selected=!0);const E={isoDate:t.isoDate,measurements:j,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",had_relations:t.had_relations??t.hadRelations??!1,ignored:t.ignored??!1,peak_marker:n?"peak":null},re=t?.id&&!String(t.id).startsWith("placeholder-")?t:null;await x(E,re,u.id)}catch(r){console.error("Error toggling peak marker:",r)}finally{Y(!1)}},qe=c.useCallback(()=>{Re(!1),Ze(null),ut(null)},[]),xt=async(t,{keepFormOpen:o=!1}={})=>{if(u?.id){Y(!0),o&&(He.current=Date.now()+500);try{if(await x(t,Ke,u.id),_){const a=await G(u.id);a&&w(a)}o||(Re(!1),Ze(null),ut(null))}finally{Y(!1)}}},Et=t=>{Ze(t)},It=()=>{nt(t=>!t)},it=c.useCallback(()=>{Qe(null)},[]),lt=t=>{if(t.preventDefault(),Le.current){Le.current=!1;return}It()},ie=t=>{t.pointerType==="touch"&&(t.preventDefault(),Le.current=!0,It())},Xe=c.useCallback(t=>{if(t){Re(!0);return}Date.now()<He.current||qe()},[qe]),me=c.useCallback(t=>{if(!Number.isInteger(t)||t<0||t>=et.length)return"—";const o=et[t],a=o?.isoDate??o?.date;if(!a)return"—";try{const n=typeof a=="string"?ct(a):a;return Lt(n,"dd/MM")}catch(n){return console.error("Error formatting date from index",n),"—"}},[et]),Ae=c.useCallback((t={})=>{if(!t)return;const o=t.phase??null,a=t.reasons??{},n=a?.aggregate??null,r=Array.isArray(n?.usedCandidates)?n.usedCandidates:[],l=a?.window??a?.fertileWindow??null,j=Number.isInteger(a?.startIndex)?a.startIndex:Number.isInteger(a?.fertileStartFinalIndex)?a.fertileStartFinalIndex:null,E=!!se?.postpartum,re=!E&&!!(se?.calculators?.cpm||se?.calculators?.t8),P=C=>(C?.source??C?.originalSource??"").toString().toUpperCase(),B=()=>{const C=Number.isInteger(j)?j+1:null;return C?{candidate:r.find(T=>Number.isFinite(T?.day)&&Math.round(T.day)===C)??r[0]??null,dayNumber:C}:{candidate:null,dayNumber:null}},V=()=>{const{candidate:C}=B(),M=P(C);if(M==="CPM")return"alcanzar valor CPM";if(M==="T8"||M==="T-8")return"alcanzar valor T-8";if(a?.source==="marker"||a?.details?.explicitStartDay!=null)return"marcador";const T=(C?.reason??"").toUpperCase(),W=T.includes("S")||T.includes("BIP");return!T&&!M?null:W?"cambio en la sensación":"presencia de moco"};let v="",I="",b=null;if(o==="relativeInfertile"){v="Relativamente infértil";const C=Number.isInteger(t?.limitIndex)?t.limitIndex:Number.isInteger(t?.endIndex)?t.endIndex:Number.isInteger(t?.todayIndex)?t.todayIndex:null,M=Number.isInteger(j)&&Number.isInteger(C)&&j<=C,T=V(),W=me(j);M?(I=`Fin de fase por ${T??"—"}.`,b=W!=="—"?`Inicio fértil: ${W}.`:null):re?I="A la espera de cálculo (CPM/T-8) o signos de moco/sensación.":I="A la espera de signos de moco/sensación."}else if(o==="fertile"){v="Fase fértil";const C=V()??"—",T=me(j)??"—",W=Number.isFinite(l?.endIndex),le=Number.isInteger(l?.mucusInfertileStartIndex),be=Number.isInteger(l?.temperatureInfertileStartIndex);I=`Iniciada el ${T} por ${C}.`,W?le&&be?b="Finalizada por doble criterio.":le?b="Finalizada por día pico.":be&&(b="Finalizada por temperatura."):b="A la espera de cierre por día pico y/o confirmación de temperatura."}else if(o==="postOvulatory"){const C=(t?.displayLabel??t?.label??"").toLowerCase(),M=t?.status??a?.status??null,T=me(Number.isInteger(a?.temperature?.confirmationIndex)?a.temperature.confirmationIndex:Number.isInteger(a?.temperature?.startIndex)?a.temperature.startIndex:l?.temperatureInfertileStartIndex),W=me(a?.mucus?.peakDayIndex),le=me(Number.isInteger(a?.mucus?.infertileStartIndex)?a.mucus.infertileStartIndex:t?.startIndex),be=me(t?.startIndex);if(M==="absolute"||t?.displayLabel==="Infertilidad absoluta")v="Infertilidad postovulatoria confirmada",I=`Comienza el ${be}.`,b=`Confirmada por temperatura (${T}) y 3.º/4.º día postpico (${le}).`;else if(C.includes("moco")){v="Infertilidad post-pico";const Se=Number.isInteger(a?.mucus?.infertileStartIndex)?a.mucus.infertileStartIndex:Number.isInteger(t?.startIndex)?t.startIndex:null,J=Number.isInteger(a?.mucus?.peakDayIndex)?a.mucus.peakDayIndex:null;let Ee="día postpico";if(Number.isInteger(Se)&&Number.isInteger(J)){const Oe=Se-J;Oe===3?Ee="3.º día postpico":Oe===4&&(Ee="4.º día postpico")}I=`Alcanzada el ${be} por ${Ee}. Día pico: ${W}.`,b="A la espera de confirmación por temperatura."}else C.includes("temperatura")?(v="Infertilidad postovulatoria por temperatura",I=`Temperatura confirmada el ${T}.`,b="A la espera de determinación del día pico."):(v="Fase postovulatoria",I="Interpretación postovulatoria disponible.",b=M==="pending"?"Pendiente completar el segundo criterio.":null)}else if(o==="nodata")(a?.status??t?.status??null)==="no-fertile-window"?(v="Sin ventana fértil identificable",I="No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."):(v="Sin datos suficientes",I="Añade registros de sensación, moco o temperatura para interpretar el ciclo.");else if(t?.message)v=t.message;else return;v&&Qe({title:v,message:I,description:b,postpartumActive:E})},[se,me,et.length,Qe]),gt=()=>{if(!ue){Fe(!0),vt(!0);return}vt(!1);const t=typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait";p(t),Fe(!1)};return e.jsx(Tt,{hideBottomNav:ue,children:e.jsxs("div",{className:ue?"fixed inset-0 z-50 h-app w-[100vw] overflow-y-auto overflow-x-hidden":"relative w-full h-full overflow-y-auto overflow-x-hidden",style:he,children:[L&&!ue&&e.jsx(St,{asChild:!0,variant:"ghost",className:"absolute top-4 left-4 z-10 bg-white/20 text-slate-700 hover:brightness-95",children:e.jsxs(zt,{to:`/cycle/${u.id}`,className:"flex items-center gap-1",children:[e.jsx(_n,{className:"h-4 w-4"}),$&&e.jsx("span",{className:"ml-1 text-xs font-semibold text-slate-700 sm:text-sm",children:$})]})}),e.jsx(St,{onClick:()=>_e(t=>!t),variant:"ghost",size:"icon",className:"absolute top-16 right-4 z-10 p-2 rounded-full bg-white/20 shadow-lg shadow-secundario text-secundario border hover:brightness-95","aria-label":"Ajustes",children:e.jsx(Hn,{className:"h-4 w-4"})}),e.jsx(St,{onClick:lt,onPointerUp:ie,variant:"ghost",size:"icon",className:`absolute top-4 right-20 z-10 p-2 rounded-full transition-colors ${R?"bg-fertiliapp-fuerte text-white shadow-lg shadow-fertiliapp-fuerte/50 border-fertiliapp-fuerte/70":"bg-white/20 text-fertiliapp-fuerte border border-fertiliapp-fuerte hover:brightness-95 shadow-md"}`,children:R?e.jsx(Wn,{className:"h-4 w-4"}):e.jsx(Gn,{className:"h-4 w-4"})}),e.jsx(St,{onClick:gt,className:"absolute top-4 right-4 z-10 bg-white/20 rounded-full text-slate-600 hover:bg-pink-50/80 shadow-md border border-slate-400/50 backdrop-blur-sm","aria-label":ue?"Salir de pantalla completa":"Rotar gráfico",children:e.jsx(zn,{className:"w-4 h-4"})}),e.jsx(us,{data:et,isFullScreen:ue,orientation:we,onToggleIgnore:ne,onEdit:X,onTogglePeak:Be,cycleId:u.id,initialScrollIndex:bt,visibleDays:Ye,showInterpretation:R,reduceMotion:!0,forceLandscape:U||we==="landscape",currentPeakIsoDate:st,showRelationsRow:Pe.showRelationsRow,fertilityStartConfig:Nt,fertilityCalculatorCycles:xe,fertilityCalculatorCandidates:mt,onShowPhaseInfo:Ae,isArchivedCycle:!N,cycleEndDate:u?.endDate??null}),Je&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/30",onClick:()=>_e(!1),"aria-hidden":"true"}),e.jsx("div",{className:`fixed top-0 right-0 z-50 h-app w-72 sm:w-80 transform transition-transform duration-300 ease-in-out ${Je?"translate-x-0":"translate-x-full"}`,role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col gap-6 border-xl rounded-xl border-rose-100/60 bg-white p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-titulo",children:"Ajustes del gráfico"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Personaliza la visualización del gráfico"})]}),e.jsx(St,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-slate-600",onClick:()=>_e(!1),"aria-label":"Cerrar ajustes del gráfico",children:"×"})]}),e.jsxs("div",{className:"space-y-4 overflow-y-auto pr-1",children:[e.jsxs("div",{className:"rounded-2xl border border-pink-100/70 bg-pink-50/40 p-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"max-w-xs",children:[e.jsx(Fn,{htmlFor:"toggle-relations-row",className:"text-sm font-semibold text-slate-700",children:"Mostrar fila RS"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Añade una fila dedicada a las relaciones sexuales debajo de la gráfica."})]}),e.jsx(Ht,{id:"toggle-relations-row",checked:Pe.showRelationsRow,onCheckedChange:ye,className:"mt-1"})]}),e.jsx("div",{className:"rounded-2xl border border-red-100/70 bg-red-50/40 p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3 pt-1",children:[e.jsx("div",{className:"max-w-[65%]",children:e.jsx("p",{className:"text-sm font-semibold text-slate-700",children:"Modo postparto"})}),e.jsx(Ht,{checked:!!se.postpartum,onCheckedChange:Ne,className:"mt-1"})]})}),e.jsxs("div",{className:"rounded-2xl border border-amber-100/70 bg-amber-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Calculadoras complementarias"}),e.jsx("p",{className:"text-xs text-slate-500",children:"CPM y T-8 se combinan con los perfiles activos, salvo que actives el modo posparto."})]}),se.postpartum&&e.jsx("p",{className:"text-xs font-medium text-rose-500",children:"El modo posparto está activo: CPM y T-8 se omiten del cálculo final."}),e.jsx("div",{className:"space-y-2",children:xs.map(t=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-sm text-slate-700",children:t.label}),e.jsx(Ht,{checked:!!se.calculators?.[t.key],disabled:!!se.postpartum,onCheckedChange:o=>K(t.key,o)})]},t.key))})]})]})]})}),e.jsx(hs,{isOpen:!!Ie,onClose:it,ariaLabel:"Detalle de interpretación del ciclo",containerClassName:"p-6",children:Ie&&e.jsxs("div",{className:"space-y-3 text-left",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-fertiliapp-fuerte",children:Ie.title}),Ie.postpartumActive&&e.jsx("span",{className:"rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-[11px] font-semibold text-rose-600",children:"Modo postparto"})]}),e.jsx("button",{type:"button",onClick:it,className:"rounded-full p-1 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-200","aria-label":"Cerrar detalle de interpretación",children:e.jsx(kn,{className:"h-5 w-5"})})]}),Ie.message&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-700",children:Ie.message}),Ie.description&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-500",children:Ie.description})]})}),e.jsx($n,{open:Dt,onOpenChange:Xe,children:e.jsx(Bn,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",onInteractOutside:t=>{Date.now()<He.current&&t.preventDefault()},onPointerDownOutside:t=>{Date.now()<He.current&&t.preventDefault()},children:e.jsx(Ln,{onSubmit:xt,onCancel:qe,initialData:Ke,cycleStartDate:u.startDate,cycleEndDate:u.endDate,isProcessing:pe,isEditing:!!Ke&&!fe,cycleData:u.data,onDateSelect:Et,initialSectionKey:Mt})})})]})})};export{Ms as default};
