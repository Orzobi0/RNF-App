import{c as Mt,r as _,H as kt,j as l,m as xe,B as Ge,I as yt,f as et,p as Re,X as Nt,J as dt}from"./index-8c1bb4d0.js";import{e as jt,B as Tt}from"./badge-6bd7af9d.js";import{g as Pt,X as At,d as at,P as ot,e as Ke,T as Ct,f as Ft,c as Dt}from"./computePeakStatuses-347fa954.js";const _t=Mt("Sparkles",[["path",{d:"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z",key:"17u4zn"}],["path",{d:"M5 3v4",key:"bklmnn"}],["path",{d:"M19 17v4",key:"iiml17"}],["path",{d:"M3 5h4",key:"nem4j1"}],["path",{d:"M17 19h4",key:"lbex7p"}]]),Lt=({isOpen:e,onClose:r,children:o,ariaLabel:j,containerClassName:m="",backdropClassName:s="bg-black/40"})=>{if(_.useEffect(()=>{if(!e)return;const x=$=>{$.key==="Escape"&&typeof r=="function"&&r()};document.addEventListener("keydown",x);const{body:b}=document,I=b.style.overflow;return b.style.overflow="hidden",()=>{document.removeEventListener("keydown",x),b.style.overflow=I}},[e,r]),!e||typeof document>"u")return null;const c=()=>{typeof r=="function"&&r()},p=x=>{x.stopPropagation()};return kt.createPortal(l.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center px-4 py-8",children:[l.jsx("div",{className:`absolute inset-0 ${s}`,onClick:c,"aria-hidden":"true"}),l.jsx("div",{role:"dialog","aria-modal":"true","aria-label":j??void 0,className:`relative z-[101] w-full max-w-md overflow-hidden rounded-3xl bg-white shadow-2xl shadow-rose-200/50 focus:outline-none focus-visible:ring-2 focus-visible:ring-pink-200 ${m}`,onClick:p,children:o})]}),document.body)},nn=({point:e,position:r,chartWidth:o,chartHeight:j,onToggleIgnore:m,onEdit:s,onClose:c,onTogglePeak:p,currentPeakIsoDate:x})=>{if(!e)return null;const b=.6,I=200,$=120,z=I*b,ae=$*b,B=_.useRef(null),[d,S]=_.useState(ae),[N,v]=_.useState(!1),[P,k]=_.useState(!1);_.useEffect(()=>{B.current&&S(B.current.offsetHeight),v(!1),k(!1)},[e]);const R=r.clientX>o*.66,Y=r.clientY+d>j;let D=R?r.clientX-z-10:r.clientX+10,q=Y?r.clientY:r.clientY+10;D+z>o&&(D=o-z-10),q+d>j&&(q=j-d-10),D<10&&(D=10),q<10&&(q=10);const A=!e.id||String(e.id).startsWith("placeholder-"),O=e.temperature_chart??e.displayTemperature??null,X=Pt(e.fertility_symbol),G=e.timestamp||e.isoDate,te=y=>{if(y==null)return null;const g=String(y).trim();return g.length?g:null},Q=y=>{if(!y)return null;try{const g=Re(y),M=g.getTime();return Number.isNaN(M)?null:et(g,"HH:mm")}catch{return null}},se=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const y=e.measurements.filter(Boolean);if(!y.length)return null;const g=[...y.filter(M=>M==null?void 0:M.selected),...y.filter(M=>!(M!=null&&M.selected))];for(const M of g){const ee=!!(M!=null&&M.use_corrected)?te(M==null?void 0:M.time_corrected)??te(M==null?void 0:M.time):te(M==null?void 0:M.time);if(ee)return ee}return null})(),K=(e.use_corrected?[te(e.time_corrected),te(e.time)]:[te(e.time)]).find(Boolean)??Q(e.timestamp),he=se??K,F=e.fertilityAssessment??null,Ce=!!F&&(F==null?void 0:F.showFertilityStatus)!==!1&&!e.isFutureDay,H=(F==null?void 0:F.header)??null,T=(F==null?void 0:F.title)??(F==null?void 0:F.label)??null,me=(F==null?void 0:F.body)??(F==null?void 0:F.summaryText)??null,Ie=Array.isArray(F==null?void 0:F.reasonsList)?F.reasonsList:[],ce=(F==null?void 0:F.note)??null,pe=(F==null?void 0:F.state)??null,W=(()=>{switch(pe){case"waiting":return{container:"from-amber-50 to-yellow-50 border border-amber-200/70",header:"text-amber-700/80",title:"text-amber-900",body:"text-amber-800/80",icon:"from-amber-500 to-orange-500"};case"infertil":return{container:"from-slate-50 to-slate-100 border border-slate-200/80",header:"text-slate-600",title:"text-slate-800",body:"text-slate-600",icon:"from-slate-500 to-slate-600"};default:return{container:"from-emerald-50 to-lime-50 border border-emerald-200/70",header:"text-emerald-700/80",title:"text-emerald-900",body:"text-emerald-800/80",icon:"from-emerald-500 to-teal-600"}}})(),ue=e.mucus_sensation??e.mucusSensation??"",Z=e.mucus_appearance??e.mucusAppearance??"",ne=e.observations??"",de=!!(e.had_relations??e.hadRelations),Se=X&&X.value!=="none",oe=O!=null,be=!!(ue&&ue.trim()||Z&&Z.trim()),Ne=!!(ne&&ne.trim()),Fe=!(oe||Se||be||Ne||de),re=e.peakStatus||(e.peak_marker==="peak"?"P":null),fe=re&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[re]||null,we=!!(p&&e.isoDate),De=!!x,ke=De&&e.isoDate===x||re==="P"||e.peak_marker==="peak",ve=ke?"remove":De?"update":"assign",n=ve==="assign"?"Asignar día pico":ve==="update"?"Actualizar día pico":"Quitar día pico",u=n,a=async()=>{if(!(!p||N)){v(!0);try{await p(e,!ke),c&&c()}catch(y){console.error("Error toggling peak marker from tooltip:",y)}finally{v(!1)}}},h=()=>{f()},f=y=>{s&&(s(e,y),c&&c())},L=(y=>{switch(y){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return l.jsxs(xe.div,{ref:B,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:q,left:D,width:z},children:[l.jsx("div",{className:"origin-top-left",style:{transform:`scale(${b})`,width:I,minHeight:$},children:l.jsxs("div",{className:"relative bg-gradient-to-br from-white/98 to-rose-50/95 backdrop-blur-xl rounded-3xl border border-pink-100 shadow-2xl overflow-hidden",children:[l.jsx(Ge,{variant:"ghost",size:"icon",onClick:c,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-pink-600 hover:bg-pink-50/80 rounded-full w-6 h-6 transition-all duration-200",children:l.jsx(At,{size:20})}),de&&l.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:l.jsx("div",{className:"w-4 h-4 rounded-full bg-rose-100/90 border border-rose-200 flex items-center justify-center shadow-sm",children:l.jsx(yt,{className:"w-4 h-4 text-rose-600",fill:"currentColor"})})}),l.jsxs("div",{className:"p-2",children:[l.jsxs("div",{className:"mb-2 relative",children:[l.jsx("div",{className:"w-5 h-5 bg-gradient-to-br from-pink-500 to-rose-500 rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:l.jsx(at,{className:"w-2 h-2 text-white",fill:"currentColor"})}),l.jsx("div",{className:"flex items-center mb-1 pl-8",children:l.jsxs("div",{children:[l.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:G?et(Re(G),"dd/MM",{locale:jt}):"Fecha"}),l.jsxs("p",{className:"text-sm text-pink-600 font-medium",children:["Día ",e.cycleDay||"N/A"," del ciclo"]}),fe&&l.jsx("div",{className:"mt-1 flex justify-center",children:l.jsx(Tt,{className:"bg-rose-100 text-rose-600 border border-rose-200 px-2 py-0 text-[11px]",children:fe})})]})})]}),Ce&&T&&l.jsxs(l.Fragment,{children:[l.jsx(xe.button,{type:"button",onClick:()=>k(!0),initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{delay:.05},className:`mb-2 w-full bg-gradient-to-r ${W.container} rounded-3xl p-2 shadow-sm outline-none transition-transform hover:shadow-md focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200 active:scale-95`,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:`w-7 h-7 bg-gradient-to-br ${W.icon} rounded-xl flex items-center justify-center shadow-md`,children:l.jsx(_t,{className:"w-4 h-4 text-white"})}),l.jsx("p",{className:`flex-1 text-left text-sm font-semibold ${W.title}`,children:T})]})}),l.jsxs(Lt,{isOpen:P,onClose:()=>k(!1),ariaLabel:"Detalle de la evaluación de fertilidad",containerClassName:"p-6",children:[l.jsxs("div",{className:"flex items-start justify-between gap-4",children:[l.jsxs("div",{className:"space-y-1",children:[H&&l.jsx("p",{className:`text-xs font-semibold uppercase tracking-wide ${W.header}`,children:H}),l.jsx("p",{className:`text-lg font-semibold ${W.title}`,children:T})]}),l.jsx("button",{type:"button",onClick:()=>k(!1),className:"rounded-full p-1 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-200","aria-label":"Cerrar detalle de fertilidad",children:l.jsx(Nt,{className:"h-5 w-5"})})]}),l.jsxs("div",{className:"mt-4 space-y-3 text-left",children:[me&&l.jsx("p",{className:`text-sm leading-relaxed ${W.body}`,children:me}),Ie.length>0&&l.jsx("ul",{className:"list-disc space-y-1 pl-5 text-sm text-slate-600",children:Ie.map((y,g)=>l.jsx("li",{children:y},`${y}-${g}`))}),ce&&l.jsx("p",{className:"text-xs text-slate-500",children:ce})]})]})]}),Fe?l.jsxs("div",{className:"pt-1 space-y-3",children:[l.jsx(xe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-pink-200 bg-pink-50/60 p-2 text-center",children:l.jsx("p",{className:"text-sm font-semibold text-pink-600",children:"Sin datos registrados para este día."})}),(we||s)&&l.jsxs(xe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[we&&l.jsx(ot,{mode:ve,size:"sm",onClick:a,pending:N,"aria-label":u,title:n,className:"shrink-0"}),s&&l.jsxs(Ge,{onClick:h,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[l.jsx(Ke,{className:"h-4 w-4"}),l.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"space-y-1",children:[oe&&l.jsx(xe.button,{type:"button",onClick:()=>f("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-1 border border-amber-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-200",disabled:!s,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center shadow-md",children:l.jsx(Ct,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1",children:l.jsxs("div",{className:"flex items-center justify-between gap-3",children:[l.jsxs("div",{className:"flex items-baseline gap-2",children:[l.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(O).toFixed(2)}),l.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&l.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),he&&l.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:he})]})})]})}),Se&&l.jsx(xe.button,{type:"button",onClick:()=>f("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${L.light} rounded-3xl p-1 ${L.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!s,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:`w-6 h-6 ${L.bg} rounded-lg flex items-center justify-center shadow-lg ${L.glow} shadow-lg`,children:l.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:`text-md font-semibold ${L.text}`,children:X.label})})]})}),l.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[l.jsx(xe.button,{type:"button",onClick:()=>f("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-1 border border-blue-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!s,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md",children:l.jsx(Ft,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:"text-md font-semibold text-blue-800",children:ue||"-"})})]})}),l.jsx(xe.button,{type:"button",onClick:()=>f("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-gradient-to-r from-emerald-50 to-teal-50 rounded-3xl p-1 border border-emerald-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!s,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center shadow-md",children:l.jsx(at,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:"text-md font-semibold text-green-800",children:Z||"-"})})]})}),Ne&&l.jsx(xe.button,{type:"button",onClick:()=>f("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-gradient-to-r from-violet-50 to-purple-50 rounded-3xl p-1 border border-violet-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!s,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md",children:l.jsx(Ke,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:"text-sm font-semibold text-violet-800",children:ne})})]})})]})]}),(s||m&&!A&&e.id||we&&!A)&&l.jsxs(xe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[we&&!A&&l.jsx(ot,{mode:ve,size:"sm",onClick:a,pending:N,"aria-label":u,title:n,className:"shrink-0"}),l.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:s&&l.jsxs(Ge,{onClick:h,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[l.jsx(Ke,{className:"h-4 w-4 mr-1.5"}),l.jsx("span",{className:"font-medium",children:A?"Añadir datos":""})]})})]})]})]})]})}),l.jsx("div",{className:"absolute -inset-2 bg-gradient-to-br from-pink-200/25 to-rose-300/25 rounded-3xl blur-2xl -z-10"})]})},He={0:0,1:.4,2:.8,3:1},zt={M:.8,F:1,"M+":1,white:.4},Bt=(e,r=0,o=1)=>!Number.isFinite(e)||e<r?r:e>o?o:e,Et=e=>e?String(e).toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""):"",mt=e=>Et(e).replace(/\s+/g," ").trim(),ft=(e,r=[])=>{if(!e)return null;let o=null;return r.forEach((j,m)=>{const{patterns:s=[],level:c,descriptor:p,negatedLevel:x,allowedModifiers:b=null,disallowedModifiers:I=null,selectionScore:$,forceSelection:z=!1}=j||{};s.forEach(ae=>{if(!ae)return;const B=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${ae})(?=$|[^a-z0-9])`,"g");let d;for(;(d=B.exec(e))!==null;){const S=d[1]?d[1].trim():null;if(b&&!b.includes(S)||I&&I.includes(S))continue;let N=c;S==="no"?N=x??1:S==="muy"?N=Math.min(3,c+1):(S==="poco"||S==="leve")&&(N=Math.max(0,c-1));const v=$??N+m*.001,P=typeof p=="function"?p({modifier:S}):p;(!o||z||N>o.level||N===o.level&&v>o.selectionScore)&&(o={level:N,baseLevel:c,descriptor:P,modifier:S,selectionScore:v,force:z})}})}),o},$t=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],Ot=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],ht=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const o=Math.round(e);if(o>=0&&o<=3)return o}const r=String(e).trim();return/^[0-3]$/.test(r)?Number.parseInt(r,10):null},pt=e=>{const r=ht(e);if(r!=null)return{level:r,reason:`S${r}`,descriptor:`S${r}`,hasInput:!0};const o=e!=null?String(e).trim():"",j=mt(e),m=o.length>0;if(!j)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^s\s*0?$/.test(j))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(j==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const s=ft(j,$t);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},bt=e=>{const r=ht(e);if(r!=null)return{level:r,reason:`M${r}`,descriptor:`M${r}`,hasInput:!0};const o=e!=null?String(e).trim():"",j=mt(e),m=o.length>0;if(!j)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^m\s*0$/.test(j))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(o))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const s=ft(j,Ot);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},Rt=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Ht=({appearance:e,observations:r,fertilitySymbol:o})=>{const j=[e,r,o].map(s=>String(s||"").toUpperCase()),m=s=>{if(!s)return!1;const p=`(?:^|[^\\p{L}\\p{N}])${Rt(s)}(?=$|[^\\p{L}\\p{N}])`,x=new RegExp(p,"u");return j.some(b=>x.test(b))};return m("M+")?"M+":m("M")?"M":m("F")||m("FER")?"F":String(o||"").toLowerCase()==="white"?"white":"none"},gt=e=>{if(e==null)return"";const r=String(e).trim().toUpperCase();return r==="P"||r==="PEAK"?"P":r==="1"||r==="P1"||r==="P+1"?"1":r==="2"||r==="P2"||r==="P+2"?"2":r==="3"||r==="P3"||r==="P+3"?"3":""},We=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,Wt=(e,r,o)=>{const j=(e==null?void 0:e.mucusSensation)??(e==null?void 0:e.mucus_sensation),m=(e==null?void 0:e.mucusAppearance)??(e==null?void 0:e.mucus_appearance),s=(e==null?void 0:e.fertility_symbol)??(e==null?void 0:e.fertilitySymbol),c=(e==null?void 0:e.observations)??(e==null?void 0:e.notes),p=pt(j),x=bt(m);let b=We(p.level),I=We(x.level);const $=[];p.reason&&$.push(`S:${p.reason}`),x.reason&&$.push(`M:${x.reason}`);const z=Ht({appearance:m,observations:c,fertilitySymbol:s}),ae=z;let B=z;B==="white"&&(I=Math.max(I,1)),B==="M"&&(I=Math.max(I,2)),B==="M+"&&(I=Math.max(I,3)),B==="F"&&(I=Math.max(I,3),b=Math.max(b,3));const d=He[b]??0,S=He[I]??0,N=Math.max(d,S);B&&B!=="none"&&$.push(`symbol:${B}`);const v=zt[B]??0,P=Bt(Math.max(N,v)),k=r!=null&&Number.isFinite(r)?N>=r+.4-1e-9:!1;k&&$.push("cambioBIP");const R={hasSensation:!!p.hasInput,hasAppearance:!!x.hasInput,hasSymbol:s!=null&&String(s).trim()!==""&&String(s).trim().toLowerCase()!=="none",hasObservation:c!=null&&String(c).trim()!==""};R.hasAny=R.hasSensation||R.hasAppearance||R.hasSymbol||R.hasObservation;const Y=gt((e==null?void 0:e.normalizedPeakStatus)??(e==null?void 0:e.peakStatus)??(e==null?void 0:e.peak_marker));return{index:o,S:b,M:I,symbolDetected:B,rawSymbol:ae,scoreCore:N,scoreFertil:P,hasChangeBIP:k,reasons:$,entryFlags:R,descriptors:{sensation:p.descriptor??p.reason??null,appearance:x.descriptor??x.reason??null},normalizedPeakStatus:Y}},qt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const r=[];for(let m=0;m<Math.min(6,e.length);m+=1){const s=e[m];if(!s||String((s==null?void 0:s.fertility_symbol)||"").toLowerCase()==="red")continue;const p=pt((s==null?void 0:s.mucusSensation)??(s==null?void 0:s.mucus_sensation)),x=bt((s==null?void 0:s.mucusAppearance)??(s==null?void 0:s.mucus_appearance)),b=He[We(p.level)]??0,I=He[We(x.level)]??0;r.push(Math.max(b,I))}const o=r.length>0?Math.max(...r):0;return{days:e.map((m,s)=>Wt(m,o,s)),bipScore:o}},Yt=e=>{for(let r=0;r<e.length;r+=1){const o=e[r];if(o){if(o.symbolDetected==="M+"||o.symbolDetected==="F")return{source:"Alemanas",day:r+1,reason:"M+",kind:"profile"};if(o.M>=2||o.S>=2)return{source:"Alemanas",day:r+1,reason:"S/M>=2",kind:"profile"};if(o.hasChangeBIP)return{source:"Alemanas",day:r+1,reason:"BIP",kind:"profile"}}}return null},Xt=e=>{for(let r=0;r<e.length;r+=1){const o=e[r];if(o){if(o.M>=2)return{source:"OMS",day:r+1,reason:"M>=2",kind:"profile"};if(o.S>=2)return{source:"OMS",day:r+1,reason:"S>=2",kind:"profile"};if(o.symbolDetected==="M+"||o.symbolDetected==="F")return{source:"OMS",day:r+1,reason:"M+",kind:"profile"};if(o.hasChangeBIP)return{source:"OMS",day:r+1,reason:"BIP",kind:"profile"}}}return null},Ut=e=>{for(let r=0;r<e.length;r+=1){const o=e[r];if(o){if(o.symbolDetected==="M+")return{source:"Creighton",day:r+1,reason:"M+",kind:"profile"};if(o.symbolDetected==="M"||o.M>=2)return{source:"Creighton",day:r+1,reason:"M>=2",kind:"profile"};if(o.hasChangeBIP)return{source:"Creighton",day:r+1,reason:"BIP",kind:"profile"}}}return null},Vt=(e,r)=>{const o=e.filter(c=>c&&Number.isFinite(c.day)).map(c=>({...c}));if(o.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:r,usedCandidates:[],notes:["Sin candidatos disponibles"]};const j=[...o].sort((c,p)=>{const x=Number.isFinite(c.day)?c.day:Number.POSITIVE_INFINITY,b=Number.isFinite(p.day)?p.day:Number.POSITIVE_INFINITY;return x-b}),m=j.map(c=>Math.round(c.day));let s=null;if(r==="permisivo")s=Math.max(...m);else if(r==="consenso"){const c=new Map;m.forEach(b=>{const I=c.get(b)??0;c.set(b,I+1)});let p=0,x=null;c.forEach((b,I)=>{(b>p||b===p&&(x==null||I<x))&&(p=b,x=I)}),s=x}else s=Math.min(...m);return{status:s!=null?"ok":"indeterminado",selectedDay:s??null,selectedMode:r,usedCandidates:j,notes:[]}},Gt=({processedData:e=[],config:r={},calculatorCandidates:o=[],context:j={}})=>{var tt,nt,rt,st;const{methods:m={alemanas:!0,oms:!0,creighton:!0},calculators:s={cpm:!0,t8:!0},postpartum:c=!1,combineMode:p="conservador"}=r||{},{peakDayIndex:x=null,postPeakStartIndex:b=null,peakThirdDayIndex:I=null,temperatureInfertileStartIndex:$=null,temperatureConfirmationIndex:z=null,temperatureRule:ae=null,todayIndex:B=null}=j||{},{days:d,bipScore:S}=qt(e),N=Array.isArray(d)?d.length:0,v=t=>Number.isInteger(t)&&t>=0&&t<N,P=t=>{var i;if(!t||N===0)return null;for(let C=N-1;C>=0;C-=1)if(((i=d[C])==null?void 0:i.normalizedPeakStatus)===t)return C;return null};let k=v(x)?x:null;if(k==null){const t=P("P");v(t)&&(k=t)}if(k==null){const t=[{status:"1",offset:1},{status:"2",offset:2},{status:"3",offset:3}];for(const{status:i,offset:C}of t){const V=P(i);if(V==null)continue;const E=V-C;if(v(E)){k=E;break}}}if(k==null&&N>0){let t=null,i=-1/0;for(let C=0;C<N;C+=1){const V=d[C];if(!V)continue;const E=Number.isFinite(V.scoreFertil)?V.scoreFertil:null;E!=null&&(E>i||E===i&&(t==null||C>t))&&(i=E,t=C)}t!=null&&(k=t)}const R=[],Y=t=>{!t||!Number.isFinite(t.day)||R.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};m.alemanas&&Y(Yt(d)),m.oms&&Y(Xt(d)),m.creighton&&Y(Ut(d));const D=[];c&&D.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),c||o.forEach(t=>{if(!t)return;const i=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";(i==="CPM"&&s.cpm||i==="T8"&&s.t8)&&Y({...t,source:i,kind:"calculator"})}),!m.alemanas&&!m.oms&&!m.creighton&&D.push("Ningún perfil sintotérmico seleccionado.");const q=R.map(t=>({...t})),A=Vt(R,p);A.notes=Array.from(new Set([...A.notes??[],...D].filter(Boolean)));const O=t=>{if(!Number.isFinite(t))return null;const i=Math.max(1,Math.round(t));return e.length>0?Math.min(i,e.length):i};let X=Number.isFinite(A.selectedDay)?O(A.selectedDay):null;if(X!=null&&X!==A.selectedDay){const t=`El día calculado (${A.selectedDay}) supera la duración del ciclo. Se usa ${X}.`;A.notes=Array.from(new Set([...A.notes??[],t])),A.selectedDay=X}let G=null;if(Array.isArray(d)&&d.length>0){const t=d.findIndex(i=>(i==null?void 0:i.rawSymbol)==="white");t>=0&&(G=t)}if(Array.isArray(e)&&e.length>0)for(let t=0;t<e.length;t+=1){const i=e[t];if(gt((i==null?void 0:i.normalizedPeakStatus)??(i==null?void 0:i.peakStatus)??(i==null?void 0:i.peak_marker))==="P"){G=G!=null?Math.min(G,t):t;break}}if(G!=null&&(X==null||G+1<X)){const t=O(G+1);t!=null&&(A.selectedDay=t,A.selectedMode="marcador",A.status="ok",A.notes=Array.from(new Set([...A.notes??[],"Inicio fértil ajustado por marcador explícito."])),X=t)}else X=A.selectedDay??null;let te=null;X!=null&&X>=1&&(te=X-1);const Q=d.length>0?d.length-1:null,U=Number.isInteger(te)&&te>=0?te:null;let se=null;if(U!=null&&Q!=null&&Q>=U)if(Number.isInteger(b)){const t=Math.max(U,Math.min(b-1,Q));se=t>=U?t:U}else if(v(k)){const t=Math.min(Q,k+2),i=Math.max(U,t);se=i>=U?i:U}else se=Q;const ye=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,K=t=>Number.isInteger(t)?Q==null||Q<0?t>=0?t:null:t<0?null:t>Q?Q:t:null,he=t=>{var C,V;if(!Number.isInteger(t)||t<0||t>=e.length)return null;const i=(C=e[t])==null?void 0:C.isoDate;if(!i)return null;try{const E=Re(i);return Number.isNaN((V=E==null?void 0:E.getTime)==null?void 0:V.call(E))?null:E}catch{return null}},F=t=>{const i=he(t);if(!i)return null;try{return et(i,"dd/MM")}catch{return null}};let H=(t=>{var i;if(!t)return null;for(let C=0;C<d.length;C+=1)if(((i=d[C])==null?void 0:i.normalizedPeakStatus)===t)return C;return null})("3");H==null&&Number.isInteger(I)&&(H=K(I)),H==null&&Number.isInteger(b)&&(H=K(b-1));let T=null;if(H!=null){const t=K(H+1);t!=null&&(T=t)}const me=K(k),Ie=he(me);if(Ie)for(let t=me+1;t<e.length;t+=1){const i=he(t);if(!i)continue;const C=dt(i,Ie);if(H==null&&C>=3&&(H=K(t)),T==null&&C>=4&&(T=K(t)),H!=null&&T!=null)break}const ce=K(z),pe=K($);let W=ce;if(W==null&&pe!=null){const t=K(pe-1);t!=null&&t>=0&&(W=t)}if(T==null&&H!=null){const t=K(H+1);t!=null&&(T=t)}const ue=H??null;let Z=null;H!=null&&W!=null&&(Z=Math.max(H,W));let ne=null;T!=null&&W!=null&&(ne=Math.max(T,W));let de=null,Se=null;if(Z!=null||ne!=null){const t=Z??Number.NEGATIVE_INFINITY,i=ne??Number.NEGATIVE_INFINITY;Se=Math.max(t,i),ne!=null&&(Z==null||ne>=Z)?de="P+4 y T+3 (OMS)":Z!=null&&(de="P+3 y T+3 (Alemanes)")}if(Se!=null&&U!=null){const t=K(Se);t!=null&&(se=Math.max(U,t))}const oe=se??Q??null,be={conservador:"modo conservador",consenso:"modo consenso",permisivo:"modo permisivo",marcador:"marcador explícito"},Ne=(A==null?void 0:A.selectedMode)??p??"conservador",Ee=(A==null?void 0:A.usedCandidates)??[],Fe=Ee.some(t=>(t==null?void 0:t.kind)==="profile"),re=Ee.some(t=>(t==null?void 0:t.kind)==="calculator"),qe=d.some(t=>{var i,C;return((i=t==null?void 0:t.entryFlags)==null?void 0:i.hasAppearance)||((C=t==null?void 0:t.entryFlags)==null?void 0:C.hasSensation)||(t==null?void 0:t.symbolDetected)});let fe=`Fase fértil abierta (perfil: ${be[Ne]??Ne}).`;Ne==="marcador"?fe="Fase fértil abierta (ajustada por tus marcadores).":Fe&&qe?fe="Fase fértil abierta (basada en tus observaciones de moco).":re&&!Fe&&(fe="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const we="Fase de infertilidad absoluta confirmada(postovulatoria)",ze=`Ventana cerrada por doble criterio: ${de??"criterio indeterminado"}.`,ke=K(k),ve=H!=null||T!=null,n=W!=null,u=ve&&n,a=F(ke),h=F(W),f="Fase de infertilidad postovulatoria (método moco)",w=a?`Fase de infertilidad alcanzada por determinación de día pico el ${a}.`:"Fase de infertilidad alcanzada por determinación de día pico.",L="Ovulación confirmada por temperatura",y=h?`Ovulación confirmada por temperatura el ${h}. La fase de infertilidad absoluta está pendiente de determinar día pico (si se registra).`:"Ovulación confirmada por temperatura. La fase de infertilidad absoluta está pendiente de determinar día pico (si se registra).",g=new Array(d.length).fill(null);let M=null,le=0,ee=null;const je={inicio:0,aumento:1,alta:2,muyAlta:3},Ye=t=>{var C,V;if(!t)return[];const i=[];if(Number.isFinite(t.M)&&t.M>0){const E=(C=t.descriptors)==null?void 0:C.appearance;i.push(`M${t.M}${E?` (${E})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const E=(V=t.descriptors)==null?void 0:V.sensation;i.push(`S${t.S}${E?` (${E})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?i.push("white"):i.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&i.push("cambio BIP"),i},xt=["inicio","aumento","alta","muyAlta"];for(let t=0;t<d.length;t+=1){const i=d[t];if(!i){g[t]=null;continue}const C=U!=null&&oe!=null&&t>=U&&t<=oe,V=Number.isInteger(B)&&B!=null?t>B:!1;if(!C){if(le=0,M=null,oe!=null&&t>oe){if(!ve&&!n){g[t]=null;continue}const Be=!!((tt=i.entryFlags)!=null&&tt.hasAny),Ue=Be?null:"Sin registro hoy; estimación basada en días adyacentes.";let Ae=we,Oe=ze,Ve="absolute";!u&&ve?(Ae=f,Oe=w,Ve="mucus"):!u&&n&&(Ae=L,Oe=y,Ve="temperature"),g[t]={index:t,state:"infertil",status:Ve,title:Ae,header:Ae,body:Oe,detail:de,hasRecord:Be,inherited:!1,note:Ue,isFertile:!1,label:Ae,summaryText:Oe,reasonsList:[],reasonsText:"",showFertilityStatus:!V}}continue}const E=!!((nt=i.entryFlags)!=null&&nt.hasAny);let Te=0;i.normalizedPeakStatus==="P"||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3||i.M>=3?Te=3:i.M>=2||i.S>=2||i.symbolDetected==="M"?Te=2:(i.M>=1||i.S>=1||i.hasChangeBIP)&&(Te=1),E?(le=0,M=Te):le+=1;const lt=i.M>=2||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3,St=ue!=null&&t>=ue&&(W==null||t<=W);let Me=Te,J=null;if(St&&!lt)J="waiting";else{if(!E){const Ue=M??Te,Ae=Math.floor(le/2);Me=Math.max(0,Ue-Ae)}const Be=Math.max(0,Math.min(3,Me));J=xt[Be]}const it=Ye(i),Pe=it.join("; "),_e=ke!=null?t-ke:null,Xe=_e!=null?ye(_e):null,wt=E?null:"Sin registro hoy; estimación basada en días adyacentes.";J!=="waiting"&&(_e===0||_e===1||_e===2?(J="muyAlta",Me=Math.max(Me,3)):_e===3?(je[J]<je.alta&&(J="alta"),Me=Math.max(Me,2)):ee!=null&&t-ee<=3&&(je[J]<je.aumento&&(J="aumento"),Me=Math.max(Me,1))),(J==="alta"||J==="muyAlta"||lt)&&(ee=t);let ge,ie;switch(J){case"waiting":ge="Fertilidad en espera de confirmación por temperatura",ie="Final de moco alcanzado (≥P+3). Ventana mantenida hasta confirmación térmica (T+3).";break;case"aumento":ge="Aumento de fertilidad",ie=Pe?`Signos en aumento: ${Pe}.`:"Signos en aumento.";break;case"alta":ge="Fertilidad alta",ie=Pe?`Signos fértiles claros (${Pe}).`:"Signos fértiles claros.";break;case"muyAlta":{ge="Fertilidad muy alta",ie=`Día de máxima fertilidad${Xe?` (${Xe})`:""}.`,ie+=Pe?` Signos pico: ${Pe}.`:" Signos pico presentes.";break}case"inicio":default:ge="Ventana fértil abierta",ie="Hoy sin signos destacables, a la espera de registrar más datos.";break}E||(J==="alta"?(ge="Fertilidad estimada alta",ie=`${ie} Sin datos apuntados este día; se estima en base a días cercanos.`):J==="muyAlta"?(ge="Fertilidad estimada muy alta",ie=`${ie} Sin datos apuntados este día; se estima en base a días cercanos.`):(J==="aumento"||J==="inicio")&&(ge="Ventana fértil abierta (sin registro hoy)",ie=`${ie} Sin datos apuntados este día; se estima en base a días cercanos.`));const vt={index:t,state:J,level:J==="waiting"?Te:Me,title:ge,header:fe,body:ie,reasonsList:it,reasonsText:Pe,hasRecord:E,inherited:!E,note:wt,isFertile:!0,label:ge,summaryText:ie,delta:Xe,showFertilityStatus:!V,reasonParts:{symbol:i.symbolDetected??null,appearance:((rt=i.descriptors)==null?void 0:rt.appearance)??null,sensation:((st=i.descriptors)==null?void 0:st.sensation)??null}};g[t]=vt}oe!=null&&(se=oe);let $e=null;if(Number.isInteger(B)&&g.length>0){const t=Math.min(Math.max(B,0),g.length-1);let i=null;for(let C=t;C>=0;C-=1){const V=g[C];if(V&&(i||(i=V),V.isFertile)){$e=V;break}}!$e&&i&&($e=i)}const It={bipScore:S,explicitStartDay:G,effectivePeakIndex:k,candidatesBeforeAggregate:q,closureDetail:de,waitingStartIndex:ue,pPlus3Index:H,pPlus4Index:T,temperatureConfirmationIndex:W,temperatureInfertileIndex:pe,temperatureRule:ae??null};return{fertileStartFinalIndex:te,fertileWindow:U!=null&&se!=null?{startIndex:U,endIndex:se,waitingStartIndex:ue,closureDetail:de,temperatureConfirmationIndex:W,temperatureInfertileStartIndex:pe,temperatureRule:ae??null}:null,dailyAssessments:g,currentAssessment:$e,candidates:q,aggregate:A,debug:It}},ct=e=>{if(!e)return null;try{const r=new Date(e);return Number.isNaN(r.getTime())?null:r}catch{return null}},Kt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const o=e.map(c=>{if(!(c!=null&&c.startDate)||!(c!=null&&c.endDate))return null;const p=ct(c.startDate),x=ct(c.endDate);if(!p||!x||x<p)return null;const b=Math.round((x-p)/(1e3*60*60*24))+1;if(!Number.isFinite(b)||b<=0)return null;const I=!!(c!=null&&c.ignoredForAutoCalculations);return{duration:b,ignored:I}}).filter(Boolean).filter(c=>!c.ignored);if(o.length<6)return null;const j=o.reduce((c,p)=>p.duration<c.duration?p:c),m=o.length>=12?20:21,s=j.duration-m;return Number.isFinite(s)?{source:"CPM",day:Math.max(1,Math.round(s)),reason:`ciclo_mas_corto=${j.duration}`,kind:"calculator"}:null},Je=e=>{if(e==null||e==="")return null;const r=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(r)?r:null},Jt=e=>{const r=[e==null?void 0:e.temperature_chart,e==null?void 0:e.temperature_raw,e==null?void 0:e.temperature_corrected];for(const o of r){const j=Je(o);if(j!==null)return j}if(Array.isArray(e==null?void 0:e.measurements)){const o=s=>{if(!s)return null;const c=Je(s.temperature),p=Je(s.temperature_corrected);return s.use_corrected&&p!==null?p:c!==null?c:p!==null?p:null},m=e.measurements.find(s=>s&&s.selected&&o(s)!==null)||e.measurements.find(s=>o(s)!==null);if(m){const s=o(m);if(s!==null)return s}}return null},Qt=(e=[],r)=>{if(!Array.isArray(e)||e.length===0||typeof r!="function")return null;const o=[];if(e.forEach(m=>{if(!(m!=null&&m.data)||!Array.isArray(m.data)||!m.startDate)return;const s=m.data.filter(z=>z&&z.isoDate).map(z=>({...z,displayTemperature:Jt(z)}));if(s.length===0)return;const{ovulationDetails:c}=r(s);if(!(c!=null&&c.confirmed))return;const p=Number.isInteger(c==null?void 0:c.ovulationIndex)?c.ovulationIndex:Number.isInteger(c==null?void 0:c.confirmationIndex)?c.confirmationIndex:null;if(p==null||p<0||p>=s.length)return;const x=s[p],b=Number(x==null?void 0:x.cycleDay);if(!Number.isFinite(b)||b<=0)return;const I=Math.max(1,Math.round(b-8)),$={riseDay:b,t8Day:I,ignored:!!(m!=null&&m.ignoredForAutoCalculations)};!$.ignored&&o.length<12&&o.push($)}),o.length<6)return null;const j=o.reduce((m,s)=>s.t8Day<m.t8Day?s:m);return{source:"T8",day:Math.max(1,Math.round(j.t8Day)),reason:`t8=${j.t8Day}`,kind:"calculator"}},Le={methods:{alemanas:!0,oms:!0,creighton:!0},calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"conservador"},Qe=35.8,Ze=37.2,ut=(e=[])=>{var B;const r=d=>d&&d.displayTemperature!=null&&!d.ignored,m=d=>{if(!d||d.length!==6)return null;const S=d.map(P=>P.temp);if(S.some(P=>!Number.isFinite(P)))return null;const N=S.reduce((P,k)=>k>P?k:P,S[0]),v=S.reduce((P,k)=>k>=N-.05&&k<N?P+1:P,0);return v>=2?null:{baselineTemp:N,baselineStartIndex:d[0].index,baselineIndices:d.map(P=>P.index),baselineBorderlineCount:v}},s=d=>{const S=[];for(let N=d;N<e.length;N+=1){const v=e[N];if(!r(v))continue;const P=v.displayTemperature;if(Number.isFinite(P)&&(S.push({index:N,temp:P}),S.length>6&&S.shift(),S.length===6)){const k=m(S);if(!k)continue;let R=null;for(let Y=N+1;Y<e.length;Y+=1){const D=e[Y];if(!r(D))continue;const q=D.displayTemperature;if(Number.isFinite(q)&&q>k.baselineTemp){R=Y;break}}return{baselineTemp:k.baselineTemp,baselineStartIndex:k.baselineStartIndex,baselineIndices:k.baselineIndices,baselineBorderlineCount:k.baselineBorderlineCount,firstHighIndex:R}}}return null},c={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let p=null,x=null,b=null,I=[],$=c,z=0;const ae=({baselineTemp:d,firstHighIndex:S})=>{if(S==null)return{confirmed:!1};const N=d+.2,v=[],P=[],k=new Set,R=O=>{O==null||k.has(O)||(k.add(O),P.push(O))};let Y=null,D=!1;const q=S>0?S-1:null,A=()=>q!=null?[q,...P]:[...P];for(let O=S;O<e.length;O++){const X=e[O];if(!r(X))break;const G=X.displayTemperature;if(!Number.isFinite(G))break;if(G>d){if(R(O),v.push({index:O,temp:G}),v.length===3&&v[2].temp>=N)return{confirmed:!0,confirmationIndex:v[2].index,usedIndices:A(),highSequenceIndices:[...P],rule:"3-high"};if(v.length===4&&v[2].temp<N&&v[3].temp>d)return{confirmed:!0,confirmationIndex:v[3].index,usedIndices:A(),highSequenceIndices:[...P],rule:"german-3+1"};if(Y!==null&&v.length===3&&v[2].temp>=N)return{confirmed:!0,confirmationIndex:v[2].index,usedIndices:A(),highSequenceIndices:[...P],rule:"german-2nd-exception"};if(v.length===5&&v[3].temp>d&&v[4].temp>=N)return{confirmed:!0,confirmationIndex:v[4].index,usedIndices:A(),highSequenceIndices:[...P],rule:"5-high"};continue}if(G>=d-.05&&Y===null&&v.length>0&&v.length<3){Y=O,R(O),v.push({index:O,temp:d});continue}if(!D&&v.length>0&&v.length<3){D=!0,R(O);continue}break}return{confirmed:!1,usedIndices:A(),highSequenceIndices:[...P]}};for(;z<e.length;){const d=s(z);if(!d)break;if(p=d.baselineTemp,x=d.baselineStartIndex,I=Array.isArray(d.baselineIndices)?[...d.baselineIndices]:[],b=d.firstHighIndex,d.baselineBorderlineCount,b==null){z=x+1;continue}const S=ae(d);if(S!=null&&S.requireRebaseline){z=x+1;continue}if(S!=null&&S.confirmed){const N=(B=S.highSequenceIndices)!=null&&B.length?S.highSequenceIndices[0]:null,v=Number.isInteger(S.confirmationIndex)?Math.max(0,Math.min(S.confirmationIndex,e.length-1)):null;let P=null;if(v!=null){const k=v+1;P=Math.max(0,Math.min(k,e.length-1))}$={confirmed:!0,confirmationIndex:v,infertileStartIndex:P,rule:S.rule,highSequenceIndices:S.highSequenceIndices??S.usedIndices,usedIndices:S.usedIndices,ovulationIndex:b??N??null};break}z=x+1}return{baselineTemp:p,baselineStartIndex:x,firstHighIndex:b,baselineIndices:I,ovulationDetails:$}},rn=(e,r,o,j,m,s=5,c=!1,p=null,x=[],b=null)=>{const I=_.useRef(null),$=_.useRef(null),[z,ae]=_.useState({width:0,height:0}),[B,d]=_.useState(null),[S,N]=_.useState({x:0,y:0}),[v,P]=_.useState(null),k=_.useCallback(()=>{d(null),P(null)},[]),R=n=>{if(n==null)return"";const u=String(n).trim().toUpperCase();return u==="P"||u==="PEAK"?"P":u==="1"||u==="P1"||u==="P+1"?"1":u==="2"||u==="P2"||u==="P+2"?"2":u==="3"||u==="P3"||u==="P+3"?"3":""},Y=_.useMemo(()=>Dt(e),[e]),D=_.useMemo(()=>{const n=a=>{if(a==null||a==="")return null;const h=parseFloat(String(a).replace(",","."));return Number.isFinite(h)?h:null},u=a=>{if(!a)return null;const h=n(a.temperature),f=n(a.temperature_corrected);return a.use_corrected&&f!==null?f:h!==null?h:f!==null?f:null};return e.map(a=>{const h=[a==null?void 0:a.temperature_chart,a==null?void 0:a.temperature_raw,a==null?void 0:a.temperature_corrected];let f=null;for(const M of h)if(M!=null&&M!==""){f=M;break}if(f==null&&Array.isArray(a==null?void 0:a.measurements)){const le=a.measurements.find(ee=>ee&&ee.selected&&u(ee)!==null)||a.measurements.find(ee=>u(ee)!==null);le&&(f=u(le))}const w=a==null?void 0:a.isoDate,L=(a==null?void 0:a.peak_marker)??(a==null?void 0:a.peakStatus)??null,y=w?Y[w]??L:L,g=R(y);return{...a,displayTemperature:n(f),peakStatus:y??null,normalizedPeakStatus:g}})},[e,Y]),q=_.useMemo(()=>{if(!Array.isArray(D)||D.length===0)return null;const n=new Date;let u=null;return D.forEach((a,h)=>{var f;if(a!=null&&a.isoDate)try{const w=Re(a.isoDate);if(Number.isNaN((f=w==null?void 0:w.getTime)==null?void 0:f.call(w)))return;dt(w,n)<=0&&(u=h)}catch{}}),u},[D]);_.useLayoutEffect(()=>{const n=()=>{if(!I.current)return;const a=I.current.parentElement||I.current;let h=a.clientWidth||600,f=a.clientHeight||400,w=I.current.clientWidth>0?I.current.clientWidth:h,L,y;if(r){let g=window.innerWidth,M=window.innerHeight;if(c&&M>g&&([g,M]=[M,g]),w=g,o==="portrait"&&!c){const le=Math.max(30,g*.05);L=(g-le)/s*e.length}else L=g/s*e.length;y=M}else L=w/s*e.length,y=f;ae({width:L,height:y})};n(),window.addEventListener("resize",n);let u;if(I.current){const a=I.current.parentElement||I.current;u=new ResizeObserver(n),u.observe(a)}return()=>{window.removeEventListener("resize",n),u&&u.disconnect()}},[r,e.length,s,o,c]);const A=_.useMemo(()=>D.filter(n=>n&&n.isoDate&&!n.ignored&&n.displayTemperature!==null&&n.displayTemperature!==void 0),[D]),O=_.useMemo(()=>D.filter(n=>n&&n.isoDate),[D]),X=A.length>0,G=_.useMemo(()=>!Array.isArray(D)||D.length===0?!1:D.some(n=>n?n.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(w=>{const L=n==null?void 0:n[w];return L!=null&&String(L).trim()!==""})||(()=>{const w=(n==null?void 0:n.fertility_symbol)??(n==null?void 0:n.fertilitySymbol);return w==null?!1:String(w).trim()!==""})()||(()=>{const w=(n==null?void 0:n.observations)??(n==null?void 0:n.notes);return w==null?!1:String(w).trim()!==""})()?!0:R((n==null?void 0:n.normalizedPeakStatus)??(n==null?void 0:n.peakStatus)??(n==null?void 0:n.peak_marker))!=="":!1),[D]),te=_.useMemo(()=>{var y,g,M,le,ee;const n=p??{},u=(je,Ye)=>typeof je=="boolean"?je:Ye,a={alemanas:u((y=n==null?void 0:n.methods)==null?void 0:y.alemanas,Le.methods.alemanas),oms:u((g=n==null?void 0:n.methods)==null?void 0:g.oms,Le.methods.oms),creighton:u((M=n==null?void 0:n.methods)==null?void 0:M.creighton,Le.methods.creighton)},h={cpm:u((le=n==null?void 0:n.calculators)==null?void 0:le.cpm,Le.calculators.cpm),t8:u((ee=n==null?void 0:n.calculators)==null?void 0:ee.t8,Le.calculators.t8)},w=new Set(["conservador","consenso","permisivo"]).has(n==null?void 0:n.combineMode)?n.combineMode:Le.combineMode,L=!!(n!=null&&n.postpartum);return{methods:a,calculators:h,combineMode:w,postpartum:L}},[p]),Q=_.useMemo(()=>{if(Array.isArray(b)&&b.length>0)return b.map(h=>{if(!h)return null;const{source:f,day:w,reason:L}=h,y=typeof f=="string"?f.toUpperCase().replace(/-/g,""):"";if(y!=="CPM"&&y!=="T8")return null;const g=Number(w);return Number.isFinite(g)?{source:y,originalSource:f??y,day:g,reason:typeof L=="string"?L:"",kind:"calculator"}:null}).filter(Boolean);const n=Array.isArray(x)?x:[];if(!n.length)return[];const u=Kt(n),a=Qt(n,ut);return[u,a].filter(Boolean)},[b,x]),{peakDayIndex:U,thirdDayIndex:se,peakInfertilityStartIndex:ye}=_.useMemo(()=>{if(!O.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const n=O.map(h=>(h==null?void 0:h.normalizedPeakStatus)??R((h==null?void 0:h.peakStatus)??(h==null?void 0:h.peak_marker)));let u=null,a=null;if(n.forEach((h,f)=>{h==="P"&&u==null&&(u=f),h==="3"&&a==null&&(a=f)}),u==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(a!=null){const h=O.length-1,f=Math.min(a+1,h);return{peakDayIndex:u,thirdDayIndex:a,peakInfertilityStartIndex:f}}return{peakDayIndex:u,thirdDayIndex:null,peakInfertilityStartIndex:null}},[O]),{baselineTemp:K,baselineStartIndex:he,firstHighIndex:F,baselineIndices:Ce,ovulationDetails:H}=_.useMemo(()=>ut(D),[D]),T=_.useMemo(()=>({...H??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:K,baselineIndices:Ce,baselineStartIndex:he,firstHighIndex:F,peakDayIndex:U,peakInfertilityStartIndex:ye,thirdDayIndex:se}),[H,K,Ce,he,F,U,ye,se]),me=_.useMemo(()=>Gt({processedData:D,config:te,calculatorCandidates:Q,context:{peakDayIndex:U,postPeakStartIndex:ye,peakThirdDayIndex:(T==null?void 0:T.thirdDayIndex)??null,temperatureInfertileStartIndex:(T==null?void 0:T.infertileStartIndex)??null,temperatureConfirmationIndex:(T==null?void 0:T.confirmationIndex)??null,temperatureRule:(T==null?void 0:T.rule)??null,todayIndex:q}}),[D,te,Q,T==null?void 0:T.thirdDayIndex,T==null?void 0:T.infertileStartIndex,T==null?void 0:T.confirmationIndex,T==null?void 0:T.rule,U,ye,q]),Ie=_.useMemo(()=>D.map((n,u)=>{var w;if(!n)return n;const a=Number.isInteger(q)?u>q:!1,h=((w=me==null?void 0:me.dailyAssessments)==null?void 0:w[u])??null,f=h?{...h,showFertilityStatus:h.showFertilityStatus!==!1&&!a}:null;return f?{...n,fertilityAssessment:f,isFutureDay:a}:{...n,isFutureDay:a}}),[D,me,q]),ce=_.useMemo(()=>Ie.filter(n=>n&&n.isoDate),[Ie]),{tempMin:pe,tempMax:W}=_.useMemo(()=>{const n=A.map(g=>g.displayTemperature).filter(g=>g!=null);if(n.length===0)return{tempMin:Qe,tempMax:Ze};const u=Ze-Qe,a=Math.min(...n),h=Math.max(...n);let f=Math.min(a,Qe),w=Math.max(h,Ze);const L=g=>Math.floor(g*10)/10,y=g=>Math.ceil(g*10)/10;if(f=L(f),w=y(w),w-f<u){const g=(f+w)/2;f=L(g-u/2),w=y(g+u/2)}return Math.abs(f-a)<1e-9&&(f=L(f-.1)),Math.abs(w-h)<1e-9&&(w=y(w+.1)),{tempMin:parseFloat(f.toFixed(1)),tempMax:parseFloat(w.toFixed(1))}},[A]),ue=W-pe,Z=z.width,ne=z.height,de=9,Se=(n=1)=>{if(!r)return de*n;const u=Math.min(Z,ne);return Math.max(8,Math.min(de*n,u/(ce.length>0?40/n:40)))},oe=Math.round(Se(r?1.6:2)),be=c||o==="landscape",Fe=Math.round(oe*((r?9:7.5)+(r?1:.75))),re={top:r?Math.max(be?6:12,ne*(be?.015:.03)):12,right:r?Math.max(be?35:30,Z*(be?.02:.05)):50,bottom:Math.max(0,Fe-1),left:r?Math.max(be?45:20,Z*(be?.02:.05)):50},fe=Math.max(0,Math.round(oe*4)),we=ne-re.bottom-fe,De=n=>{const u=ne-re.top-re.bottom-fe;return n==null||ue===0||u<=0?we:we-(n-pe)/ue*u},ze=n=>{const u=r&&!(c||o==="landscape")?5:10,a=r&&!(c||o==="landscape")?25:0,h=Z-re.left-re.right-u-a*(ce.length-1);if(h<=0)return re.left+u+a*n;const f=ce.length>1?ce.length-1:1;return f===0||ce.length===0?re.left+u+a*n:re.left+u+n*(h/(ce.length===1?1:f))+a*n},ke=(n,u,a)=>{if(!n){k();return}const h=I.current.getBoundingClientRect();let f,w;if(a.type.startsWith("touch")){const M=a.changedTouches[0];f=M.clientX,w=M.clientY}else f=a.clientX,w=a.clientY;const L=ze(u),y=n.displayTemperature??n.temperature_chart??null,g=De(y);N({svgX:L,svgY:g,clientX:f-h.left+I.current.scrollLeft,clientY:w-h.top+I.current.scrollTop}),P(u),d(n)};return _.useEffect(()=>{const n=u=>{var a;if($.current&&!$.current.contains(u.target)){const h=(a=I.current)==null?void 0:a.querySelectorAll("circle, text, rect");let f=!1;if(h){for(let w of h)if(w.contains(u.target)){f=!0;break}}f||k()}};return B&&(document.addEventListener("mousedown",n),document.addEventListener("touchstart",n)),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}},[B,k]),{chartRef:I,tooltipRef:$,dimensions:z,activePoint:B,activeIndex:v,tooltipPosition:S,processedData:Ie,validDataForLine:A,allDataPoints:ce,tempMin:pe,tempMax:W,tempRange:ue,padding:re,textRowHeight:oe,setActivePoint:d,setActiveIndex:P,getY:De,getX:ze,handlePointInteraction:ke,clearActivePoint:k,handleToggleIgnore:n=>{j&&n&&(j(m,n),k())},responsiveFontSize:Se,baselineTemp:K,baselineStartIndex:he,baselineIndices:Ce,firstHighIndex:F,ovulationDetails:T,fertilityStart:me,hasTemperatureData:X,hasAnyObservation:G,graphBottomInset:fe,todayIndex:q}};export{nn as C,Lt as O,ut as c,rn as u};
