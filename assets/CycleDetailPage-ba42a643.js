import{c as ge,j as e,m as H,r as o,p as m,f as C,C as ye,B as k,h as be,a as ve,u as je,b as we,L as X,g as De,s as ee,d as Ne}from"./index-c55d5272.js";import{e as Ce,B as J,P as ke}from"./badge-537eb28b.js";import{c as Ee,T as Se,b as _e,d as Oe,e as Pe,P as Le,F as ae,D as Re}from"./computePeakStatuses-31c2acae.js";import{a as Te}from"./eye-eb92638a.js";import{P as Ie,T as te}from"./trash-2-a6e4167a.js";import{D as se}from"./DeletionDialog-e7abebfe.js";import{C as Ae}from"./CycleDatesEditor-71225023.js";import{O as $e}from"./OverlapWarningDialog-c9e8ec86.js";import{u as ze,D as Fe,a as Me}from"./useCycleData-5dcb71a4.js";import{A as qe}from"./arrow-left-b07553e7.js";import"./input-e74c5c89.js";import"./label-43470110.js";import"./checkbox-423022af.js";const Be=ge("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),Ue=({records:i,onEdit:x,onDelete:d,isProcessing:c,selectedDate:b})=>{if(!i||i.length===0)return e.jsx(H.div,{className:"text-center py-12",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"bg-white/70 backdrop-blur-md rounded-3xl p-8 border border-pink-200/50 shadow-lg mx-4",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center",children:e.jsx(Te,{className:"w-8 h-8 text-pink-500"})}),e.jsx("h3",{className:"text-xl font-semibold text-slate-700 mb-2",children:"No hay registros"}),e.jsx("p",{className:"text-slate-500",children:"Añade tu primer registro para comenzar."})]})});const A=s=>ae.find(h=>h.value===s)||ae[0],$=o.useMemo(()=>Ee(i),[i]),O={P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"},z=o.useMemo(()=>{if(!(i!=null&&i.length))return[];const s=[...i].sort((h,l)=>m(l.isoDate)-m(h.isoDate));if(b){const h=s.findIndex(l=>l.isoDate===b);if(h>0){const[l]=s.splice(h,1);s.unshift(l)}}return s},[i,b]);return e.jsx(H.div,{className:"space-y-3",variants:{hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.05}}},initial:"hidden",animate:"show",children:z.map((s,h)=>{var E;const l=A(s.fertility_symbol),a=((E=s.measurements)==null?void 0:E.find(p=>p.selected))||(s.temperature_chart||s.temperature_raw?{temperature:s.temperature_chart??s.temperature_raw,temperature_corrected:s.temperature_corrected??null,time:s.timestamp?C(m(s.timestamp),"HH:mm"):null,use_corrected:s.use_corrected??!1}:null),j=(a==null?void 0:a.use_corrected)??s.use_corrected??!1,f=(a==null?void 0:a.temperature_corrected)??s.temperature_corrected??null,w=(a==null?void 0:a.temperature)??s.temperature_chart??s.temperature_raw??null,P=j&&f!==null?f:w??f,v=P!==null,D=P,L=j&&f!==null,g=$[s.isoDate],u=g&&O[g]||null,F=b===s.isoDate;return e.jsx(H.div,{className:`bg-white/80 backdrop-blur-md border border-pink-200/50 shadow-lg hover:shadow-xl transition-all duration-300 hover:bg-white/90 rounded-xl ${F?"ring-2 ring-rose-400 shadow-xl shadow-rose-200/70":""}`,variants:{hidden:{opacity:0,y:20},show:{opacity:1,y:0}},children:e.jsxs("div",{className:"p-3 shadow-md",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ye,{className:"w-5 h-5 text-pink-500 flex-shrink-0"}),e.jsx("span",{className:"font-semibold text-slate-700 text-lg",children:C(m(s.isoDate),"dd/MM/yyyy",{locale:Ce})}),e.jsxs("span",{className:"text-md text-pink-500",children:["Día ",s.cycleDay]}),u&&e.jsx(J,{className:"ml-2 bg-rose-100 text-rose-600 border border-rose-200",children:u})]}),e.jsx("div",{className:"flex items-center space-x-1 ml-2",children:e.jsx("div",{className:`w-6 h-6 rounded-full border border-slate-300 ${l.color} ${l.pattern?"pattern-bg":""} flex-shrink-0`,style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"}})})]}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs text-slate-800",children:[e.jsxs("div",{className:"flex items-center space-x-1 border border-amber-500 px-2 py-1.5 rounded-lg",children:[e.jsx(Se,{className:"w-4 h-4 bg-amber-500 rounded-full text-white"}),e.jsx("span",{className:"font-medium",children:v?`${D}°C`:""}),L&&e.jsx("span",{className:"w-1 h-1 rounded-full bg-amber-500 shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"}),v&&s.ignored&&e.jsx(J,{variant:"secondary",className:"text-xs py-0 px-1 bg-orange-200 text-slate-700",children:"Ignorada"})]}),e.jsx("div",{className:"flex items-center space-x-1  border border-gray-400 px-2 py-1.5 rounded-lg",children:(a==null?void 0:a.time)&&e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"w-3 h-3 text-gray-600"}),e.jsx("span",{children:a.time})]})})]}),Array.isArray(s.measurements)&&s.measurements.length>1&&e.jsx("div",{className:"mt-2 text-xs text-slate-600 space-y-1",children:s.measurements.map((p,_)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:p.time}),e.jsx("span",{children:p.temperature}),p.selected&&e.jsx(J,{className:"ml-1",variant:"secondary",children:"Principal"})]},_))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs text-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2 border border-blue-600/40 px-2 py-1.5 rounded-lg",children:[e.jsx("div",{className:"w-5 h-5 bg-gradient-to-br from-blue-500/90 to-indigo-600/90 rounded-lg flex items-center justify-center shadow-md",children:e.jsx(Oe,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-semibold text-blue-800 truncate",children:s.mucus_sensation||s.mucusSensation||""})]}),e.jsxs("div",{className:"flex items-center gap-2  border border-emerald-500 px-2 py-1.5 rounded-lg",children:[e.jsx("div",{className:"w-5 h-5 bg-gradient-to-br from-emerald-500/90 to-teal-600/90 rounded-lg flex items-center justify-center shadow-md",children:e.jsx(Pe,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-semibold text-green-800 truncate",children:s.mucus_appearance||s.mucusAppearance||""})]})]}),e.jsxs("div",{className:"mt-2 grid grid-cols-[1fr_auto] gap-2 items-start text-xs text-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2 border border-violet-500/40 px-2 py-1.5 rounded-lg",children:[e.jsx("div",{className:"w-5 h-5 bg-gradient-to-br from-violet-500/90 to-purple-600/90 rounded-lg flex items-center justify-center shadow-md",children:e.jsx(Le,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-semibold text-violet-800 truncate",children:s.observations||""})]}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(k,{type:"button",onClick:()=>x(s),variant:"outline",size:"sm",className:"h-8 w-8 p-0 bg-slate-100 border-pink-300 text-pink-600 hover:bg-pink-50 hover:border-pink-400",disabled:c,children:e.jsx(Ie,{className:"h-3 w-3"})}),e.jsx(k,{type:"button",onClick:()=>d(s.id),variant:"outline",size:"sm",className:"h-8 w-8 p-0 border-rose-300 text-rose-600 hover:bg-rose-800 hover:border-rose-800",disabled:c,children:e.jsx(te,{className:"h-3 w-3"})})]})]})]})},s.id)})})},He=(i,x)=>{const d=ee(m(i)),c=ee(m(x));return Ne(d,c)+1},Je=(i,x)=>!i||!Array.isArray(i)||!x?[]:[...i].sort((c,b)=>m(c.isoDate)-m(b.isoDate)).map(c=>({...c,ignored:c.ignored||!1,cycleDay:He(c.isoDate,x)})),ia=()=>{const{cycleId:i}=be(),x=ve(),{user:d}=je(),{getCycleById:c,isLoading:b,addOrUpdateDataPoint:A,deleteRecord:$,updateCycleDates:O,deleteCycle:z,checkCycleOverlap:s,forceUpdateCycleStart:h}=ze(),{toast:l}=we(),[a,j]=o.useState(null),[f,w]=o.useState(null),[P,v]=o.useState(!1),[D,L]=o.useState(null),[g,u]=o.useState(!1),[F,E]=o.useState(!1),[p,_]=o.useState(!1),[S,R]=o.useState(""),[T,I]=o.useState(""),[re,N]=o.useState(""),[W,M]=o.useState(!1),[Y,q]=o.useState(null),[V,B]=o.useState(null),Z=a?`${C(m(a.startDate),"dd/MM/yyyy")} - ${a.endDate?C(m(a.endDate),"dd/MM/yyyy"):"En curso"}`:"",U=o.useCallback(t=>{if(!d||!(t!=null&&t.id))return;const r={...t,data:(t.data||[]).map(({cycleDay:y,...n})=>n)};localStorage.setItem(`fertilityData_cycle_${d.uid}_${t.id}`,JSON.stringify(r))},[d]);o.useEffect(()=>{(async()=>{if(!d)return;let r=await c(i);if(!r){const y=localStorage.getItem(`fertilityData_cycle_${d.uid}_${i}`);if(y){const n=JSON.parse(y);r={...n,data:Je(n.data||[],n.startDate)}}}r?j(r):(l({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),x("/archived-cycles"))})()},[i,d,c,l,x]),o.useEffect(()=>{a&&(R(a.startDate||""),I(a.endDate||""))},[a]);const ie=async(t,{keepFormOpen:r=!1}={})=>{if(!a||!d)return;const y=!!f;u(!0);try{await A(t,f,a.id);const n=await c(a.id);n&&(U(n),j(n)),l({title:y?"Registro actualizado":"Nuevo registro añadido",description:"Datos para el ciclo actualizados."}),r||(v(!1),w(null))}catch(n){console.error("Error adding/updating data point:",n),l({title:"Error",description:"No se pudo guardar el registro.",variant:"destructive"})}finally{u(!1)}},le=async t=>{if(!(!a||!d)){u(!0);try{await $(t,a.id);const r=await c(a.id);r&&(U(r),j(r)),l({title:"Registro eliminado",description:"El registro ha sido eliminado."})}catch(r){console.error("Error deleting record:",r),l({title:"Error",description:"No se pudo eliminar el registro.",variant:"destructive"})}finally{u(!1)}}},oe=async({startDate:t,endDate:r,force:y})=>{if(!a||!d)return!1;u(!0);try{y?(await h(a.id,t),r!==void 0&&await O(a.id,void 0,r)):await O(a.id,t,r);const n=await c(a.id);return n&&(U(n),j(n)),l({title:"Fechas actualizadas",description:"Las fechas del ciclo han sido modificadas."}),!0}catch(n){return console.error(n),l({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"}),!1}finally{u(!1)}},ne=()=>{a&&E(!0)},ce=async()=>{if(!(!a||!d)){u(!0);try{await z(a.id),l({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),x("/archived-cycles"),E(!1)}catch(t){console.error(t),l({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{u(!1)}}},de=()=>{!p&&a&&(R(a.startDate||""),I(a.endDate||""),N("")),_(t=>!t)},me=()=>{a&&(R(a.startDate||""),I(a.endDate||"")),N(""),_(!1)},G=async t=>{await oe(t)&&(_(!1),N(""))},ue=async()=>{if(!S){N("La fecha de inicio es obligatoria");return}if(T&&T<S){N("La fecha de fin no puede ser anterior al inicio");return}N("");const t={startDate:S,endDate:T||void 0};if(s&&(a!=null&&a.id)&&S){const r=await s(a.id,S);if(r){q(t),B(r),M(!0);return}}await G(t)},K=async()=>{Y&&await G({...Y,force:!0}),M(!1),q(null),B(null)},Q=()=>{M(!1),q(null),B(null)},pe=t=>{w(t),v(!0)},xe=()=>{w(null),v(!0)},he=t=>{if(!a)return;const r=(a.data||[]).find(y=>y.id===t);L(r||null)},fe=()=>{D&&le(D.id)};return b&&!a||!a?e.jsx("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-pink-600",children:e.jsx("p",{children:"Cargando detalles del ciclo..."})}):e.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"relative z-10 px-4 py-6",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto",children:[e.jsx("div",{className:"space-y-4 mb-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx(k,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:e.jsxs(X,{to:"/archived-cycles",children:[e.jsx(qe,{className:"mr-2 h-4 w-4"})," Mis Ciclos"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{asChild:!0,variant:"outline",size:"icon",className:"border-pink-300 text-pink-600 hover:bg-pink-50 hover:border-pink-400",children:e.jsx(X,{to:`/chart/${a.id}`,"aria-label":"Ver gráfica del ciclo",children:e.jsx(De,{className:"h-4 w-4"})})}),e.jsx(k,{type:"button",variant:"outline",size:"icon",onClick:de,"aria-pressed":p,"aria-label":p?"Ocultar opciones del ciclo":"Editar ciclo",className:`border-pink-300 text-pink-600 hover:bg-pink-50 hover:border-pink-400 ${p?"bg-pink-50":""}`,children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(k,{onClick:xe,size:"icon",className:"bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow","aria-label":"Añadir registro al ciclo",children:e.jsx(ke,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"rounded-3xl p-4 ",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"flex flex-col gap-1",children:e.jsxs("h2",{className:"text-2xl sm:text-3xl font-bold text-rose-700",children:["Detalle de ciclo (",C(m(a.startDate),"dd/MM/yyyy")," -"," ",a.endDate?C(m(a.endDate),"dd/MM/yyyy"):"En curso",")"]})}),p&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ae,{cycle:a,startDate:S,endDate:T,onStartDateChange:t=>R(t),onEndDateChange:t=>I(t),onSave:ue,onCancel:me,isProcessing:g,dateError:re,includeEndDate:!0,showOverlapDialog:W,overlapCycle:V,onConfirmOverlap:K,onCancelOverlap:Q,onClearError:()=>N(""),className:"w-full"}),e.jsxs("div",{className:"rounded-2xl border border-rose-100 bg-white p-5 shadow",children:[e.jsx("h3",{className:"text-lg font-semibold text-rose-700 mb-2",children:"Eliminar ciclo"}),e.jsx("p",{className:"text-sm text-slate-600 mb-3",children:"Esta acción no se puede deshacer. Se eliminarán todos los registros asociados."}),e.jsxs(k,{onClick:ne,disabled:g,className:"w-full sm:w-auto bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600 text-white shadow-md",children:[e.jsx(te,{className:"mr-2 h-4 w-4"})," Eliminar ciclo"]})]})]})]})})]})}),e.jsx("div",{className:"mt-6",children:e.jsx(Ue,{records:a.data,onEdit:pe,onDelete:he,isProcessing:g})}),e.jsx(Fe,{open:P,onOpenChange:t=>{t||(v(!1),w(null))},children:e.jsx(Me,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Re,{onSubmit:ie,initialData:f,onCancel:()=>{v(!1),w(null)},cycleStartDate:a.startDate,cycleEndDate:a.endDate,isProcessing:g,isEditing:!!f,cycleData:a.data})})}),e.jsx(se,{isOpen:!!D,onClose:()=>L(null),onConfirm:fe,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:D?`¿Estás seguro de que quieres eliminar el registro del ${C(m(D.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:g}),e.jsx(se,{isOpen:F,onClose:()=>E(!1),onConfirm:ce,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:Z?`¿Estás seguro de que quieres eliminar el ciclo ${Z}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:g}),e.jsx($e,{isOpen:W,conflictCycle:V,onCancel:Q,onConfirm:K})]})})]})};export{ia as default};
