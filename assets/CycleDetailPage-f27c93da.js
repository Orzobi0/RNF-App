import{c as F,q as T,a as J,u as V,b as H,r as o,g as S,f as m,j as a,B as y,L as R,o as W,l as L,k as Z}from"./index-2f41c8cd.js";import{D as G}from"./DeletionDialog-31da8265.js";import{u as K}from"./useCycleData-9f76d19f.js";import{RecordsExperience as Q}from"./RecordsPage-689fc63f.js";import{A as X}from"./arrow-left-da98c05b.js";import{P as Y}from"./badge-4c7d2230.js";import"./NewCycleDialog-c52b1f5b.js";import"./OverlapWarningDialog-038e0dd4.js";import"./input-c95d25ec.js";import"./computePeakStatuses-8ec0bab9.js";import"./label-270ed458.js";import"./checkbox-2e1f35be.js";import"./eye-fe5b932b.js";const ee=F("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),se=(r,d)=>{const t=L(m(r)),l=L(m(d));return Z(t,l)+1},te=(r,d)=>!r||!Array.isArray(r)||!d?[]:[...r].sort((l,p)=>m(l.isoDate)-m(p.isoDate)).map(l=>({...l,ignored:l.ignored||!1,cycleDay:se(l.isoDate,d)})),ye=()=>{const{cycleId:r}=T(),d=J(),{user:t}=V(),{getCycleById:l,isLoading:p,addOrUpdateDataPoint:x,deleteRecord:b,updateCycleDates:v,deleteCycle:D,checkCycleOverlap:$,forceUpdateCycleStart:w,refreshData:j}=K(),{toast:u}=H(),[e,N]=o.useState(null),[A,C]=o.useState(!1),[k,E]=o.useState(!1),f=e?`${S(m(e.startDate),"dd/MM/yyyy")} - ${e.endDate?S(m(e.endDate),"dd/MM/yyyy"):"En curso"}`:"",g=o.useCallback(s=>{if(!t||!(s!=null&&s.id))return;const i={...s,data:(s.data||[]).map(({cycleDay:c,...n})=>n)};localStorage.setItem(`fertilityData_cycle_${t.uid}_${s.id}`,JSON.stringify(i))},[t]),h=o.useCallback(async()=>{if(!t||!r)return null;const s=await l(r);return s&&(g(s),N(s)),s},[r,l,g,t]);o.useEffect(()=>{(async()=>{if(!t)return;let i=await l(r);if(!i){const c=localStorage.getItem(`fertilityData_cycle_${t.uid}_${r}`);if(c){const n=JSON.parse(c);i={...n,data:te(n.data||[],n.startDate)}}}i?(g(i),N(i)):(u({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),d("/archived-cycles"))})()},[r,t,l,u,d]);const O=o.useCallback(async(s,i)=>{if(!(e!=null&&e.id)||!t)return;const c=!!i;await x(s,i,e.id),await h()&&u({title:c?"Registro actualizado":"Nuevo registro añadido",description:"Datos del ciclo actualizados."})},[e==null?void 0:e.id,t,x,h,u]),P=o.useCallback(async s=>{!(e!=null&&e.id)||!t||(await b(s,e.id),await h(),u({title:"Registro eliminado",description:"El registro ha sido eliminado."}))},[e==null?void 0:e.id,t,b,h,u]),q=o.useCallback(async(s,i,c)=>{const n=s??(e==null?void 0:e.id);!t||!n||await v(n,i,c)},[e==null?void 0:e.id,t,v]),I=o.useCallback(async(s,i)=>{const c=s??(e==null?void 0:e.id);!t||!c||await w(c,i)},[e==null?void 0:e.id,t,w]),U=o.useCallback(async s=>{await j(s),await h()},[j,h]),z=()=>{C(!0)},M=o.useCallback(async()=>{if(!(!(e!=null&&e.id)||!t)){E(!0);try{await D(e.id),u({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),d("/archived-cycles")}catch(s){console.error(s),u({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{E(!1),C(!1)}}},[e==null?void 0:e.id,D,d,u,t]),_=o.useCallback(()=>a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(y,{asChild:!0,variant:"outline",size:"icon",className:"shrink-0 ml-2 rounded-full border-fertiliapp-fuerte text-fertiliapp-fuerte hover:brightness-95",children:a.jsxs(R,{to:"/archived-cycles","aria-label":"Volver a mis ciclos",children:[a.jsx(X,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Mis ciclos"})]})}),a.jsx("div",{className:"items-center justify-center px-4 py-3",children:a.jsxs("h2",{className:"text-2xl font-semibold text-titulo truncate",children:[e!=null&&e.name?`${e.name} · `:"",f]})})]}),[e==null?void 0:e.name,f]),B=o.useCallback(({openDateEditor:s,openAddRecord:i,isProcessing:c,isUpdatingDates:n})=>a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(y,{asChild:!0,variant:"outline",size:"icon",className:"border-white text-alerta bg-white rounded-full hover:brightness-95",children:a.jsx(R,{to:`/chart/${r}`,"aria-label":"Ver gráfica del ciclo",children:a.jsx(W,{className:"h-4 w-4"})})}),a.jsx(y,{type:"button",variant:"outline",size:"icon",onClick:s,"aria-pressed":n,className:"border-white text-subtitulo rounded-full hover:brightness-95",disabled:n,"aria-label":"Editar fechas del ciclo",children:a.jsx(ee,{className:"h-4 w-4"})}),a.jsx(y,{type:"button",size:"icon",onClick:i,className:"rounded-full bg-secundario hover:brightness-95 text-white shadow",disabled:c,"aria-label":"Añadir registro al ciclo",children:a.jsx(Y,{className:"h-4 w-4"})})]}),[r]);return p&&!e||!e?a.jsx("div",{className:"flex h-full flex-col items-center justify-center overflow-hidden",children:a.jsx("p",{children:"Cargando detalles del ciclo..."})}):a.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[a.jsx(Q,{cycle:e,isLoading:p,addOrUpdateDataPoint:O,deleteRecord:P,updateCycleDates:q,checkCycleOverlap:$,forceUpdateCycleStart:I,refreshData:U,includeEndDate:!0,headerActions:B,topAccessory:_,onRequestDeleteCycle:z,isDeletingCycle:k,dateEditorDeleteDescription:f?`Se eliminará el ciclo ${f} y todos sus registros asociados.`:"Se eliminará este ciclo y todos sus registros asociados."}),a.jsx(G,{isOpen:A,onClose:()=>C(!1),onConfirm:M,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:f?`¿Estás seguro de que quieres eliminar el ciclo ${f}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:k})]})};export{ye as default};
