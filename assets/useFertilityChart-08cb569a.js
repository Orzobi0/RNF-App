import{r as _,j as c,m as ye,B as Je,N as Tt,f as rt,g as qe,O as pt}from"./index-a7b876ee.js";import{e as At,B as jt}from"./badge-a7e9b0c3.js";import{g as Ct,X as Dt,d as dt,P as mt,e as Ze,T as Ft,f as _t,c as zt}from"./computePeakStatuses-93cb3295.js";const nn=({point:e,position:r,chartWidth:l,chartHeight:N,onToggleIgnore:m,onEdit:s,onClose:a,onTogglePeak:f,currentPeakIsoDate:w})=>{if(!e)return null;const h=.6,g=200,E=120,C=g*h,ae=E*h,D=_.useRef(null),[d,x]=_.useState(ae),[k,S]=_.useState(!1);_.useEffect(()=>{D.current&&x(D.current.offsetHeight),S(!1)},[e]);const y=r.clientX>l*.66,P=r.clientY+d>N;let F=y?r.clientX-C-10:r.clientX+10,L=P?r.clientY:r.clientY+10;F+C>l&&(F=l-C-10),L+d>N&&(L=N-d-10),F<10&&(F=10),L<10&&(L=10);const T=!e.id||String(e.id).startsWith("placeholder-"),q=e.temperature_chart??e.displayTemperature??null,V=Ct(e.fertility_symbol),M=e.timestamp||e.isoDate,ie=$=>{if($==null)return null;const te=String($).trim();return te.length?te:null},O=$=>{if(!$)return null;try{const te=qe($),z=te.getTime();return Number.isNaN(z)?null:rt(te,"HH:mm")}catch{return null}},be=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const $=e.measurements.filter(Boolean);if(!$.length)return null;const te=[...$.filter(z=>z==null?void 0:z.selected),...$.filter(z=>!(z!=null&&z.selected))];for(const z of te){const n=!!(z!=null&&z.use_corrected)?ie(z==null?void 0:z.time_corrected)??ie(z==null?void 0:z.time):ie(z==null?void 0:z.time);if(n)return n}return null})(),H=(e.use_corrected?[ie(e.time_corrected),ie(e.time)]:[ie(e.time)]).find(Boolean)??O(e.timestamp),K=be??H,we=e.mucus_sensation??e.mucusSensation??"",W=e.mucus_appearance??e.mucusAppearance??"",fe=e.observations??"",ve=!!(e.had_relations??e.hadRelations),Fe=V&&V.value!=="none",I=q!=null,re=!!(we&&we.trim()||W&&W.trim()),ke=!!(fe&&fe.trim()),Te=!(I||Fe||re||ke||ve),se=e.peakStatus||(e.peak_marker==="peak"?"P":null),de=se&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[se]||null,Z=!!(f&&e.isoDate),le=!!w,ce=le&&e.isoDate===w||se==="P"||e.peak_marker==="peak",Y=ce?"remove":le?"update":"assign",Pe=Y==="assign"?"Asignar día pico":Y==="update"?"Actualizar día pico":"Quitar día pico",ge=Pe,_e=async()=>{if(!(!f||k)){S(!0);try{await f(e,!ce),a&&a()}catch($){console.error("Error toggling peak marker from tooltip:",$)}finally{S(!1)}}},ee=()=>{xe()},xe=$=>{s&&(s(e,$),a&&a())},Ie=($=>{switch($){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return c.jsxs(ye.div,{ref:D,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:L,left:F,width:C},children:[c.jsx("div",{className:"origin-top-left",style:{transform:`scale(${h})`,width:g,minHeight:E},children:c.jsxs("div",{className:"relative bg-gradient-to-br from-white/98 to-rose-50/95 backdrop-blur-xl rounded-3xl border border-pink-100 shadow-2xl overflow-hidden",children:[c.jsx(Je,{variant:"ghost",size:"icon",onClick:a,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-pink-600 hover:bg-pink-50/80 rounded-full w-6 h-6 transition-all duration-200",children:c.jsx(Dt,{size:20})}),ve&&c.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:c.jsx("div",{className:"w-4 h-4 rounded-full bg-rose-100/90 border border-rose-200 flex items-center justify-center shadow-sm",children:c.jsx(Tt,{className:"w-4 h-4 text-rose-600",fill:"currentColor"})})}),c.jsxs("div",{className:"p-2",children:[c.jsxs("div",{className:"mb-2 relative",children:[c.jsx("div",{className:"w-5 h-5 bg-gradient-to-br from-pink-500 to-rose-500 rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:c.jsx(dt,{className:"w-2 h-2 text-white",fill:"currentColor"})}),c.jsx("div",{className:"flex items-center mb-1 pl-8",children:c.jsxs("div",{children:[c.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:M?rt(qe(M),"dd/MM",{locale:At}):"Fecha"}),c.jsxs("p",{className:"text-sm text-pink-600 font-medium",children:["Día ",e.cycleDay||"N/A"," del ciclo"]}),de&&c.jsx("div",{className:"mt-1 flex justify-center",children:c.jsx(jt,{className:"bg-rose-100 text-rose-600 border border-rose-200 px-2 py-0 text-[11px]",children:de})})]})})]}),Te?c.jsxs("div",{className:"pt-1 space-y-3",children:[c.jsx(ye.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-pink-200 bg-pink-50/60 p-2 text-center",children:c.jsx("p",{className:"text-sm font-semibold text-pink-600",children:"Sin datos registrados para este día."})}),(Z||s)&&c.jsxs(ye.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[Z&&c.jsx(mt,{mode:Y,size:"sm",onClick:_e,pending:k,"aria-label":ge,title:Pe,className:"shrink-0"}),s&&c.jsxs(Je,{onClick:ee,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[c.jsx(Ze,{className:"h-4 w-4"}),c.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):c.jsxs(c.Fragment,{children:[c.jsxs("div",{className:"space-y-1",children:[I&&c.jsx(ye.button,{type:"button",onClick:()=>xe("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-1 border border-amber-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(Ft,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1",children:c.jsxs("div",{className:"flex items-center justify-between gap-3",children:[c.jsxs("div",{className:"flex items-baseline gap-2",children:[c.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(q).toFixed(2)}),c.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&c.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),K&&c.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:K})]})})]})}),Fe&&c.jsx(ye.button,{type:"button",onClick:()=>xe("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${Ie.light} rounded-3xl p-1 ${Ie.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:`w-6 h-6 ${Ie.bg} rounded-lg flex items-center justify-center shadow-lg ${Ie.glow} shadow-lg`,children:c.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:`text-md font-semibold ${Ie.text}`,children:V.label})})]})}),c.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[c.jsx(ye.button,{type:"button",onClick:()=>xe("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-1 border border-blue-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(_t,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:"text-md font-semibold text-blue-800",children:we||"-"})})]})}),c.jsx(ye.button,{type:"button",onClick:()=>xe("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-gradient-to-r from-emerald-50 to-teal-50 rounded-3xl p-1 border border-emerald-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(dt,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:"text-md font-semibold text-green-800",children:W||"-"})})]})}),ke&&c.jsx(ye.button,{type:"button",onClick:()=>xe("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-gradient-to-r from-violet-50 to-purple-50 rounded-3xl p-1 border border-violet-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(Ze,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:"text-sm font-semibold text-violet-800",children:fe})})]})})]})]}),(s||m&&!T&&e.id||Z&&!T)&&c.jsxs(ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[Z&&!T&&c.jsx(mt,{mode:Y,size:"sm",onClick:_e,pending:k,"aria-label":ge,title:Pe,className:"shrink-0"}),c.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:s&&c.jsxs(Je,{onClick:ee,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[c.jsx(Ze,{className:"h-4 w-4 mr-1.5"}),c.jsx("span",{className:"font-medium",children:T?"Añadir datos":""})]})})]})]})]})]})}),c.jsx("div",{className:"absolute -inset-2 bg-gradient-to-br from-pink-200/25 to-rose-300/25 rounded-3xl blur-2xl -z-10"})]})},Ye={0:0,1:.4,2:.8,3:1},Lt={M:.8,F:1,"M+":1,white:.4},Bt=(e,r=0,l=1)=>!Number.isFinite(e)||e<r?r:e>l?l:e,Et=e=>e?String(e).toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""):"",bt=e=>Et(e).replace(/\s+/g," ").trim(),gt=(e,r=[])=>{if(!e)return null;let l=null;return r.forEach((N,m)=>{const{patterns:s=[],level:a,descriptor:f,negatedLevel:w,allowedModifiers:h=null,disallowedModifiers:g=null,selectionScore:E,forceSelection:C=!1}=N||{};s.forEach(ae=>{if(!ae)return;const D=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${ae})(?=$|[^a-z0-9])`,"g");let d;for(;(d=D.exec(e))!==null;){const x=d[1]?d[1].trim():null;if(h&&!h.includes(x)||g&&g.includes(x))continue;let k=a;x==="no"?k=w??1:x==="muy"?k=Math.min(3,a+1):(x==="poco"||x==="leve")&&(k=Math.max(0,a-1));const S=E??k+m*.001,y=typeof f=="function"?f({modifier:x}):f;(!l||C||k>l.level||k===l.level&&S>l.selectionScore)&&(l={level:k,baseLevel:a,descriptor:y,modifier:x,selectionScore:S,force:C})}})}),l},Rt=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],$t=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],xt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const l=Math.round(e);if(l>=0&&l<=3)return l}const r=String(e).trim();return/^[0-3]$/.test(r)?Number.parseInt(r,10):null},It=e=>{const r=xt(e);if(r!=null)return{level:r,reason:`S${r}`,descriptor:`S${r}`,hasInput:!0};const l=e!=null?String(e).trim():"",N=bt(e),m=l.length>0;if(!N)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^s\s*0?$/.test(N))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(N==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const s=gt(N,Rt);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},St=e=>{const r=xt(e);if(r!=null)return{level:r,reason:`M${r}`,descriptor:`M${r}`,hasInput:!0};const l=e!=null?String(e).trim():"",N=bt(e),m=l.length>0;if(!N)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^m\s*0$/.test(N))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(l))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const s=gt(N,$t);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},Ot=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Wt=({appearance:e,observations:r,fertilitySymbol:l})=>{const N=[e,r,l].map(s=>String(s||"").toUpperCase()),m=s=>{if(!s)return!1;const f=`(?:^|[^\\p{L}\\p{N}])${Ot(s)}(?=$|[^\\p{L}\\p{N}])`,w=new RegExp(f,"u");return N.some(h=>w.test(h))};return m("M+")?"M+":m("M")?"M":m("F")||m("FER")?"F":String(l||"").toLowerCase()==="white"?"white":"none"},Mt=e=>{if(e==null)return"";const r=String(e).trim().toUpperCase();return r==="P"||r==="PEAK"?"P":r==="1"||r==="P1"||r==="P+1"?"1":r==="2"||r==="P2"||r==="P+2"?"2":r==="3"||r==="P3"||r==="P+3"?"3":""},Xe=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,Ht=(e,r,l)=>{const N=(e==null?void 0:e.mucusSensation)??(e==null?void 0:e.mucus_sensation),m=(e==null?void 0:e.mucusAppearance)??(e==null?void 0:e.mucus_appearance),s=(e==null?void 0:e.fertility_symbol)??(e==null?void 0:e.fertilitySymbol),a=(e==null?void 0:e.observations)??(e==null?void 0:e.notes),f=It(N),w=St(m);let h=Xe(f.level),g=Xe(w.level);const E=[];f.reason&&E.push(`S:${f.reason}`),w.reason&&E.push(`M:${w.reason}`);const C=Wt({appearance:m,observations:a,fertilitySymbol:s}),ae=C;let D=C;D==="white"&&(g=Math.max(g,1)),D==="M"&&(g=Math.max(g,2)),D==="M+"&&(g=Math.max(g,3)),D==="F"&&(g=Math.max(g,3),h=Math.max(h,3));const d=Ye[h]??0,x=Ye[g]??0,k=Math.max(d,x);D&&D!=="none"&&E.push(`symbol:${D}`);const S=Lt[D]??0,y=Bt(Math.max(k,S)),P=r!=null&&Number.isFinite(r)?k>=r+.4-1e-9:!1;P&&E.push("cambioBIP");const F={hasSensation:!!f.hasInput,hasAppearance:!!w.hasInput,hasSymbol:s!=null&&String(s).trim()!==""&&String(s).trim().toLowerCase()!=="none",hasObservation:a!=null&&String(a).trim()!==""};F.hasAny=F.hasSensation||F.hasAppearance||F.hasSymbol||F.hasObservation;const L=Mt((e==null?void 0:e.normalizedPeakStatus)??(e==null?void 0:e.peakStatus)??(e==null?void 0:e.peak_marker));return{index:l,S:h,M:g,symbolDetected:D,rawSymbol:ae,scoreCore:k,scoreFertil:y,hasChangeBIP:P,reasons:E,entryFlags:F,descriptors:{sensation:f.descriptor??f.reason??null,appearance:w.descriptor??w.reason??null},normalizedPeakStatus:L}},qt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const r=[];for(let m=0;m<Math.min(6,e.length);m+=1){const s=e[m];if(!s||String((s==null?void 0:s.fertility_symbol)||"").toLowerCase()==="red")continue;const f=It((s==null?void 0:s.mucusSensation)??(s==null?void 0:s.mucus_sensation)),w=St((s==null?void 0:s.mucusAppearance)??(s==null?void 0:s.mucus_appearance)),h=Ye[Xe(f.level)]??0,g=Ye[Xe(w.level)]??0;r.push(Math.max(h,g))}const l=r.length>0?Math.max(...r):0;return{days:e.map((m,s)=>Ht(m,l,s)),bipScore:l}},Yt=e=>{for(let r=0;r<e.length;r+=1){const l=e[r];if(l){if(l.symbolDetected==="M+"||l.symbolDetected==="F")return{source:"Alemanas",day:r+1,reason:"M+",kind:"profile"};if(l.M>=2||l.S>=2)return{source:"Alemanas",day:r+1,reason:"S/M>=2",kind:"profile"};if(l.hasChangeBIP)return{source:"Alemanas",day:r+1,reason:"BIP",kind:"profile"}}}return null},Xt=e=>{for(let r=0;r<e.length;r+=1){const l=e[r];if(l){if(l.M>=2)return{source:"OMS",day:r+1,reason:"M>=2",kind:"profile"};if(l.S>=2)return{source:"OMS",day:r+1,reason:"S>=2",kind:"profile"};if(l.symbolDetected==="M+"||l.symbolDetected==="F")return{source:"OMS",day:r+1,reason:"M+",kind:"profile"};if(l.hasChangeBIP)return{source:"OMS",day:r+1,reason:"BIP",kind:"profile"}}}return null},Ut=e=>{for(let r=0;r<e.length;r+=1){const l=e[r];if(l){if(l.symbolDetected==="M+")return{source:"Creighton",day:r+1,reason:"M+",kind:"profile"};if(l.symbolDetected==="M"||l.M>=2)return{source:"Creighton",day:r+1,reason:"M>=2",kind:"profile"};if(l.hasChangeBIP)return{source:"Creighton",day:r+1,reason:"BIP",kind:"profile"}}}return null},Vt=(e,r)=>{const l=e.filter(a=>a&&Number.isFinite(a.day)).map(a=>({...a}));if(l.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:r,usedCandidates:[],notes:["Sin candidatos disponibles"]};const N=[...l].sort((a,f)=>{const w=Number.isFinite(a.day)?a.day:Number.POSITIVE_INFINITY,h=Number.isFinite(f.day)?f.day:Number.POSITIVE_INFINITY;return w-h}),m=N.map(a=>Math.round(a.day));let s=null;if(r==="permisivo")s=Math.max(...m);else if(r==="consenso"){const a=new Map;m.forEach(h=>{const g=a.get(h)??0;a.set(h,g+1)});let f=0,w=null;a.forEach((h,g)=>{(h>f||h===f&&(w==null||g<w))&&(f=h,w=g)}),s=w}else s=Math.min(...m);return{status:s!=null?"ok":"indeterminado",selectedDay:s??null,selectedMode:r,usedCandidates:N,notes:[]}},Gt=({processedData:e=[],config:r={},calculatorCandidates:l=[],context:N={}})=>{var it,lt,ot,at;const{methods:m={alemanas:!0,oms:!0,creighton:!0},calculators:s={cpm:!0,t8:!0},postpartum:a=!1,combineMode:f="conservador"}=r||{},{peakDayIndex:w=null,postPeakStartIndex:h=null,peakThirdDayIndex:g=null,temperatureInfertileStartIndex:E=null,temperatureConfirmationIndex:C=null,temperatureRule:ae=null,todayIndex:D=null}=N||{},{days:d,bipScore:x}=qt(e),k=Array.isArray(d)?d.length:0,S=t=>Number.isInteger(t)&&t>=0&&t<k,y=t=>{var i;if(!t||k===0)return null;for(let j=k-1;j>=0;j-=1)if(((i=d[j])==null?void 0:i.normalizedPeakStatus)===t)return j;return null};let P=S(w)?w:null;if(P==null){const t=y("P");S(t)&&(P=t)}const F=[],L=t=>{!t||!Number.isFinite(t.day)||F.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};m.alemanas&&L(Yt(d)),m.oms&&L(Xt(d)),m.creighton&&L(Ut(d));const T=[];a&&T.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),a||l.forEach(t=>{if(!t)return;const i=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";(i==="CPM"&&s.cpm||i==="T8"&&s.t8)&&L({...t,source:i,kind:"calculator"})}),!m.alemanas&&!m.oms&&!m.creighton&&T.push("Ningún perfil sintotérmico seleccionado.");const q=F.map(t=>({...t}));let V=F;(f==="consenso"||f==="permisivo")&&(V=F.filter(t=>t.kind!=="calculator"));const M=Vt(V,f);M.notes=Array.from(new Set([...M.notes??[],...T].filter(Boolean)));const ie=t=>{if(!Number.isFinite(t))return null;const i=Math.max(1,Math.round(t));return e.length>0?Math.min(i,e.length):i};let O=Number.isFinite(M.selectedDay)?ie(M.selectedDay):null;if(O!=null&&O!==M.selectedDay){const t=`El día calculado (${M.selectedDay}) supera la duración del ciclo. Se usa ${O}.`;M.notes=Array.from(new Set([...M.notes??[],t])),M.selectedDay=O}let ue=null;if(Array.isArray(d)&&d.length>0){const t=d.findIndex(i=>(i==null?void 0:i.rawSymbol)==="white");t>=0&&(ue=t)}if(Array.isArray(e)&&e.length>0)for(let t=0;t<e.length;t+=1){const i=e[t];if(Mt((i==null?void 0:i.normalizedPeakStatus)??(i==null?void 0:i.peakStatus)??(i==null?void 0:i.peak_marker))==="P"){ue=ue!=null?Math.min(ue,t):t;break}}if(ue!=null&&(O==null||ue+1<O)){const t=ie(ue+1);t!=null&&(M.selectedDay=t,M.selectedMode="marcador",M.status="ok",M.notes=Array.from(new Set([...M.notes??[],"Inicio fértil ajustado por marcador explícito."])),O=t)}else O=M.selectedDay??null;let be=null;O!=null&&O>=1&&(be=O-1);const G=d.length>0?d.length-1:null,H=Number.isInteger(be)&&be>=0?be:null;let K=null;if(H!=null&&G!=null&&G>=H)if(Number.isInteger(h)){const t=Math.max(H,Math.min(h-1,G));K=t>=H?t:H}else if(S(P)){const t=Math.min(G,P+2),i=Math.max(H,t);K=i>=H?i:H}else K=G;const we=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,W=t=>Number.isInteger(t)?G==null||G<0?t>=0?t:null:t<0?null:t>G?G:t:null,fe=t=>{var j,me;if(!Number.isInteger(t)||t<0||t>=e.length)return null;const i=(j=e[t])==null?void 0:j.isoDate;if(!i)return null;try{const ne=qe(i);return Number.isNaN((me=ne==null?void 0:ne.getTime)==null?void 0:me.call(ne))?null:ne}catch{return null}},ve=t=>{const i=fe(t);if(!i)return null;try{return rt(i,"dd/MM")}catch{return null}};let I=(t=>{var i;if(!t)return null;for(let j=0;j<d.length;j+=1)if(((i=d[j])==null?void 0:i.normalizedPeakStatus)===t)return j;return null})("3");I==null&&Number.isInteger(g)&&(I=W(g)),I==null&&Number.isInteger(h)&&(I=W(h-1));let re=null;if(I!=null){const t=W(I+1);t!=null&&(re=t)}const ke=W(P),he=fe(ke);if(he)for(let t=ke+1;t<e.length;t+=1){const i=fe(t);if(!i)continue;const j=pt(i,he);if(I==null&&j>=3&&(I=W(t)),re==null&&j>=4&&(re=W(t)),I!=null&&re!=null)break}const Te=W(C),se=W(E);let Q=Te;if(Q==null&&se!=null){const t=W(se-1);t!=null&&t>=0&&(Q=t)}if(re==null&&I!=null){const t=W(I+1);t!=null&&(re=t)}const de=I??null,Z=re??I??null;let le=null;Z!=null&&se!=null?le=Math.min(Z,se):Z!=null?le=Z:se!=null&&(le=se);let pe=null;I!=null&&Q!=null&&(pe=Math.max(I,Q));let ce=null;re!=null&&Q!=null&&(ce=Math.max(re,Q));let Y=null,Pe=null;if(pe!=null||ce!=null){const t=pe??Number.NEGATIVE_INFINITY,i=ce??Number.NEGATIVE_INFINITY;Pe=Math.max(t,i),ce!=null&&(pe==null||ce>=pe)?Y="P+4 y T+3 (OMS)":pe!=null&&(Y="P+3 y T+3 (Alemanes)")}if(Pe!=null&&H!=null){const t=W(Pe);t!=null&&(K=Math.max(H,t))}const ge=K??G??null,_e={conservador:"modo conservador",consenso:"modo consenso",permisivo:"modo permisivo",marcador:"marcador explícito"},ee=(M==null?void 0:M.selectedMode)??f??"conservador",xe=(M==null?void 0:M.usedCandidates)??[],Ae=xe.some(t=>(t==null?void 0:t.kind)==="profile"),Ie=xe.some(t=>(t==null?void 0:t.kind)==="calculator"),$=d.some(t=>{var i,j;return((i=t==null?void 0:t.entryFlags)==null?void 0:i.hasAppearance)||((j=t==null?void 0:t.entryFlags)==null?void 0:j.hasSensation)||(t==null?void 0:t.symbolDetected)});let te=`Fase fértil abierta (perfil: ${_e[ee]??ee}).`;ee==="marcador"?te="Fase fértil abierta (ajustada por tus marcadores).":Ae&&$?te="Fase fértil abierta (basada en tus observaciones de moco).":Ie&&!Ae&&(te="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const z="Fase de infertilidad absoluta confirmada(postovulatoria)",n=`Ventana cerrada por doble criterio: ${Y??"criterio indeterminado"}.`,u=W(P),o=I!=null||re!=null,p=Q!=null,b=o&&p,v=ve(u),B=ve(Q),R="Fase de infertilidad postovulatoria (método moco)",A=v?`Fase de infertilidad alcanzada por determinación de día pico el ${v}.`:"Fase de infertilidad alcanzada por determinación de día pico.",X="Ovulación confirmada por temperatura",Se=B?`Ovulación confirmada por temperatura el ${B}. La fase de infertilidad absoluta está pendiente de determinar día pico (si se registra).`:"Ovulación confirmada por temperatura. La fase de infertilidad absoluta está pendiente de determinar día pico (si se registra).",U=new Array(d.length).fill(null);let je=null,ze=0,Ue=null;const $e={inicio:0,aumento:1,alta:2,muyAlta:3},wt=t=>{var j,me;if(!t)return[];const i=[];if(Number.isFinite(t.M)&&t.M>0){const ne=(j=t.descriptors)==null?void 0:j.appearance;i.push(`M${t.M}${ne?` (${ne})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const ne=(me=t.descriptors)==null?void 0:me.sensation;i.push(`S${t.S}${ne?` (${ne})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?i.push("white"):i.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&i.push("cambio BIP"),i},vt=["inicio","aumento","alta","muyAlta"];for(let t=0;t<d.length;t+=1){const i=d[t];if(!i){U[t]=null;continue}const j=Number.isInteger(le)?t>=le:!1,me=H!=null&&ge!=null&&t>=H&&t<=ge&&!j,ne=Number.isInteger(D)&&D!=null?t>D:!1;if(!me){if(ze=0,je=null,j||ge!=null&&t>ge){if(!o&&!p&&le==null){U[t]=null;continue}const We=!!((it=i.entryFlags)!=null&&it.hasAny),Ke=We?null:"Sin registro hoy; estimación basada en días adyacentes.";let Re=z,He=n,Qe="absolute";!b&&o?(Re=R,He=A,Qe="mucus"):!b&&p&&(Re=X,He=Se,Qe="temperature"),U[t]={index:t,state:"infertil",status:Qe,title:Re,header:Re,body:He,detail:Y,hasRecord:We,inherited:!1,note:Ke,isFertile:!1,phase:"postOvulatory",label:Re,summaryText:He,reasonsList:[],reasonsText:"",showFertilityStatus:!ne}}continue}const Le=!!((lt=i.entryFlags)!=null&&lt.hasAny);let Ce=0;i.normalizedPeakStatus==="P"||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3||i.M>=3?Ce=3:i.M>=2||i.S>=2||i.symbolDetected==="M"?Ce=2:(i.M>=1||i.S>=1||i.hasChangeBIP)&&(Ce=1),Le?(ze=0,je=Ce):ze+=1;const ct=i.M>=2||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3,Nt=de!=null&&t>=de&&(Q==null||t<=Q);let Ne=Ce,J=null;if(Nt&&!ct)J="waiting";else{if(!Le){const We=je??Ce,Ke=Math.floor(ze/2);Ne=Math.max(0,We-Ke)}const Ge=Math.max(0,Math.min(3,Ne));J=vt[Ge]}const ut=wt(i),De=ut.join("; "),Be=u!=null?t-u:null,Ve=Be!=null?we(Be):null,yt=Le?null:"Sin registro hoy; estimación basada en días adyacentes.";J!=="waiting"&&(Be===0||Be===1||Be===2?(J="muyAlta",Ne=Math.max(Ne,3)):Be===3?($e[J]<$e.alta&&(J="alta"),Ne=Math.max(Ne,2)):Ue!=null&&t-Ue<=3&&($e[J]<$e.aumento&&(J="aumento"),Ne=Math.max(Ne,1))),(J==="alta"||J==="muyAlta"||ct)&&(Ue=t);let Me,oe;switch(J){case"waiting":Me="Fertilidad en espera de confirmación por temperatura",oe="Final de moco alcanzado (≥P+3). Ventana mantenida hasta confirmación térmica (T+3).";break;case"aumento":Me="Aumento de fertilidad",oe=De?`Signos en aumento: ${De}.`:"Signos en aumento.";break;case"alta":Me="Fertilidad alta",oe=De?`Signos fértiles claros (${De}).`:"Signos fértiles claros.";break;case"muyAlta":{Me="Fertilidad muy alta",oe=`Día de máxima fertilidad${Ve?` (${Ve})`:""}.`,oe+=De?` Signos pico: ${De}.`:" Signos pico presentes.";break}case"inicio":default:Me="Ventana fértil abierta",oe="Hoy sin signos destacables, a la espera de registrar más datos.";break}Le||(J==="alta"?(Me="Fertilidad estimada alta",oe=`${oe} Sin datos apuntados este día; se estima en base a días cercanos.`):J==="muyAlta"?(Me="Fertilidad estimada muy alta",oe=`${oe} Sin datos apuntados este día; se estima en base a días cercanos.`):(J==="aumento"||J==="inicio")&&(Me="Ventana fértil abierta (sin registro hoy)",oe=`${oe} Sin datos apuntados este día; se estima en base a días cercanos.`));const Pt={index:t,state:J,level:J==="waiting"?Ce:Ne,title:Me,header:te,body:oe,reasonsList:ut,reasonsText:De,hasRecord:Le,inherited:!Le,note:yt,isFertile:!0,phase:"fertile",label:Me,summaryText:oe,delta:Ve,showFertilityStatus:!ne,reasonParts:{symbol:i.symbolDetected??null,appearance:((ot=i.descriptors)==null?void 0:ot.appearance)??null,sensation:((at=i.descriptors)==null?void 0:at.sensation)??null}};U[t]=Pt}ge!=null&&(K=ge);let Oe=null;if(Number.isInteger(D)&&U.length>0){const t=Math.min(Math.max(D,0),U.length-1);let i=null;for(let j=t;j>=0;j-=1){const me=U[j];if(me&&(i||(i=me),me.isFertile)){Oe=me;break}}!Oe&&i&&(Oe=i)}const kt={bipScore:x,explicitStartDay:ue,effectivePeakIndex:P,candidatesBeforeAggregate:q,closureDetail:Y,waitingStartIndex:de,pPlus3Index:I,pPlus4Index:re,temperatureConfirmationIndex:Q,temperatureInfertileIndex:se,temperatureRule:ae??null,mucusInfertileStartIndex:Z,postOvulatoryStartIndex:le};return{fertileStartFinalIndex:be,fertileWindow:H!=null&&K!=null?{startIndex:H,endIndex:K,waitingStartIndex:de,closureDetail:Y,temperatureConfirmationIndex:Q,temperatureInfertileStartIndex:se,mucusInfertileStartIndex:Z,postOvulatoryStartIndex:le,temperatureRule:ae??null}:null,dailyAssessments:U,currentAssessment:Oe,candidates:q,aggregate:M,debug:kt}},ft=e=>{if(!e)return null;try{const r=new Date(e);return Number.isNaN(r.getTime())?null:r}catch{return null}},Kt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const l=e.map(a=>{if(!(a!=null&&a.startDate)||!(a!=null&&a.endDate))return null;const f=ft(a.startDate),w=ft(a.endDate);if(!f||!w||w<f)return null;const h=Math.round((w-f)/(1e3*60*60*24))+1;if(!Number.isFinite(h)||h<=0)return null;const g=!!(a!=null&&a.ignoredForAutoCalculations);return{duration:h,ignored:g}}).filter(Boolean).filter(a=>!a.ignored);if(l.length<6)return null;const N=l.reduce((a,f)=>f.duration<a.duration?f:a),m=l.length>=12?20:21,s=N.duration-m;return Number.isFinite(s)?{source:"CPM",day:Math.max(1,Math.round(s)),reason:`ciclo_mas_corto=${N.duration}`,kind:"calculator"}:null},et=e=>{if(e==null||e==="")return null;const r=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(r)?r:null},Qt=e=>{const r=[e==null?void 0:e.temperature_chart,e==null?void 0:e.temperature_raw,e==null?void 0:e.temperature_corrected];for(const l of r){const N=et(l);if(N!==null)return N}if(Array.isArray(e==null?void 0:e.measurements)){const l=s=>{if(!s)return null;const a=et(s.temperature),f=et(s.temperature_corrected);return s.use_corrected&&f!==null?f:a!==null?a:f!==null?f:null},m=e.measurements.find(s=>s&&s.selected&&l(s)!==null)||e.measurements.find(s=>l(s)!==null);if(m){const s=l(m);if(s!==null)return s}}return null},Jt=(e=[],r)=>{if(!Array.isArray(e)||e.length===0||typeof r!="function")return null;const l=[];if(e.forEach(m=>{if(!(m!=null&&m.data)||!Array.isArray(m.data)||!m.startDate)return;const s=m.data.filter(C=>C&&C.isoDate).map(C=>({...C,displayTemperature:Qt(C)}));if(s.length===0)return;const{ovulationDetails:a}=r(s);if(!(a!=null&&a.confirmed))return;const f=Number.isInteger(a==null?void 0:a.ovulationIndex)?a.ovulationIndex:Number.isInteger(a==null?void 0:a.confirmationIndex)?a.confirmationIndex:null;if(f==null||f<0||f>=s.length)return;const w=s[f],h=Number(w==null?void 0:w.cycleDay);if(!Number.isFinite(h)||h<=0)return;const g=Math.max(1,Math.round(h-8)),E={riseDay:h,t8Day:g,ignored:!!(m!=null&&m.ignoredForAutoCalculations)};!E.ignored&&l.length<12&&l.push(E)}),l.length<6)return null;const N=l.reduce((m,s)=>s.t8Day<m.t8Day?s:m);return{source:"T8",day:Math.max(1,Math.round(N.t8Day)),reason:`t8=${N.t8Day}`,kind:"calculator"}},Ee={methods:{alemanas:!0,oms:!0,creighton:!0},calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"conservador"},tt=35.8,nt=37.2,ht=(e=[])=>{var D;const r=d=>d&&d.displayTemperature!=null&&!d.ignored,m=d=>{if(!d||d.length!==6)return null;const x=d.map(y=>y.temp);if(x.some(y=>!Number.isFinite(y)))return null;const k=x.reduce((y,P)=>P>y?P:y,x[0]),S=x.reduce((y,P)=>P>=k-.05&&P<k?y+1:y,0);return S>=2?null:{baselineTemp:k,baselineStartIndex:d[0].index,baselineIndices:d.map(y=>y.index),baselineBorderlineCount:S}},s=d=>{const x=[];for(let k=d;k<e.length;k+=1){const S=e[k];if(!r(S))continue;const y=S.displayTemperature;if(Number.isFinite(y)&&(x.push({index:k,temp:y}),x.length>6&&x.shift(),x.length===6)){const P=m(x);if(!P)continue;let F=null;for(let L=k+1;L<e.length;L+=1){const T=e[L];if(!r(T))continue;const q=T.displayTemperature;if(Number.isFinite(q)&&q>P.baselineTemp){F=L;break}}return{baselineTemp:P.baselineTemp,baselineStartIndex:P.baselineStartIndex,baselineIndices:P.baselineIndices,baselineBorderlineCount:P.baselineBorderlineCount,firstHighIndex:F}}}return null},a={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let f=null,w=null,h=null,g=[],E=a,C=0;const ae=({baselineTemp:d,firstHighIndex:x})=>{if(x==null)return{confirmed:!1};const k=d+.2,S=[],y=[],P=new Set,F=M=>{M==null||P.has(M)||(P.add(M),y.push(M))};let L=null,T=!1;const q=x>0?x-1:null,V=()=>q!=null?[q,...y]:[...y];for(let M=x;M<e.length;M++){const ie=e[M];if(!r(ie))break;const O=ie.displayTemperature;if(!Number.isFinite(O))break;if(O>d){if(F(M),S.push({index:M,temp:O}),S.length===3&&S[2].temp>=k)return{confirmed:!0,confirmationIndex:S[2].index,usedIndices:V(),highSequenceIndices:[...y],rule:"3-high"};if(S.length===4&&S[2].temp<k&&S[3].temp>d)return{confirmed:!0,confirmationIndex:S[3].index,usedIndices:V(),highSequenceIndices:[...y],rule:"german-3+1"};if(L!==null&&S.length===3&&S[2].temp>=k)return{confirmed:!0,confirmationIndex:S[2].index,usedIndices:V(),highSequenceIndices:[...y],rule:"german-2nd-exception"};if(S.length===5&&S[3].temp>d&&S[4].temp>=k)return{confirmed:!0,confirmationIndex:S[4].index,usedIndices:V(),highSequenceIndices:[...y],rule:"5-high"};continue}if(O>=d-.05&&L===null&&S.length>0&&S.length<3){L=M,F(M),S.push({index:M,temp:d});continue}if(!T&&S.length>0&&S.length<3){T=!0,F(M);continue}break}return{confirmed:!1,usedIndices:V(),highSequenceIndices:[...y]}};for(;C<e.length;){const d=s(C);if(!d)break;if(f=d.baselineTemp,w=d.baselineStartIndex,g=Array.isArray(d.baselineIndices)?[...d.baselineIndices]:[],h=d.firstHighIndex,d.baselineBorderlineCount,h==null){C=w+1;continue}const x=ae(d);if(x!=null&&x.requireRebaseline){C=w+1;continue}if(x!=null&&x.confirmed){const k=(D=x.highSequenceIndices)!=null&&D.length?x.highSequenceIndices[0]:null,S=Number.isInteger(x.confirmationIndex)?Math.max(0,Math.min(x.confirmationIndex,e.length-1)):null;let y=null;if(S!=null){const P=S+1;y=Math.max(0,Math.min(P,e.length-1))}E={confirmed:!0,confirmationIndex:S,infertileStartIndex:y,rule:x.rule,highSequenceIndices:x.highSequenceIndices??x.usedIndices,usedIndices:x.usedIndices,ovulationIndex:h??k??null};break}C=w+1}return{baselineTemp:f,baselineStartIndex:w,firstHighIndex:h,baselineIndices:g,ovulationDetails:E}},rn=(e,r,l,N,m,s=5,a=!1,f=null,w=[],h=null)=>{const g=_.useRef(null),E=_.useRef(null),[C,ae]=_.useState({width:0,height:0}),[D,d]=_.useState(null),[x,k]=_.useState({x:0,y:0}),[S,y]=_.useState(null),P=_.useCallback(()=>{d(null),y(null)},[]),F=n=>{if(n==null)return"";const u=String(n).trim().toUpperCase();return u==="P"||u==="PEAK"?"P":u==="1"||u==="P1"||u==="P+1"?"1":u==="2"||u==="P2"||u==="P+2"?"2":u==="3"||u==="P3"||u==="P+3"?"3":""},L=_.useMemo(()=>zt(e),[e]),T=_.useMemo(()=>{const n=o=>{if(o==null||o==="")return null;const p=parseFloat(String(o).replace(",","."));return Number.isFinite(p)?p:null},u=o=>{if(!o)return null;const p=n(o.temperature),b=n(o.temperature_corrected);return o.use_corrected&&b!==null?b:p!==null?p:b!==null?b:null};return e.map(o=>{const p=[o==null?void 0:o.temperature_chart,o==null?void 0:o.temperature_raw,o==null?void 0:o.temperature_corrected];let b=null;for(const X of p)if(X!=null&&X!==""){b=X;break}if(b==null&&Array.isArray(o==null?void 0:o.measurements)){const Se=o.measurements.find(U=>U&&U.selected&&u(U)!==null)||o.measurements.find(U=>u(U)!==null);Se&&(b=u(Se))}const v=o==null?void 0:o.isoDate,B=(o==null?void 0:o.peak_marker)??(o==null?void 0:o.peakStatus)??null,R=v?L[v]??B:B,A=F(R);return{...o,displayTemperature:n(b),peakStatus:R??null,normalizedPeakStatus:A}})},[e,L]),q=_.useMemo(()=>{if(!Array.isArray(T)||T.length===0)return null;const n=new Date;let u=null;return T.forEach((o,p)=>{var b;if(o!=null&&o.isoDate)try{const v=qe(o.isoDate);if(Number.isNaN((b=v==null?void 0:v.getTime)==null?void 0:b.call(v)))return;pt(v,n)<=0&&(u=p)}catch{}}),u},[T]);_.useLayoutEffect(()=>{const n=()=>{if(!g.current)return;const o=g.current.parentElement||g.current;let p=o.clientWidth||600,b=o.clientHeight||400,v=g.current.clientWidth>0?g.current.clientWidth:p,B,R;if(r){let A=window.innerWidth,X=window.innerHeight;if(a&&X>A&&([A,X]=[X,A]),v=A,l==="portrait"&&!a){const Se=Math.max(30,A*.05);B=(A-Se)/s*e.length}else B=A/s*e.length;R=X}else B=v/s*e.length,R=b;ae({width:B,height:R})};n(),window.addEventListener("resize",n);let u;if(g.current){const o=g.current.parentElement||g.current;u=new ResizeObserver(n),u.observe(o)}return()=>{window.removeEventListener("resize",n),u&&u.disconnect()}},[r,e.length,s,l,a]);const V=_.useMemo(()=>T.filter(n=>n&&n.isoDate&&!n.ignored&&n.displayTemperature!==null&&n.displayTemperature!==void 0),[T]),M=_.useMemo(()=>T.filter(n=>n&&n.isoDate),[T]),ie=V.length>0,O=_.useMemo(()=>!Array.isArray(T)||T.length===0?!1:T.some(n=>n?n.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(v=>{const B=n==null?void 0:n[v];return B!=null&&String(B).trim()!==""})||(()=>{const v=(n==null?void 0:n.fertility_symbol)??(n==null?void 0:n.fertilitySymbol);return v==null?!1:String(v).trim()!==""})()||(()=>{const v=(n==null?void 0:n.observations)??(n==null?void 0:n.notes);return v==null?!1:String(v).trim()!==""})()?!0:F((n==null?void 0:n.normalizedPeakStatus)??(n==null?void 0:n.peakStatus)??(n==null?void 0:n.peak_marker))!=="":!1),[T]),ue=_.useMemo(()=>{var R,A,X,Se,U;const n=f??{},u=(je,ze)=>typeof je=="boolean"?je:ze,o={alemanas:u((R=n==null?void 0:n.methods)==null?void 0:R.alemanas,Ee.methods.alemanas),oms:u((A=n==null?void 0:n.methods)==null?void 0:A.oms,Ee.methods.oms),creighton:u((X=n==null?void 0:n.methods)==null?void 0:X.creighton,Ee.methods.creighton)},p={cpm:u((Se=n==null?void 0:n.calculators)==null?void 0:Se.cpm,Ee.calculators.cpm),t8:u((U=n==null?void 0:n.calculators)==null?void 0:U.t8,Ee.calculators.t8)},v=new Set(["conservador","consenso","permisivo"]).has(n==null?void 0:n.combineMode)?n.combineMode:Ee.combineMode,B=!!(n!=null&&n.postpartum);return{methods:o,calculators:p,combineMode:v,postpartum:B}},[f]),be=_.useMemo(()=>{if(Array.isArray(h)&&h.length>0)return h.map(p=>{if(!p)return null;const{source:b,day:v,reason:B}=p,R=typeof b=="string"?b.toUpperCase().replace(/-/g,""):"";if(R!=="CPM"&&R!=="T8")return null;const A=Number(v);return Number.isFinite(A)?{source:R,originalSource:b??R,day:A,reason:typeof B=="string"?B:"",kind:"calculator"}:null}).filter(Boolean);const n=Array.isArray(w)?w:[];if(!n.length)return[];const u=Kt(n),o=Jt(n,ht);return[u,o].filter(Boolean)},[h,w]),{peakDayIndex:G,thirdDayIndex:H,peakInfertilityStartIndex:K}=_.useMemo(()=>{if(!M.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const n=M.map(p=>(p==null?void 0:p.normalizedPeakStatus)??F((p==null?void 0:p.peakStatus)??(p==null?void 0:p.peak_marker)));let u=null,o=null;if(n.forEach((p,b)=>{p==="P"&&u==null&&(u=b),p==="3"&&o==null&&(o=b)}),u==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(o!=null){const p=M.length-1,b=Math.min(o+1,p);return{peakDayIndex:u,thirdDayIndex:o,peakInfertilityStartIndex:b}}return{peakDayIndex:u,thirdDayIndex:null,peakInfertilityStartIndex:null}},[M]),{baselineTemp:we,baselineStartIndex:W,firstHighIndex:fe,baselineIndices:ve,ovulationDetails:Fe}=_.useMemo(()=>ht(T),[T]),I=_.useMemo(()=>({...Fe??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:we,baselineIndices:ve,baselineStartIndex:W,firstHighIndex:fe,peakDayIndex:G,peakInfertilityStartIndex:K,thirdDayIndex:H}),[Fe,we,ve,W,fe,G,K,H]),re=_.useMemo(()=>Gt({processedData:T,config:ue,calculatorCandidates:be,context:{peakDayIndex:G,postPeakStartIndex:K,peakThirdDayIndex:(I==null?void 0:I.thirdDayIndex)??null,temperatureInfertileStartIndex:(I==null?void 0:I.infertileStartIndex)??null,temperatureConfirmationIndex:(I==null?void 0:I.confirmationIndex)??null,temperatureRule:(I==null?void 0:I.rule)??null,todayIndex:q}}),[T,ue,be,I==null?void 0:I.thirdDayIndex,I==null?void 0:I.infertileStartIndex,I==null?void 0:I.confirmationIndex,I==null?void 0:I.rule,G,K,q]),ke=_.useMemo(()=>T.map((n,u)=>{if(!n)return n;const o=Number.isInteger(q)?u>q:!1;return{...n,isFutureDay:o}}),[T,q]),he=_.useMemo(()=>ke.filter(n=>n&&n.isoDate),[ke]),{tempMin:Te,tempMax:se}=_.useMemo(()=>{const n=V.map(A=>A.displayTemperature).filter(A=>A!=null);if(n.length===0)return{tempMin:tt,tempMax:nt};const u=nt-tt,o=Math.min(...n),p=Math.max(...n);let b=Math.min(o,tt),v=Math.max(p,nt);const B=A=>Math.floor(A*10)/10,R=A=>Math.ceil(A*10)/10;if(b=B(b),v=R(v),v-b<u){const A=(b+v)/2;b=B(A-u/2),v=R(A+u/2)}return Math.abs(b-o)<1e-9&&(b=B(b-.1)),Math.abs(v-p)<1e-9&&(v=R(v+.1)),{tempMin:parseFloat(b.toFixed(1)),tempMax:parseFloat(v.toFixed(1))}},[V]),Q=se-Te,de=C.width,Z=C.height,le=9,pe=(n=1)=>{if(!r)return le*n;const u=Math.min(de,Z);return Math.max(8,Math.min(le*n,u/(he.length>0?40/n:40)))},ce=Math.round(pe(r?1.6:2)),Y=a||l==="landscape",_e=Math.round(ce*((r?9:7.5)+(r?1:.75))),ee={top:r?Math.max(Y?6:12,Z*(Y?.015:.03)):12,right:r?Math.max(Y?35:30,de*(Y?.02:.05)):50,bottom:Math.max(0,_e-1),left:r?Math.max(Y?45:20,de*(Y?.02:.05)):50},Ae=Math.max(0,Math.round(ce*4)),Ie=Z-ee.bottom-Ae,$=n=>{const u=Z-ee.top-ee.bottom-Ae;return n==null||Q===0||u<=0?Ie:Ie-(n-Te)/Q*u},te=n=>{const u=r&&!(a||l==="landscape")?5:10,o=r&&!(a||l==="landscape")?25:0,p=de-ee.left-ee.right-u-o*(he.length-1);if(p<=0)return ee.left+u+o*n;const b=he.length>1?he.length-1:1;return b===0||he.length===0?ee.left+u+o*n:ee.left+u+n*(p/(he.length===1?1:b))+o*n},z=(n,u,o)=>{if(!n){P();return}const p=g.current.getBoundingClientRect();let b,v;if(o.type.startsWith("touch")){const X=o.changedTouches[0];b=X.clientX,v=X.clientY}else b=o.clientX,v=o.clientY;const B=te(u),R=n.displayTemperature??n.temperature_chart??null,A=$(R);k({svgX:B,svgY:A,clientX:b-p.left+g.current.scrollLeft,clientY:v-p.top+g.current.scrollTop}),y(u),d(n)};return _.useEffect(()=>{const n=u=>{var o;if(E.current&&!E.current.contains(u.target)){const p=(o=g.current)==null?void 0:o.querySelectorAll("circle, text, rect");let b=!1;if(p){for(let v of p)if(v.contains(u.target)){b=!0;break}}b||P()}};return D&&(document.addEventListener("mousedown",n),document.addEventListener("touchstart",n)),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}},[D,P]),{chartRef:g,tooltipRef:E,dimensions:C,activePoint:D,activeIndex:S,tooltipPosition:x,processedData:ke,validDataForLine:V,allDataPoints:he,tempMin:Te,tempMax:se,tempRange:Q,padding:ee,textRowHeight:ce,setActivePoint:d,setActiveIndex:y,getY:$,getX:te,handlePointInteraction:z,clearActivePoint:P,handleToggleIgnore:n=>{N&&n&&(N(m,n),P())},responsiveFontSize:pe,baselineTemp:we,baselineStartIndex:W,baselineIndices:ve,firstHighIndex:fe,ovulationDetails:I,fertilityStart:re,hasTemperatureData:ie,hasAnyObservation:O,graphBottomInset:Ae,todayIndex:q}};export{nn as C,Kt as a,Jt as b,ht as c,rn as u};
