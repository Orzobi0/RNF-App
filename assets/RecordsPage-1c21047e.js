import{c as Wt,r as n,f as w,p as h,j as s,F as y,B as we,I as Aa,b as Ta,K as N,h as K,N as Fa,J as Ht,i as Ia,m as ue}from"./index-8c1bb4d0.js";import{L as it,T as La,P as Oa,C as Ra}from"./CycleDatesEditor-5cdf72be.js";import{T as Pa,h as za,f as Ba,d as Ha,c as Va,m as Vt,j as xe,i as Oe,k as Ua,A as Xa,l as qa,D as $a,F as Ut}from"./computePeakStatuses-347fa954.js";import{e as lt,P as Ya}from"./badge-6bd7af9d.js";import{D as Ga}from"./DeletionDialog-dad1e6ec.js";import{u as Wa,D as Ka,a as Ja}from"./useCycleData-a1f868e4.js";import{e as Za}from"./checkbox-a510d285.js";import"./OverlapWarningDialog-7409f0f1.js";import"./input-6cdf51b4.js";import"./label-60015da2.js";import"./eye-5bd09b1b.js";const ct=Wt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),Qa=Wt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),er=({isoDate:g,cycleDay:k,details:i,peakStatus:Re,isPeakDay:ye,onEdit:b,onDelete:De,onAdd:P,onToggleRelations:de,isProcessing:S})=>{var e,ke,Q,_e;const Ce=!!(i!=null&&i.record),Pe=n.useMemo(()=>{if(!g)return null;try{return w(h(g),"dd/MM/yyyy",{locale:lt})}catch{return null}},[g]),fe=((e=i==null?void 0:i.symbolInfo)==null?void 0:e.label)||"Sin símbolo",Se=((ke=i==null?void 0:i.symbolInfo)==null?void 0:ke.value)||"none",ze=((Q=i==null?void 0:i.symbolInfo)==null?void 0:Q.pattern)==="spotting-pattern"?"spotting-pattern-icon":"",je=()=>{!(i!=null&&i.record)||!b||b(i.record,null)},J=()=>{var v;!((v=i==null?void 0:i.record)!=null&&v.id)||!De||De(i.record.id)},Be=()=>{!g||!P||P(g)},T=(v,F=null)=>{if(i!=null&&i.record&&b){b(i.record,v,F);return}g&&P&&P(g,v,F)},He=()=>{!g||!de||de(g)},z=(v,F={})=>v&&typeof v=="string"&&v.trim().length>0||typeof v=="number"?v:F.placeholder||"—",Ve=i!=null&&i.hasTemperature?`${i.displayTemp} °C`:"—",Ue=(i==null?void 0:i.timeValue)||"—",Xe=!!(i!=null&&i.timeValue),qe=i!=null&&i.hasMucusSensation?i.mucusSensation:"—",$e=i!=null&&i.hasMucusAppearance?i.mucusAppearance:"—",Ne=(_e=i==null?void 0:i.observationsText)==null?void 0:_e.trim(),Z=!!(i!=null&&i.hasRelations),Ye=()=>{switch(Se){case"red":return"bg-rose-50 border-rose-100";case"green":return"bg-emerald-50 border-emerald-100";case"yellow":return"bg-yellow-50 border-yellow-100";case"spot":return"bg-rose-50 border-rose-100";case"white":return"bg-white border-slate-300";default:return"bg-slate-50 border-slate-200"}};if(!g)return s.jsx("div",{className:"w-full rounded-2xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const B="flex items-center gap-2 rounded-xl border px-3 py-2 text-sm min-h-[3rem]";return s.jsxs("div",{className:"w-full rounded-2xl border border-rose-100 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-sm",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("p",{className:"text-base font-semibold text-slate-800 sm:text-lg",children:[Pe,k?` · D${k}`:""]}),s.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[s.jsx("button",{type:"button",onClick:()=>T("symbol","fertilitySymbol"),className:y("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ye(),ze),title:fe,"aria-label":fe}),Ce?s.jsxs(s.Fragment,{children:[s.jsxs(we,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-rose-500 hover:bg-rose-50",onClick:je,disabled:S,children:[S?s.jsx(it,{className:"h-4 w-4 animate-spin"}):s.jsx(Qa,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Editar registro"})]}),s.jsxs(we,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-rose-500 hover:bg-rose-50",onClick:J,disabled:S,children:[S?s.jsx(it,{className:"h-4 w-4 animate-spin"}):s.jsx(La,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):s.jsxs(we,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:Be,disabled:S,children:[S&&s.jsx(it,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),s.jsxs("div",{className:"mt-4 space-y-3",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>T("temperature","temperature"),className:y(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[s.jsx(Pa,{className:"h-5 w-5 opacity-80"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"font-semibold",children:z(Ve)}),(i==null?void 0:i.showCorrectedIndicator)&&s.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),s.jsxs("button",{type:"button",onClick:()=>T("temperature","time"),className:y(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Xe?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[s.jsx(za,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"font-semibold",children:z(Ue)})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>T("sensation","mucusSensation"),className:y(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[s.jsx(Ba,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"font-semibold",children:z(qe)})]}),s.jsxs("button",{type:"button",onClick:()=>T("appearance","mucusAppearance"),className:y(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[s.jsx(Ha,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"font-semibold",children:z($e)})]})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>T("observations","observations"),className:y(B,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ne?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[s.jsx(ct,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"truncate",children:z(Ne,{placeholder:"-"})})]}),s.jsx("button",{type:"button",onClick:He,disabled:S,className:y("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Z?"border-rose-500 bg-rose-50":"border-slate-200 bg-white",S&&"opacity-70 cursor-not-allowed"),title:Z?"Hubo relaciones":"Sin relaciones","aria-label":Z?"Hubo relaciones":"Sin relaciones",children:s.jsx(Aa,{className:y("h-4 w-4",Z?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},tr=g=>Ut.find(k=>k.value===g)||Ut[0],Xt=10,qt=60,$t=400,Yt=120,Gt=85,ar=5,ve=160,rr=g=>{if(g==null||g==="")return null;const k=Number(typeof g=="string"?g.replace(",","."):g);return Number.isFinite(k)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(k):null},sr=({cycle:g,headerTitle:k="Mis Registros",headerIcon:i=ct,headerActions:Re,topAccessory:ye,includeEndDate:b=!1,initialCalendarOpen:De=!0,addOrUpdateDataPoint:P,deleteRecord:de,isLoading:S,updateCycleDates:Ce,checkCycleOverlap:Pe,forceShiftNextCycleStart:fe,forceUpdateCycleStart:Se,refreshData:ze,afterRecordsContent:je=null,onRequestDeleteCycle:J=null,dateEditorDeleteTitle:Be="Eliminar ciclo",dateEditorDeleteDescription:T="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:He="Eliminar ciclo",isDeletingCycle:z=!1}={})=>{const{currentCycle:Ve,addOrUpdateDataPoint:Ue,deleteRecord:Xe,isLoading:qe,updateCycleDates:$e,checkCycleOverlap:Ne,forceUpdateCycleStart:Z,forceShiftNextCycleStart:Ye,refreshData:B}=Wa(),e=g??Ve,ke=S??qe,Q=P||(async(t,r)=>{if(e!=null&&e.id)return Ue(t,r,e.id)}),_e=de||(async t=>{if(e!=null&&e.id)return Xe(t,e.id)}),v=Ce||(async(t,r,a)=>$e(t??(e==null?void 0:e.id),r,a)),F=Pe??Ne,ut=Se||(async(t,r)=>Z(t??(e==null?void 0:e.id),r)),Ge=fe||(async(t,r,a)=>Ye(t??(e==null?void 0:e.id),r,a)),Ee=ze??B,{toast:j}=Ta(),[Kt,ee]=n.useState(!1),[We,te]=n.useState(null),[ae,Ke]=n.useState(null),[re,se]=n.useState(!1),[Jt,dt]=n.useState(!1),[H,Me]=n.useState(()=>(e==null?void 0:e.startDate)||""),[V,Ae]=n.useState(()=>(e==null?void 0:e.endDate)||""),[Zt,I]=n.useState(""),[L,ft]=n.useState(null),[Je,mt]=n.useState(null),[Ze,pt]=n.useState(!1),[Qt,ht]=n.useState(null),[ea,Qe]=n.useState(!1),[et,me]=n.useState(!1),[f,U]=n.useState(null),[ta,X]=n.useState(null),[aa,pe]=n.useState(null),[ra,he]=n.useState(null),[q,Te]=n.useState(De),Fe=n.useRef(null),gt=n.useRef(null),bt=n.useRef(0),[xt,vt]=n.useState(0),Ie=n.useCallback(()=>{const t=Fe.current;if(!t){bt.current=0,vt(0);return}const a=t.getBoundingClientRect().height;bt.current=a,vt(o=>Math.abs(o-a)>.5?a:o)},[]);n.useLayoutEffect(()=>{let t=window.requestAnimationFrame(Ie);const r=()=>{t&&window.cancelAnimationFrame(t),t=window.requestAnimationFrame(Ie)};window.addEventListener("resize",r);let a;return typeof ResizeObserver<"u"&&(a=new ResizeObserver(()=>{t&&window.cancelAnimationFrame(t),t=window.requestAnimationFrame(Ie)}),Fe.current&&a.observe(Fe.current)),()=>{window.removeEventListener("resize",r),a&&a.disconnect(),t&&window.cancelAnimationFrame(t)}},[Ie]);const wt=n.useMemo(()=>Math.max(Math.round(xt+Xt),Xt),[xt]);n.useEffect(()=>{Me((e==null?void 0:e.startDate)||""),Ae((e==null?void 0:e.endDate)||"")},[e==null?void 0:e.startDate,e==null?void 0:e.endDate]);const ne=n.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?[...e.data].filter(r=>r==null?void 0:r.isoDate).sort((r,a)=>{const o=h(r.isoDate);return h(a.isoDate)-o}).map(r=>r.isoDate):[]},[e==null?void 0:e.data]);n.useEffect(()=>{const t=gt.current;t&&t.scrollTo({top:0,behavior:"auto"})},[]);const oe=n.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?e.data.map(r=>{if(!(r!=null&&r.isoDate))return null;const a=h(r.isoDate);return N(a)?a:null}).filter(Boolean):[]},[e==null?void 0:e.data]),yt=n.useMemo(()=>new Set(ne),[ne]),tt=n.useMemo(()=>Va((e==null?void 0:e.data)??[]),[e==null?void 0:e.data]),ie=n.useMemo(()=>{var r;const t=new Map;return(r=e==null?void 0:e.data)!=null&&r.length&&e.data.forEach(a=>{var Bt;if(!(a!=null&&a.isoDate))return;const o=((Bt=a.measurements)==null?void 0:Bt.find(ot=>ot==null?void 0:ot.selected))||(a.temperature_chart||a.temperature_raw?{temperature:a.temperature_chart??a.temperature_raw,temperature_corrected:a.temperature_corrected??null,time:a.timestamp?w(h(a.timestamp),"HH:mm"):null,use_corrected:a.use_corrected??!1}:null),c=(o==null?void 0:o.use_corrected)??a.use_corrected??!1,u=(o==null?void 0:o.temperature_corrected)??a.temperature_corrected??null,m=(o==null?void 0:o.temperature)??a.temperature_chart??a.temperature_raw??null,p=rr(c&&u!==null&&u!==void 0&&u!==""?u:m??u),x=p!==null,C=c&&u!==null&&u!==void 0&&u!=="";let A=null;o!=null&&o.time?A=o.time:a.timestamp&&N(h(a.timestamp))&&(A=w(h(a.timestamp),"HH:mm"));const G=a.mucusSensation??a.mucus_sensation??"",W=a.mucusAppearance??a.mucus_appearance??"",R=!!G,be=!!W,Na=R||be,Pt=a.observations||"",ka=!!Pt,_a=!!(a.had_relations??a.hadRelations??!1),zt=tt[a.isoDate]||null,Ea=a.peak_marker==="peak"||zt==="P",Ma=tr(a.fertility_symbol);t.set(a.isoDate,{record:a,symbolInfo:Ma,hasTemperature:x,displayTemp:p,showCorrectedIndicator:C,timeValue:A,hasMucus:Na,hasMucusSensation:R,hasMucusAppearance:be,mucusSensation:G,mucusAppearance:W,hasObservations:ka,observationsText:Pt,hasRelations:_a,peakStatus:zt,isPeakDay:Ea})}),t},[e==null?void 0:e.data,tt]),d=n.useMemo(()=>{if(!(e!=null&&e.startDate))return null;const t=h(e.startDate);if(!N(t))return null;let r;if(e!=null&&e.endDate)r=h(e.endDate);else{const a=K(new Date),o=[t,a];oe.length&&o.push(Vt(oe)),r=Vt(o)}return N(r)?{from:t,to:r}:{from:t,to:t}},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,oe]),sa=n.useMemo(()=>{const t={};return d&&(t.outsideCycle=r=>xe(r,d.from)||Oe(r,d.to),t.insideCycleNoRecord=r=>{if(xe(r,d.from)||Oe(r,d.to))return!1;const a=w(r,"yyyy-MM-dd");return!yt.has(a)}),oe.length&&(t.hasRecord=oe),t},[d,oe,yt]),na=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:y(Fa({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-2xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"rounded-2xl border border-rose-400 text-rose-600 focus:ring-2 focus:ring-rose-300 focus:ring-offset-2",day_today:"rounded-2xl ring-1 ring-rose-300 text-rose-700 font-semibold bg-transparent"}),[]),[Dt,at]=n.useState(()=>f&&N(h(f))?h(f):d!=null&&d.to?d.to:K(new Date)),ge=n.useRef(!1),_=n.useRef(null),oa=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1}),D=n.useRef(null),Ct=n.useRef(null),rt=n.useRef(null),St=n.useRef(0),[ia,la]=n.useState(0),[jt,st]=n.useState(!1),E=n.useCallback(t=>{St.current=t,la(t)},[]),Nt=n.useCallback(()=>new Promise(t=>{requestAnimationFrame(()=>{requestAnimationFrame(t)})}),[]),le=n.useCallback((t,{duration:r=ve}={})=>{_.current&&(cancelAnimationFrame(_.current),_.current=null);const a=St.current,o=t-a;return Math.abs(o)<.5||r<=0?(E(t),Promise.resolve()):new Promise(c=>{const u=p=>1-Math.pow(1-p,3),m=performance.now(),l=p=>{const x=p-m,C=Math.min(1,x/r),A=a+o*u(C);if(E(A),C<1){_.current=requestAnimationFrame(l);return}_.current=null,c()};_.current=requestAnimationFrame(l)})},[E]),ca=n.useMemo(()=>({labelDay:t=>{const r=w(t,"yyyy-MM-dd"),a=ie.get(r),o=w(t,"d MMM",{locale:lt});if(!a)return o;const c=[];if(a.hasTemperature&&a.hasMucus?c.push("temperatura y moco"):a.hasTemperature?c.push("temperatura"):a.hasMucus&&c.push("moco"),a.hasRelations&&c.push("RS"),a.peakStatus){const u=a.peakStatus==="P"?"pico ✖":`pico +${a.peakStatus}`;c.push(u)}return c.length?`${o}: ${c.join("; ")}`:o}}),[ie]),ua=n.useCallback(({date:t,activeModifiers:r})=>{const a=w(t,"yyyy-MM-dd"),o=ie.get(a),c=(o==null?void 0:o.hasTemperature)??!1,u=(o==null?void 0:o.hasMucus)??!1;o==null||o.hasRelations;const m=(o==null?void 0:o.peakStatus)??null,l=o==null?void 0:o.symbolInfo,p=l==null?void 0:l.value,x=r.selected,C=y("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",c?"bg-amber-500":"bg-transparent",c&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),A=y("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",u?"bg-teal-500":"bg-transparent",u&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),G=!!(p&&p!=="none"),W=y("relative z-10 text-[1.15rem] leading-none",r.outside||r.outsideCycle?"text-slate-300":x?G?"text-white":"text-rose-600":"text-slate-700"),R=m==="P"?"✖":m?`+${m}`:null,be=G?y("pointer-events-none absolute inset-0 rounded-full transition-opacity",(l==null?void 0:l.color)??"",(l==null?void 0:l.pattern)==="spotting-pattern"?"calendar-spotting-dot":"",p==="white"?"ring-1 ring-slate-300/70":"",x?"opacity-50":"opacity-25"):null;return s.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[s.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[be&&s.jsx("span",{className:be,"aria-hidden":"true"}),s.jsx("span",{className:W,children:w(t,"d")})]}),s.jsxs("div",{className:"mt-[0.22rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[s.jsx("span",{className:C}),s.jsx("span",{className:A})]}),R&&s.jsx("span",{"aria-hidden":"true",className:y("pointer-events-none absolute -top-[1px] right-[1px] rounded-sm px-[2px] text-[0.55rem] font-semibold leading-none text-rose-500 shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",x?"bg-rose-100/90 text-rose-700":"bg-white/90"),children:R})]})},[ie]),O=n.useMemo(()=>{if(!(e!=null&&e.startDate))return[];const t=h(e.startDate);if(!N(t))return[];const r=K(t),a=K(new Date);let o=d!=null&&d.to?K(d.to):a;Oe(o,a)&&(o=a),xe(o,r)&&(o=r);const c=Ht(o,r)+1;if(c<=0)return[];const u=[];for(let m=c-1;m>=0;m-=1){const l=Ia(r,m),p=w(l,"yyyy-MM-dd"),x=Ht(l,r)+1,C=ie.get(p)||null;u.push({isoDate:p,date:l,cycleDay:x,details:C})}return u},[e==null?void 0:e.startDate,d,ie]),kt=n.useMemo(()=>new Set(O.map(t=>t.isoDate)),[O]),da=n.useMemo(()=>{const t=new Map;return O.forEach(r=>{t.set(r.isoDate,r)}),t},[O]),ce=f&&da.get(f)||null,$=(ce==null?void 0:ce.details)??null,_t=($==null?void 0:$.peakStatus)??(f?tt[f]??null:null),fa=($==null?void 0:$.isPeakDay)??_t==="P",Le=n.useMemo(()=>{const t=d!=null&&d.to?w(K(d.to),"yyyy-MM-dd"):null;return b?t??ne[0]??null:ne.length?ne[0]:t},[b,d,ne]);n.useEffect(()=>{if(!(f&&kt.has(f))){if(!Le){f!==null&&U(null);return}f!==Le&&U(Le)}},[f,kt,Le]);const Et=n.useCallback(t=>{if(!t)return;const r=w(t,"yyyy-MM-dd");d&&(xe(t,d.from)||Oe(t,d.to))||U(r)},[d]);n.useEffect(()=>{if(!f)return;const t=h(f);N(t)&&at(r=>r&&r.getFullYear()===t.getFullYear()&&r.getMonth()===t.getMonth()?r:t)},[f]);const Mt=n.useCallback(t=>{at(r=>{const a=r??(d==null?void 0:d.to)??K(new Date);return Ua(a,t==="next"?1:-1)})},[d]);n.useEffect(()=>{if(!q){rt.current=null,E(0),st(!1);return}const t=Ct.current;if(!t)return;const r=t.querySelector(".records-calendar-day-grid");r&&(rt.current=r)},[Dt,q,E]);const nt=n.useCallback(async t=>{var m;if(ge.current)return;ge.current=!0;const r=rt.current,a=((m=r==null?void 0:r.getBoundingClientRect())==null?void 0:m.width)??0,o=t==="next"?-Yt:Yt,c=a?t==="next"?-a:a:o,u=-c;try{await le(c,{duration:ve}),Mt(t),E(u),await Nt(),await le(0,{duration:ve})}finally{ge.current=!1}},[le,Mt,E,Nt]),M=n.useCallback(()=>{ft(null),mt(null),pt(!1),ht(null),Qe(!1)},[]);n.useEffect(()=>()=>{_.current&&(cancelAnimationFrame(_.current),_.current=null),D.current&&(D.current(),D.current=null)},[]);const At=n.useCallback(()=>{Me((e==null?void 0:e.startDate)||""),Ae((e==null?void 0:e.endDate)||""),I(""),M(),dt(!0)},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,M]),Y=n.useCallback(()=>{dt(!1),I(""),M(),Me((e==null?void 0:e.startDate)||""),Ae((e==null?void 0:e.endDate)||"")},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,M]),ma=n.useCallback(()=>{J&&(Y(),J())},[Y,J]),pa=n.useCallback(t=>{var m;if(!q||ge.current||t.pointerType==="mouse"&&t.button!==0||!t.target.closest(".records-calendar-day-grid"))return;const a=oa.current;a.active=!0,a.pointerId=t.pointerId,a.startX=t.clientX,a.startTime=performance.now(),a.dragging=!1;const o=l=>{if(!a.active||l.pointerId!==a.pointerId)return;const p=l.clientX-a.startX;if(!a.dragging&&Math.abs(p)>ar&&(a.dragging=!0,st(!0)),!a.dragging)return;const x=Math.max(-Gt,Math.min(Gt,p));l.preventDefault(),E(x)},c=async l=>{var R;if(!a.active||l.pointerId!==a.pointerId)return;(R=D.current)==null||R.call(D),D.current=null,a.active=!1;const p=l.clientX-a.startX,x=performance.now()-a.startTime,C=x>0?p/x*1e3:0,A=p<=-qt||C<=-$t,G=p>=qt||C>=$t,W=a.dragging;if(a.dragging=!1,st(!1),ge.current){await le(0,{duration:ve});return}if(W&&A){await nt("next");return}if(W&&G){await nt("prev");return}await le(0,{duration:ve})},u=()=>{window.removeEventListener("pointermove",o,{capture:!0}),window.removeEventListener("pointerup",c,{capture:!0}),window.removeEventListener("pointercancel",c,{capture:!0})};(m=D.current)==null||m.call(D),D.current=u,window.addEventListener("pointermove",o,{capture:!0,passive:!1}),window.addEventListener("pointerup",c,{capture:!0}),window.addEventListener("pointercancel",c,{capture:!0})},[nt,le,q,E]),ha=n.useCallback(()=>{M()},[M]),ga=n.useCallback(async()=>{if(!H){I("La fecha de inicio es obligatoria");return}if(b&&V&&V<H){I("La fecha de fin no puede ser anterior al inicio");return}if(e!=null&&e.id){I(""),me(!0);try{const t=F?await F(e.id,H,b&&V||void 0):null;if(t){ft(H),mt((b&&V||void 0)??null),pt(!!b),ht(t),Qe(!0),me(!1);return}await v(e.id,H,b&&V||void 0),await Ee({silent:!0}),j({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),Y()}catch(t){console.error("Error updating start date from records page:",t),I("No se pudieron actualizar las fechas"),j({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{me(!1)}}},[H,V,b,e==null?void 0:e.id,F,v,Ee,j,Y]),ba=n.useCallback(async()=>{if(!(e!=null&&e.id)||!L){M();return}me(!0),Qe(!1);try{const t=e.startDate,r=e.endDate??void 0,a=L!==t,o=a&&L&&t&&xe(h(L),h(t)),c=Ze?Je??void 0:void 0,u=Ze&&Je!==null&&c!==r;if(o&&await ut(e.id,L),u&&c&&Ge){const m=a?L:t;await Ge(e.id,c,m)}await v(e.id,a?L:void 0,c),await Ee({silent:!0}),j({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),Y()}catch(t){console.error("Error adjusting cycle dates from records page:",t),I("No se pudieron actualizar las fechas"),j({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{me(!1),M()}},[e==null?void 0:e.id,e==null?void 0:e.startDate,e==null?void 0:e.endDate,L,Ze,Je,ut,Ge,v,Ee,j,Y,M]),Tt=n.useCallback(()=>{ee(!1),te(null),X(null),pe(null),he(null)},[]),Ft=n.useCallback((t,r=null,a=null)=>{t&&(te(t),X(t.isoDate??null),pe(r),he(a??null),t.isoDate&&U(t.isoDate),ee(!0))},[]),xa=n.useCallback((t,r=null,a=null)=>Ft(t,a,r),[Ft]),va=t=>{var a;const r=(a=e==null?void 0:e.data)==null?void 0:a.find(o=>o.id===t);Ke(r||null)},wa=n.useCallback(t=>{te(t)},[]),ya=n.useCallback((t,r=null,a=null)=>{t&&(U(t),te(null),X(t),pe(a),he(r),ee(!0))},[]),It=n.useCallback(()=>{const t=O.length?O[0].isoDate:(e==null?void 0:e.startDate)||null,r=f||t||null;te(null),X(r),pe(null),he(null),r&&U(r),ee(!0)},[O,e==null?void 0:e.startDate,f]),Lt=n.useCallback((t,r={})=>{var u,m;const a=((u=e==null?void 0:e.data)==null?void 0:u.find(l=>l.isoDate===t))||null,o=a!=null&&a.timestamp&&N(h(a.timestamp))?w(h(a.timestamp),"HH:mm"):w(new Date,"HH:mm"),c=(m=a==null?void 0:a.measurements)!=null&&m.length?a.measurements.map((l,p)=>{const x=(l==null?void 0:l.time)||(l!=null&&l.timestamp&&N(h(l.timestamp))?w(h(l.timestamp),"HH:mm"):o);return{temperature:(l==null?void 0:l.temperature)??(l==null?void 0:l.temperature_raw)??"",temperature_corrected:(l==null?void 0:l.temperature_corrected)??"",time:x,time_corrected:(l==null?void 0:l.time_corrected)||x,use_corrected:!!(l!=null&&l.use_corrected),selected:!!((l==null?void 0:l.selected)??p===0)}}):[{temperature:"",temperature_corrected:"",time:o,time_corrected:o,use_corrected:!1,selected:!0}];return{isoDate:t,measurements:c,mucusSensation:(a==null?void 0:a.mucusSensation)??(a==null?void 0:a.mucus_sensation)??"",mucusAppearance:(a==null?void 0:a.mucusAppearance)??(a==null?void 0:a.mucus_appearance)??"",fertility_symbol:(a==null?void 0:a.fertility_symbol)??(a==null?void 0:a.fertilitySymbol)??"none",observations:(a==null?void 0:a.observations)??"",peak_marker:(a==null?void 0:a.peak_marker)??null,ignored:(a==null?void 0:a.ignored)??!1,...r}},[e==null?void 0:e.data]),Da=async(t,{keepFormOpen:r=!1}={})=>{se(!0);try{await Q(t,We),r||(ee(!1),te(null),X(null),pe(null),he(null))}catch{j({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{se(!1),r&&X((t==null?void 0:t.isoDate)??null)}},Ca=n.useCallback(async t=>{var c;if(!t)return;const r=((c=e==null?void 0:e.data)==null?void 0:c.find(u=>u.isoDate===t))||null,a=!!((r==null?void 0:r.had_relations)??(r==null?void 0:r.hadRelations)??!1),o=Lt(t,{had_relations:!a,hadRelations:!a});se(!0);try{await Q(o,r)}catch{j({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{se(!1)}},[Q,Lt,e==null?void 0:e.data,j]),Sa=async()=>{if(ae){se(!0);try{const t=ae.isoDate;await _e(ae.id),Ke(null),X(null),t&&f===t&&U(t)}catch{j({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{se(!1)}}},Ot={openDateEditor:At,openAddRecord:It,isProcessing:re,isUpdatingDates:et,cycle:e},ja=typeof Re=="function"?Re(Ot):s.jsxs(s.Fragment,{children:[s.jsxs(we,{type:"button",variant:"outline",size:"icon",onClick:At,className:"border-pink-200 rounded-full text-pink-600 hover:bg-pink-500",disabled:re||et,"aria-label":b?"Editar fechas del ciclo":"Editar fecha de inicio",children:[s.jsx(Oa,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:b?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),s.jsxs(we,{type:"button",size:"icon",onClick:It,className:"rounded-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",disabled:re,style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},"aria-label":"Añadir registro",children:[s.jsx(Ya,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),Rt=typeof ye=="function"?ye({...Ot,toggleCalendar:()=>Te(t=>!t),openCalendar:()=>Te(!0),closeCalendar:()=>Te(!1)}):ye??null;return ke&&!(e!=null&&e.id)?s.jsxs("div",{className:"relative flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[s.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),s.jsx("p",{className:"text-center text-slate-600 text-lg",children:"Cargando..."})]}):e!=null&&e.id?s.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[Rt&&s.jsx("div",{className:"space-y-4",children:Rt}),s.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),s.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[s.jsx("div",{ref:Fe,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:s.jsx("div",{className:"relative overflow-hidden rounded-2xl ring-1 ring-rose-100/70",children:s.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[s.jsx(ue.div,{className:"flex flex-col gap-4",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:s.jsxs("div",{className:"flex flex-wrap items-center gap-1 justify-between sm:justify-start",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(i,{className:"h-7 w-7 text-pink-500"}),s.jsxs("button",{type:"button",onClick:()=>Te(t=>!t),className:"group flex items-center gap-1 rounded-full px-1 py-1 text-left transition-all hover:border-rose-800 hover:bg-white/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-400 focus-visible:ring-offset-2 focus-visible:ring-offset-rose-50","aria-expanded":q,"aria-controls":"records-calendar",children:[s.jsx("span",{className:"text-2xl sm:text-2xl font-bold text-slate-700",children:k}),s.jsx("span",{className:"flex items-center gap-1",children:s.jsx(ue.span,{animate:{rotate:q?180:0},className:"flex h-7 w-7 items-center justify-center rounded-full bg-rose-50 text-rose-400",children:s.jsx(Za,{className:"h-4 w-4"})})})]})]}),s.jsx("div",{className:"flex items-center gap-1",children:ja})]})}),Jt&&s.jsx(ue.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:s.jsx(Ra,{cycle:e,startDate:H,endDate:b?V:e==null?void 0:e.endDate,onStartDateChange:t=>Me(t),onEndDateChange:b?t=>Ae(t):void 0,onSave:ga,onCancel:Y,isProcessing:et,dateError:Zt,includeEndDate:b,showOverlapDialog:ea,overlapCycle:Qt,onConfirmOverlap:ba,onCancelOverlap:ha,onClearError:()=>I(""),saveLabel:b?"Guardar fechas":"Guardar cambios",title:b?"Editar fechas del ciclo":"Editar fecha de inicio",description:b?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:J?ma:void 0,deleteTitle:Be,deleteDescription:T,deleteLabel:He,isDeletingCycle:z})}),s.jsx(Xa,{initial:!1,children:q&&s.jsx(ue.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:s.jsx("div",{ref:Ct,onPointerDown:pa,"data-calendar-dragging":jt?"true":"false",className:y("w-full max-w-sm rounded-3xl bg-white/40 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:transition-transform [&_.records-calendar-day-grid]:duration-200 [&_.records-calendar-day-grid]:ease-out [&_.records-calendar-day-grid]:[transform:translateX(var(--calendar-drag-x,0px))] data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:duration-0 data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:ease-linear",jt?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${ia}px`},children:s.jsx(qa,{mode:"single",locale:lt,month:Dt??void 0,onMonthChange:at,selected:f&&N(h(f))?h(f):void 0,onSelect:Et,onDayClick:Et,modifiers:sa,labels:ca,components:{DayContent:ua},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-rose-200 [&_button[aria-selected=true]]:bg-rose-200 [&_button[aria-selected=true]]:rounded-2xl",classNames:na,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),s.jsxs("div",{ref:gt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:wt,maxHeight:`calc(100dvh - ${wt}px - var(--bottom-nav-safe, 0px))`,WebkitOverflowScrolling:"touch"},children:[s.jsx(ue.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 pb-[calc(var(--bottom-nav-safe,0px))] sm:px-2 lg:px-4",children:O.length===0?s.jsx(ue.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:s.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[s.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-rose-500 shadow-inner",children:s.jsx(ct,{className:"h-8 w-8"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),s.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):s.jsx(er,{isoDate:f,cycleDay:(ce==null?void 0:ce.cycleDay)??null,details:$,peakStatus:_t,isPeakDay:fa,onEdit:xa,onDelete:va,onAdd:ya,onToggleRelations:Ca,isProcessing:re})}),je&&s.jsx("div",{className:"pt-4 space-y-4",children:je})]})]}),s.jsx(Ka,{open:Kt,onOpenChange:t=>{t?ee(!0):Tt()},children:s.jsx(Ja,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:s.jsx($a,{onSubmit:Da,onCancel:Tt,initialData:We,cycleStartDate:e==null?void 0:e.startDate,cycleEndDate:e==null?void 0:e.endDate,isProcessing:re,isEditing:!!We,cycleData:e==null?void 0:e.data,onDateSelect:wa,defaultIsoDate:ta,focusedField:aa,initialSectionKey:ra})})}),s.jsx(Ga,{isOpen:!!ae,onClose:()=>Ke(null),onConfirm:Sa,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:ae?`¿Estás seguro de que quieres eliminar el registro del ${w(h(ae.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:re})]}):s.jsxs("div",{className:"relative flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[s.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),s.jsx("p",{className:"text-center text-slate-600 text-lg",children:"No hay ciclo activo."})]})},gr=()=>s.jsx(sr,{});export{sr as RecordsExperience,gr as default};
