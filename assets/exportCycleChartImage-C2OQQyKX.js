import{ao as $,O as A,j as z}from"./index-ByFXgX-t.js";import{F as B}from"./FertilityChart-C1dfcuJt.js";import"./computePeakStatuses-hwVxT-Am.js";import"./useCycleData-BwqH7MfP.js";import"./badge-CetW1kHg.js";import"./useFertilityChart-B4dbAta_.js";import"./peak-mode-button-DTRv1E4U.js";async function L(c,e=2500){const i=performance.now();for(;performance.now()-i<e;){const n=c.querySelector("svg");if(n){const s=n.getBoundingClientRect();if(s.width>50&&s.height>50)return n}await new Promise(s=>requestAnimationFrame(s))}throw new Error("No se pudo renderizar el SVG del gráfico (timeout).")}function V(c,e){const i=["--phase-rel","--phase-fertile","--phase-post","--phase-post-abs","--phase-rel-stop","--phase-fertile-stop","--phase-post-stop","--phase-post-abs-stop","--phase-text-shadow"],n=getComputedStyle(c);i.forEach(s=>{const r=n.getPropertyValue(s);r&&r.trim()&&e.style.setProperty(s,r.trim())})}async function j(c,{widthPx:e,heightPx:i,pixelRatio:n=2,background:s="#ffffff"}){const r="http://www.w3.org/2000/svg",o=c.cloneNode(!0);o.setAttribute("width",String(e)),o.setAttribute("height",String(i)),V(c,o);const a=document.createElementNS(r,"rect");a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("fill",s),o.insertBefore(a,o.firstChild);const d=new XMLSerializer().serializeToString(o),l=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(d)}`,t=new Image;t.decoding="async",t.src=l,await t.decode();const h=document.createElement("canvas");h.width=Math.round(e*n),h.height=Math.round(i*n);const m=h.getContext("2d");return m.setTransform(n,0,0,n,0,0),m.imageSmoothingEnabled=!0,m.imageSmoothingQuality="high",m.drawImage(t,0,0,e,i),h.toDataURL("image/png")}async function W(c){const e=new Image;e.src=c,await e.decode();const i=Math.min(e.width,220),n=Math.min(e.height,220),s=document.createElement("canvas");s.width=i,s.height=n;const r=s.getContext("2d");r.drawImage(e,0,0,i,n);const{data:o}=r.getImageData(0,0,i,n);for(let a=0;a<o.length;a+=100){const d=o[a],l=o[a+1],t=o[a+2];if(o[a+3]>10&&(d<245||l<245||t<245))return}throw new Error("PNG generado en blanco")}async function X(c,{threshold:e=248,alphaThreshold:i=10,padding:n=12,sampleMax:s=700}={}){const r=new Image;r.src=c,await r.decode();const o=r.width,a=r.height,d=Math.min(1,s/o),l=Math.max(1,Math.round(o*d)),t=Math.max(1,Math.round(a*d)),h=document.createElement("canvas");h.width=l,h.height=t;const m=h.getContext("2d");m.drawImage(r,0,0,l,t);const{data:f}=m.getImageData(0,0,l,t);let g=l,E=t,x=-1,b=-1;for(let u=0;u<t;u+=1)for(let w=0;w<l;w+=1){const I=(u*l+w)*4,F=f[I],R=f[I+1],T=f[I+2],U=f[I+3]>i,k=F<e||R<e||T<e;U&&k&&(w<g&&(g=w),u<E&&(E=u),w>x&&(x=w),u>b&&(b=u))}if(x<0||b<0)return{dataUrl:c,widthPx:o,heightPx:a};const M=1/d;let C=Math.floor(g*M),v=Math.floor(E*M),P=Math.ceil((x+1)*M),D=Math.ceil((b+1)*M);C=Math.max(0,C-n),v=Math.max(0,v-n),P=Math.min(o,P+n),D=Math.min(a,D+n);const p=Math.max(1,P-C),y=Math.max(1,D-v),S=document.createElement("canvas");S.width=p,S.height=y;const N=S.getContext("2d");return N.fillStyle="#ffffff",N.fillRect(0,0,p,y),N.drawImage(r,C,v,p,y,0,0,p,y),{dataUrl:S.toDataURL("image/png"),widthPx:p,heightPx:y}}async function Z({cycle:c,entries:e,widthPx:i,heightPx:n,pixelRatio:s=1.5,visibleDays:r,initialScrollIndex:o=0}){if(typeof window>"u")throw new Error("renderCycleChartToPng solo está disponible en el navegador.");const a=Math.max(Number.isFinite(Number(r))?Number(r):e?.length??0,1),d=Math.max((e?.length??1)-1,0),l=Math.min(Math.max(Number.isFinite(Number(o))?Number(o):0,0),d),t=document.createElement("div");t.style.position="fixed",t.style.left="-10000px",t.style.top="0",t.style.width=`${i}px`,t.style.height=`${n}px`,t.style.background="#ffffff",t.style.pointerEvents="none",t.style.zIndex="-1",document.body.appendChild(t);const h=$.createRoot(t);try{A.flushSync(()=>{h.render(z.jsx(B,{data:e,isFullScreen:!0,orientation:"landscape",onToggleIgnore:()=>{},onEdit:()=>{},onTogglePeak:()=>{},cycleId:`${c?.id??"export"}-${e?.[0]?.isoDate??"seg"}`,initialScrollIndex:l,visibleDays:a,showInterpretation:!1,reduceMotion:!0,forceLandscape:!0,currentPeakIsoDate:null,showRelationsRow:!1,fertilityStartConfig:null,fertilityCalculatorCycles:[],fertilityCalculatorCandidates:null,onShowPhaseInfo:null,isArchivedCycle:!1,cycleEndDate:c?.endDate??null,exportMode:!0}))}),document.fonts?.ready&&await document.fonts.ready,A.flushSync(()=>{}),document.fonts?.ready&&await document.fonts.ready;const m=await L(t),f=await j(m,{widthPx:i,heightPx:n,pixelRatio:s,background:"#ffffff"});await W(f);const g=await X(f,{padding:12});return{dataUrl:g.dataUrl,widthPx:g.widthPx,heightPx:g.heightPx}}finally{h.unmount(),t.remove()}}export{Z as renderCycleChartToPng};
