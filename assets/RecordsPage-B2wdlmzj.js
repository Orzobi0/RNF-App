import{c as ct,r as n,g as w,f as u,j as a,H as D,B as ot,K as Zt,S as N,Q as Fe,l as E,b as Pa,V as $a,n as za,m as ge}from"./index-DH3_E9Yn.js";import{L as lt,T as Ha,P as Ba,N as Va,C as Ua}from"./NewCycleDialog-tvXiEQYk.js";import{T as Ya,j as Xa,h as qa,e as Wa,c as Ga,F as Xt,m as qt,k as ye,i as Ie,l as Ka,A as Qa,n as Za,D as Ja}from"./computePeakStatuses-P1dm--_1.js";import{l as De,P as es}from"./badge-CdG7NQBE.js";import{a as ts,H as as,D as ss}from"./DeletionDialog-DcHdHws2.js";import{u as rs,D as ns,a as os}from"./useCycleData-BKkKqmXq.js";import"./OverlapWarningDialog-CkV2JUiC.js";import"./input-DQhpSuZa.js";import"./label-UHMSfazx.js";import"./checkbox-2dsJVv6E.js";import"./eye-CYxb1UHs.js";const Wt=ct("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),ls=ct("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),is=ct("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),cs=({isoDate:d,cycleDay:b,details:o,peakStatus:y,isPeakDay:j,onEdit:m,onDelete:I,onAdd:k,onToggleRelations:ve,isProcessing:M})=>{const Le=!!o?.record,Ce=n.useMemo(()=>{if(!d)return null;try{return w(u(d),"dd/MM/yyyy",{locale:De})}catch{return null}},[d]),ue=o?.symbolInfo?.label||"Sin símbolo",Oe=o?.symbolInfo?.value||"none",Pe=o?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",Ne=()=>{!o?.record||!m||m(o.record,null)},Q=()=>{!o?.record?.id||!I||I(o.record.id)},$e=()=>{!d||!k||k(d)},F=(S,L=null)=>{if(o?.record&&m){m(o.record,S,L);return}d&&k&&k(d,S,L)},ze=()=>{!d||!ve||ve(d)},B=(S,L={})=>S&&typeof S=="string"&&S.trim().length>0||typeof S=="number"?S:L.placeholder||"—",He=o?.hasTemperature?`${o.displayTemp} °C`:"—",Be=o?.timeValue||"—",Ve=!!o?.timeValue,Ue=o?.hasMucusSensation?o.mucusSensation:"—",Ye=o?.hasMucusAppearance?o.mucusAppearance:"—",je=o?.observationsText?.trim(),Z=!!o?.hasRelations;let J=null,me=null;y&&(y==="P"||j?(J="Día pico",me="peak"):(J=`+${y}`,me="post-peak"));const Xe=()=>{switch(Oe){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!d)return a.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const r="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return a.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Ce,b?` · Día ${b}`:""]}),J&&a.jsx("span",{className:D("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:J})]}),a.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[a.jsx("button",{type:"button",onClick:()=>F("symbol","fertilitySymbol"),className:D("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Xe(),Pe),title:ue,"aria-label":ue}),Le?a.jsxs(a.Fragment,{children:[a.jsxs(ot,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Ne,disabled:M,children:[M?a.jsx(lt,{className:"h-4 w-4 animate-spin"}):a.jsx(is,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Editar registro"})]}),a.jsxs(ot,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Q,disabled:M,children:[M?a.jsx(lt,{className:"h-4 w-4 animate-spin"}):a.jsx(Ha,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):a.jsxs(ot,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:$e,disabled:M,children:[M&&a.jsx(lt,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),a.jsxs("div",{className:"mt-4 space-y-3",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("temperature","temperature"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[a.jsx(Ya,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"font-semibold",children:B(He)}),o?.showCorrectedIndicator&&a.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),a.jsxs("button",{type:"button",onClick:()=>F("temperature","time"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ve?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[a.jsx(Xa,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:B(Be)})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("sensation","mucusSensation"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[a.jsx(qa,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:B(Ue)})]}),a.jsxs("button",{type:"button",onClick:()=>F("appearance","mucusAppearance"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[a.jsx(Wa,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:B(Ye)})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("observations","observations"),className:D(r,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",je?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[a.jsx(ls,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"truncate",children:B(je,{placeholder:"-"})})]}),a.jsx("button",{type:"button",onClick:ze,disabled:M,className:D("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Z?"border-rose-50 bg-rose-50":"border-slate-200 bg-white",M&&"opacity-70 cursor-not-allowed"),title:Z?"Hubo relaciones":"Sin relaciones","aria-label":Z?"Hubo relaciones":"Sin relaciones",children:a.jsx(Zt,{className:D("h-4 shrink-0 w-4",Z?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},Jt=d=>d.replace(".","").toLowerCase(),be=d=>Jt(w(d,"MMM",{locale:De})),ds=d=>Jt(w(d,"d MMM yyyy",{locale:De})),us=({startDate:d,endDate:b})=>{if(!b){if(!d)return"Mis registros";const k=u(d);return N(k)?`${ds(k)} - actualidad`:"Mis registros"}if(!d)return"Mis registros";const o=u(d),y=u(b);if(!N(o)||!N(y))return"Mis registros";const j=o.getFullYear()===y.getFullYear();if(j&&o.getMonth()===y.getMonth())return`${o.getDate()}–${y.getDate()} ${be(o)} ${o.getFullYear()}`;if(j)return`${o.getDate()} ${be(o)} – ${y.getDate()} ${be(y)} ${o.getFullYear()}`;const I=`${o.getFullYear()}–${String(y.getFullYear()).slice(-2)}`;return`${o.getDate()} ${be(o)} – ${y.getDate()} ${be(y)} · ${I}`},ms=({startDate:d,endDate:b,recordCount:o=0,referenceDate:y=new Date})=>{if(!d)return`${o} registros`;const j=u(d);if(!N(j))return`${o} registros`;if(!b)return`Día ${Fe(E(y),E(j))+1} · ${o} registros`;const m=u(b);return N(m)?`${Fe(E(m),E(j))+1} días · ${o} registros`:`${o} registros`},fs=d=>Xt.find(b=>b.value===d)||Xt[0],Gt=10,it=60,Kt=750,Qt=120,ps=85,hs=5,we=180,xs=d=>{if(d==null||d==="")return null;const b=Number(typeof d=="string"?d.replace(",","."):d);return Number.isFinite(b)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(b):null},gs=({cycle:d,headerTitle:b,headerIcon:o=Wt,headerActions:y,topAccessory:j,includeEndDate:m=!1,addOrUpdateDataPoint:I,deleteRecord:k,isLoading:ve,updateCycleDates:M,checkCycleOverlap:Le,forceShiftNextCycleStart:Ce,forceUpdateCycleStart:ue,startNewCycle:Oe,refreshData:Pe,afterRecordsContent:Ne=null,onRequestDeleteCycle:Q=null,dateEditorDeleteTitle:$e="Eliminar ciclo",dateEditorDeleteDescription:F="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:ze="Eliminar ciclo",isDeletingCycle:B=!1}={})=>{const{currentCycle:He,addOrUpdateDataPoint:Be,deleteRecord:Ve,isLoading:Ue,updateCycleDates:Ye,checkCycleOverlap:je,forceUpdateCycleStart:Z,forceShiftNextCycleStart:J,startNewCycle:me,refreshData:Xe}=rs(),r=d??He,S=ve??Ue,L=I||(async(e,t)=>{if(r?.id)return Be(e,t,r.id)}),ea=k||(async e=>{if(r?.id)return Ve(e,r.id)}),Se=M||(async(e,t,s)=>Ye(e??r?.id,t,s)),qe=Le??je,dt=ue||(async(e,t)=>Z(e??r?.id,t)),We=Ce||(async(e,t,s)=>J(e??r?.id,t,s)),ta=Oe??me,ke=Pe??Xe,{toast:R}=Pa(),[aa,V]=n.useState(!1),[Ge,ee]=n.useState(null),[te,Ke]=n.useState(null),[ae,se]=n.useState(!1),[sa,ut]=n.useState(!1),[U,Me]=n.useState(()=>r?.startDate||""),[Y,Ee]=n.useState(()=>r?.endDate||""),[ra,O]=n.useState(""),[P,mt]=n.useState(null),[Qe,ft]=n.useState(null),[Ze,pt]=n.useState(!1),[na,ht]=n.useState(null),[oa,Je]=n.useState(!1),[et,fe]=n.useState(!1),[p,X]=n.useState(null),[la,q]=n.useState(null),[ia,pe]=n.useState(null),[ca,re]=n.useState(null),[da,tt]=n.useState(!1),xt=r?.data?.length??0,gt=!r?.endDate,ua=n.useMemo(()=>b||us({startDate:r?.startDate,endDate:r?.endDate}),[r?.endDate,r?.startDate,b]),yt=n.useMemo(()=>ms({startDate:r?.startDate,endDate:r?.endDate,recordCount:xt}),[r?.endDate,r?.startDate,xt]),bt=!0,Re=n.useRef(null),wt=n.useRef(null),Dt=n.useRef(0),[vt,Ct]=n.useState(0),_e=n.useCallback(()=>{const e=Re.current;if(!e){Dt.current=0,Ct(0);return}const s=e.getBoundingClientRect().height;Dt.current=s,Ct(l=>Math.abs(l-s)>.5?s:l)},[]);n.useLayoutEffect(()=>{let e=window.requestAnimationFrame(_e);const t=()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)};window.addEventListener("resize",t);let s;return typeof ResizeObserver<"u"&&(s=new ResizeObserver(()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)}),Re.current&&s.observe(Re.current)),()=>{window.removeEventListener("resize",t),s&&s.disconnect(),e&&window.cancelAnimationFrame(e)}},[_e]);const Nt=n.useMemo(()=>Math.max(Math.round(vt+Gt),Gt),[vt]);n.useEffect(()=>{Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate]);const ne=n.useMemo(()=>r?.data?.length?[...r.data].filter(e=>e?.isoDate).sort((e,t)=>{const s=u(e.isoDate);return u(t.isoDate)-s}).map(e=>e.isoDate):[],[r?.data]);n.useEffect(()=>{const e=wt.current;e&&e.scrollTo({top:0,behavior:"auto"})},[]);const oe=n.useMemo(()=>r?.data?.length?r.data.map(e=>{if(!e?.isoDate)return null;const t=u(e.isoDate);return N(t)?t:null}).filter(Boolean):[],[r?.data]),jt=n.useMemo(()=>new Set(ne),[ne]),W=n.useMemo(()=>Ga(r?.data??[]),[r?.data]),le=n.useMemo(()=>{const e=new Map;return r?.data?.length&&r.data.forEach(t=>{if(!t?.isoDate)return;const s=t.measurements?.find(Oa=>Oa?.selected)||(t.temperature_chart||t.temperature_raw?{temperature:t.temperature_chart??t.temperature_raw,temperature_corrected:t.temperature_corrected??null,time:t.timestamp?w(u(t.timestamp),"HH:mm"):null,use_corrected:t.use_corrected??!1}:null),l=s?.use_corrected??t.use_corrected??!1,c=s?.temperature_corrected??t.temperature_corrected??null,i=s?.temperature??t.temperature_chart??t.temperature_raw??null,f=xs(l&&c!==null&&c!==void 0&&c!==""?c:i??c),g=f!==null,C=l&&c!==null&&c!==void 0&&c!=="";let h=null;s?.time?h=s.time:t.timestamp&&N(u(t.timestamp))&&(h=w(u(t.timestamp),"HH:mm"));const _=t.mucusSensation??t.mucus_sensation??"",ce=t.mucusAppearance??t.mucus_appearance??"",de=!!_,H=!!ce,nt=de||H,xe=t.observations||"",Te=!!xe,Ia=!!(t.had_relations??t.hadRelations??!1),Yt=W[t.isoDate]||null,Fa=t.peak_marker==="peak"||Yt==="P",La=fs(t.fertility_symbol);e.set(t.isoDate,{record:t,symbolInfo:La,hasTemperature:g,displayTemp:f,showCorrectedIndicator:C,timeValue:h,hasMucus:nt,hasMucusSensation:de,hasMucusAppearance:H,mucusSensation:_,mucusAppearance:ce,hasObservations:Te,observationsText:xe,hasRelations:Ia,peakStatus:Yt,isPeakDay:Fa})}),e},[r?.data,W]),x=n.useMemo(()=>{if(!r?.startDate)return null;const e=u(r.startDate);if(!N(e))return null;let t;if(r?.endDate)t=u(r.endDate);else{const s=E(new Date),l=[e,s];oe.length&&l.push(qt(oe)),t=qt(l)}return N(t)?{from:e,to:t}:{from:e,to:e}},[r?.startDate,r?.endDate,oe]),ma=n.useMemo(()=>{const e={};return x&&(e.outsideCycle=t=>ye(t,x.from)||Ie(t,x.to),e.insideCycleNoRecord=t=>{if(ye(t,x.from)||Ie(t,x.to))return!1;const s=w(t,"yyyy-MM-dd");return!jt.has(s)}),oe.length&&(e.hasRecord=oe),e},[x,oe,jt]),fa=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:D($a({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[St,at]=n.useState(()=>p&&N(u(p))?u(p):x?.to?x.to:E(new Date)),he=n.useRef(!1),A=n.useRef(null),pa=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),G=n.useRef(null),kt=n.useRef(null),Mt=n.useRef(null),Et=n.useRef(0),[ha,xa]=n.useState(0),[Rt,_t]=n.useState(!1),$=n.useCallback(e=>{Et.current=e,xa(e)},[]),At=n.useCallback(()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(e)})}),[]),ie=n.useCallback((e,{duration:t=we}={})=>{A.current&&(cancelAnimationFrame(A.current),A.current=null);const s=Et.current,l=e-s;return Math.abs(l)<.5||t<=0?($(e),Promise.resolve()):new Promise(c=>{const i=g=>1-Math.pow(1-g,3),v=performance.now(),f=g=>{const C=g-v,h=Math.min(1,C/t),_=s+l*i(h);if($(_),h<1){A.current=requestAnimationFrame(f);return}A.current=null,c()};A.current=requestAnimationFrame(f)})},[$]),ga=n.useMemo(()=>({labelDay:e=>{const t=w(e,"yyyy-MM-dd"),s=le.get(t),l=w(e,"d MMM",{locale:De}),c=s?.peakStatus??W[t]??null,i=[];if(s?.hasTemperature&&s?.hasMucus?i.push("temperatura y moco"):s?.hasTemperature?i.push("temperatura"):s?.hasMucus&&i.push("moco"),s?.hasRelations&&i.push("RS"),c){const v=c==="P"?"pico ✖":`pico +${c}`;i.push(v)}return i.length?`${l}: ${i.join("; ")}`:l}}),[W,le]),ya=n.useCallback(({date:e,activeModifiers:t})=>{const s=w(e,"yyyy-MM-dd"),l=le.get(s),c=l?.hasTemperature??!1,i=l?.hasMucus??!1,v=l?.hasRelations??!1,f=l?.peakStatus??W[s]??null,g=l?.symbolInfo,C=g?.value,h=t.selected,_=t.today,ce=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",c?"bg-amber-500":"bg-transparent",c&&h?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),de=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",i?"bg-teal-500":"bg-transparent",i&&h?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),H=!!(C&&C!=="none"),nt=D("relative z-10 text-[1.15rem] leading-none",t.outside||t.outsideCycle?"text-slate-300":h?H?"text-white":"text-fertiliapp-fuerte":_?"text-subtitulo font-semibold":"text-slate-700"),xe=f==="P"?"✖":f?`+${f}`:null,Te=H?D("pointer-events-none absolute inset-0 rounded-full transition-opacity",g?.color??"",g?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",C==="white"?"ring-1 ring-slate-300/70":"",h?"opacity-50":"opacity-25"):null;return a.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[a.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[_&&!h&&!(t.outside||t.outsideCycle)&&a.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),h&&a.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full bg-tarjeta border border-fertiliapp-fuerte"}),Te&&a.jsx("span",{className:Te,"aria-hidden":"true"}),a.jsx("span",{className:nt,children:w(e,"d")}),v&&a.jsx(Zt,{"aria-hidden":"true",className:"pointer-events-none absolute -bottom-[0.2px] -right-[0.2px] h-2 w-2 text-rose-500 fill-current"})]}),a.jsxs("div",{className:"mt-[0.35rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[a.jsx("span",{className:ce}),a.jsx("span",{className:de})]}),xe&&a.jsx("span",{"aria-hidden":"true",className:D("pointer-events-none absolute -top-[1px] right-[0.5px] rounded-sm px-[2px] text-[0.75rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",h?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:xe})]})},[W,le]),z=n.useMemo(()=>{if(!r?.startDate)return[];const e=u(r.startDate);if(!N(e))return[];const t=E(e),s=E(new Date);let l=x?.to?E(x.to):s;Ie(l,s)&&(l=s),ye(l,t)&&(l=t);const c=Fe(l,t)+1;if(c<=0)return[];const i=[];for(let v=c-1;v>=0;v-=1){const f=za(t,v),g=w(f,"yyyy-MM-dd"),C=Fe(f,t)+1,h=le.get(g)||null;i.push({isoDate:g,date:f,cycleDay:C,details:h})}return i},[r?.startDate,x,le]),Tt=n.useMemo(()=>new Set(z.map(e=>e.isoDate)),[z]),ba=n.useMemo(()=>{const e=new Map;return z.forEach(t=>{e.set(t.isoDate,t)}),e},[z]),It=p&&ba.get(p)||null,st=It?.details??null,Ft=st?.peakStatus??(p?W[p]??null:null),wa=st?.isPeakDay??Ft==="P",Ae=n.useMemo(()=>{const e=x?.to?w(E(x.to),"yyyy-MM-dd"):null;return m?e??ne[0]??null:ne.length?ne[0]:e},[m,x,ne]);n.useEffect(()=>{if(!(p&&Tt.has(p))){if(!Ae){p!==null&&X(null);return}p!==Ae&&X(Ae)}},[p,Tt,Ae]);const Lt=n.useCallback(e=>{if(!e)return;const t=w(e,"yyyy-MM-dd");x&&(ye(e,x.from)||Ie(e,x.to))||X(t)},[x]);n.useEffect(()=>{if(!p)return;const e=u(p);N(e)&&at(t=>t&&t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()?t:e)},[p]);const Ot=n.useCallback(e=>{at(t=>{const s=t??x?.to??E(new Date);return Ka(s,e==="next"?1:-1)})},[x]);n.useEffect(()=>{const e=kt.current;if(!e)return;const t=e.querySelector(".records-calendar-day-grid");t&&(Mt.current=t)},[St,bt,$]);const rt=n.useCallback(async e=>{if(he.current)return;he.current=!0;const s=Mt.current?.getBoundingClientRect()?.width??0,l=e==="next"?-Qt:Qt,c=s?e==="next"?-s:s:l,i=-c;try{await ie(c,{duration:we}),Ot(e),$(i),await At(),await ie(0,{duration:we})}finally{he.current=!1}},[ie,Ot,$,At]),T=n.useCallback(()=>{mt(null),ft(null),pt(!1),ht(null),Je(!1)},[]);n.useEffect(()=>()=>{A.current&&(cancelAnimationFrame(A.current),A.current=null),G.current&&(G.current(),G.current=null)},[]);const Pt=n.useCallback(()=>{Me(r?.startDate||""),Ee(r?.endDate||""),O(""),T(),ut(!0)},[r?.startDate,r?.endDate,T]),K=n.useCallback(()=>{ut(!1),O(""),T(),Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate,T]),Da=n.useCallback(()=>{Q&&(K(),Q())},[K,Q]),va=n.useCallback(e=>{if(he.current||e.pointerType==="mouse"&&e.button!==0)return;const t=e.target.closest(".records-calendar-day-grid");if(!t)return;const s=pa.current;s.active=!0,s.pointerId=e.pointerId,s.startX=e.clientX,s.startTime=performance.now(),s.dragging=!1;const l=t.getBoundingClientRect().width||0;s.gridWidth=l,s.swipeThreshold=l?Math.max(it,l*.25):it;const c=f=>{if(!s.active||f.pointerId!==s.pointerId)return;const g=f.clientX-s.startX;if(!s.dragging&&Math.abs(g)>hs&&(s.dragging=!0,_t(!0)),!s.dragging)return;const C=s.gridWidth?s.gridWidth*.7:ps,h=Math.max(-C,Math.min(C,g));f.preventDefault(),$(h)},i=async f=>{if(!s.active||f.pointerId!==s.pointerId)return;G.current?.(),G.current=null,s.active=!1;const g=f.clientX-s.startX,C=performance.now()-s.startTime,h=C>0?g/C*1e3:0,_=s.swipeThreshold||it,ce=g<=-_||h<=-Kt,de=g>=_||h>=Kt,H=s.dragging;if(s.dragging=!1,_t(!1),he.current){await ie(0,{duration:we});return}if(H&&ce){await rt("next");return}if(H&&de){await rt("prev");return}await ie(0,{duration:we})},v=()=>{window.removeEventListener("pointermove",c,{capture:!0}),window.removeEventListener("pointerup",i,{capture:!0}),window.removeEventListener("pointercancel",i,{capture:!0})};G.current?.(),G.current=v,window.addEventListener("pointermove",c,{capture:!0,passive:!1}),window.addEventListener("pointerup",i,{capture:!0}),window.addEventListener("pointercancel",i,{capture:!0})},[rt,ie,bt,$]),Ca=n.useCallback(()=>{T()},[T]),Na=n.useCallback(async()=>{if(!U){O("La fecha de inicio es obligatoria");return}if(m&&Y&&Y<U){O("La fecha de fin no puede ser anterior al inicio");return}if(r?.id){O(""),fe(!0);try{const e=qe?await qe(r.id,U,m&&Y||void 0):null;if(e){mt(U),ft((m&&Y||void 0)??null),pt(!!m),ht(e),Je(!0),fe(!1);return}await Se(r.id,U,m&&Y||void 0),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),K()}catch(e){console.error("Error updating start date from records page:",e),O("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{fe(!1)}}},[U,Y,m,r?.id,qe,Se,ke,R,K]),ja=n.useCallback(async()=>{if(!r?.id||!P){T();return}fe(!0),Je(!1);try{const e=r.startDate,t=r.endDate??void 0,s=P!==e,l=s&&P&&e&&ye(u(P),u(e)),c=Ze?Qe??void 0:void 0,i=Ze&&Qe!==null&&c!==t;if(l&&await dt(r.id,P),i&&c&&We){const v=s?P:e;await We(r.id,c,v)}await Se(r.id,s?P:void 0,c),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),K()}catch(e){console.error("Error adjusting cycle dates from records page:",e),O("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{fe(!1),T()}},[r?.id,r?.startDate,r?.endDate,P,Ze,Qe,dt,We,Se,ke,R,K,T]),$t=n.useCallback(()=>{V(!1),ee(null),q(null),pe(null),re(null)},[]),zt=n.useCallback((e,t=null,s=null)=>{e&&(ee(e),q(e.isoDate??null),pe(t),re(s??null),e.isoDate&&X(e.isoDate),V(!0))},[]),Sa=n.useCallback((e,t=null,s=null)=>zt(e,s,t),[zt]),ka=e=>{const t=r?.data?.find(s=>s.id===e);Ke(t||null)},Ma=n.useCallback(e=>{ee(e)},[]),Ea=n.useCallback((e,t=null,s=null)=>{e&&(X(e),ee(null),q(e),pe(s),re(t),V(!0))},[]),Ht=n.useCallback(()=>{const e=z.length?z[0].isoDate:r?.startDate||null,t=p||e||null;ee(null),q(t),pe(null),re(null),t&&X(t),V(!0)},[z,r?.startDate,p]),Bt=n.useCallback((e,t={})=>{const s=r?.data?.find(i=>i.isoDate===e)||null,l=s?.timestamp&&N(u(s.timestamp))?w(u(s.timestamp),"HH:mm"):w(new Date,"HH:mm"),c=s?.measurements?.length?s.measurements.map((i,v)=>{const f=i?.time||(i?.timestamp&&N(u(i.timestamp))?w(u(i.timestamp),"HH:mm"):l);return{temperature:i?.temperature??i?.temperature_raw??"",temperature_corrected:i?.temperature_corrected??"",time:f,time_corrected:i?.time_corrected||f,use_corrected:!!i?.use_corrected,selected:!!(i?.selected??v===0)}}):[{temperature:"",temperature_corrected:"",time:l,time_corrected:l,use_corrected:!1,selected:!0}];return{isoDate:e,measurements:c,mucusSensation:s?.mucusSensation??s?.mucus_sensation??"",mucusAppearance:s?.mucusAppearance??s?.mucus_appearance??"",fertility_symbol:s?.fertility_symbol??s?.fertilitySymbol??"none",observations:s?.observations??"",peak_marker:s?.peak_marker??null,ignored:s?.ignored??!1,...t}},[r?.data]),Ra=async(e,{keepFormOpen:t=!1}={})=>{se(!0);try{await L(e,Ge),t||(V(!1),ee(null),q(null),pe(null),re(null))}catch{R({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{se(!1),t&&q(e?.isoDate??null)}},_a=n.useCallback(async e=>{if(!e)return;const t=r?.data?.find(c=>c.isoDate===e)||null,s=!!(t?.had_relations??t?.hadRelations??!1),l=Bt(e,{had_relations:!s,hadRelations:!s});se(!0);try{await L(l,t)}catch{R({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{se(!1)}},[L,Bt,r?.data,R]),Aa=async()=>{if(te){se(!0);try{const e=te.isoDate;await ea(te.id),Ke(null),q(null),e&&p===e&&X(e)}catch{R({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{se(!1)}}},Vt={openDateEditor:Pt,openAddRecord:Ht,isProcessing:ae,isUpdatingDates:et,cycle:r},Ta=typeof y=="function"?y(Vt):a.jsxs(a.Fragment,{children:[a.jsxs(ts,{type:"button",onClick:Pt,className:"text-subtitulo",disabled:ae||et,"aria-label":m?"Editar fechas del ciclo":"Editar fecha de inicio",children:[a.jsx(Ba,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:m?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),a.jsxs(as,{type:"button",onClick:Ht,disabled:ae,"aria-label":"Añadir registro",children:[a.jsx(es,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),Ut=typeof j=="function"?j({...Vt}):j??null;return S&&!r?.id?a.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:a.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):r?.id?a.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[a.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[a.jsx("div",{ref:Re,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:a.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:a.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[a.jsx(ge.div,{className:"flex flex-col gap-2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:a.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/50 p-3 shadow-sm backdrop-blur-md",children:a.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[a.jsxs("div",{className:"flex items-center justify-between gap-2 text-[10px] uppercase tracking-[0.18em] text-base",children:[a.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[Ut&&a.jsx("div",{className:"flex items-center",children:Ut}),a.jsx("span",{children:gt?"CICLO ACTUAL":"CICLO ARCHIVADO"})]}),a.jsx("div",{className:"flex shrink-0 items-center gap-2",children:Ta})]}),a.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[a.jsx(o,{className:"h-5 w-5 text-subtitulo"}),a.jsx("span",{className:D("font-semibold text-titulo leading-tight","text-[21px] sm:text-[22px]"),children:ua})]}),yt&&a.jsx("div",{className:"text-[13px] text-base whitespace-nowrap",children:yt})]})})}),sa&&a.jsx(ge.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:a.jsx(Ua,{cycle:r,startDate:U,endDate:m?Y:r?.endDate,onStartDateChange:e=>Me(e),onEndDateChange:m?e=>Ee(e):void 0,onSave:Na,onCancel:K,isProcessing:et,dateError:ra,includeEndDate:m,showOverlapDialog:oa,overlapCycle:na,onConfirmOverlap:ja,onCancelOverlap:Ca,onClearError:()=>O(""),saveLabel:m?"Guardar fechas":"Guardar cambios",title:m?"Editar fechas del ciclo":"Editar fecha de inicio",description:m?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:Q?Da:void 0,deleteTitle:$e,deleteDescription:F,deleteLabel:ze,isDeletingCycle:B})}),a.jsx(Qa,{initial:!1,children:a.jsx(ge.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:a.jsx("div",{ref:kt,onPointerDown:va,"data-calendar-dragging":Rt?"true":"false",className:D("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:[transform:translate3d(var(--calendar-drag-x,0px),0,0)]",Rt?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${ha}px`},children:a.jsx(Za,{mode:"single",locale:De,month:St??void 0,onMonthChange:at,selected:p&&N(u(p))?u(p):void 0,onSelect:Lt,onDayClick:Lt,modifiers:ma,labels:ga,components:{DayContent:ya},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:fa,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),a.jsxs("div",{ref:wt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:Nt,maxHeight:`calc(h-app - ${Nt}px )`,WebkitOverflowScrolling:"touch"},children:[a.jsx(ge.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:z.length===0?a.jsx(ge.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:a.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[a.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:a.jsx(Wt,{className:"h-9 w-9"})}),a.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),a.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):a.jsx(cs,{isoDate:p,cycleDay:It?.cycleDay??null,details:st,peakStatus:Ft,isPeakDay:wa,onEdit:Sa,onDelete:ka,onAdd:Ea,onToggleRelations:_a,isProcessing:ae})}),Ne&&a.jsx("div",{className:"pt-4 space-y-4",children:Ne})]})]}),a.jsx(ns,{open:aa,onOpenChange:e=>{e?V(!0):$t()},children:a.jsx(os,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:a.jsx(Ja,{onSubmit:Ra,onCancel:$t,initialData:Ge,cycleStartDate:r?.startDate,cycleEndDate:r?.endDate,isProcessing:ae,isEditing:!!Ge,cycleData:r?.data,onDateSelect:Ma,defaultIsoDate:la,focusedField:ia,initialSectionKey:ca})})}),a.jsx(ss,{isOpen:!!te,onClose:()=>Ke(null),onConfirm:Aa,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:te?`¿Estás seguro de que quieres eliminar el registro del ${w(u(te.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:ae})]}):a.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[a.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[a.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),a.jsx("button",{onClick:()=>tt(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),a.jsx(Va,{isOpen:da,onClose:()=>tt(!1),onConfirm:async e=>{await ta(e),tt(!1),re(null),V(!0)}})]})},Es=()=>a.jsx(gs,{});export{gs as RecordsExperience,Es as default};
