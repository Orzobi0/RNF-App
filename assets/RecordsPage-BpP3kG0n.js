import{c as lt,r,k as C,f as h,j as t,K as M,B as de,W as Ta,g as k,q as ot,o as P,u as Ms,b as Rs,l as ja,Y as Es,T as It,m as Ve}from"./index-ByFXgX-t.js";import{L as _t,a as Is,N as Na,P as _s,C as Ts}from"./PostpartumExitDialog-81hY3wEb.js";import{T as As,a as Os,A as Ls,D as Fs}from"./DataEntryForm-B10-vrnA.js";import{l as Te}from"./badge-CetW1kHg.js";import{T as Ps,D as $s,C as Bs}from"./peak-mode-button-DTRv1E4U.js";import{D as At}from"./DeletionDialog-Da12udM-.js";import{D as Aa,a as Oa,b as Hs,c as zs,u as Us,i as rt}from"./useCycleData-BwqH7MfP.js";import{a as Vs,H as Ys}from"./HeaderIconButton-9FbpFFvA.js";import{m as Sa,i as nt,f as Xs,P as qs,e as Ws}from"./useBackClose-BFeNma-P.js";import{C as Ks,c as Gs,F as ka}from"./computePeakStatuses-hwVxT-Am.js";import"./label--L53Nrbo.js";import"./eye-CfXbXuuz.js";const Zs=lt("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),Ma=lt("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),Qs=lt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),Js=lt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),er=({isoDate:i,cycleDay:d,details:o,peakStatus:b,isPeakDay:T,onEdit:x,onDelete:B,onAdd:O,onToggleRelations:te,isProcessing:L})=>{const ue=!!o?.record,Ae=r.useMemo(()=>{if(!i)return null;try{return C(h(i),"dd/MM/yyyy",{locale:Te})}catch{return null}},[i]),ae=o?.symbolInfo?.label||"Sin símbolo",U=o?.symbolInfo?.value||"none",V=o?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",me=()=>{!o?.record||!x||x(o.record,null)},fe=()=>{!o?.record?.id||!B||B(o.record.id)},pe=()=>{!i||!O||O(i)},$=(I,ye=null)=>{if(o?.record&&x){x(o.record,I,ye);return}i&&O&&O(i,I,ye)},D=()=>{!i||!te||te(i)},R=(I,ye={})=>I&&typeof I=="string"&&I.trim().length>0||typeof I=="number"?I:ye.placeholder||"—",H=o?.hasTemperature?`${o.displayTemp} °C`:"—",Oe=!!(o?.hasTemperature&&o?.record?.ignored),Le=o?.timeValue||"—",he=!!o?.timeValue,xe=o?.hasMucusSensation?o.mucusSensation:"—",Fe=o?.hasMucusAppearance?o.mucusAppearance:"—",c=o?.observationsText?.trim(),j=!!o?.hasRelations;let f=null,S=null;b&&(b==="P"||T?(f="Día pico",S="peak"):(f=`+${b}`,S="post-peak"));const v=()=>{switch(U){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!i)return t.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const A="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return t.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Ae,d?` · Día ${d}`:""]}),f&&t.jsx("span",{className:M("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:f})]}),t.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:()=>$("symbol","fertilitySymbol"),className:M("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",v(),V),title:ae,"aria-label":ae}),ue?t.jsxs(t.Fragment,{children:[t.jsxs(de,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:me,disabled:L,children:[L?t.jsx(_t,{className:"h-4 w-4 animate-spin"}):t.jsx(Js,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:"Editar registro"})]}),t.jsxs(de,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:fe,disabled:L,children:[L?t.jsx(_t,{className:"h-4 w-4 animate-spin"}):t.jsx(As,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):t.jsxs(de,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:pe,disabled:L,children:[L&&t.jsx(_t,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),t.jsxs("div",{className:"mt-4 space-y-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("button",{type:"button",onClick:()=>$("temperature","temperature"),className:M(A,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[t.jsx(Ps,{className:"h-5 w-5 shrink-0 opacity-80"}),t.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[t.jsx("span",{className:M("font-semibold",Oe&&"text-slate-400 line-through decoration-1"),children:R(H)}),o?.showCorrectedIndicator&&t.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),t.jsxs("button",{type:"button",onClick:()=>$("temperature","time"),className:M(A,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",he?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[t.jsx(Os,{className:"h-5 w-5 shrink-0 opacity-80"}),t.jsx("span",{className:"font-semibold",children:R(Le)})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("button",{type:"button",onClick:()=>$("sensation","mucusSensation"),className:M(A,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[t.jsx($s,{className:"h-5 w-5 shrink-0 opacity-80"}),t.jsx("span",{className:"font-semibold",children:R(xe)})]}),t.jsxs("button",{type:"button",onClick:()=>$("appearance","mucusAppearance"),className:M(A,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[t.jsx(Bs,{className:"h-5 w-5 shrink-0 opacity-80"}),t.jsx("span",{className:"font-semibold",children:R(Fe)})]})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("button",{type:"button",onClick:()=>$("observations","observations"),className:M(A,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",c?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[t.jsx(Qs,{className:"h-5 w-5 shrink-0 opacity-80"}),t.jsx("span",{className:"truncate",children:R(c,{placeholder:"-"})})]}),t.jsx("button",{type:"button",onClick:D,disabled:L,className:M("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",j?"border-rose-50 bg-rose-50":"border-slate-200 bg-white",L&&"opacity-70 cursor-not-allowed"),title:j?"Hubo relaciones":"Sin relaciones","aria-label":j?"Hubo relaciones":"Sin relaciones",children:t.jsx(Ta,{className:M("h-4 shrink-0 w-4",j?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},La=i=>i.replace(".","").toLowerCase(),Ye=i=>La(C(i,"MMM",{locale:Te})),tr=i=>La(C(i,"d MMM yyyy",{locale:Te})),ar=({startDate:i,endDate:d})=>{if(!d){if(!i)return"Mis registros";const O=h(i);return k(O)?`${tr(O)} - actualidad`:"Mis registros"}if(!i)return"Mis registros";const o=h(i),b=h(d);if(!k(o)||!k(b))return"Mis registros";const T=o.getFullYear()===b.getFullYear();if(T&&o.getMonth()===b.getMonth())return`${o.getDate()}–${b.getDate()} ${Ye(o)} ${o.getFullYear()}`;if(T)return`${o.getDate()} ${Ye(o)} – ${b.getDate()} ${Ye(b)} ${o.getFullYear()}`;const B=`${o.getFullYear()}–${String(b.getFullYear()).slice(-2)}`;return`${o.getDate()} ${Ye(o)} – ${b.getDate()} ${Ye(b)} · ${B}`},sr=({startDate:i,endDate:d,recordCount:o=0,referenceDate:b=new Date})=>{if(!i)return`${o} registros`;const T=h(i);if(!k(T))return`${o} registros`;if(!d)return`Día ${ot(P(b),P(T))+1} · ${o} registros`;const x=h(d);return k(x)?`${ot(P(x),P(T))+1} días · ${o} registros`:`${o} registros`},rr=({issues:i,onReview:d})=>i?.hasIssues?t.jsx("div",{className:"rounded-2xl border border-amber-300 bg-amber-50 px-3 py-2 text-amber-900 shadow-sm",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[t.jsx(Zs,{className:"h-4 w-4"}),t.jsxs("span",{children:["Hay problemas de datos en este ciclo: ",i.summary.duplicateDaysCount," días con duplicados,"," ",i.summary.outOfRangeCount," fuera de rango."]})]}),t.jsx(de,{type:"button",size:"sm",variant:"outline",onClick:d,children:"Revisar"})]})}):null,_e=i=>{if(!i)return"Fecha inválida";const d=h(i);return k(d)?C(d,"dd-MM-yyyy"):i},Ra=({entry:i})=>{const d=i?.preview||i?.entryPreview||{};return t.jsxs("div",{className:"rounded-xl border bg-white p-3 text-xs space-y-1",children:[t.jsxs("div",{children:[t.jsx("b",{children:"Temp gráfica/orig/corr:"})," ",d.temperature_chart??"—"," / ",d.temperature_raw??"—"," / ",d.temperature_corrected??"—"]}),t.jsxs("div",{children:[t.jsx("b",{children:"Hora:"})," ",d.timestamp&&k(h(d.timestamp))?C(h(d.timestamp),"HH:mm"):"—"]}),t.jsxs("div",{children:[t.jsx("b",{children:"Moco:"})," ",d.mucus_sensation??"—"," / ",d.mucus_appearance??"—"]}),t.jsxs("div",{children:[t.jsx("b",{children:"Símbolo:"})," ",d.fertility_symbol??"—"]}),t.jsxs("div",{children:[t.jsx("b",{children:"Obs:"})," ",d.observations||"—"]}),t.jsxs("div",{children:[t.jsx("b",{children:"RS:"})," ",d.had_relations?"Sí":"No"]}),t.jsxs("div",{children:[t.jsx("b",{children:"Ignorado:"})," ",d.ignored?"Sí":"No"]}),t.jsxs("div",{children:[t.jsx("b",{children:"Día Pico:"})," ",d.peak_marker??"—"]}),t.jsxs("div",{children:[t.jsx("b",{children:"+ Mediciones:"})," ",d.measurementsCount??"—"]}),t.jsxs("div",{children:[t.jsx("b",{children:"ID:"})," ",i?.entryId]})]})},nr=({open:i,onOpenChange:d,cycle:o,cycles:b,onResolveDuplicate:T,onMoveOutOfRange:x,onDeleteEntry:B})=>{const[O,te]=r.useState({}),[L,ue]=r.useState({}),[Ae,ae]=r.useState({}),[U,V]=r.useState(null),[me,fe]=r.useState({}),[pe,$]=r.useState({}),[D,R]=r.useState(null),H=o?.issues,Oe=r.useMemo(()=>{const c={};for(const j of H?.outOfRange||[]){const f=j.isoDateResolved,S=(b||[]).find(v=>v?.id!==o?.id&&v?.startDate&&f&&f>=v.startDate&&(!v.endDate||f<=v.endDate));S?.id&&(c[j.entryId]=S.id)}return c},[o?.id,b,H?.outOfRange]),Le=r.useMemo(()=>(b||[]).filter(c=>c?.id!==o?.id).slice().sort((c,j)=>{const f=c?.endDate||"9999-12-31",S=j?.endDate||"9999-12-31";return f!==S?S.localeCompare(f):(c?.startDate||"").localeCompare(j?.startDate||"")}),[o?.id,b]),he=r.useMemo(()=>(H?.duplicates||[]).filter(c=>!me[c.isoDate]),[H?.duplicates,me]),xe=r.useMemo(()=>(H?.outOfRange||[]).filter(c=>!pe[c.entryId]),[H?.outOfRange,pe]);r.useEffect(()=>{i&&(fe({}),$({}),te({}),ue({}),ae({}),R(null))},[i,o?.id]);const Fe=async()=>{if(!D)return;const{actionKey:c,execute:j}=D;V(c);try{await j(),R(null)}finally{V(f=>f===c?null:f)}};return t.jsxs(Aa,{open:i,onOpenChange:d,children:[t.jsxs(Oa,{className:"max-w-3xl max-h-[85vh] overflow-y-auto",children:[t.jsxs(Hs,{children:[t.jsx(zs,{children:"Reparación manual de datos"}),t.jsxs("p",{className:"text-sm text-slate-600",children:["Ciclo: ",t.jsx("b",{children:_e(o?.startDate)})," -"," ",t.jsx("b",{children:o?.endDate?_e(o.endDate):"actualidad"})]})]}),t.jsxs("div",{className:"space-y-5",children:[t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"font-semibold",children:"Duplicados"}),he.length===0&&t.jsx("p",{className:"text-sm text-slate-500",children:"Sin duplicados."}),he.map(c=>{const j=O[c.isoDate]||c.entries?.[0]?.entryId,f=L[c.isoDate]??!1,S=c.entries.map(v=>v.entryId).filter(v=>v!==j);return t.jsxs("div",{className:"rounded-xl border p-3 space-y-3 bg-slate-50",children:[t.jsx("div",{className:"text-sm font-medium",children:_e(c.isoDate)}),t.jsx("div",{className:"grid gap-2 md:grid-cols-2",children:c.entries.map(v=>t.jsxs("label",{className:"space-y-1 cursor-pointer",children:[t.jsxs("div",{className:"text-xs",children:[t.jsx("input",{type:"radio",name:`winner-${c.isoDate}`,checked:j===v.entryId,onChange:()=>te(A=>({...A,[c.isoDate]:v.entryId}))})," ","Conservar este"]}),t.jsx(Ra,{entry:v})]},v.entryId))}),t.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[t.jsx(Ks,{checked:f,onCheckedChange:v=>ue(A=>({...A,[c.isoDate]:v!==!1}))}),"Mover mediciones de los descartados al conservado"]}),t.jsx(de,{type:"button",onClick:()=>{const v=`resolve-${c.isoDate}`;R({actionKey:v,title:"Resolver duplicado",description:"¿Confirmas resolver este duplicado? Esta acción elimina registros duplicados.",confirmLabel:"Resolver duplicado",execute:async()=>{await T({cycleId:o.id,isoDate:c.isoDate,winnerEntryId:j,loserEntryIds:S,moveMeasurements:f}),fe(A=>({...A,[c.isoDate]:!0}))}})},disabled:!S.length||U===`resolve-${c.isoDate}`,children:"Aplicar"})]},c.isoDate)})]}),t.jsxs("section",{className:"space-y-3",children:[t.jsx("h3",{className:"font-semibold",children:"Fuera de rango"}),xe.length===0&&t.jsx("p",{className:"text-sm text-slate-500",children:"Sin registros fuera de rango."}),xe.map(c=>{const j=Ae[c.entryId]||Oe[c.entryId]||"";return t.jsxs("div",{className:"rounded-xl border p-3 space-y-2 bg-slate-50",children:[t.jsxs("div",{className:"text-sm",children:["Fecha: ",t.jsx("b",{children:c.isoDateResolved?_e(c.isoDateResolved):"inválida"})]}),t.jsx(Ra,{entry:c}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("select",{className:"border rounded-3xl h-9 px-2 text-sm",value:j,onChange:f=>ae(S=>({...S,[c.entryId]:f.target.value})),children:[t.jsx("option",{value:"",children:"Seleccionar ciclo destino…"}),Le.map(f=>t.jsxs("option",{value:f.id,children:[_e(f.startDate)," - ",f.endDate?_e(f.endDate):"actualidad"]},f.id))]}),t.jsx(de,{type:"button",variant:"outline",disabled:!j||!c.isoDateResolved||U===`move-${c.entryId}`,onClick:()=>{const f=`move-${c.entryId}`;R({actionKey:f,title:"Mover registro",description:"¿Mover este registro al ciclo seleccionado?",confirmLabel:"Mover",execute:async()=>{await x({fromCycleId:o.id,toCycleId:j,entryId:c.entryId,isoDate:c.isoDateResolved}),$(S=>({...S,[c.entryId]:!0}))}})},children:"Mover"}),t.jsx(de,{type:"button",variant:"destructive",disabled:U===`delete-${c.entryId}`,onClick:()=>{const f=`delete-${c.entryId}`;R({actionKey:f,title:"Eliminar registro",description:"¿Eliminar este registro y sus mediciones?",confirmLabel:"Eliminar",execute:async()=>{await B({cycleId:o.id,entryId:c.entryId}),$(S=>({...S,[c.entryId]:!0}))}})},children:"Eliminar este registro"})]})]},c.entryId)})]})]})]}),t.jsx(At,{isOpen:!!D,onClose:()=>R(null),onConfirm:Fe,title:D?.title,description:D?.description,confirmLabel:D?.confirmLabel,isProcessing:!!D?.actionKey&&U===D?.actionKey})]})},or=i=>ka.find(d=>d.value===i)||ka[0],Ea=10,Tt=60,Ia=750,_a=120,lr=85,ir=5,Xe=180,cr=i=>{if(i==null||i==="")return null;const d=Number(typeof i=="string"?i.replace(",","."):i);return Number.isFinite(d)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(d):null},dr=({cycle:i,headerTitle:d,headerIcon:o=Ma,headerActions:b,topAccessory:T,includeEndDate:x=!1,addOrUpdateDataPoint:B,deleteRecord:O,isLoading:te,updateCycleDates:L,checkCycleOverlap:ue,startNewCycle:Ae,refreshData:ae,afterRecordsContent:U=null,onRequestDeleteCycle:V=null,dateEditorDeleteTitle:me="Eliminar ciclo",dateEditorDeleteDescription:fe="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:pe="Eliminar ciclo",isDeletingCycle:$=!1}={})=>{const{currentCycle:D,archivedCycles:R,addOrUpdateDataPoint:H,deleteRecord:Oe,isLoading:Le,updateCycleDates:he,checkCycleOverlap:xe,previewUpdateCycleDates:Fe,previewStartNewCycle:c,startNewCycle:j,refreshData:f,getMeasurementsForEntry:S,undoCurrentCycle:v,repairDialogState:A,openDataRepairDialog:I,closeDataRepairDialog:ye,resolveDuplicateIssue:Ot,moveOutOfRangeEntry:Lt,deleteIssueEntry:Ft,getPublicError:ge}=Us(),{preferences:Pt,savePreferences:it}=Ms(),n=i??D,$t=te??Le,ct=B||(async(e,a)=>{if(n?.id)return H(e,a,n.id)}),Fa=O||(async e=>{if(n?.id)return Oe(e,n.id)}),qe=L||(async(e,a,s)=>he(e??n?.id,a,s)),dt=ue??xe,ut=Fe,Bt=c,Ht=Ae??j,se=ae??f,mt=S,{toast:Y}=Rs(),[Pa,K]=r.useState(!1),[ft,re]=r.useState(null),[be,pt]=r.useState(null),[$a,ht]=r.useState(!1),[xt,zt]=r.useState(!1),[De,ve]=r.useState(!1),[Ba,yt]=r.useState(!1),[G,Ut]=r.useState(!1),[X,We]=r.useState(()=>n?.startDate||""),[we,Ke]=r.useState(()=>n?.endDate||""),[Ha,Z]=r.useState(""),[Ge,gt]=r.useState(null),[bt,Dt]=r.useState(null),[vt,wt]=r.useState(!1),[za,Ct]=r.useState(null),[Ua,jt]=r.useState(null),[Va,Ze]=r.useState(!1),[Nt,Ce]=r.useState(!1),[y,ne]=r.useState(null),[Ya,oe]=r.useState(null),[Xa,Pe]=r.useState(null),[qa,le]=r.useState(null),[Vt,$e]=r.useState(!1),[Yt,Be]=r.useState(null),[Wa,Qe]=r.useState(!1),Xt=n?.data?.length??0,qt=!n?.endDate,je=r.useMemo(()=>{if(!D?.id||D?.endDate||!n?.id||n.id!==D.id||!D?.startDate)return null;const e=h(D.startDate);if(!k(e))return null;const a=C(ja(e,-1),"yyyy-MM-dd"),s=R.filter(l=>l?.endDate===a);return s.length?s.sort((l,u)=>(u.startDate||"").localeCompare(l.startDate||""))[0]:null},[R,D,n?.id]),St=r.useMemo(()=>{if(!je?.startDate||!je?.endDate)return"";const e=h(je.startDate),a=h(je.endDate);if(!k(e)||!k(a))return"";const s=l=>C(l,"dd MMM yy",{locale:Te}).replace(".","");return`${s(e)} - ${s(a)}`},[je]),Ka=r.useMemo(()=>`¿Quieres unir el ciclo actual al ciclo anterior${St?` (${St})`:""}? Esta acción no se puede deshacer.`,[St]),Ga=r.useCallback(async()=>{Qe(!1),typeof it=="function"&&await it({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[it]),Ne=r.useCallback(async()=>{!i?.id||!se||await se({silent:!0})},[i?.id,se]),Za=r.useCallback(async e=>{await Ot(e),await Ne()},[Ne,Ot]),Qa=r.useCallback(async e=>{await Lt(e),await Ne()},[Lt,Ne]),Ja=r.useCallback(async e=>{await Ft(e),await Ne()},[Ft,Ne]),es=r.useMemo(()=>d||ar({startDate:n?.startDate,endDate:n?.endDate}),[n?.endDate,n?.startDate,d]),Wt=r.useMemo(()=>sr({startDate:n?.startDate,endDate:n?.endDate,recordCount:Xt}),[n?.endDate,n?.startDate,Xt]),Kt=!0,Je=r.useRef(null),Gt=r.useRef(null),Zt=r.useRef(0),He=r.useRef(null),[Qt,Jt]=r.useState(0),ea=r.useRef(null),et=r.useCallback(()=>{const e=Je.current;if(!e){Zt.current=0,Jt(0);return}const s=e.getBoundingClientRect().height;Zt.current=s,Jt(l=>Math.abs(l-s)>.5?s:l)},[]);r.useLayoutEffect(()=>{let e=window.requestAnimationFrame(et);const a=()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(et)};window.addEventListener("resize",a);let s;return typeof ResizeObserver<"u"&&(s=new ResizeObserver(()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(et)}),Je.current&&s.observe(Je.current)),()=>{window.removeEventListener("resize",a),s&&s.disconnect(),e&&window.cancelAnimationFrame(e)}},[et]);const ta=r.useMemo(()=>Math.max(Math.round(Qt+Ea),Ea),[Qt]);r.useEffect(()=>{We(n?.startDate||""),Ke(n?.endDate||"")},[n?.startDate,n?.endDate]);const tt=r.useMemo(()=>n?.data?.length?[...n.data].filter(e=>e?.isoDate).sort((e,a)=>{const s=h(e.isoDate);return h(a.isoDate)-s}).map(e=>e.isoDate):[],[n?.data]);r.useEffect(()=>{const e=Gt.current;e&&e.scrollTo({top:0,behavior:"auto"})},[]);const Se=r.useMemo(()=>n?.data?.length?n.data.map(e=>{if(!e?.isoDate)return null;const a=h(e.isoDate);return k(a)?a:null}).filter(Boolean):[],[n?.data]),aa=r.useMemo(()=>new Set(tt),[tt]),ie=r.useMemo(()=>Gs(n?.data??[]),[n?.data]),ke=r.useMemo(()=>{const e=new Map;return n?.data?.length&&n.data.forEach(a=>{if(!a?.isoDate)return;const s=a.measurements?.find(ks=>ks?.selected)||(a.temperature_chart||a.temperature_raw?{temperature:a.temperature_chart??a.temperature_raw,temperature_corrected:a.temperature_corrected??null,time:a.timestamp?C(h(a.timestamp),"HH:mm"):null,use_corrected:a.use_corrected??!1}:null),l=s?.use_corrected??a.use_corrected??!1,u=s?.temperature_corrected??a.temperature_corrected??null,p=s?.temperature??a.temperature_chart??a.temperature_raw??null,N=cr(l&&u!==null&&u!==void 0&&u!==""?u:p??u),m=N!==null,E=l&&u!==null&&u!==void 0&&u!=="";let g=null;s?.time?g=s.time:a.timestamp&&k(h(a.timestamp))&&(g=C(h(a.timestamp),"HH:mm"));const z=a.mucusSensation??a.mucus_sensation??"",Ee=a.mucusAppearance??a.mucus_appearance??"",Ie=!!z,ee=!!Ee,Et=Ie||ee,Ue=a.observations||"",st=!!Ue,js=!!(a.had_relations??a.hadRelations??!1),Ca=ie[a.isoDate]||null,Ns=a.peak_marker==="peak"||Ca==="P",Ss=or(a.fertility_symbol);e.set(a.isoDate,{record:a,symbolInfo:Ss,hasTemperature:m,displayTemp:N,showCorrectedIndicator:E,timeValue:g,hasMucus:Et,hasMucusSensation:Ie,hasMucusAppearance:ee,mucusSensation:z,mucusAppearance:Ee,hasObservations:st,observationsText:Ue,hasRelations:js,peakStatus:Ca,isPeakDay:Ns})}),e},[n?.data,ie]),w=r.useMemo(()=>{if(!n?.startDate)return null;const e=h(n.startDate);if(!k(e))return null;let a;if(n?.endDate)a=h(n.endDate);else{const s=P(new Date),l=[e,s];Se.length&&l.push(Sa(Se)),a=Sa(l)}return k(a)?{from:e,to:a}:{from:e,to:e}},[n?.startDate,n?.endDate,Se]),ts=r.useMemo(()=>{const e={};return w&&(e.outsideCycle=a=>nt(a,w.from)||rt(a,w.to),e.insideCycleNoRecord=a=>{if(nt(a,w.from)||rt(a,w.to))return!1;const s=C(a,"yyyy-MM-dd");return!aa.has(s)}),Se.length&&(e.hasRecord=Se),e},[w,Se,aa]),as=r.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:M(Es({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[sa,kt]=r.useState(()=>y&&k(h(y))?h(y):w?.to?w.to:P(new Date)),ze=r.useRef(!1),q=r.useRef(null),ss=r.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),ce=r.useRef(null),ra=r.useRef(null),na=r.useRef(null),oa=r.useRef(0),[rs,ns]=r.useState(0),[la,ia]=r.useState(!1),Q=r.useCallback(e=>{oa.current=e,ns(e)},[]),ca=r.useCallback(()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(e)})}),[]),Me=r.useCallback((e,{duration:a=Xe}={})=>{q.current&&(cancelAnimationFrame(q.current),q.current=null);const s=oa.current,l=e-s;return Math.abs(l)<.5||a<=0?(Q(e),Promise.resolve()):new Promise(u=>{const p=m=>1-Math.pow(1-m,3),_=performance.now(),N=m=>{const E=m-_,g=Math.min(1,E/a),z=s+l*p(g);if(Q(z),g<1){q.current=requestAnimationFrame(N);return}q.current=null,u()};q.current=requestAnimationFrame(N)})},[Q]),os=r.useMemo(()=>({labelDay:e=>{const a=C(e,"yyyy-MM-dd"),s=ke.get(a),l=C(e,"d MMM",{locale:Te}),u=s?.peakStatus??ie[a]??null,p=[];if(s?.hasTemperature&&s?.hasMucus?p.push("temperatura y moco"):s?.hasTemperature?p.push("temperatura"):s?.hasMucus&&p.push("moco"),s?.hasRelations&&p.push("RS"),u){const _=u==="P"?"pico ✖":`pico +${u}`;p.push(_)}return p.length?`${l}: ${p.join("; ")}`:l}}),[ie,ke]),ls=r.useCallback(({date:e,activeModifiers:a})=>{const s=C(e,"yyyy-MM-dd"),l=ke.get(s),u=l?.hasTemperature??!1,p=l?.hasMucus??!1,_=l?.hasRelations??!1,N=l?.peakStatus??ie[s]??null,m=l?.symbolInfo,E=m?.value,g=a.selected,z=a.today,Ee=M("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",u?"bg-amber-500":"bg-transparent",u&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),Ie=M("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",p?"bg-teal-500":"bg-transparent",p&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),ee=!!(E&&E!=="none"),Et=M("relative z-10 text-[1.15rem] leading-none",a.outside||a.outsideCycle?"text-slate-300":g?ee?"text-white":"text-fertiliapp-fuerte":z?"text-subtitulo font-semibold":"text-slate-700"),Ue=N==="P"?"✖":N?`+${N}`:null,st=ee?M("pointer-events-none absolute inset-0 rounded-full transition-opacity",m?.color??"",m?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",E==="white"?"ring-1 ring-slate-300/70":"",g?"opacity-50":"opacity-25"):null;return t.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[t.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[z&&!g&&!(a.outside||a.outsideCycle)&&t.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),g&&t.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[2px] rounded-full bg-tarjeta border-2 border-fertiliapp-fuerte"}),st&&t.jsx("span",{className:st,"aria-hidden":"true"}),t.jsx("span",{className:Et,children:C(e,"d")}),_&&t.jsx(Ta,{"aria-hidden":"true",className:"pointer-events-none absolute -bottom-[0.2px] -right-[0.2px] h-2 w-2 text-rose-500 fill-current"})]}),t.jsxs("div",{className:"mt-[0.2rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[t.jsx("span",{className:Ee}),t.jsx("span",{className:Ie})]}),Ue&&t.jsx("span",{"aria-hidden":"true",className:M("pointer-events-none absolute -top-[1px] right-[0.5px] rounded-sm px-[2px] text-[0.75rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",g?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:Ue})]})},[ie,ke]),J=r.useMemo(()=>{if(!n?.startDate)return[];const e=h(n.startDate);if(!k(e))return[];const a=P(e),s=P(new Date);let l=w?.to?P(w.to):s;rt(l,s)&&(l=s),nt(l,a)&&(l=a);const u=ot(l,a)+1;if(u<=0)return[];const p=[];for(let _=u-1;_>=0;_-=1){const N=ja(a,_),m=C(N,"yyyy-MM-dd"),E=ot(N,a)+1,g=ke.get(m)||null;p.push({isoDate:m,date:N,cycleDay:E,details:g})}return p},[n?.startDate,w,ke]),Re=r.useMemo(()=>new Set(J.map(e=>e.isoDate)),[J]),is=r.useMemo(()=>{const e=new Map;return J.forEach(a=>{e.set(a.isoDate,a)}),e},[J]),da=y&&is.get(y)||null,Mt=da?.details??null,ua=Mt?.peakStatus??(y?ie[y]??null:null),cs=Mt?.isPeakDay??ua==="P",at=r.useMemo(()=>{if(!w)return null;const e=w?.to?C(P(w.to),"yyyy-MM-dd"):null,a=w?.from?C(P(w.from),"yyyy-MM-dd"):null;if(!n?.endDate){const s=C(P(new Date),"yyyy-MM-dd");if(Re.has(s))return s}return e&&Re.has(e)?e:a&&Re.has(a)?a:tt[0]??null},[n?.endDate,w,Re,tt]);r.useEffect(()=>{if(!(y&&Re.has(y))){if(!at){y!==null&&ne(null);return}y!==at&&ne(at)}},[y,Re,at]);const ma=r.useCallback(e=>{if(!e)return;const a=C(e,"yyyy-MM-dd");w&&(nt(e,w.from)||rt(e,w.to))||ne(a)},[w]);r.useEffect(()=>{if(!y)return;const e=h(y);k(e)&&kt(a=>a&&a.getFullYear()===e.getFullYear()&&a.getMonth()===e.getMonth()?a:e)},[y]);const fa=r.useCallback(e=>{kt(a=>{const s=a??w?.to??P(new Date);return Xs(s,e==="next"?1:-1)})},[w]);r.useEffect(()=>{const e=ra.current;if(!e)return;const a=e.querySelector(".records-calendar-day-grid");a&&(na.current=a)},[sa,Kt,Q]);const Rt=r.useCallback(async e=>{if(ze.current)return;ze.current=!0;const s=na.current?.getBoundingClientRect()?.width??0,l=e==="next"?-_a:_a,u=s?e==="next"?-s:s:l,p=-u;try{await Me(u,{duration:Xe}),fa(e),Q(p),await ca(),await Me(0,{duration:Xe})}finally{ze.current=!1}},[Me,fa,Q,ca]),W=r.useCallback(()=>{gt(null),Dt(null),wt(!1),Ct(null),jt(null),Ze(!1)},[]);r.useEffect(()=>()=>{q.current&&(cancelAnimationFrame(q.current),q.current=null),ce.current&&(ce.current(),ce.current=null)},[]);const pa=r.useCallback(()=>{We(n?.startDate||""),Ke(n?.endDate||""),Z(""),W(),Ut(!0)},[n?.startDate,n?.endDate,W]),F=r.useCallback(()=>{Ut(!1),Z(""),W(),We(n?.startDate||""),Ke(n?.endDate||"")},[n?.startDate,n?.endDate,W]),ha=r.useCallback(()=>{if(G){F();return}pa()},[F,pa,G]);r.useEffect(()=>{if(!G)return;const e=a=>{const s=a.target;!(s instanceof Node)||ea.current?.contains(s)||s instanceof Element&&s.closest('[data-date-editor-toggle="true"]')||typeof s.closest=="function"&&s.closest("[data-radix-popper-content-wrapper], [data-radix-popover-content]")||F()};return document.addEventListener("pointerdown",e,!0),()=>{document.removeEventListener("pointerdown",e,!0)}},[F,G]);const ds=r.useCallback(async()=>{if(D?.id){zt(!0);try{await v(D.id),ht(!1),F()}catch(e){console.error("Failed to undo cycle",e)}finally{zt(!1)}}},[F,D?.id,v]),us=r.useCallback(()=>{V&&(F(),V())},[F,V]),ms=r.useCallback(e=>{if(ze.current||e.pointerType==="mouse"&&e.button!==0)return;const a=e.target.closest(".records-calendar-day-grid");if(!a)return;const s=ss.current;s.active=!0,s.pointerId=e.pointerId,s.startX=e.clientX,s.startTime=performance.now(),s.dragging=!1;const l=a.getBoundingClientRect().width||0;s.gridWidth=l,s.swipeThreshold=l?Math.max(Tt,l*.25):Tt;const u=N=>{if(!s.active||N.pointerId!==s.pointerId)return;const m=N.clientX-s.startX;if(!s.dragging&&Math.abs(m)>ir&&(s.dragging=!0,ia(!0)),!s.dragging)return;const E=s.gridWidth?s.gridWidth*.7:lr,g=Math.max(-E,Math.min(E,m));N.preventDefault(),Q(g)},p=async N=>{if(!s.active||N.pointerId!==s.pointerId)return;ce.current?.(),ce.current=null,s.active=!1;const m=N.clientX-s.startX,E=performance.now()-s.startTime,g=E>0?m/E*1e3:0,z=s.swipeThreshold||Tt,Ee=m<=-z||g<=-Ia,Ie=m>=z||g>=Ia,ee=s.dragging;if(s.dragging=!1,ia(!1),ze.current){await Me(0,{duration:Xe});return}if(ee&&Ee){await Rt("next");return}if(ee&&Ie){await Rt("prev");return}await Me(0,{duration:Xe})},_=()=>{window.removeEventListener("pointermove",u,{capture:!0}),window.removeEventListener("pointerup",p,{capture:!0}),window.removeEventListener("pointercancel",p,{capture:!0})};ce.current?.(),ce.current=_,window.addEventListener("pointermove",u,{capture:!0,passive:!1}),window.addEventListener("pointerup",p,{capture:!0}),window.addEventListener("pointercancel",p,{capture:!0})},[Rt,Me,Kt,Q]),fs=r.useCallback(()=>{W()},[W]),ps=r.useCallback(async()=>{if(!X){Z("La fecha de inicio es obligatoria");return}if(x&&we&&we<X){Z("La fecha de fin no puede ser anterior al inicio");return}if(n?.id){Z(""),Ce(!0);try{const e=x&&we||void 0,a=ut?await ut(n.id,X,e):null;if(a){gt(X),Dt(e??null),wt(!!x),Ct(null),jt(a),Ze(!0),Ce(!1);return}const s=dt?await dt(n.id,X,e):null;if(s){gt(X),Dt(e??null),wt(!!x),Ct(s),jt(null),Ze(!0),Ce(!1);return}await qe(n.id,X,x&&we||void 0),await se({silent:!0}),F()}catch(e){const a=ge?ge(e):null;console.error("Error updating start date from records page:",e),Z(a?.message||"No se pudieron actualizar las fechas"),Y({title:a?.title||"Error",description:a?.message||"No se pudieron actualizar las fechas.",variant:"destructive",action:a?.action?.label==="Revisar"?t.jsx(It,{altText:"Revisar",onClick:()=>I?.(n?.id),children:"Revisar"}):void 0})}finally{Ce(!1)}}},[X,we,x,n?.id,dt,ut,qe,se,Y,F]),hs=r.useCallback(async()=>{if(!n?.id||!Ge){W();return}Ce(!0),Ze(!1);try{const e=n.startDate,a=n.endDate??void 0,s=Ge!==e,l=vt?bt??void 0:void 0,u=vt&&bt!==null&&l!==a;await qe(n.id,s?Ge:void 0,l),await se({silent:!0}),F()}catch(e){const a=ge?ge(e):null;console.error("Error adjusting cycle dates from records page:",e),Z(a?.message||"No se pudieron actualizar las fechas"),Y({title:a?.title||"Error",description:a?.message||"No se pudieron actualizar las fechas.",variant:"destructive",action:a?.action?.label==="Revisar"?t.jsx(It,{altText:"Revisar",onClick:()=>I?.(n?.id),children:"Revisar"}):void 0})}finally{Ce(!1),W()}},[n?.id,n?.startDate,n?.endDate,Ge,vt,bt,qe,se,Y,F,W]),xa=r.useCallback(()=>{K(!1),re(null),oe(null),Pe(null),le(null),yt(!1),He.current=null},[]),ya=r.useCallback(async(e,a=null,s=null)=>{if(!e)return;He.current=e.id??null,re(e),oe(e.isoDate??null),Pe(a),le(s??null),e.isoDate&&ne(e.isoDate),K(!0);const l=e?.measurementsLoaded||Array.isArray(e?.measurements)&&e.measurements.length>0;if(mt&&e?.id&&n?.id&&!l){yt(!0);try{const u=await mt(n.id,e.id);He.current===e.id&&re(p=>p?.id===e.id?{...p,measurements:u,measurementsLoaded:!0}:p)}finally{yt(!1)}}},[n?.id,mt]),xs=r.useCallback((e,a=null,s=null)=>ya(e,s,a),[ya]),ys=e=>{const a=n?.data?.find(s=>s.id===e);pt(a||null)},gs=r.useCallback(e=>{re(e)},[]),bs=r.useCallback((e,a=null,s=null)=>{e&&(He.current=null,ne(e),re(null),oe(e),Pe(s),le(a),K(!0))},[]),ga=r.useCallback(()=>{const e=J.length?J[0].isoDate:n?.startDate||null,a=y||e||null;He.current=null,re(null),oe(a),Pe(null),le(null),a&&ne(a),K(!0)},[J,n?.startDate,y]),ba=r.useCallback((e=null)=>{Be(e||y||null),$e(!0)},[y]),Da=r.useCallback((e,a={})=>{const s=n?.data?.find(m=>m.isoDate===e)||null,l=s?.timestamp&&k(h(s.timestamp))?C(h(s.timestamp),"HH:mm"):C(new Date,"HH:mm"),u=s?.temperature_raw??s?.temperature??"",p=s?.temperature_corrected??"",_=!!s?.use_corrected,N=s?.measurements?.length?s.measurements.map((m,E)=>{const g=m?.time||(m?.timestamp&&k(h(m.timestamp))?C(h(m.timestamp),"HH:mm"):l);return{temperature:m?.temperature??m?.temperature_raw??u,temperature_corrected:m?.temperature_corrected??p,time:g,time_corrected:m?.time_corrected||g,use_corrected:m?.use_corrected!==void 0?!!m?.use_corrected:_,selected:!!(m?.selected??E===0)}}):[{temperature:u,temperature_corrected:p,time:l,time_corrected:l,use_corrected:_,selected:!0}];return{isoDate:e,measurements:N,mucusSensation:s?.mucusSensation??s?.mucus_sensation??"",mucusAppearance:s?.mucusAppearance??s?.mucus_appearance??"",fertility_symbol:s?.fertility_symbol??s?.fertilitySymbol??"none",observations:s?.observations??"",peak_marker:s?.peak_marker??null,ignored:s?.ignored??!1,...a}},[n?.data]),Ds=async(e,{keepFormOpen:a=!1}={})=>{ve(!0);try{await ct(e,ft),Y({title:"Guardado",duration:2e3}),a||(K(!1),re(null),oe(null),Pe(null),le(null))}catch(s){const l=ge?ge(s):null,u=["duplicate-iso-date","entry-out-of-range"].includes(l?.code);Y({title:l?.title||"Error",description:l?.message||"No se pudo guardar el registro",variant:"destructive",action:u?t.jsx(It,{altText:"Revisar",onClick:()=>I?.(n?.id),children:"Revisar"}):void 0})}finally{ve(!1),a&&oe(e?.isoDate??null)}},vs=r.useCallback(async e=>{if(!e)return;const a=n?.data?.find(u=>u.isoDate===e)||null,s=!!(a?.had_relations??a?.hadRelations??!1),l=Da(e,{had_relations:!s,hadRelations:!s});ve(!0);try{await ct(l,a)}catch{Y({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{ve(!1)}},[ct,Da,n?.data,Y]),ws=async()=>{if(be){ve(!0);try{const e=be.isoDate;await Fa(be.id),pt(null),oe(null),e&&y===e&&ne(e)}catch{Y({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{ve(!1)}}},va={openDateEditor:ha,openAddRecord:ga,isProcessing:De,isUpdatingDates:Nt,cycle:n,isDateEditorOpen:G},Cs=typeof b=="function"?b(va):t.jsxs(t.Fragment,{children:[t.jsxs(Vs,{type:"button",onClick:ha,"data-date-editor-toggle":"true",disabled:De||Nt,"aria-label":x?"Editar fechas del ciclo":"Editar fecha de inicio","aria-pressed":G,"aria-expanded":G,className:"date-editor-toggle",children:[t.jsx(Is,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:x?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),t.jsxs(Ys,{type:"button",onClick:ga,disabled:De,"aria-label":"Añadir registro",children:[t.jsx(qs,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),wa=typeof T=="function"?T({...va}):T??null;return $t&&!n?.id?t.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:t.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):n?.id?t.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[t.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[t.jsx("div",{ref:Je,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:t.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:t.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[t.jsx(Ve.div,{className:"flex flex-col gap-2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:t.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/50 p-3 shadow-sm backdrop-blur-md",children:t.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2 text-[10px] uppercase tracking-[0.18em] text-base",children:[t.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[wa&&t.jsx("div",{className:"flex items-center",children:wa}),t.jsx("span",{children:qt?"CICLO ACTUAL":"CICLO ARCHIVADO"})]}),t.jsx("div",{className:"flex shrink-0 items-center gap-2",children:Cs})]}),t.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[t.jsx(o,{className:"h-5 w-5 text-subtitulo"}),t.jsx("span",{className:M("font-semibold text-titulo leading-tight","text-[21px] sm:text-[22px]"),children:es})]}),Wt&&t.jsx("div",{className:"text-[13px] text-base whitespace-nowrap",children:Wt})]})})}),t.jsx(rr,{issues:n?.issues,onReview:()=>I?.(n?.id)}),G&&t.jsx(Ve.div,{ref:ea,initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:t.jsx(Ts,{cycle:n,startDate:X,endDate:x?we:n?.endDate,otherCycles:[...R??[],D].filter(Boolean),onStartDateChange:e=>We(e),onEndDateChange:x?e=>Ke(e):void 0,onSave:ps,onCancel:F,isProcessing:Nt||$t||xt,dateError:Ha,includeEndDate:x,showOverlapDialog:Va,overlapCycle:za,overlapImpactPreview:Ua,onConfirmOverlap:hs,onCancelOverlap:fs,onClearError:()=>Z(""),saveLabel:x?"Guardar fechas":"Guardar cambios",title:x?"Editar fechas del ciclo":"Editar fecha de inicio",description:x?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onUndoCycle:je?()=>ht(!0):void 0,isUndoingCycle:xt,onDeleteCycle:V?us:void 0,deleteTitle:me,deleteDescription:fe,deleteLabel:pe,isDeletingCycle:$})}),t.jsx(Ls,{initial:!1,children:t.jsx(Ve.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:t.jsx("div",{ref:ra,onPointerDown:ms,"data-calendar-dragging":la?"true":"false",className:M("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:[transform:translate3d(var(--calendar-drag-x,0px),0,0)]",la?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${rs}px`},children:t.jsx(Ws,{mode:"single",locale:Te,month:sa??void 0,onMonthChange:kt,selected:y&&k(h(y))?h(y):void 0,onSelect:ma,onDayClick:ma,modifiers:ts,labels:os,components:{DayContent:ls},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:as,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),t.jsxs("div",{ref:Gt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:ta,maxHeight:`calc(h-app - ${ta}px )`,WebkitOverflowScrolling:"touch"},children:[t.jsx(Ve.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:J.length===0?t.jsx(Ve.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:t.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[t.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:t.jsx(Ma,{className:"h-9 w-9"})}),t.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),t.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):t.jsx(er,{isoDate:y,cycleDay:da?.cycleDay??null,details:Mt,peakStatus:ua,isPeakDay:cs,onEdit:xs,onDelete:ys,onAdd:bs,onToggleRelations:vs,isProcessing:De})}),U&&t.jsx("div",{className:"pt-4 space-y-4",children:U})]})]}),t.jsx(Aa,{open:Pa,onOpenChange:e=>{e?K(!0):xa()},children:t.jsx(Oa,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:t.jsx(Fs,{onSubmit:Ds,onCancel:xa,initialData:ft,cycleStartDate:n?.startDate,cycleEndDate:n?.endDate,isProcessing:De||Ba,isEditing:!!ft,cycleData:n?.data,onDateSelect:gs,defaultIsoDate:Ya,focusedField:Xa,initialSectionKey:qa,onOpenNewCycle:ba})})}),t.jsx(Na,{isOpen:Vt,onClose:()=>{$e(!1),Be(null)},onPreview:e=>Bt?.(e,n?.id),onConfirm:async e=>{await Ht(e),$e(!1),Be(null),le(null),K(!0),Pt?.fertilityStartConfig?.postpartum===!0&&Qe(!0)},currentCycleStartDate:n?.startDate,currentCycleRecords:n?.data??[],initialStartDate:Yt}),t.jsx(At,{isOpen:$a,onClose:()=>ht(!1),onConfirm:ds,title:"Deshacer ciclo",confirmLabel:"Deshacer ciclo",cancelLabel:"Cancelar",description:Ka,isProcessing:xt}),t.jsx(nr,{open:A?.open&&A?.cycleId===n?.id,onOpenChange:e=>{e?I?.(n?.id):ye?.()},cycle:n,cycles:[...R||[],D].filter(Boolean),onResolveDuplicate:Za,onMoveOutOfRange:Qa,onDeleteEntry:Ja}),t.jsx(At,{isOpen:!!be,onClose:()=>pt(null),onConfirm:ws,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:be?`¿Estás seguro de que quieres eliminar el registro del ${C(h(be.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:De})]}):t.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[t.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[t.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),t.jsx("button",{onClick:()=>ba(),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),t.jsx(Na,{isOpen:Vt,onClose:()=>{$e(!1),Be(null)},onPreview:e=>Bt?.(e,n?.id),onConfirm:async e=>{await Ht(e),$e(!1),Be(null),le(null),K(!0),Pt?.fertilityStartConfig?.postpartum===!0&&Qe(!0)},currentCycleRecords:n?.data??[],initialStartDate:Yt}),t.jsx(_s,{isOpen:Wa,onClose:()=>Qe(!1),onConfirm:Ga})]})},Cr=()=>t.jsx(dr,{});export{dr as RecordsExperience,Cr as default};
