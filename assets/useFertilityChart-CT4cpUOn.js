import{r as C,j as a,m as ke,B as tt,K as wt,g as lt,f as Ue,Q as pt}from"./index-DKDve1bt.js";import{l as Mt,B as kt}from"./badge-Bv0PJFOO.js";import{X as Nt,b as ut,P as dt,c as nt,T as Pt,d as Tt}from"./DataEntryForm-BA2ItfuX.js";import{a as At,c as Dt}from"./computePeakStatuses-DDireWCn.js";const Jt=({point:e,position:r,chartWidth:i,chartHeight:h,onToggleIgnore:f,onEdit:n,onClose:c,onTogglePeak:b,currentPeakIsoDate:D})=>{if(!e)return null;const x=.6,w=200,y=120,S=w*x,j=y*x,T=C.useRef(null),[H,o]=C.useState(j),[p,k]=C.useState(!1);C.useEffect(()=>{T.current&&o(T.current.offsetHeight),k(!1)},[e]);const g=r.clientX>i*.66,M=r.clientY+H>h;let v=g?r.clientX-S-10:r.clientX+10,E=M?r.clientY:r.clientY+10;v+S>i&&(v=i-S-10),E+H>h&&(E=h-H-10),v<10&&(v=10),E<10&&(E=10);const R=!e.id||String(e.id).startsWith("placeholder-"),A=e.temperature_chart??e.displayTemperature??null,Y=At(e.fertility_symbol),G=e.timestamp||e.isoDate,F=W=>{if(W==null)return null;const ce=String(W).trim();return ce.length?ce:null},O=W=>{if(!W)return null;try{const ce=Ue(W),V=ce.getTime();return Number.isNaN(V)?null:lt(ce,"HH:mm")}catch{return null}},te=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const W=e.measurements.filter(Boolean);if(!W.length)return null;const ce=[...W.filter(V=>V?.selected),...W.filter(V=>!V?.selected)];for(const V of ce){const we=!!V?.use_corrected?F(V?.time_corrected)??F(V?.time):F(V?.time);if(we)return we}return null})(),B=(e.use_corrected?[F(e.time_corrected),F(e.time)]:[F(e.time)]).find(Boolean)??O(e.timestamp),$=te??B,q=e.mucus_sensation??e.mucusSensation??"",ye=e.mucus_appearance??e.mucusAppearance??"",Q=e.observations??"",pe=!!(e.had_relations??e.hadRelations),Ie=Y&&Y.value!=="none",ue=A!=null,U=!!(q&&q.trim()||ye&&ye.trim()),De=!!(Q&&Q.trim()),J=!(ue||Ie||U||De||pe),ne=e.peakStatus||(e.peak_marker==="peak"?"P":null),ve=ne&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[ne]||null,X=!!(b&&e.isoDate),ae=!!D,Se=ae&&e.isoDate===D||ne==="P"||e.peak_marker==="peak",re=Se?"remove":ae?"update":"assign",de=re==="assign"?"Asignar día pico":re==="update"?"Actualizar día pico":"Quitar día pico",Z=de,le=async()=>{if(!(!b||p)){k(!0);try{await b(e,!Se),c&&c()}catch(W){console.error("Error toggling peak marker from tooltip:",W)}finally{k(!1)}}},Ce=()=>{oe()},oe=W=>{n&&(n(e,W),c&&c())},me=(W=>{switch(W){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return a.jsxs(ke.div,{ref:T,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:E,left:v,width:S},children:[a.jsx("div",{className:"origin-top-left",style:{transform:`scale(${x})`,width:w,minHeight:y},children:a.jsxs("div",{className:"relative tooltip-surface--gradient backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden",children:[a.jsx(tt,{variant:"ghost",size:"icon",onClick:c,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-suave rounded-full w-6 h-6 transition-all duration-200",children:a.jsx(Nt,{size:20})}),pe&&a.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:a.jsx(wt,{className:"w-4 h-4 text-fertiliapp-fuerte",fill:"currentColor"})}),a.jsxs("div",{className:"p-2",children:[a.jsxs("div",{className:"mb-2 relative",children:[a.jsx("div",{className:"w-5 h-5 bg-fertiliapp-fuerte rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:a.jsx(ut,{className:"w-2 h-2 text-white",fill:"currentColor"})}),a.jsxs("div",{className:"mb-1 pl-8",children:[a.jsxs("div",{className:"flex items-baseline justify-start gap-2",children:[a.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:G?lt(Ue(G),"dd/MM",{locale:Mt}):"Fecha"}),a.jsxs("span",{className:"text-sm text-fertiliapp-fuerte font-medium whitespace-nowrap",children:["Día ",e.cycleDay||"N/A"]})]}),ve&&a.jsx("div",{className:"mt-1 flex justify-start",children:a.jsx(kt,{className:"bg-tarjeta text-fertiliapp-fuerte border border-fertiliapp-suave px-2 py-0 text-[11px]",children:ve})})]})]}),J?a.jsxs("div",{className:"pt-1 space-y-3",children:[a.jsx(ke.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:a.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(X||n)&&a.jsxs(ke.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[X&&a.jsx(dt,{mode:re,size:"sm",onClick:le,pending:p,"aria-label":Z,title:de,className:"shrink-0"}),n&&a.jsxs(tt,{onClick:Ce,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[a.jsx(nt,{className:"h-4 w-4"}),a.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-1",children:[ue&&a.jsx(ke.button,{type:"button",onClick:()=>oe("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-temp-suave rounded-2xl p-1 border border-temp focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-temp",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-temp rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Pt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(A).toFixed(2)}),a.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&a.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),$&&a.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:$})]})})]})}),Ie&&a.jsx(ke.button,{type:"button",onClick:()=>oe("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${me.light} rounded-3xl p-1 ${me.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-6 h-6 ${me.bg} rounded-lg flex items-center justify-center shadow-lg ${me.glow} shadow-lg`,children:a.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:`text-md font-semibold ${me.text}`,children:Y.label})})]})}),a.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[a.jsx(ke.button,{type:"button",onClick:()=>oe("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-sensacion-suave rounded-3xl p-1 border border-sensacion focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-sensacion rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Tt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-sensacion-fuerte",children:q||"-"})})]})}),a.jsx(ke.button,{type:"button",onClick:()=>oe("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-apariencia-suave rounded-3xl p-1 border border-apariencia focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-apariencia rounded-lg flex items-center justify-center shadow-md",children:a.jsx(ut,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-apariencia-fuerte",children:ye||"-"})})]})}),De&&a.jsx(ke.button,{type:"button",onClick:()=>oe("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-observaciones-suave rounded-3xl p-1 border border-observaciones focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-observaciones rounded-lg flex items-center justify-center shadow-md",children:a.jsx(nt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-sm font-semibold text-observaciones-fuerte",children:Q})})]})})]})]}),(n||f&&!R&&e.id||X&&!R)&&a.jsxs(ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[X&&!R&&a.jsx(dt,{mode:re,size:"sm",onClick:le,pending:p,"aria-label":Z,title:de,className:"shrink-0"}),a.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:n&&a.jsxs(tt,{onClick:Ce,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[a.jsx(nt,{className:"h-4 w-4 mr-1.5"}),a.jsx("span",{className:"font-medium",children:R?"Añadir datos":""})]})})]})]})]})]})}),a.jsx("div",{className:"absolute -inset-2 tooltip-glow rounded-3xl blur-xl -z-10"})]})},jt=({baselineTemp:e,firstHighIndex:r,processedData:i,isValid:h})=>{if(r==null)return{confirmed:!1};const f=e+.2,n=[],c=[],b=new Set,D=o=>{o==null||b.has(o)||(b.add(o),c.push(o))};let x=0,w=!1,y=null,S=!1;const j=r>0?r-1:null,T=()=>j!=null?[j,...c]:[...c],H=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:T(),highSequenceIndices:[...c]});for(let o=r;o<i.length;o+=1){const p=i[o];if(!h(p))break;const k=p.displayTemperature;if(!Number.isFinite(k))break;if(k>e){if(D(o),n.push({index:o,temp:k}),!w&&n.length===3&&n[2].temp<f&&(S=!0),!w&&n.length===4&&n[2].temp>=f)return{confirmed:!0,confirmationIndex:n[3].index,usedIndices:T(),highSequenceIndices:[...c],rule:"pp-4-high"};if(!w&&S&&n.length===5)return{confirmed:!0,confirmationIndex:n[4].index,usedIndices:T(),highSequenceIndices:[...c],rule:"pp-ex1-5-high"};if(w){if(n.length===4&&y==null)if(k>=f)y=o;else return H();if(y!=null&&n.length>=5){const g=n[n.length-1].index;if(g!==y)return{confirmed:!0,confirmationIndex:g,usedIndices:T(),highSequenceIndices:[...c],rule:"pp-ex2-5-high"}}}continue}if(k<=e){if(x+=1,D(o),x>=2)return H();if(n.length>0&&n.length<3&&!w){w=!0;continue}break}break}return{confirmed:!1,usedIndices:T(),highSequenceIndices:[...c]}},Ve={0:0,1:.4,2:.8,3:1},Ct={M:.8,F:1,"M+":1,white:.4},Ft=(e,r=0,i=1)=>!Number.isFinite(e)||e<r?r:e>i?i:e,_t=e=>e?String(e).toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),""):"",ht=e=>_t(e).replace(/\s+/g," ").trim(),gt=(e,r=[])=>{if(!e)return null;let i=null;return r.forEach((h,f)=>{const{patterns:n=[],level:c,descriptor:b,negatedLevel:D,allowedModifiers:x=null,disallowedModifiers:w=null,selectionScore:y,forceSelection:S=!1}=h||{};n.forEach(j=>{if(!j)return;const T=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${j})(?=$|[^a-z0-9])`,"g");let H;for(;(H=T.exec(e))!==null;){const o=H[1]?H[1].trim():null;if(x&&!x.includes(o)||w&&w.includes(o))continue;let p=c;o==="no"?p=D??1:o==="muy"?p=Math.min(3,c+1):(o==="poco"||o==="leve")&&(p=Math.max(0,c-1));const k=y??p+f*.001,g=typeof b=="function"?b({modifier:o}):b;(!i||S||p>i.level||p===i.level&&k>i.selectionScore)&&(i={level:p,baseLevel:c,descriptor:g,modifier:o,selectionScore:k,force:S})}})}),i},Lt=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],Rt=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],bt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const i=Math.round(e);if(i>=0&&i<=3)return i}const r=String(e).trim();return/^[0-3]$/.test(r)?Number.parseInt(r,10):null},xt=e=>{const r=bt(e);if(r!=null)return{level:r,reason:`S${r}`,descriptor:`S${r}`,hasInput:!0};const i=e!=null?String(e).trim():"",h=ht(e),f=i.length>0;if(!h)return{level:0,reason:null,descriptor:null,hasInput:f};if(/^s\s*0?$/.test(h))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(h==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const n=gt(h,Lt);return n?{level:Math.max(0,Math.min(3,n.level)),reason:n.descriptor,descriptor:n.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:f}},yt=e=>{const r=bt(e);if(r!=null)return{level:r,reason:`M${r}`,descriptor:`M${r}`,hasInput:!0};const i=e!=null?String(e).trim():"",h=ht(e),f=i.length>0;if(!h)return{level:0,reason:null,descriptor:null,hasInput:f};if(/^m\s*0$/.test(h))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(i))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const n=gt(h,Rt);return n?{level:Math.max(0,Math.min(3,n.level)),reason:n.descriptor,descriptor:n.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:f}},zt=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Et=({appearance:e,observations:r,fertilitySymbol:i})=>{const h=[e,r,i].map(n=>String(n||"").toUpperCase()),f=n=>{if(!n)return!1;const b=`(?:^|[^\\p{L}\\p{N}])${zt(n)}(?=$|[^\\p{L}\\p{N}])`,D=new RegExp(b,"u");return h.some(x=>D.test(x))};return f("M+")?"M+":f("M")?"M":f("F")||f("FER")?"F":String(i||"").toLowerCase()==="white"?"white":"none"},Bt=e=>{if(e==null)return"";const r=String(e).trim().toUpperCase();return r==="P"||r==="PEAK"?"P":r==="1"||r==="P1"||r==="P+1"?"1":r==="2"||r==="P2"||r==="P+2"?"2":r==="3"||r==="P3"||r==="P+3"?"3":""},Ge=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,$t=(e,r,i)=>{const h=e?.mucusSensation??e?.mucus_sensation,f=e?.mucusAppearance??e?.mucus_appearance,n=e?.fertility_symbol??e?.fertilitySymbol,c=e?.observations??e?.notes,b=e?.peak_marker??e?.peakMarker??null,D=typeof b=="string"?b.trim().toLowerCase()==="peak":!1,x=xt(h),w=yt(f);let y=Ge(x.level),S=Ge(w.level);const j=[];x.reason&&j.push(`S:${x.reason}`),w.reason&&j.push(`M:${w.reason}`);const T=Et({appearance:f,observations:c,fertilitySymbol:n}),H=T;let o=T;o==="white"&&(S=Math.max(S,1)),o==="M"&&(S=Math.max(S,2)),o==="M+"&&(S=Math.max(S,3)),o==="F"&&(S=Math.max(S,3),y=Math.max(y,3));const p=Ve[y]??0,k=Ve[S]??0,g=Math.max(p,k);o&&o!=="none"&&j.push(`symbol:${o}`);const M=Ct[o]??0,v=Ft(Math.max(g,M)),E=r!=null&&Number.isFinite(r)?g>=r+.4-1e-9:!1;E&&j.push("cambioBIP");const R={hasSensation:!!x.hasInput,hasAppearance:!!w.hasInput,hasSymbol:n!=null&&String(n).trim()!==""&&String(n).trim().toLowerCase()!=="none",hasObservation:c!=null&&String(c).trim()!==""};R.hasAny=R.hasSensation||R.hasAppearance||R.hasSymbol||R.hasObservation;const A=Bt(e?.normalizedPeakStatus??e?.peakStatus??e?.peak_marker);return{index:i,S:y,M:S,symbolDetected:o,rawSymbol:H,isPeakMarked:D,scoreCore:g,scoreFertil:v,hasChangeBIP:E,reasons:j,entryFlags:R,descriptors:{sensation:x.descriptor??x.reason??null,appearance:w.descriptor??w.reason??null},normalizedPeakStatus:A}},Ht=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const r=[];for(let f=0;f<Math.min(6,e.length);f+=1){const n=e[f];if(!n||String(n?.fertility_symbol||"").toLowerCase()==="red")continue;const b=xt(n?.mucusSensation??n?.mucus_sensation),D=yt(n?.mucusAppearance??n?.mucus_appearance),x=Ve[Ge(b.level)]??0,w=Ve[Ge(D.level)]??0;r.push(Math.max(x,w))}const i=r.length>0?Math.max(...r):0;return{days:e.map((f,n)=>$t(f,i,n)),bipScore:i}},Ot=e=>{for(let r=0;r<e.length;r+=1){const i=e[r];if(i){if(i.isPeakMarked)return{source:"Interno",day:r+1,reason:"P",kind:"profile"};if(i.symbolDetected==="white"||i.rawSymbol==="white")return{source:"Interno",day:r+1,reason:"white",kind:"profile"};if(i.symbolDetected==="M+"||i.symbolDetected==="F")return{source:"Interno",day:r+1,reason:"M+",kind:"profile"};if(i.symbolDetected==="M")return{source:"Interno",day:r+1,reason:"M",kind:"profile"};if(i.M>=2||i.S>=2)return{source:"Interno",day:r+1,reason:"S/M>=2",kind:"profile"}}}return null},Wt=(e,r)=>{const i=e.filter(n=>n&&Number.isFinite(n.day)).map(n=>({...n}));if(i.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:r,usedCandidates:[],notes:["Sin candidatos disponibles"]};const h=[...i].sort((n,c)=>{const b=Number.isFinite(n.day)?n.day:Number.POSITIVE_INFINITY,D=Number.isFinite(c.day)?c.day:Number.POSITIVE_INFINITY;return b-D}),f=Math.min(...h.map(n=>Math.round(n.day)));return{status:f!=null?"ok":"indeterminado",selectedDay:f??null,selectedMode:r,usedCandidates:h,notes:[]}},qt=({processedData:e=[],config:r={},calculatorCandidates:i=[],context:h={}})=>{const{calculators:f={cpm:!0,t8:!0},postpartum:n=!1,combineMode:c="estandar"}=r||{},D=new Set(["estandar"]).has(c)?c:"estandar",{postPeakStartIndex:x=null,temperatureInfertileStartIndex:w=null,temperatureConfirmationIndex:y=null,temperatureRule:S=null,todayIndex:j=null}=h||{},{days:T,bipScore:H}=Ht(e),o=Array.isArray(T)?T.length:0,p=t=>Number.isInteger(t)&&t>=0&&t<o,k=t=>{const l=t?.peak_marker??t?.peakMarker??null;return typeof l=="string"&&l.trim().toLowerCase()==="peak"},M=(()=>{if(!Array.isArray(e)||e.length===0)return null;for(let t=e.length-1;t>=0;t-=1)if(k(e[t]))return t;return null})(),v=p(M)?M:null,E=[],R=t=>{!t||!Number.isFinite(t.day)||E.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};R(Ot(T));const A=[],Y=[];n&&A.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),n||i.forEach(t=>{if(!t)return;const l=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";if(!(l==="CPM"&&f.cpm||l==="T8"&&f.t8))return;const ee={...t,source:l,kind:"calculator"};R(ee)});const G=E.map(t=>({...t})),O=Wt(E,D);O.ignoredCalculatorCandidates=Y,O.notes=Array.from(new Set([...O.notes??[],...A].filter(Boolean)));const be=t=>{if(!Number.isFinite(t))return null;const l=Math.max(1,Math.round(t));return e.length>0?Math.min(l,e.length):l},te=Number.isFinite(O.selectedDay)?be(O.selectedDay):null;if(te!=null&&te!==O.selectedDay){const t=`El día calculado (${O.selectedDay}) supera la duración del ciclo. Se usa ${te}.`;O.notes=Array.from(new Set([...O.notes??[],t])),O.selectedDay=te}let xe=null;te!=null&&te>=1&&(xe=te-1);const B=T.length>0?T.length-1:null,$=Number.isInteger(xe)&&xe>=0?xe:null;let q=null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(x)){const t=Math.max($,Math.min(x-1,B));q=t>=$?t:$}else if(p(v)){const t=Math.min(B,v+2),l=Math.max($,t);q=l>=$?l:$}else q=B;const ye=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,Q=t=>Number.isInteger(t)?B==null||B<0?t>=0?t:null:t<0?null:t>B?B:t:null,pe=t=>{if(!Number.isInteger(t)||t<0||t>=e.length)return null;const l=e[t]?.isoDate;if(!l)return null;try{const P=Ue(l);return Number.isNaN(P?.getTime?.())?null:P}catch{return null}},Ie=t=>{const l=pe(t);if(!l)return null;try{return lt(l,"dd/MM")}catch{return null}};let ue=null,U=null;if(p(v)){const t=v+3;p(t)&&(ue=t);const l=v+4;p(l)&&(U=l);const P=Q(v),ee=pe(P);if(ee)for(let Ne=P+1;Ne<e.length;Ne+=1){const Xe=pe(Ne);if(!Xe)continue;const Ee=pt(Xe,ee);if(ue==null&&Ee>=3&&(ue=Q(Ne)),U==null&&Ee>=4&&(U=Q(Ne)),n){if(U!=null)break}else if(ue!=null)break}}const De=Q(y),ie=Q(w);let J=De;if(J==null&&ie!=null){const t=Q(ie-1);t!=null&&t>=0&&(J=t)}const ne=(n?U:ue)??null,je=null,ve=[ne,ie].filter(t=>Number.isInteger(t)),X=ve.length>0?Math.min(...ve):null,ae=Number.isInteger(ne),he=Number.isInteger(ie),Se=ae&&he?Math.max(ne,ie):null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(X)){const t=Math.max($,X-1);q=Math.min(t,B)}else q=B;const re=q??B??null,de=X,Z=n?"P+4":"P+3";let le=null;ae&&he?le=`${Z} y T+3`:ae?le=Z:he&&(le=S??"Temperatura");const Ce={estandar:"modo estándar",marcador:"marcador explícito"},oe=O?.selectedMode??D??"estandar",Pe=O?.usedCandidates??[],me=Pe.some(t=>t?.kind==="profile"),W=Pe.some(t=>t?.kind==="calculator"),ce=T.some(t=>t?.entryFlags?.hasAppearance||t?.entryFlags?.hasSensation||t?.symbolDetected&&t.symbolDetected!=="none");let V=`Fase fértil abierta (${Ce[oe]??oe}).`;oe==="marcador"?V="Fase fértil abierta (ajustada por tus marcadores).":me&&ce?V="Fase fértil abierta (basada en tus observaciones de moco).":W&&!me&&(V="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const He=ae&&he,we="Infertilidad absoluta postovulatoria",fe=`Ventana cerrada por doble criterio: ${le??"criterio indeterminado"}.`,Oe=Q(v),Fe=Ie(Oe),ze=Ie(J),We="Infertilidad estimada por moco",qe=Fe?`Fase de infertilidad alcanzada por determinación de día pico el ${Fe}.`:"Fase de infertilidad alcanzada por determinación de día pico.",Ke="Infertilidad estimada por temperatura",Qe=ze?`Infertilidad estimada por temperatura desde el ${ze}.`:"Infertilidad estimada por temperatura.",s=new Array(T.length).fill(null);let u=null,d=0,I=null;const m={inicio:0,aumento:1,alta:2,muyAlta:3},N=t=>{if(!t)return[];const l=[];if(Number.isFinite(t.M)&&t.M>0){const P=t.descriptors?.appearance;l.push(`M${t.M}${P?` (${P})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const P=t.descriptors?.sensation;l.push(`S${t.S}${P?` (${P})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?l.push("white"):l.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&l.push("cambio BIP"),l},_=["inicio","aumento","alta","muyAlta"];for(let t=0;t<T.length;t+=1){const l=T[t];if(!l){s[t]=null;continue}const P=Number.isInteger(X),ee=P?t>=X:!1,Ne=Number.isInteger(Se)?t>=Se:!1,Xe=$!=null&&re!=null&&t>=$&&(P?t<X:t<=re)&&!ee,Ee=Number.isInteger(j)&&j!=null?t>j:!1;if(!Xe){if(d=0,u=null,!(ee||re!=null&&t>re)||!P){s[t]=null;continue}const Ye=!!l.entryFlags?.hasAny,et=Ye?null:"Sin registro hoy; estimación basada en días adyacentes.";let Re=null,Be=null,$e=null;if(Ne&&He?(Re=we,Be=fe,$e="absolute"):ae&&t>=ne?(Re=We,Be=qe,$e="mucus"):he&&t>=ie&&(Re=Ke,Be=Qe,$e="temperature"),!$e){s[t]=null;continue}s[t]={index:t,state:"infertil",status:$e,title:Re,header:Re,body:Be,detail:le,hasRecord:Ye,inherited:!1,note:et,isFertile:!1,phase:"postOvulatory",label:Re,summaryText:Be,reasonsList:[],reasonsText:"",showFertilityStatus:!Ee};continue}const _e=!!l.entryFlags?.hasAny;let Te=0;l.isPeakMarked||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3||l.M>=3?Te=3:l.M>=2||l.S>=2||l.symbolDetected==="M"?Te=2:(l.M>=1||l.S>=1||l.hasChangeBIP)&&(Te=1),_e?(d=0,u=Te):d+=1;const It=l.M>=2||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3;let Me=Te,K=null;{if(!_e){const Ye=u??Te,et=Math.floor(d/2);Me=Math.max(0,Ye-et)}const Ze=Math.max(0,Math.min(3,Me));K=_[Ze]}const ct=N(l),Ae=ct.join("; "),Le=Oe!=null?t-Oe:null,Je=Le!=null?ye(Le):null,vt=_e?null:"Sin registro hoy; estimación basada en días adyacentes.";K!=="waiting"&&(Le===0||Le===1||Le===2?(K="muyAlta",Me=Math.max(Me,3)):Le===3?(m[K]<m.alta&&(K="alta"),Me=Math.max(Me,2)):I!=null&&t-I<=3&&(m[K]<m.aumento&&(K="aumento"),Me=Math.max(Me,1))),(K==="alta"||K==="muyAlta"||It)&&(I=t);let ge,se;switch(K){case"waiting":ge="Fertilidad en espera de confirmación por temperatura",se=`Final de moco alcanzado (≥${Z}). Ventana mantenida hasta confirmación térmica (T+3).`;break;case"aumento":ge="Aumento de fertilidad",se=Ae?`Signos en aumento: ${Ae}.`:"Signos en aumento.";break;case"alta":ge="Fertilidad alta",se=Ae?`Signos fértiles claros (${Ae}).`:"Signos fértiles claros.";break;case"muyAlta":{ge="Fertilidad muy alta",se=`Día de máxima fertilidad${Je?` (${Je})`:""}.`,se+=Ae?` Signos pico: ${Ae}.`:" Signos pico presentes.";break}default:ge="Ventana fértil abierta",se="Hoy sin signos destacables, a la espera de registrar más datos.";break}_e||(K==="alta"?(ge="Fertilidad estimada alta",se=`${se} Sin datos apuntados este día; se estima en base a días cercanos.`):K==="muyAlta"?(ge="Fertilidad estimada muy alta",se=`${se} Sin datos apuntados este día; se estima en base a días cercanos.`):(K==="aumento"||K==="inicio")&&(ge="Ventana fértil abierta (sin registro hoy)",se=`${se} Sin datos apuntados este día; se estima en base a días cercanos.`));const St={index:t,state:K,level:K==="waiting"?Te:Me,title:ge,header:V,body:se,reasonsList:ct,reasonsText:Ae,hasRecord:_e,inherited:!_e,note:vt,isFertile:!0,phase:"fertile",label:ge,summaryText:se,delta:Je,showFertilityStatus:!Ee,reasonParts:{symbol:l.symbolDetected??null,appearance:l.descriptors?.appearance??null,sensation:l.descriptors?.sensation??null}};s[t]=St}re!=null&&(q=re);let L=null;if(Number.isInteger(j)&&s.length>0){const t=Math.min(Math.max(j,0),s.length-1);let l=null;for(let P=t;P>=0;P-=1){const ee=s[P];if(ee&&(l||(l=ee),ee.isFertile)){L=ee;break}}!L&&l&&(L=l)}const z={bipScore:H,effectivePeakIndex:v,candidatesBeforeAggregate:G,closureDetail:le,waitingStartIndex:je,pPlus3Index:ue,pPlus4Index:U,temperatureConfirmationIndex:J,temperatureInfertileIndex:ie,temperatureRule:S??null,mucusInfertileStartIndex:ne,postOvulatoryStartIndex:de,firstEstimateIndex:X,absoluteStartIndex:Se};return{fertileStartFinalIndex:xe,fertileWindow:$!=null&&q!=null?{startIndex:$,endIndex:q,waitingStartIndex:je,closureDetail:le,temperatureConfirmationIndex:J,temperatureInfertileStartIndex:ie,mucusInfertileStartIndex:ne,postOvulatoryStartIndex:de,temperatureRule:S??null}:null,dailyAssessments:s,currentAssessment:L,candidates:G,aggregate:O,debug:z}},mt=e=>{if(!e)return null;try{const r=new Date(e);return Number.isNaN(r.getTime())?null:r}catch{return null}},Xt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const i=e.map(c=>{if(!c?.startDate||!c?.endDate)return null;const b=mt(c.startDate),D=mt(c.endDate);if(!b||!D||D<b)return null;const x=Math.round((D-b)/(1e3*60*60*24))+1;if(!Number.isFinite(x)||x<=0)return null;const w=!!c?.ignoredForAutoCalculations;return{duration:x,ignored:w}}).filter(Boolean).filter(c=>!c.ignored);if(i.length<6)return null;const h=i.reduce((c,b)=>b.duration<c.duration?b:c),f=i.length>=12?20:21,n=h.duration-f;return Number.isFinite(n)?{source:"CPM",day:Math.max(1,Math.round(n)),reason:`ciclo_mas_corto=${h.duration}`,kind:"calculator"}:null},rt=e=>{if(e==null||e==="")return null;const r=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(r)?r:null},Yt=e=>{const r=[e?.temperature_chart,e?.temperature_raw,e?.temperature_corrected];for(const i of r){const h=rt(i);if(h!==null)return h}if(Array.isArray(e?.measurements)){const i=n=>{if(!n)return null;const c=rt(n.temperature),b=rt(n.temperature_corrected);return n.use_corrected&&b!==null?b:c!==null?c:b!==null?b:null},f=e.measurements.find(n=>n&&n.selected&&i(n)!==null)||e.measurements.find(n=>i(n)!==null);if(f){const n=i(f);if(n!==null)return n}}return null},Ut=(e=[],r)=>{if(!Array.isArray(e)||e.length===0||typeof r!="function")return null;const i=[];if(e.forEach(f=>{if(!f?.data||!Array.isArray(f.data)||!f.startDate)return;const n=f.data.filter(S=>S&&S.isoDate).map(S=>({...S,displayTemperature:Yt(S)}));if(n.length===0)return;const{ovulationDetails:c}=r(n);if(!c?.confirmed)return;const b=Number.isInteger(c?.ovulationIndex)?c.ovulationIndex:Number.isInteger(c?.confirmationIndex)?c.confirmationIndex:null;if(b==null||b<0||b>=n.length)return;const D=n[b],x=Number(D?.cycleDay);if(!Number.isFinite(x)||x<=0)return;const w=Math.max(1,Math.round(x-8)),y={riseDay:x,t8Day:w,ignored:!!f?.ignoredForAutoCalculations};!y.ignored&&i.length<12&&i.push(y)}),i.length<6)return null;const h=i.reduce((f,n)=>n.t8Day<f.t8Day?n:f);return{source:"T8",day:Math.max(1,Math.round(h.t8Day)),reason:`t8=${h.t8Day}`,kind:"calculator"}},st={calculators:{cpm:!0,t8:!0},combineMode:"estandar"},it=36.1,at=37.5,ft=(e=[],r={})=>{const{postpartum:i=!1}=r,h=o=>o&&o.displayTemperature!=null&&!o.ignored,f=6,n=.05,c=o=>{if(!o||o.length!==f)return null;const p=o.map(M=>M.temp);if(p.some(M=>!Number.isFinite(M)))return null;const k=p.reduce((M,v)=>v>M?v:M,p[0]),g=p.reduce((M,v)=>v>=k-n&&v<k?M+1:M,0);return g>=2?null:{baselineTemp:k,baselineStartIndex:o[0].index,baselineIndices:o.map(M=>M.index),baselineBorderlineCount:g}},b=o=>{const p=[];for(let k=o;k<e.length;k+=1){const g=e[k];if(!h(g))continue;const M=g.displayTemperature;if(Number.isFinite(M)&&(p.push({index:k,temp:M}),p.length>f&&p.shift(),p.length===f)){const v=c(p);if(!v)continue;let E=null;for(let R=k+1;R<e.length;R+=1){const A=e[R];if(!h(A))continue;const Y=A.displayTemperature;if(Number.isFinite(Y)&&Y>v.baselineTemp){E=R;break}}return{baselineTemp:v.baselineTemp,baselineStartIndex:v.baselineStartIndex,baselineIndices:v.baselineIndices,baselineBorderlineCount:v.baselineBorderlineCount,firstHighIndex:E}}}return null},D={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let x=null,w=null,y=null,S=[],j=D,T=0;const H=({baselineTemp:o,firstHighIndex:p})=>{if(p==null)return{confirmed:!1};const k=o+.2,g=[],M=[],v=new Set,E=F=>{F==null||v.has(F)||(v.add(F),M.push(F))};let R=null,A=!1;const Y=p>0?p-1:null,G=()=>Y!=null?[Y,...M]:[...M];for(let F=p;F<e.length;F++){const O=e[F];if(!h(O))break;const be=O.displayTemperature;if(!Number.isFinite(be))break;if(be>o){if(E(F),g.push({index:F,temp:be}),g.length===3&&g[2].temp>=k)return{confirmed:!0,confirmationIndex:g[2].index,usedIndices:G(),highSequenceIndices:[...M],rule:"3-high"};if(g.length===4&&g[2].temp<k&&g[3].temp>o)return{confirmed:!0,confirmationIndex:g[3].index,usedIndices:G(),highSequenceIndices:[...M],rule:"german-3+1"};if(R!==null&&g.length===3&&g[2].temp>=k)return{confirmed:!0,confirmationIndex:g[2].index,usedIndices:G(),highSequenceIndices:[...M],rule:"german-2nd-exception"};if(g.length===5&&g[3].temp>o&&g[4].temp>=k)return{confirmed:!0,confirmationIndex:g[4].index,usedIndices:G(),highSequenceIndices:[...M],rule:"5-high"};continue}if(be>=o-.05&&R===null&&g.length>0&&g.length<3){R=F,E(F),g.push({index:F,temp:o});continue}if(!A&&g.length>0&&g.length<3){A=!0,E(F);continue}break}return{confirmed:!1,usedIndices:G(),highSequenceIndices:[...M]}};for(;T<e.length;){const o=b(T);if(!o)break;if(x=o.baselineTemp,w=o.baselineStartIndex,S=Array.isArray(o.baselineIndices)?[...o.baselineIndices]:[],y=o.firstHighIndex,o.baselineBorderlineCount,y==null){T=w+1;continue}const p=i?jt({...o,processedData:e,isValid:h}):H(o);if(p?.requireRebaseline){T=w+1;continue}if(p?.confirmed){const k=p.highSequenceIndices?.length?p.highSequenceIndices[0]:null,g=Number.isInteger(p.confirmationIndex)?Math.max(0,Math.min(p.confirmationIndex,e.length-1)):null;let M=null;g!=null&&(M=Math.max(0,Math.min(g,e.length-1))),j={confirmed:!0,confirmationIndex:g,infertileStartIndex:M,rule:p.rule,highSequenceIndices:p.highSequenceIndices??p.usedIndices,usedIndices:p.usedIndices,ovulationIndex:y??k??null};break}T=w+1}return{baselineTemp:x,baselineStartIndex:w,firstHighIndex:y,baselineIndices:S,ovulationDetails:j}},Zt=(e,r,i,h,f,n=5,c=!1,b=null,D=[],x=null,w=!1)=>{const y=C.useRef(null),S=C.useRef(null),[j,T]=C.useState({width:0,height:0,viewportWidth:0,viewportHeight:0}),[H,o]=C.useState(null),[p,k]=C.useState({x:0,y:0}),[g,M]=C.useState(null),v=C.useCallback(()=>{o(null),M(null)},[]),E=s=>{if(s==null)return"";const u=String(s).trim().toUpperCase();return u==="P"||u==="PEAK"?"P":u==="1"||u==="P1"||u==="P+1"?"1":u==="2"||u==="P2"||u==="P+2"?"2":u==="3"||u==="P3"||u==="P+3"?"3":""},R=C.useMemo(()=>Dt(e),[e]),A=C.useMemo(()=>{const s=d=>{if(d==null||d==="")return null;const I=parseFloat(String(d).replace(",","."));return Number.isFinite(I)?I:null},u=d=>{if(!d)return null;const I=s(d.temperature),m=s(d.temperature_corrected);return d.use_corrected&&m!==null?m:I!==null?I:m!==null?m:null};return e.map(d=>{const I=[d?.temperature_chart,d?.temperature_raw,d?.temperature_corrected];let m=null;for(const t of I)if(t!=null&&t!==""){m=t;break}if(m==null&&Array.isArray(d?.measurements)){const l=d.measurements.find(P=>P&&P.selected&&u(P)!==null)||d.measurements.find(P=>u(P)!==null);l&&(m=u(l))}const N=d?.isoDate,_=d?.peak_marker??d?.peakStatus??null,L=N?R[N]??_:_,z=E(L);return{...d,displayTemperature:s(m),peakStatus:L??null,normalizedPeakStatus:z}})},[e,R]),Y=C.useMemo(()=>{if(!Array.isArray(A)||A.length===0)return null;const s=new Date;let u=null;return A.forEach((d,I)=>{if(d?.isoDate)try{const m=Ue(d.isoDate);if(Number.isNaN(m?.getTime?.()))return;pt(m,s)<=0&&(u=I)}catch{}}),u},[A]);C.useLayoutEffect(()=>{const s=()=>{if(!y.current)return;const d=y.current.parentElement||y.current;let I=d.clientWidth||600,m=d.clientHeight||400,N=y.current.clientWidth>0?y.current.clientWidth:I,_,L,z,t;if(r){let l=window.innerWidth,P=window.innerHeight;if(c&&P>l&&([l,P]=[P,l]),N=l,z=l,t=P,i==="portrait"&&!c){const ee=Math.max(30,l*.05);_=(l-ee)/n*e.length}else _=l/n*e.length;L=P}else _=N/n*e.length,L=m,z=N,t=m;T({width:_,height:L,viewportWidth:z,viewportHeight:t})};s(),window.addEventListener("resize",s);let u;if(y.current){const d=y.current.parentElement||y.current;u=new ResizeObserver(s),u.observe(d)}return()=>{window.removeEventListener("resize",s),u&&u.disconnect()}},[r,e.length,n,i,c]);const G=C.useMemo(()=>A.filter(s=>s&&s.isoDate&&!s.ignored&&s.displayTemperature!==null&&s.displayTemperature!==void 0),[A]),F=C.useMemo(()=>A.filter(s=>s&&s.isoDate),[A]),O=G.length>0,be=C.useMemo(()=>!Array.isArray(A)||A.length===0?!1:A.some(s=>s?s.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(N=>{const _=s?.[N];return _!=null&&String(_).trim()!==""})||(()=>{const N=s?.fertility_symbol??s?.fertilitySymbol;return N==null?!1:String(N).trim()!==""})()||(()=>{const N=s?.observations??s?.notes;return N==null?!1:String(N).trim()!==""})()?!0:E(s?.normalizedPeakStatus??s?.peakStatus??s?.peak_marker)!=="":!1),[A]),te=C.useMemo(()=>{const s=b??{},u=(_,L)=>typeof _=="boolean"?_:L,d={cpm:u(s?.calculators?.cpm,st.calculators.cpm),t8:u(s?.calculators?.t8,st.calculators.t8)},m=new Set(["estandar"]).has(s?.combineMode)?s.combineMode:st.combineMode,N=!!s?.postpartum;return{calculators:d,combineMode:m,postpartum:N}},[b]),xe=C.useMemo(()=>{if(Array.isArray(x)&&x.length>0)return x.map(I=>{if(!I)return null;const{source:m,day:N,reason:_}=I,L=typeof m=="string"?m.toUpperCase().replace(/-/g,""):"";if(L!=="CPM"&&L!=="T8")return null;const z=Number(N);return Number.isFinite(z)?{source:L,originalSource:m??L,day:z,reason:typeof _=="string"?_:"",kind:"calculator"}:null}).filter(Boolean);const s=Array.isArray(D)?D:[];if(!s.length)return[];const u=Xt(s),d=Ut(s,ft);return[u,d].filter(Boolean)},[x,D]),{peakDayIndex:B,thirdDayIndex:$,peakInfertilityStartIndex:q}=C.useMemo(()=>{if(!F.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const s=F.map(I=>I?.normalizedPeakStatus??E(I?.peakStatus??I?.peak_marker));let u=null,d=null;if(s.forEach((I,m)=>{I==="P"&&u==null&&(u=m),I==="3"&&d==null&&(d=m)}),u==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(d!=null){const I=F.length-1,m=Math.min(d+1,I);return{peakDayIndex:u,thirdDayIndex:d,peakInfertilityStartIndex:m}}return{peakDayIndex:u,thirdDayIndex:null,peakInfertilityStartIndex:null}},[F]),{baselineTemp:ye,baselineStartIndex:Q,firstHighIndex:pe,baselineIndices:Ie,ovulationDetails:ue}=C.useMemo(()=>ft(A,{postpartum:te.postpartum}),[A,te.postpartum]),U=C.useMemo(()=>({...ue??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:ye,baselineIndices:Ie,baselineStartIndex:Q,firstHighIndex:pe,peakDayIndex:B,peakInfertilityStartIndex:q,thirdDayIndex:$}),[ue,ye,Ie,Q,pe,B,q,$]),De=C.useMemo(()=>qt({processedData:A,config:te,calculatorCandidates:xe,context:{postPeakStartIndex:q,peakThirdDayIndex:U?.thirdDayIndex??null,temperatureInfertileStartIndex:U?.infertileStartIndex??null,temperatureConfirmationIndex:U?.confirmationIndex??null,temperatureRule:U?.rule??null,todayIndex:Y}}),[A,te,xe,U?.thirdDayIndex,U?.infertileStartIndex,U?.confirmationIndex,U?.rule,B,q,Y]),ie=C.useMemo(()=>A.map((s,u)=>{if(!s)return s;const d=Number.isInteger(Y)?u>Y:!1;return{...s,isFutureDay:d}}),[A,Y]),J=C.useMemo(()=>ie.filter(s=>s&&s.isoDate),[ie]),{tempMin:ne,tempMax:je}=C.useMemo(()=>{const s=G.map(z=>z.displayTemperature).filter(z=>z!=null);if(s.length===0)return{tempMin:it,tempMax:at};const u=at-it,d=Math.min(...s),I=Math.max(...s);let m=Math.min(d,it),N=Math.max(I,at);const _=z=>Math.floor(z*10)/10,L=z=>Math.ceil(z*10)/10;if(m=_(m),N=L(N),N-m<u){const z=(m+N)/2;m=_(z-u/2),N=L(z+u/2)}return Math.abs(m-d)<1e-9&&(m=_(m-.1)),Math.abs(N-I)<1e-9&&(N=L(N+.1)),{tempMin:parseFloat(m.toFixed(1)),tempMax:parseFloat(N.toFixed(1))}},[G]),ve=je-ne,X=j.width,ae=j.viewportHeight||j.height,he=j.viewportWidth||X,Se=9,re=(s=1)=>{if(!r)return Se*s;const u=Math.min(X,ae);return Math.max(8,Math.min(Se*s,u/(J.length>0?40/s:40)))},de=Math.round(re(r?1.6:2)),Z=c||i==="landscape",le=r?9:7.5,Ce=le+(w?r?2:1.5:0),oe=r?1:.75,Pe=Math.round(de*(le+oe)),me=Math.round(de*(Ce+oe)),W=Pe,ce=w?Math.max(0,me-Pe):0,V=w?me:Pe,He=Math.max(ae-V,de*(r?10:8)),we=V+Math.max(He,0),ot=we+ce,fe={top:r?Math.max(Z?6:12,ae*(Z?.015:.03)):12,right:r?Math.max(Z?35:30,Math.min(X,he)*(Z?.02:.05)):50,bottom:Math.max(0,W-1),left:r?Math.max(Z?45:20,Math.min(X,he)*(Z?.02:.05)):50},Fe=Math.max(0,Math.round(de*4)),ze=we-fe.bottom-Fe,We=s=>{const u=we-fe.top-fe.bottom-Fe;return s==null||ve===0||u<=0?ze:ze-(s-ne)/ve*u},qe=s=>{const u=r&&!(c||i==="landscape")?5:10,d=r&&!(c||i==="landscape")?25:0,I=15,m=r?Math.max(Z?8:18,Math.min(X,he)*(Z?.01:.05)):20,N=fe.right+I,_=X-fe.left-N-u-m*2-d*(J.length-1);if(_<=0)return fe.left+u+m+d*s;const L=J.length>1?J.length-1:1;return L===0||J.length===0?fe.left+u+m+d*s:fe.left+u+m+s*(_/(J.length===1?1:L))+d*s},Ke=(s,u,d)=>{if(!s){v();return}const I=y.current.getBoundingClientRect();let m,N;if(d.type.startsWith("touch")){const t=d.changedTouches[0];m=t.clientX,N=t.clientY}else m=d.clientX,N=d.clientY;const _=qe(u),L=s.displayTemperature??s.temperature_chart??null,z=We(L);k({svgX:_,svgY:z,clientX:m-I.left+y.current.scrollLeft,clientY:N-I.top+y.current.scrollTop}),M(u),o(s)};C.useEffect(()=>{const s=u=>{if(S.current&&!S.current.contains(u.target)){const d=y.current?.querySelectorAll("circle, text, rect");let I=!1;if(d){for(let m of d)if(m.contains(u.target)){I=!0;break}}I||v()}};return H&&(document.addEventListener("mousedown",s),document.addEventListener("touchstart",s)),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("touchstart",s)}},[H,v]);const Qe=s=>{h&&s&&(h(f,s),v())};return{chartRef:y,tooltipRef:S,dimensions:{...j,contentHeight:we,scrollableContentHeight:ot,extraScrollableHeight:ce,viewportHeight:ae},activePoint:H,activeIndex:g,tooltipPosition:p,processedData:ie,validDataForLine:G,allDataPoints:J,tempMin:ne,tempMax:je,tempRange:ve,padding:fe,textRowHeight:de,setActivePoint:o,setActiveIndex:M,getY:We,getX:qe,handlePointInteraction:Ke,clearActivePoint:v,handleToggleIgnore:Qe,responsiveFontSize:re,baselineTemp:ye,baselineStartIndex:Q,baselineIndices:Ie,firstHighIndex:pe,ovulationDetails:U,fertilityStart:De,hasTemperatureData:O,hasAnyObservation:be,graphBottomInset:Fe,todayIndex:Y}};export{Jt as C,Xt as a,Ut as b,ft as c,Zt as u};
