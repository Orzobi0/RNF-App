import{r as H,j as a,m as ke,B as tt,V as wt,k as lt,f as Ue,q as pt}from"./index-D1odW1ad.js";import{l as Mt,B as kt}from"./badge-CmDzsC2c.js";import{X as Nt,C as ut,a as dt,P as nt,T as Tt,D as Pt}from"./peak-mode-button-BZ-YtFep.js";import{a as At,c as Ct}from"./computePeakStatuses-BuckH43K.js";const Jt=({point:e,position:n,chartWidth:i,chartHeight:g,onToggleIgnore:f,onEdit:s,onClose:d,onTogglePeak:y,currentPeakIsoDate:v})=>{if(!e)return null;const I=.6,_=200,M=120,k=_*I,D=M*I,O=H.useRef(null),[X,T]=H.useState(D),[P,K]=H.useState(!1);H.useEffect(()=>{O.current&&T(O.current.offsetHeight),K(!1)},[e]);const N=n.clientX>i*.66,te=n.clientY+X>g;let B=N?n.clientX-k-10:n.clientX+10,R=te?n.clientY:n.clientY+10;B+k>i&&(B=i-k-10),R+X>g&&(R=g-X-10),B<10&&(B=10),R<10&&(R=10);const Y=!e.id||String(e.id).startsWith("placeholder-"),j=e.temperature_chart??e.displayTemperature??null,Q=At(e.fertility_symbol),u=e.timestamp||e.isoDate,b=G=>{if(G==null)return null;const pe=String(G).trim();return pe.length?pe:null},h=G=>{if(!G)return null;try{const pe=Ue(G),ee=pe.getTime();return Number.isNaN(ee)?null:lt(pe,"HH:mm")}catch{return null}},x=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const G=e.measurements.filter(Boolean);if(!G.length)return null;const pe=[...G.filter(ee=>ee?.selected),...G.filter(ee=>!ee?.selected)];for(const ee of pe){const we=!!ee?.use_corrected?b(ee?.time_corrected)??b(ee?.time):b(ee?.time);if(we)return we}return null})(),L=(e.use_corrected?[b(e.time_corrected),b(e.time)]:[b(e.time)]).find(Boolean)??h(e.timestamp),E=x??L,W=e.mucus_sensation??e.mucusSensation??"",ae=e.mucus_appearance??e.mucusAppearance??"",Z=e.observations??"",ne=!!(e.had_relations??e.hadRelations),he=Q&&Q.value!=="none",q=j!=null,U=!!(W&&W.trim()||ae&&ae.trim()),Te=!!(Z&&Z.trim()),se=!(q||he||U||Te||ne),oe=e.peakStatus||(e.peak_marker==="peak"?"P":null),ve=oe&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[oe]||null,J=!!(y&&e.isoDate),de=!!v,Se=de&&e.isoDate===v||oe==="P"||e.peak_marker==="peak",ce=Se?"remove":de?"update":"assign",ge=ce==="assign"?"Asignar día pico":ce==="update"?"Actualizar día pico":"Quitar día pico",le=ge,me=async()=>{if(!(!y||P)){K(!0);try{await y(e,!Se),d&&d()}catch(G){console.error("Error toggling peak marker from tooltip:",G)}finally{K(!1)}}},je=()=>{fe()},fe=G=>{s&&(s(e,G),d&&d())},be=(G=>{switch(G){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return a.jsxs(ke.div,{ref:O,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:R,left:B,width:k},children:[a.jsx("div",{className:"origin-top-left",style:{transform:`scale(${I})`,width:_,minHeight:M},children:a.jsxs("div",{className:"relative tooltip-surface--gradient backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden",children:[a.jsx(tt,{variant:"ghost",size:"icon",onClick:d,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-suave rounded-full w-6 h-6 transition-all duration-200",children:a.jsx(Nt,{size:20})}),ne&&a.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:a.jsx(wt,{className:"w-4 h-4 text-fertiliapp-fuerte",fill:"currentColor"})}),a.jsxs("div",{className:"p-2",children:[a.jsxs("div",{className:"mb-2 relative",children:[a.jsx("div",{className:"w-5 h-5 bg-fertiliapp-fuerte rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:a.jsx(ut,{className:"w-2 h-2 text-white",fill:"currentColor"})}),a.jsxs("div",{className:"mb-1 pl-8",children:[a.jsxs("div",{className:"flex items-baseline justify-start gap-2",children:[a.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:u?lt(Ue(u),"dd/MM",{locale:Mt}):"Fecha"}),a.jsxs("span",{className:"text-sm text-fertiliapp-fuerte font-medium whitespace-nowrap",children:["Día ",e.cycleDay||"N/A"]})]}),ve&&a.jsx("div",{className:"mt-1 flex justify-start",children:a.jsx(kt,{className:"bg-tarjeta text-fertiliapp-fuerte border border-fertiliapp-suave px-2 py-0 text-[11px]",children:ve})})]})]}),se?a.jsxs("div",{className:"pt-1 space-y-3",children:[a.jsx(ke.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:a.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(J||s)&&a.jsxs(ke.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[J&&a.jsx(dt,{mode:ce,size:"sm",onClick:me,pending:P,"aria-label":le,title:ge,className:"shrink-0"}),s&&a.jsxs(tt,{onClick:je,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[a.jsx(nt,{className:"h-4 w-4"}),a.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-1",children:[q&&a.jsx(ke.button,{type:"button",onClick:()=>fe("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-temp-suave rounded-2xl p-1 border border-temp focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-temp",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-temp rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Tt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(j).toFixed(2)}),a.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&a.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),E&&a.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:E})]})})]})}),he&&a.jsx(ke.button,{type:"button",onClick:()=>fe("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${be.light} rounded-3xl p-1 ${be.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-6 h-6 ${be.bg} rounded-lg flex items-center justify-center shadow-lg ${be.glow} shadow-lg`,children:a.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:`text-md font-semibold ${be.text}`,children:Q.label})})]})}),a.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[a.jsx(ke.button,{type:"button",onClick:()=>fe("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-sensacion-suave rounded-3xl p-1 border border-sensacion focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-sensacion rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Pt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-sensacion-fuerte",children:W||"-"})})]})}),a.jsx(ke.button,{type:"button",onClick:()=>fe("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-apariencia-suave rounded-3xl p-1 border border-apariencia focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-apariencia rounded-lg flex items-center justify-center shadow-md",children:a.jsx(ut,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-apariencia-fuerte",children:ae||"-"})})]})}),Te&&a.jsx(ke.button,{type:"button",onClick:()=>fe("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-observaciones-suave rounded-3xl p-1 border border-observaciones focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-observaciones rounded-lg flex items-center justify-center shadow-md",children:a.jsx(nt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-sm font-semibold text-observaciones-fuerte",children:Z})})]})})]})]}),(s||f&&!Y&&e.id||J&&!Y)&&a.jsxs(ke.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[J&&!Y&&a.jsx(dt,{mode:ce,size:"sm",onClick:me,pending:P,"aria-label":le,title:ge,className:"shrink-0"}),a.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:s&&a.jsxs(tt,{onClick:je,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[a.jsx(nt,{className:"h-4 w-4 mr-1.5"}),a.jsx("span",{className:"font-medium",children:Y?"Añadir datos":""})]})})]})]})]})]})}),a.jsx("div",{className:"absolute -inset-2 tooltip-glow rounded-3xl blur-xl -z-10"})]})},Dt=({baselineTemp:e,firstHighIndex:n,processedData:i,isValid:g,findPreviousValidIndex:f})=>{if(n==null)return{confirmed:!1};const s=N=>N?.calcTemperature!=null?N.calcTemperature:N?.displayTemperature,d=N=>N?.ignoredForCalc!=null?N.ignoredForCalc:N?.ignored,y=e+.2,v=[],I=[],_=new Set,M=N=>{N==null||_.has(N)||(_.add(N),I.push(N))};let k=0,D=!1,O=null,X=!1;const T=typeof f=="function"?f(n-1):n>0?n-1:null,P=()=>T!=null?[T,...I]:[...I],K=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:P(),highSequenceIndices:[...I]});for(let N=n;N<i.length;N+=1){const B=i[N];if(!B)break;if(d(B))continue;if(!g(B))break;const R=s(B);if(!Number.isFinite(R))break;const Y=R<=e&&R>=e-.05;if(R<e-.05)return M(N),K();if(R>e){if(M(N),v.push({index:N,temp:R}),!D&&v.length===3&&v[2].temp<y&&(X=!0),!D&&v.length===4&&v[2].temp>=y)return{confirmed:!0,confirmationIndex:v[3].index,usedIndices:P(),highSequenceIndices:[...I],rule:"pp-4-high"};if(!D&&X&&v.length===5)return{confirmed:!0,confirmationIndex:v[4].index,usedIndices:P(),highSequenceIndices:[...I],rule:"pp-ex1-5-high"};if(D){if(X=!1,v.length===3&&O==null)if(R>=y)O=N;else return K();if(O!=null&&v.length>=4){const Q=v[v.length-1].index;if(Q!==O)return{confirmed:!0,confirmationIndex:Q,usedIndices:P(),highSequenceIndices:[...I],rule:"pp-ex2-5-high"}}}continue}if(Y){if(k+=1,M(N),k>=2)return K();if(v.length>0&&v.length<3&&!D){D=!0;continue}break}break}return{confirmed:!1,usedIndices:P(),highSequenceIndices:[...I]}},Ve={0:0,1:.4,2:.8,3:1},jt={M:.8,F:1,"M+":1,white:.4},Ft=(e,n=0,i=1)=>!Number.isFinite(e)||e<n?n:e>i?i:e,_t=e=>e?String(e).toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),""):"",ht=e=>_t(e).replace(/\s+/g," ").trim(),gt=(e,n=[])=>{if(!e)return null;let i=null;return n.forEach((g,f)=>{const{patterns:s=[],level:d,descriptor:y,negatedLevel:v,allowedModifiers:I=null,disallowedModifiers:_=null,selectionScore:M,forceSelection:k=!1}=g||{};s.forEach(D=>{if(!D)return;const O=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${D})(?=$|[^a-z0-9])`,"g");let X;for(;(X=O.exec(e))!==null;){const T=X[1]?X[1].trim():null;if(I&&!I.includes(T)||_&&_.includes(T))continue;let P=d;T==="no"?P=v??1:T==="muy"?P=Math.min(3,d+1):(T==="poco"||T==="leve")&&(P=Math.max(0,d-1));const K=M??P+f*.001,N=typeof y=="function"?y({modifier:T}):y;(!i||k||P>i.level||P===i.level&&K>i.selectionScore)&&(i={level:P,baseLevel:d,descriptor:N,modifier:T,selectionScore:K,force:k})}})}),i},Lt=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],Et=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],bt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const i=Math.round(e);if(i>=0&&i<=3)return i}const n=String(e).trim();return/^[0-3]$/.test(n)?Number.parseInt(n,10):null},xt=e=>{const n=bt(e);if(n!=null)return{level:n,reason:`S${n}`,descriptor:`S${n}`,hasInput:!0};const i=e!=null?String(e).trim():"",g=ht(e),f=i.length>0;if(!g)return{level:0,reason:null,descriptor:null,hasInput:f};if(/^s\s*0?$/.test(g))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(g==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const s=gt(g,Lt);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:f}},yt=e=>{const n=bt(e);if(n!=null)return{level:n,reason:`M${n}`,descriptor:`M${n}`,hasInput:!0};const i=e!=null?String(e).trim():"",g=ht(e),f=i.length>0;if(!g)return{level:0,reason:null,descriptor:null,hasInput:f};if(/^m\s*0$/.test(g))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(i))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const s=gt(g,Et);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:f}},Bt=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Rt=({appearance:e,observations:n,fertilitySymbol:i})=>{const g=[e,n,i].map(s=>String(s||"").toUpperCase()),f=s=>{if(!s)return!1;const y=`(?:^|[^\\p{L}\\p{N}])${Bt(s)}(?=$|[^\\p{L}\\p{N}])`,v=new RegExp(y,"u");return g.some(I=>v.test(I))};return f("M+")?"M+":f("M")?"M":f("F")||f("FER")?"F":String(i||"").toLowerCase()==="white"?"white":"none"},zt=e=>{if(e==null)return"";const n=String(e).trim().toUpperCase();return n==="P"||n==="PEAK"?"P":n==="1"||n==="P1"||n==="P+1"?"1":n==="2"||n==="P2"||n==="P+2"?"2":n==="3"||n==="P3"||n==="P+3"?"3":""},Ge=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,$t=(e,n,i)=>{const g=e?.mucusSensation??e?.mucus_sensation,f=e?.mucusAppearance??e?.mucus_appearance,s=e?.fertility_symbol??e?.fertilitySymbol,d=e?.observations??e?.notes,y=e?.peak_marker??e?.peakMarker??null,v=typeof y=="string"?y.trim().toLowerCase()==="peak":!1,I=xt(g),_=yt(f);let M=Ge(I.level),k=Ge(_.level);const D=[];I.reason&&D.push(`S:${I.reason}`),_.reason&&D.push(`M:${_.reason}`);const O=Rt({appearance:f,observations:d,fertilitySymbol:s}),X=O;let T=O;T==="white"&&(k=Math.max(k,1)),T==="M"&&(k=Math.max(k,2)),T==="M+"&&(k=Math.max(k,3)),T==="F"&&(k=Math.max(k,3),M=Math.max(M,3));const P=Ve[M]??0,K=Ve[k]??0,N=Math.max(P,K);T&&T!=="none"&&D.push(`symbol:${T}`);const te=jt[T]??0,B=Ft(Math.max(N,te)),R=n!=null&&Number.isFinite(n)?N>=n+.4-1e-9:!1;R&&D.push("cambioBIP");const Y={hasSensation:!!I.hasInput,hasAppearance:!!_.hasInput,hasSymbol:s!=null&&String(s).trim()!==""&&String(s).trim().toLowerCase()!=="none",hasObservation:d!=null&&String(d).trim()!==""};Y.hasAny=Y.hasSensation||Y.hasAppearance||Y.hasSymbol||Y.hasObservation;const j=zt(e?.normalizedPeakStatus??e?.peakStatus??e?.peak_marker);return{index:i,S:M,M:k,symbolDetected:T,rawSymbol:X,isPeakMarked:v,scoreCore:N,scoreFertil:B,hasChangeBIP:R,reasons:D,entryFlags:Y,descriptors:{sensation:I.descriptor??I.reason??null,appearance:_.descriptor??_.reason??null},normalizedPeakStatus:j}},Ht=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const n=[];for(let f=0;f<Math.min(6,e.length);f+=1){const s=e[f];if(!s||String(s?.fertility_symbol||"").toLowerCase()==="red")continue;const y=xt(s?.mucusSensation??s?.mucus_sensation),v=yt(s?.mucusAppearance??s?.mucus_appearance),I=Ve[Ge(y.level)]??0,_=Ve[Ge(v.level)]??0;n.push(Math.max(I,_))}const i=n.length>0?Math.max(...n):0;return{days:e.map((f,s)=>$t(f,i,s)),bipScore:i}},Ot=e=>{for(let n=0;n<e.length;n+=1){const i=e[n];if(i){if(i.isPeakMarked)return{source:"Interno",day:n+1,reason:"P",kind:"profile"};if(i.symbolDetected==="white"||i.rawSymbol==="white")return{source:"Interno",day:n+1,reason:"white",kind:"profile"};if(i.symbolDetected==="M+"||i.symbolDetected==="F")return{source:"Interno",day:n+1,reason:"M+",kind:"profile"};if(i.symbolDetected==="M")return{source:"Interno",day:n+1,reason:"M",kind:"profile"};if(i.M>=2||i.S>=2)return{source:"Interno",day:n+1,reason:"S/M>=2",kind:"profile"}}}return null},qt=(e,n)=>{const i=e.filter(s=>s&&Number.isFinite(s.day)).map(s=>({...s}));if(i.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:n,usedCandidates:[],notes:["Sin candidatos disponibles"]};const g=[...i].sort((s,d)=>{const y=Number.isFinite(s.day)?s.day:Number.POSITIVE_INFINITY,v=Number.isFinite(d.day)?d.day:Number.POSITIVE_INFINITY;return y-v}),f=Math.min(...g.map(s=>Math.round(s.day)));return{status:f!=null?"ok":"indeterminado",selectedDay:f??null,selectedMode:n,usedCandidates:g,notes:[]}},Wt=({processedData:e=[],config:n={},calculatorCandidates:i=[],context:g={}})=>{const{calculators:f={cpm:!0,t8:!0},postpartum:s=!1,combineMode:d="estandar"}=n||{},v=new Set(["estandar"]).has(d)?d:"estandar",{postPeakStartIndex:I=null,temperatureInfertileStartIndex:_=null,temperatureConfirmationIndex:M=null,temperatureRule:k=null,todayIndex:D=null}=g||{},{days:O,bipScore:X}=Ht(e),T=Array.isArray(O)?O.length:0,P=t=>Number.isInteger(t)&&t>=0&&t<T,K=t=>{const l=t?.peak_marker??t?.peakMarker??null;return typeof l=="string"&&l.trim().toLowerCase()==="peak"},te=(()=>{if(!Array.isArray(e)||e.length===0)return null;for(let t=e.length-1;t>=0;t-=1)if(K(e[t]))return t;return null})(),B=P(te)?te:null,R=[],Y=t=>{!t||!Number.isFinite(t.day)||R.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};Y(Ot(O));const j=[],Q=[];s&&j.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),s||i.forEach(t=>{if(!t)return;const l=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";if(!(l==="CPM"&&f.cpm||l==="T8"&&f.t8))return;const re={...t,source:l,kind:"calculator"};Y(re)});const u=R.map(t=>({...t})),h=qt(R,v);h.ignoredCalculatorCandidates=Q,h.notes=Array.from(new Set([...h.notes??[],...j].filter(Boolean)));const p=t=>{if(!Number.isFinite(t))return null;const l=Math.max(1,Math.round(t));return e.length>0?Math.min(l,e.length):l},x=Number.isFinite(h.selectedDay)?p(h.selectedDay):null;if(x!=null&&x!==h.selectedDay){const t=`El día calculado (${h.selectedDay}) supera la duración del ciclo. Se usa ${x}.`;h.notes=Array.from(new Set([...h.notes??[],t])),h.selectedDay=x}let A=null;x!=null&&x>=1&&(A=x-1);const L=O.length>0?O.length-1:null,E=Number.isInteger(A)&&A>=0?A:null;let W=null;if(E!=null&&L!=null&&L>=E)if(Number.isInteger(I)){const t=Math.max(E,Math.min(I-1,L));W=t>=E?t:E}else if(P(B)){const t=Math.min(L,B+2),l=Math.max(E,t);W=l>=E?l:E}else W=L;const ae=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,Z=t=>Number.isInteger(t)?L==null||L<0?t>=0?t:null:t<0?null:t>L?L:t:null,ne=t=>{if(!Number.isInteger(t)||t<0||t>=e.length)return null;const l=e[t]?.isoDate;if(!l)return null;try{const F=Ue(l);return Number.isNaN(F?.getTime?.())?null:F}catch{return null}},he=t=>{const l=ne(t);if(!l)return null;try{return lt(l,"dd/MM")}catch{return null}};let q=null,U=null;if(P(B)){const t=B+3;P(t)&&(q=t);const l=B+4;P(l)&&(U=l);const F=Z(B),re=ne(F);if(re)for(let Ne=F+1;Ne<e.length;Ne+=1){const Xe=ne(Ne);if(!Xe)continue;const Re=pt(Xe,re);if(q==null&&Re>=3&&(q=Z(Ne)),U==null&&Re>=4&&(U=Z(Ne)),s){if(U!=null)break}else if(q!=null)break}}const Te=Z(M),V=Z(_);let se=Te;if(se==null&&V!=null){const t=Z(V-1);t!=null&&t>=0&&(se=t)}const oe=(s?U:q)??null,De=null,ve=[oe,V].filter(t=>Number.isInteger(t)),J=ve.length>0?Math.min(...ve):null,de=Number.isInteger(oe),ye=Number.isInteger(V),Se=de&&ye?Math.max(oe,V):null;if(E!=null&&L!=null&&L>=E)if(Number.isInteger(J)){const t=Math.max(E,J-1);W=Math.min(t,L)}else W=L;const ce=W??L??null,ge=J,le=s?"P+4":"P+3";let me=null;de&&ye?me=`${le} y T+3`:de?me=le:ye&&(me=k??"Temperatura");const je={estandar:"modo estándar",marcador:"marcador explícito"},fe=h?.selectedMode??v??"estandar",Pe=h?.usedCandidates??[],be=Pe.some(t=>t?.kind==="profile"),G=Pe.some(t=>t?.kind==="calculator"),pe=O.some(t=>t?.entryFlags?.hasAppearance||t?.entryFlags?.hasSensation||t?.symbolDetected&&t.symbolDetected!=="none");let ee=`Fase fértil abierta (${je[fe]??fe}).`;fe==="marcador"?ee="Fase fértil abierta (ajustada por tus marcadores).":be&&pe?ee="Fase fértil abierta (basada en tus observaciones de moco).":G&&!be&&(ee="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const He=de&&ye,we="Infertilidad absoluta postovulatoria",xe=`Ventana cerrada por doble criterio: ${me??"criterio indeterminado"}.`,Oe=Z(B),Fe=he(Oe),Be=he(se),qe="Infertilidad estimada por moco",We=Fe?`Fase de infertilidad alcanzada por determinación de día pico el ${Fe}.`:"Fase de infertilidad alcanzada por determinación de día pico.",Ke="Infertilidad estimada por temperatura",Qe=Be?`Infertilidad estimada por temperatura desde el ${Be}.`:"Infertilidad estimada por temperatura.",r=new Array(O.length).fill(null);let o=null,S=0,c=null;const m={inicio:0,aumento:1,alta:2,muyAlta:3},w=t=>{if(!t)return[];const l=[];if(Number.isFinite(t.M)&&t.M>0){const F=t.descriptors?.appearance;l.push(`M${t.M}${F?` (${F})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const F=t.descriptors?.sensation;l.push(`S${t.S}${F?` (${F})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?l.push("white"):l.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&l.push("cambio BIP"),l},C=["inicio","aumento","alta","muyAlta"];for(let t=0;t<O.length;t+=1){const l=O[t];if(!l){r[t]=null;continue}const F=Number.isInteger(J),re=F?t>=J:!1,Ne=Number.isInteger(Se)?t>=Se:!1,Xe=E!=null&&ce!=null&&t>=E&&(F?t<J:t<=ce)&&!re,Re=Number.isInteger(D)&&D!=null?t>D:!1;if(!Xe){if(S=0,o=null,!(re||ce!=null&&t>ce)||!F){r[t]=null;continue}const Ye=!!l.entryFlags?.hasAny,et=Ye?null:"Sin registro hoy; estimación basada en días adyacentes.";let Ee=null,ze=null,$e=null;if(Ne&&He?(Ee=we,ze=xe,$e="absolute"):de&&t>=oe?(Ee=qe,ze=We,$e="mucus"):ye&&t>=V&&(Ee=Ke,ze=Qe,$e="temperature"),!$e){r[t]=null;continue}r[t]={index:t,state:"infertil",status:$e,title:Ee,header:Ee,body:ze,detail:me,hasRecord:Ye,inherited:!1,note:et,isFertile:!1,phase:"postOvulatory",label:Ee,summaryText:ze,reasonsList:[],reasonsText:"",showFertilityStatus:!Re};continue}const _e=!!l.entryFlags?.hasAny;let Ae=0;l.isPeakMarked||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3||l.M>=3?Ae=3:l.M>=2||l.S>=2||l.symbolDetected==="M"?Ae=2:(l.M>=1||l.S>=1||l.hasChangeBIP)&&(Ae=1),_e?(S=0,o=Ae):S+=1;const It=l.M>=2||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3;let Me=Ae,ie=null;{if(!_e){const Ye=o??Ae,et=Math.floor(S/2);Me=Math.max(0,Ye-et)}const Ze=Math.max(0,Math.min(3,Me));ie=C[Ze]}const ct=w(l),Ce=ct.join("; "),Le=Oe!=null?t-Oe:null,Je=Le!=null?ae(Le):null,vt=_e?null:"Sin registro hoy; estimación basada en días adyacentes.";ie!=="waiting"&&(Le===0||Le===1||Le===2?(ie="muyAlta",Me=Math.max(Me,3)):Le===3?(m[ie]<m.alta&&(ie="alta"),Me=Math.max(Me,2)):c!=null&&t-c<=3&&(m[ie]<m.aumento&&(ie="aumento"),Me=Math.max(Me,1))),(ie==="alta"||ie==="muyAlta"||It)&&(c=t);let Ie,ue;switch(ie){case"waiting":Ie="Fertilidad en espera de confirmación por temperatura",ue=`Final de moco alcanzado (≥${le}). Ventana mantenida hasta confirmación térmica (T+3).`;break;case"aumento":Ie="Aumento de fertilidad",ue=Ce?`Signos en aumento: ${Ce}.`:"Signos en aumento.";break;case"alta":Ie="Fertilidad alta",ue=Ce?`Signos fértiles claros (${Ce}).`:"Signos fértiles claros.";break;case"muyAlta":{Ie="Fertilidad muy alta",ue=`Día de máxima fertilidad${Je?` (${Je})`:""}.`,ue+=Ce?` Signos pico: ${Ce}.`:" Signos pico presentes.";break}default:Ie="Ventana fértil abierta",ue="Hoy sin signos destacables, a la espera de registrar más datos.";break}_e||(ie==="alta"?(Ie="Fertilidad estimada alta",ue=`${ue} Sin datos apuntados este día; se estima en base a días cercanos.`):ie==="muyAlta"?(Ie="Fertilidad estimada muy alta",ue=`${ue} Sin datos apuntados este día; se estima en base a días cercanos.`):(ie==="aumento"||ie==="inicio")&&(Ie="Ventana fértil abierta (sin registro hoy)",ue=`${ue} Sin datos apuntados este día; se estima en base a días cercanos.`));const St={index:t,state:ie,level:ie==="waiting"?Ae:Me,title:Ie,header:ee,body:ue,reasonsList:ct,reasonsText:Ce,hasRecord:_e,inherited:!_e,note:vt,isFertile:!0,phase:"fertile",label:Ie,summaryText:ue,delta:Je,showFertilityStatus:!Re,reasonParts:{symbol:l.symbolDetected??null,appearance:l.descriptors?.appearance??null,sensation:l.descriptors?.sensation??null}};r[t]=St}ce!=null&&(W=ce);let z=null;if(Number.isInteger(D)&&r.length>0){const t=Math.min(Math.max(D,0),r.length-1);let l=null;for(let F=t;F>=0;F-=1){const re=r[F];if(re&&(l||(l=re),re.isFertile)){z=re;break}}!z&&l&&(z=l)}const $={bipScore:X,effectivePeakIndex:B,candidatesBeforeAggregate:u,closureDetail:me,waitingStartIndex:De,pPlus3Index:q,pPlus4Index:U,temperatureConfirmationIndex:se,temperatureInfertileIndex:V,temperatureRule:k??null,mucusInfertileStartIndex:oe,postOvulatoryStartIndex:ge,firstEstimateIndex:J,absoluteStartIndex:Se};return{fertileStartFinalIndex:A,fertileWindow:E!=null&&W!=null?{startIndex:E,endIndex:W,waitingStartIndex:De,closureDetail:me,temperatureConfirmationIndex:se,temperatureInfertileStartIndex:V,mucusInfertileStartIndex:oe,postOvulatoryStartIndex:ge,temperatureRule:k??null}:null,dailyAssessments:r,currentAssessment:z,candidates:u,aggregate:h,debug:$}},mt=e=>{if(!e)return null;try{const n=new Date(e);return Number.isNaN(n.getTime())?null:n}catch{return null}},Xt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const i=e.map(d=>{if(!d?.startDate||!d?.endDate)return null;const y=mt(d.startDate),v=mt(d.endDate);if(!y||!v||v<y)return null;const I=Math.round((v-y)/(1e3*60*60*24))+1;if(!Number.isFinite(I)||I<=0)return null;const _=!!d?.ignoredForAutoCalculations;return{duration:I,ignored:_}}).filter(Boolean).filter(d=>!d.ignored);if(i.length<6)return null;const g=i.reduce((d,y)=>y.duration<d.duration?y:d),f=i.length>=12?20:21,s=g.duration-f;return Number.isFinite(s)?{source:"CPM",day:Math.max(1,Math.round(s)),reason:`ciclo_mas_corto=${g.duration}`,kind:"calculator"}:null},rt=e=>{if(e==null||e==="")return null;const n=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(n)?n:null},Yt=e=>{const n=[e?.temperature_chart,e?.temperature_raw,e?.temperature_corrected];for(const i of n){const g=rt(i);if(g!==null)return g}if(Array.isArray(e?.measurements)){const i=s=>{if(!s)return null;const d=rt(s.temperature),y=rt(s.temperature_corrected);return s.use_corrected&&y!==null?y:d!==null?d:y!==null?y:null},f=e.measurements.find(s=>s&&s.selected&&i(s)!==null)||e.measurements.find(s=>i(s)!==null);if(f){const s=i(f);if(s!==null)return s}}return null},Ut=(e=[],n)=>{if(!Array.isArray(e)||e.length===0||typeof n!="function")return null;const i=[];if(e.forEach(f=>{if(!f?.data||!Array.isArray(f.data)||!f.startDate)return;const s=f.data.filter(k=>k&&k.isoDate).map(k=>({...k,displayTemperature:Yt(k)}));if(s.length===0)return;const{ovulationDetails:d}=n(s);if(!d?.confirmed)return;const y=Number.isInteger(d?.ovulationIndex)?d.ovulationIndex:Number.isInteger(d?.confirmationIndex)?d.confirmationIndex:null;if(y==null||y<0||y>=s.length)return;const v=s[y],I=Number(v?.cycleDay);if(!Number.isFinite(I)||I<=0)return;const _=Math.max(1,Math.round(I-8)),M={riseDay:I,t8Day:_,ignored:!!f?.ignoredForAutoCalculations};!M.ignored&&i.length<12&&i.push(M)}),i.length<6)return null;const g=i.reduce((f,s)=>s.t8Day<f.t8Day?s:f);return{source:"T8",day:Math.max(1,Math.round(g.t8Day)),reason:`t8=${g.t8Day}`,kind:"calculator"}},st={calculators:{cpm:!0,t8:!0},combineMode:"estandar"},it=36.1,at=37.5,ft=(e=[],n={})=>{const{postpartum:i=!1}=n,g=u=>u?.calcTemperature!=null?u.calcTemperature:u?.displayTemperature,f=u=>u?.ignoredForCalc!=null?u.ignoredForCalc:u?.ignored,s=u=>u&&g(u)!=null&&!f(u),d=u=>s(u)&&Number.isFinite(g(u)),y=6,v=.05,I=!1,_=(u,b=d)=>{if(!Number.isInteger(u))return null;for(let h=u;h>=0;h-=1){const p=e[h];if(b(p))return h}return null},M=(u,b=d)=>{if(!Array.isArray(u)||u.length===0)return[];const h=new Set,p=[];return u.forEach(x=>{const A=Number(x);if(!Number.isInteger(A)||A<0||A>=e.length||h.has(A))return;const L=e[A];b(L)&&(h.add(A),p.push(A))}),p},k=u=>{if(!u||u.length!==y)return null;const b=u.map(x=>x.temp);if(b.some(x=>!Number.isFinite(x)))return null;const h=b.reduce((x,A)=>A>x?A:x,b[0]),p=b.reduce((x,A)=>A>=h-v&&A<h?x+1:x,0);return p>=2?null:{baselineTemp:h,baselineStartIndex:u[0].index,baselineIndices:u.map(x=>x.index),baselineBorderlineCount:p}},D=u=>{const b=[];for(let h=u;h<e.length;h+=1){const p=e[h];if(!s(p))continue;const x=g(p);if(Number.isFinite(x)&&(b.push({index:h,temp:x}),b.length>y&&b.shift(),b.length===y)){const A=k(b);if(!A)continue;let L=null;for(let E=h+1;E<e.length;E+=1){const W=e[E];if(!s(W))continue;const ae=g(W);if(Number.isFinite(ae)&&ae>A.baselineTemp){L=E;break}}return{baselineTemp:A.baselineTemp,baselineStartIndex:A.baselineStartIndex,baselineIndices:A.baselineIndices,baselineBorderlineCount:A.baselineBorderlineCount,firstHighIndex:L}}}return null},O={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let X=null,T=null,P=null,K=[],N=O,te=0;const B=({baselineTemp:u,firstHighIndex:b})=>{if(b==null)return{confirmed:!1};const h=u+.2,p=[],x=[],A=new Set,L=q=>{q==null||A.has(q)||(A.add(q),x.push(q))};let E=!1,W=0,ae=!1;const Z=_(b-1),ne=()=>Z!=null?[Z,...x]:[...x],he=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:ne(),highSequenceIndices:[...x]});for(let q=b;q<e.length;q++){const U=e[q];if(!U)break;if(f(U))continue;const V=g(U);if(!Number.isFinite(V))break;if(V>u){if(L(q),p.push({index:q,temp:V}),E){if(p.length===3)return V>=h?{confirmed:!0,confirmationIndex:q,usedIndices:ne(),highSequenceIndices:[...x],rule:"german-2nd-exception"}:he();continue}if(p.length===3&&p[2].temp>=h)return{confirmed:!0,confirmationIndex:p[2].index,usedIndices:ne(),highSequenceIndices:[...x],rule:"3-high"};if(p.length===4&&p[2].temp<h&&p[3].temp>u)return{confirmed:!0,confirmationIndex:p[3].index,usedIndices:ne(),highSequenceIndices:[...x],rule:"german-3+1"};if(p.length===5&&p[3].temp>u&&p[4].temp>=h)return{confirmed:!0,confirmationIndex:p[4].index,usedIndices:ne(),highSequenceIndices:[...x],rule:"5-high"};continue}if(V<=u&&V>=u-.05&&p.length>0&&p.length<3){if(W+=1,L(q),W>=2)return he();E=!0;continue}if(!ae&&!E&&p.length>0&&p.length<3){ae=!0,L(q);continue}break}return{confirmed:!1,usedIndices:ne(),highSequenceIndices:[...x]}};for(;te<e.length;){const u=D(te);if(!u)break;if(X=u.baselineTemp,T=u.baselineStartIndex,K=Array.isArray(u.baselineIndices)?[...u.baselineIndices]:[],P=u.firstHighIndex,u.baselineBorderlineCount,P==null){te=T+1;continue}const b=i?Dt({...u,processedData:e,isValid:s,findPreviousValidIndex:_}):B(u);if(b?.requireRebaseline){te=T+1;continue}if(b?.confirmed){const h=b.highSequenceIndices?.length?b.highSequenceIndices[0]:null,p=Number.isInteger(b.confirmationIndex)?Math.max(0,Math.min(b.confirmationIndex,e.length-1)):null;let x=null;p!=null&&(x=Math.max(0,Math.min(p,e.length-1))),N={confirmed:!0,confirmationIndex:p,infertileStartIndex:x,rule:b.rule,highSequenceIndices:b.highSequenceIndices??b.usedIndices,usedIndices:b.usedIndices,ovulationIndex:P??h??null};break}te=T+1}const R=M(K),Y=M(N?.highSequenceIndices),j=M(N?.usedIndices),Q={...N,highSequenceIndices:Y,usedIndices:j};if(I){const u=h=>{const p=e[h];return p?{index:h,isoDate:p.isoDate,displayTemperature:p.displayTemperature,calcTemperature:g(p),ignored:p.ignored,ignoredForCalc:f(p),use_corrected:p.use_corrected,temperature_raw:p.temperature_raw??null,temperature_corrected:p.temperature_corrected??null,temperature_chart:p.temperature_chart??null}:null},b=(h,p)=>{console.groupCollapsed(`${h} (${p.length})`),p.forEach(x=>console.log(u(x))),console.groupEnd()};console.groupCollapsed("[fertility] Ovulation metrics debug"),console.log("baselineTemp",X),console.log("baselineIndices",R),console.log("firstHighIndex",P),console.log("ovulationDetails",{rule:Q?.rule,confirmationIndex:Q?.confirmationIndex,highSequenceIndices:Y,usedIndices:j}),b("baselineIndices",R),b("highSequenceIndices",Y),b("usedIndices",j),console.groupEnd()}return{baselineTemp:X,baselineStartIndex:T,firstHighIndex:P,baselineIndices:R,ovulationDetails:Q}},Zt=(e,n,i,g,f,s=5,d=!1,y=null,v=[],I=null,_=!1)=>{const M=H.useRef(null),k=H.useRef(null),[D,O]=H.useState({width:0,height:0,viewportWidth:0,viewportHeight:0}),[X,T]=H.useState(null),[P,K]=H.useState({x:0,y:0}),[N,te]=H.useState(null),B=H.useCallback(()=>{T(null),te(null)},[]),R=r=>{if(r==null)return"";const o=String(r).trim().toUpperCase();return o==="P"||o==="PEAK"?"P":o==="1"||o==="P1"||o==="P+1"?"1":o==="2"||o==="P2"||o==="P+2"?"2":o==="3"||o==="P3"||o==="P+3"?"3":""},Y=H.useMemo(()=>Ct(e),[e]),j=H.useMemo(()=>{const r=c=>{if(c==null||c==="")return null;const m=parseFloat(String(c).replace(",","."));return Number.isFinite(m)?m:null},o=c=>{if(!c)return null;const m=r(c.temperature),w=r(c.temperature_corrected);return c.use_corrected&&w!==null?w:m!==null?m:w!==null?w:null},S=c=>{if(!c)return null;const m=r(c.temperature_chart),w=r(c.temperature_raw),C=r(c.temperature_corrected);if(c.use_corrected&&C!==null)return C;if(m!==null)return m;if(w!==null)return w;if(C!==null)return C;if(Array.isArray(c.measurements)){const $=c.measurements.find(t=>t&&t.selected&&o(t)!==null)||c.measurements.find(t=>o(t)!==null);if($)return o($)}return null};return e.map(c=>{const m=S(c),w=Array.isArray(c?.measurements)?c.measurements.some(re=>re?.ignored):!1,C=c?.isoDate,z=c?.peak_marker??c?.peakStatus??null,$=C?Y[C]??z:z,t=R($),l=r(m),F=!!(c?.ignored||w);return{...c,displayTemperature:l,calcTemperature:F?null:l,ignoredForCalc:F,peakStatus:$??null,normalizedPeakStatus:t}})},[e,Y]),Q=H.useMemo(()=>{if(!Array.isArray(j)||j.length===0)return null;const r=new Date;let o=null;return j.forEach((S,c)=>{if(S?.isoDate)try{const m=Ue(S.isoDate);if(Number.isNaN(m?.getTime?.()))return;pt(m,r)<=0&&(o=c)}catch{}}),o},[j]);H.useLayoutEffect(()=>{const r=()=>{if(!M.current)return;const S=M.current.parentElement||M.current;let c=S.clientWidth||600,m=S.clientHeight||400,w=M.current.clientWidth>0?M.current.clientWidth:c,C,z,$,t;if(n){let l=window.innerWidth,F=window.innerHeight;if(d&&F>l&&([l,F]=[F,l]),w=l,$=l,t=F,i==="portrait"&&!d){const re=Math.max(30,l*.05);C=(l-re)/s*e.length}else C=l/s*e.length;z=F}else C=w/s*e.length,z=m,$=w,t=m;O({width:C,height:z,viewportWidth:$,viewportHeight:t})};r(),window.addEventListener("resize",r);let o;if(M.current){const S=M.current.parentElement||M.current;o=new ResizeObserver(r),o.observe(S)}return()=>{window.removeEventListener("resize",r),o&&o.disconnect()}},[n,e.length,s,i,d]);const u=H.useMemo(()=>j.filter(r=>r&&r.isoDate&&!r.ignored&&r.displayTemperature!==null&&r.displayTemperature!==void 0),[j]),b=H.useMemo(()=>j.filter(r=>r&&r.isoDate),[j]),h=u.length>0,p=H.useMemo(()=>!Array.isArray(j)||j.length===0?!1:j.some(r=>r?r.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(w=>{const C=r?.[w];return C!=null&&String(C).trim()!==""})||(()=>{const w=r?.fertility_symbol??r?.fertilitySymbol;return w==null?!1:String(w).trim()!==""})()||(()=>{const w=r?.observations??r?.notes;return w==null?!1:String(w).trim()!==""})()?!0:R(r?.normalizedPeakStatus??r?.peakStatus??r?.peak_marker)!=="":!1),[j]),x=H.useMemo(()=>{const r=y??{},o=(C,z)=>typeof C=="boolean"?C:z,S={cpm:o(r?.calculators?.cpm,st.calculators.cpm),t8:o(r?.calculators?.t8,st.calculators.t8)},m=new Set(["estandar"]).has(r?.combineMode)?r.combineMode:st.combineMode,w=!!r?.postpartum;return{calculators:S,combineMode:m,postpartum:w}},[y]),A=H.useMemo(()=>{if(Array.isArray(I)&&I.length>0)return I.map(c=>{if(!c)return null;const{source:m,day:w,reason:C}=c,z=typeof m=="string"?m.toUpperCase().replace(/-/g,""):"";if(z!=="CPM"&&z!=="T8")return null;const $=Number(w);return Number.isFinite($)?{source:z,originalSource:m??z,day:$,reason:typeof C=="string"?C:"",kind:"calculator"}:null}).filter(Boolean);const r=Array.isArray(v)?v:[];if(!r.length)return[];const o=Xt(r),S=Ut(r,ft);return[o,S].filter(Boolean)},[I,v]),{peakDayIndex:L,thirdDayIndex:E,peakInfertilityStartIndex:W}=H.useMemo(()=>{if(!b.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const r=b.map(c=>c?.normalizedPeakStatus??R(c?.peakStatus??c?.peak_marker));let o=null,S=null;if(r.forEach((c,m)=>{c==="P"&&o==null&&(o=m),c==="3"&&S==null&&(S=m)}),o==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(S!=null){const c=b.length-1,m=Math.min(S+1,c);return{peakDayIndex:o,thirdDayIndex:S,peakInfertilityStartIndex:m}}return{peakDayIndex:o,thirdDayIndex:null,peakInfertilityStartIndex:null}},[b]),{baselineTemp:ae,baselineStartIndex:Z,firstHighIndex:ne,baselineIndices:he,ovulationDetails:q}=H.useMemo(()=>ft(j,{postpartum:x.postpartum}),[j,x.postpartum]),U=H.useMemo(()=>({...q??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:ae,baselineIndices:he,baselineStartIndex:Z,firstHighIndex:ne,peakDayIndex:L,peakInfertilityStartIndex:W,thirdDayIndex:E}),[q,ae,he,Z,ne,L,W,E]),Te=H.useMemo(()=>Wt({processedData:j,config:x,calculatorCandidates:A,context:{postPeakStartIndex:W,peakThirdDayIndex:U?.thirdDayIndex??null,temperatureInfertileStartIndex:U?.infertileStartIndex??null,temperatureConfirmationIndex:U?.confirmationIndex??null,temperatureRule:U?.rule??null,todayIndex:Q}}),[j,x,A,U?.thirdDayIndex,U?.infertileStartIndex,U?.confirmationIndex,U?.rule,L,W,Q]),V=H.useMemo(()=>j.map((r,o)=>{if(!r)return r;const S=Number.isInteger(Q)?o>Q:!1;return{...r,isFutureDay:S}}),[j,Q]),se=H.useMemo(()=>V.filter(r=>r&&r.isoDate),[V]),{tempMin:oe,tempMax:De}=H.useMemo(()=>{const r=u.map($=>$.displayTemperature).filter($=>$!=null);if(r.length===0)return{tempMin:it,tempMax:at};const o=at-it,S=Math.min(...r),c=Math.max(...r);let m=Math.min(S,it),w=Math.max(c,at);const C=$=>Math.floor($*10)/10,z=$=>Math.ceil($*10)/10;if(m=C(m),w=z(w),w-m<o){const $=(m+w)/2;m=C($-o/2),w=z($+o/2)}return Math.abs(m-S)<1e-9&&(m=C(m-.1)),Math.abs(w-c)<1e-9&&(w=z(w+.1)),{tempMin:parseFloat(m.toFixed(1)),tempMax:parseFloat(w.toFixed(1))}},[u]),ve=De-oe,J=D.width,de=D.viewportHeight||D.height,ye=D.viewportWidth||J,Se=9,ce=(r=1)=>{if(!n)return Se*r;const o=Math.min(J,de);return Math.max(8,Math.min(Se*r,o/(se.length>0?40/r:40)))},ge=Math.round(ce(n?1.6:2)),le=d||i==="landscape",me=n?9:7.5,je=me+(_?n?2:1.5:0),fe=n?1:.75,Pe=Math.round(ge*(me+fe)),be=Math.round(ge*(je+fe)),G=Pe,pe=_?Math.max(0,be-Pe):0,ee=_?be:Pe,He=Math.max(de-ee,ge*(n?10:8)),we=ee+Math.max(He,0),ot=we+pe,xe={top:n?Math.max(le?6:12,de*(le?.015:.03)):12,right:n?Math.max(le?35:30,Math.min(J,ye)*(le?.02:.05)):50,bottom:Math.max(0,G-1),left:n?Math.max(le?45:20,Math.min(J,ye)*(le?.02:.05)):50},Fe=Math.max(0,Math.round(ge*4)),Be=we-xe.bottom-Fe,qe=r=>{const o=we-xe.top-xe.bottom-Fe;return r==null||ve===0||o<=0?Be:Be-(r-oe)/ve*o},We=r=>{const o=n&&!(d||i==="landscape")?5:10,S=n&&!(d||i==="landscape")?25:0,c=15,m=n?Math.max(le?8:18,Math.min(J,ye)*(le?.01:.05)):20,w=xe.right+c,C=J-xe.left-w-o-m*2-S*(se.length-1);if(C<=0)return xe.left+o+m+S*r;const z=se.length>1?se.length-1:1;return z===0||se.length===0?xe.left+o+m+S*r:xe.left+o+m+r*(C/(se.length===1?1:z))+S*r},Ke=(r,o,S)=>{if(!r){B();return}const c=M.current.getBoundingClientRect();let m,w;if(S.type.startsWith("touch")){const t=S.changedTouches[0];m=t.clientX,w=t.clientY}else m=S.clientX,w=S.clientY;const C=We(o),z=r.displayTemperature??r.temperature_chart??null,$=qe(z);K({svgX:C,svgY:$,clientX:m-c.left+M.current.scrollLeft,clientY:w-c.top+M.current.scrollTop}),te(o),T(r)};H.useEffect(()=>{const r=o=>{if(k.current&&!k.current.contains(o.target)){const S=M.current?.querySelectorAll("circle, text, rect");let c=!1;if(S){for(let m of S)if(m.contains(o.target)){c=!0;break}}c||B()}};return X&&(document.addEventListener("mousedown",r),document.addEventListener("touchstart",r)),()=>{document.removeEventListener("mousedown",r),document.removeEventListener("touchstart",r)}},[X,B]);const Qe=r=>{g&&r&&(g(f,r),B())};return{chartRef:M,tooltipRef:k,dimensions:{...D,contentHeight:we,scrollableContentHeight:ot,extraScrollableHeight:pe,viewportHeight:de},activePoint:X,activeIndex:N,tooltipPosition:P,processedData:V,validDataForLine:u,allDataPoints:se,tempMin:oe,tempMax:De,tempRange:ve,padding:xe,textRowHeight:ge,setActivePoint:T,setActiveIndex:te,getY:qe,getX:We,handlePointInteraction:Ke,clearActivePoint:B,handleToggleIgnore:Qe,responsiveFontSize:ce,baselineTemp:ae,baselineStartIndex:Z,baselineIndices:he,firstHighIndex:ne,ovulationDetails:U,fertilityStart:Te,hasTemperatureData:h,hasAnyObservation:p,graphBottomInset:Fe,todayIndex:Q}};export{Jt as C,Xt as a,Ut as b,ft as c,Zt as u};
