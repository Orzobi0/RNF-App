import{c as qt,r as n,g as y,f as d,j as s,H as D,B as be,O as Aa,b as Ta,S as C,l as W,V as Ia,Q as Bt,n as Fa,m as xe}from"./index-C041RoKp.js";import{L as st,T as La,P as Oa,N as Pa,C as za}from"./NewCycleDialog-pYL8DOtB.js";import{T as Ba,j as Ha,h as Va,e as Ua,c as Xa,F as Ht,m as Vt,k as ge,i as Ae,l as $a,A as qa,n as Wa,D as Ya}from"./computePeakStatuses-Dl9gvYQS.js";import{l as nt,P as Ga}from"./badge-BbO7fxzd.js";import{D as Ka}from"./DeletionDialog-BtycWigc.js";import{u as Qa,D as Za,a as Ja}from"./useCycleData-fUMApAkg.js";import"./OverlapWarningDialog-CRNazV6l.js";import"./input-D9upNPQ0.js";import"./label-DmhTYPl7.js";import"./checkbox-DTslPdqR.js";import"./eye-fkTjB7nE.js";const ot=qt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),es=qt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),ts=({isoDate:f,cycleDay:S,details:c,peakStatus:Y,isPeakDay:ie,onEdit:p,onDelete:ce,onAdd:L,onToggleRelations:we,isProcessing:N})=>{const Te=!!c?.record,De=n.useMemo(()=>{if(!f)return null;try{return y(d(f),"dd/MM/yyyy",{locale:nt})}catch{return null}},[f]),de=c?.symbolInfo?.label||"Sin símbolo",Ie=c?.symbolInfo?.value||"none",Fe=c?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",ve=()=>{!c?.record||!p||p(c.record,null)},G=()=>{!c?.record?.id||!ce||ce(c.record.id)},Le=()=>{!f||!L||L(f)},M=(v,R=null)=>{if(c?.record&&p){p(c.record,v,R);return}f&&L&&L(f,v,R)},Oe=()=>{!f||!we||we(f)},O=(v,R={})=>v&&typeof v=="string"&&v.trim().length>0||typeof v=="number"?v:R.placeholder||"—",Pe=c?.hasTemperature?`${c.displayTemp} °C`:"—",ze=c?.timeValue||"—",Be=!!c?.timeValue,He=c?.hasMucusSensation?c.mucusSensation:"—",Ve=c?.hasMucusAppearance?c.mucusAppearance:"—",Ce=c?.observationsText?.trim(),K=!!c?.hasRelations;let Q=null,ue=null;Y&&(Y==="P"||ie?(Q="Día pico",ue="peak"):(Q=`+${Y}`,ue="post-peak"));const Ue=()=>{switch(Ie){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!f)return s.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const r="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return s.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[De,S?` · D${S}`:""]}),Q&&s.jsx("span",{className:D("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:Q})]}),s.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[s.jsx("button",{type:"button",onClick:()=>M("symbol","fertilitySymbol"),className:D("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ue(),Fe),title:de,"aria-label":de}),Te?s.jsxs(s.Fragment,{children:[s.jsxs(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:ve,disabled:N,children:[N?s.jsx(st,{className:"h-4 w-4 animate-spin"}):s.jsx(es,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Editar registro"})]}),s.jsxs(be,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:G,disabled:N,children:[N?s.jsx(st,{className:"h-4 w-4 animate-spin"}):s.jsx(La,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):s.jsxs(be,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:Le,disabled:N,children:[N&&s.jsx(st,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),s.jsxs("div",{className:"mt-4 space-y-3",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>M("temperature","temperature"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",c?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[s.jsx(Ba,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"font-semibold",children:O(Pe)}),c?.showCorrectedIndicator&&s.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),s.jsxs("button",{type:"button",onClick:()=>M("temperature","time"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Be?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[s.jsx(Ha,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:O(ze)})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>M("sensation","mucusSensation"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",c?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[s.jsx(Va,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:O(He)})]}),s.jsxs("button",{type:"button",onClick:()=>M("appearance","mucusAppearance"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",c?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[s.jsx(Ua,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:O(Ve)})]})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>M("observations","observations"),className:D(r,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ce?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[s.jsx(ot,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"truncate",children:O(Ce,{placeholder:"-"})})]}),s.jsx("button",{type:"button",onClick:Oe,disabled:N,className:D("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",K?"border-rose-500 bg-rose-50":"border-slate-200 bg-white",N&&"opacity-70 cursor-not-allowed"),title:K?"Hubo relaciones":"Sin relaciones","aria-label":K?"Hubo relaciones":"Sin relaciones",children:s.jsx(Aa,{className:D("h-4 shrink-0 w-4",K?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},as=f=>Ht.find(S=>S.value===f)||Ht[0],Ut=10,rt=60,Xt=400,$t=120,ss=85,rs=5,ye=10,ns=f=>{if(f==null||f==="")return null;const S=Number(typeof f=="string"?f.replace(",","."):f);return Number.isFinite(S)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(S):null},os=({cycle:f,headerTitle:S,headerIcon:c=ot,headerActions:Y,topAccessory:ie,includeEndDate:p=!1,addOrUpdateDataPoint:ce,deleteRecord:L,isLoading:we,updateCycleDates:N,checkCycleOverlap:Te,forceShiftNextCycleStart:De,forceUpdateCycleStart:de,startNewCycle:Ie,refreshData:Fe,afterRecordsContent:ve=null,onRequestDeleteCycle:G=null,dateEditorDeleteTitle:Le="Eliminar ciclo",dateEditorDeleteDescription:M="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:Oe="Eliminar ciclo",isDeletingCycle:O=!1}={})=>{const{currentCycle:Pe,addOrUpdateDataPoint:ze,deleteRecord:Be,isLoading:He,updateCycleDates:Ve,checkCycleOverlap:Ce,forceUpdateCycleStart:K,forceShiftNextCycleStart:Q,startNewCycle:ue,refreshData:Ue}=Qa(),r=f??Pe,v=we??He,R=ce||(async(e,t)=>{if(r?.id)return ze(e,t,r.id)}),Wt=L||(async e=>{if(r?.id)return Be(e,r.id)}),Se=N||(async(e,t,a)=>Ve(e??r?.id,t,a)),Xe=Te??Ce,lt=de||(async(e,t)=>K(e??r?.id,t)),$e=De||(async(e,t,a)=>Q(e??r?.id,t,a)),Yt=Ie??ue,Ne=Fe??Ue,{toast:j}=Ta(),[Gt,P]=n.useState(!1),[qe,Z]=n.useState(null),[J,We]=n.useState(null),[ee,te]=n.useState(!1),[Kt,it]=n.useState(!1),[z,je]=n.useState(()=>r?.startDate||""),[B,ke]=n.useState(()=>r?.endDate||""),[Qt,A]=n.useState(""),[T,ct]=n.useState(null),[Ye,dt]=n.useState(null),[Ge,ut]=n.useState(!1),[Zt,mt]=n.useState(null),[Jt,Ke]=n.useState(!1),[Qe,me]=n.useState(!1),[m,H]=n.useState(null),[ea,V]=n.useState(null),[ta,fe]=n.useState(null),[aa,ae]=n.useState(null),[sa,Ze]=n.useState(!1),ft=n.useMemo(()=>{if(!r?.startDate)return null;const e=d(r.startDate);if(!C(e))return null;const t=y(e,"dd/MM/yyyy");let a="En curso";if(r?.endDate){const o=d(r.endDate);C(o)&&(a=y(o,"dd/MM/yyyy"))}return`${t} - ${a}`},[r?.endDate,r?.startDate]),ra=n.useMemo(()=>S||(r?.type==="current"||!r?.endDate?"Ciclo actual":ft??"Mis registros"),[r?.endDate,r?.type,ft,S]),pt=!0,Ee=n.useRef(null),ht=n.useRef(null),xt=n.useRef(0),[gt,yt]=n.useState(0),_e=n.useCallback(()=>{const e=Ee.current;if(!e){xt.current=0,yt(0);return}const a=e.getBoundingClientRect().height;xt.current=a,yt(o=>Math.abs(o-a)>.5?a:o)},[]);n.useLayoutEffect(()=>{let e=window.requestAnimationFrame(_e);const t=()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)};window.addEventListener("resize",t);let a;return typeof ResizeObserver<"u"&&(a=new ResizeObserver(()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)}),Ee.current&&a.observe(Ee.current)),()=>{window.removeEventListener("resize",t),a&&a.disconnect(),e&&window.cancelAnimationFrame(e)}},[_e]);const bt=n.useMemo(()=>Math.max(Math.round(gt+Ut),Ut),[gt]);n.useEffect(()=>{je(r?.startDate||""),ke(r?.endDate||"")},[r?.startDate,r?.endDate]);const se=n.useMemo(()=>r?.data?.length?[...r.data].filter(e=>e?.isoDate).sort((e,t)=>{const a=d(e.isoDate);return d(t.isoDate)-a}).map(e=>e.isoDate):[],[r?.data]);n.useEffect(()=>{const e=ht.current;e&&e.scrollTo({top:0,behavior:"auto"})},[]);const re=n.useMemo(()=>r?.data?.length?r.data.map(e=>{if(!e?.isoDate)return null;const t=d(e.isoDate);return C(t)?t:null}).filter(Boolean):[],[r?.data]),wt=n.useMemo(()=>new Set(se),[se]),Je=n.useMemo(()=>Xa(r?.data??[]),[r?.data]),ne=n.useMemo(()=>{const e=new Map;return r?.data?.length&&r.data.forEach(t=>{if(!t?.isoDate)return;const a=t.measurements?.find(Ra=>Ra?.selected)||(t.temperature_chart||t.temperature_raw?{temperature:t.temperature_chart??t.temperature_raw,temperature_corrected:t.temperature_corrected??null,time:t.timestamp?y(d(t.timestamp),"HH:mm"):null,use_corrected:t.use_corrected??!1}:null),o=a?.use_corrected??t.use_corrected??!1,l=a?.temperature_corrected??t.temperature_corrected??null,i=a?.temperature??t.temperature_chart??t.temperature_raw??null,u=ns(o&&l!==null&&l!==void 0&&l!==""?l:i??l),x=u!==null,g=o&&l!==null&&l!==void 0&&l!=="";let w=null;a?.time?w=a.time:t.timestamp&&C(d(t.timestamp))&&(w=y(d(t.timestamp),"HH:mm"));const _=t.mucusSensation??t.mucus_sensation??"",le=t.mucusAppearance??t.mucus_appearance??"",$=!!_,q=!!le,Re=$||q,he=t.observations||"",ka=!!he,Ea=!!(t.had_relations??t.hadRelations??!1),zt=Je[t.isoDate]||null,_a=t.peak_marker==="peak"||zt==="P",Ma=as(t.fertility_symbol);e.set(t.isoDate,{record:t,symbolInfo:Ma,hasTemperature:x,displayTemp:u,showCorrectedIndicator:g,timeValue:w,hasMucus:Re,hasMucusSensation:$,hasMucusAppearance:q,mucusSensation:_,mucusAppearance:le,hasObservations:ka,observationsText:he,hasRelations:Ea,peakStatus:zt,isPeakDay:_a})}),e},[r?.data,Je]),h=n.useMemo(()=>{if(!r?.startDate)return null;const e=d(r.startDate);if(!C(e))return null;let t;if(r?.endDate)t=d(r.endDate);else{const a=W(new Date),o=[e,a];re.length&&o.push(Vt(re)),t=Vt(o)}return C(t)?{from:e,to:t}:{from:e,to:e}},[r?.startDate,r?.endDate,re]),na=n.useMemo(()=>{const e={};return h&&(e.outsideCycle=t=>ge(t,h.from)||Ae(t,h.to),e.insideCycleNoRecord=t=>{if(ge(t,h.from)||Ae(t,h.to))return!1;const a=y(t,"yyyy-MM-dd");return!wt.has(a)}),re.length&&(e.hasRecord=re),e},[h,re,wt]),oa=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:D(Ia({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[Dt,et]=n.useState(()=>m&&C(d(m))?d(m):h?.to?h.to:W(new Date)),pe=n.useRef(!1),k=n.useRef(null),la=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),U=n.useRef(null),vt=n.useRef(null),Ct=n.useRef(null),St=n.useRef(0),[ia,ca]=n.useState(0),[Nt,jt]=n.useState(!1),I=n.useCallback(e=>{St.current=e,ca(e)},[]),kt=n.useCallback(()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(e)})}),[]),oe=n.useCallback((e,{duration:t=ye}={})=>{k.current&&(cancelAnimationFrame(k.current),k.current=null);const a=St.current,o=e-a;return Math.abs(o)<.5||t<=0?(I(e),Promise.resolve()):new Promise(l=>{const i=x=>1-Math.pow(1-x,3),b=performance.now(),u=x=>{const g=x-b,w=Math.min(1,g/t),_=a+o*i(w);if(I(_),w<1){k.current=requestAnimationFrame(u);return}k.current=null,l()};k.current=requestAnimationFrame(u)})},[I]),da=n.useMemo(()=>({labelDay:e=>{const t=y(e,"yyyy-MM-dd"),a=ne.get(t),o=y(e,"d MMM",{locale:nt});if(!a)return o;const l=[];if(a.hasTemperature&&a.hasMucus?l.push("temperatura y moco"):a.hasTemperature?l.push("temperatura"):a.hasMucus&&l.push("moco"),a.hasRelations&&l.push("RS"),a.peakStatus){const i=a.peakStatus==="P"?"pico ✖":`pico +${a.peakStatus}`;l.push(i)}return l.length?`${o}: ${l.join("; ")}`:o}}),[ne]),ua=n.useCallback(({date:e,activeModifiers:t})=>{const a=y(e,"yyyy-MM-dd"),o=ne.get(a),l=o?.hasTemperature??!1,i=o?.hasMucus??!1;o?.hasRelations;const b=o?.peakStatus??null,u=o?.symbolInfo,x=u?.value,g=t.selected,w=t.today,_=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",l?"bg-amber-500":"bg-transparent",l&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),le=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",i?"bg-teal-500":"bg-transparent",i&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),$=!!(x&&x!=="none"),q=D("relative z-10 text-[1.15rem] leading-none",t.outside||t.outsideCycle?"text-slate-300":g?$?"text-white":"text-fertiliapp-fuerte":w?"text-subtitulo font-semibold":"text-slate-700"),Re=b==="P"?"✖":b?`+${b}`:null,he=$?D("pointer-events-none absolute inset-0 rounded-full transition-opacity",u?.color??"",u?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",x==="white"?"ring-1 ring-slate-300/70":"",g?"opacity-50":"opacity-25"):null;return s.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[s.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[w&&!g&&!(t.outside||t.outsideCycle)&&s.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),g&&s.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full bg-tarjeta border border-fertiliapp-fuerte"}),he&&s.jsx("span",{className:he,"aria-hidden":"true"}),s.jsx("span",{className:q,children:y(e,"d")})]}),s.jsxs("div",{className:"mt-[0.35rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[s.jsx("span",{className:_}),s.jsx("span",{className:le})]}),Re&&s.jsx("span",{"aria-hidden":"true",className:D("pointer-events-none absolute -top-[1px] right-[1px] rounded-sm px-[2px] text-[0.55rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",g?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:Re})]})},[ne]),F=n.useMemo(()=>{if(!r?.startDate)return[];const e=d(r.startDate);if(!C(e))return[];const t=W(e),a=W(new Date);let o=h?.to?W(h.to):a;Ae(o,a)&&(o=a),ge(o,t)&&(o=t);const l=Bt(o,t)+1;if(l<=0)return[];const i=[];for(let b=l-1;b>=0;b-=1){const u=Fa(t,b),x=y(u,"yyyy-MM-dd"),g=Bt(u,t)+1,w=ne.get(x)||null;i.push({isoDate:x,date:u,cycleDay:g,details:w})}return i},[r?.startDate,h,ne]),Et=n.useMemo(()=>new Set(F.map(e=>e.isoDate)),[F]),ma=n.useMemo(()=>{const e=new Map;return F.forEach(t=>{e.set(t.isoDate,t)}),e},[F]),_t=m&&ma.get(m)||null,tt=_t?.details??null,Mt=tt?.peakStatus??(m?Je[m]??null:null),fa=tt?.isPeakDay??Mt==="P",Me=n.useMemo(()=>{const e=h?.to?y(W(h.to),"yyyy-MM-dd"):null;return p?e??se[0]??null:se.length?se[0]:e},[p,h,se]);n.useEffect(()=>{if(!(m&&Et.has(m))){if(!Me){m!==null&&H(null);return}m!==Me&&H(Me)}},[m,Et,Me]);const Rt=n.useCallback(e=>{if(!e)return;const t=y(e,"yyyy-MM-dd");h&&(ge(e,h.from)||Ae(e,h.to))||H(t)},[h]);n.useEffect(()=>{if(!m)return;const e=d(m);C(e)&&et(t=>t&&t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()?t:e)},[m]);const At=n.useCallback(e=>{et(t=>{const a=t??h?.to??W(new Date);return $a(a,e==="next"?1:-1)})},[h]);n.useEffect(()=>{const e=vt.current;if(!e)return;const t=e.querySelector(".records-calendar-day-grid");t&&(Ct.current=t)},[Dt,pt,I]);const at=n.useCallback(async e=>{if(pe.current)return;pe.current=!0;const a=Ct.current?.getBoundingClientRect()?.width??0,o=e==="next"?-$t:$t,l=a?e==="next"?-a:a:o,i=-l;try{await oe(l,{duration:ye}),At(e),I(i),await kt(),await oe(0,{duration:ye})}finally{pe.current=!1}},[oe,At,I,kt]),E=n.useCallback(()=>{ct(null),dt(null),ut(!1),mt(null),Ke(!1)},[]);n.useEffect(()=>()=>{k.current&&(cancelAnimationFrame(k.current),k.current=null),U.current&&(U.current(),U.current=null)},[]);const Tt=n.useCallback(()=>{je(r?.startDate||""),ke(r?.endDate||""),A(""),E(),it(!0)},[r?.startDate,r?.endDate,E]),X=n.useCallback(()=>{it(!1),A(""),E(),je(r?.startDate||""),ke(r?.endDate||"")},[r?.startDate,r?.endDate,E]),pa=n.useCallback(()=>{G&&(X(),G())},[X,G]),ha=n.useCallback(e=>{if(pe.current||e.pointerType==="mouse"&&e.button!==0)return;const t=e.target.closest(".records-calendar-day-grid");if(!t)return;const a=la.current;a.active=!0,a.pointerId=e.pointerId,a.startX=e.clientX,a.startTime=performance.now(),a.dragging=!1;const o=t.getBoundingClientRect().width||0;a.gridWidth=o,a.swipeThreshold=o?Math.max(rt,o*.2):rt;const l=u=>{if(!a.active||u.pointerId!==a.pointerId)return;const x=u.clientX-a.startX;if(!a.dragging&&Math.abs(x)>rs&&(a.dragging=!0,jt(!0)),!a.dragging)return;const g=a.gridWidth||ss,w=Math.max(-g,Math.min(g,x));u.preventDefault(),I(w)},i=async u=>{if(!a.active||u.pointerId!==a.pointerId)return;U.current?.(),U.current=null,a.active=!1;const x=u.clientX-a.startX,g=performance.now()-a.startTime,w=g>0?x/g*1e3:0,_=a.swipeThreshold||rt,le=x<=-_||w<=-Xt,$=x>=_||w>=Xt,q=a.dragging;if(a.dragging=!1,jt(!1),pe.current){await oe(0,{duration:ye});return}if(q&&le){await at("next");return}if(q&&$){await at("prev");return}await oe(0,{duration:ye})},b=()=>{window.removeEventListener("pointermove",l,{capture:!0}),window.removeEventListener("pointerup",i,{capture:!0}),window.removeEventListener("pointercancel",i,{capture:!0})};U.current?.(),U.current=b,window.addEventListener("pointermove",l,{capture:!0,passive:!1}),window.addEventListener("pointerup",i,{capture:!0}),window.addEventListener("pointercancel",i,{capture:!0})},[at,oe,pt,I]),xa=n.useCallback(()=>{E()},[E]),ga=n.useCallback(async()=>{if(!z){A("La fecha de inicio es obligatoria");return}if(p&&B&&B<z){A("La fecha de fin no puede ser anterior al inicio");return}if(r?.id){A(""),me(!0);try{const e=Xe?await Xe(r.id,z,p&&B||void 0):null;if(e){ct(z),dt((p&&B||void 0)??null),ut(!!p),mt(e),Ke(!0),me(!1);return}await Se(r.id,z,p&&B||void 0),await Ne({silent:!0}),j({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),X()}catch(e){console.error("Error updating start date from records page:",e),A("No se pudieron actualizar las fechas"),j({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{me(!1)}}},[z,B,p,r?.id,Xe,Se,Ne,j,X]),ya=n.useCallback(async()=>{if(!r?.id||!T){E();return}me(!0),Ke(!1);try{const e=r.startDate,t=r.endDate??void 0,a=T!==e,o=a&&T&&e&&ge(d(T),d(e)),l=Ge?Ye??void 0:void 0,i=Ge&&Ye!==null&&l!==t;if(o&&await lt(r.id,T),i&&l&&$e){const b=a?T:e;await $e(r.id,l,b)}await Se(r.id,a?T:void 0,l),await Ne({silent:!0}),j({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),X()}catch(e){console.error("Error adjusting cycle dates from records page:",e),A("No se pudieron actualizar las fechas"),j({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{me(!1),E()}},[r?.id,r?.startDate,r?.endDate,T,Ge,Ye,lt,$e,Se,Ne,j,X,E]),It=n.useCallback(()=>{P(!1),Z(null),V(null),fe(null),ae(null)},[]),Ft=n.useCallback((e,t=null,a=null)=>{e&&(Z(e),V(e.isoDate??null),fe(t),ae(a??null),e.isoDate&&H(e.isoDate),P(!0))},[]),ba=n.useCallback((e,t=null,a=null)=>Ft(e,a,t),[Ft]),wa=e=>{const t=r?.data?.find(a=>a.id===e);We(t||null)},Da=n.useCallback(e=>{Z(e)},[]),va=n.useCallback((e,t=null,a=null)=>{e&&(H(e),Z(null),V(e),fe(a),ae(t),P(!0))},[]),Lt=n.useCallback(()=>{const e=F.length?F[0].isoDate:r?.startDate||null,t=m||e||null;Z(null),V(t),fe(null),ae(null),t&&H(t),P(!0)},[F,r?.startDate,m]),Ot=n.useCallback((e,t={})=>{const a=r?.data?.find(i=>i.isoDate===e)||null,o=a?.timestamp&&C(d(a.timestamp))?y(d(a.timestamp),"HH:mm"):y(new Date,"HH:mm"),l=a?.measurements?.length?a.measurements.map((i,b)=>{const u=i?.time||(i?.timestamp&&C(d(i.timestamp))?y(d(i.timestamp),"HH:mm"):o);return{temperature:i?.temperature??i?.temperature_raw??"",temperature_corrected:i?.temperature_corrected??"",time:u,time_corrected:i?.time_corrected||u,use_corrected:!!i?.use_corrected,selected:!!(i?.selected??b===0)}}):[{temperature:"",temperature_corrected:"",time:o,time_corrected:o,use_corrected:!1,selected:!0}];return{isoDate:e,measurements:l,mucusSensation:a?.mucusSensation??a?.mucus_sensation??"",mucusAppearance:a?.mucusAppearance??a?.mucus_appearance??"",fertility_symbol:a?.fertility_symbol??a?.fertilitySymbol??"none",observations:a?.observations??"",peak_marker:a?.peak_marker??null,ignored:a?.ignored??!1,...t}},[r?.data]),Ca=async(e,{keepFormOpen:t=!1}={})=>{te(!0);try{await R(e,qe),t||(P(!1),Z(null),V(null),fe(null),ae(null))}catch{j({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{te(!1),t&&V(e?.isoDate??null)}},Sa=n.useCallback(async e=>{if(!e)return;const t=r?.data?.find(l=>l.isoDate===e)||null,a=!!(t?.had_relations??t?.hadRelations??!1),o=Ot(e,{had_relations:!a,hadRelations:!a});te(!0);try{await R(o,t)}catch{j({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{te(!1)}},[R,Ot,r?.data,j]),Na=async()=>{if(J){te(!0);try{const e=J.isoDate;await Wt(J.id),We(null),V(null),e&&m===e&&H(e)}catch{j({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{te(!1)}}},Pt={openDateEditor:Tt,openAddRecord:Lt,isProcessing:ee,isUpdatingDates:Qe,cycle:r},ja=typeof Y=="function"?Y(Pt):s.jsxs(s.Fragment,{children:[s.jsxs(be,{type:"button",variant:"outline",size:"icon",onClick:Tt,className:"border-fertiliapp-suave rounded-full bg-secundario text-white hover:brightness-95",disabled:ee||Qe,"aria-label":p?"Editar fechas del ciclo":"Editar fecha de inicio",children:[s.jsx(Oa,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:p?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),s.jsxs(be,{type:"button",size:"icon",onClick:Lt,className:"rounded-full border border-fertiliapp-fuerte bg-white/80 hover:brightness-95 text-fertiliapp-fuerte shadow-md",disabled:ee,style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},"aria-label":"Añadir registro",children:[s.jsx(Ga,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]});return typeof ie=="function"&&ie({...Pt}),v&&!r?.id?s.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:s.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):r?.id?s.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[s.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[s.jsx("div",{ref:Ee,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:s.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:s.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[s.jsx(xe.div,{className:"flex flex-col gap-4",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:s.jsxs("div",{className:"flex flex-wrap items-center gap-1 justify-between sm:justify-start",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(c,{className:"h-7 w-7 text-subtitulo"}),s.jsx("span",{className:"text-2xl sm:text-2xl font-bold text-subtitulo",children:ra})]}),s.jsx("div",{className:"flex items-center gap-1",children:ja})]})}),Kt&&s.jsx(xe.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:s.jsx(za,{cycle:r,startDate:z,endDate:p?B:r?.endDate,onStartDateChange:e=>je(e),onEndDateChange:p?e=>ke(e):void 0,onSave:ga,onCancel:X,isProcessing:Qe,dateError:Qt,includeEndDate:p,showOverlapDialog:Jt,overlapCycle:Zt,onConfirmOverlap:ya,onCancelOverlap:xa,onClearError:()=>A(""),saveLabel:p?"Guardar fechas":"Guardar cambios",title:p?"Editar fechas del ciclo":"Editar fecha de inicio",description:p?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:G?pa:void 0,deleteTitle:Le,deleteDescription:M,deleteLabel:Oe,isDeletingCycle:O})}),s.jsx(qa,{initial:!1,children:s.jsx(xe.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:s.jsx("div",{ref:vt,onPointerDown:ha,"data-calendar-dragging":Nt?"true":"false",className:D("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:transition-transform [&_.records-calendar-day-grid]:duration-200 [&_.records-calendar-day-grid]:ease-out [&_.records-calendar-day-grid]:[transform:translateX(var(--calendar-drag-x,0px))] data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:duration-0 data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:ease-linear",Nt?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${ia}px`},children:s.jsx(Wa,{mode:"single",locale:nt,month:Dt??void 0,onMonthChange:et,selected:m&&C(d(m))?d(m):void 0,onSelect:Rt,onDayClick:Rt,modifiers:na,labels:da,components:{DayContent:ua},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:oa,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),s.jsxs("div",{ref:ht,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:bt,maxHeight:`calc(h-app - ${bt}px )`,WebkitOverflowScrolling:"touch"},children:[s.jsx(xe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:F.length===0?s.jsx(xe.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:s.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[s.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:s.jsx(ot,{className:"h-8 w-8"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),s.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):s.jsx(ts,{isoDate:m,cycleDay:_t?.cycleDay??null,details:tt,peakStatus:Mt,isPeakDay:fa,onEdit:ba,onDelete:wa,onAdd:va,onToggleRelations:Sa,isProcessing:ee})}),ve&&s.jsx("div",{className:"pt-4 space-y-4",children:ve})]})]}),s.jsx(Za,{open:Gt,onOpenChange:e=>{e?P(!0):It()},children:s.jsx(Ja,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:s.jsx(Ya,{onSubmit:Ca,onCancel:It,initialData:qe,cycleStartDate:r?.startDate,cycleEndDate:r?.endDate,isProcessing:ee,isEditing:!!qe,cycleData:r?.data,onDateSelect:Da,defaultIsoDate:ea,focusedField:ta,initialSectionKey:aa})})}),s.jsx(Ka,{isOpen:!!J,onClose:()=>We(null),onConfirm:Na,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:J?`¿Estás seguro de que quieres eliminar el registro del ${y(d(J.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:ee})]}):s.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[s.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[s.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),s.jsx("button",{onClick:()=>Ze(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),s.jsx(Pa,{isOpen:sa,onClose:()=>Ze(!1),onConfirm:async e=>{await Yt(e),Ze(!1),ae(null),P(!0)}})]})},ys=()=>s.jsx(os,{});export{os as RecordsExperience,ys as default};
