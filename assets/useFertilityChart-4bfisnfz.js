import{r as j,j as a,m as we,B as tt,K as St,g as lt,f as Ye,Q as ft}from"./index-DH3_E9Yn.js";import{l as wt,B as Mt}from"./badge-CdG7NQBE.js";import{b as kt,X as Nt,e as ct,P as ut,f as nt,T as Pt,h as Tt,c as Dt}from"./computePeakStatuses-P1dm--_1.js";const Gt=({point:e,position:n,chartWidth:l,chartHeight:I,onToggleIgnore:p,onEdit:s,onClose:u,onTogglePeak:x,currentPeakIsoDate:w})=>{if(!e)return null;const y=.6,C=200,N=120,S=C*y,L=N*y,f=j.useRef(null),[g,h]=j.useState(L),[d,v]=j.useState(!1);j.useEffect(()=>{f.current&&h(f.current.offsetHeight),v(!1)},[e]);const F=n.clientX>l*.66,U=n.clientY+g>I;let T=F?n.clientX-S-10:n.clientX+10,E=U?n.clientY:n.clientY+10;T+S>l&&(T=l-S-10),E+g>I&&(E=I-g-10),T<10&&(T=10),E<10&&(E=10);const R=!e.id||String(e.id).startsWith("placeholder-"),P=e.temperature_chart??e.displayTemperature??null,A=kt(e.fertility_symbol),re=e.timestamp||e.isoDate,X=H=>{if(H==null)return null;const G=String(H).trim();return G.length?G:null},V=H=>{if(!H)return null;try{const G=Ye(H),Z=G.getTime();return Number.isNaN(Z)?null:lt(G,"HH:mm")}catch{return null}},le=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const H=e.measurements.filter(Boolean);if(!H.length)return null;const G=[...H.filter(Z=>Z?.selected),...H.filter(Z=>!Z?.selected)];for(const Z of G){const ke=!!Z?.use_corrected?X(Z?.time_corrected)??X(Z?.time):X(Z?.time);if(ke)return ke}return null})(),B=(e.use_corrected?[X(e.time_corrected),X(e.time)]:[X(e.time)]).find(Boolean)??V(e.timestamp),$=le??B,O=e.mucus_sensation??e.mucusSensation??"",xe=e.mucus_appearance??e.mucusAppearance??"",Q=e.observations??"",me=!!(e.had_relations??e.hadRelations),ye=A&&A.value!=="none",oe=P!=null,Y=!!(O&&O.trim()||xe&&xe.trim()),Ae=!!(Q&&Q.trim()),J=!(oe||ye||Y||Ae||me),ee=e.peakStatus||(e.peak_marker==="peak"?"P":null),ve=ee&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[ee]||null,W=!!(x&&e.isoDate),ae=!!w,Ie=ae&&e.isoDate===w||ee==="P"||e.peak_marker==="peak",te=Ie?"remove":ae?"update":"assign",ce=te==="assign"?"Asignar día pico":te==="update"?"Actualizar día pico":"Quitar día pico",q=ce,Ne=async()=>{if(!(!x||d)){v(!0);try{await x(e,!Ie),u&&u()}catch(H){console.error("Error toggling peak marker from tooltip:",H)}finally{v(!1)}}},Me=()=>{ue()},ue=H=>{s&&(s(e,H),u&&u())},pe=(H=>{switch(H){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return a.jsxs(we.div,{ref:f,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:E,left:T,width:S},children:[a.jsx("div",{className:"origin-top-left",style:{transform:`scale(${y})`,width:C,minHeight:N},children:a.jsxs("div",{className:"relative tooltip-surface--gradient backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden",children:[a.jsx(tt,{variant:"ghost",size:"icon",onClick:u,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-suave rounded-full w-6 h-6 transition-all duration-200",children:a.jsx(Nt,{size:20})}),me&&a.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:a.jsx(St,{className:"w-4 h-4 text-fertiliapp-fuerte",fill:"currentColor"})}),a.jsxs("div",{className:"p-2",children:[a.jsxs("div",{className:"mb-2 relative",children:[a.jsx("div",{className:"w-5 h-5 bg-fertiliapp-fuerte rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:a.jsx(ct,{className:"w-2 h-2 text-white",fill:"currentColor"})}),a.jsxs("div",{className:"mb-1 pl-8",children:[a.jsxs("div",{className:"flex items-baseline justify-start gap-2",children:[a.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:re?lt(Ye(re),"dd/MM",{locale:wt}):"Fecha"}),a.jsxs("span",{className:"text-sm text-fertiliapp-fuerte font-medium whitespace-nowrap",children:["Día ",e.cycleDay||"N/A"]})]}),ve&&a.jsx("div",{className:"mt-1 flex justify-start",children:a.jsx(Mt,{className:"bg-tarjeta text-fertiliapp-fuerte border border-fertiliapp-suave px-2 py-0 text-[11px]",children:ve})})]})]}),J?a.jsxs("div",{className:"pt-1 space-y-3",children:[a.jsx(we.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:a.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(W||s)&&a.jsxs(we.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[W&&a.jsx(ut,{mode:te,size:"sm",onClick:Ne,pending:d,"aria-label":q,title:ce,className:"shrink-0"}),s&&a.jsxs(tt,{onClick:Me,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[a.jsx(nt,{className:"h-4 w-4"}),a.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-1",children:[oe&&a.jsx(we.button,{type:"button",onClick:()=>ue("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-temp-suave rounded-2xl p-1 border border-temp focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-temp",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-temp rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Pt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(P).toFixed(2)}),a.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&a.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),$&&a.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:$})]})})]})}),ye&&a.jsx(we.button,{type:"button",onClick:()=>ue("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${pe.light} rounded-3xl p-1 ${pe.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-6 h-6 ${pe.bg} rounded-lg flex items-center justify-center shadow-lg ${pe.glow} shadow-lg`,children:a.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:`text-md font-semibold ${pe.text}`,children:A.label})})]})}),a.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[a.jsx(we.button,{type:"button",onClick:()=>ue("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-sensacion-suave rounded-3xl p-1 border border-sensacion focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-sensacion rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Tt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-sensacion-fuerte",children:O||"-"})})]})}),a.jsx(we.button,{type:"button",onClick:()=>ue("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-apariencia-suave rounded-3xl p-1 border border-apariencia focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-apariencia rounded-lg flex items-center justify-center shadow-md",children:a.jsx(ct,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-apariencia-fuerte",children:xe||"-"})})]})}),Ae&&a.jsx(we.button,{type:"button",onClick:()=>ue("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-observaciones-suave rounded-3xl p-1 border border-observaciones focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-observaciones rounded-lg flex items-center justify-center shadow-md",children:a.jsx(nt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-sm font-semibold text-observaciones-fuerte",children:Q})})]})})]})]}),(s||p&&!R&&e.id||W&&!R)&&a.jsxs(we.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[W&&!R&&a.jsx(ut,{mode:te,size:"sm",onClick:Ne,pending:d,"aria-label":q,title:ce,className:"shrink-0"}),a.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:s&&a.jsxs(tt,{onClick:Me,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[a.jsx(nt,{className:"h-4 w-4 mr-1.5"}),a.jsx("span",{className:"font-medium",children:R?"Añadir datos":""})]})})]})]})]})]})}),a.jsx("div",{className:"absolute -inset-2 tooltip-glow rounded-3xl blur-xl -z-10"})]})},Ue={0:0,1:.4,2:.8,3:1},At={M:.8,F:1,"M+":1,white:.4},jt=(e,n=0,l=1)=>!Number.isFinite(e)||e<n?n:e>l?l:e,Ct=e=>e?String(e).toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),""):"",pt=e=>Ct(e).replace(/\s+/g," ").trim(),ht=(e,n=[])=>{if(!e)return null;let l=null;return n.forEach((I,p)=>{const{patterns:s=[],level:u,descriptor:x,negatedLevel:w,allowedModifiers:y=null,disallowedModifiers:C=null,selectionScore:N,forceSelection:S=!1}=I||{};s.forEach(L=>{if(!L)return;const f=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${L})(?=$|[^a-z0-9])`,"g");let g;for(;(g=f.exec(e))!==null;){const h=g[1]?g[1].trim():null;if(y&&!y.includes(h)||C&&C.includes(h))continue;let d=u;h==="no"?d=w??1:h==="muy"?d=Math.min(3,u+1):(h==="poco"||h==="leve")&&(d=Math.max(0,u-1));const v=N??d+p*.001,F=typeof x=="function"?x({modifier:h}):x;(!l||S||d>l.level||d===l.level&&v>l.selectionScore)&&(l={level:d,baseLevel:u,descriptor:F,modifier:h,selectionScore:v,force:S})}})}),l},Ft=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],_t=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],gt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const l=Math.round(e);if(l>=0&&l<=3)return l}const n=String(e).trim();return/^[0-3]$/.test(n)?Number.parseInt(n,10):null},bt=e=>{const n=gt(e);if(n!=null)return{level:n,reason:`S${n}`,descriptor:`S${n}`,hasInput:!0};const l=e!=null?String(e).trim():"",I=pt(e),p=l.length>0;if(!I)return{level:0,reason:null,descriptor:null,hasInput:p};if(/^s\s*0?$/.test(I))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(I==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const s=ht(I,Ft);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:p}},xt=e=>{const n=gt(e);if(n!=null)return{level:n,reason:`M${n}`,descriptor:`M${n}`,hasInput:!0};const l=e!=null?String(e).trim():"",I=pt(e),p=l.length>0;if(!I)return{level:0,reason:null,descriptor:null,hasInput:p};if(/^m\s*0$/.test(I))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(l))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const s=ht(I,_t);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:p}},Lt=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),zt=({appearance:e,observations:n,fertilitySymbol:l})=>{const I=[e,n,l].map(s=>String(s||"").toUpperCase()),p=s=>{if(!s)return!1;const x=`(?:^|[^\\p{L}\\p{N}])${Lt(s)}(?=$|[^\\p{L}\\p{N}])`,w=new RegExp(x,"u");return I.some(y=>w.test(y))};return p("M+")?"M+":p("M")?"M":p("F")||p("FER")?"F":String(l||"").toLowerCase()==="white"?"white":"none"},Et=e=>{if(e==null)return"";const n=String(e).trim().toUpperCase();return n==="P"||n==="PEAK"?"P":n==="1"||n==="P1"||n==="P+1"?"1":n==="2"||n==="P2"||n==="P+2"?"2":n==="3"||n==="P3"||n==="P+3"?"3":""},Ve=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,Rt=(e,n,l)=>{const I=e?.mucusSensation??e?.mucus_sensation,p=e?.mucusAppearance??e?.mucus_appearance,s=e?.fertility_symbol??e?.fertilitySymbol,u=e?.observations??e?.notes,x=e?.peak_marker??e?.peakMarker??null,w=typeof x=="string"?x.trim().toLowerCase()==="peak":!1,y=bt(I),C=xt(p);let N=Ve(y.level),S=Ve(C.level);const L=[];y.reason&&L.push(`S:${y.reason}`),C.reason&&L.push(`M:${C.reason}`);const f=zt({appearance:p,observations:u,fertilitySymbol:s}),g=f;let h=f;h==="white"&&(S=Math.max(S,1)),h==="M"&&(S=Math.max(S,2)),h==="M+"&&(S=Math.max(S,3)),h==="F"&&(S=Math.max(S,3),N=Math.max(N,3));const d=Ue[N]??0,v=Ue[S]??0,F=Math.max(d,v);h&&h!=="none"&&L.push(`symbol:${h}`);const U=At[h]??0,T=jt(Math.max(F,U)),E=n!=null&&Number.isFinite(n)?F>=n+.4-1e-9:!1;E&&L.push("cambioBIP");const R={hasSensation:!!y.hasInput,hasAppearance:!!C.hasInput,hasSymbol:s!=null&&String(s).trim()!==""&&String(s).trim().toLowerCase()!=="none",hasObservation:u!=null&&String(u).trim()!==""};R.hasAny=R.hasSensation||R.hasAppearance||R.hasSymbol||R.hasObservation;const P=Et(e?.normalizedPeakStatus??e?.peakStatus??e?.peak_marker);return{index:l,S:N,M:S,symbolDetected:h,rawSymbol:g,isPeakMarked:w,scoreCore:F,scoreFertil:T,hasChangeBIP:E,reasons:L,entryFlags:R,descriptors:{sensation:y.descriptor??y.reason??null,appearance:C.descriptor??C.reason??null},normalizedPeakStatus:P}},Bt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const n=[];for(let p=0;p<Math.min(6,e.length);p+=1){const s=e[p];if(!s||String(s?.fertility_symbol||"").toLowerCase()==="red")continue;const x=bt(s?.mucusSensation??s?.mucus_sensation),w=xt(s?.mucusAppearance??s?.mucus_appearance),y=Ue[Ve(x.level)]??0,C=Ue[Ve(w.level)]??0;n.push(Math.max(y,C))}const l=n.length>0?Math.max(...n):0;return{days:e.map((p,s)=>Rt(p,l,s)),bipScore:l}},$t=e=>{for(let n=0;n<e.length;n+=1){const l=e[n];if(l){if(l.isPeakMarked)return{source:"Interno",day:n+1,reason:"P",kind:"profile"};if(l.symbolDetected==="white"||l.rawSymbol==="white")return{source:"Interno",day:n+1,reason:"white",kind:"profile"};if(l.symbolDetected==="M+"||l.symbolDetected==="F")return{source:"Interno",day:n+1,reason:"M+",kind:"profile"};if(l.symbolDetected==="M")return{source:"Interno",day:n+1,reason:"M",kind:"profile"};if(l.M>=2||l.S>=2)return{source:"Interno",day:n+1,reason:"S/M>=2",kind:"profile"}}}return null},Ht=(e,n)=>{const l=e.filter(s=>s&&Number.isFinite(s.day)).map(s=>({...s}));if(l.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:n,usedCandidates:[],notes:["Sin candidatos disponibles"]};const I=[...l].sort((s,u)=>{const x=Number.isFinite(s.day)?s.day:Number.POSITIVE_INFINITY,w=Number.isFinite(u.day)?u.day:Number.POSITIVE_INFINITY;return x-w}),p=Math.min(...I.map(s=>Math.round(s.day)));return{status:p!=null?"ok":"indeterminado",selectedDay:p??null,selectedMode:n,usedCandidates:I,notes:[]}},Ot=({processedData:e=[],config:n={},calculatorCandidates:l=[],context:I={}})=>{const{calculators:p={cpm:!0,t8:!0},postpartum:s=!1,combineMode:u="conservador"}=n||{},w=new Set(["conservador","estandar"]).has(u)?u:"conservador",{postPeakStartIndex:y=null,temperatureInfertileStartIndex:C=null,temperatureConfirmationIndex:N=null,temperatureRule:S=null,todayIndex:L=null}=I||{},{days:f,bipScore:g}=Bt(e),h=Array.isArray(f)?f.length:0,d=t=>Number.isInteger(t)&&t>=0&&t<h,v=t=>{const i=t?.peak_marker??t?.peakMarker??null;return typeof i=="string"&&i.trim().toLowerCase()==="peak"},U=(()=>{if(!Array.isArray(e)||e.length===0)return null;for(let t=e.length-1;t>=0;t-=1)if(v(e[t]))return t;return null})(),T=d(U)?U:null,E=[],R=t=>{!t||!Number.isFinite(t.day)||E.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};R($t(f));const P=[],A=[];s&&P.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),s||l.forEach(t=>{if(!t)return;const i=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";if(!(i==="CPM"&&p.cpm||i==="T8"&&p.t8))return;const _={...t,source:i,kind:"calculator"};w==="conservador"?R(_):A.push(_)});const re=E.map(t=>({...t})),X=w==="conservador"?E:E.filter(t=>t.kind!=="calculator"),V=Ht(X,w);V.ignoredCalculatorCandidates=A,V.notes=Array.from(new Set([...V.notes??[],...P].filter(Boolean)));const $e=t=>{if(!Number.isFinite(t))return null;const i=Math.max(1,Math.round(t));return e.length>0?Math.min(i,e.length):i},le=Number.isFinite(V.selectedDay)?$e(V.selectedDay):null;if(le!=null&&le!==V.selectedDay){const t=`El día calculado (${V.selectedDay}) supera la duración del ciclo. Se usa ${le}.`;V.notes=Array.from(new Set([...V.notes??[],t])),V.selectedDay=le}let be=null;le!=null&&le>=1&&(be=le-1);const B=f.length>0?f.length-1:null,$=Number.isInteger(be)&&be>=0?be:null;let O=null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(y)){const t=Math.max($,Math.min(y-1,B));O=t>=$?t:$}else if(d(T)){const t=Math.min(B,T+2),i=Math.max($,t);O=i>=$?i:$}else O=B;const xe=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,Q=t=>Number.isInteger(t)?B==null||B<0?t>=0?t:null:t<0?null:t>B?B:t:null,me=t=>{if(!Number.isInteger(t)||t<0||t>=e.length)return null;const i=e[t]?.isoDate;if(!i)return null;try{const k=Ye(i);return Number.isNaN(k?.getTime?.())?null:k}catch{return null}},ye=t=>{const i=me(t);if(!i)return null;try{return lt(i,"dd/MM")}catch{return null}};let oe=null,Y=null;if(d(T)){const t=T+3;d(t)&&(oe=t);const i=T+4;d(i)&&(Y=i);const k=Q(T),_=me(k);if(_)for(let he=k+1;he<e.length;he+=1){const ze=me(he);if(!ze)continue;const Ee=ft(ze,_);if(oe==null&&Ee>=3&&(oe=Q(he)),Y==null&&Ee>=4&&(Y=Q(he)),oe!=null&&Y!=null)break}}const Ae=Q(N),se=Q(C);let J=Ae;if(J==null&&se!=null){const t=Q(se-1);t!=null&&t>=0&&(J=t)}const ee=w==="conservador"?Y??null:oe??null,je=null,ve=[ee,se].filter(t=>Number.isInteger(t)),W=ve.length>0?Math.min(...ve):null,ae=Number.isInteger(ee),fe=Number.isInteger(se),Ie=ae&&fe?Math.max(ee,se):null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(W)){const t=Math.max($,W-1);O=Math.min(t,B)}else O=B;const te=O??B??null,ce=W;let q=null;ae&&fe?q=w==="conservador"?"P+4 y T+3":"P+3 y T+3":ae?q=w==="conservador"?"P+4":"P+3":fe&&(q=S??"Temperatura");const Ne={conservador:"modo conservador",estandar:"modo estándar",marcador:"marcador explícito"},Me=V?.selectedMode??w??"conservador",ue=V?.usedCandidates??[],Pe=ue.some(t=>t?.kind==="profile"),pe=ue.some(t=>t?.kind==="calculator"),H=f.some(t=>t?.entryFlags?.hasAppearance||t?.entryFlags?.hasSensation||t?.symbolDetected&&t.symbolDetected!=="none");let G=`Fase fértil abierta (${Ne[Me]??Me}).`;Me==="marcador"?G="Fase fértil abierta (ajustada por tus marcadores).":Pe&&H?G="Fase fértil abierta (basada en tus observaciones de moco).":pe&&!Pe&&(G="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const Z=ae&&fe,He="Infertilidad absoluta postovulatoria",Ge=`Ventana cerrada por doble criterio: ${q??"criterio indeterminado"}.`,ie=Q(T),Ke=ye(ie),Ce=ye(J),Oe="Infertilidad estimada por moco",We=Ke?`Fase de infertilidad alcanzada por determinación de día pico el ${Ke}.`:"Fase de infertilidad alcanzada por determinación de día pico.",qe="Infertilidad estimada por temperatura",Qe=Ce?`Infertilidad estimada por temperatura desde el ${Ce}.`:"Infertilidad estimada por temperatura.",de=new Array(f.length).fill(null);let r=null,o=0,c=null;const b={inicio:0,aumento:1,alta:2,muyAlta:3},m=t=>{if(!t)return[];const i=[];if(Number.isFinite(t.M)&&t.M>0){const k=t.descriptors?.appearance;i.push(`M${t.M}${k?` (${k})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const k=t.descriptors?.sensation;i.push(`S${t.S}${k?` (${k})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?i.push("white"):i.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&i.push("cambio BIP"),i},M=["inicio","aumento","alta","muyAlta"];for(let t=0;t<f.length;t+=1){const i=f[t];if(!i){de[t]=null;continue}const k=Number.isInteger(W),_=k?t>=W:!1,he=Number.isInteger(Ie)?t>=Ie:!1,ze=$!=null&&te!=null&&t>=$&&(k?t<W:t<=te)&&!_,Ee=Number.isInteger(L)&&L!=null?t>L:!1;if(!ze){if(o=0,r=null,!(_||te!=null&&t>te)||!k){de[t]=null;continue}const Xe=!!i.entryFlags?.hasAny,et=Xe?null:"Sin registro hoy; estimación basada en días adyacentes.";let Le=null,Re=null,Be=null;if(he&&Z?(Le=He,Re=Ge,Be="absolute"):ae&&t>=ee?(Le=Oe,Re=We,Be="mucus"):fe&&t>=se&&(Le=qe,Re=Qe,Be="temperature"),!Be){de[t]=null;continue}de[t]={index:t,state:"infertil",status:Be,title:Le,header:Le,body:Re,detail:q,hasRecord:Xe,inherited:!1,note:et,isFertile:!1,phase:"postOvulatory",label:Le,summaryText:Re,reasonsList:[],reasonsText:"",showFertilityStatus:!Ee};continue}const Fe=!!i.entryFlags?.hasAny;let Te=0;i.isPeakMarked||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3||i.M>=3?Te=3:i.M>=2||i.S>=2||i.symbolDetected==="M"?Te=2:(i.M>=1||i.S>=1||i.hasChangeBIP)&&(Te=1),Fe?(o=0,r=Te):o+=1;const yt=i.M>=2||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3;let Se=Te,K=null;{if(!Fe){const Xe=r??Te,et=Math.floor(o/2);Se=Math.max(0,Xe-et)}const Ze=Math.max(0,Math.min(3,Se));K=M[Ze]}const ot=m(i),De=ot.join("; "),_e=ie!=null?t-ie:null,Je=_e!=null?xe(_e):null,vt=Fe?null:"Sin registro hoy; estimación basada en días adyacentes.";K!=="waiting"&&(_e===0||_e===1||_e===2?(K="muyAlta",Se=Math.max(Se,3)):_e===3?(b[K]<b.alta&&(K="alta"),Se=Math.max(Se,2)):c!=null&&t-c<=3&&(b[K]<b.aumento&&(K="aumento"),Se=Math.max(Se,1))),(K==="alta"||K==="muyAlta"||yt)&&(c=t);let ge,ne;switch(K){case"waiting":ge="Fertilidad en espera de confirmación por temperatura",ne="Final de moco alcanzado (≥P+3). Ventana mantenida hasta confirmación térmica (T+3).";break;case"aumento":ge="Aumento de fertilidad",ne=De?`Signos en aumento: ${De}.`:"Signos en aumento.";break;case"alta":ge="Fertilidad alta",ne=De?`Signos fértiles claros (${De}).`:"Signos fértiles claros.";break;case"muyAlta":{ge="Fertilidad muy alta",ne=`Día de máxima fertilidad${Je?` (${Je})`:""}.`,ne+=De?` Signos pico: ${De}.`:" Signos pico presentes.";break}default:ge="Ventana fértil abierta",ne="Hoy sin signos destacables, a la espera de registrar más datos.";break}Fe||(K==="alta"?(ge="Fertilidad estimada alta",ne=`${ne} Sin datos apuntados este día; se estima en base a días cercanos.`):K==="muyAlta"?(ge="Fertilidad estimada muy alta",ne=`${ne} Sin datos apuntados este día; se estima en base a días cercanos.`):(K==="aumento"||K==="inicio")&&(ge="Ventana fértil abierta (sin registro hoy)",ne=`${ne} Sin datos apuntados este día; se estima en base a días cercanos.`));const It={index:t,state:K,level:K==="waiting"?Te:Se,title:ge,header:G,body:ne,reasonsList:ot,reasonsText:De,hasRecord:Fe,inherited:!Fe,note:vt,isFertile:!0,phase:"fertile",label:ge,summaryText:ne,delta:Je,showFertilityStatus:!Ee,reasonParts:{symbol:i.symbolDetected??null,appearance:i.descriptors?.appearance??null,sensation:i.descriptors?.sensation??null}};de[t]=It}te!=null&&(O=te);let D=null;if(Number.isInteger(L)&&de.length>0){const t=Math.min(Math.max(L,0),de.length-1);let i=null;for(let k=t;k>=0;k-=1){const _=de[k];if(_&&(i||(i=_),_.isFertile)){D=_;break}}!D&&i&&(D=i)}const z={bipScore:g,effectivePeakIndex:T,candidatesBeforeAggregate:re,closureDetail:q,waitingStartIndex:je,pPlus3Index:oe,pPlus4Index:Y,temperatureConfirmationIndex:J,temperatureInfertileIndex:se,temperatureRule:S??null,mucusInfertileStartIndex:ee,postOvulatoryStartIndex:ce,firstEstimateIndex:W,absoluteStartIndex:Ie};return{fertileStartFinalIndex:be,fertileWindow:$!=null&&O!=null?{startIndex:$,endIndex:O,waitingStartIndex:je,closureDetail:q,temperatureConfirmationIndex:J,temperatureInfertileStartIndex:se,mucusInfertileStartIndex:ee,postOvulatoryStartIndex:ce,temperatureRule:S??null}:null,dailyAssessments:de,currentAssessment:D,candidates:re,aggregate:V,debug:z}},dt=e=>{if(!e)return null;try{const n=new Date(e);return Number.isNaN(n.getTime())?null:n}catch{return null}},Wt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const l=e.map(u=>{if(!u?.startDate||!u?.endDate)return null;const x=dt(u.startDate),w=dt(u.endDate);if(!x||!w||w<x)return null;const y=Math.round((w-x)/(1e3*60*60*24))+1;if(!Number.isFinite(y)||y<=0)return null;const C=!!u?.ignoredForAutoCalculations;return{duration:y,ignored:C}}).filter(Boolean).filter(u=>!u.ignored);if(l.length<6)return null;const I=l.reduce((u,x)=>x.duration<u.duration?x:u),p=l.length>=12?20:21,s=I.duration-p;return Number.isFinite(s)?{source:"CPM",day:Math.max(1,Math.round(s)),reason:`ciclo_mas_corto=${I.duration}`,kind:"calculator"}:null},rt=e=>{if(e==null||e==="")return null;const n=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(n)?n:null},qt=e=>{const n=[e?.temperature_chart,e?.temperature_raw,e?.temperature_corrected];for(const l of n){const I=rt(l);if(I!==null)return I}if(Array.isArray(e?.measurements)){const l=s=>{if(!s)return null;const u=rt(s.temperature),x=rt(s.temperature_corrected);return s.use_corrected&&x!==null?x:u!==null?u:x!==null?x:null},p=e.measurements.find(s=>s&&s.selected&&l(s)!==null)||e.measurements.find(s=>l(s)!==null);if(p){const s=l(p);if(s!==null)return s}}return null},Xt=(e=[],n)=>{if(!Array.isArray(e)||e.length===0||typeof n!="function")return null;const l=[];if(e.forEach(p=>{if(!p?.data||!Array.isArray(p.data)||!p.startDate)return;const s=p.data.filter(S=>S&&S.isoDate).map(S=>({...S,displayTemperature:qt(S)}));if(s.length===0)return;const{ovulationDetails:u}=n(s);if(!u?.confirmed)return;const x=Number.isInteger(u?.ovulationIndex)?u.ovulationIndex:Number.isInteger(u?.confirmationIndex)?u.confirmationIndex:null;if(x==null||x<0||x>=s.length)return;const w=s[x],y=Number(w?.cycleDay);if(!Number.isFinite(y)||y<=0)return;const C=Math.max(1,Math.round(y-8)),N={riseDay:y,t8Day:C,ignored:!!p?.ignoredForAutoCalculations};!N.ignored&&l.length<12&&l.push(N)}),l.length<6)return null;const I=l.reduce((p,s)=>s.t8Day<p.t8Day?s:p);return{source:"T8",day:Math.max(1,Math.round(I.t8Day)),reason:`t8=${I.t8Day}`,kind:"calculator"}},st={calculators:{cpm:!0,t8:!0},combineMode:"conservador"},at=36.1,it=37.5,mt=(e=[])=>{const n=f=>f&&f.displayTemperature!=null&&!f.ignored,p=f=>{if(!f||f.length!==6)return null;const g=f.map(v=>v.temp);if(g.some(v=>!Number.isFinite(v)))return null;const h=g.reduce((v,F)=>F>v?F:v,g[0]),d=g.reduce((v,F)=>F>=h-.05&&F<h?v+1:v,0);return d>=2?null:{baselineTemp:h,baselineStartIndex:f[0].index,baselineIndices:f.map(v=>v.index),baselineBorderlineCount:d}},s=f=>{const g=[];for(let h=f;h<e.length;h+=1){const d=e[h];if(!n(d))continue;const v=d.displayTemperature;if(Number.isFinite(v)&&(g.push({index:h,temp:v}),g.length>6&&g.shift(),g.length===6)){const F=p(g);if(!F)continue;let U=null;for(let T=h+1;T<e.length;T+=1){const E=e[T];if(!n(E))continue;const R=E.displayTemperature;if(Number.isFinite(R)&&R>F.baselineTemp){U=T;break}}return{baselineTemp:F.baselineTemp,baselineStartIndex:F.baselineStartIndex,baselineIndices:F.baselineIndices,baselineBorderlineCount:F.baselineBorderlineCount,firstHighIndex:U}}}return null},u={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let x=null,w=null,y=null,C=[],N=u,S=0;const L=({baselineTemp:f,firstHighIndex:g})=>{if(g==null)return{confirmed:!1};const h=f+.2,d=[],v=[],F=new Set,U=A=>{A==null||F.has(A)||(F.add(A),v.push(A))};let T=null,E=!1;const R=g>0?g-1:null,P=()=>R!=null?[R,...v]:[...v];for(let A=g;A<e.length;A++){const re=e[A];if(!n(re))break;const X=re.displayTemperature;if(!Number.isFinite(X))break;if(X>f){if(U(A),d.push({index:A,temp:X}),d.length===3&&d[2].temp>=h)return{confirmed:!0,confirmationIndex:d[2].index,usedIndices:P(),highSequenceIndices:[...v],rule:"3-high"};if(d.length===4&&d[2].temp<h&&d[3].temp>f)return{confirmed:!0,confirmationIndex:d[3].index,usedIndices:P(),highSequenceIndices:[...v],rule:"german-3+1"};if(T!==null&&d.length===3&&d[2].temp>=h)return{confirmed:!0,confirmationIndex:d[2].index,usedIndices:P(),highSequenceIndices:[...v],rule:"german-2nd-exception"};if(d.length===5&&d[3].temp>f&&d[4].temp>=h)return{confirmed:!0,confirmationIndex:d[4].index,usedIndices:P(),highSequenceIndices:[...v],rule:"5-high"};continue}if(X>=f-.05&&T===null&&d.length>0&&d.length<3){T=A,U(A),d.push({index:A,temp:f});continue}if(!E&&d.length>0&&d.length<3){E=!0,U(A);continue}break}return{confirmed:!1,usedIndices:P(),highSequenceIndices:[...v]}};for(;S<e.length;){const f=s(S);if(!f)break;if(x=f.baselineTemp,w=f.baselineStartIndex,C=Array.isArray(f.baselineIndices)?[...f.baselineIndices]:[],y=f.firstHighIndex,f.baselineBorderlineCount,y==null){S=w+1;continue}const g=L(f);if(g?.requireRebaseline){S=w+1;continue}if(g?.confirmed){const h=g.highSequenceIndices?.length?g.highSequenceIndices[0]:null,d=Number.isInteger(g.confirmationIndex)?Math.max(0,Math.min(g.confirmationIndex,e.length-1)):null;let v=null;d!=null&&(v=Math.max(0,Math.min(d,e.length-1))),N={confirmed:!0,confirmationIndex:d,infertileStartIndex:v,rule:g.rule,highSequenceIndices:g.highSequenceIndices??g.usedIndices,usedIndices:g.usedIndices,ovulationIndex:y??h??null};break}S=w+1}return{baselineTemp:x,baselineStartIndex:w,firstHighIndex:y,baselineIndices:C,ovulationDetails:N}},Kt=(e,n,l,I,p,s=5,u=!1,x=null,w=[],y=null,C=!1)=>{const N=j.useRef(null),S=j.useRef(null),[L,f]=j.useState({width:0,height:0,viewportWidth:0,viewportHeight:0}),[g,h]=j.useState(null),[d,v]=j.useState({x:0,y:0}),[F,U]=j.useState(null),T=j.useCallback(()=>{h(null),U(null)},[]),E=r=>{if(r==null)return"";const o=String(r).trim().toUpperCase();return o==="P"||o==="PEAK"?"P":o==="1"||o==="P1"||o==="P+1"?"1":o==="2"||o==="P2"||o==="P+2"?"2":o==="3"||o==="P3"||o==="P+3"?"3":""},R=j.useMemo(()=>Dt(e),[e]),P=j.useMemo(()=>{const r=c=>{if(c==null||c==="")return null;const b=parseFloat(String(c).replace(",","."));return Number.isFinite(b)?b:null},o=c=>{if(!c)return null;const b=r(c.temperature),m=r(c.temperature_corrected);return c.use_corrected&&m!==null?m:b!==null?b:m!==null?m:null};return e.map(c=>{const b=[c?.temperature_chart,c?.temperature_raw,c?.temperature_corrected];let m=null;for(const i of b)if(i!=null&&i!==""){m=i;break}if(m==null&&Array.isArray(c?.measurements)){const k=c.measurements.find(_=>_&&_.selected&&o(_)!==null)||c.measurements.find(_=>o(_)!==null);k&&(m=o(k))}const M=c?.isoDate,D=c?.peak_marker??c?.peakStatus??null,z=M?R[M]??D:D,t=E(z);return{...c,displayTemperature:r(m),peakStatus:z??null,normalizedPeakStatus:t}})},[e,R]),A=j.useMemo(()=>{if(!Array.isArray(P)||P.length===0)return null;const r=new Date;let o=null;return P.forEach((c,b)=>{if(c?.isoDate)try{const m=Ye(c.isoDate);if(Number.isNaN(m?.getTime?.()))return;ft(m,r)<=0&&(o=b)}catch{}}),o},[P]);j.useLayoutEffect(()=>{const r=()=>{if(!N.current)return;const c=N.current.parentElement||N.current;let b=c.clientWidth||600,m=c.clientHeight||400,M=N.current.clientWidth>0?N.current.clientWidth:b,D,z,t,i;if(n){let k=window.innerWidth,_=window.innerHeight;if(u&&_>k&&([k,_]=[_,k]),M=k,t=k,i=_,l==="portrait"&&!u){const he=Math.max(30,k*.05);D=(k-he)/s*e.length}else D=k/s*e.length;z=_}else D=M/s*e.length,z=m,t=M,i=m;f({width:D,height:z,viewportWidth:t,viewportHeight:i})};r(),window.addEventListener("resize",r);let o;if(N.current){const c=N.current.parentElement||N.current;o=new ResizeObserver(r),o.observe(c)}return()=>{window.removeEventListener("resize",r),o&&o.disconnect()}},[n,e.length,s,l,u]);const re=j.useMemo(()=>P.filter(r=>r&&r.isoDate&&!r.ignored&&r.displayTemperature!==null&&r.displayTemperature!==void 0),[P]),X=j.useMemo(()=>P.filter(r=>r&&r.isoDate),[P]),V=re.length>0,$e=j.useMemo(()=>!Array.isArray(P)||P.length===0?!1:P.some(r=>r?r.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(M=>{const D=r?.[M];return D!=null&&String(D).trim()!==""})||(()=>{const M=r?.fertility_symbol??r?.fertilitySymbol;return M==null?!1:String(M).trim()!==""})()||(()=>{const M=r?.observations??r?.notes;return M==null?!1:String(M).trim()!==""})()?!0:E(r?.normalizedPeakStatus??r?.peakStatus??r?.peak_marker)!=="":!1),[P]),le=j.useMemo(()=>{const r=x??{},o=(D,z)=>typeof D=="boolean"?D:z,c={cpm:o(r?.calculators?.cpm,st.calculators.cpm),t8:o(r?.calculators?.t8,st.calculators.t8)},m=new Set(["conservador","estandar"]).has(r?.combineMode)?r.combineMode:st.combineMode,M=!!r?.postpartum;return{calculators:c,combineMode:m,postpartum:M}},[x]),be=j.useMemo(()=>{if(Array.isArray(y)&&y.length>0)return y.map(b=>{if(!b)return null;const{source:m,day:M,reason:D}=b,z=typeof m=="string"?m.toUpperCase().replace(/-/g,""):"";if(z!=="CPM"&&z!=="T8")return null;const t=Number(M);return Number.isFinite(t)?{source:z,originalSource:m??z,day:t,reason:typeof D=="string"?D:"",kind:"calculator"}:null}).filter(Boolean);const r=Array.isArray(w)?w:[];if(!r.length)return[];const o=Wt(r),c=Xt(r,mt);return[o,c].filter(Boolean)},[y,w]),{peakDayIndex:B,thirdDayIndex:$,peakInfertilityStartIndex:O}=j.useMemo(()=>{if(!X.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const r=X.map(b=>b?.normalizedPeakStatus??E(b?.peakStatus??b?.peak_marker));let o=null,c=null;if(r.forEach((b,m)=>{b==="P"&&o==null&&(o=m),b==="3"&&c==null&&(c=m)}),o==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(c!=null){const b=X.length-1,m=Math.min(c+1,b);return{peakDayIndex:o,thirdDayIndex:c,peakInfertilityStartIndex:m}}return{peakDayIndex:o,thirdDayIndex:null,peakInfertilityStartIndex:null}},[X]),{baselineTemp:xe,baselineStartIndex:Q,firstHighIndex:me,baselineIndices:ye,ovulationDetails:oe}=j.useMemo(()=>mt(P),[P]),Y=j.useMemo(()=>({...oe??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:xe,baselineIndices:ye,baselineStartIndex:Q,firstHighIndex:me,peakDayIndex:B,peakInfertilityStartIndex:O,thirdDayIndex:$}),[oe,xe,ye,Q,me,B,O,$]),Ae=j.useMemo(()=>Ot({processedData:P,config:le,calculatorCandidates:be,context:{postPeakStartIndex:O,peakThirdDayIndex:Y?.thirdDayIndex??null,temperatureInfertileStartIndex:Y?.infertileStartIndex??null,temperatureConfirmationIndex:Y?.confirmationIndex??null,temperatureRule:Y?.rule??null,todayIndex:A}}),[P,le,be,Y?.thirdDayIndex,Y?.infertileStartIndex,Y?.confirmationIndex,Y?.rule,B,O,A]),se=j.useMemo(()=>P.map((r,o)=>{if(!r)return r;const c=Number.isInteger(A)?o>A:!1;return{...r,isFutureDay:c}}),[P,A]),J=j.useMemo(()=>se.filter(r=>r&&r.isoDate),[se]),{tempMin:ee,tempMax:je}=j.useMemo(()=>{const r=re.map(t=>t.displayTemperature).filter(t=>t!=null);if(r.length===0)return{tempMin:at,tempMax:it};const o=it-at,c=Math.min(...r),b=Math.max(...r);let m=Math.min(c,at),M=Math.max(b,it);const D=t=>Math.floor(t*10)/10,z=t=>Math.ceil(t*10)/10;if(m=D(m),M=z(M),M-m<o){const t=(m+M)/2;m=D(t-o/2),M=z(t+o/2)}return Math.abs(m-c)<1e-9&&(m=D(m-.1)),Math.abs(M-b)<1e-9&&(M=z(M+.1)),{tempMin:parseFloat(m.toFixed(1)),tempMax:parseFloat(M.toFixed(1))}},[re]),ve=je-ee,W=L.width,ae=L.viewportHeight||L.height,fe=L.viewportWidth||W,Ie=9,te=(r=1)=>{if(!n)return Ie*r;const o=Math.min(W,ae);return Math.max(8,Math.min(Ie*r,o/(J.length>0?40/r:40)))},ce=Math.round(te(n?1.6:2)),q=u||l==="landscape",Ne=n?9:7.5,Me=Ne+(C?n?2:1.5:0),ue=n?1:.75,Pe=Math.round(ce*(Ne+ue)),pe=Math.round(ce*(Me+ue)),H=Pe,G=C?Math.max(0,pe-Pe):0,Z=C?pe:Pe,He=Math.max(ae-Z,ce*(n?10:8)),ke=Z+Math.max(He,0),Ge=ke+G,ie={top:n?Math.max(q?6:12,ae*(q?.015:.03)):12,right:n?Math.max(q?35:30,Math.min(W,fe)*(q?.02:.05)):50,bottom:Math.max(0,H-1),left:n?Math.max(q?45:20,Math.min(W,fe)*(q?.02:.05)):50},Ce=Math.max(0,Math.round(ce*4)),Oe=ke-ie.bottom-Ce,We=r=>{const o=ke-ie.top-ie.bottom-Ce;return r==null||ve===0||o<=0?Oe:Oe-(r-ee)/ve*o},qe=r=>{const o=n&&!(u||l==="landscape")?5:10,c=n&&!(u||l==="landscape")?25:0,b=15,m=n?Math.max(q?8:18,Math.min(W,fe)*(q?.01:.05)):20,M=ie.right+b,D=W-ie.left-M-o-m*2-c*(J.length-1);if(D<=0)return ie.left+o+m+c*r;const z=J.length>1?J.length-1:1;return z===0||J.length===0?ie.left+o+m+c*r:ie.left+o+m+r*(D/(J.length===1?1:z))+c*r},Qe=(r,o,c)=>{if(!r){T();return}const b=N.current.getBoundingClientRect();let m,M;if(c.type.startsWith("touch")){const i=c.changedTouches[0];m=i.clientX,M=i.clientY}else m=c.clientX,M=c.clientY;const D=qe(o),z=r.displayTemperature??r.temperature_chart??null,t=We(z);v({svgX:D,svgY:t,clientX:m-b.left+N.current.scrollLeft,clientY:M-b.top+N.current.scrollTop}),U(o),h(r)};j.useEffect(()=>{const r=o=>{if(S.current&&!S.current.contains(o.target)){const c=N.current?.querySelectorAll("circle, text, rect");let b=!1;if(c){for(let m of c)if(m.contains(o.target)){b=!0;break}}b||T()}};return g&&(document.addEventListener("mousedown",r),document.addEventListener("touchstart",r)),()=>{document.removeEventListener("mousedown",r),document.removeEventListener("touchstart",r)}},[g,T]);const de=r=>{I&&r&&(I(p,r),T())};return{chartRef:N,tooltipRef:S,dimensions:{...L,contentHeight:ke,scrollableContentHeight:Ge,extraScrollableHeight:G,viewportHeight:ae},activePoint:g,activeIndex:F,tooltipPosition:d,processedData:se,validDataForLine:re,allDataPoints:J,tempMin:ee,tempMax:je,tempRange:ve,padding:ie,textRowHeight:ce,setActivePoint:h,setActiveIndex:U,getY:We,getX:qe,handlePointInteraction:Qe,clearActivePoint:T,handleToggleIgnore:de,responsiveFontSize:te,baselineTemp:xe,baselineStartIndex:Q,baselineIndices:ye,firstHighIndex:me,ovulationDetails:Y,fertilityStart:Ae,hasTemperatureData:V,hasAnyObservation:$e,graphBottomInset:Ce,todayIndex:A}};export{Gt as C,Wt as a,Xt as b,mt as c,Kt as u};
