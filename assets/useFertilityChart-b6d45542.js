import{r as _,j as c,m as Pe,B as it,N as Tt,g as ut,f as Ke,O as xt}from"./index-2f41c8cd.js";import{e as At,B as Ct}from"./badge-4c7d2230.js";import{b as jt,X as Dt,e as pt,P as ht,f as lt,T as Ft,h as _t,c as zt}from"./computePeakStatuses-8ec0bab9.js";const nn=({point:e,position:r,chartWidth:o,chartHeight:N,onToggleIgnore:m,onEdit:s,onClose:a,onTogglePeak:f,currentPeakIsoDate:M})=>{if(!e)return null;const h=.6,k=200,T=120,F=k*h,re=T*h,z=_.useRef(null),[d,b]=_.useState(re),[w,x]=_.useState(!1);_.useEffect(()=>{z.current&&b(z.current.offsetHeight),x(!1)},[e]);const y=r.clientX>o*.66,P=r.clientY+d>N;let j=y?r.clientX-F-10:r.clientX+10,E=P?r.clientY:r.clientY+10;j+F>o&&(j=o-F-10),E+d>N&&(E=N-d-10),j<10&&(j=10),E<10&&(E=10);const U=!e.id||String(e.id).startsWith("placeholder-"),D=e.temperature_chart??e.displayTemperature??null,X=jt(e.fertility_symbol),I=e.timestamp||e.isoDate,V=H=>{if(H==null)return null;const te=String(H).trim();return te.length?te:null},q=H=>{if(!H)return null;try{const te=Ke(H),B=te.getTime();return Number.isNaN(B)?null:ut(te,"HH:mm")}catch{return null}},Ie=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const H=e.measurements.filter(Boolean);if(!H.length)return null;const te=[...H.filter(B=>B==null?void 0:B.selected),...H.filter(B=>!(B!=null&&B.selected))];for(const B of te){const Le=!!(B!=null&&B.use_corrected)?V(B==null?void 0:B.time_corrected)??V(B==null?void 0:B.time):V(B==null?void 0:B.time);if(Le)return Le}return null})(),O=(e.use_corrected?[V(e.time_corrected),V(e.time)]:[V(e.time)]).find(Boolean)??q(e.timestamp),ie=Ie??O,Se=e.mucus_sensation??e.mucusSensation??"",Y=e.mucus_appearance??e.mucusAppearance??"",he=e.observations??"",ve=!!(e.had_relations??e.hadRelations),Te=X&&X.value!=="none",R=D!=null,v=!!(Se&&Se.trim()||Y&&Y.trim()),Ae=!!(he&&he.trim()),be=!(R||Te||v||Ae||ve),Q=e.peakStatus||(e.peak_marker==="peak"?"P":null),ge=Q&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[Q]||null,Z=!!(f&&e.isoDate),ee=!!M,ue=ee&&e.isoDate===M||Q==="P"||e.peak_marker==="peak",G=ue?"remove":ee?"update":"assign",le=G==="assign"?"Asignar día pico":G==="update"?"Actualizar día pico":"Quitar día pico",de=le,_e=async()=>{if(!(!f||w)){x(!0);try{await f(e,!ue),a&&a()}catch(H){console.error("Error toggling peak marker from tooltip:",H)}finally{x(!1)}}},Ne=()=>{ae()},ae=H=>{s&&(s(e,H),a&&a())},ke=(H=>{switch(H){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return c.jsxs(Pe.div,{ref:z,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:E,left:j,width:F},children:[c.jsx("div",{className:"origin-top-left",style:{transform:`scale(${h})`,width:k,minHeight:T},children:c.jsxs("div",{className:"relative bg-gradient-to-br from-white/80 to-rose-50/95 backdrop-blur-xl rounded-3xl border border-pink-100 shadow-2xl overflow-hidden",children:[c.jsx(it,{variant:"ghost",size:"icon",onClick:a,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-fuerte/20 rounded-full w-6 h-6 transition-all duration-200",children:c.jsx(Dt,{size:20})}),ve&&c.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:c.jsx("div",{className:"w-4 h-4 rounded-full bg-rose-100/90 border border-rose-200 flex items-center justify-center shadow-sm",children:c.jsx(Tt,{className:"w-4 h-4 text-fertiliapp-fuerte",fill:"currentColor"})})}),c.jsxs("div",{className:"p-2",children:[c.jsxs("div",{className:"mb-2 relative",children:[c.jsx("div",{className:"w-5 h-5 bg-fertiliapp-fuerte rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:c.jsx(pt,{className:"w-2 h-2 text-white",fill:"currentColor"})}),c.jsx("div",{className:"flex items-center mb-1 pl-8",children:c.jsxs("div",{children:[c.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:I?ut(Ke(I),"dd/MM",{locale:At}):"Fecha"}),c.jsxs("p",{className:"text-sm text-fertiliapp-fuerte font-medium",children:["Día ",e.cycleDay||"N/A"," del ciclo"]}),ge&&c.jsx("div",{className:"mt-1 flex justify-center",children:c.jsx(Ct,{className:"bg-rose-100 text-fertiliapp-fuerte border border-rose-200 px-2 py-0 text-[11px]",children:ge})})]})})]}),be?c.jsxs("div",{className:"pt-1 space-y-3",children:[c.jsx(Pe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:c.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(Z||s)&&c.jsxs(Pe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[Z&&c.jsx(ht,{mode:G,size:"sm",onClick:_e,pending:w,"aria-label":de,title:le,className:"shrink-0"}),s&&c.jsxs(it,{onClick:Ne,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[c.jsx(lt,{className:"h-4 w-4"}),c.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):c.jsxs(c.Fragment,{children:[c.jsxs("div",{className:"space-y-1",children:[R&&c.jsx(Pe.button,{type:"button",onClick:()=>ae("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-1 border border-amber-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(Ft,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1",children:c.jsxs("div",{className:"flex items-center justify-between gap-3",children:[c.jsxs("div",{className:"flex items-baseline gap-2",children:[c.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(D).toFixed(2)}),c.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&c.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),ie&&c.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:ie})]})})]})}),Te&&c.jsx(Pe.button,{type:"button",onClick:()=>ae("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${ke.light} rounded-3xl p-1 ${ke.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:`w-6 h-6 ${ke.bg} rounded-lg flex items-center justify-center shadow-lg ${ke.glow} shadow-lg`,children:c.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:`text-md font-semibold ${ke.text}`,children:X.label})})]})}),c.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[c.jsx(Pe.button,{type:"button",onClick:()=>ae("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-1 border border-blue-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(_t,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:"text-md font-semibold text-blue-800",children:Se||"-"})})]})}),c.jsx(Pe.button,{type:"button",onClick:()=>ae("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-gradient-to-r from-emerald-50 to-teal-50 rounded-3xl p-1 border border-emerald-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(pt,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:"text-md font-semibold text-green-800",children:Y||"-"})})]})}),Ae&&c.jsx(Pe.button,{type:"button",onClick:()=>ae("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-gradient-to-r from-violet-50 to-purple-50 rounded-3xl p-1 border border-violet-100/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!s,children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md",children:c.jsx(lt,{className:"w-4 h-4 text-white"})}),c.jsx("div",{className:"flex-1 text-left",children:c.jsx("span",{className:"text-sm font-semibold text-violet-800",children:he})})]})})]})]}),(s||m&&!U&&e.id||Z&&!U)&&c.jsxs(Pe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[Z&&!U&&c.jsx(ht,{mode:G,size:"sm",onClick:_e,pending:w,"aria-label":de,title:le,className:"shrink-0"}),c.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:s&&c.jsxs(it,{onClick:Ne,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[c.jsx(lt,{className:"h-4 w-4 mr-1.5"}),c.jsx("span",{className:"font-medium",children:U?"Añadir datos":""})]})})]})]})]})]})}),c.jsx("div",{className:"absolute -inset-2 bg-gradient-to-br from-pink-200/25 to-rose-300/25 rounded-3xl blur-xl -z-10"})]})},Qe={0:0,1:.4,2:.8,3:1},Bt={M:.8,F:1,"M+":1,white:.4},Lt=(e,r=0,o=1)=>!Number.isFinite(e)||e<r?r:e>o?o:e,Et=e=>e?String(e).toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""):"",It=e=>Et(e).replace(/\s+/g," ").trim(),St=(e,r=[])=>{if(!e)return null;let o=null;return r.forEach((N,m)=>{const{patterns:s=[],level:a,descriptor:f,negatedLevel:M,allowedModifiers:h=null,disallowedModifiers:k=null,selectionScore:T,forceSelection:F=!1}=N||{};s.forEach(re=>{if(!re)return;const z=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${re})(?=$|[^a-z0-9])`,"g");let d;for(;(d=z.exec(e))!==null;){const b=d[1]?d[1].trim():null;if(h&&!h.includes(b)||k&&k.includes(b))continue;let w=a;b==="no"?w=M??1:b==="muy"?w=Math.min(3,a+1):(b==="poco"||b==="leve")&&(w=Math.max(0,a-1));const x=T??w+m*.001,y=typeof f=="function"?f({modifier:b}):f;(!o||F||w>o.level||w===o.level&&x>o.selectionScore)&&(o={level:w,baseLevel:a,descriptor:y,modifier:b,selectionScore:x,force:F})}})}),o},Rt=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],$t=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],Mt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const o=Math.round(e);if(o>=0&&o<=3)return o}const r=String(e).trim();return/^[0-3]$/.test(r)?Number.parseInt(r,10):null},wt=e=>{const r=Mt(e);if(r!=null)return{level:r,reason:`S${r}`,descriptor:`S${r}`,hasInput:!0};const o=e!=null?String(e).trim():"",N=It(e),m=o.length>0;if(!N)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^s\s*0?$/.test(N))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(N==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const s=St(N,Rt);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},vt=e=>{const r=Mt(e);if(r!=null)return{level:r,reason:`M${r}`,descriptor:`M${r}`,hasInput:!0};const o=e!=null?String(e).trim():"",N=It(e),m=o.length>0;if(!N)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^m\s*0$/.test(N))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(o))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const s=St(N,$t);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},Ot=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Ht=({appearance:e,observations:r,fertilitySymbol:o})=>{const N=[e,r,o].map(s=>String(s||"").toUpperCase()),m=s=>{if(!s)return!1;const f=`(?:^|[^\\p{L}\\p{N}])${Ot(s)}(?=$|[^\\p{L}\\p{N}])`,M=new RegExp(f,"u");return N.some(h=>M.test(h))};return m("M+")?"M+":m("M")?"M":m("F")||m("FER")?"F":String(o||"").toLowerCase()==="white"?"white":"none"},Nt=e=>{if(e==null)return"";const r=String(e).trim().toUpperCase();return r==="P"||r==="PEAK"?"P":r==="1"||r==="P1"||r==="P+1"?"1":r==="2"||r==="P2"||r==="P+2"?"2":r==="3"||r==="P3"||r==="P+3"?"3":""},Je=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,Wt=(e,r,o)=>{const N=(e==null?void 0:e.mucusSensation)??(e==null?void 0:e.mucus_sensation),m=(e==null?void 0:e.mucusAppearance)??(e==null?void 0:e.mucus_appearance),s=(e==null?void 0:e.fertility_symbol)??(e==null?void 0:e.fertilitySymbol),a=(e==null?void 0:e.observations)??(e==null?void 0:e.notes),f=wt(N),M=vt(m);let h=Je(f.level),k=Je(M.level);const T=[];f.reason&&T.push(`S:${f.reason}`),M.reason&&T.push(`M:${M.reason}`);const F=Ht({appearance:m,observations:a,fertilitySymbol:s}),re=F;let z=F;z==="white"&&(k=Math.max(k,1)),z==="M"&&(k=Math.max(k,2)),z==="M+"&&(k=Math.max(k,3)),z==="F"&&(k=Math.max(k,3),h=Math.max(h,3));const d=Qe[h]??0,b=Qe[k]??0,w=Math.max(d,b);z&&z!=="none"&&T.push(`symbol:${z}`);const x=Bt[z]??0,y=Lt(Math.max(w,x)),P=r!=null&&Number.isFinite(r)?w>=r+.4-1e-9:!1;P&&T.push("cambioBIP");const j={hasSensation:!!f.hasInput,hasAppearance:!!M.hasInput,hasSymbol:s!=null&&String(s).trim()!==""&&String(s).trim().toLowerCase()!=="none",hasObservation:a!=null&&String(a).trim()!==""};j.hasAny=j.hasSensation||j.hasAppearance||j.hasSymbol||j.hasObservation;const E=Nt((e==null?void 0:e.normalizedPeakStatus)??(e==null?void 0:e.peakStatus)??(e==null?void 0:e.peak_marker));return{index:o,S:h,M:k,symbolDetected:z,rawSymbol:re,scoreCore:w,scoreFertil:y,hasChangeBIP:P,reasons:T,entryFlags:j,descriptors:{sensation:f.descriptor??f.reason??null,appearance:M.descriptor??M.reason??null},normalizedPeakStatus:E}},qt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const r=[];for(let m=0;m<Math.min(6,e.length);m+=1){const s=e[m];if(!s||String((s==null?void 0:s.fertility_symbol)||"").toLowerCase()==="red")continue;const f=wt((s==null?void 0:s.mucusSensation)??(s==null?void 0:s.mucus_sensation)),M=vt((s==null?void 0:s.mucusAppearance)??(s==null?void 0:s.mucus_appearance)),h=Qe[Je(f.level)]??0,k=Qe[Je(M.level)]??0;r.push(Math.max(h,k))}const o=r.length>0?Math.max(...r):0;return{days:e.map((m,s)=>Wt(m,o,s)),bipScore:o}},Yt=e=>{for(let r=0;r<e.length;r+=1){const o=e[r];if(o){if(o.symbolDetected==="M+"||o.symbolDetected==="F")return{source:"Alemanas",day:r+1,reason:"M+",kind:"profile"};if(o.M>=2||o.S>=2)return{source:"Alemanas",day:r+1,reason:"S/M>=2",kind:"profile"};if(o.hasChangeBIP)return{source:"Alemanas",day:r+1,reason:"BIP",kind:"profile"}}}return null},Xt=e=>{for(let r=0;r<e.length;r+=1){const o=e[r];if(o){if(o.M>=2)return{source:"OMS",day:r+1,reason:"M>=2",kind:"profile"};if(o.S>=2)return{source:"OMS",day:r+1,reason:"S>=2",kind:"profile"};if(o.symbolDetected==="M+"||o.symbolDetected==="F")return{source:"OMS",day:r+1,reason:"M+",kind:"profile"};if(o.hasChangeBIP)return{source:"OMS",day:r+1,reason:"BIP",kind:"profile"}}}return null},Ut=e=>{for(let r=0;r<e.length;r+=1){const o=e[r];if(o){if(o.symbolDetected==="M+")return{source:"Creighton",day:r+1,reason:"M+",kind:"profile"};if(o.symbolDetected==="M"||o.M>=2)return{source:"Creighton",day:r+1,reason:"M>=2",kind:"profile"};if(o.hasChangeBIP)return{source:"Creighton",day:r+1,reason:"BIP",kind:"profile"}}}return null},Vt=(e,r)=>{const o=e.filter(a=>a&&Number.isFinite(a.day)).map(a=>({...a}));if(o.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:r,usedCandidates:[],notes:["Sin candidatos disponibles"]};const N=[...o].sort((a,f)=>{const M=Number.isFinite(a.day)?a.day:Number.POSITIVE_INFINITY,h=Number.isFinite(f.day)?f.day:Number.POSITIVE_INFINITY;return M-h}),m=N.map(a=>Math.round(a.day));let s=null;if(r==="permisivo")s=Math.max(...m);else if(r==="consenso"){const a=new Map;m.forEach(h=>{const k=a.get(h)??0;a.set(h,k+1)});let f=0,M=null;a.forEach((h,k)=>{(h>f||h===f&&(M==null||k<M))&&(f=h,M=k)}),s=M}else s=Math.min(...m);return{status:s!=null?"ok":"indeterminado",selectedDay:s??null,selectedMode:r,usedCandidates:N,notes:[]}},Gt=({processedData:e=[],config:r={},calculatorCandidates:o=[],context:N={}})=>{var me,qe,Ue,dt;const{methods:m={alemanas:!0,oms:!0,creighton:!0},calculators:s={cpm:!0,t8:!0},postpartum:a=!1,combineMode:f="conservador"}=r||{},{peakDayIndex:M=null,postPeakStartIndex:h=null,peakThirdDayIndex:k=null,temperatureInfertileStartIndex:T=null,temperatureConfirmationIndex:F=null,temperatureRule:re=null,todayIndex:z=null}=N||{},{days:d,bipScore:b}=qt(e),w=Array.isArray(d)?d.length:0,x=t=>Number.isInteger(t)&&t>=0&&t<w,y=t=>{var l;if(!t||w===0)return null;for(let C=w-1;C>=0;C-=1)if(((l=d[C])==null?void 0:l.normalizedPeakStatus)===t)return C;return null};let P=x(M)?M:null;if(P==null){const t=y("P");x(t)&&(P=t)}const j=[],E=t=>{!t||!Number.isFinite(t.day)||j.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};m.alemanas&&E(Yt(d)),m.oms&&E(Xt(d)),m.creighton&&E(Ut(d));const U=[];a&&U.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),a||o.forEach(t=>{if(!t)return;const l=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";(l==="CPM"&&s.cpm||l==="T8"&&s.t8)&&E({...t,source:l,kind:"calculator"})}),!m.alemanas&&!m.oms&&!m.creighton&&U.push("Ningún perfil sintotérmico seleccionado.");const D=j.map(t=>({...t}));let X=j;(f==="consenso"||f==="permisivo")&&(X=j.filter(t=>t.kind!=="calculator"));const I=Vt(X,f);I.notes=Array.from(new Set([...I.notes??[],...U].filter(Boolean)));const V=t=>{if(!Number.isFinite(t))return null;const l=Math.max(1,Math.round(t));return e.length>0?Math.min(l,e.length):l};let q=Number.isFinite(I.selectedDay)?V(I.selectedDay):null;if(q!=null&&q!==I.selectedDay){const t=`El día calculado (${I.selectedDay}) supera la duración del ciclo. Se usa ${q}.`;I.notes=Array.from(new Set([...I.notes??[],t])),I.selectedDay=q}let pe=null;if(Array.isArray(d)&&d.length>0){const t=d.findIndex(l=>(l==null?void 0:l.rawSymbol)==="white");t>=0&&(pe=t)}if(Array.isArray(e)&&e.length>0)for(let t=0;t<e.length;t+=1){const l=e[t];if(Nt((l==null?void 0:l.normalizedPeakStatus)??(l==null?void 0:l.peakStatus)??(l==null?void 0:l.peak_marker))==="P"){pe=pe!=null?Math.min(pe,t):t;break}}if(pe!=null&&(q==null||pe+1<q)){const t=V(pe+1);t!=null&&(I.selectedDay=t,I.selectedMode="marcador",I.status="ok",I.notes=Array.from(new Set([...I.notes??[],"Inicio fértil ajustado por marcador explícito."])),q=t)}else q=I.selectedDay??null;let Ie=null;q!=null&&q>=1&&(Ie=q-1);const se=d.length>0?d.length-1:null,O=Number.isInteger(Ie)&&Ie>=0?Ie:null;let ie=null;if(O!=null&&se!=null&&se>=O)if(Number.isInteger(h)){const t=Math.max(O,Math.min(h-1,se));ie=t>=O?t:O}else if(x(P)){const t=Math.min(se,P+2),l=Math.max(O,t);ie=l>=O?l:O}else ie=se;const Se=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,Y=t=>Number.isInteger(t)?se==null||se<0?t>=0?t:null:t<0?null:t>se?se:t:null,he=t=>{var C,fe;if(!Number.isInteger(t)||t<0||t>=e.length)return null;const l=(C=e[t])==null?void 0:C.isoDate;if(!l)return null;try{const ne=Ke(l);return Number.isNaN((fe=ne==null?void 0:ne.getTime)==null?void 0:fe.call(ne))?null:ne}catch{return null}},ve=t=>{const l=he(t);if(!l)return null;try{return ut(l,"dd/MM")}catch{return null}};let R=(t=>{var l;if(!t)return null;for(let C=0;C<d.length;C+=1)if(((l=d[C])==null?void 0:l.normalizedPeakStatus)===t)return C;return null})("3");R==null&&Number.isInteger(k)&&(R=Y(k)),R==null&&Number.isInteger(h)&&(R=Y(h-1));let v=null;if(R!=null){const t=Y(R+1);t!=null&&(v=t)}const Ae=Y(P),Ce=he(Ae);if(Ce)for(let t=Ae+1;t<e.length;t+=1){const l=he(t);if(!l)continue;const C=xt(l,Ce);if(R==null&&C>=3&&(R=Y(t)),v==null&&C>=4&&(v=Y(t)),R!=null&&v!=null)break}const be=Y(F),Q=Y(T);let J=be;if(J==null&&Q!=null){const t=Y(Q-1);t!=null&&t>=0&&(J=t)}if(v==null&&R!=null){const t=Y(R+1);t!=null&&(v=t)}const ge=R??null,Z=v??R??null;let ee=null;Z!=null&&Q!=null?ee=Math.min(Z,Q):Z!=null?ee=Z:Q!=null&&(ee=Q);let xe=null;R!=null&&J!=null&&(xe=Math.max(R,J));let ue=null;v!=null&&J!=null&&(ue=Math.max(v,J));let G=null,le=null;if(xe!=null||ue!=null){const t=xe??Number.NEGATIVE_INFINITY,l=ue??Number.NEGATIVE_INFINITY;le=Math.max(t,l),ue!=null&&(xe==null||ue>=xe)?G="P+4 y T+3 (OMS)":xe!=null&&(G="P+3 y T+3 (Alemanes)")}if(le!=null&&O!=null){const t=Y(le);t!=null&&(ie=Math.max(O,t))}const de=ie??se??null,_e={conservador:"modo conservador",consenso:"modo consenso",permisivo:"modo permisivo",marcador:"marcador explícito"},Ne=(I==null?void 0:I.selectedMode)??f??"conservador",ae=(I==null?void 0:I.usedCandidates)??[],ze=ae.some(t=>(t==null?void 0:t.kind)==="profile"),ke=ae.some(t=>(t==null?void 0:t.kind)==="calculator"),H=d.some(t=>{var l,C;return((l=t==null?void 0:t.entryFlags)==null?void 0:l.hasAppearance)||((C=t==null?void 0:t.entryFlags)==null?void 0:C.hasSensation)||(t==null?void 0:t.symbolDetected)});let te=`Fase fértil abierta (perfil: ${_e[Ne]??Ne}).`;Ne==="marcador"?te="Fase fértil abierta (ajustada por tus marcadores).":ze&&H?te="Fase fértil abierta (basada en tus observaciones de moco).":ke&&!ze&&(te="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const B="Fase de infertilidad absoluta confirmada(postovulatoria)",Le=`Ventana cerrada por doble criterio: ${G??"criterio indeterminado"}.`,ce=Y(P),Xe=R!=null||v!=null,je=J!=null,Oe=Xe&&je,He=ve(ce),We=ve(J),Ze="Fase de infertilidad postovulatoria (método moco)",et=He?`Fase de infertilidad alcanzada por determinación de día pico el ${He}.`:"Fase de infertilidad alcanzada por determinación de día pico.",n="Ovulación confirmada por temperatura",u=We?`Ovulación confirmada por temperatura el ${We}. La fase de infertilidad absoluta está pendiente de determinar día pico (si se registra).`:"Ovulación confirmada por temperatura. La fase de infertilidad absoluta está pendiente de determinar día pico (si se registra).",i=new Array(d.length).fill(null);let g=null,p=0,S=null;const L={inicio:0,aumento:1,alta:2,muyAlta:3},$=t=>{var C,fe;if(!t)return[];const l=[];if(Number.isFinite(t.M)&&t.M>0){const ne=(C=t.descriptors)==null?void 0:C.appearance;l.push(`M${t.M}${ne?` (${ne})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const ne=(fe=t.descriptors)==null?void 0:fe.sensation;l.push(`S${t.S}${ne?` (${ne})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?l.push("white"):l.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&l.push("cambio BIP"),l},A=["inicio","aumento","alta","muyAlta"];for(let t=0;t<d.length;t+=1){const l=d[t];if(!l){i[t]=null;continue}const C=Number.isInteger(ee)?t>=ee:!1,fe=O!=null&&de!=null&&t>=O&&t<=de&&!C,ne=Number.isInteger(z)&&z!=null?t>z:!1;if(!fe){if(p=0,g=null,C||de!=null&&t>de){if(!Xe&&!je&&ee==null){i[t]=null;continue}const Ve=!!((me=l.entryFlags)!=null&&me.hasAny),rt=Ve?null:"Sin registro hoy; estimación basada en días adyacentes.";let Ye=B,Ge=Le,st="absolute";!Oe&&Xe?(Ye=Ze,Ge=et,st="mucus"):!Oe&&je&&(Ye=n,Ge=u,st="temperature"),i[t]={index:t,state:"infertil",status:st,title:Ye,header:Ye,body:Ge,detail:G,hasRecord:Ve,inherited:!1,note:rt,isFertile:!1,phase:"postOvulatory",label:Ye,summaryText:Ge,reasonsList:[],reasonsText:"",showFertilityStatus:!ne}}continue}const Ee=!!((qe=l.entryFlags)!=null&&qe.hasAny);let De=0;l.normalizedPeakStatus==="P"||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3||l.M>=3?De=3:l.M>=2||l.S>=2||l.symbolDetected==="M"?De=2:(l.M>=1||l.S>=1||l.hasChangeBIP)&&(De=1),Ee?(p=0,g=De):p+=1;const mt=l.M>=2||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3,kt=ge!=null&&t>=ge&&(J==null||t<=J);let ye=De,K=null;if(kt&&!mt)K="waiting";else{if(!Ee){const Ve=g??De,rt=Math.floor(p/2);ye=Math.max(0,Ve-rt)}const nt=Math.max(0,Math.min(3,ye));K=A[nt]}const ft=$(l),Fe=ft.join("; "),Re=ce!=null?t-ce:null,tt=Re!=null?Se(Re):null,yt=Ee?null:"Sin registro hoy; estimación basada en días adyacentes.";K!=="waiting"&&(Re===0||Re===1||Re===2?(K="muyAlta",ye=Math.max(ye,3)):Re===3?(L[K]<L.alta&&(K="alta"),ye=Math.max(ye,2)):S!=null&&t-S<=3&&(L[K]<L.aumento&&(K="aumento"),ye=Math.max(ye,1))),(K==="alta"||K==="muyAlta"||mt)&&(S=t);let we,oe;switch(K){case"waiting":we="Fertilidad en espera de confirmación por temperatura",oe="Final de moco alcanzado (≥P+3). Ventana mantenida hasta confirmación térmica (T+3).";break;case"aumento":we="Aumento de fertilidad",oe=Fe?`Signos en aumento: ${Fe}.`:"Signos en aumento.";break;case"alta":we="Fertilidad alta",oe=Fe?`Signos fértiles claros (${Fe}).`:"Signos fértiles claros.";break;case"muyAlta":{we="Fertilidad muy alta",oe=`Día de máxima fertilidad${tt?` (${tt})`:""}.`,oe+=Fe?` Signos pico: ${Fe}.`:" Signos pico presentes.";break}case"inicio":default:we="Ventana fértil abierta",oe="Hoy sin signos destacables, a la espera de registrar más datos.";break}Ee||(K==="alta"?(we="Fertilidad estimada alta",oe=`${oe} Sin datos apuntados este día; se estima en base a días cercanos.`):K==="muyAlta"?(we="Fertilidad estimada muy alta",oe=`${oe} Sin datos apuntados este día; se estima en base a días cercanos.`):(K==="aumento"||K==="inicio")&&(we="Ventana fértil abierta (sin registro hoy)",oe=`${oe} Sin datos apuntados este día; se estima en base a días cercanos.`));const Pt={index:t,state:K,level:K==="waiting"?De:ye,title:we,header:te,body:oe,reasonsList:ft,reasonsText:Fe,hasRecord:Ee,inherited:!Ee,note:yt,isFertile:!0,phase:"fertile",label:we,summaryText:oe,delta:tt,showFertilityStatus:!ne,reasonParts:{symbol:l.symbolDetected??null,appearance:((Ue=l.descriptors)==null?void 0:Ue.appearance)??null,sensation:((dt=l.descriptors)==null?void 0:dt.sensation)??null}};i[t]=Pt}de!=null&&(ie=de);let W=null;if(Number.isInteger(z)&&i.length>0){const t=Math.min(Math.max(z,0),i.length-1);let l=null;for(let C=t;C>=0;C-=1){const fe=i[C];if(fe&&(l||(l=fe),fe.isFertile)){W=fe;break}}!W&&l&&(W=l)}const Me={bipScore:b,explicitStartDay:pe,effectivePeakIndex:P,candidatesBeforeAggregate:D,closureDetail:G,waitingStartIndex:ge,pPlus3Index:R,pPlus4Index:v,temperatureConfirmationIndex:J,temperatureInfertileIndex:Q,temperatureRule:re??null,mucusInfertileStartIndex:Z,postOvulatoryStartIndex:ee};return{fertileStartFinalIndex:Ie,fertileWindow:O!=null&&ie!=null?{startIndex:O,endIndex:ie,waitingStartIndex:ge,closureDetail:G,temperatureConfirmationIndex:J,temperatureInfertileStartIndex:Q,mucusInfertileStartIndex:Z,postOvulatoryStartIndex:ee,temperatureRule:re??null}:null,dailyAssessments:i,currentAssessment:W,candidates:D,aggregate:I,debug:Me}},bt=e=>{if(!e)return null;try{const r=new Date(e);return Number.isNaN(r.getTime())?null:r}catch{return null}},Kt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const o=e.map(a=>{if(!(a!=null&&a.startDate)||!(a!=null&&a.endDate))return null;const f=bt(a.startDate),M=bt(a.endDate);if(!f||!M||M<f)return null;const h=Math.round((M-f)/(1e3*60*60*24))+1;if(!Number.isFinite(h)||h<=0)return null;const k=!!(a!=null&&a.ignoredForAutoCalculations);return{duration:h,ignored:k}}).filter(Boolean).filter(a=>!a.ignored);if(o.length<6)return null;const N=o.reduce((a,f)=>f.duration<a.duration?f:a),m=o.length>=12?20:21,s=N.duration-m;return Number.isFinite(s)?{source:"CPM",day:Math.max(1,Math.round(s)),reason:`ciclo_mas_corto=${N.duration}`,kind:"calculator"}:null},ot=e=>{if(e==null||e==="")return null;const r=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(r)?r:null},Qt=e=>{const r=[e==null?void 0:e.temperature_chart,e==null?void 0:e.temperature_raw,e==null?void 0:e.temperature_corrected];for(const o of r){const N=ot(o);if(N!==null)return N}if(Array.isArray(e==null?void 0:e.measurements)){const o=s=>{if(!s)return null;const a=ot(s.temperature),f=ot(s.temperature_corrected);return s.use_corrected&&f!==null?f:a!==null?a:f!==null?f:null},m=e.measurements.find(s=>s&&s.selected&&o(s)!==null)||e.measurements.find(s=>o(s)!==null);if(m){const s=o(m);if(s!==null)return s}}return null},Jt=(e=[],r)=>{if(!Array.isArray(e)||e.length===0||typeof r!="function")return null;const o=[];if(e.forEach(m=>{if(!(m!=null&&m.data)||!Array.isArray(m.data)||!m.startDate)return;const s=m.data.filter(F=>F&&F.isoDate).map(F=>({...F,displayTemperature:Qt(F)}));if(s.length===0)return;const{ovulationDetails:a}=r(s);if(!(a!=null&&a.confirmed))return;const f=Number.isInteger(a==null?void 0:a.ovulationIndex)?a.ovulationIndex:Number.isInteger(a==null?void 0:a.confirmationIndex)?a.confirmationIndex:null;if(f==null||f<0||f>=s.length)return;const M=s[f],h=Number(M==null?void 0:M.cycleDay);if(!Number.isFinite(h)||h<=0)return;const k=Math.max(1,Math.round(h-8)),T={riseDay:h,t8Day:k,ignored:!!(m!=null&&m.ignoredForAutoCalculations)};!T.ignored&&o.length<12&&o.push(T)}),o.length<6)return null;const N=o.reduce((m,s)=>s.t8Day<m.t8Day?s:m);return{source:"T8",day:Math.max(1,Math.round(N.t8Day)),reason:`t8=${N.t8Day}`,kind:"calculator"}},$e={methods:{alemanas:!0,oms:!0,creighton:!0},calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"conservador"},at=35.8,ct=37.2,gt=(e=[])=>{var z;const r=d=>d&&d.displayTemperature!=null&&!d.ignored,m=d=>{if(!d||d.length!==6)return null;const b=d.map(y=>y.temp);if(b.some(y=>!Number.isFinite(y)))return null;const w=b.reduce((y,P)=>P>y?P:y,b[0]),x=b.reduce((y,P)=>P>=w-.05&&P<w?y+1:y,0);return x>=2?null:{baselineTemp:w,baselineStartIndex:d[0].index,baselineIndices:d.map(y=>y.index),baselineBorderlineCount:x}},s=d=>{const b=[];for(let w=d;w<e.length;w+=1){const x=e[w];if(!r(x))continue;const y=x.displayTemperature;if(Number.isFinite(y)&&(b.push({index:w,temp:y}),b.length>6&&b.shift(),b.length===6)){const P=m(b);if(!P)continue;let j=null;for(let E=w+1;E<e.length;E+=1){const U=e[E];if(!r(U))continue;const D=U.displayTemperature;if(Number.isFinite(D)&&D>P.baselineTemp){j=E;break}}return{baselineTemp:P.baselineTemp,baselineStartIndex:P.baselineStartIndex,baselineIndices:P.baselineIndices,baselineBorderlineCount:P.baselineBorderlineCount,firstHighIndex:j}}}return null},a={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let f=null,M=null,h=null,k=[],T=a,F=0;const re=({baselineTemp:d,firstHighIndex:b})=>{if(b==null)return{confirmed:!1};const w=d+.2,x=[],y=[],P=new Set,j=I=>{I==null||P.has(I)||(P.add(I),y.push(I))};let E=null,U=!1;const D=b>0?b-1:null,X=()=>D!=null?[D,...y]:[...y];for(let I=b;I<e.length;I++){const V=e[I];if(!r(V))break;const q=V.displayTemperature;if(!Number.isFinite(q))break;if(q>d){if(j(I),x.push({index:I,temp:q}),x.length===3&&x[2].temp>=w)return{confirmed:!0,confirmationIndex:x[2].index,usedIndices:X(),highSequenceIndices:[...y],rule:"3-high"};if(x.length===4&&x[2].temp<w&&x[3].temp>d)return{confirmed:!0,confirmationIndex:x[3].index,usedIndices:X(),highSequenceIndices:[...y],rule:"german-3+1"};if(E!==null&&x.length===3&&x[2].temp>=w)return{confirmed:!0,confirmationIndex:x[2].index,usedIndices:X(),highSequenceIndices:[...y],rule:"german-2nd-exception"};if(x.length===5&&x[3].temp>d&&x[4].temp>=w)return{confirmed:!0,confirmationIndex:x[4].index,usedIndices:X(),highSequenceIndices:[...y],rule:"5-high"};continue}if(q>=d-.05&&E===null&&x.length>0&&x.length<3){E=I,j(I),x.push({index:I,temp:d});continue}if(!U&&x.length>0&&x.length<3){U=!0,j(I);continue}break}return{confirmed:!1,usedIndices:X(),highSequenceIndices:[...y]}};for(;F<e.length;){const d=s(F);if(!d)break;if(f=d.baselineTemp,M=d.baselineStartIndex,k=Array.isArray(d.baselineIndices)?[...d.baselineIndices]:[],h=d.firstHighIndex,d.baselineBorderlineCount,h==null){F=M+1;continue}const b=re(d);if(b!=null&&b.requireRebaseline){F=M+1;continue}if(b!=null&&b.confirmed){const w=(z=b.highSequenceIndices)!=null&&z.length?b.highSequenceIndices[0]:null,x=Number.isInteger(b.confirmationIndex)?Math.max(0,Math.min(b.confirmationIndex,e.length-1)):null;let y=null;if(x!=null){const P=x+1;y=Math.max(0,Math.min(P,e.length-1))}T={confirmed:!0,confirmationIndex:x,infertileStartIndex:y,rule:b.rule,highSequenceIndices:b.highSequenceIndices??b.usedIndices,usedIndices:b.usedIndices,ovulationIndex:h??w??null};break}F=M+1}return{baselineTemp:f,baselineStartIndex:M,firstHighIndex:h,baselineIndices:k,ovulationDetails:T}},rn=(e,r,o,N,m,s=5,a=!1,f=null,M=[],h=null,k=!1)=>{const T=_.useRef(null),F=_.useRef(null),[re,z]=_.useState({width:0,height:0}),[d,b]=_.useState(null),[w,x]=_.useState({x:0,y:0}),[y,P]=_.useState(null),j=_.useCallback(()=>{b(null),P(null)},[]),E=n=>{if(n==null)return"";const u=String(n).trim().toUpperCase();return u==="P"||u==="PEAK"?"P":u==="1"||u==="P1"||u==="P+1"?"1":u==="2"||u==="P2"||u==="P+2"?"2":u==="3"||u==="P3"||u==="P+3"?"3":""},U=_.useMemo(()=>zt(e),[e]),D=_.useMemo(()=>{const n=i=>{if(i==null||i==="")return null;const g=parseFloat(String(i).replace(",","."));return Number.isFinite(g)?g:null},u=i=>{if(!i)return null;const g=n(i.temperature),p=n(i.temperature_corrected);return i.use_corrected&&p!==null?p:g!==null?g:p!==null?p:null};return e.map(i=>{const g=[i==null?void 0:i.temperature_chart,i==null?void 0:i.temperature_raw,i==null?void 0:i.temperature_corrected];let p=null;for(const W of g)if(W!=null&&W!==""){p=W;break}if(p==null&&Array.isArray(i==null?void 0:i.measurements)){const Me=i.measurements.find(me=>me&&me.selected&&u(me)!==null)||i.measurements.find(me=>u(me)!==null);Me&&(p=u(Me))}const S=i==null?void 0:i.isoDate,L=(i==null?void 0:i.peak_marker)??(i==null?void 0:i.peakStatus)??null,$=S?U[S]??L:L,A=E($);return{...i,displayTemperature:n(p),peakStatus:$??null,normalizedPeakStatus:A}})},[e,U]),X=_.useMemo(()=>{if(!Array.isArray(D)||D.length===0)return null;const n=new Date;let u=null;return D.forEach((i,g)=>{var p;if(i!=null&&i.isoDate)try{const S=Ke(i.isoDate);if(Number.isNaN((p=S==null?void 0:S.getTime)==null?void 0:p.call(S)))return;xt(S,n)<=0&&(u=g)}catch{}}),u},[D]);_.useLayoutEffect(()=>{const n=()=>{if(!T.current)return;const i=T.current.parentElement||T.current;let g=i.clientWidth||600,p=i.clientHeight||400,S=T.current.clientWidth>0?T.current.clientWidth:g,L,$;if(r){let A=window.innerWidth,W=window.innerHeight;if(a&&W>A&&([A,W]=[W,A]),S=A,o==="portrait"&&!a){const Me=Math.max(30,A*.05);L=(A-Me)/s*e.length}else L=A/s*e.length;$=W}else L=S/s*e.length,$=p;z({width:L,height:$})};n(),window.addEventListener("resize",n);let u;if(T.current){const i=T.current.parentElement||T.current;u=new ResizeObserver(n),u.observe(i)}return()=>{window.removeEventListener("resize",n),u&&u.disconnect()}},[r,e.length,s,o,a]);const I=_.useMemo(()=>D.filter(n=>n&&n.isoDate&&!n.ignored&&n.displayTemperature!==null&&n.displayTemperature!==void 0),[D]),V=_.useMemo(()=>D.filter(n=>n&&n.isoDate),[D]),q=I.length>0,pe=_.useMemo(()=>!Array.isArray(D)||D.length===0?!1:D.some(n=>n?n.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(S=>{const L=n==null?void 0:n[S];return L!=null&&String(L).trim()!==""})||(()=>{const S=(n==null?void 0:n.fertility_symbol)??(n==null?void 0:n.fertilitySymbol);return S==null?!1:String(S).trim()!==""})()||(()=>{const S=(n==null?void 0:n.observations)??(n==null?void 0:n.notes);return S==null?!1:String(S).trim()!==""})()?!0:E((n==null?void 0:n.normalizedPeakStatus)??(n==null?void 0:n.peakStatus)??(n==null?void 0:n.peak_marker))!=="":!1),[D]),Ie=_.useMemo(()=>{var $,A,W,Me,me;const n=f??{},u=(qe,Ue)=>typeof qe=="boolean"?qe:Ue,i={alemanas:u(($=n==null?void 0:n.methods)==null?void 0:$.alemanas,$e.methods.alemanas),oms:u((A=n==null?void 0:n.methods)==null?void 0:A.oms,$e.methods.oms),creighton:u((W=n==null?void 0:n.methods)==null?void 0:W.creighton,$e.methods.creighton)},g={cpm:u((Me=n==null?void 0:n.calculators)==null?void 0:Me.cpm,$e.calculators.cpm),t8:u((me=n==null?void 0:n.calculators)==null?void 0:me.t8,$e.calculators.t8)},S=new Set(["conservador","consenso","permisivo"]).has(n==null?void 0:n.combineMode)?n.combineMode:$e.combineMode,L=!!(n!=null&&n.postpartum);return{methods:i,calculators:g,combineMode:S,postpartum:L}},[f]),se=_.useMemo(()=>{if(Array.isArray(h)&&h.length>0)return h.map(g=>{if(!g)return null;const{source:p,day:S,reason:L}=g,$=typeof p=="string"?p.toUpperCase().replace(/-/g,""):"";if($!=="CPM"&&$!=="T8")return null;const A=Number(S);return Number.isFinite(A)?{source:$,originalSource:p??$,day:A,reason:typeof L=="string"?L:"",kind:"calculator"}:null}).filter(Boolean);const n=Array.isArray(M)?M:[];if(!n.length)return[];const u=Kt(n),i=Jt(n,gt);return[u,i].filter(Boolean)},[h,M]),{peakDayIndex:O,thirdDayIndex:ie,peakInfertilityStartIndex:Se}=_.useMemo(()=>{if(!V.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const n=V.map(g=>(g==null?void 0:g.normalizedPeakStatus)??E((g==null?void 0:g.peakStatus)??(g==null?void 0:g.peak_marker)));let u=null,i=null;if(n.forEach((g,p)=>{g==="P"&&u==null&&(u=p),g==="3"&&i==null&&(i=p)}),u==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(i!=null){const g=V.length-1,p=Math.min(i+1,g);return{peakDayIndex:u,thirdDayIndex:i,peakInfertilityStartIndex:p}}return{peakDayIndex:u,thirdDayIndex:null,peakInfertilityStartIndex:null}},[V]),{baselineTemp:Y,baselineStartIndex:he,firstHighIndex:ve,baselineIndices:Te,ovulationDetails:R}=_.useMemo(()=>gt(D),[D]),v=_.useMemo(()=>({...R??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:Y,baselineIndices:Te,baselineStartIndex:he,firstHighIndex:ve,peakDayIndex:O,peakInfertilityStartIndex:Se,thirdDayIndex:ie}),[R,Y,Te,he,ve,O,Se,ie]),Ae=_.useMemo(()=>Gt({processedData:D,config:Ie,calculatorCandidates:se,context:{peakDayIndex:O,postPeakStartIndex:Se,peakThirdDayIndex:(v==null?void 0:v.thirdDayIndex)??null,temperatureInfertileStartIndex:(v==null?void 0:v.infertileStartIndex)??null,temperatureConfirmationIndex:(v==null?void 0:v.confirmationIndex)??null,temperatureRule:(v==null?void 0:v.rule)??null,todayIndex:X}}),[D,Ie,se,v==null?void 0:v.thirdDayIndex,v==null?void 0:v.infertileStartIndex,v==null?void 0:v.confirmationIndex,v==null?void 0:v.rule,O,Se,X]),Ce=_.useMemo(()=>D.map((n,u)=>{if(!n)return n;const i=Number.isInteger(X)?u>X:!1;return{...n,isFutureDay:i}}),[D,X]),be=_.useMemo(()=>Ce.filter(n=>n&&n.isoDate),[Ce]),{tempMin:Q,tempMax:J}=_.useMemo(()=>{const n=I.map(A=>A.displayTemperature).filter(A=>A!=null);if(n.length===0)return{tempMin:at,tempMax:ct};const u=ct-at,i=Math.min(...n),g=Math.max(...n);let p=Math.min(i,at),S=Math.max(g,ct);const L=A=>Math.floor(A*10)/10,$=A=>Math.ceil(A*10)/10;if(p=L(p),S=$(S),S-p<u){const A=(p+S)/2;p=L(A-u/2),S=$(A+u/2)}return Math.abs(p-i)<1e-9&&(p=L(p-.1)),Math.abs(S-g)<1e-9&&(S=$(S+.1)),{tempMin:parseFloat(p.toFixed(1)),tempMax:parseFloat(S.toFixed(1))}},[I]),ge=J-Q,Z=re.width,ee=re.height,xe=9,ue=(n=1)=>{if(!r)return xe*n;const u=Math.min(Z,ee);return Math.max(8,Math.min(xe*n,u/(be.length>0?40/n:40)))},G=Math.round(ue(r?1.6:2)),le=a||o==="landscape",de=r?9:7.5,_e=de+(k?r?2:1.5:0),Ne=r?1:.75,ae=Math.round(G*(de+Ne)),ze=Math.round(G*(_e+Ne)),ke=ae,H=k?Math.max(0,ze-ae):0,te=k?ze:ae,B=Math.max(ee-te,G*(r?10:8)),Be=te+Math.max(B,0),Le=Be+H,ce={top:r?Math.max(le?6:12,ee*(le?.015:.03)):12,right:r?Math.max(le?35:30,Z*(le?.02:.05)):50,bottom:Math.max(0,ke-1),left:r?Math.max(le?45:20,Z*(le?.02:.05)):50},je=Math.max(0,Math.round(G*4)),Oe=Be-ce.bottom-je,He=n=>{const u=Be-ce.top-ce.bottom-je;return n==null||ge===0||u<=0?Oe:Oe-(n-Q)/ge*u},We=n=>{const u=r&&!(a||o==="landscape")?5:10,i=r&&!(a||o==="landscape")?25:0,g=Z-ce.left-ce.right-u-i*(be.length-1);if(g<=0)return ce.left+u+i*n;const p=be.length>1?be.length-1:1;return p===0||be.length===0?ce.left+u+i*n:ce.left+u+n*(g/(be.length===1?1:p))+i*n},Ze=(n,u,i)=>{if(!n){j();return}const g=T.current.getBoundingClientRect();let p,S;if(i.type.startsWith("touch")){const W=i.changedTouches[0];p=W.clientX,S=W.clientY}else p=i.clientX,S=i.clientY;const L=We(u),$=n.displayTemperature??n.temperature_chart??null,A=He($);x({svgX:L,svgY:A,clientX:p-g.left+T.current.scrollLeft,clientY:S-g.top+T.current.scrollTop}),P(u),b(n)};_.useEffect(()=>{const n=u=>{var i;if(F.current&&!F.current.contains(u.target)){const g=(i=T.current)==null?void 0:i.querySelectorAll("circle, text, rect");let p=!1;if(g){for(let S of g)if(S.contains(u.target)){p=!0;break}}p||j()}};return d&&(document.addEventListener("mousedown",n),document.addEventListener("touchstart",n)),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}},[d,j]);const et=n=>{N&&n&&(N(m,n),j())};return{chartRef:T,tooltipRef:F,dimensions:{...re,contentHeight:Be,scrollableContentHeight:Le,extraScrollableHeight:H,viewportHeight:ee},activePoint:d,activeIndex:y,tooltipPosition:w,processedData:Ce,validDataForLine:I,allDataPoints:be,tempMin:Q,tempMax:J,tempRange:ge,padding:ce,textRowHeight:G,setActivePoint:b,setActiveIndex:P,getY:He,getX:We,handlePointInteraction:Ze,clearActivePoint:j,handleToggleIgnore:et,responsiveFontSize:ue,baselineTemp:Y,baselineStartIndex:he,baselineIndices:Te,firstHighIndex:ve,ovulationDetails:v,fertilityStart:Ae,hasTemperatureData:q,hasAnyObservation:pe,graphBottomInset:je,todayIndex:X}};export{nn as C,Kt as a,Jt as b,gt as c,rn as u};
