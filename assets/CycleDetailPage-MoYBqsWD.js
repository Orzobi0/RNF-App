import{c as ce,v as oe,a as ne,u as de,b as ue,r as l,k as V,f as g,w as u,j as e,L as F,t as me,B as w,o as H,n as ye}from"./index-ByFXgX-t.js";import{D as he}from"./DeletionDialog-Da12udM-.js";import{u as pe,D as U,a as z,b as X,c as J,d as W,e as Y}from"./useCycleData-BwqH7MfP.js";import{a as L,H as De}from"./HeaderIconButton-9FbpFFvA.js";import{RecordsExperience as fe}from"./RecordsPage-BpP3kG0n.js";import{A as ge}from"./arrow-left-RIrLE-V6.js";import{P as xe}from"./useBackClose-BFeNma-P.js";import"./PostpartumExitDialog-81hY3wEb.js";import"./badge-CetW1kHg.js";import"./DataEntryForm-B10-vrnA.js";import"./label--L53Nrbo.js";import"./computePeakStatuses-hwVxT-Am.js";import"./peak-mode-button-DTRv1E4U.js";import"./eye-CfXbXuuz.js";const Ce=ce("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),Ee=(r,m)=>{const i=H(g(r)),c=H(g(m));return ye(i,c)+1},ve=(r,m)=>!r||!Array.isArray(r)||!m?[]:[...r].sort((c,x)=>g(c.isoDate)-g(x.isoDate)).map(c=>({...c,ignored:c.ignored||!1,cycleDay:Ee(c.isoDate,m)})),N={[u.DELETE]:"Eliminar ciclo y registros (dejar hueco)",[u.MERGE_PREV]:"Fusionar con el ciclo anterior",[u.MERGE_NEXT]:"Fusionar con el ciclo siguiente"},$e=()=>{const{cycleId:r}=oe(),m=ne(),{user:i}=de(),{getCycleById:c,isLoading:x,addOrUpdateDataPoint:P,deleteRecord:T,updateCycleDates:I,deleteCycle:M,previewDeleteCycle:_,deleteArchivedCycleWithStrategy:A,checkCycleOverlap:Z,refreshData:$,getPublicError:C}=pe(),{toast:d}=ue(),[t,B]=l.useState(null),[k,E]=l.useState(!1),[y,O]=l.useState(!1),[p,v]=l.useState(null),[D,j]=l.useState(null),[q,S]=l.useState(!1),R=t?`${V(g(t.startDate),"dd/MM/yyyy")} - ${t.endDate?V(g(t.endDate),"dd/MM/yyyy"):"En curso"}`:"",K=l.useMemo(()=>[{value:u.MERGE_PREV,title:N[u.MERGE_PREV],description:"Mueve todos los registros al ciclo anterior y extiende su fecha de fin."},{value:u.DELETE,title:N[u.DELETE],description:"Borra el ciclo completo y todos sus registros asociados."},{value:u.MERGE_NEXT,title:N[u.MERGE_NEXT],description:"Mueve todos los registros al ciclo siguiente y adelanta su fecha de inicio."}],[]),h=l.useCallback(()=>{E(!1),v(null),j(null),S(!1)},[]),b=l.useCallback(a=>{if(!i||!a?.id)return;const s={...a,data:(a.data||[]).map(({cycleDay:o,...n})=>n)};localStorage.setItem(`fertilityData_cycle_${i.uid}_${a.id}`,JSON.stringify(s))},[i]),f=l.useCallback(async()=>{if(!i||!r)return null;const a=await c(r);return a&&(b(a),B(a)),a},[r,c,b,i]);l.useEffect(()=>{(async()=>{if(!i)return;let s=await c(r);if(!s){const o=localStorage.getItem(`fertilityData_cycle_${i.uid}_${r}`);if(o){const n=JSON.parse(o);s={...n,data:ve(n.data||[],n.startDate)}}}s?(b(s),B(s)):(d({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),m("/archived-cycles"))})()},[r,i,c,d,m,b]);const Q=l.useCallback(async(a,s)=>{if(!t?.id||!i)return;const o=!!s;await P(a,s,t.id),await f()&&d({title:o?"Registro actualizado":"Nuevo registro añadido",description:"Datos del ciclo actualizados."})},[t?.id,i,P,f,d]),ee=l.useCallback(async a=>{!t?.id||!i||(await T(a,t.id),await f(),d({title:"Registro eliminado",description:"El registro ha sido eliminado."}))},[t?.id,i,T,f,d]),ae=l.useCallback(async(a,s,o)=>{const n=a??t?.id;!i||!n||await I(n,s,o)},[t?.id,i,I]),te=l.useCallback(async a=>{await $(a),await f()},[$,f]),se=l.useCallback(()=>{if(!t?.endDate){E(!0);return}h(),E(!0)},[t?.endDate,h]),le=l.useCallback(async a=>{if(t?.id){v(a),S(!0);try{const s=await _(t.id,a);j(s)}catch(s){const o=C(s);d({title:o?.title||"Error",description:o?.message||"No se pudo preparar la vista previa.",variant:"destructive"}),v(null),j(null)}finally{S(!1)}}},[t?.id,C,_,d]),G=l.useCallback(async()=>{if(!(!t?.id||!i)){O(!0);try{p&&t?.endDate?await A(t.id,p):await M(t.id),d({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),m("/archived-cycles")}catch(a){const s=C(a);d({title:s?.title||"Error",description:s?.message||"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{O(!1),h()}}},[t?.id,t?.endDate,A,M,C,m,h,p,d,i]),ie=l.useCallback(()=>e.jsx(L,{asChild:!0,className:"shrink-0 text-fertiliapp-fuerte",children:e.jsxs(F,{to:"/archived-cycles","aria-label":"Volver a mis ciclos",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Mis ciclos"})]})}),[]),re=l.useCallback(({openDateEditor:a,openAddRecord:s,isProcessing:o,isDateEditorOpen:n})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{type:"button",onClick:a,"data-date-editor-toggle":"true","aria-pressed":n,"aria-expanded":n,className:"date-editor-toggle","aria-label":"Editar fechas del ciclo",children:e.jsx(Ce,{className:"h-4 w-4"})}),e.jsx(L,{asChild:!0,children:e.jsx(F,{to:`/chart/${r}`,"aria-label":"Ver gráfica del ciclo",children:e.jsx(me,{className:"h-4 w-4"})})}),e.jsx(De,{type:"button",onClick:s,disabled:o,"aria-label":"Añadir registro al ciclo",children:e.jsx(xe,{className:"h-4 w-4"})})]}),[r]);return x&&!t||!t?e.jsx("div",{className:"flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:e.jsx("p",{children:"Cargando detalles del ciclo..."})}):e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[e.jsx(fe,{cycle:t,isLoading:x,addOrUpdateDataPoint:Q,deleteRecord:ee,updateCycleDates:ae,checkCycleOverlap:Z,refreshData:te,includeEndDate:!0,headerActions:re,topAccessory:ie,onRequestDeleteCycle:se,isDeletingCycle:y,dateEditorDeleteDescription:"Se eliminará este ciclo y todos sus registros."}),e.jsx(he,{isOpen:k&&!t?.endDate,onClose:()=>E(!1),onConfirm:G,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:R?`¿Estás seguro de que quieres eliminar el ciclo ${R}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:y}),e.jsx(U,{open:k&&!!t?.endDate&&!p,onOpenChange:a=>!a&&h(),children:e.jsxs(z,{children:[e.jsxs(X,{children:[e.jsx(J,{children:"Eliminar ciclo archivado"}),e.jsx(W,{children:"Elige cómo quieres eliminar el ciclo. Puedes borrar todo o fusionar sus registros con un ciclo vecino."})]}),e.jsx("div",{className:"space-y-3",children:K.map(a=>e.jsxs(w,{type:"button",variant:"outline",className:`h-auto w-full flex-col items-start gap-1 text-left ${a.value===u.DELETE?"border-red-200 bg-red-100/20 hover:bg-red-200/80":"border-gray-300 bg-slate-50 hover:bg-slate-100"}`,disabled:q||y,onClick:()=>le(a.value),children:[e.jsx("span",{className:`font-semibold ${a.value===u.DELETE?"text-red-700":"text-slate-800"}`,children:a.title}),e.jsx("span",{className:"text-xs text-slate-600",children:a.description})]},a.value))}),e.jsx(Y,{children:e.jsx(w,{type:"button",variant:"outline",onClick:h,disabled:q||y,children:"Cancelar"})})]})}),e.jsx(U,{open:k&&!!p&&!!D,onOpenChange:a=>!a&&h(),children:e.jsxs(z,{children:[e.jsxs(X,{children:[e.jsx(J,{children:"Vista previa"}),e.jsx(W,{children:"Revisa el impacto antes de confirmar."})]}),e.jsxs("div",{className:"space-y-3 text-sm text-slate-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Estrategia:"})," ",N[p]]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Impacto:"})," ",D?.impactSummary?.trimmedCycles??0," ciclos ajustados,"," ",D?.impactSummary?.deletedCycles??0," eliminados,"," ",D?.impactSummary?.movedEntries??0," registros movidos."]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-800",children:"Ciclos afectados"}),e.jsx("ul",{className:"mt-1 list-disc pl-5",children:(D?.affectedCycles??[]).map(a=>e.jsxs("li",{children:[a.startDate," → ",a.endDate??"en curso"]},a.cycleId))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-800",children:"Cómo quedarán"}),e.jsx("ul",{className:"mt-1 list-disc pl-5",children:(D?.adjustedCyclesPreview??[]).map(a=>e.jsxs("li",{children:[a.type==="delete"?"Eliminar":"Ajustar"," ciclo: ",a.startDate," → ",a.endDate??"en curso"]},`${a.cycleId}-${a.type}`))})]})]}),e.jsxs(Y,{className:"gap-2",children:[e.jsx(w,{type:"button",variant:"outline",onClick:()=>{v(null),j(null)},disabled:y,children:"Atrás"}),e.jsx(w,{type:"button",onClick:G,disabled:y,children:y?"Confirmando…":"Confirmar"})]})]})})]})};export{$e as default};
