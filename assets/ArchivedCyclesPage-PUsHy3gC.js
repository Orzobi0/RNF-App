import{c as xe,r,j as e,B as I,g as D,f as n,b as fe,a as me,m as G,A as te,L as pe,C as se,o as ge}from"./index-C041RoKp.js";import{D as ye,a as ve,b as be,c as je,d as Ce,e as we,u as Ne}from"./useCycleData-fUMApAkg.js";import{u as De,P as ae,l as re,B as Ee}from"./badge-BbO7fxzd.js";import{I as le}from"./input-D9upNPQ0.js";import{O as Se}from"./OverlapWarningDialog-CRNazV6l.js";import{D as Me}from"./DeletionDialog-BtycWigc.js";const ke=xe("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),X=({isOpen:b,onClose:j,onConfirm:R,initialStartDate:E,initialEndDate:m,includeEndDate:u=!0,title:H="Editar Fechas del Ciclo",description:V,cycleId:q,checkOverlap:B,errorMessage:S,conflictCycle:h,onResetError:p})=>{const[a,M]=r.useState(E||""),[i,C]=r.useState(m||""),[$,g]=r.useState(""),[w,y]=r.useState(null),[k,N]=r.useState(null),[A,T]=r.useState(!1);De(b,j),r.useEffect(()=>{M(E||""),C(m||"")},[E,m]);const W=()=>{if(!h)return null;const l=F=>{if(!F)return null;try{return D(n(F),"dd/MM/yyyy")}catch(K){return console.error("Error formatting conflict date",K),F}},x=l(h.startDate)??"sin fecha de inicio",z=h.endDate?l(h.endDate):"en curso";return`Conflicto con el ciclo del ${x} al ${z}.`},J=()=>{g(""),p&&p()},d=l=>{M(l),J()},O=l=>{C(l),g(""),p&&p()},v=W(),Y=async()=>{if(u&&!i){g("La fecha de fin es obligatoria");return}if(u&&a&&i&&i<a){g("La fecha de fin no puede ser anterior al inicio");return}const l=u?{startDate:a,endDate:i}:{startDate:a};if(B&&q&&a){const x=await B(q,a,u&&i||void 0);if(x){y(x),N(l),T(!0);return}}R(l)};return e.jsxs(e.Fragment,{children:[e.jsx(ye,{open:b,onOpenChange:j,children:e.jsxs(ve,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(be,{children:[e.jsx(je,{children:H}),e.jsx(Ce,{className:"text-gray-600",children:V??(u?"Modifica la fecha de inicio y fin del ciclo.":"Modifica la fecha de inicio del ciclo.")})]}),(S||h)&&e.jsxs("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[e.jsx("p",{className:"font-semibold text-red-800",children:"No se pudo guardar el ciclo"}),S&&e.jsx("p",{className:"mt-1",children:S}),v&&e.jsx("p",{className:"mt-1",children:v}),e.jsx("p",{className:"mt-3 text-xs text-red-600",children:"Ajusta las fechas para que no se superpongan con ciclos existentes."})]}),e.jsxs("div",{className:"my-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Inicio del ciclo"}),e.jsx(le,{id:"startDate",type:"date",value:a,onChange:l=>d(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),u&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"text-gray-700 text-sm",children:"Fin del ciclo"}),e.jsx(le,{id:"endDate",type:"date",value:i||"",onChange:l=>O(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"}),$&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:$})]})]}),e.jsxs(we,{className:"sm:justify-end",children:[e.jsx(I,{variant:"outline",onClick:j,className:"border-gray-300 text-titulo hover:bg-gray-100",children:"Cancelar"}),e.jsx(I,{variant:"primary",onClick:Y,className:"bg-pink-600 hover:bg-pink-700 text-white",children:"Guardar"})]})]})}),e.jsx(Se,{isOpen:A,conflictCycle:w,onCancel:()=>T(!1),onConfirm:()=>{T(!1),k&&R({...k,force:!0})}})]})},Ie=()=>{const{currentCycle:b,archivedCycles:j,isLoading:R,addArchivedCycle:E,updateCycleDates:m,deleteCycle:u,checkCycleOverlap:H,forceUpdateCycleStart:V,forceShiftNextCycleStart:q}=Ne(),{toast:B}=fe(),S=me(),[h,p]=r.useState(!1),[a,M]=r.useState(null),[i,C]=r.useState(null),[$,g]=r.useState(!1),[w,y]=r.useState(null),[k,N]=r.useState(null),[A,T]=r.useState("all"),[W,J]=r.useState(!1),d=r.useRef(null),O=r.useRef(!1),v=r.useRef(!1),Y=t=>{if(!t)return"Las fechas ingresadas se superponen con otro ciclo.";const s=f=>{if(!f)return null;try{return D(n(f),"dd/MM/yyyy")}catch(U){return console.error("Error parsing conflict date",U),f}},c=s(t.startDate)??"sin fecha de inicio",o=t.endDate?s(t.endDate):"en curso";return`Las fechas ingresadas se superponen con el ciclo del ${c} al ${o}.`},l=()=>{y(null),p(!0)},x=()=>{p(!1),y(null)},z=async({startDate:t,endDate:s})=>{try{await E(t,s),x()}catch(c){const o=c.code==="cycle-overlap"?Y(c.conflictCycle):"No se pudo crear el ciclo.";y({message:o,conflictCycle:c.conflictCycle||null})}},F=async({startDate:t,endDate:s,force:c})=>{if(a)try{const o=a.startDate,f=a.endDate,U=t!==void 0&&t!==o,de=s!==void 0&&s!==f,ue=U&&o&&t&&n(t)<n(o),he=U?t:o,ee=de?s:f;c&&ue?(await V(a.id,t),s!==void 0&&await m(a.id,void 0,s)):c&&ee?(await q(a.id,ee,he),await m(a.id,t,s)):await m(a.id,t,s),M(null),N(null)}catch(o){const f=o.code==="cycle-overlap"?Y(o.conflictCycle):"No se pudieron actualizar las fechas.";N({message:f,conflictCycle:o.conflictCycle||null})}},K=t=>{C(t)},ie=async()=>{if(i){g(!0);try{await u(i.id),B({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),C(null)}catch(t){console.error("Error deleting archived cycle:",t)}finally{g(!1)}}},ne=t=>{S(t.isCurrent?"/":`/cycle/${t.id}`)},Z=t=>{O.current=!1,d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{O.current=!0,K(t)},1500)},L=(t,s=!0)=>{d.current&&(clearTimeout(d.current),d.current=null),!O.current&&s&&ne(t)};r.useEffect(()=>()=>{d.current&&clearTimeout(d.current)},[]);const P=b.id?[{...b,isCurrent:!0,needsCompletion:!b.endDate},...j]:j,oe=P&&P.length>0;if(R&&!oe)return e.jsx("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:e.jsx("div",{className:"text-center text-slate-600 p-8",children:"Cargando ciclos archivados..."})});if(!P||P.length===0)return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"flex flex-1 items-center justify-center px-4",children:e.jsx(G.div,{className:"text-center text-slate-600 flex flex-col items-center max-w-md",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"bg-white/70 mt-6 backdrop-blur-md rounded-3xl p-8 border border-pink-200/50 shadow-sm",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center",children:e.jsx(te,{className:"w-10 h-10 text-subtitulo"})}),e.jsx("h2",{className:"text-2xl font-semibold text-subtitulo mb-4",children:"No hay ciclos archivados"}),e.jsx("p",{className:"text-subtitulo mb-8",children:"Cuando inicies un nuevo ciclo, el anterior aparecerá aquí."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(I,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl hover:brightness-95 text-white shadow-sm",children:e.jsx(pe,{to:"/",children:"Volver al Ciclo Actual"})}),e.jsxs(I,{onClick:l,className:"bg-fertiliapp-fuerte hover:brightness-95 rounded-3xl text-white shadow-sm",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"})," Crear Ciclo"]})]})]})})}),e.jsx(X,{isOpen:h,onClose:x,onConfirm:z,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:w?.message,conflictCycle:w?.conflictCycle,onResetError:()=>y(null)})]});const Q=[...P].sort((t,s)=>n(s.startDate)-n(t.startDate)),ce=Array.from(new Set(Q.map(t=>{try{return n(t.startDate).getFullYear()}catch(s){return console.error("Error parsing startDate for year filter",s),null}}).filter(Boolean))).sort((t,s)=>s-t),_=A==="all"?Q:Q.filter(t=>{try{return n(t.startDate).getFullYear()===Number(A)}catch(s){return console.error("Error filtering cycle by year",s),!1}});return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[e.jsx("div",{className:"relative z-10 flex flex-1",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 py-6 flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col",children:[e.jsxs(G.div,{className:"flex items-center justify-between gap-3 mb-6",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-subtitulo flex items-center",children:[e.jsx(te,{className:"mr-3 h-8 w-8 text-subtitulo"}),"Mis Ciclos"]}),e.jsxs("div",{className:"flex flex-row items-center gap-3",children:[e.jsxs(I,{onClick:l,className:"flex-shrink-0 text-md font-semibold rounded-full bg-white/90 border border-secundario hover:brightness-95 text-secundario shadow-sm px-2",style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(ae,{className:"mr-1 h-4 w-4"})," Ciclo"]}),e.jsx("button",{type:"button",onClick:()=>J(t=>!t),className:"inline-flex h-10 w-10 items-center justify-center rounded-full border border-fertiliapp-fuerte bg-white/90 shadow-sm hover:bg-white","aria-label":"Filtrar por año",children:e.jsx(ke,{className:"h-5 w-5 text-fertiliapp-fuerte"})})]})]}),W&&e.jsx("div",{className:"mb-4 flex w-full justify-center",children:e.jsxs("div",{className:"flex w-full max-w-md items-center gap-2 rounded-3xl border border-fertiliapp-suave bg-white/90 px-3 py-2 shadow-sm",children:[e.jsx("span",{className:"text-xs font-medium text-slate-700",children:"Año"}),e.jsxs("select",{id:"year-filter",value:A,onChange:t=>T(t.target.value),className:"flex-1 rounded-3xl border border-pink-100 bg-white px-3 py-2 text-sm text-slate-700 shadow-inner focus:outline-none focus:ring-2 focus:ring-pink-300",children:[e.jsx("option",{value:"all",children:"Todos"}),ce.map(t=>e.jsx("option",{value:t,children:t},t))]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-1 sm:pr-0 pb-6",children:e.jsxs(G.div,{className:"space-y-4 px-1",variants:{hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"show",children:[_.map(t=>{const s=t.endDate?D(n(t.endDate),"dd/MM/yyyy",{locale:re}):"En curso",c=t.data?t.data.length:0;return e.jsx(G.button,{type:"button",className:"w-full max-w-[480px] mx-auto bg-white/80 backdrop-blur-md border border-fertiliapp-suave shadow-sm hover:shadow-sm transition-all duration-300 hover:bg-white/90 rounded-3xl active:scale-[0.98] cursor-pointer select-none",variants:{hidden:{opacity:0,y:20},show:{opacity:1,y:0}},onMouseDown:()=>Z(t),onMouseUp:()=>L(t),onMouseLeave:()=>L(t,!1),onTouchStart:()=>{v.current=!1,Z(t)},onTouchMove:()=>{v.current=!0,L(t,!1)},onTouchEnd:()=>{v.current?(v.current=!1,L(t,!1)):L(t,!0)},children:e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"w-12 h-12 bg-fertiliapp rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(se,{className:"w-6 h-6 text-white"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center flex-wrap gap-2 mb-1.5",children:e.jsxs("h2",{className:"text-lg font-semibold text-slate-700",children:[D(n(t.startDate),"dd/MM/yyyy",{locale:re})," - ",s]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-2 text-sm text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ge,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[c," registro",c!==1?"s":""]})]}),t.endDate&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(se,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[Math.ceil((n(t.endDate)-n(t.startDate))/(1e3*60*60*24))+1," días"]})]}),t.isCurrent&&e.jsx(Ee,{className:"bg-fertiliapp-fuerte text-white text-xs",children:"Ciclo actual"})]})]})]})})},t.id)}),_.length===0&&e.jsx("div",{className:"mt-6 rounded-3xl border border-dashed border-fertiliapp-suave bg-white/70 p-6 text-center text-slate-600 shadow-inner",children:"No hay ciclos para el año seleccionado."})]})})]})}),e.jsx(X,{isOpen:h,onClose:x,onConfirm:z,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:w?.message,conflictCycle:w?.conflictCycle,onResetError:()=>y(null)}),e.jsx(X,{isOpen:!!a,onClose:()=>{M(null),N(null)},onConfirm:F,initialStartDate:a?.startDate,initialEndDate:a?.endDate,cycleId:a?.id,checkOverlap:H,title:"Editar Fechas del Ciclo",description:"Actualiza las fechas del ciclo.",errorMessage:k?.message,conflictCycle:k?.conflictCycle,onResetError:()=>N(null)}),e.jsx(Me,{isOpen:!!i,onClose:()=>C(null),onConfirm:ie,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:i?`¿Estás seguro de que quieres eliminar el ciclo ${D(n(i.startDate),"dd/MM/yyyy")} - ${i.endDate?D(n(i.endDate),"dd/MM/yyyy"):"En curso"}? Esta acción no se puede deshacer.`:"",isProcessing:$})]})};export{Ie as default};
