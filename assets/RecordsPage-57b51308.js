import{c as Wt,r as n,f as y,g as h,j as s,I as w,B as Se,N as Aa,b as Ta,Q as S,l as Q,S as Fa,O as Ht,n as Ia,m as pe}from"./index-a7b876ee.js";import{L as lt,T as La,P as Oa,C as Ra}from"./CycleDatesEditor-2252eb48.js";import{T as Pa,h as za,f as Ba,d as Ha,c as Va,m as Vt,j as je,i as Be,k as Ua,A as Xa,l as qa,D as $a,F as Ut}from"./computePeakStatuses-93cb3295.js";import{e as ct,P as Ya}from"./badge-a7e9b0c3.js";import{D as Ga}from"./DeletionDialog-d77cbaeb.js";import{u as Wa,D as Ka,a as Qa}from"./useCycleData-3c889a19.js";import{e as Za}from"./checkbox-7666851b.js";import"./OverlapWarningDialog-becbd304.js";import"./input-4ca4bf6c.js";import"./label-c685ab7e.js";import"./eye-a5e52431.js";const ut=Wt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),Ja=Wt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),es=({isoDate:g,cycleDay:k,details:i,peakStatus:Z,isPeakDay:he,onEdit:b,onDelete:ke,onAdd:P,onToggleRelations:ge,isProcessing:j})=>{var ae,Te,H,se;const _e=!!(i!=null&&i.record),He=n.useMemo(()=>{if(!g)return null;try{return y(h(g),"dd/MM/yyyy",{locale:ct})}catch{return null}},[g]),be=((ae=i==null?void 0:i.symbolInfo)==null?void 0:ae.label)||"Sin símbolo",Ee=((Te=i==null?void 0:i.symbolInfo)==null?void 0:Te.value)||"none",Ve=((H=i==null?void 0:i.symbolInfo)==null?void 0:H.pattern)==="spotting-pattern"?"spotting-pattern-icon":"",Me=()=>{!(i!=null&&i.record)||!b||b(i.record,null)},J=()=>{var v;!((v=i==null?void 0:i.record)!=null&&v.id)||!ke||ke(i.record.id)},Ue=()=>{!g||!P||P(g)},T=(v,F=null)=>{if(i!=null&&i.record&&b){b(i.record,v,F);return}g&&P&&P(g,v,F)},Xe=()=>{!g||!ge||ge(g)},z=(v,F={})=>v&&typeof v=="string"&&v.trim().length>0||typeof v=="number"?v:F.placeholder||"—",qe=i!=null&&i.hasTemperature?`${i.displayTemp} °C`:"—",$e=(i==null?void 0:i.timeValue)||"—",Ye=!!(i!=null&&i.timeValue),Ge=i!=null&&i.hasMucusSensation?i.mucusSensation:"—",We=i!=null&&i.hasMucusAppearance?i.mucusAppearance:"—",Ae=(se=i==null?void 0:i.observationsText)==null?void 0:se.trim(),ee=!!(i!=null&&i.hasRelations);let te=null,xe=null;Z&&(Z==="P"||he?(te="Día pico",xe="peak"):(te=`+${Z}`,xe="post-peak"));const e=()=>{switch(Ee){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!g)return s.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const B="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return s.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("p",{className:"text-base font-semibold text-rose-700 sm:text-lg",children:[He,k?` · D${k}`:""]}),te&&s.jsx("span",{className:w("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:te})]}),s.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[s.jsx("button",{type:"button",onClick:()=>T("symbol","fertilitySymbol"),className:w("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",e(),Ve),title:be,"aria-label":be}),_e?s.jsxs(s.Fragment,{children:[s.jsxs(Se,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-rose-500 hover:bg-rose-50",onClick:Me,disabled:j,children:[j?s.jsx(lt,{className:"h-4 w-4 animate-spin"}):s.jsx(Ja,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Editar registro"})]}),s.jsxs(Se,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-rose-500 hover:bg-rose-50",onClick:J,disabled:j,children:[j?s.jsx(lt,{className:"h-4 w-4 animate-spin"}):s.jsx(La,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):s.jsxs(Se,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:Ue,disabled:j,children:[j&&s.jsx(lt,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),s.jsxs("div",{className:"mt-4 space-y-3",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>T("temperature","temperature"),className:w(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[s.jsx(Pa,{className:"h-5 w-5 opacity-80"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"font-semibold",children:z(qe)}),(i==null?void 0:i.showCorrectedIndicator)&&s.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),s.jsxs("button",{type:"button",onClick:()=>T("temperature","time"),className:w(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ye?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[s.jsx(za,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"font-semibold",children:z($e)})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>T("sensation","mucusSensation"),className:w(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[s.jsx(Ba,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"font-semibold",children:z(Ge)})]}),s.jsxs("button",{type:"button",onClick:()=>T("appearance","mucusAppearance"),className:w(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i!=null&&i.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[s.jsx(Ha,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"font-semibold",children:z(We)})]})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>T("observations","observations"),className:w(B,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ae?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[s.jsx(ut,{className:"h-5 w-5 opacity-80"}),s.jsx("span",{className:"truncate",children:z(Ae,{placeholder:"-"})})]}),s.jsx("button",{type:"button",onClick:Xe,disabled:j,className:w("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",ee?"border-rose-500 bg-rose-50":"border-slate-200 bg-white",j&&"opacity-70 cursor-not-allowed"),title:ee?"Hubo relaciones":"Sin relaciones","aria-label":ee?"Hubo relaciones":"Sin relaciones",children:s.jsx(Aa,{className:w("h-4 w-4",ee?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},ts=g=>Ut.find(k=>k.value===g)||Ut[0],Xt=10,qt=60,$t=400,Yt=120,Gt=85,as=5,Ne=160,ss=g=>{if(g==null||g==="")return null;const k=Number(typeof g=="string"?g.replace(",","."):g);return Number.isFinite(k)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(k):null},rs=({cycle:g,headerTitle:k="Mis Registros",headerIcon:i=ut,headerActions:Z,topAccessory:he,includeEndDate:b=!1,initialCalendarOpen:ke=!0,addOrUpdateDataPoint:P,deleteRecord:ge,isLoading:j,updateCycleDates:_e,checkCycleOverlap:He,forceShiftNextCycleStart:be,forceUpdateCycleStart:Ee,refreshData:Ve,afterRecordsContent:Me=null,onRequestDeleteCycle:J=null,dateEditorDeleteTitle:Ue="Eliminar ciclo",dateEditorDeleteDescription:T="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:Xe="Eliminar ciclo",isDeletingCycle:z=!1}={})=>{const{currentCycle:qe,addOrUpdateDataPoint:$e,deleteRecord:Ye,isLoading:Ge,updateCycleDates:We,checkCycleOverlap:Ae,forceUpdateCycleStart:ee,forceShiftNextCycleStart:te,refreshData:xe}=Wa(),e=g??qe,B=j??Ge,ae=P||(async(t,r)=>{if(e!=null&&e.id)return $e(t,r,e.id)}),Te=ge||(async t=>{if(e!=null&&e.id)return Ye(t,e.id)}),H=_e||(async(t,r,a)=>We(t??(e==null?void 0:e.id),r,a)),se=He??Ae,v=Ee||(async(t,r)=>ee(t??(e==null?void 0:e.id),r)),F=be||(async(t,r,a)=>te(t??(e==null?void 0:e.id),r,a)),Fe=Ve??xe,{toast:N}=Ta(),[Kt,re]=n.useState(!1),[Ke,ne]=n.useState(null),[oe,Qe]=n.useState(null),[ie,le]=n.useState(!1),[Qt,dt]=n.useState(!1),[V,Ie]=n.useState(()=>(e==null?void 0:e.startDate)||""),[U,Le]=n.useState(()=>(e==null?void 0:e.endDate)||""),[Zt,I]=n.useState(""),[L,ft]=n.useState(null),[Ze,mt]=n.useState(null),[Je,pt]=n.useState(!1),[Jt,ht]=n.useState(null),[ea,et]=n.useState(!1),[tt,ve]=n.useState(!1),[f,X]=n.useState(null),[ta,q]=n.useState(null),[aa,we]=n.useState(null),[sa,ye]=n.useState(null),[$,Oe]=n.useState(ke),Re=n.useRef(null),gt=n.useRef(null),bt=n.useRef(0),[xt,vt]=n.useState(0),Pe=n.useCallback(()=>{const t=Re.current;if(!t){bt.current=0,vt(0);return}const a=t.getBoundingClientRect().height;bt.current=a,vt(o=>Math.abs(o-a)>.5?a:o)},[]);n.useLayoutEffect(()=>{let t=window.requestAnimationFrame(Pe);const r=()=>{t&&window.cancelAnimationFrame(t),t=window.requestAnimationFrame(Pe)};window.addEventListener("resize",r);let a;return typeof ResizeObserver<"u"&&(a=new ResizeObserver(()=>{t&&window.cancelAnimationFrame(t),t=window.requestAnimationFrame(Pe)}),Re.current&&a.observe(Re.current)),()=>{window.removeEventListener("resize",r),a&&a.disconnect(),t&&window.cancelAnimationFrame(t)}},[Pe]);const wt=n.useMemo(()=>Math.max(Math.round(xt+Xt),Xt),[xt]);n.useEffect(()=>{Ie((e==null?void 0:e.startDate)||""),Le((e==null?void 0:e.endDate)||"")},[e==null?void 0:e.startDate,e==null?void 0:e.endDate]);const ce=n.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?[...e.data].filter(r=>r==null?void 0:r.isoDate).sort((r,a)=>{const o=h(r.isoDate);return h(a.isoDate)-o}).map(r=>r.isoDate):[]},[e==null?void 0:e.data]);n.useEffect(()=>{const t=gt.current;t&&t.scrollTo({top:0,behavior:"auto"})},[]);const ue=n.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?e.data.map(r=>{if(!(r!=null&&r.isoDate))return null;const a=h(r.isoDate);return S(a)?a:null}).filter(Boolean):[]},[e==null?void 0:e.data]),yt=n.useMemo(()=>new Set(ce),[ce]),at=n.useMemo(()=>Va((e==null?void 0:e.data)??[]),[e==null?void 0:e.data]),de=n.useMemo(()=>{var r;const t=new Map;return(r=e==null?void 0:e.data)!=null&&r.length&&e.data.forEach(a=>{var Bt;if(!(a!=null&&a.isoDate))return;const o=((Bt=a.measurements)==null?void 0:Bt.find(it=>it==null?void 0:it.selected))||(a.temperature_chart||a.temperature_raw?{temperature:a.temperature_chart??a.temperature_raw,temperature_corrected:a.temperature_corrected??null,time:a.timestamp?y(h(a.timestamp),"HH:mm"):null,use_corrected:a.use_corrected??!1}:null),c=(o==null?void 0:o.use_corrected)??a.use_corrected??!1,u=(o==null?void 0:o.temperature_corrected)??a.temperature_corrected??null,m=(o==null?void 0:o.temperature)??a.temperature_chart??a.temperature_raw??null,p=ss(c&&u!==null&&u!==void 0&&u!==""?u:m??u),x=p!==null,C=c&&u!==null&&u!==void 0&&u!=="";let A=null;o!=null&&o.time?A=o.time:a.timestamp&&S(h(a.timestamp))&&(A=y(h(a.timestamp),"HH:mm"));const W=a.mucusSensation??a.mucus_sensation??"",K=a.mucusAppearance??a.mucus_appearance??"",R=!!W,Ce=!!K,Sa=R||Ce,Pt=a.observations||"",ka=!!Pt,_a=!!(a.had_relations??a.hadRelations??!1),zt=at[a.isoDate]||null,Ea=a.peak_marker==="peak"||zt==="P",Ma=ts(a.fertility_symbol);t.set(a.isoDate,{record:a,symbolInfo:Ma,hasTemperature:x,displayTemp:p,showCorrectedIndicator:C,timeValue:A,hasMucus:Sa,hasMucusSensation:R,hasMucusAppearance:Ce,mucusSensation:W,mucusAppearance:K,hasObservations:ka,observationsText:Pt,hasRelations:_a,peakStatus:zt,isPeakDay:Ea})}),t},[e==null?void 0:e.data,at]),d=n.useMemo(()=>{if(!(e!=null&&e.startDate))return null;const t=h(e.startDate);if(!S(t))return null;let r;if(e!=null&&e.endDate)r=h(e.endDate);else{const a=Q(new Date),o=[t,a];ue.length&&o.push(Vt(ue)),r=Vt(o)}return S(r)?{from:t,to:r}:{from:t,to:t}},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,ue]),ra=n.useMemo(()=>{const t={};return d&&(t.outsideCycle=r=>je(r,d.from)||Be(r,d.to),t.insideCycleNoRecord=r=>{if(je(r,d.from)||Be(r,d.to))return!1;const a=y(r,"yyyy-MM-dd");return!yt.has(a)}),ue.length&&(t.hasRecord=ue),t},[d,ue,yt]),na=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:w(Fa({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-2xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"rounded-2xl border border-rose-400 text-rose-600 focus:ring-2 focus:ring-rose-300 focus:ring-offset-2",day_today:"rounded-2xl ring-1 ring-rose-300 text-rose-700 font-semibold bg-transparent"}),[]),[Dt,st]=n.useState(()=>f&&S(h(f))?h(f):d!=null&&d.to?d.to:Q(new Date)),De=n.useRef(!1),_=n.useRef(null),oa=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1}),D=n.useRef(null),Ct=n.useRef(null),rt=n.useRef(null),jt=n.useRef(0),[ia,la]=n.useState(0),[Nt,nt]=n.useState(!1),E=n.useCallback(t=>{jt.current=t,la(t)},[]),St=n.useCallback(()=>new Promise(t=>{requestAnimationFrame(()=>{requestAnimationFrame(t)})}),[]),fe=n.useCallback((t,{duration:r=Ne}={})=>{_.current&&(cancelAnimationFrame(_.current),_.current=null);const a=jt.current,o=t-a;return Math.abs(o)<.5||r<=0?(E(t),Promise.resolve()):new Promise(c=>{const u=p=>1-Math.pow(1-p,3),m=performance.now(),l=p=>{const x=p-m,C=Math.min(1,x/r),A=a+o*u(C);if(E(A),C<1){_.current=requestAnimationFrame(l);return}_.current=null,c()};_.current=requestAnimationFrame(l)})},[E]),ca=n.useMemo(()=>({labelDay:t=>{const r=y(t,"yyyy-MM-dd"),a=de.get(r),o=y(t,"d MMM",{locale:ct});if(!a)return o;const c=[];if(a.hasTemperature&&a.hasMucus?c.push("temperatura y moco"):a.hasTemperature?c.push("temperatura"):a.hasMucus&&c.push("moco"),a.hasRelations&&c.push("RS"),a.peakStatus){const u=a.peakStatus==="P"?"pico ✖":`pico +${a.peakStatus}`;c.push(u)}return c.length?`${o}: ${c.join("; ")}`:o}}),[de]),ua=n.useCallback(({date:t,activeModifiers:r})=>{const a=y(t,"yyyy-MM-dd"),o=de.get(a),c=(o==null?void 0:o.hasTemperature)??!1,u=(o==null?void 0:o.hasMucus)??!1;o==null||o.hasRelations;const m=(o==null?void 0:o.peakStatus)??null,l=o==null?void 0:o.symbolInfo,p=l==null?void 0:l.value,x=r.selected,C=w("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",c?"bg-amber-500":"bg-transparent",c&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),A=w("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",u?"bg-teal-500":"bg-transparent",u&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),W=!!(p&&p!=="none"),K=w("relative z-10 text-[1.15rem] leading-none",r.outside||r.outsideCycle?"text-slate-300":x?W?"text-white":"text-rose-600":"text-slate-700"),R=m==="P"?"✖":m?`+${m}`:null,Ce=W?w("pointer-events-none absolute inset-0 rounded-full transition-opacity",(l==null?void 0:l.color)??"",(l==null?void 0:l.pattern)==="spotting-pattern"?"calendar-spotting-dot":"",p==="white"?"ring-1 ring-slate-300/70":"",x?"opacity-50":"opacity-25"):null;return s.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[s.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[Ce&&s.jsx("span",{className:Ce,"aria-hidden":"true"}),s.jsx("span",{className:K,children:y(t,"d")})]}),s.jsxs("div",{className:"mt-[0.22rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[s.jsx("span",{className:C}),s.jsx("span",{className:A})]}),R&&s.jsx("span",{"aria-hidden":"true",className:w("pointer-events-none absolute -top-[1px] right-[1px] rounded-sm px-[2px] text-[0.55rem] font-semibold leading-none text-rose-500 shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",x?"bg-rose-100/90 text-rose-700":"bg-white/90"),children:R})]})},[de]),O=n.useMemo(()=>{if(!(e!=null&&e.startDate))return[];const t=h(e.startDate);if(!S(t))return[];const r=Q(t),a=Q(new Date);let o=d!=null&&d.to?Q(d.to):a;Be(o,a)&&(o=a),je(o,r)&&(o=r);const c=Ht(o,r)+1;if(c<=0)return[];const u=[];for(let m=c-1;m>=0;m-=1){const l=Ia(r,m),p=y(l,"yyyy-MM-dd"),x=Ht(l,r)+1,C=de.get(p)||null;u.push({isoDate:p,date:l,cycleDay:x,details:C})}return u},[e==null?void 0:e.startDate,d,de]),kt=n.useMemo(()=>new Set(O.map(t=>t.isoDate)),[O]),da=n.useMemo(()=>{const t=new Map;return O.forEach(r=>{t.set(r.isoDate,r)}),t},[O]),me=f&&da.get(f)||null,Y=(me==null?void 0:me.details)??null,_t=(Y==null?void 0:Y.peakStatus)??(f?at[f]??null:null),fa=(Y==null?void 0:Y.isPeakDay)??_t==="P",ze=n.useMemo(()=>{const t=d!=null&&d.to?y(Q(d.to),"yyyy-MM-dd"):null;return b?t??ce[0]??null:ce.length?ce[0]:t},[b,d,ce]);n.useEffect(()=>{if(!(f&&kt.has(f))){if(!ze){f!==null&&X(null);return}f!==ze&&X(ze)}},[f,kt,ze]);const Et=n.useCallback(t=>{if(!t)return;const r=y(t,"yyyy-MM-dd");d&&(je(t,d.from)||Be(t,d.to))||X(r)},[d]);n.useEffect(()=>{if(!f)return;const t=h(f);S(t)&&st(r=>r&&r.getFullYear()===t.getFullYear()&&r.getMonth()===t.getMonth()?r:t)},[f]);const Mt=n.useCallback(t=>{st(r=>{const a=r??(d==null?void 0:d.to)??Q(new Date);return Ua(a,t==="next"?1:-1)})},[d]);n.useEffect(()=>{if(!$){rt.current=null,E(0),nt(!1);return}const t=Ct.current;if(!t)return;const r=t.querySelector(".records-calendar-day-grid");r&&(rt.current=r)},[Dt,$,E]);const ot=n.useCallback(async t=>{var m;if(De.current)return;De.current=!0;const r=rt.current,a=((m=r==null?void 0:r.getBoundingClientRect())==null?void 0:m.width)??0,o=t==="next"?-Yt:Yt,c=a?t==="next"?-a:a:o,u=-c;try{await fe(c,{duration:Ne}),Mt(t),E(u),await St(),await fe(0,{duration:Ne})}finally{De.current=!1}},[fe,Mt,E,St]),M=n.useCallback(()=>{ft(null),mt(null),pt(!1),ht(null),et(!1)},[]);n.useEffect(()=>()=>{_.current&&(cancelAnimationFrame(_.current),_.current=null),D.current&&(D.current(),D.current=null)},[]);const At=n.useCallback(()=>{Ie((e==null?void 0:e.startDate)||""),Le((e==null?void 0:e.endDate)||""),I(""),M(),dt(!0)},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,M]),G=n.useCallback(()=>{dt(!1),I(""),M(),Ie((e==null?void 0:e.startDate)||""),Le((e==null?void 0:e.endDate)||"")},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,M]),ma=n.useCallback(()=>{J&&(G(),J())},[G,J]),pa=n.useCallback(t=>{var m;if(!$||De.current||t.pointerType==="mouse"&&t.button!==0||!t.target.closest(".records-calendar-day-grid"))return;const a=oa.current;a.active=!0,a.pointerId=t.pointerId,a.startX=t.clientX,a.startTime=performance.now(),a.dragging=!1;const o=l=>{if(!a.active||l.pointerId!==a.pointerId)return;const p=l.clientX-a.startX;if(!a.dragging&&Math.abs(p)>as&&(a.dragging=!0,nt(!0)),!a.dragging)return;const x=Math.max(-Gt,Math.min(Gt,p));l.preventDefault(),E(x)},c=async l=>{var R;if(!a.active||l.pointerId!==a.pointerId)return;(R=D.current)==null||R.call(D),D.current=null,a.active=!1;const p=l.clientX-a.startX,x=performance.now()-a.startTime,C=x>0?p/x*1e3:0,A=p<=-qt||C<=-$t,W=p>=qt||C>=$t,K=a.dragging;if(a.dragging=!1,nt(!1),De.current){await fe(0,{duration:Ne});return}if(K&&A){await ot("next");return}if(K&&W){await ot("prev");return}await fe(0,{duration:Ne})},u=()=>{window.removeEventListener("pointermove",o,{capture:!0}),window.removeEventListener("pointerup",c,{capture:!0}),window.removeEventListener("pointercancel",c,{capture:!0})};(m=D.current)==null||m.call(D),D.current=u,window.addEventListener("pointermove",o,{capture:!0,passive:!1}),window.addEventListener("pointerup",c,{capture:!0}),window.addEventListener("pointercancel",c,{capture:!0})},[ot,fe,$,E]),ha=n.useCallback(()=>{M()},[M]),ga=n.useCallback(async()=>{if(!V){I("La fecha de inicio es obligatoria");return}if(b&&U&&U<V){I("La fecha de fin no puede ser anterior al inicio");return}if(e!=null&&e.id){I(""),ve(!0);try{const t=se?await se(e.id,V,b&&U||void 0):null;if(t){ft(V),mt((b&&U||void 0)??null),pt(!!b),ht(t),et(!0),ve(!1);return}await H(e.id,V,b&&U||void 0),await Fe({silent:!0}),N({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),G()}catch(t){console.error("Error updating start date from records page:",t),I("No se pudieron actualizar las fechas"),N({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{ve(!1)}}},[V,U,b,e==null?void 0:e.id,se,H,Fe,N,G]),ba=n.useCallback(async()=>{if(!(e!=null&&e.id)||!L){M();return}ve(!0),et(!1);try{const t=e.startDate,r=e.endDate??void 0,a=L!==t,o=a&&L&&t&&je(h(L),h(t)),c=Je?Ze??void 0:void 0,u=Je&&Ze!==null&&c!==r;if(o&&await v(e.id,L),u&&c&&F){const m=a?L:t;await F(e.id,c,m)}await H(e.id,a?L:void 0,c),await Fe({silent:!0}),N({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),G()}catch(t){console.error("Error adjusting cycle dates from records page:",t),I("No se pudieron actualizar las fechas"),N({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{ve(!1),M()}},[e==null?void 0:e.id,e==null?void 0:e.startDate,e==null?void 0:e.endDate,L,Je,Ze,v,F,H,Fe,N,G,M]),Tt=n.useCallback(()=>{re(!1),ne(null),q(null),we(null),ye(null)},[]),Ft=n.useCallback((t,r=null,a=null)=>{t&&(ne(t),q(t.isoDate??null),we(r),ye(a??null),t.isoDate&&X(t.isoDate),re(!0))},[]),xa=n.useCallback((t,r=null,a=null)=>Ft(t,a,r),[Ft]),va=t=>{var a;const r=(a=e==null?void 0:e.data)==null?void 0:a.find(o=>o.id===t);Qe(r||null)},wa=n.useCallback(t=>{ne(t)},[]),ya=n.useCallback((t,r=null,a=null)=>{t&&(X(t),ne(null),q(t),we(a),ye(r),re(!0))},[]),It=n.useCallback(()=>{const t=O.length?O[0].isoDate:(e==null?void 0:e.startDate)||null,r=f||t||null;ne(null),q(r),we(null),ye(null),r&&X(r),re(!0)},[O,e==null?void 0:e.startDate,f]),Lt=n.useCallback((t,r={})=>{var u,m;const a=((u=e==null?void 0:e.data)==null?void 0:u.find(l=>l.isoDate===t))||null,o=a!=null&&a.timestamp&&S(h(a.timestamp))?y(h(a.timestamp),"HH:mm"):y(new Date,"HH:mm"),c=(m=a==null?void 0:a.measurements)!=null&&m.length?a.measurements.map((l,p)=>{const x=(l==null?void 0:l.time)||(l!=null&&l.timestamp&&S(h(l.timestamp))?y(h(l.timestamp),"HH:mm"):o);return{temperature:(l==null?void 0:l.temperature)??(l==null?void 0:l.temperature_raw)??"",temperature_corrected:(l==null?void 0:l.temperature_corrected)??"",time:x,time_corrected:(l==null?void 0:l.time_corrected)||x,use_corrected:!!(l!=null&&l.use_corrected),selected:!!((l==null?void 0:l.selected)??p===0)}}):[{temperature:"",temperature_corrected:"",time:o,time_corrected:o,use_corrected:!1,selected:!0}];return{isoDate:t,measurements:c,mucusSensation:(a==null?void 0:a.mucusSensation)??(a==null?void 0:a.mucus_sensation)??"",mucusAppearance:(a==null?void 0:a.mucusAppearance)??(a==null?void 0:a.mucus_appearance)??"",fertility_symbol:(a==null?void 0:a.fertility_symbol)??(a==null?void 0:a.fertilitySymbol)??"none",observations:(a==null?void 0:a.observations)??"",peak_marker:(a==null?void 0:a.peak_marker)??null,ignored:(a==null?void 0:a.ignored)??!1,...r}},[e==null?void 0:e.data]),Da=async(t,{keepFormOpen:r=!1}={})=>{le(!0);try{await ae(t,Ke),r||(re(!1),ne(null),q(null),we(null),ye(null))}catch{N({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{le(!1),r&&q((t==null?void 0:t.isoDate)??null)}},Ca=n.useCallback(async t=>{var c;if(!t)return;const r=((c=e==null?void 0:e.data)==null?void 0:c.find(u=>u.isoDate===t))||null,a=!!((r==null?void 0:r.had_relations)??(r==null?void 0:r.hadRelations)??!1),o=Lt(t,{had_relations:!a,hadRelations:!a});le(!0);try{await ae(o,r)}catch{N({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{le(!1)}},[ae,Lt,e==null?void 0:e.data,N]),ja=async()=>{if(oe){le(!0);try{const t=oe.isoDate;await Te(oe.id),Qe(null),q(null),t&&f===t&&X(t)}catch{N({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{le(!1)}}},Ot={openDateEditor:At,openAddRecord:It,isProcessing:ie,isUpdatingDates:tt,cycle:e},Na=typeof Z=="function"?Z(Ot):s.jsxs(s.Fragment,{children:[s.jsxs(Se,{type:"button",variant:"outline",size:"icon",onClick:At,className:"border-pink-200 rounded-full text-pink-600 hover:bg-pink-500",disabled:ie||tt,"aria-label":b?"Editar fechas del ciclo":"Editar fecha de inicio",children:[s.jsx(Oa,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:b?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),s.jsxs(Se,{type:"button",size:"icon",onClick:It,className:"rounded-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",disabled:ie,style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},"aria-label":"Añadir registro",children:[s.jsx(Ya,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),Rt=typeof he=="function"?he({...Ot,toggleCalendar:()=>Oe(t=>!t),openCalendar:()=>Oe(!0),closeCalendar:()=>Oe(!1)}):he??null;return B&&!(e!=null&&e.id)?s.jsxs("div",{className:"relative flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[s.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),s.jsx("p",{className:"text-center text-slate-600 text-lg",children:"Cargando..."})]}):e!=null&&e.id?s.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[Rt&&s.jsx("div",{className:"space-y-4",children:Rt}),s.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),s.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[s.jsx("div",{ref:Re,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:s.jsx("div",{className:"relative overflow-hidden rounded-2xl ring-1 ring-rose-100/70",children:s.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[s.jsx(pe.div,{className:"flex flex-col gap-4",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:s.jsxs("div",{className:"flex flex-wrap items-center gap-1 justify-between sm:justify-start",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(i,{className:"h-7 w-7 text-pink-500"}),s.jsxs("button",{type:"button",onClick:()=>Oe(t=>!t),className:"group flex items-center gap-1 rounded-full px-1 py-1 text-left transition-all hover:border-rose-800 hover:bg-white/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-400 focus-visible:ring-offset-2 focus-visible:ring-offset-rose-50","aria-expanded":$,"aria-controls":"records-calendar",children:[s.jsx("span",{className:"text-2xl sm:text-2xl font-bold text-slate-700",children:k}),s.jsx("span",{className:"flex items-center gap-1",children:s.jsx(pe.span,{animate:{rotate:$?180:0},className:"flex h-7 w-7 items-center justify-center rounded-full bg-rose-50 text-rose-400",children:s.jsx(Za,{className:"h-4 w-4"})})})]})]}),s.jsx("div",{className:"flex items-center gap-1",children:Na})]})}),Qt&&s.jsx(pe.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:s.jsx(Ra,{cycle:e,startDate:V,endDate:b?U:e==null?void 0:e.endDate,onStartDateChange:t=>Ie(t),onEndDateChange:b?t=>Le(t):void 0,onSave:ga,onCancel:G,isProcessing:tt,dateError:Zt,includeEndDate:b,showOverlapDialog:ea,overlapCycle:Jt,onConfirmOverlap:ba,onCancelOverlap:ha,onClearError:()=>I(""),saveLabel:b?"Guardar fechas":"Guardar cambios",title:b?"Editar fechas del ciclo":"Editar fecha de inicio",description:b?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:J?ma:void 0,deleteTitle:Ue,deleteDescription:T,deleteLabel:Xe,isDeletingCycle:z})}),s.jsx(Xa,{initial:!1,children:$&&s.jsx(pe.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:s.jsx("div",{ref:Ct,onPointerDown:pa,"data-calendar-dragging":Nt?"true":"false",className:w("w-full max-w-sm rounded-3xl bg-white/40 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:transition-transform [&_.records-calendar-day-grid]:duration-200 [&_.records-calendar-day-grid]:ease-out [&_.records-calendar-day-grid]:[transform:translateX(var(--calendar-drag-x,0px))] data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:duration-0 data-[calendar-dragging=true]:[&_.records-calendar-day-grid]:ease-linear",Nt?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${ia}px`},children:s.jsx(qa,{mode:"single",locale:ct,month:Dt??void 0,onMonthChange:st,selected:f&&S(h(f))?h(f):void 0,onSelect:Et,onDayClick:Et,modifiers:ra,labels:ca,components:{DayContent:ua},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-rose-200 [&_button[aria-selected=true]]:bg-rose-200 [&_button[aria-selected=true]]:rounded-2xl",classNames:na,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),s.jsxs("div",{ref:gt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:wt,maxHeight:`calc(100dvh - ${wt}px - var(--bottom-nav-safe, 0px))`,WebkitOverflowScrolling:"touch"},children:[s.jsx(pe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 pb-[calc(var(--bottom-nav-safe,0px))] sm:px-2 lg:px-4",children:O.length===0?s.jsx(pe.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:s.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[s.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-rose-500 shadow-inner",children:s.jsx(ut,{className:"h-8 w-8"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),s.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):s.jsx(es,{isoDate:f,cycleDay:(me==null?void 0:me.cycleDay)??null,details:Y,peakStatus:_t,isPeakDay:fa,onEdit:xa,onDelete:va,onAdd:ya,onToggleRelations:Ca,isProcessing:ie})}),Me&&s.jsx("div",{className:"pt-4 space-y-4",children:Me})]})]}),s.jsx(Ka,{open:Kt,onOpenChange:t=>{t?re(!0):Tt()},children:s.jsx(Qa,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:s.jsx($a,{onSubmit:Da,onCancel:Tt,initialData:Ke,cycleStartDate:e==null?void 0:e.startDate,cycleEndDate:e==null?void 0:e.endDate,isProcessing:ie,isEditing:!!Ke,cycleData:e==null?void 0:e.data,onDateSelect:wa,defaultIsoDate:ta,focusedField:aa,initialSectionKey:sa})})}),s.jsx(Ga,{isOpen:!!oe,onClose:()=>Qe(null),onConfirm:ja,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:oe?`¿Estás seguro de que quieres eliminar el registro del ${y(h(oe.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:ie})]}):s.jsxs("div",{className:"relative flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[s.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),s.jsx("p",{className:"text-center text-slate-600 text-lg",children:"No hay ciclo activo."})]})},gs=()=>s.jsx(rs,{});export{rs as RecordsExperience,gs as default};
