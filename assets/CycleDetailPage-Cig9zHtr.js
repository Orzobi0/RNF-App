import{c as T,q as H,a as z,u as J,b as V,r as l,g as S,f,j as s,L as R,o as W,l as L,k as Z}from"./index-DKDve1bt.js";import{a as C,H as G,D as K}from"./DeletionDialog-CF9wx8xT.js";import{u as Q}from"./useCycleData-B59yyua_.js";import{RecordsExperience as X}from"./RecordsPage-C5L22UIi.js";import{A as Y}from"./arrow-left-B-zvaJsb.js";import{P as ee}from"./badge-Bv0PJFOO.js";import"./PostpartumExitDialog-Cpj4GPqp.js";import"./OverlapWarningDialog-BdysBLfz.js";import"./input-3y406qNm.js";import"./DataEntryForm-BA2ItfuX.js";import"./label-CjCq2AfR.js";import"./computePeakStatuses-DDireWCn.js";import"./eye-B04h8Q7I.js";const ae=T("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),te=(i,d)=>{const a=L(f(i)),r=L(f(d));return Z(a,r)+1},se=(i,d)=>!i||!Array.isArray(i)||!d?[]:[...i].sort((r,p)=>f(r.isoDate)-f(p.isoDate)).map(r=>({...r,ignored:r.ignored||!1,cycleDay:te(r.isoDate,d)})),De=()=>{const{cycleId:i}=H(),d=z(),{user:a}=J(),{getCycleById:r,isLoading:p,addOrUpdateDataPoint:g,deleteRecord:v,updateCycleDates:x,deleteCycle:b,checkCycleOverlap:I,forceUpdateCycleStart:w,refreshData:j}=Q(),{toast:u}=V(),[t,k]=l.useState(null),[P,m]=l.useState(!1),[E,N]=l.useState(!1),h=t?`${S(f(t.startDate),"dd/MM/yyyy")} - ${t.endDate?S(f(t.endDate),"dd/MM/yyyy"):"En curso"}`:"",D=l.useCallback(e=>{if(!a||!e?.id)return;const c={...e,data:(e.data||[]).map(({cycleDay:o,...n})=>n)};localStorage.setItem(`fertilityData_cycle_${a.uid}_${e.id}`,JSON.stringify(c))},[a]),y=l.useCallback(async()=>{if(!a||!i)return null;const e=await r(i);return e&&(D(e),k(e)),e},[i,r,D,a]);l.useEffect(()=>{(async()=>{if(!a)return;let c=await r(i);if(!c){const o=localStorage.getItem(`fertilityData_cycle_${a.uid}_${i}`);if(o){const n=JSON.parse(o);c={...n,data:se(n.data||[],n.startDate)}}}c?(D(c),k(c)):(u({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),d("/archived-cycles"))})()},[i,a,r,u,d]);const A=l.useCallback(async(e,c)=>{if(!t?.id||!a)return;const o=!!c;await g(e,c,t.id),await y()&&u({title:o?"Registro actualizado":"Nuevo registro añadido",description:"Datos del ciclo actualizados."})},[t?.id,a,g,y,u]),O=l.useCallback(async e=>{!t?.id||!a||(await v(e,t.id),await y(),u({title:"Registro eliminado",description:"El registro ha sido eliminado."}))},[t?.id,a,v,y,u]),$=l.useCallback(async(e,c,o)=>{const n=e??t?.id;!a||!n||await x(n,c,o)},[t?.id,a,x]),q=l.useCallback(async(e,c)=>{const o=e??t?.id;!a||!o||await w(o,c)},[t?.id,a,w]),U=l.useCallback(async e=>{await j(e),await y()},[j,y]),M=()=>{m(!0)},_=l.useCallback(async()=>{if(!(!t?.id||!a)){N(!0);try{await b(t.id),u({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),d("/archived-cycles")}catch(e){console.error(e),u({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{N(!1),m(!1)}}},[t?.id,b,d,u,a]),B=l.useCallback(()=>s.jsx(C,{asChild:!0,className:"shrink-0 text-fertiliapp-fuerte",children:s.jsxs(R,{to:"/archived-cycles","aria-label":"Volver a mis ciclos",children:[s.jsx(Y,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Mis ciclos"})]})}),[]),F=l.useCallback(({openDateEditor:e,openAddRecord:c,isProcessing:o,isUpdatingDates:n})=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(C,{type:"button",onClick:e,"aria-pressed":n,disabled:n,"aria-label":"Editar fechas del ciclo",children:s.jsx(ae,{className:"h-4 w-4"})}),s.jsx(C,{asChild:!0,children:s.jsx(R,{to:`/chart/${i}`,"aria-label":"Ver gráfica del ciclo",children:s.jsx(W,{className:"h-4 w-4"})})}),s.jsx(G,{type:"button",onClick:c,disabled:o,"aria-label":"Añadir registro al ciclo",children:s.jsx(ee,{className:"h-4 w-4"})})]}),[i]);return p&&!t||!t?s.jsx("div",{className:"flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:s.jsx("p",{children:"Cargando detalles del ciclo..."})}):s.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[s.jsx(X,{cycle:t,isLoading:p,addOrUpdateDataPoint:A,deleteRecord:O,updateCycleDates:$,checkCycleOverlap:I,forceUpdateCycleStart:q,refreshData:U,includeEndDate:!0,headerActions:F,topAccessory:B,onRequestDeleteCycle:M,isDeletingCycle:E,dateEditorDeleteDescription:h?`Se eliminará el ciclo ${h} y todos sus registros asociados.`:"Se eliminará este ciclo y todos sus registros asociados."}),s.jsx(K,{isOpen:P,onClose:()=>m(!1),onConfirm:_,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:h?`¿Estás seguro de que quieres eliminar el ciclo ${h}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:E})]})};export{De as default};
