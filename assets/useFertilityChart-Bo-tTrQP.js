import{r as j,j as a,m as we,B as tt,O as St,g as lt,f as Ue,Q as ft}from"./index-C041RoKp.js";import{l as wt,B as Mt}from"./badge-BbO7fxzd.js";import{b as kt,X as Nt,e as ct,P as ut,f as nt,T as Pt,h as Tt,c as Dt}from"./computePeakStatuses-Dl9gvYQS.js";const Gt=({point:e,position:n,chartWidth:i,chartHeight:v,onToggleIgnore:p,onEdit:s,onClose:u,onTogglePeak:b,currentPeakIsoDate:w})=>{if(!e)return null;const x=.6,C=200,k=120,S=C*x,R=k*x,f=j.useRef(null),[g,h]=j.useState(R),[m,I]=j.useState(!1);j.useEffect(()=>{f.current&&h(f.current.offsetHeight),I(!1)},[e]);const F=n.clientX>i*.66,Y=n.clientY+g>v;let P=F?n.clientX-S-10:n.clientX+10,z=Y?n.clientY:n.clientY+10;P+S>i&&(P=i-S-10),z+g>v&&(z=v-g-10),P<10&&(P=10),z<10&&(z=10);const E=!e.id||String(e.id).startsWith("placeholder-"),N=e.temperature_chart??e.displayTemperature??null,A=kt(e.fertility_symbol),re=e.timestamp||e.isoDate,W=O=>{if(O==null)return null;const G=String(O).trim();return G.length?G:null},U=O=>{if(!O)return null;try{const G=Ue(O),te=G.getTime();return Number.isNaN(te)?null:lt(G,"HH:mm")}catch{return null}},ce=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const O=e.measurements.filter(Boolean);if(!O.length)return null;const G=[...O.filter(te=>te?.selected),...O.filter(te=>!te?.selected)];for(const te of G){const ze=!!te?.use_corrected?W(te?.time_corrected)??W(te?.time):W(te?.time);if(ze)return ze}return null})(),B=(e.use_corrected?[W(e.time_corrected),W(e.time)]:[W(e.time)]).find(Boolean)??U(e.timestamp),$=ce??B,H=e.mucus_sensation??e.mucusSensation??"",he=e.mucus_appearance??e.mucusAppearance??"",Q=e.observations??"",me=!!(e.had_relations??e.hadRelations),ge=A&&A.value!=="none",ue=N!=null,q=!!(H&&H.trim()||he&&he.trim()),Te=!!(Q&&Q.trim()),J=!(ue||ge||q||Te||me),ee=e.peakStatus||(e.peak_marker==="peak"?"P":null),be=ee&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[ee]||null,X=!!(b&&e.isoDate),ae=!!w,ye=ae&&e.isoDate===w||ee==="P"||e.peak_marker==="peak",V=ye?"remove":ae?"update":"assign",Z=V==="assign"?"Asignar día pico":V==="update"?"Actualizar día pico":"Quitar día pico",ie=Z,Ae=async()=>{if(!(!b||m)){I(!0);try{await b(e,!ye),u&&u()}catch(O){console.error("Error toggling peak marker from tooltip:",O)}finally{I(!1)}}},Ie=()=>{le()},le=O=>{s&&(s(e,O),u&&u())},ve=(O=>{switch(O){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return a.jsxs(we.div,{ref:f,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:z,left:P,width:S},children:[a.jsx("div",{className:"origin-top-left",style:{transform:`scale(${x})`,width:C,minHeight:k},children:a.jsxs("div",{className:"relative tooltip-surface--gradient backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden",children:[a.jsx(tt,{variant:"ghost",size:"icon",onClick:u,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-suave rounded-full w-6 h-6 transition-all duration-200",children:a.jsx(Nt,{size:20})}),me&&a.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:a.jsx(St,{className:"w-4 h-4 text-fertiliapp-fuerte",fill:"currentColor"})}),a.jsxs("div",{className:"p-2",children:[a.jsxs("div",{className:"mb-2 relative",children:[a.jsx("div",{className:"w-5 h-5 bg-fertiliapp-fuerte rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:a.jsx(ct,{className:"w-2 h-2 text-white",fill:"currentColor"})}),a.jsxs("div",{className:"mb-1 pl-8",children:[a.jsxs("div",{className:"flex items-baseline justify-start gap-2",children:[a.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:re?lt(Ue(re),"dd/MM",{locale:wt}):"Fecha"}),a.jsxs("span",{className:"text-sm text-fertiliapp-fuerte font-medium whitespace-nowrap",children:["Día ",e.cycleDay||"N/A"]})]}),be&&a.jsx("div",{className:"mt-1 flex justify-start",children:a.jsx(Mt,{className:"bg-tarjeta text-fertiliapp-fuerte border border-fertiliapp-suave px-2 py-0 text-[11px]",children:be})})]})]}),J?a.jsxs("div",{className:"pt-1 space-y-3",children:[a.jsx(we.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:a.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(X||s)&&a.jsxs(we.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[X&&a.jsx(ut,{mode:V,size:"sm",onClick:Ae,pending:m,"aria-label":ie,title:Z,className:"shrink-0"}),s&&a.jsxs(tt,{onClick:Ie,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[a.jsx(nt,{className:"h-4 w-4"}),a.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-1",children:[ue&&a.jsx(we.button,{type:"button",onClick:()=>le("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-temp-suave rounded-2xl p-1 border border-temp focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-temp",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-temp rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Pt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(N).toFixed(2)}),a.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&a.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),$&&a.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:$})]})})]})}),ge&&a.jsx(we.button,{type:"button",onClick:()=>le("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${ve.light} rounded-3xl p-1 ${ve.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-6 h-6 ${ve.bg} rounded-lg flex items-center justify-center shadow-lg ${ve.glow} shadow-lg`,children:a.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:`text-md font-semibold ${ve.text}`,children:A.label})})]})}),a.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[a.jsx(we.button,{type:"button",onClick:()=>le("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-sensacion-suave rounded-3xl p-1 border border-sensacion focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-sensacion rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Tt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-sensacion-fuerte",children:H||"-"})})]})}),a.jsx(we.button,{type:"button",onClick:()=>le("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-apariencia-suave rounded-3xl p-1 border border-apariencia focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-apariencia rounded-lg flex items-center justify-center shadow-md",children:a.jsx(ct,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-apariencia-fuerte",children:he||"-"})})]})}),Te&&a.jsx(we.button,{type:"button",onClick:()=>le("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-observaciones-suave rounded-3xl p-1 border border-observaciones focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!s,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-observaciones rounded-lg flex items-center justify-center shadow-md",children:a.jsx(nt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-sm font-semibold text-observaciones-fuerte",children:Q})})]})})]})]}),(s||p&&!E&&e.id||X&&!E)&&a.jsxs(we.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[X&&!E&&a.jsx(ut,{mode:V,size:"sm",onClick:Ae,pending:m,"aria-label":ie,title:Z,className:"shrink-0"}),a.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:s&&a.jsxs(tt,{onClick:Ie,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[a.jsx(nt,{className:"h-4 w-4 mr-1.5"}),a.jsx("span",{className:"font-medium",children:E?"Añadir datos":""})]})})]})]})]})]})}),a.jsx("div",{className:"absolute -inset-2 tooltip-glow rounded-3xl blur-xl -z-10"})]})},Ve={0:0,1:.4,2:.8,3:1},At={M:.8,F:1,"M+":1,white:.4},jt=(e,n=0,i=1)=>!Number.isFinite(e)||e<n?n:e>i?i:e,Ct=e=>e?String(e).toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),""):"",pt=e=>Ct(e).replace(/\s+/g," ").trim(),ht=(e,n=[])=>{if(!e)return null;let i=null;return n.forEach((v,p)=>{const{patterns:s=[],level:u,descriptor:b,negatedLevel:w,allowedModifiers:x=null,disallowedModifiers:C=null,selectionScore:k,forceSelection:S=!1}=v||{};s.forEach(R=>{if(!R)return;const f=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${R})(?=$|[^a-z0-9])`,"g");let g;for(;(g=f.exec(e))!==null;){const h=g[1]?g[1].trim():null;if(x&&!x.includes(h)||C&&C.includes(h))continue;let m=u;h==="no"?m=w??1:h==="muy"?m=Math.min(3,u+1):(h==="poco"||h==="leve")&&(m=Math.max(0,u-1));const I=k??m+p*.001,F=typeof b=="function"?b({modifier:h}):b;(!i||S||m>i.level||m===i.level&&I>i.selectionScore)&&(i={level:m,baseLevel:u,descriptor:F,modifier:h,selectionScore:I,force:S})}})}),i},Ft=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],_t=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],gt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const i=Math.round(e);if(i>=0&&i<=3)return i}const n=String(e).trim();return/^[0-3]$/.test(n)?Number.parseInt(n,10):null},bt=e=>{const n=gt(e);if(n!=null)return{level:n,reason:`S${n}`,descriptor:`S${n}`,hasInput:!0};const i=e!=null?String(e).trim():"",v=pt(e),p=i.length>0;if(!v)return{level:0,reason:null,descriptor:null,hasInput:p};if(/^s\s*0?$/.test(v))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(v==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const s=ht(v,Ft);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:p}},xt=e=>{const n=gt(e);if(n!=null)return{level:n,reason:`M${n}`,descriptor:`M${n}`,hasInput:!0};const i=e!=null?String(e).trim():"",v=pt(e),p=i.length>0;if(!v)return{level:0,reason:null,descriptor:null,hasInput:p};if(/^m\s*0$/.test(v))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(i))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const s=ht(v,_t);return s?{level:Math.max(0,Math.min(3,s.level)),reason:s.descriptor,descriptor:s.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:p}},Lt=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),zt=({appearance:e,observations:n,fertilitySymbol:i})=>{const v=[e,n,i].map(s=>String(s||"").toUpperCase()),p=s=>{if(!s)return!1;const b=`(?:^|[^\\p{L}\\p{N}])${Lt(s)}(?=$|[^\\p{L}\\p{N}])`,w=new RegExp(b,"u");return v.some(x=>w.test(x))};return p("M+")?"M+":p("M")?"M":p("F")||p("FER")?"F":String(i||"").toLowerCase()==="white"?"white":"none"},Et=e=>{if(e==null)return"";const n=String(e).trim().toUpperCase();return n==="P"||n==="PEAK"?"P":n==="1"||n==="P1"||n==="P+1"?"1":n==="2"||n==="P2"||n==="P+2"?"2":n==="3"||n==="P3"||n==="P+3"?"3":""},Ge=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,Rt=(e,n,i)=>{const v=e?.mucusSensation??e?.mucus_sensation,p=e?.mucusAppearance??e?.mucus_appearance,s=e?.fertility_symbol??e?.fertilitySymbol,u=e?.observations??e?.notes,b=e?.peak_marker??e?.peakMarker??null,w=typeof b=="string"?b.trim().toLowerCase()==="peak":!1,x=bt(v),C=xt(p);let k=Ge(x.level),S=Ge(C.level);const R=[];x.reason&&R.push(`S:${x.reason}`),C.reason&&R.push(`M:${C.reason}`);const f=zt({appearance:p,observations:u,fertilitySymbol:s}),g=f;let h=f;h==="white"&&(S=Math.max(S,1)),h==="M"&&(S=Math.max(S,2)),h==="M+"&&(S=Math.max(S,3)),h==="F"&&(S=Math.max(S,3),k=Math.max(k,3));const m=Ve[k]??0,I=Ve[S]??0,F=Math.max(m,I);h&&h!=="none"&&R.push(`symbol:${h}`);const Y=At[h]??0,P=jt(Math.max(F,Y)),z=n!=null&&Number.isFinite(n)?F>=n+.4-1e-9:!1;z&&R.push("cambioBIP");const E={hasSensation:!!x.hasInput,hasAppearance:!!C.hasInput,hasSymbol:s!=null&&String(s).trim()!==""&&String(s).trim().toLowerCase()!=="none",hasObservation:u!=null&&String(u).trim()!==""};E.hasAny=E.hasSensation||E.hasAppearance||E.hasSymbol||E.hasObservation;const N=Et(e?.normalizedPeakStatus??e?.peakStatus??e?.peak_marker);return{index:i,S:k,M:S,symbolDetected:h,rawSymbol:g,isPeakMarked:w,scoreCore:F,scoreFertil:P,hasChangeBIP:z,reasons:R,entryFlags:E,descriptors:{sensation:x.descriptor??x.reason??null,appearance:C.descriptor??C.reason??null},normalizedPeakStatus:N}},Bt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const n=[];for(let p=0;p<Math.min(6,e.length);p+=1){const s=e[p];if(!s||String(s?.fertility_symbol||"").toLowerCase()==="red")continue;const b=bt(s?.mucusSensation??s?.mucus_sensation),w=xt(s?.mucusAppearance??s?.mucus_appearance),x=Ve[Ge(b.level)]??0,C=Ve[Ge(w.level)]??0;n.push(Math.max(x,C))}const i=n.length>0?Math.max(...n):0;return{days:e.map((p,s)=>Rt(p,i,s)),bipScore:i}},$t=e=>{for(let n=0;n<e.length;n+=1){const i=e[n];if(i){if(i.isPeakMarked)return{source:"Interno",day:n+1,reason:"P",kind:"profile"};if(i.symbolDetected==="white"||i.rawSymbol==="white")return{source:"Interno",day:n+1,reason:"white",kind:"profile"};if(i.symbolDetected==="M+"||i.symbolDetected==="F")return{source:"Interno",day:n+1,reason:"M+",kind:"profile"};if(i.symbolDetected==="M")return{source:"Interno",day:n+1,reason:"M",kind:"profile"};if(i.M>=2||i.S>=2)return{source:"Interno",day:n+1,reason:"S/M>=2",kind:"profile"}}}return null},Ot=(e,n)=>{const i=e.filter(s=>s&&Number.isFinite(s.day)).map(s=>({...s}));if(i.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:n,usedCandidates:[],notes:["Sin candidatos disponibles"]};const v=[...i].sort((s,u)=>{const b=Number.isFinite(s.day)?s.day:Number.POSITIVE_INFINITY,w=Number.isFinite(u.day)?u.day:Number.POSITIVE_INFINITY;return b-w}),p=Math.min(...v.map(s=>Math.round(s.day)));return{status:p!=null?"ok":"indeterminado",selectedDay:p??null,selectedMode:n,usedCandidates:v,notes:[]}},Ht=({processedData:e=[],config:n={},calculatorCandidates:i=[],context:v={}})=>{const{calculators:p={cpm:!0,t8:!0},postpartum:s=!1,combineMode:u="conservador"}=n||{},w=new Set(["conservador","estandar"]).has(u)?u:"conservador",{postPeakStartIndex:x=null,temperatureInfertileStartIndex:C=null,temperatureConfirmationIndex:k=null,temperatureRule:S=null,todayIndex:R=null}=v||{},{days:f,bipScore:g}=Bt(e),h=Array.isArray(f)?f.length:0,m=t=>Number.isInteger(t)&&t>=0&&t<h,I=t=>{const c=t?.peak_marker??t?.peakMarker??null;return typeof c=="string"&&c.trim().toLowerCase()==="peak"},Y=(()=>{if(!Array.isArray(e)||e.length===0)return null;for(let t=e.length-1;t>=0;t-=1)if(I(e[t]))return t;return null})(),P=m(Y)?Y:null,z=[],E=t=>{!t||!Number.isFinite(t.day)||z.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};E($t(f));const N=[],A=[];s&&N.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),s||i.forEach(t=>{if(!t)return;const c=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";if(!(c==="CPM"&&p.cpm||c==="T8"&&p.t8))return;const oe={...t,source:c,kind:"calculator"};w==="conservador"?E(oe):A.push(oe)});const re=z.map(t=>({...t})),W=w==="conservador"?z:z.filter(t=>t.kind!=="calculator"),U=Ot(W,w);U.ignoredCalculatorCandidates=A,U.notes=Array.from(new Set([...U.notes??[],...N].filter(Boolean)));const Oe=t=>{if(!Number.isFinite(t))return null;const c=Math.max(1,Math.round(t));return e.length>0?Math.min(c,e.length):c},ce=Number.isFinite(U.selectedDay)?Oe(U.selectedDay):null;if(ce!=null&&ce!==U.selectedDay){const t=`El día calculado (${U.selectedDay}) supera la duración del ciclo. Se usa ${ce}.`;U.notes=Array.from(new Set([...U.notes??[],t])),U.selectedDay=ce}let pe=null;ce!=null&&ce>=1&&(pe=ce-1);const B=f.length>0?f.length-1:null,$=Number.isInteger(pe)&&pe>=0?pe:null;let H=null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(x)){const t=Math.max($,Math.min(x-1,B));H=t>=$?t:$}else if(m(P)){const t=Math.min(B,P+2),c=Math.max($,t);H=c>=$?c:$}else H=B;const he=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,Q=t=>Number.isInteger(t)?B==null||B<0?t>=0?t:null:t<0?null:t>B?B:t:null,me=t=>{if(!Number.isInteger(t)||t<0||t>=e.length)return null;const c=e[t]?.isoDate;if(!c)return null;try{const D=Ue(c);return Number.isNaN(D?.getTime?.())?null:D}catch{return null}},ge=t=>{const c=me(t);if(!c)return null;try{return lt(c,"dd/MM")}catch{return null}};let ue=null,q=null;if(m(P)){const t=P+3;m(t)&&(ue=t);const c=P+4;m(c)&&(q=c);const D=Q(P),oe=me(D);if(oe)for(let ke=D+1;ke<e.length;ke+=1){const Xe=me(ke);if(!Xe)continue;const Re=ft(Xe,oe);if(ue==null&&Re>=3&&(ue=Q(ke)),q==null&&Re>=4&&(q=Q(ke)),ue!=null&&q!=null)break}}const Te=Q(k),se=Q(C);let J=Te;if(J==null&&se!=null){const t=Q(se-1);t!=null&&t>=0&&(J=t)}const ee=w==="conservador"?q??null:ue??null,De=null,be=[ee,se].filter(t=>Number.isInteger(t)),X=be.length>0?Math.min(...be):null,ae=Number.isInteger(ee),xe=Number.isInteger(se),ye=ae&&xe?Math.max(ee,se):null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(X)){const t=Math.max($,X-1);H=Math.min(t,B)}else H=B;const V=H??B??null,Z=X;let ie=null;ae&&xe?ie=w==="conservador"?"P+4 y T+3":"P+3 y T+3":ae?ie=w==="conservador"?"P+4":"P+3":xe&&(ie=S??"Temperatura");const Ae={conservador:"modo conservador",estandar:"modo estándar",marcador:"marcador explícito"},Ie=U?.selectedMode??w??"conservador",le=U?.usedCandidates??[],je=le.some(t=>t?.kind==="profile"),ve=le.some(t=>t?.kind==="calculator"),O=f.some(t=>t?.entryFlags?.hasAppearance||t?.entryFlags?.hasSensation||t?.symbolDetected&&t.symbolDetected!=="none");let G=`Fase fértil abierta (${Ae[Ie]??Ie}).`;Ie==="marcador"?G="Fase fértil abierta (ajustada por tus marcadores).":je&&O?G="Fase fértil abierta (basada en tus observaciones de moco).":ve&&!je&&(G="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const te=ae&&xe,Me="Infertilidad absoluta postovulatoria",de=`Ventana cerrada por doble criterio: ${ie??"criterio indeterminado"}.`,He=Q(P),Ce=ge(He),Ee=ge(J),We="Infertilidad estimada por moco",qe=Ce?`Fase de infertilidad alcanzada por determinación de día pico el ${Ce}.`:"Fase de infertilidad alcanzada por determinación de día pico.",Ke="Infertilidad estimada por temperatura",Qe=Ee?`Infertilidad estimada por temperatura desde el ${Ee}.`:"Infertilidad estimada por temperatura.",r=new Array(f.length).fill(null);let l=null,o=0,y=null;const d={inicio:0,aumento:1,alta:2,muyAlta:3},M=t=>{if(!t)return[];const c=[];if(Number.isFinite(t.M)&&t.M>0){const D=t.descriptors?.appearance;c.push(`M${t.M}${D?` (${D})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const D=t.descriptors?.sensation;c.push(`S${t.S}${D?` (${D})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?c.push("white"):c.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&c.push("cambio BIP"),c},_=["inicio","aumento","alta","muyAlta"];for(let t=0;t<f.length;t+=1){const c=f[t];if(!c){r[t]=null;continue}const D=Number.isInteger(X),oe=D?t>=X:!1,ke=Number.isInteger(ye)?t>=ye:!1,Xe=$!=null&&V!=null&&t>=$&&(D?t<X:t<=V)&&!oe,Re=Number.isInteger(R)&&R!=null?t>R:!1;if(!Xe){if(o=0,l=null,!(oe||V!=null&&t>V)||!D){r[t]=null;continue}const Ye=!!c.entryFlags?.hasAny,et=Ye?null:"Sin registro hoy; estimación basada en días adyacentes.";let Le=null,Be=null,$e=null;if(ke&&te?(Le=Me,Be=de,$e="absolute"):ae&&t>=ee?(Le=We,Be=qe,$e="mucus"):xe&&t>=se&&(Le=Ke,Be=Qe,$e="temperature"),!$e){r[t]=null;continue}r[t]={index:t,state:"infertil",status:$e,title:Le,header:Le,body:Be,detail:ie,hasRecord:Ye,inherited:!1,note:et,isFertile:!1,phase:"postOvulatory",label:Le,summaryText:Be,reasonsList:[],reasonsText:"",showFertilityStatus:!Re};continue}const Fe=!!c.entryFlags?.hasAny;let Ne=0;c.isPeakMarked||c.symbolDetected==="M+"||c.symbolDetected==="F"||c.S>=3||c.M>=3?Ne=3:c.M>=2||c.S>=2||c.symbolDetected==="M"?Ne=2:(c.M>=1||c.S>=1||c.hasChangeBIP)&&(Ne=1),Fe?(o=0,l=Ne):o+=1;const yt=c.M>=2||c.symbolDetected==="M+"||c.symbolDetected==="F"||c.S>=3;let Se=Ne,K=null;{if(!Fe){const Ye=l??Ne,et=Math.floor(o/2);Se=Math.max(0,Ye-et)}const Ze=Math.max(0,Math.min(3,Se));K=_[Ze]}const ot=M(c),Pe=ot.join("; "),_e=He!=null?t-He:null,Je=_e!=null?he(_e):null,It=Fe?null:"Sin registro hoy; estimación basada en días adyacentes.";K!=="waiting"&&(_e===0||_e===1||_e===2?(K="muyAlta",Se=Math.max(Se,3)):_e===3?(d[K]<d.alta&&(K="alta"),Se=Math.max(Se,2)):y!=null&&t-y<=3&&(d[K]<d.aumento&&(K="aumento"),Se=Math.max(Se,1))),(K==="alta"||K==="muyAlta"||yt)&&(y=t);let fe,ne;switch(K){case"waiting":fe="Fertilidad en espera de confirmación por temperatura",ne="Final de moco alcanzado (≥P+3). Ventana mantenida hasta confirmación térmica (T+3).";break;case"aumento":fe="Aumento de fertilidad",ne=Pe?`Signos en aumento: ${Pe}.`:"Signos en aumento.";break;case"alta":fe="Fertilidad alta",ne=Pe?`Signos fértiles claros (${Pe}).`:"Signos fértiles claros.";break;case"muyAlta":{fe="Fertilidad muy alta",ne=`Día de máxima fertilidad${Je?` (${Je})`:""}.`,ne+=Pe?` Signos pico: ${Pe}.`:" Signos pico presentes.";break}default:fe="Ventana fértil abierta",ne="Hoy sin signos destacables, a la espera de registrar más datos.";break}Fe||(K==="alta"?(fe="Fertilidad estimada alta",ne=`${ne} Sin datos apuntados este día; se estima en base a días cercanos.`):K==="muyAlta"?(fe="Fertilidad estimada muy alta",ne=`${ne} Sin datos apuntados este día; se estima en base a días cercanos.`):(K==="aumento"||K==="inicio")&&(fe="Ventana fértil abierta (sin registro hoy)",ne=`${ne} Sin datos apuntados este día; se estima en base a días cercanos.`));const vt={index:t,state:K,level:K==="waiting"?Ne:Se,title:fe,header:G,body:ne,reasonsList:ot,reasonsText:Pe,hasRecord:Fe,inherited:!Fe,note:It,isFertile:!0,phase:"fertile",label:fe,summaryText:ne,delta:Je,showFertilityStatus:!Re,reasonParts:{symbol:c.symbolDetected??null,appearance:c.descriptors?.appearance??null,sensation:c.descriptors?.sensation??null}};r[t]=vt}V!=null&&(H=V);let L=null;if(Number.isInteger(R)&&r.length>0){const t=Math.min(Math.max(R,0),r.length-1);let c=null;for(let D=t;D>=0;D-=1){const oe=r[D];if(oe&&(c||(c=oe),oe.isFertile)){L=oe;break}}!L&&c&&(L=c)}const T={bipScore:g,effectivePeakIndex:P,candidatesBeforeAggregate:re,closureDetail:ie,waitingStartIndex:De,pPlus3Index:ue,pPlus4Index:q,temperatureConfirmationIndex:J,temperatureInfertileIndex:se,temperatureRule:S??null,mucusInfertileStartIndex:ee,postOvulatoryStartIndex:Z,firstEstimateIndex:X,absoluteStartIndex:ye};return{fertileStartFinalIndex:pe,fertileWindow:$!=null&&H!=null?{startIndex:$,endIndex:H,waitingStartIndex:De,closureDetail:ie,temperatureConfirmationIndex:J,temperatureInfertileStartIndex:se,mucusInfertileStartIndex:ee,postOvulatoryStartIndex:Z,temperatureRule:S??null}:null,dailyAssessments:r,currentAssessment:L,candidates:re,aggregate:U,debug:T}},dt=e=>{if(!e)return null;try{const n=new Date(e);return Number.isNaN(n.getTime())?null:n}catch{return null}},Wt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const i=e.map(u=>{if(!u?.startDate||!u?.endDate)return null;const b=dt(u.startDate),w=dt(u.endDate);if(!b||!w||w<b)return null;const x=Math.round((w-b)/(1e3*60*60*24))+1;if(!Number.isFinite(x)||x<=0)return null;const C=!!u?.ignoredForAutoCalculations;return{duration:x,ignored:C}}).filter(Boolean).filter(u=>!u.ignored);if(i.length<6)return null;const v=i.reduce((u,b)=>b.duration<u.duration?b:u),p=i.length>=12?20:21,s=v.duration-p;return Number.isFinite(s)?{source:"CPM",day:Math.max(1,Math.round(s)),reason:`ciclo_mas_corto=${v.duration}`,kind:"calculator"}:null},rt=e=>{if(e==null||e==="")return null;const n=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(n)?n:null},qt=e=>{const n=[e?.temperature_chart,e?.temperature_raw,e?.temperature_corrected];for(const i of n){const v=rt(i);if(v!==null)return v}if(Array.isArray(e?.measurements)){const i=s=>{if(!s)return null;const u=rt(s.temperature),b=rt(s.temperature_corrected);return s.use_corrected&&b!==null?b:u!==null?u:b!==null?b:null},p=e.measurements.find(s=>s&&s.selected&&i(s)!==null)||e.measurements.find(s=>i(s)!==null);if(p){const s=i(p);if(s!==null)return s}}return null},Xt=(e=[],n)=>{if(!Array.isArray(e)||e.length===0||typeof n!="function")return null;const i=[];if(e.forEach(p=>{if(!p?.data||!Array.isArray(p.data)||!p.startDate)return;const s=p.data.filter(S=>S&&S.isoDate).map(S=>({...S,displayTemperature:qt(S)}));if(s.length===0)return;const{ovulationDetails:u}=n(s);if(!u?.confirmed)return;const b=Number.isInteger(u?.ovulationIndex)?u.ovulationIndex:Number.isInteger(u?.confirmationIndex)?u.confirmationIndex:null;if(b==null||b<0||b>=s.length)return;const w=s[b],x=Number(w?.cycleDay);if(!Number.isFinite(x)||x<=0)return;const C=Math.max(1,Math.round(x-8)),k={riseDay:x,t8Day:C,ignored:!!p?.ignoredForAutoCalculations};!k.ignored&&i.length<12&&i.push(k)}),i.length<6)return null;const v=i.reduce((p,s)=>s.t8Day<p.t8Day?s:p);return{source:"T8",day:Math.max(1,Math.round(v.t8Day)),reason:`t8=${v.t8Day}`,kind:"calculator"}},st={calculators:{cpm:!0,t8:!0},combineMode:"conservador"},at=35.8,it=37.2,mt=(e=[])=>{const n=f=>f&&f.displayTemperature!=null&&!f.ignored,p=f=>{if(!f||f.length!==6)return null;const g=f.map(I=>I.temp);if(g.some(I=>!Number.isFinite(I)))return null;const h=g.reduce((I,F)=>F>I?F:I,g[0]),m=g.reduce((I,F)=>F>=h-.05&&F<h?I+1:I,0);return m>=2?null:{baselineTemp:h,baselineStartIndex:f[0].index,baselineIndices:f.map(I=>I.index),baselineBorderlineCount:m}},s=f=>{const g=[];for(let h=f;h<e.length;h+=1){const m=e[h];if(!n(m))continue;const I=m.displayTemperature;if(Number.isFinite(I)&&(g.push({index:h,temp:I}),g.length>6&&g.shift(),g.length===6)){const F=p(g);if(!F)continue;let Y=null;for(let P=h+1;P<e.length;P+=1){const z=e[P];if(!n(z))continue;const E=z.displayTemperature;if(Number.isFinite(E)&&E>F.baselineTemp){Y=P;break}}return{baselineTemp:F.baselineTemp,baselineStartIndex:F.baselineStartIndex,baselineIndices:F.baselineIndices,baselineBorderlineCount:F.baselineBorderlineCount,firstHighIndex:Y}}}return null},u={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let b=null,w=null,x=null,C=[],k=u,S=0;const R=({baselineTemp:f,firstHighIndex:g})=>{if(g==null)return{confirmed:!1};const h=f+.2,m=[],I=[],F=new Set,Y=A=>{A==null||F.has(A)||(F.add(A),I.push(A))};let P=null,z=!1;const E=g>0?g-1:null,N=()=>E!=null?[E,...I]:[...I];for(let A=g;A<e.length;A++){const re=e[A];if(!n(re))break;const W=re.displayTemperature;if(!Number.isFinite(W))break;if(W>f){if(Y(A),m.push({index:A,temp:W}),m.length===3&&m[2].temp>=h)return{confirmed:!0,confirmationIndex:m[2].index,usedIndices:N(),highSequenceIndices:[...I],rule:"3-high"};if(m.length===4&&m[2].temp<h&&m[3].temp>f)return{confirmed:!0,confirmationIndex:m[3].index,usedIndices:N(),highSequenceIndices:[...I],rule:"german-3+1"};if(P!==null&&m.length===3&&m[2].temp>=h)return{confirmed:!0,confirmationIndex:m[2].index,usedIndices:N(),highSequenceIndices:[...I],rule:"german-2nd-exception"};if(m.length===5&&m[3].temp>f&&m[4].temp>=h)return{confirmed:!0,confirmationIndex:m[4].index,usedIndices:N(),highSequenceIndices:[...I],rule:"5-high"};continue}if(W>=f-.05&&P===null&&m.length>0&&m.length<3){P=A,Y(A),m.push({index:A,temp:f});continue}if(!z&&m.length>0&&m.length<3){z=!0,Y(A);continue}break}return{confirmed:!1,usedIndices:N(),highSequenceIndices:[...I]}};for(;S<e.length;){const f=s(S);if(!f)break;if(b=f.baselineTemp,w=f.baselineStartIndex,C=Array.isArray(f.baselineIndices)?[...f.baselineIndices]:[],x=f.firstHighIndex,f.baselineBorderlineCount,x==null){S=w+1;continue}const g=R(f);if(g?.requireRebaseline){S=w+1;continue}if(g?.confirmed){const h=g.highSequenceIndices?.length?g.highSequenceIndices[0]:null,m=Number.isInteger(g.confirmationIndex)?Math.max(0,Math.min(g.confirmationIndex,e.length-1)):null;let I=null;m!=null&&(I=Math.max(0,Math.min(m,e.length-1))),k={confirmed:!0,confirmationIndex:m,infertileStartIndex:I,rule:g.rule,highSequenceIndices:g.highSequenceIndices??g.usedIndices,usedIndices:g.usedIndices,ovulationIndex:x??h??null};break}S=w+1}return{baselineTemp:b,baselineStartIndex:w,firstHighIndex:x,baselineIndices:C,ovulationDetails:k}},Kt=(e,n,i,v,p,s=5,u=!1,b=null,w=[],x=null,C=!1)=>{const k=j.useRef(null),S=j.useRef(null),[R,f]=j.useState({width:0,height:0}),[g,h]=j.useState(null),[m,I]=j.useState({x:0,y:0}),[F,Y]=j.useState(null),P=j.useCallback(()=>{h(null),Y(null)},[]),z=r=>{if(r==null)return"";const l=String(r).trim().toUpperCase();return l==="P"||l==="PEAK"?"P":l==="1"||l==="P1"||l==="P+1"?"1":l==="2"||l==="P2"||l==="P+2"?"2":l==="3"||l==="P3"||l==="P+3"?"3":""},E=j.useMemo(()=>Dt(e),[e]),N=j.useMemo(()=>{const r=o=>{if(o==null||o==="")return null;const y=parseFloat(String(o).replace(",","."));return Number.isFinite(y)?y:null},l=o=>{if(!o)return null;const y=r(o.temperature),d=r(o.temperature_corrected);return o.use_corrected&&d!==null?d:y!==null?y:d!==null?d:null};return e.map(o=>{const y=[o?.temperature_chart,o?.temperature_raw,o?.temperature_corrected];let d=null;for(const t of y)if(t!=null&&t!==""){d=t;break}if(d==null&&Array.isArray(o?.measurements)){const c=o.measurements.find(D=>D&&D.selected&&l(D)!==null)||o.measurements.find(D=>l(D)!==null);c&&(d=l(c))}const M=o?.isoDate,_=o?.peak_marker??o?.peakStatus??null,L=M?E[M]??_:_,T=z(L);return{...o,displayTemperature:r(d),peakStatus:L??null,normalizedPeakStatus:T}})},[e,E]),A=j.useMemo(()=>{if(!Array.isArray(N)||N.length===0)return null;const r=new Date;let l=null;return N.forEach((o,y)=>{if(o?.isoDate)try{const d=Ue(o.isoDate);if(Number.isNaN(d?.getTime?.()))return;ft(d,r)<=0&&(l=y)}catch{}}),l},[N]);j.useLayoutEffect(()=>{const r=()=>{if(!k.current)return;const o=k.current.parentElement||k.current;let y=o.clientWidth||600,d=o.clientHeight||400,M=k.current.clientWidth>0?k.current.clientWidth:y,_,L;if(n){let T=window.innerWidth,t=window.innerHeight;if(u&&t>T&&([T,t]=[t,T]),M=T,i==="portrait"&&!u){const c=Math.max(30,T*.05);_=(T-c)/s*e.length}else _=T/s*e.length;L=t}else _=M/s*e.length,L=d;f({width:_,height:L})};r(),window.addEventListener("resize",r);let l;if(k.current){const o=k.current.parentElement||k.current;l=new ResizeObserver(r),l.observe(o)}return()=>{window.removeEventListener("resize",r),l&&l.disconnect()}},[n,e.length,s,i,u]);const re=j.useMemo(()=>N.filter(r=>r&&r.isoDate&&!r.ignored&&r.displayTemperature!==null&&r.displayTemperature!==void 0),[N]),W=j.useMemo(()=>N.filter(r=>r&&r.isoDate),[N]),U=re.length>0,Oe=j.useMemo(()=>!Array.isArray(N)||N.length===0?!1:N.some(r=>r?r.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(M=>{const _=r?.[M];return _!=null&&String(_).trim()!==""})||(()=>{const M=r?.fertility_symbol??r?.fertilitySymbol;return M==null?!1:String(M).trim()!==""})()||(()=>{const M=r?.observations??r?.notes;return M==null?!1:String(M).trim()!==""})()?!0:z(r?.normalizedPeakStatus??r?.peakStatus??r?.peak_marker)!=="":!1),[N]),ce=j.useMemo(()=>{const r=b??{},l=(_,L)=>typeof _=="boolean"?_:L,o={cpm:l(r?.calculators?.cpm,st.calculators.cpm),t8:l(r?.calculators?.t8,st.calculators.t8)},d=new Set(["conservador","estandar"]).has(r?.combineMode)?r.combineMode:st.combineMode,M=!!r?.postpartum;return{calculators:o,combineMode:d,postpartum:M}},[b]),pe=j.useMemo(()=>{if(Array.isArray(x)&&x.length>0)return x.map(y=>{if(!y)return null;const{source:d,day:M,reason:_}=y,L=typeof d=="string"?d.toUpperCase().replace(/-/g,""):"";if(L!=="CPM"&&L!=="T8")return null;const T=Number(M);return Number.isFinite(T)?{source:L,originalSource:d??L,day:T,reason:typeof _=="string"?_:"",kind:"calculator"}:null}).filter(Boolean);const r=Array.isArray(w)?w:[];if(!r.length)return[];const l=Wt(r),o=Xt(r,mt);return[l,o].filter(Boolean)},[x,w]),{peakDayIndex:B,thirdDayIndex:$,peakInfertilityStartIndex:H}=j.useMemo(()=>{if(!W.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const r=W.map(y=>y?.normalizedPeakStatus??z(y?.peakStatus??y?.peak_marker));let l=null,o=null;if(r.forEach((y,d)=>{y==="P"&&l==null&&(l=d),y==="3"&&o==null&&(o=d)}),l==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(o!=null){const y=W.length-1,d=Math.min(o+1,y);return{peakDayIndex:l,thirdDayIndex:o,peakInfertilityStartIndex:d}}return{peakDayIndex:l,thirdDayIndex:null,peakInfertilityStartIndex:null}},[W]),{baselineTemp:he,baselineStartIndex:Q,firstHighIndex:me,baselineIndices:ge,ovulationDetails:ue}=j.useMemo(()=>mt(N),[N]),q=j.useMemo(()=>({...ue??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:he,baselineIndices:ge,baselineStartIndex:Q,firstHighIndex:me,peakDayIndex:B,peakInfertilityStartIndex:H,thirdDayIndex:$}),[ue,he,ge,Q,me,B,H,$]),Te=j.useMemo(()=>Ht({processedData:N,config:ce,calculatorCandidates:pe,context:{postPeakStartIndex:H,peakThirdDayIndex:q?.thirdDayIndex??null,temperatureInfertileStartIndex:q?.infertileStartIndex??null,temperatureConfirmationIndex:q?.confirmationIndex??null,temperatureRule:q?.rule??null,todayIndex:A}}),[N,ce,pe,q?.thirdDayIndex,q?.infertileStartIndex,q?.confirmationIndex,q?.rule,B,H,A]),se=j.useMemo(()=>N.map((r,l)=>{if(!r)return r;const o=Number.isInteger(A)?l>A:!1;return{...r,isFutureDay:o}}),[N,A]),J=j.useMemo(()=>se.filter(r=>r&&r.isoDate),[se]),{tempMin:ee,tempMax:De}=j.useMemo(()=>{const r=re.map(T=>T.displayTemperature).filter(T=>T!=null);if(r.length===0)return{tempMin:at,tempMax:it};const l=it-at,o=Math.min(...r),y=Math.max(...r);let d=Math.min(o,at),M=Math.max(y,it);const _=T=>Math.floor(T*10)/10,L=T=>Math.ceil(T*10)/10;if(d=_(d),M=L(M),M-d<l){const T=(d+M)/2;d=_(T-l/2),M=L(T+l/2)}return Math.abs(d-o)<1e-9&&(d=_(d-.1)),Math.abs(M-y)<1e-9&&(M=L(M+.1)),{tempMin:parseFloat(d.toFixed(1)),tempMax:parseFloat(M.toFixed(1))}},[re]),be=De-ee,X=R.width,ae=R.height,xe=9,ye=(r=1)=>{if(!n)return xe*r;const l=Math.min(X,ae);return Math.max(8,Math.min(xe*r,l/(J.length>0?40/r:40)))},V=Math.round(ye(n?1.6:2)),Z=u||i==="landscape",ie=n?9:7.5,Ae=ie+(C?n?2:1.5:0),Ie=n?1:.75,le=Math.round(V*(ie+Ie)),je=Math.round(V*(Ae+Ie)),ve=le,O=C?Math.max(0,je-le):0,G=C?je:le,te=Math.max(ae-G,V*(n?10:8)),Me=G+Math.max(te,0),ze=Me+O,de={top:n?Math.max(Z?6:12,ae*(Z?.015:.03)):12,right:n?Math.max(Z?35:30,X*(Z?.02:.05)):50,bottom:Math.max(0,ve-1),left:n?Math.max(Z?45:20,X*(Z?.02:.05)):50},Ce=Math.max(0,Math.round(V*4)),Ee=Me-de.bottom-Ce,We=r=>{const l=Me-de.top-de.bottom-Ce;return r==null||be===0||l<=0?Ee:Ee-(r-ee)/be*l},qe=r=>{const l=n&&!(u||i==="landscape")?5:10,o=n&&!(u||i==="landscape")?25:0,y=15,d=n?Math.max(Z?8:18,X*(Z?.01:.05)):20,M=de.right+y,_=X-de.left-M-l-d*2-o*(J.length-1);if(_<=0)return de.left+l+d+o*r;const L=J.length>1?J.length-1:1;return L===0||J.length===0?de.left+l+d+o*r:de.left+l+d+r*(_/(J.length===1?1:L))+o*r},Ke=(r,l,o)=>{if(!r){P();return}const y=k.current.getBoundingClientRect();let d,M;if(o.type.startsWith("touch")){const t=o.changedTouches[0];d=t.clientX,M=t.clientY}else d=o.clientX,M=o.clientY;const _=qe(l),L=r.displayTemperature??r.temperature_chart??null,T=We(L);I({svgX:_,svgY:T,clientX:d-y.left+k.current.scrollLeft,clientY:M-y.top+k.current.scrollTop}),Y(l),h(r)};j.useEffect(()=>{const r=l=>{if(S.current&&!S.current.contains(l.target)){const o=k.current?.querySelectorAll("circle, text, rect");let y=!1;if(o){for(let d of o)if(d.contains(l.target)){y=!0;break}}y||P()}};return g&&(document.addEventListener("mousedown",r),document.addEventListener("touchstart",r)),()=>{document.removeEventListener("mousedown",r),document.removeEventListener("touchstart",r)}},[g,P]);const Qe=r=>{v&&r&&(v(p,r),P())};return{chartRef:k,tooltipRef:S,dimensions:{...R,contentHeight:Me,scrollableContentHeight:ze,extraScrollableHeight:O,viewportHeight:ae},activePoint:g,activeIndex:F,tooltipPosition:m,processedData:se,validDataForLine:re,allDataPoints:J,tempMin:ee,tempMax:De,tempRange:be,padding:de,textRowHeight:V,setActivePoint:h,setActiveIndex:Y,getY:We,getX:qe,handlePointInteraction:Ke,clearActivePoint:P,handleToggleIgnore:Qe,responsiveFontSize:ye,baselineTemp:he,baselineStartIndex:Q,baselineIndices:ge,firstHighIndex:me,ovulationDetails:q,fertilityStart:Te,hasTemperatureData:U,hasAnyObservation:Oe,graphBottomInset:Ce,todayIndex:A}};export{Gt as C,Wt as a,Xt as b,mt as c,Kt as u};
