import{r as E,j as l,m as Pe,B as tt,V as wt,k as lt,f as Ue,q as ht}from"./index-SThGP-UZ.js";import{l as Mt,B as kt}from"./badge-NjDKYZGp.js";import{X as Nt,C as ut,a as dt,P as nt,T as Tt,D as Pt}from"./peak-mode-button-DESZS8hz.js";import{a as Ct,c as At}from"./computePeakStatuses-DuBnmQQE.js";const Jt=({point:e,position:n,chartWidth:a,chartHeight:b,onToggleIgnore:f,onEdit:r,onClose:d,onTogglePeak:I,currentPeakIsoDate:w})=>{if(!e)return null;const v=.6,F=200,_=120,g=F*v,B=_*v,A=E.useRef(null),[q,C]=E.useState(B),[T,Y]=E.useState(!1);E.useEffect(()=>{A.current&&C(A.current.offsetHeight),Y(!1)},[e]);const N=n.clientX>a*.66,se=n.clientY+q>b;let z=N?n.clientX-g-10:n.clientX+10,L=se?n.clientY:n.clientY+10;z+g>a&&(z=a-g-10),L+q>b&&(L=b-q-10),z<10&&(z=10),L<10&&(L=10);const H=!e.id||String(e.id).startsWith("placeholder-"),ie=e.temperature_chart??e.displayTemperature??null,D=Ct(e.fertility_symbol),c=e.timestamp||e.isoDate,x=X=>{if(X==null)return null;const fe=String(X).trim();return fe.length?fe:null},h=X=>{if(!X)return null;try{const fe=Ue(X),K=fe.getTime();return Number.isNaN(K)?null:lt(fe,"HH:mm")}catch{return null}},M=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const X=e.measurements.filter(Boolean);if(!X.length)return null;const fe=[...X.filter(K=>K?.selected),...X.filter(K=>!K?.selected)];for(const K of fe){const De=!!K?.use_corrected?x(K?.time_corrected)??x(K?.time):x(K?.time);if(De)return De}return null})(),R=(e.use_corrected?[x(e.time_corrected),x(e.time)]:[x(e.time)]).find(Boolean)??h(e.timestamp),j=M??R,O=e.mucus_sensation??e.mucusSensation??"",te=e.mucus_appearance??e.mucusAppearance??"",V=e.observations??"",J=!!(e.had_relations??e.hadRelations),ge=D&&D.value!=="none",$=ie!=null,ae=!!(O&&O.trim()||te&&te.trim()),le=!!(V&&V.trim()),be=!($||ge||ae||le||J),U=e.peakStatus||(e.peak_marker==="peak"?"P":null),Ae=U&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[U]||null,Z=!!(I&&e.isoDate),ee=!!w,xe=ee&&e.isoDate===w||U==="P"||e.peak_marker==="peak",me=xe?"remove":ee?"update":"assign",Me=me==="assign"?"Asignar día pico":me==="update"?"Actualizar día pico":"Quitar día pico",ke=Me,ne=async()=>{if(!(!I||T)){Y(!0);try{await I(e,!xe),d&&d()}catch(X){console.error("Error toggling peak marker from tooltip:",X)}finally{Y(!1)}}},oe=()=>{ce()},ce=X=>{r&&(r(e,X),d&&d())},ve=(X=>{switch(X){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return l.jsxs(Pe.div,{ref:A,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:L,left:z,width:g},children:[l.jsx("div",{className:"origin-top-left",style:{transform:`scale(${v})`,width:F,minHeight:_},children:l.jsxs("div",{className:"relative tooltip-surface--gradient backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden",children:[l.jsx(tt,{variant:"ghost",size:"icon",onClick:d,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-suave rounded-full w-6 h-6 transition-all duration-200",children:l.jsx(Nt,{size:20})}),J&&l.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:l.jsx(wt,{className:"w-4 h-4 text-fertiliapp-fuerte",fill:"currentColor"})}),l.jsxs("div",{className:"p-2",children:[l.jsxs("div",{className:"mb-2 relative",children:[l.jsx("div",{className:"w-5 h-5 bg-fertiliapp-fuerte rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:l.jsx(ut,{className:"w-2 h-2 text-white",fill:"currentColor"})}),l.jsxs("div",{className:"mb-1 pl-8",children:[l.jsxs("div",{className:"flex items-baseline justify-start gap-2",children:[l.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:c?lt(Ue(c),"dd/MM",{locale:Mt}):"Fecha"}),l.jsxs("span",{className:"text-sm text-fertiliapp-fuerte font-medium whitespace-nowrap",children:["Día ",e.cycleDay||"N/A"]})]}),Ae&&l.jsx("div",{className:"mt-1 flex justify-start",children:l.jsx(kt,{className:"bg-tarjeta text-fertiliapp-fuerte border border-fertiliapp-suave px-2 py-0 text-[11px]",children:Ae})})]})]}),be?l.jsxs("div",{className:"pt-1 space-y-3",children:[l.jsx(Pe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:l.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(Z||r)&&l.jsxs(Pe.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[Z&&l.jsx(dt,{mode:me,size:"sm",onClick:ne,pending:T,"aria-label":ke,title:Me,className:"shrink-0"}),r&&l.jsxs(tt,{onClick:oe,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[l.jsx(nt,{className:"h-4 w-4"}),l.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"space-y-1",children:[$&&l.jsx(Pe.button,{type:"button",onClick:()=>ce("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-temp-suave rounded-2xl p-1 border border-temp focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-temp",disabled:!r,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-temp rounded-lg flex items-center justify-center shadow-md",children:l.jsx(Tt,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1",children:l.jsxs("div",{className:"flex items-center justify-between gap-3",children:[l.jsxs("div",{className:"flex items-baseline gap-2",children:[l.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(ie).toFixed(2)}),l.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&l.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),j&&l.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:j})]})})]})}),ge&&l.jsx(Pe.button,{type:"button",onClick:()=>ce("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${ve.light} rounded-3xl p-1 ${ve.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!r,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:`w-6 h-6 ${ve.bg} rounded-lg flex items-center justify-center shadow-lg ${ve.glow} shadow-lg`,children:l.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:`text-md font-semibold ${ve.text}`,children:D.label})})]})}),l.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[l.jsx(Pe.button,{type:"button",onClick:()=>ce("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-sensacion-suave rounded-3xl p-1 border border-sensacion focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!r,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-sensacion rounded-lg flex items-center justify-center shadow-md",children:l.jsx(Pt,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:"text-md font-semibold text-sensacion-fuerte",children:O||"-"})})]})}),l.jsx(Pe.button,{type:"button",onClick:()=>ce("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-apariencia-suave rounded-3xl p-1 border border-apariencia focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!r,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-apariencia rounded-lg flex items-center justify-center shadow-md",children:l.jsx(ut,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:"text-md font-semibold text-apariencia-fuerte",children:te||"-"})})]})}),le&&l.jsx(Pe.button,{type:"button",onClick:()=>ce("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-observaciones-suave rounded-3xl p-1 border border-observaciones focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!r,children:l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"w-6 h-6 bg-observaciones rounded-lg flex items-center justify-center shadow-md",children:l.jsx(nt,{className:"w-4 h-4 text-white"})}),l.jsx("div",{className:"flex-1 text-left",children:l.jsx("span",{className:"text-sm font-semibold text-observaciones-fuerte",children:V})})]})})]})]}),(r||f&&!H&&e.id||Z&&!H)&&l.jsxs(Pe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[Z&&!H&&l.jsx(dt,{mode:me,size:"sm",onClick:ne,pending:T,"aria-label":ke,title:Me,className:"shrink-0"}),l.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:r&&l.jsxs(tt,{onClick:oe,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[l.jsx(nt,{className:"h-4 w-4 mr-1.5"}),l.jsx("span",{className:"font-medium",children:H?"Añadir datos":""})]})})]})]})]})]})}),l.jsx("div",{className:"absolute -inset-2 tooltip-glow rounded-3xl blur-xl -z-10"})]})},Dt=({baselineTemp:e,firstHighIndex:n,processedData:a,isValid:b,findPreviousValidIndex:f})=>{if(n==null)return{confirmed:!1};const r=N=>N?.calcTemperature!=null?N.calcTemperature:N?.displayTemperature,d=N=>N?.ignoredForCalc!=null?N.ignoredForCalc:N?.ignored,I=e+.2,w=[],v=[],F=new Set,_=N=>{N==null||F.has(N)||(F.add(N),v.push(N))};let g=0,B=!1,A=null,q=!1;const C=typeof f=="function"?f(n-1):n>0?n-1:null,T=()=>C!=null?[C,...v]:[...v],Y=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:T(),highSequenceIndices:[...v]});for(let N=n;N<a.length;N+=1){const z=a[N];if(!z)break;if(d(z))continue;if(!b(z))break;const L=r(z);if(!Number.isFinite(L))break;const H=L<=e&&L>=e-.05;if(L<e-.05)return _(N),Y();if(L>e){if(_(N),w.push({index:N,temp:L}),!B&&w.length===3&&w[2].temp<I&&(q=!0),!B&&w.length===4&&w[2].temp>=I)return{confirmed:!0,confirmationIndex:w[3].index,usedIndices:T(),highSequenceIndices:[...v],rule:"pp-4-high"};if(!B&&q&&w.length===5)return{confirmed:!0,confirmationIndex:w[4].index,usedIndices:T(),highSequenceIndices:[...v],rule:"pp-ex1-5-high"};if(B){if(q=!1,w.length===3&&A==null)if(L>=I)A=N;else return Y();if(A!=null&&w.length>=4){const D=w[w.length-1].index;if(D!==A)return{confirmed:!0,confirmationIndex:D,usedIndices:T(),highSequenceIndices:[...v],rule:"pp-ex2-5-high"}}}continue}if(H){if(g+=1,_(N),g>=2)return Y();if(w.length>0&&w.length<3&&!B){B=!0;continue}break}break}return{confirmed:!1,usedIndices:T(),highSequenceIndices:[...v]}},Ve={0:0,1:.4,2:.8,3:1},jt={M:.8,F:1,"M+":1,white:.4},Ft=(e,n=0,a=1)=>!Number.isFinite(e)||e<n?n:e>a?a:e,_t=e=>e?String(e).toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),""):"",pt=e=>_t(e).replace(/\s+/g," ").trim(),gt=(e,n=[])=>{if(!e)return null;let a=null;return n.forEach((b,f)=>{const{patterns:r=[],level:d,descriptor:I,negatedLevel:w,allowedModifiers:v=null,disallowedModifiers:F=null,selectionScore:_,forceSelection:g=!1}=b||{};r.forEach(B=>{if(!B)return;const A=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${B})(?=$|[^a-z0-9])`,"g");let q;for(;(q=A.exec(e))!==null;){const C=q[1]?q[1].trim():null;if(v&&!v.includes(C)||F&&F.includes(C))continue;let T=d;C==="no"?T=w??1:C==="muy"?T=Math.min(3,d+1):(C==="poco"||C==="leve")&&(T=Math.max(0,d-1));const Y=_??T+f*.001,N=typeof I=="function"?I({modifier:C}):I;(!a||g||T>a.level||T===a.level&&Y>a.selectionScore)&&(a={level:T,baseLevel:d,descriptor:N,modifier:C,selectionScore:Y,force:g})}})}),a},Lt=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],Et=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],bt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const a=Math.round(e);if(a>=0&&a<=3)return a}const n=String(e).trim();return/^[0-3]$/.test(n)?Number.parseInt(n,10):null},xt=e=>{const n=bt(e);if(n!=null)return{level:n,reason:`S${n}`,descriptor:`S${n}`,hasInput:!0};const a=e!=null?String(e).trim():"",b=pt(e),f=a.length>0;if(!b)return{level:0,reason:null,descriptor:null,hasInput:f};if(/^s\s*0?$/.test(b))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(b==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const r=gt(b,Lt);return r?{level:Math.max(0,Math.min(3,r.level)),reason:r.descriptor,descriptor:r.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:f}},yt=e=>{const n=bt(e);if(n!=null)return{level:n,reason:`M${n}`,descriptor:`M${n}`,hasInput:!0};const a=e!=null?String(e).trim():"",b=pt(e),f=a.length>0;if(!b)return{level:0,reason:null,descriptor:null,hasInput:f};if(/^m\s*0$/.test(b))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(a))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const r=gt(b,Et);return r?{level:Math.max(0,Math.min(3,r.level)),reason:r.descriptor,descriptor:r.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:f}},Bt=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Rt=({appearance:e,observations:n,fertilitySymbol:a})=>{const b=[e,n,a].map(r=>String(r||"").toUpperCase()),f=r=>{if(!r)return!1;const I=`(?:^|[^\\p{L}\\p{N}])${Bt(r)}(?=$|[^\\p{L}\\p{N}])`,w=new RegExp(I,"u");return b.some(v=>w.test(v))};return f("M+")?"M+":f("M")?"M":f("F")||f("FER")?"F":String(a||"").toLowerCase()==="white"?"white":"none"},zt=e=>{if(e==null)return"";const n=String(e).trim().toUpperCase();return n==="P"||n==="PEAK"?"P":n==="1"||n==="P1"||n==="P+1"?"1":n==="2"||n==="P2"||n==="P+2"?"2":n==="3"||n==="P3"||n==="P+3"?"3":""},Ge=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,$t=(e,n,a)=>{const b=e?.mucusSensation??e?.mucus_sensation,f=e?.mucusAppearance??e?.mucus_appearance,r=e?.fertility_symbol??e?.fertilitySymbol,d=e?.observations??e?.notes,I=e?.peak_marker??e?.peakMarker??null,w=typeof I=="string"?I.trim().toLowerCase()==="peak":!1,v=xt(b),F=yt(f);let _=Ge(v.level),g=Ge(F.level);const B=[];v.reason&&B.push(`S:${v.reason}`),F.reason&&B.push(`M:${F.reason}`);const A=Rt({appearance:f,observations:d,fertilitySymbol:r}),q=A;let C=A;C==="white"&&(g=Math.max(g,1)),C==="M"&&(g=Math.max(g,2)),C==="M+"&&(g=Math.max(g,3)),C==="F"&&(g=Math.max(g,3),_=Math.max(_,3));const T=Ve[_]??0,Y=Ve[g]??0,N=Math.max(T,Y);C&&C!=="none"&&B.push(`symbol:${C}`);const se=jt[C]??0,z=Ft(Math.max(N,se)),L=n!=null&&Number.isFinite(n)?N>=n+.4-1e-9:!1;L&&B.push("cambioBIP");const H={hasSensation:!!v.hasInput,hasAppearance:!!F.hasInput,hasSymbol:r!=null&&String(r).trim()!==""&&String(r).trim().toLowerCase()!=="none",hasObservation:d!=null&&String(d).trim()!==""};H.hasAny=H.hasSensation||H.hasAppearance||H.hasSymbol||H.hasObservation;const ie=zt(e?.normalizedPeakStatus??e?.peakStatus??e?.peak_marker);return{index:a,S:_,M:g,symbolDetected:C,rawSymbol:q,isPeakMarked:w,scoreCore:N,scoreFertil:z,hasChangeBIP:L,reasons:B,entryFlags:H,descriptors:{sensation:v.descriptor??v.reason??null,appearance:F.descriptor??F.reason??null},normalizedPeakStatus:ie}},Ht=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const n=[];for(let f=0;f<Math.min(6,e.length);f+=1){const r=e[f];if(!r||String(r?.fertility_symbol||"").toLowerCase()==="red")continue;const I=xt(r?.mucusSensation??r?.mucus_sensation),w=yt(r?.mucusAppearance??r?.mucus_appearance),v=Ve[Ge(I.level)]??0,F=Ve[Ge(w.level)]??0;n.push(Math.max(v,F))}const a=n.length>0?Math.max(...n):0;return{days:e.map((f,r)=>$t(f,a,r)),bipScore:a}},Ot=e=>{for(let n=0;n<e.length;n+=1){const a=e[n];if(a){if(a.isPeakMarked)return{source:"Interno",day:n+1,reason:"P",kind:"profile"};if(a.symbolDetected==="white"||a.rawSymbol==="white")return{source:"Interno",day:n+1,reason:"white",kind:"profile"};if(a.symbolDetected==="M+"||a.symbolDetected==="F")return{source:"Interno",day:n+1,reason:"M+",kind:"profile"};if(a.symbolDetected==="M")return{source:"Interno",day:n+1,reason:"M",kind:"profile"};if(a.M>=2||a.S>=2)return{source:"Interno",day:n+1,reason:"S/M>=2",kind:"profile"}}}return null},Wt=(e,n)=>{const a=e.filter(r=>r&&Number.isFinite(r.day)).map(r=>({...r}));if(a.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:n,usedCandidates:[],notes:["Sin candidatos disponibles"]};const b=[...a].sort((r,d)=>{const I=Number.isFinite(r.day)?r.day:Number.POSITIVE_INFINITY,w=Number.isFinite(d.day)?d.day:Number.POSITIVE_INFINITY;return I-w}),f=Math.min(...b.map(r=>Math.round(r.day)));return{status:f!=null?"ok":"indeterminado",selectedDay:f??null,selectedMode:n,usedCandidates:b,notes:[]}},qt=({processedData:e=[],config:n={},calculatorCandidates:a=[],context:b={}})=>{const{calculators:f={cpm:!0,t8:!0},postpartum:r=!1,combineMode:d="estandar"}=n||{},w=new Set(["estandar"]).has(d)?d:"estandar",{postPeakStartIndex:v=null,temperatureInfertileStartIndex:F=null,temperatureConfirmationIndex:_=null,temperatureRule:g=null,todayIndex:B=null}=b||{},{days:A,bipScore:q}=Ht(e),C=Array.isArray(A)?A.length:0,T=t=>Number.isInteger(t)&&t>=0&&t<C,Y=t=>{const i=t?.peak_marker??t?.peakMarker??null;return typeof i=="string"&&i.trim().toLowerCase()==="peak"},se=(()=>{if(!Array.isArray(e)||e.length===0)return null;for(let t=e.length-1;t>=0;t-=1)if(Y(e[t]))return t;return null})(),z=T(se)?se:null,L=[],H=t=>{!t||!Number.isFinite(t.day)||L.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};H(Ot(A));const ie=[],D=[];r&&ie.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),r||a.forEach(t=>{if(!t)return;const i=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";if(!(i==="CPM"&&f.cpm||i==="T8"&&f.t8))return;const k={...t,source:i,kind:"calculator"};H(k)});const c=L.map(t=>({...t})),h=Wt(L,w);h.ignoredCalculatorCandidates=D,h.notes=Array.from(new Set([...h.notes??[],...ie].filter(Boolean)));const p=t=>{if(!Number.isFinite(t))return null;const i=Math.max(1,Math.round(t));return e.length>0?Math.min(i,e.length):i},M=Number.isFinite(h.selectedDay)?p(h.selectedDay):null;if(M!=null&&M!==h.selectedDay){const t=`El día calculado (${h.selectedDay}) supera la duración del ciclo. Se usa ${M}.`;h.notes=Array.from(new Set([...h.notes??[],t])),h.selectedDay=M}let P=null;M!=null&&M>=1&&(P=M-1);const R=A.length>0?A.length-1:null,j=Number.isInteger(P)&&P>=0?P:null;let O=null;if(j!=null&&R!=null&&R>=j)if(Number.isInteger(v)){const t=Math.max(j,Math.min(v-1,R));O=t>=j?t:j}else if(T(z)){const t=Math.min(R,z+2),i=Math.max(j,t);O=i>=j?i:j}else O=R;const te=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,V=t=>Number.isInteger(t)?R==null||R<0?t>=0?t:null:t<0?null:t>R?R:t:null,J=t=>{if(!Number.isInteger(t)||t<0||t>=e.length)return null;const i=e[t]?.isoDate;if(!i)return null;try{const y=Ue(i);return Number.isNaN(y?.getTime?.())?null:y}catch{return null}},ge=t=>{const i=J(t);if(!i)return null;try{return lt(i,"dd/MM")}catch{return null}};let $=null,ae=null;if(T(z)){const t=z+3;T(t)&&($=t);const i=z+4;T(i)&&(ae=i);const y=V(z),k=J(y);if(k)for(let W=y+1;W<e.length;W+=1){const Q=J(W);if(!Q)continue;const de=ht(Q,k);if($==null&&de>=3&&($=V(W)),ae==null&&de>=4&&(ae=V(W)),r){if(ae!=null)break}else if($!=null)break}}const le=V(_),G=V(F);let be=le;if(be==null&&G!=null){const t=V(G-1);t!=null&&t>=0&&(be=t)}const U=(r?ae:$)??null,Ce=null,Ae=[U,G].filter(t=>Number.isInteger(t)),Z=Ae.length>0?Math.min(...Ae):null,ee=Number.isInteger(U),Ie=Number.isInteger(G),xe=ee&&Ie?Math.max(U,G):null;if(j!=null&&R!=null&&R>=j)if(Number.isInteger(Z)){const t=Math.max(j,Z-1);O=Math.min(t,R)}else O=R;const me=O??R??null,Me=Z,ke=r?"P+4":"P+3";let ne=null;ee&&Ie?ne=`${ke} y T+3`:ee?ne=ke:Ie&&(ne=g??"Temperatura");const oe={estandar:"modo estándar",marcador:"marcador explícito"},ce=h?.selectedMode??w??"estandar",Le=h?.usedCandidates??[],ve=Le.some(t=>t?.kind==="profile"),X=Le.some(t=>t?.kind==="calculator"),fe=A.some(t=>t?.entryFlags?.hasAppearance||t?.entryFlags?.hasSensation||t?.symbolDetected&&t.symbolDetected!=="none");let K=`Fase fértil abierta (${oe[ce]??ce}).`;ce==="marcador"?K="Fase fértil abierta (ajustada por tus marcadores).":ve&&fe?K="Fase fértil abierta (basada en tus observaciones de moco).":X&&!ve&&(K="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const qe=ee&&Ie,De="Infertilidad absoluta postovulatoria",Qe=`Ventana cerrada por doble criterio: ${ne??"criterio indeterminado"}.`,Ne=V(z),Xe=ge(Ne),je=ge(be),ue="Infertilidad estimada por moco",ot=Xe?`Fase de infertilidad alcanzada por determinación de día pico el ${Xe}.`:"Fase de infertilidad alcanzada por determinación de día pico.",Ee="Infertilidad estimada por temperatura",$e=je?`Infertilidad estimada por temperatura desde el ${je}.`:"Infertilidad estimada por temperatura.",ye=new Array(A.length).fill(null);let Fe=null,Be=0,He=null;const s={inicio:0,aumento:1,alta:2,muyAlta:3},u=t=>{if(!t)return[];const i=[];if(Number.isFinite(t.M)&&t.M>0){const y=t.descriptors?.appearance;i.push(`M${t.M}${y?` (${y})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const y=t.descriptors?.sensation;i.push(`S${t.S}${y?` (${y})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?i.push("white"):i.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&i.push("cambio BIP"),i},S=["inicio","aumento","alta","muyAlta"];for(let t=0;t<A.length;t+=1){const i=A[t];if(!i){ye[t]=null;continue}const y=Number.isInteger(Z),k=y?t>=Z:!1,W=Number.isInteger(xe)?t>=xe:!1,Q=j!=null&&me!=null&&t>=j&&(y?t<Z:t<=me)&&!k,de=Number.isInteger(B)&&B!=null?t>B:!1;if(!Q){if(Be=0,Fe=null,!(k||me!=null&&t>me)||!y){ye[t]=null;continue}const Ye=!!i.entryFlags?.hasAny,et=Ye?null:"Sin registro hoy; estimación basada en días adyacentes.";let ze=null,Oe=null,We=null;if(W&&qe?(ze=De,Oe=Qe,We="absolute"):ee&&t>=U?(ze=ue,Oe=ot,We="mucus"):Ie&&t>=G&&(ze=Ee,Oe=$e,We="temperature"),!We){ye[t]=null;continue}ye[t]={index:t,state:"infertil",status:We,title:ze,header:ze,body:Oe,detail:ne,hasRecord:Ye,inherited:!1,note:et,isFertile:!1,phase:"postOvulatory",label:ze,summaryText:Oe,reasonsList:[],reasonsText:"",showFertilityStatus:!de};continue}const pe=!!i.entryFlags?.hasAny;let Se=0;i.isPeakMarked||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3||i.M>=3?Se=3:i.M>=2||i.S>=2||i.symbolDetected==="M"?Se=2:(i.M>=1||i.S>=1||i.hasChangeBIP)&&(Se=1),pe?(Be=0,Fe=Se):Be+=1;const It=i.M>=2||i.symbolDetected==="M+"||i.symbolDetected==="F"||i.S>=3;let Te=Se,re=null;{if(!pe){const Ye=Fe??Se,et=Math.floor(Be/2);Te=Math.max(0,Ye-et)}const Ze=Math.max(0,Math.min(3,Te));re=S[Ze]}const ct=u(i),_e=ct.join("; "),Re=Ne!=null?t-Ne:null,Je=Re!=null?te(Re):null,vt=pe?null:"Sin registro hoy; estimación basada en días adyacentes.";re!=="waiting"&&(Re===0||Re===1||Re===2?(re="muyAlta",Te=Math.max(Te,3)):Re===3?(s[re]<s.alta&&(re="alta"),Te=Math.max(Te,2)):He!=null&&t-He<=3&&(s[re]<s.aumento&&(re="aumento"),Te=Math.max(Te,1))),(re==="alta"||re==="muyAlta"||It)&&(He=t);let we,he;switch(re){case"waiting":we="Fertilidad en espera de confirmación por temperatura",he=`Final de moco alcanzado (≥${ke}). Ventana mantenida hasta confirmación térmica (T+3).`;break;case"aumento":we="Aumento de fertilidad",he=_e?`Signos en aumento: ${_e}.`:"Signos en aumento.";break;case"alta":we="Fertilidad alta",he=_e?`Signos fértiles claros (${_e}).`:"Signos fértiles claros.";break;case"muyAlta":{we="Fertilidad muy alta",he=`Día de máxima fertilidad${Je?` (${Je})`:""}.`,he+=_e?` Signos pico: ${_e}.`:" Signos pico presentes.";break}default:we="Ventana fértil abierta",he="Hoy sin signos destacables, a la espera de registrar más datos.";break}pe||(re==="alta"?(we="Fertilidad estimada alta",he=`${he} Sin datos apuntados este día; se estima en base a días cercanos.`):re==="muyAlta"?(we="Fertilidad estimada muy alta",he=`${he} Sin datos apuntados este día; se estima en base a días cercanos.`):(re==="aumento"||re==="inicio")&&(we="Ventana fértil abierta (sin registro hoy)",he=`${he} Sin datos apuntados este día; se estima en base a días cercanos.`));const St={index:t,state:re,level:re==="waiting"?Se:Te,title:we,header:K,body:he,reasonsList:ct,reasonsText:_e,hasRecord:pe,inherited:!pe,note:vt,isFertile:!0,phase:"fertile",label:we,summaryText:he,delta:Je,showFertilityStatus:!de,reasonParts:{symbol:i.symbolDetected??null,appearance:i.descriptors?.appearance??null,sensation:i.descriptors?.sensation??null}};ye[t]=St}me!=null&&(O=me);let o=null;if(Number.isInteger(B)&&ye.length>0){const t=Math.min(Math.max(B,0),ye.length-1);let i=null;for(let y=t;y>=0;y-=1){const k=ye[y];if(k&&(i||(i=k),k.isFertile)){o=k;break}}!o&&i&&(o=i)}const m={bipScore:q,effectivePeakIndex:z,candidatesBeforeAggregate:c,closureDetail:ne,waitingStartIndex:Ce,pPlus3Index:$,pPlus4Index:ae,temperatureConfirmationIndex:be,temperatureInfertileIndex:G,temperatureRule:g??null,mucusInfertileStartIndex:U,postOvulatoryStartIndex:Me,firstEstimateIndex:Z,absoluteStartIndex:xe};return{fertileStartFinalIndex:P,fertileWindow:j!=null&&O!=null?{startIndex:j,endIndex:O,waitingStartIndex:Ce,closureDetail:ne,temperatureConfirmationIndex:be,temperatureInfertileStartIndex:G,mucusInfertileStartIndex:U,postOvulatoryStartIndex:Me,temperatureRule:g??null}:null,dailyAssessments:ye,currentAssessment:o,candidates:c,aggregate:h,debug:m}},mt=e=>{if(!e)return null;try{const n=new Date(e);return Number.isNaN(n.getTime())?null:n}catch{return null}},Xt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const a=e.map(d=>{if(!d?.startDate||!d?.endDate)return null;const I=mt(d.startDate),w=mt(d.endDate);if(!I||!w||w<I)return null;const v=Math.round((w-I)/(1e3*60*60*24))+1;if(!Number.isFinite(v)||v<=0)return null;const F=!!d?.ignoredForAutoCalculations;return{duration:v,ignored:F}}).filter(Boolean).filter(d=>!d.ignored);if(a.length<6)return null;const b=a.reduce((d,I)=>I.duration<d.duration?I:d),f=a.length>=12?20:21,r=b.duration-f;return Number.isFinite(r)?{source:"CPM",day:Math.max(1,Math.round(r)),reason:`ciclo_mas_corto=${b.duration}`,kind:"calculator"}:null},rt=e=>{if(e==null||e==="")return null;const n=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(n)?n:null},Yt=e=>{const n=[e?.temperature_chart,e?.temperature_raw,e?.temperature_corrected];for(const a of n){const b=rt(a);if(b!==null)return b}if(Array.isArray(e?.measurements)){const a=r=>{if(!r)return null;const d=rt(r.temperature),I=rt(r.temperature_corrected);return r.use_corrected&&I!==null?I:d!==null?d:I!==null?I:null},f=e.measurements.find(r=>r&&r.selected&&a(r)!==null)||e.measurements.find(r=>a(r)!==null);if(f){const r=a(f);if(r!==null)return r}}return null},Ut=(e=[],n)=>{if(!Array.isArray(e)||e.length===0||typeof n!="function")return null;const a=[];if(e.forEach(f=>{if(!f?.data||!Array.isArray(f.data)||!f.startDate)return;const r=f.data.filter(g=>g&&g.isoDate).map(g=>({...g,displayTemperature:Yt(g)}));if(r.length===0)return;const{ovulationDetails:d}=n(r);if(!d?.confirmed)return;const I=Number.isInteger(d?.ovulationIndex)?d.ovulationIndex:Number.isInteger(d?.confirmationIndex)?d.confirmationIndex:null;if(I==null||I<0||I>=r.length)return;const w=r[I],v=Number(w?.cycleDay);if(!Number.isFinite(v)||v<=0)return;const F=Math.max(1,Math.round(v-8)),_={riseDay:v,t8Day:F,ignored:!!f?.ignoredForAutoCalculations};!_.ignored&&a.length<12&&a.push(_)}),a.length<6)return null;const b=a.reduce((f,r)=>r.t8Day<f.t8Day?r:f);return{source:"T8",day:Math.max(1,Math.round(b.t8Day)),reason:`t8=${b.t8Day}`,kind:"calculator"}},st={calculators:{cpm:!0,t8:!0},combineMode:"estandar"},it=36.1,at=37.5,ft=(e=[],n={})=>{const{postpartum:a=!1}=n,b=c=>c?.calcTemperature!=null?c.calcTemperature:c?.displayTemperature,f=c=>c?.ignoredForCalc!=null?c.ignoredForCalc:c?.ignored,r=c=>c&&b(c)!=null&&!f(c),d=c=>r(c)&&Number.isFinite(b(c)),I=6,w=.05,v=!1,F=(c,x=d)=>{if(!Number.isInteger(c))return null;for(let h=c;h>=0;h-=1){const p=e[h];if(x(p))return h}return null},_=(c,x=d)=>{if(!Array.isArray(c)||c.length===0)return[];const h=new Set,p=[];return c.forEach(M=>{const P=Number(M);if(!Number.isInteger(P)||P<0||P>=e.length||h.has(P))return;const R=e[P];x(R)&&(h.add(P),p.push(P))}),p},g=c=>{if(!c||c.length!==I)return null;const x=c.map(M=>M.temp);if(x.some(M=>!Number.isFinite(M)))return null;const h=x.reduce((M,P)=>P>M?P:M,x[0]),p=x.reduce((M,P)=>P>=h-w&&P<h?M+1:M,0);return p>=2?null:{baselineTemp:h,baselineStartIndex:c[0].index,baselineIndices:c.map(M=>M.index),baselineBorderlineCount:p}},B=c=>{const x=[];for(let h=c;h<e.length;h+=1){const p=e[h];if(!r(p))continue;const M=b(p);if(Number.isFinite(M)&&(x.push({index:h,temp:M}),x.length>I&&x.shift(),x.length===I)){const P=g(x);if(!P)continue;let R=null;for(let j=h+1;j<e.length;j+=1){const O=e[j];if(!r(O))continue;const te=b(O);if(Number.isFinite(te)&&te>P.baselineTemp){R=j;break}}return{baselineTemp:P.baselineTemp,baselineStartIndex:P.baselineStartIndex,baselineIndices:P.baselineIndices,baselineBorderlineCount:P.baselineBorderlineCount,firstHighIndex:R}}}return null},A={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let q=null,C=null,T=null,Y=[],N=A,se=0;const z=({baselineTemp:c,firstHighIndex:x})=>{if(x==null)return{confirmed:!1};const h=c+.2,p=[],M=[],P=new Set,R=$=>{$==null||P.has($)||(P.add($),M.push($))};let j=!1,O=0,te=!1;const V=F(x-1),J=()=>V!=null?[V,...M]:[...M],ge=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:J(),highSequenceIndices:[...M]});for(let $=x;$<e.length;$++){const ae=e[$];if(!ae)break;if(f(ae))continue;const G=b(ae);if(!Number.isFinite(G))break;if(G>c){if(R($),p.push({index:$,temp:G}),j){if(p.length===3)return G>=h?{confirmed:!0,confirmationIndex:$,usedIndices:J(),highSequenceIndices:[...M],rule:"german-2nd-exception"}:ge();continue}if(p.length===3&&p[2].temp>=h)return{confirmed:!0,confirmationIndex:p[2].index,usedIndices:J(),highSequenceIndices:[...M],rule:"3-high"};if(p.length===4&&p[2].temp<h&&p[3].temp>c)return{confirmed:!0,confirmationIndex:p[3].index,usedIndices:J(),highSequenceIndices:[...M],rule:"german-3+1"};if(p.length===5&&p[3].temp>c&&p[4].temp>=h)return{confirmed:!0,confirmationIndex:p[4].index,usedIndices:J(),highSequenceIndices:[...M],rule:"5-high"};continue}if(G<=c&&G>=c-.05&&p.length>0&&p.length<3){if(O+=1,R($),O>=2)return ge();j=!0;continue}if(!te&&!j&&p.length>0&&p.length<3){te=!0,R($);continue}break}return{confirmed:!1,usedIndices:J(),highSequenceIndices:[...M]}};for(;se<e.length;){const c=B(se);if(!c)break;if(q=c.baselineTemp,C=c.baselineStartIndex,Y=Array.isArray(c.baselineIndices)?[...c.baselineIndices]:[],T=c.firstHighIndex,c.baselineBorderlineCount,T==null){se=C+1;continue}const x=a?Dt({...c,processedData:e,isValid:r,findPreviousValidIndex:F}):z(c);if(x?.requireRebaseline){se=C+1;continue}if(x?.confirmed){const h=x.highSequenceIndices?.length?x.highSequenceIndices[0]:null,p=Number.isInteger(x.confirmationIndex)?Math.max(0,Math.min(x.confirmationIndex,e.length-1)):null;let M=null;p!=null&&(M=Math.max(0,Math.min(p,e.length-1))),N={confirmed:!0,confirmationIndex:p,infertileStartIndex:M,rule:x.rule,highSequenceIndices:x.highSequenceIndices??x.usedIndices,usedIndices:x.usedIndices,ovulationIndex:T??h??null};break}se=C+1}const L=_(Y),H=_(N?.highSequenceIndices),ie=_(N?.usedIndices),D={...N,highSequenceIndices:H,usedIndices:ie};if(v){const c=h=>{const p=e[h];return p?{index:h,isoDate:p.isoDate,displayTemperature:p.displayTemperature,calcTemperature:b(p),ignored:p.ignored,ignoredForCalc:f(p),use_corrected:p.use_corrected,temperature_raw:p.temperature_raw??null,temperature_corrected:p.temperature_corrected??null,temperature_chart:p.temperature_chart??null}:null},x=(h,p)=>{console.groupCollapsed(`${h} (${p.length})`),p.forEach(M=>console.log(c(M))),console.groupEnd()};console.groupCollapsed("[fertility] Ovulation metrics debug"),console.log("baselineTemp",q),console.log("baselineIndices",L),console.log("firstHighIndex",T),console.log("ovulationDetails",{rule:D?.rule,confirmationIndex:D?.confirmationIndex,highSequenceIndices:H,usedIndices:ie}),x("baselineIndices",L),x("highSequenceIndices",H),x("usedIndices",ie),console.groupEnd()}return{baselineTemp:q,baselineStartIndex:C,firstHighIndex:T,baselineIndices:L,ovulationDetails:D}},Zt=(e,n,a,b,f,r=5,d=!1,I=null,w=[],v=null,F=!1,_=!1)=>{const g=E.useRef(null),B=E.useRef(null),[A,q]=E.useState({width:0,height:0,viewportWidth:0,viewportHeight:0}),[C,T]=E.useState(null),[Y,N]=E.useState({x:0,y:0}),[se,z]=E.useState(null),L=E.useCallback(()=>{T(null),z(null)},[]),H=s=>{if(s==null)return"";const u=String(s).trim().toUpperCase();return u==="P"||u==="PEAK"?"P":u==="1"||u==="P1"||u==="P+1"?"1":u==="2"||u==="P2"||u==="P+2"?"2":u==="3"||u==="P3"||u==="P+3"?"3":""},ie=E.useMemo(()=>At(e),[e]),D=E.useMemo(()=>{const s=o=>{if(o==null||o==="")return null;const m=parseFloat(String(o).replace(",","."));return Number.isFinite(m)?m:null},u=o=>{if(!o)return null;const m=s(o.temperature),t=s(o.temperature_corrected);return o.use_corrected&&t!==null?t:m!==null?m:t!==null?t:null},S=o=>{if(!o)return null;const m=s(o.temperature_chart),t=s(o.temperature_raw),i=s(o.temperature_corrected);if(o.use_corrected&&i!==null)return i;if(m!==null)return m;if(t!==null)return t;if(i!==null)return i;if(Array.isArray(o.measurements)){const k=o.measurements.find(W=>W&&W.selected&&u(W)!==null)||o.measurements.find(W=>u(W)!==null);if(k)return u(k)}return null};return e.map(o=>{const m=S(o),t=Array.isArray(o?.measurements)?o.measurements.some(pe=>pe?.ignored):!1,i=o?.isoDate,y=o?.peak_marker??o?.peakStatus??null,k=i?ie[i]??y:y,W=H(k),Q=s(m),de=!!(o?.ignored||t);return{...o,displayTemperature:Q,calcTemperature:de?null:Q,ignoredForCalc:de,peakStatus:k??null,normalizedPeakStatus:W}})},[e,ie]),c=E.useMemo(()=>{if(!Array.isArray(D)||D.length===0)return null;const s=new Date;let u=null;return D.forEach((S,o)=>{if(S?.isoDate)try{const m=Ue(S.isoDate);if(Number.isNaN(m?.getTime?.()))return;ht(m,s)<=0&&(u=o)}catch{}}),u},[D]);E.useLayoutEffect(()=>{const s=()=>{if(!g.current)return;const S=g.current.parentElement||g.current;let o=S.clientWidth||600,m=S.clientHeight||400,t=g.current.clientWidth>0?g.current.clientWidth:o,i,y,k,W;if(n){let Q=window.innerWidth,de=window.innerHeight;if(_){const pe=g.current?.clientWidth||S?.clientWidth||o,Se=g.current?.clientHeight||S?.clientHeight||m;Q=pe,de=Se}if(d&&de>Q&&([Q,de]=[de,Q]),t=Q,k=Q,W=de,a==="portrait"&&!d){const pe=Math.max(30,Q*.05);i=(Q-pe)/r*e.length}else i=Q/r*e.length;y=de}else i=t/r*e.length,y=m,k=t,W=m;q({width:i,height:y,viewportWidth:k,viewportHeight:W})};s(),window.addEventListener("resize",s);let u;if(g.current){const S=g.current.parentElement||g.current;u=new ResizeObserver(s),u.observe(S)}return()=>{window.removeEventListener("resize",s),u&&u.disconnect()}},[n,e.length,r,a,d,_]);const x=E.useMemo(()=>D.filter(s=>s&&s.isoDate&&!s.ignored&&s.displayTemperature!==null&&s.displayTemperature!==void 0),[D]),h=E.useMemo(()=>D.filter(s=>s&&s.isoDate),[D]),p=x.length>0,M=E.useMemo(()=>!Array.isArray(D)||D.length===0?!1:D.some(s=>s?s.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(t=>{const i=s?.[t];return i!=null&&String(i).trim()!==""})||(()=>{const t=s?.fertility_symbol??s?.fertilitySymbol;return t==null?!1:String(t).trim()!==""})()||(()=>{const t=s?.observations??s?.notes;return t==null?!1:String(t).trim()!==""})()?!0:H(s?.normalizedPeakStatus??s?.peakStatus??s?.peak_marker)!=="":!1),[D]),P=E.useMemo(()=>{const s=I??{},u=(i,y)=>typeof i=="boolean"?i:y,S={cpm:u(s?.calculators?.cpm,st.calculators.cpm),t8:u(s?.calculators?.t8,st.calculators.t8)},m=new Set(["estandar"]).has(s?.combineMode)?s.combineMode:st.combineMode,t=!!s?.postpartum;return{calculators:S,combineMode:m,postpartum:t}},[I]),R=E.useMemo(()=>{if(Array.isArray(v)&&v.length>0)return v.map(o=>{if(!o)return null;const{source:m,day:t,reason:i}=o,y=typeof m=="string"?m.toUpperCase().replace(/-/g,""):"";if(y!=="CPM"&&y!=="T8")return null;const k=Number(t);return Number.isFinite(k)?{source:y,originalSource:m??y,day:k,reason:typeof i=="string"?i:"",kind:"calculator"}:null}).filter(Boolean);const s=Array.isArray(w)?w:[];if(!s.length)return[];const u=Xt(s),S=Ut(s,ft);return[u,S].filter(Boolean)},[v,w]),{peakDayIndex:j,thirdDayIndex:O,peakInfertilityStartIndex:te}=E.useMemo(()=>{if(!h.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const s=h.map(o=>o?.normalizedPeakStatus??H(o?.peakStatus??o?.peak_marker));let u=null,S=null;if(s.forEach((o,m)=>{o==="P"&&u==null&&(u=m),o==="3"&&S==null&&(S=m)}),u==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(S!=null){const o=h.length-1,m=Math.min(S+1,o);return{peakDayIndex:u,thirdDayIndex:S,peakInfertilityStartIndex:m}}return{peakDayIndex:u,thirdDayIndex:null,peakInfertilityStartIndex:null}},[h]),{baselineTemp:V,baselineStartIndex:J,firstHighIndex:ge,baselineIndices:$,ovulationDetails:ae}=E.useMemo(()=>ft(D,{postpartum:P.postpartum}),[D,P.postpartum]),le=E.useMemo(()=>({...ae??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:V,baselineIndices:$,baselineStartIndex:J,firstHighIndex:ge,peakDayIndex:j,peakInfertilityStartIndex:te,thirdDayIndex:O}),[ae,V,$,J,ge,j,te,O]),G=E.useMemo(()=>qt({processedData:D,config:P,calculatorCandidates:R,context:{postPeakStartIndex:te,peakThirdDayIndex:le?.thirdDayIndex??null,temperatureInfertileStartIndex:le?.infertileStartIndex??null,temperatureConfirmationIndex:le?.confirmationIndex??null,temperatureRule:le?.rule??null,todayIndex:c}}),[D,P,R,le?.thirdDayIndex,le?.infertileStartIndex,le?.confirmationIndex,le?.rule,j,te,c]),be=E.useMemo(()=>D.map((s,u)=>{if(!s)return s;const S=Number.isInteger(c)?u>c:!1;return{...s,isFutureDay:S}}),[D,c]),U=E.useMemo(()=>be.filter(s=>s&&s.isoDate),[be]),{tempMin:Ce,tempMax:Ae}=E.useMemo(()=>{const s=x.map(k=>k.displayTemperature).filter(k=>k!=null);if(s.length===0)return{tempMin:it,tempMax:at};const u=at-it,S=Math.min(...s),o=Math.max(...s);let m=Math.min(S,it),t=Math.max(o,at);const i=k=>Math.floor(k*10)/10,y=k=>Math.ceil(k*10)/10;if(m=i(m),t=y(t),t-m<u){const k=(m+t)/2;m=i(k-u/2),t=y(k+u/2)}return Math.abs(m-S)<1e-9&&(m=i(m-.1)),Math.abs(t-o)<1e-9&&(t=y(t+.1)),{tempMin:parseFloat(m.toFixed(1)),tempMax:parseFloat(t.toFixed(1))}},[x]),Z=Ae-Ce,ee=A.width,Ie=A.viewportHeight||A.height,xe=A.viewportWidth||ee,me=(s,u,S)=>Math.min(S,Math.max(s,u)),Me=_?11:9,ke=(s=1)=>{if(_){const o=(A.viewportWidth||xe||ee||1)/Math.max(Number(r)||1,1),t=me(11,o*.33,15)*s;return me(10,t,18)}if(!n)return Me*s;const u=Math.min(ee,Ie);return Math.max(8,Math.min(Me*s,u/(U.length>0?40/s:40)))},ne=Math.round(ke(n?_?1.45:1.6:2)),oe=d||a==="landscape",ce=_&&n&&oe&&r>=28,Le=n?9:7.5,ve=Le+(F?n?2:1.5:0),X=n?1:.75,fe=Math.round(ne*(Le+X)),K=Math.round(ne*(ve+X)),qe=fe,De=F?Math.max(0,K-fe):0,Ke=F?K:fe,Qe=Math.max(Ie-Ke,ne*(n?10:8)),Ne=Ke+Math.max(Qe,0),Xe=Ne+De,je={top:n?Math.max(oe?6:12,Ie*(oe?.015:.03)):12,right:n?Math.max(oe?35:30,Math.min(ee,xe)*(oe?.02:.05)):50,bottom:Math.max(0,qe-1),left:n?Math.max(oe?45:20,Math.min(ee,xe)*(oe?.02:.05)):50},ue=ce?{...je,left:Math.max(34,Math.round(je.left*.78)),right:Math.max(18,Math.round(je.right*.6))}:je,Ee=Math.max(0,Math.round(ne*4)),$e=Ne-ue.bottom-Ee,ye=E.useCallback(s=>{const u=Ne-ue.top-ue.bottom-Ee;return s==null||Z===0||u<=0?$e:$e-(s-Ce)/Z*u},[Ne,ue.top,ue.bottom,Ee,Z,$e,Ce]),Fe=E.useCallback(s=>{const u=ce?2:n&&!(d||a==="landscape")?5:10,S=n&&!(d||a==="landscape")?25:0,o=ce?4:15,m=ce?0:n?Math.max(oe?8:18,Math.min(ee,xe)*(oe?.01:.05)):20,t=ue.right+o,i=ee-ue.left-t-u-m*2-S*(U.length-1);if(i<=0)return ue.left+u+m+S*s;const y=U.length>1?U.length-1:1;return y===0||U.length===0?ue.left+u+m+S*s:ue.left+u+m+s*(i/(U.length===1?1:y))+S*s},[n,d,a,ue.left,ue.right,ee,xe,U.length,oe]),Be=(s,u,S)=>{if(!s){L();return}const o=g.current.getBoundingClientRect();let m,t;if(S.type.startsWith("touch")){const W=S.changedTouches[0];m=W.clientX,t=W.clientY}else m=S.clientX,t=S.clientY;const i=Fe(u),y=s.displayTemperature??s.temperature_chart??null,k=ye(y);N({svgX:i,svgY:k,clientX:m-o.left+g.current.scrollLeft,clientY:t-o.top+g.current.scrollTop}),z(u),T(s)};E.useEffect(()=>{const s=u=>{if(B.current&&!B.current.contains(u.target)){const S=g.current?.querySelectorAll("circle, text, rect");let o=!1;if(S){for(let m of S)if(m.contains(u.target)){o=!0;break}}o||L()}};return C&&(document.addEventListener("mousedown",s),document.addEventListener("touchstart",s)),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("touchstart",s)}},[C,L]);const He=s=>{b&&s&&(b(f,s),L())};return{chartRef:g,tooltipRef:B,dimensions:{...A,contentHeight:Ne,scrollableContentHeight:Xe,extraScrollableHeight:De,viewportHeight:Ie},activePoint:C,activeIndex:se,tooltipPosition:Y,processedData:be,validDataForLine:x,allDataPoints:U,tempMin:Ce,tempMax:Ae,tempRange:Z,padding:ue,textRowHeight:ne,setActivePoint:T,setActiveIndex:z,getY:ye,getX:Fe,handlePointInteraction:Be,clearActivePoint:L,handleToggleIgnore:He,responsiveFontSize:ke,baselineTemp:V,baselineStartIndex:J,baselineIndices:$,firstHighIndex:ge,ovulationDetails:le,fertilityStart:G,hasTemperatureData:p,hasAnyObservation:M,graphBottomInset:Ee,todayIndex:c}};export{Jt as C,Xt as a,Ut as b,ft as c,Zt as u};
