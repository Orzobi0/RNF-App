import{c as dt,r as n,g as y,f as u,j as a,H as D,B as lt,K as Zt,S as N,Q as Le,l as j,b as Pa,V as $a,n as za,m as ge}from"./index-Ck3e0O9m.js";import{L as it,T as Ha,P as Ba,N as Va,C as Ua}from"./NewCycleDialog-CSAB8M2N.js";import{T as Ya,e as Xa,d as qa,b as Wa,m as Xt,f as ye,g as Ga,A as Ka,h as Qa,D as Za}from"./DataEntryForm-CRvk9Tt4.js";import{l as De,P as Ja}from"./badge-CIoXRNss.js";import{a as es,H as ts,D as as}from"./DeletionDialog-GUwB-TKv.js";import{u as ss,D as rs,a as ns}from"./useCycleData-C3echxsr.js";import{c as os,F as qt,i as Fe}from"./computePeakStatuses-D9iHsp4z.js";import"./OverlapWarningDialog-DRM9oP2Y.js";import"./input-hh7yE9fK.js";import"./label-DxCIISDy.js";import"./eye-DWFbEAhh.js";const Wt=dt("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),ls=dt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),is=dt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),cs=({isoDate:d,cycleDay:w,details:o,peakStatus:b,isPeakDay:S,onEdit:m,onDelete:T,onAdd:M,onToggleRelations:ve,isProcessing:E})=>{const Oe=!!o?.record,Ce=n.useMemo(()=>{if(!d)return null;try{return y(u(d),"dd/MM/yyyy",{locale:De})}catch{return null}},[d]),ue=o?.symbolInfo?.label||"Sin símbolo",Pe=o?.symbolInfo?.value||"none",$e=o?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",Ne=()=>{!o?.record||!m||m(o.record,null)},Q=()=>{!o?.record?.id||!T||T(o.record.id)},ze=()=>{!d||!M||M(d)},F=(k,L=null)=>{if(o?.record&&m){m(o.record,k,L);return}d&&M&&M(d,k,L)},He=()=>{!d||!ve||ve(d)},B=(k,L={})=>k&&typeof k=="string"&&k.trim().length>0||typeof k=="number"?k:L.placeholder||"—",Be=o?.hasTemperature?`${o.displayTemp} °C`:"—",Ve=o?.timeValue||"—",Ue=!!o?.timeValue,Ye=o?.hasMucusSensation?o.mucusSensation:"—",Xe=o?.hasMucusAppearance?o.mucusAppearance:"—",je=o?.observationsText?.trim(),Z=!!o?.hasRelations;let J=null,me=null;b&&(b==="P"||S?(J="Día pico",me="peak"):(J=`+${b}`,me="post-peak"));const qe=()=>{switch(Pe){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!d)return a.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const r="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return a.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Ce,w?` · Día ${w}`:""]}),J&&a.jsx("span",{className:D("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:J})]}),a.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[a.jsx("button",{type:"button",onClick:()=>F("symbol","fertilitySymbol"),className:D("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",qe(),$e),title:ue,"aria-label":ue}),Oe?a.jsxs(a.Fragment,{children:[a.jsxs(lt,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Ne,disabled:E,children:[E?a.jsx(it,{className:"h-4 w-4 animate-spin"}):a.jsx(is,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Editar registro"})]}),a.jsxs(lt,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Q,disabled:E,children:[E?a.jsx(it,{className:"h-4 w-4 animate-spin"}):a.jsx(Ha,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):a.jsxs(lt,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:ze,disabled:E,children:[E&&a.jsx(it,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),a.jsxs("div",{className:"mt-4 space-y-3",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("temperature","temperature"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[a.jsx(Ya,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"font-semibold",children:B(Be)}),o?.showCorrectedIndicator&&a.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),a.jsxs("button",{type:"button",onClick:()=>F("temperature","time"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ue?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[a.jsx(Xa,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:B(Ve)})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("sensation","mucusSensation"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[a.jsx(qa,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:B(Ye)})]}),a.jsxs("button",{type:"button",onClick:()=>F("appearance","mucusAppearance"),className:D(r,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[a.jsx(Wa,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:B(Xe)})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("observations","observations"),className:D(r,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",je?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[a.jsx(ls,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"truncate",children:B(je,{placeholder:"-"})})]}),a.jsx("button",{type:"button",onClick:He,disabled:E,className:D("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Z?"border-rose-50 bg-rose-50":"border-slate-200 bg-white",E&&"opacity-70 cursor-not-allowed"),title:Z?"Hubo relaciones":"Sin relaciones","aria-label":Z?"Hubo relaciones":"Sin relaciones",children:a.jsx(Zt,{className:D("h-4 shrink-0 w-4",Z?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},Jt=d=>d.replace(".","").toLowerCase(),be=d=>Jt(y(d,"MMM",{locale:De})),ds=d=>Jt(y(d,"d MMM yyyy",{locale:De})),us=({startDate:d,endDate:w})=>{if(!w){if(!d)return"Mis registros";const M=u(d);return N(M)?`${ds(M)} - actualidad`:"Mis registros"}if(!d)return"Mis registros";const o=u(d),b=u(w);if(!N(o)||!N(b))return"Mis registros";const S=o.getFullYear()===b.getFullYear();if(S&&o.getMonth()===b.getMonth())return`${o.getDate()}–${b.getDate()} ${be(o)} ${o.getFullYear()}`;if(S)return`${o.getDate()} ${be(o)} – ${b.getDate()} ${be(b)} ${o.getFullYear()}`;const T=`${o.getFullYear()}–${String(b.getFullYear()).slice(-2)}`;return`${o.getDate()} ${be(o)} – ${b.getDate()} ${be(b)} · ${T}`},ms=({startDate:d,endDate:w,recordCount:o=0,referenceDate:b=new Date})=>{if(!d)return`${o} registros`;const S=u(d);if(!N(S))return`${o} registros`;if(!w)return`Día ${Le(j(b),j(S))+1} · ${o} registros`;const m=u(w);return N(m)?`${Le(j(m),j(S))+1} días · ${o} registros`:`${o} registros`},fs=d=>qt.find(w=>w.value===d)||qt[0],Gt=10,ct=60,Kt=750,Qt=120,ps=85,hs=5,we=180,xs=d=>{if(d==null||d==="")return null;const w=Number(typeof d=="string"?d.replace(",","."):d);return Number.isFinite(w)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(w):null},gs=({cycle:d,headerTitle:w,headerIcon:o=Wt,headerActions:b,topAccessory:S,includeEndDate:m=!1,addOrUpdateDataPoint:T,deleteRecord:M,isLoading:ve,updateCycleDates:E,checkCycleOverlap:Oe,forceShiftNextCycleStart:Ce,forceUpdateCycleStart:ue,startNewCycle:Pe,refreshData:$e,afterRecordsContent:Ne=null,onRequestDeleteCycle:Q=null,dateEditorDeleteTitle:ze="Eliminar ciclo",dateEditorDeleteDescription:F="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:He="Eliminar ciclo",isDeletingCycle:B=!1}={})=>{const{currentCycle:Be,addOrUpdateDataPoint:Ve,deleteRecord:Ue,isLoading:Ye,updateCycleDates:Xe,checkCycleOverlap:je,forceUpdateCycleStart:Z,forceShiftNextCycleStart:J,startNewCycle:me,refreshData:qe}=ss(),r=d??Be,k=ve??Ye,L=T||(async(e,t)=>{if(r?.id)return Ve(e,t,r.id)}),ea=M||(async e=>{if(r?.id)return Ue(e,r.id)}),Se=E||(async(e,t,s)=>Xe(e??r?.id,t,s)),We=Oe??je,ut=ue||(async(e,t)=>Z(e??r?.id,t)),Ge=Ce||(async(e,t,s)=>J(e??r?.id,t,s)),ta=Pe??me,ke=$e??qe,{toast:R}=Pa(),[aa,V]=n.useState(!1),[Ke,ee]=n.useState(null),[te,Qe]=n.useState(null),[ae,se]=n.useState(!1),[sa,mt]=n.useState(!1),[U,Me]=n.useState(()=>r?.startDate||""),[Y,Ee]=n.useState(()=>r?.endDate||""),[ra,O]=n.useState(""),[P,ft]=n.useState(null),[Ze,pt]=n.useState(null),[Je,ht]=n.useState(!1),[na,xt]=n.useState(null),[oa,et]=n.useState(!1),[tt,fe]=n.useState(!1),[h,X]=n.useState(null),[la,q]=n.useState(null),[ia,pe]=n.useState(null),[ca,re]=n.useState(null),[da,at]=n.useState(!1),gt=r?.data?.length??0,yt=!r?.endDate,ua=n.useMemo(()=>w||us({startDate:r?.startDate,endDate:r?.endDate}),[r?.endDate,r?.startDate,w]),bt=n.useMemo(()=>ms({startDate:r?.startDate,endDate:r?.endDate,recordCount:gt}),[r?.endDate,r?.startDate,gt]),wt=!0,Re=n.useRef(null),Dt=n.useRef(null),vt=n.useRef(0),[Ct,Nt]=n.useState(0),_e=n.useCallback(()=>{const e=Re.current;if(!e){vt.current=0,Nt(0);return}const s=e.getBoundingClientRect().height;vt.current=s,Nt(l=>Math.abs(l-s)>.5?s:l)},[]);n.useLayoutEffect(()=>{let e=window.requestAnimationFrame(_e);const t=()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)};window.addEventListener("resize",t);let s;return typeof ResizeObserver<"u"&&(s=new ResizeObserver(()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)}),Re.current&&s.observe(Re.current)),()=>{window.removeEventListener("resize",t),s&&s.disconnect(),e&&window.cancelAnimationFrame(e)}},[_e]);const jt=n.useMemo(()=>Math.max(Math.round(Ct+Gt),Gt),[Ct]);n.useEffect(()=>{Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate]);const Ae=n.useMemo(()=>r?.data?.length?[...r.data].filter(e=>e?.isoDate).sort((e,t)=>{const s=u(e.isoDate);return u(t.isoDate)-s}).map(e=>e.isoDate):[],[r?.data]);n.useEffect(()=>{const e=Dt.current;e&&e.scrollTo({top:0,behavior:"auto"})},[]);const ne=n.useMemo(()=>r?.data?.length?r.data.map(e=>{if(!e?.isoDate)return null;const t=u(e.isoDate);return N(t)?t:null}).filter(Boolean):[],[r?.data]),St=n.useMemo(()=>new Set(Ae),[Ae]),W=n.useMemo(()=>os(r?.data??[]),[r?.data]),oe=n.useMemo(()=>{const e=new Map;return r?.data?.length&&r.data.forEach(t=>{if(!t?.isoDate)return;const s=t.measurements?.find(Oa=>Oa?.selected)||(t.temperature_chart||t.temperature_raw?{temperature:t.temperature_chart??t.temperature_raw,temperature_corrected:t.temperature_corrected??null,time:t.timestamp?y(u(t.timestamp),"HH:mm"):null,use_corrected:t.use_corrected??!1}:null),l=s?.use_corrected??t.use_corrected??!1,c=s?.temperature_corrected??t.temperature_corrected??null,i=s?.temperature??t.temperature_chart??t.temperature_raw??null,p=xs(l&&c!==null&&c!==void 0&&c!==""?c:i??c),g=p!==null,C=l&&c!==null&&c!==void 0&&c!=="";let x=null;s?.time?x=s.time:t.timestamp&&N(u(t.timestamp))&&(x=y(u(t.timestamp),"HH:mm"));const _=t.mucusSensation??t.mucus_sensation??"",ce=t.mucusAppearance??t.mucus_appearance??"",de=!!_,H=!!ce,ot=de||H,xe=t.observations||"",Te=!!xe,Ta=!!(t.had_relations??t.hadRelations??!1),Yt=W[t.isoDate]||null,Fa=t.peak_marker==="peak"||Yt==="P",La=fs(t.fertility_symbol);e.set(t.isoDate,{record:t,symbolInfo:La,hasTemperature:g,displayTemp:p,showCorrectedIndicator:C,timeValue:x,hasMucus:ot,hasMucusSensation:de,hasMucusAppearance:H,mucusSensation:_,mucusAppearance:ce,hasObservations:Te,observationsText:xe,hasRelations:Ta,peakStatus:Yt,isPeakDay:Fa})}),e},[r?.data,W]),f=n.useMemo(()=>{if(!r?.startDate)return null;const e=u(r.startDate);if(!N(e))return null;let t;if(r?.endDate)t=u(r.endDate);else{const s=j(new Date),l=[e,s];ne.length&&l.push(Xt(ne)),t=Xt(l)}return N(t)?{from:e,to:t}:{from:e,to:e}},[r?.startDate,r?.endDate,ne]),ma=n.useMemo(()=>{const e={};return f&&(e.outsideCycle=t=>ye(t,f.from)||Fe(t,f.to),e.insideCycleNoRecord=t=>{if(ye(t,f.from)||Fe(t,f.to))return!1;const s=y(t,"yyyy-MM-dd");return!St.has(s)}),ne.length&&(e.hasRecord=ne),e},[f,ne,St]),fa=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:D($a({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[kt,st]=n.useState(()=>h&&N(u(h))?u(h):f?.to?f.to:j(new Date)),he=n.useRef(!1),A=n.useRef(null),pa=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),G=n.useRef(null),Mt=n.useRef(null),Et=n.useRef(null),Rt=n.useRef(0),[ha,xa]=n.useState(0),[_t,At]=n.useState(!1),$=n.useCallback(e=>{Rt.current=e,xa(e)},[]),It=n.useCallback(()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(e)})}),[]),le=n.useCallback((e,{duration:t=we}={})=>{A.current&&(cancelAnimationFrame(A.current),A.current=null);const s=Rt.current,l=e-s;return Math.abs(l)<.5||t<=0?($(e),Promise.resolve()):new Promise(c=>{const i=g=>1-Math.pow(1-g,3),v=performance.now(),p=g=>{const C=g-v,x=Math.min(1,C/t),_=s+l*i(x);if($(_),x<1){A.current=requestAnimationFrame(p);return}A.current=null,c()};A.current=requestAnimationFrame(p)})},[$]),ga=n.useMemo(()=>({labelDay:e=>{const t=y(e,"yyyy-MM-dd"),s=oe.get(t),l=y(e,"d MMM",{locale:De}),c=s?.peakStatus??W[t]??null,i=[];if(s?.hasTemperature&&s?.hasMucus?i.push("temperatura y moco"):s?.hasTemperature?i.push("temperatura"):s?.hasMucus&&i.push("moco"),s?.hasRelations&&i.push("RS"),c){const v=c==="P"?"pico ✖":`pico +${c}`;i.push(v)}return i.length?`${l}: ${i.join("; ")}`:l}}),[W,oe]),ya=n.useCallback(({date:e,activeModifiers:t})=>{const s=y(e,"yyyy-MM-dd"),l=oe.get(s),c=l?.hasTemperature??!1,i=l?.hasMucus??!1,v=l?.hasRelations??!1,p=l?.peakStatus??W[s]??null,g=l?.symbolInfo,C=g?.value,x=t.selected,_=t.today,ce=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",c?"bg-amber-500":"bg-transparent",c&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),de=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",i?"bg-teal-500":"bg-transparent",i&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),H=!!(C&&C!=="none"),ot=D("relative z-10 text-[1.15rem] leading-none",t.outside||t.outsideCycle?"text-slate-300":x?H?"text-white":"text-fertiliapp-fuerte":_?"text-subtitulo font-semibold":"text-slate-700"),xe=p==="P"?"✖":p?`+${p}`:null,Te=H?D("pointer-events-none absolute inset-0 rounded-full transition-opacity",g?.color??"",g?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",C==="white"?"ring-1 ring-slate-300/70":"",x?"opacity-50":"opacity-25"):null;return a.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[a.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[_&&!x&&!(t.outside||t.outsideCycle)&&a.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),x&&a.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[2px] rounded-full bg-tarjeta border-2 border-fertiliapp-fuerte"}),Te&&a.jsx("span",{className:Te,"aria-hidden":"true"}),a.jsx("span",{className:ot,children:y(e,"d")}),v&&a.jsx(Zt,{"aria-hidden":"true",className:"pointer-events-none absolute -bottom-[0.2px] -right-[0.2px] h-2 w-2 text-rose-500 fill-current"})]}),a.jsxs("div",{className:"mt-[0.2rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[a.jsx("span",{className:ce}),a.jsx("span",{className:de})]}),xe&&a.jsx("span",{"aria-hidden":"true",className:D("pointer-events-none absolute -top-[1px] right-[0.5px] rounded-sm px-[2px] text-[0.75rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",x?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:xe})]})},[W,oe]),z=n.useMemo(()=>{if(!r?.startDate)return[];const e=u(r.startDate);if(!N(e))return[];const t=j(e),s=j(new Date);let l=f?.to?j(f.to):s;Fe(l,s)&&(l=s),ye(l,t)&&(l=t);const c=Le(l,t)+1;if(c<=0)return[];const i=[];for(let v=c-1;v>=0;v-=1){const p=za(t,v),g=y(p,"yyyy-MM-dd"),C=Le(p,t)+1,x=oe.get(g)||null;i.push({isoDate:g,date:p,cycleDay:C,details:x})}return i},[r?.startDate,f,oe]),ie=n.useMemo(()=>new Set(z.map(e=>e.isoDate)),[z]),ba=n.useMemo(()=>{const e=new Map;return z.forEach(t=>{e.set(t.isoDate,t)}),e},[z]),Tt=h&&ba.get(h)||null,rt=Tt?.details??null,Ft=rt?.peakStatus??(h?W[h]??null:null),wa=rt?.isPeakDay??Ft==="P",Ie=n.useMemo(()=>{if(!f)return null;const e=f?.to?y(j(f.to),"yyyy-MM-dd"):null,t=f?.from?y(j(f.from),"yyyy-MM-dd"):null;if(!r?.endDate){const s=y(j(new Date),"yyyy-MM-dd");if(ie.has(s))return s}return e&&ie.has(e)?e:t&&ie.has(t)?t:Ae[0]??null},[r?.endDate,f,ie,Ae]);n.useEffect(()=>{if(!(h&&ie.has(h))){if(!Ie){h!==null&&X(null);return}h!==Ie&&X(Ie)}},[h,ie,Ie]);const Lt=n.useCallback(e=>{if(!e)return;const t=y(e,"yyyy-MM-dd");f&&(ye(e,f.from)||Fe(e,f.to))||X(t)},[f]);n.useEffect(()=>{if(!h)return;const e=u(h);N(e)&&st(t=>t&&t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()?t:e)},[h]);const Ot=n.useCallback(e=>{st(t=>{const s=t??f?.to??j(new Date);return Ga(s,e==="next"?1:-1)})},[f]);n.useEffect(()=>{const e=Mt.current;if(!e)return;const t=e.querySelector(".records-calendar-day-grid");t&&(Et.current=t)},[kt,wt,$]);const nt=n.useCallback(async e=>{if(he.current)return;he.current=!0;const s=Et.current?.getBoundingClientRect()?.width??0,l=e==="next"?-Qt:Qt,c=s?e==="next"?-s:s:l,i=-c;try{await le(c,{duration:we}),Ot(e),$(i),await It(),await le(0,{duration:we})}finally{he.current=!1}},[le,Ot,$,It]),I=n.useCallback(()=>{ft(null),pt(null),ht(!1),xt(null),et(!1)},[]);n.useEffect(()=>()=>{A.current&&(cancelAnimationFrame(A.current),A.current=null),G.current&&(G.current(),G.current=null)},[]);const Pt=n.useCallback(()=>{Me(r?.startDate||""),Ee(r?.endDate||""),O(""),I(),mt(!0)},[r?.startDate,r?.endDate,I]),K=n.useCallback(()=>{mt(!1),O(""),I(),Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate,I]),Da=n.useCallback(()=>{Q&&(K(),Q())},[K,Q]),va=n.useCallback(e=>{if(he.current||e.pointerType==="mouse"&&e.button!==0)return;const t=e.target.closest(".records-calendar-day-grid");if(!t)return;const s=pa.current;s.active=!0,s.pointerId=e.pointerId,s.startX=e.clientX,s.startTime=performance.now(),s.dragging=!1;const l=t.getBoundingClientRect().width||0;s.gridWidth=l,s.swipeThreshold=l?Math.max(ct,l*.25):ct;const c=p=>{if(!s.active||p.pointerId!==s.pointerId)return;const g=p.clientX-s.startX;if(!s.dragging&&Math.abs(g)>hs&&(s.dragging=!0,At(!0)),!s.dragging)return;const C=s.gridWidth?s.gridWidth*.7:ps,x=Math.max(-C,Math.min(C,g));p.preventDefault(),$(x)},i=async p=>{if(!s.active||p.pointerId!==s.pointerId)return;G.current?.(),G.current=null,s.active=!1;const g=p.clientX-s.startX,C=performance.now()-s.startTime,x=C>0?g/C*1e3:0,_=s.swipeThreshold||ct,ce=g<=-_||x<=-Kt,de=g>=_||x>=Kt,H=s.dragging;if(s.dragging=!1,At(!1),he.current){await le(0,{duration:we});return}if(H&&ce){await nt("next");return}if(H&&de){await nt("prev");return}await le(0,{duration:we})},v=()=>{window.removeEventListener("pointermove",c,{capture:!0}),window.removeEventListener("pointerup",i,{capture:!0}),window.removeEventListener("pointercancel",i,{capture:!0})};G.current?.(),G.current=v,window.addEventListener("pointermove",c,{capture:!0,passive:!1}),window.addEventListener("pointerup",i,{capture:!0}),window.addEventListener("pointercancel",i,{capture:!0})},[nt,le,wt,$]),Ca=n.useCallback(()=>{I()},[I]),Na=n.useCallback(async()=>{if(!U){O("La fecha de inicio es obligatoria");return}if(m&&Y&&Y<U){O("La fecha de fin no puede ser anterior al inicio");return}if(r?.id){O(""),fe(!0);try{const e=We?await We(r.id,U,m&&Y||void 0):null;if(e){ft(U),pt((m&&Y||void 0)??null),ht(!!m),xt(e),et(!0),fe(!1);return}await Se(r.id,U,m&&Y||void 0),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),K()}catch(e){console.error("Error updating start date from records page:",e),O("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{fe(!1)}}},[U,Y,m,r?.id,We,Se,ke,R,K]),ja=n.useCallback(async()=>{if(!r?.id||!P){I();return}fe(!0),et(!1);try{const e=r.startDate,t=r.endDate??void 0,s=P!==e,l=s&&P&&e&&ye(u(P),u(e)),c=Je?Ze??void 0:void 0,i=Je&&Ze!==null&&c!==t;if(l&&await ut(r.id,P),i&&c&&Ge){const v=s?P:e;await Ge(r.id,c,v)}await Se(r.id,s?P:void 0,c),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),K()}catch(e){console.error("Error adjusting cycle dates from records page:",e),O("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{fe(!1),I()}},[r?.id,r?.startDate,r?.endDate,P,Je,Ze,ut,Ge,Se,ke,R,K,I]),$t=n.useCallback(()=>{V(!1),ee(null),q(null),pe(null),re(null)},[]),zt=n.useCallback((e,t=null,s=null)=>{e&&(ee(e),q(e.isoDate??null),pe(t),re(s??null),e.isoDate&&X(e.isoDate),V(!0))},[]),Sa=n.useCallback((e,t=null,s=null)=>zt(e,s,t),[zt]),ka=e=>{const t=r?.data?.find(s=>s.id===e);Qe(t||null)},Ma=n.useCallback(e=>{ee(e)},[]),Ea=n.useCallback((e,t=null,s=null)=>{e&&(X(e),ee(null),q(e),pe(s),re(t),V(!0))},[]),Ht=n.useCallback(()=>{const e=z.length?z[0].isoDate:r?.startDate||null,t=h||e||null;ee(null),q(t),pe(null),re(null),t&&X(t),V(!0)},[z,r?.startDate,h]),Bt=n.useCallback((e,t={})=>{const s=r?.data?.find(i=>i.isoDate===e)||null,l=s?.timestamp&&N(u(s.timestamp))?y(u(s.timestamp),"HH:mm"):y(new Date,"HH:mm"),c=s?.measurements?.length?s.measurements.map((i,v)=>{const p=i?.time||(i?.timestamp&&N(u(i.timestamp))?y(u(i.timestamp),"HH:mm"):l);return{temperature:i?.temperature??i?.temperature_raw??"",temperature_corrected:i?.temperature_corrected??"",time:p,time_corrected:i?.time_corrected||p,use_corrected:!!i?.use_corrected,selected:!!(i?.selected??v===0)}}):[{temperature:"",temperature_corrected:"",time:l,time_corrected:l,use_corrected:!1,selected:!0}];return{isoDate:e,measurements:c,mucusSensation:s?.mucusSensation??s?.mucus_sensation??"",mucusAppearance:s?.mucusAppearance??s?.mucus_appearance??"",fertility_symbol:s?.fertility_symbol??s?.fertilitySymbol??"none",observations:s?.observations??"",peak_marker:s?.peak_marker??null,ignored:s?.ignored??!1,...t}},[r?.data]),Ra=async(e,{keepFormOpen:t=!1}={})=>{se(!0);try{await L(e,Ke),t||(V(!1),ee(null),q(null),pe(null),re(null))}catch{R({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{se(!1),t&&q(e?.isoDate??null)}},_a=n.useCallback(async e=>{if(!e)return;const t=r?.data?.find(c=>c.isoDate===e)||null,s=!!(t?.had_relations??t?.hadRelations??!1),l=Bt(e,{had_relations:!s,hadRelations:!s});se(!0);try{await L(l,t)}catch{R({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{se(!1)}},[L,Bt,r?.data,R]),Aa=async()=>{if(te){se(!0);try{const e=te.isoDate;await ea(te.id),Qe(null),q(null),e&&h===e&&X(e)}catch{R({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{se(!1)}}},Vt={openDateEditor:Pt,openAddRecord:Ht,isProcessing:ae,isUpdatingDates:tt,cycle:r},Ia=typeof b=="function"?b(Vt):a.jsxs(a.Fragment,{children:[a.jsxs(es,{type:"button",onClick:Pt,className:"text-subtitulo",disabled:ae||tt,"aria-label":m?"Editar fechas del ciclo":"Editar fecha de inicio",children:[a.jsx(Ba,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:m?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),a.jsxs(ts,{type:"button",onClick:Ht,disabled:ae,"aria-label":"Añadir registro",children:[a.jsx(Ja,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),Ut=typeof S=="function"?S({...Vt}):S??null;return k&&!r?.id?a.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:a.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):r?.id?a.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[a.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[a.jsx("div",{ref:Re,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:a.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:a.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[a.jsx(ge.div,{className:"flex flex-col gap-2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:a.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/50 p-3 shadow-sm backdrop-blur-md",children:a.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[a.jsxs("div",{className:"flex items-center justify-between gap-2 text-[10px] uppercase tracking-[0.18em] text-base",children:[a.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[Ut&&a.jsx("div",{className:"flex items-center",children:Ut}),a.jsx("span",{children:yt?"CICLO ACTUAL":"CICLO ARCHIVADO"})]}),a.jsx("div",{className:"flex shrink-0 items-center gap-2",children:Ia})]}),a.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[a.jsx(o,{className:"h-5 w-5 text-subtitulo"}),a.jsx("span",{className:D("font-semibold text-titulo leading-tight","text-[21px] sm:text-[22px]"),children:ua})]}),bt&&a.jsx("div",{className:"text-[13px] text-base whitespace-nowrap",children:bt})]})})}),sa&&a.jsx(ge.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:a.jsx(Ua,{cycle:r,startDate:U,endDate:m?Y:r?.endDate,onStartDateChange:e=>Me(e),onEndDateChange:m?e=>Ee(e):void 0,onSave:Na,onCancel:K,isProcessing:tt,dateError:ra,includeEndDate:m,showOverlapDialog:oa,overlapCycle:na,onConfirmOverlap:ja,onCancelOverlap:Ca,onClearError:()=>O(""),saveLabel:m?"Guardar fechas":"Guardar cambios",title:m?"Editar fechas del ciclo":"Editar fecha de inicio",description:m?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:Q?Da:void 0,deleteTitle:ze,deleteDescription:F,deleteLabel:He,isDeletingCycle:B})}),a.jsx(Ka,{initial:!1,children:a.jsx(ge.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:a.jsx("div",{ref:Mt,onPointerDown:va,"data-calendar-dragging":_t?"true":"false",className:D("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:[transform:translate3d(var(--calendar-drag-x,0px),0,0)]",_t?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${ha}px`},children:a.jsx(Qa,{mode:"single",locale:De,month:kt??void 0,onMonthChange:st,selected:h&&N(u(h))?u(h):void 0,onSelect:Lt,onDayClick:Lt,modifiers:ma,labels:ga,components:{DayContent:ya},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:fa,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),a.jsxs("div",{ref:Dt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:jt,maxHeight:`calc(h-app - ${jt}px )`,WebkitOverflowScrolling:"touch"},children:[a.jsx(ge.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:z.length===0?a.jsx(ge.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:a.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[a.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:a.jsx(Wt,{className:"h-9 w-9"})}),a.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),a.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):a.jsx(cs,{isoDate:h,cycleDay:Tt?.cycleDay??null,details:rt,peakStatus:Ft,isPeakDay:wa,onEdit:Sa,onDelete:ka,onAdd:Ea,onToggleRelations:_a,isProcessing:ae})}),Ne&&a.jsx("div",{className:"pt-4 space-y-4",children:Ne})]})]}),a.jsx(rs,{open:aa,onOpenChange:e=>{e?V(!0):$t()},children:a.jsx(ns,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:a.jsx(Za,{onSubmit:Ra,onCancel:$t,initialData:Ke,cycleStartDate:r?.startDate,cycleEndDate:r?.endDate,isProcessing:ae,isEditing:!!Ke,cycleData:r?.data,onDateSelect:Ma,defaultIsoDate:la,focusedField:ia,initialSectionKey:ca})})}),a.jsx(as,{isOpen:!!te,onClose:()=>Qe(null),onConfirm:Aa,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:te?`¿Estás seguro de que quieres eliminar el registro del ${y(u(te.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:ae})]}):a.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[a.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[a.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),a.jsx("button",{onClick:()=>at(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),a.jsx(Va,{isOpen:da,onClose:()=>at(!1),onConfirm:async e=>{await ta(e),at(!1),re(null),V(!0)}})]})},Es=()=>a.jsx(gs,{});export{gs as RecordsExperience,Es as default};
