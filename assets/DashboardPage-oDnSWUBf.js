import{c as pa,h as _s,i as Ls,r as a,p as zs,d as Vs,s as Us,e as Ws,a as Js,b as Hs,u as Ys,f as ue,g as ia,k as Ke,l as Xa,n as Dt,o as St,j as e,m as J,B as Ce}from"./index-ByFXgX-t.js";import{N as za,P as Va,L as Ua,C as Xs,a as Ks}from"./PostpartumExitDialog-81hY3wEb.js";import{D as qs,A as Wa,C as Gs}from"./DataEntryForm-B10-vrnA.js";import{D as Qs,O as Zs}from"./DeletionDialog-Da12udM-.js";import{u as en,i as Ka,D as dt,a as mt,b as zt,c as Vt,d as Ja,e as Ut}from"./useCycleData-BwqH7MfP.js";import{c as tn,u as an,C as sn}from"./useFertilityChart-B4dbAta_.js";import{c as nn,g as rn}from"./computePeakStatuses-hwVxT-Am.js";import{L as Wt,I as Jt}from"./label--L53Nrbo.js";import{l as ca}from"./badge-CetW1kHg.js";import{C as ma,a as on,P as ln}from"./useBackClose-BFeNma-P.js";import"./peak-mode-button-DTRv1E4U.js";import"./eye-CfXbXuuz.js";const Ha=pa("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]),Ya=pa("CheckCircle2",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),cn=pa("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]);function un(){!_s.current&&Ls();const[x]=a.useState(zs.current);return x}const dn="metrics",mn="summary",ua=async(x,i)=>{if(!x||!i||typeof i!="object")throw new Error("A valid userId and data object are required to save metrics.");const F=Vs(Ws,`users/${x}/${dn}`,mn);await Us(F,i,{merge:!0})},fa=20;function fn({cycleCount:x,deduction:i}){return typeof i=="number"&&Number.isFinite(i)?i:(typeof x=="number"&&Number.isFinite(x)?x:0)>=12?20:21}function pn({computedCpmData:x,cpmSelection:i,isManualCpm:F,manualCpmBaseValue:I,manualCpmValue:ke,formatNumber:G}){const A=typeof x.shortestCycle?.duration=="number"&&Number.isFinite(x.shortestCycle.duration)?x.shortestCycle.duration:null,we=typeof x.value=="number"&&Number.isFinite(x.value)?x.value:null,H=F&&i==="manual",T=i==="auto",te=i==="none",ae=H?I:T?A:null,Q=H?ke:T?we:null,ne=G(ae,{maximumFractionDigits:0}),$=G(Q,{maximumFractionDigits:2}),Le=`Ciclo más corto: ${ne??"—"}`,Ae=`CPM = ${$??"—"}`;let Z="Sin datos disponibles",R=!0;if(typeof Q=="number"&&Number.isFinite(Q)){if(H)typeof I=="number"&&Number.isFinite(I)?(Z=`${G(I,{maximumFractionDigits:0})??`${I}`} − ${fa}`,R=!1):(Z="Valor definido manualmente",R=!0);else if(T&&typeof A=="number"&&Number.isFinite(A)){const L=fn({cycleCount:x.cycleCount??0,deduction:x.deduction});Z=`${G(A,{maximumFractionDigits:0})??`${A}`} − ${L}`,R=!1}}return(typeof Q!="number"||!Number.isFinite(Q))&&(Z="Sin datos disponibles",R=!0),{title:"CPM",baseText:Le,finalText:Ae,microCopy:Z,microCopyMuted:R,modeLabel:te?"Sin usar":H?"Manual":"Auto",microCopyId:"cpm-metric-microcopy",baseValue:ae,finalValue:Q,baseFormatted:ne,finalFormatted:$,isManual:H}}function xn({computedT8Data:x,t8Selection:i,isManualT8:F,manualT8BaseValue:I,manualT8Value:ke,formatNumber:G}){const A=typeof x.earliestCycle?.riseDay=="number"&&Number.isFinite(x.earliestCycle.riseDay)?x.earliestCycle.riseDay:null,we=typeof x.value=="number"&&Number.isFinite(x.value)?x.value:null,H=x&&typeof x.canCompute=="boolean"?x.canCompute:!0,T=F&&i==="manual",te=i==="auto"&&H,ae=i==="none",Q=T?I:te?A:null,ne=T?ke:te?we:null,$=G(Q,{maximumFractionDigits:0}),Le=G(ne,{maximumFractionDigits:0}),Ae=`Día de subida: ${$??"—"}`,Z=`T-8 = ${Le??"—"}`;let R="Sin datos disponibles",Ne=!0;return typeof ne=="number"&&Number.isFinite(ne)&&(T?typeof I=="number"&&Number.isFinite(I)?(R=`${G(I,{maximumFractionDigits:0})??`${I}`} − 8`,Ne=!1):(R="Valor definido manualmente",Ne=!0):te&&typeof A=="number"&&Number.isFinite(A)&&(R=`${G(A,{maximumFractionDigits:0})??`${A}`} − 8`,Ne=!1)),(typeof ne!="number"||!Number.isFinite(ne))&&(R="Sin datos disponibles",Ne=!0),{title:"T-8",baseText:Ae,finalText:Z,microCopy:R,microCopyMuted:Ne,modeLabel:ae?"Sin usar":T?"Manual":"Auto",microCopyId:"t8-metric-microcopy",baseValue:Q,finalValue:ne,baseFormatted:$,finalFormatted:Le,isManual:T}}const da="dashboard:data-entry-form-draft",hn=({cycleData:x,onEdit:i,onTogglePeak:F,currentPeakIsoDate:I,onEditStartDate:ke=()=>{},handleOpenCpmDialog:G=()=>{},handleOpenT8Dialog:A=()=>{},cpmMetric:we={},t8Metric:H={}})=>{const T=x.records||[],[te,ae]=a.useState(null),[Q,ne]=a.useState({clientX:0,clientY:0}),[$,Le]=a.useState(!1),[Ae,Z]=a.useState(!1),[R,Ne]=a.useState([]),L=a.useRef(!0),xe=a.useRef(null),Ie=a.useRef(null),Mt=a.useRef(new Map),qe=a.useRef(null),ze=un(),re=x.startDate?ue(x.startDate):null,Ht=St(new Date),ft=a.useMemo(()=>nn(T),[T]);a.useEffect(()=>{const n=Mt.current,d=new Map,f=[];T.forEach(p=>{if(!p)return;let v=p.cycleDay;if(!v&&re&&p.isoDate)try{v=Dt(ue(p.isoDate),re)+1}catch{v=null}if(!v)return;const j=JSON.stringify({temp:p.displayTemperature??p.temperature_chart??null,symbol:p.fertility_symbol??null,sensation:p.mucus_sensation??p.mucusSensation??"",appearance:p.mucus_appearance??p.mucusAppearance??"",observations:p.observations??"",relations:p.had_relations??p.hadRelations??!1,updatedAt:p.updatedAt??p.timestamp??null});if(d.set(v,j),n.size>0){const M=n.get(v);(!M||M!==j)&&f.push(v)}}),Mt.current=d,!ze&&f.length&&Ne(p=>{const v=new Set(p),j=v.size;return f.forEach(M=>v.add(M)),v.size===j?p:Array.from(v)})},[re,ze,T]),a.useEffect(()=>{if(ze||R.length===0)return;const n=setTimeout(()=>{Ne([])},1400);return qe.current=n,()=>{qe.current&&clearTimeout(qe.current)}},[ze,R]);const se=28,he=140,w=he+15,B=w*2,Ft=a.useMemo(()=>{const n=T.reduce((d,f)=>{const p=f?.cycleDay??null;if(p)return Math.max(d,p);if(!re||!f?.isoDate)return d;try{const v=ue(f.isoDate),j=Dt(v,re)+1;return Number.isFinite(j)?Math.max(d,j):d}catch(v){return console.error("Error calculating record day for wheel:",v),d}},0);return Math.max(x.currentDay,n,se)},[x.currentDay,T,re,se]),oe=Math.max(Ft-se,0),S=oe>0,Ge=a.useMemo(()=>S?Math.max(0,Math.min(Math.max(x.currentDay-se,0),oe)):0,[x.currentDay,S,oe,se]),[_,le]=a.useState(Ge);a.useEffect(()=>{L.current||(L.current=!0)},[Ge,_]),a.useEffect(()=>{if(!S){L.current=!0,le(0);return}le(n=>{const d=Math.min(n,oe),f=Math.max(0,Math.min(Math.max(x.currentDay-se,0),oe)),p=x.currentDay>=d+1&&x.currentDay<=d+se;return L.current?p?d!==n?d:n:f:(L.current=!0,f)})},[S,oe,x.currentDay,se]);const de=a.useCallback(n=>Math.max(0,Math.min(n,oe)),[oe]),me=a.useCallback(n=>{!S||n===0||le(d=>de(d+n))},[de,S]),je=a.useRef(0),ee=a.useRef(0),fe=a.useCallback(n=>{!S||n===0||(ee.current+=n,!je.current&&(je.current=requestAnimationFrame(()=>{const d=Math.sign(ee.current);le(f=>de(f+d)),ee.current=0,je.current=0})))},[S,de]),Qe=a.useCallback(n=>{if(!S)return;n.preventDefault();const d=Math.abs(n.deltaY)>Math.abs(n.deltaX)?n.deltaY:n.deltaX;d!==0&&fe(d>0?1:-1)},[me,S]),z=a.useCallback(n=>{S&&(xe.current=n.touches?.[0]?.clientX??null)},[S]),pe=a.useCallback(n=>{if(!S||xe.current===null)return;const d=n.touches?.[0]?.clientX??null;if(d===null)return;const f=d-xe.current;Math.abs(f)<24||(fe(f<0?1:-1),xe.current=d)},[me,S]),Y=a.useCallback(()=>{xe.current=null},[]),De=a.useCallback(n=>({...rn(n),...n==="spot"?{pattern:"url(#spotting-pattern-dashboard)"}:{}}),[]),V=a.useMemo(()=>T.reduce((n,d)=>{if(!d)return n;const f=Number(d.cycleDay);if(Number.isFinite(f)&&f>0)return n.has(f)||n.set(f,d),n;if(!re||!d.isoDate)return n;try{const p=ue(d.isoDate),v=Dt(p,re)+1;Number.isFinite(v)&&v>0&&!n.has(v)&&n.set(v,{...d,cycleDay:v})}catch(p){console.error("Error mapping record by day for wheel:",p)}return n},new Map),[T,re]),Te={main:"#b4a9b0",light:"#c1b6bd",glow:"rgba(212, 194, 206, 0.16)",border:"#c1b6bd"},Je=Array.from({length:se},(n,d)=>{const f=_+d+1,p=V.get(f)??null,v=re?Xa(re,f-1):null,j=v?Ke(v,"yyyy-MM-dd"):null,M=v?Ka(St(v),Ht):!1,E=p?{...p,cycleDay:p.cycleDay??f}:null,Fe=(d+_)/se*2*Math.PI-Math.PI/2,U=w+he*Math.cos(Fe),Pe=w+he*Math.sin(Fe);let W=f<=x.currentDay&&E?De(E.fertility_symbol):Te;!E&&f<x.currentDay?W={main:"transparent",light:"transparent",glow:"rgba(180, 169, 176, 0.1)",border:"rgba(180, 169, 176, 0.4)"}:(M||f>x.currentDay)&&(W={main:"transparent",light:"transparent",glow:"rgba(251, 192, 203, 0.1)",border:"rgba(252, 170, 185, 0.35)"});const Xe=f===x.currentDay;Xe&&(E?W={...De(E.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:W={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const K=j&&ft[j]||null;return{x:U,y:Pe,day:f,colors:W,isActive:f<=x.currentDay,isToday:Xe,hasRecord:!!E,record:E,isoDate:j,canShowPlaceholder:!!(!E&&j&&!M),peakStatus:K}}),X=a.useMemo(()=>new Set(R),[R]),Re=_*360/se,pt=-Re*Math.PI/180,He=Math.cos(pt),xt=Math.sin(pt),Ye=a.useCallback((n,d)=>{const f=n-w,p=d-w;return{x:w+f*He-p*xt,y:w+f*xt+p*He}},[w,He,xt]),kt=2*Math.PI/se,Ve=-Math.PI/2-kt/2,It=he-18,Ze=he+10,Se=w+It*Math.cos(Ve),ht=w+It*Math.sin(Ve),Me=w+Ze*Math.cos(Ve),Ee=w+Ze*Math.sin(Ve);a.useEffect(()=>{S&&ae(null)},[_,S]);const Be=(n,d)=>{if(d.stopPropagation(),!Ie.current){ae(null);return}const f=Ie.current.getBoundingClientRect();let p,v;d.touches&&d.touches[0]?(p=d.touches[0].clientX,v=d.touches[0].clientY):(p=d.clientX,v=d.clientY);const j=n.canShowPlaceholder&&n.isoDate?{id:`placeholder-${n.isoDate}`,isoDate:n.isoDate,cycleDay:n.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:n.peakStatus,peak_marker:n.peakStatus==="P"?"peak":null}:null,M=n.record?{...n.record,cycleDay:n.record.cycleDay??n.day,peakStatus:n.peakStatus,peak_marker:n.record.peak_marker??(n.peakStatus==="P"?"peak":null)}:j;if(M&&I&&M.isoDate===I&&(M.peak_marker="peak",M.peakStatus=M.peakStatus||"P"),!M){ae(null);return}ne({clientX:p-f.left,clientY:v-f.top}),ae(M)};return a.useEffect(()=>{if(!te)return;const n=d=>{Ie.current&&!Ie.current.contains(d.target)&&ae(null)};return document.addEventListener("mousedown",n),document.addEventListener("touchstart",n),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}},[te]),e.jsxs("div",{className:"relative flex flex-col space-y-4",children:[e.jsxs(J.div,{className:"relative overflow-hidden px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-titulo mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:ke,className:"inline-flex items-center gap-1.5 rounded-full bg-white/60 px-3 py-1.5 text-sm font-semibold text-subtitulo shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white",title:"Editar fecha de inicio del ciclo",children:[e.jsx(Ks,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(J.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.2,delay:.1},children:[e.jsxs("div",{className:"relative overflow-hidden rounded-[75px]   p-4  mb-4",children:[e.jsxs("div",{className:"pointer-events-none absolute inset-0",children:[e.jsx("div",{className:"absolute inset-0 "}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 h-1/2 "})]}),e.jsx("div",{className:"relative text-center flex-shrink-0",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(J.div,{ref:Ie,className:"relative inline-flex items-center justify-center mb-4 drop-shadow-[0_15px_35px_rgba(221,86,101,0.22)]",style:{width:B,height:B},initial:{opacity:0},animate:{opacity:1},transition:{duration:.18,ease:"easeOut"},onWheel:Qe,onTouchStart:z,onTouchMove:pe,onTouchEnd:Y,children:[e.jsxs("svg",{className:"w-full h-full wheel-no-tap",viewBox:`0 0 ${B} ${B}`,onClick:()=>ae(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"78%",fx:"30%",fy:"20%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFE7E8",stopOpacity:"0.98"}),e.jsx("stop",{offset:"60%",stopColor:"#FFC0C1",stopOpacity:"0.95"}),e.jsx("stop",{offset:"100%",stopColor:"#FFB5B3",stopOpacity:"0.95"})]}),e.jsxs("filter",{id:"circleDepthShadow",children:[e.jsx("feDropShadow",{dx:"0",dy:"10",stdDeviation:"10",floodColor:"rgba(221,86,101,0.22)",floodOpacity:"1"}),e.jsx("feDropShadow",{dx:"0",dy:"4",stdDeviation:"4",floodColor:"rgba(221,86,101,0.18)",floodOpacity:"1"})]}),e.jsx("filter",{id:"dotShadow",x:"-30%",y:"-30%",width:"160%",height:"160%",colorInterpolationFilters:"sRGB",children:e.jsx("feDropShadow",{dx:"0",dy:"0.8",stdDeviation:"0.8",floodColor:"#000",floodOpacity:"0.22"})}),e.jsx("filter",{id:"whiteSymbolShadow",children:e.jsx("feDropShadow",{dx:"0",dy:"0.5",stdDeviation:"0.8",floodColor:"rgba(189,16,44,0.3)"})}),e.jsx("filter",{id:"activePointHighlight",children:e.jsx("feDropShadow",{dx:"0",dy:"-1",stdDeviation:"0.5",floodColor:"rgba(255,255,255,0.7)",floodOpacity:"1"})}),e.jsxs("filter",{id:"bevel",children:[e.jsx("feFlood",{floodColor:"rgba(255,255,255,0.4)",result:"top"}),e.jsx("feFlood",{floodColor:"rgba(0,0,0,0.2)",result:"bottom"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"top"}),e.jsx("feMergeNode",{in:"bottom"}),e.jsx("feMergeNode",{})]})]})]}),e.jsx("circle",{cx:w,cy:w,r:he-28,fill:"url(#ringGlow)",stroke:"rgba(255,225,228,0.8)",strokeWidth:1.2,filter:"url(#circleDepthShadow)"}),S&&e.jsx("line",{x1:Se,y1:ht,x2:Me,y2:Ee,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(J.g,{transition:{type:"tween",duration:.18,ease:[.2,.8,.2,1]},initial:!1,animate:L.current?{rotate:-Re}:!1,style:{transformOrigin:"center",transformBox:"view-box",willChange:"transform"},children:Je.map((n,d)=>e.jsxs("g",{children:[e.jsx("g",{filter:n.isActive?"url(#activePointHighlight)":n.isToday?"url(#bevel)":void 0,children:e.jsx(J.circle,{cx:n.x,cy:n.y,r:n.isToday?12:11,fill:n.colors.pattern||(n.isActive?n.colors.main:"rgba(255,255,255,0.001)"),stroke:n.colors.border&&n.colors.border!=="none"?n.colors.border:"rgba(255,255,255,0.3)",strokeWidth:n.colors.border&&n.colors.border!=="none"?n.isToday?2.2:1.2:0,filter:n.fertilitysymbol==="white"?"url(#whiteSymbolShadow)":n.isActive?"url(#dotShadow)":void 0,strokeLinecap:"round",onClick:f=>Be(n,f),initial:!1,whileTap:ze||!L.current?void 0:{y:2,scale:.75,opacity:.95,transition:{duration:.08,ease:"easeOut"}},style:{cursor:"pointer"}})}),!ze&&X.has(n.day)&&e.jsxs(J.g,{pointerEvents:"none",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{transformOrigin:`${n.x}px ${n.y}px`},children:[e.jsx(J.circle,{cx:n.x,cy:n.y-12,r:4,fill:n.colors.main,initial:{y:-18,scale:.5,opacity:0},animate:{y:[-18,0,2],scale:[.5,1.05,.8],opacity:[0,1,0]},transition:{duration:.6,ease:"easeOut",times:[0,.6,1]}}),e.jsx(J.circle,{cx:n.x,cy:n.y,r:n.isToday?12:10,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:2,fill:"none",initial:{scale:.5,opacity:.9},animate:{scale:1.4,opacity:0},transition:{duration:.55,ease:[.16,1,.3,1],delay:.05}}),e.jsx(J.circle,{cx:n.x,cy:n.y,r:n.isToday?14:12,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:1.5,fill:"none",initial:{scale:.6,opacity:.6},animate:{scale:1.9,opacity:0},transition:{duration:.9,ease:"easeOut",delay:.1}})]},`dot-splash-${n.day}`),n.isToday&&e.jsx("circle",{cx:n.x,cy:n.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}})]},d))}),Je.map((n,d)=>{if(!n.peakStatus)return null;const{x:f,y:p}=Ye(n.x,n.y);return n.peakStatus==="P"?e.jsx("text",{x:f,y:p+4,textAnchor:"middle",fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none"},children:"✖"}):e.jsx("text",{x:f,y:p+4,textAnchor:"middle",fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:n.peakStatus})})]}),te&&e.jsx("div",{onClick:n=>n.stopPropagation(),children:e.jsx(sn,{point:te,position:Q,chartWidth:Ie.current?.clientWidth||0,chartHeight:Ie.current?.clientHeight||0,onEdit:i,onClose:()=>ae(null),onTogglePeak:F,currentPeakIsoDate:I})}),e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:e.jsxs(J.div,{className:"flex flex-col items-center gap-2",initial:{opacity:0},animate:{opacity:1},transition:{duration:.1,delay:.1,ease:"easeOut"},children:[e.jsx("div",{className:"flex items-center justify-center ",children:e.jsx("p",{className:"text-6xl font-semibold text-fertiliapp-fuerte leading-none",children:x.currentDay})}),e.jsx("p",{className:"mt-1 text-[15px] font-medium uppercase tracking-wide text-fertiliapp-fuerte",children:"DÍA DEL CICLO"})]})})]}),S&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full text-fertiliapp-fuerte shadow-xs transition hover:border hover:bg-fertiliapp-fuerte/20",onClick:()=>me(-1),disabled:_===0,children:e.jsx(on,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-fertiliapp-fuerte",children:["Día ",_+1]}),e.jsx("span",{className:"text-xs text-fertiliapp-fuerte",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-fertiliapp-fuerte",children:["Día ",Math.min(_+se,Ft)]})]}),e.jsx("input",{type:"range",min:0,max:oe,value:_,onChange:n=>le(de(Number(n.target.value))),className:"w-40 range-fertiliapp"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full text-fertiliapp-fuerte shadow-xs transition hover:border hover:bg-fertiliapp-fuerte/20",onClick:()=>fe(1),disabled:_===oe,children:e.jsx(ma,{className:"w-4 h-4"})})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0 items-start",children:[e.jsxs(J.div,{className:`relative overflow-hidden rounded-3xl bg-white/60 border border-secundario-suave shadow-[0_14px_35px_rgba(148,163,184,0.18)] backdrop-blur-md p-1 transition-[width] duration-300 ease-in-out mx-auto ${$?"w-full":"w-[80%]"}`,initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.2,delay:.1},children:[e.jsxs("button",{type:"button",onClick:()=>Le(n=>!n),className:"group flex w-full items-center justify-between gap-3 rounded-2xl px-3 py-2 text-left transition",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-700 tracking-tight uppercase",children:"SÍMBOLOS"}),e.jsx("div",{className:"absolute top-4.5 right-4 w-1.5 h-1.5 bg-secundario rounded-full"})]}),e.jsx(Wa,{initial:!1,children:$&&e.jsx(J.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},className:"grid grid-cols-2 gap-2.5 rounded-3xl bg-white/40 p-2 overflow-hidden",children:[{label:"Menstrual",color:"#fb7185"},{label:"Moco (Fértil)",color:"#fdf5f8",stroke:"#fb7185"},{label:"Seco",color:"#67C5A4"},{label:"Moco (No fértil)",color:"#F7B944"},{label:"Spotting",color:"#fb7185",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(n=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[n.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-5 h-5 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-5 h-5 rounded-full border ${n.pattern?"pattern-bg":""}`,style:{backgroundColor:n.color,borderColor:n.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${n.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:n.label})]},n.label))},"symbols")})]}),e.jsxs(J.div,{className:`relative overflow-hidden rounded-3xl bg-white/60 border border-secundario-suave shadow-[0_14px_35px_rgba(148,163,184,0.18)] backdrop-blur-md p-1 transition-[width] duration-300 ease-in-out mx-auto ${Ae?"w-full":"w-[80%]"}`,initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.2,delay:.1},children:[e.jsxs("button",{type:"button",onClick:()=>Z(n=>!n),className:"group flex w-full items-center justify-between gap-3 rounded-2xl px-3 py-2 text-left transition",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-800 tracking-tight uppercase",children:"CÁLCULO"}),e.jsx("div",{className:"absolute top-4.5 right-4 w-1.5 h-1.5 bg-secundario rounded-full"})]}),e.jsx(Wa,{initial:!1,children:Ae&&e.jsxs(J.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},className:"grid grid-cols-2 gap-2.5 rounded-3xl bg-white/40 p-2 overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:G,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (Ciclo más corto)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"Ciclo más corto"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:we?.baseFormatted??"—"})})]}),e.jsxs("button",{type:"button",onClick:G,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (resultado)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"CPM"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:we?.finalFormatted??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:we?.modeLabel??"Auto"})]}),e.jsxs("button",{type:"button",onClick:A,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (Día de subida)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"Día de subida"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:H?.baseFormatted??"—"})})]}),e.jsxs("button",{type:"button",onClick:A,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (resultado)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"T-8"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:H?.finalFormatted??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:H?.modeLabel??"Auto"})]})]},"calc-card")})]})]})]})]})},bn=({onAddRecord:x,onAddCycle:i})=>{const[F,I]=a.useState(!1),ke=a.useRef(null);a.useEffect(()=>{if(!F)return;const we=T=>{ke.current?.contains(T.target)||I(!1)},H=T=>{T.key==="Escape"&&I(!1)};return document.addEventListener("pointerdown",we),document.addEventListener("keydown",H),()=>{document.removeEventListener("pointerdown",we),document.removeEventListener("keydown",H)}},[F]);const G=()=>{I(!1),x()},A=()=>{I(!1),i()};return e.jsxs("div",{ref:ke,className:"fixed right-4 top-12 md:top-6 flex flex-col-reverse items-end space-y-2 z-50",children:[F&&e.jsxs("div",{className:"flex flex-col space-y-2 mt-1",children:[e.jsxs(J.button,{onClick:G,className:"flex items-center gap-1 px-4 h-10 rounded-full bg-fertiliapp-fuerte hover:brightness-50 text-white/90 shadow-sm shadow-[#DD5665]",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(244, 114, 182, 0.28))"},children:[e.jsx(cn,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]}),e.jsxs(J.button,{onClick:A,className:"flex items-center gap-3 px-4 h-10 rounded-full bg-white/80 hover:brightness-50 text-fertiliapp-fuerte shadow-sm shadow-[#DD5665]",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(244, 114, 182, 0.2))"},children:[e.jsx(Gs,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]})]}),e.jsx(J.button,{onClick:()=>I(!F),className:"flex items-center justify-center rounded-full bg-white/80 border border-fertiliapp-fuerte text-fertiliapp-fuerte hover:brightness-95 shadow-sm shadow-[#5BA9B8] w-12 h-12 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300 focus-visible:ring-offset-2",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 4px 12px rgba(221, 86, 101, 0.35))"},children:e.jsx(J.span,{animate:{rotate:F?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(ln,{className:"h-5 w-5"})})})]})},In=()=>{const x=Js(),{currentCycle:i,archivedCycles:F,addOrUpdateDataPoint:I,startNewCycle:ke,isLoading:G,updateCycleDates:A,checkCycleOverlap:we,previewUpdateCycleDates:H,previewStartNewCycle:T,refreshData:te,setCycleIgnoreForAutoCalculations:ae,undoCurrentCycle:Q,previewUndoCurrentCycle:ne}=en(),{toast:$}=Hs(),[Le,Ae]=a.useState(!1),[Z,R]=a.useState(()=>i?.startDate||""),[Ne,L]=a.useState(""),[xe,Ie]=a.useState(null),[Mt,qe]=a.useState(null),[ze,re]=a.useState(null),[Ht,ft]=a.useState(!1),[se,he]=a.useState(!1),{user:D,preferences:w,savePreferences:B}=Ys(),[Ft,oe]=a.useState(!1),[S,Ge]=a.useState(""),[_,le]=a.useState(""),[de,me]=a.useState(""),[je,ee]=a.useState(""),[fe,Qe]=a.useState(null),[z,pe]=a.useState(null),[Y,De]=a.useState(null),[V,Te]=a.useState(!1),[ie,Je]=a.useState("auto"),[X,Re]=a.useState("auto"),[pt,He]=a.useState(!1),[xt,Ye]=a.useState(!1),[kt,Ve]=a.useState(!1),[It,Ze]=a.useState(!1),[Se,ht]=a.useState(""),[Me,Ee]=a.useState(""),[Be,n]=a.useState(""),[d,f]=a.useState(""),[p,v]=a.useState(null),[j,M]=a.useState(null),[E,Fe]=a.useState(null),[U,Pe]=a.useState(!1),[W,Xe]=a.useState("auto"),[K,et]=a.useState("auto"),[xa,Yt]=a.useState(!1),[qa,bt]=a.useState(!1),[ha,Xt]=a.useState(!1),[ba,ya]=a.useState([]),[Ga,Tt]=a.useState(!1),[Qa,Kt]=a.useState(!1),[qt,ga]=a.useState(null),[Gt,Et]=a.useState(!1),tt=a.useRef(!1),at=a.useRef(!1),Qt=a.useRef(null),va=a.useRef(!1),Ca=a.useRef(!1),be=a.useMemo(()=>D?.uid?`rnf_manual_cpm_${D.uid}`:null,[D?.uid]),ye=a.useMemo(()=>D?.uid?`rnf_manual_cpm_base_${D.uid}`:null,[D?.uid]),ge=a.useMemo(()=>D?.uid?`rnf_manual_t8_${D.uid}`:null,[D?.uid]),ve=a.useMemo(()=>D?.uid?`rnf_manual_t8_base_${D.uid}`:null,[D?.uid]),st=a.useMemo(()=>{if(!i?.id||i?.endDate||!i?.startDate)return null;const t=ue(i.startDate);if(!ia(t))return null;const s=Ke(Xa(t,-1),"yyyy-MM-dd"),o=F.filter(r=>r?.endDate===s);return o.length?o.sort((r,c)=>(c.startDate||"").localeCompare(r.startDate||""))[0]:null},[F,i]),Zt=a.useMemo(()=>{if(!st?.startDate||!st?.endDate)return"";const t=ue(st.startDate),s=ue(st.endDate);if(!ia(t)||!ia(s))return"";const o=r=>Ke(r,"dd MMM yy",{locale:ca}).replace(".","");return`${o(t)} - ${o(s)}`},[st]),Za=a.useMemo(()=>`¿Quieres unir el ciclo actual al ciclo anterior${Zt?` (${Zt})`:""}? Esta acción no se puede deshacer.`,[Zt]),yt=a.useCallback(async t=>{if(!(!D?.uid||!B)&&["auto","manual","none"].includes(t))try{await B({cpmMode:t})}catch(s){console.error("Failed to persist CPM mode",s)}},[B,D?.uid]),gt=a.useCallback(async t=>{if(!(!D?.uid||!B)&&["auto","manual","none"].includes(t))try{await B({t8Mode:t})}catch(s){console.error("Failed to persist T-8 mode",s)}},[B,D?.uid]);a.useEffect(()=>{tt.current=!1},[be]),a.useEffect(()=>{at.current=!1},[ge]),a.useEffect(()=>{if(!ye){pe(null);return}const t=w?.manualCpmBase;if(t!==void 0){if(typeof t=="number"&&Number.isFinite(t)){if(pe(t),typeof window<"u")try{localStorage.setItem(ye,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual CPM base value to local storage",s)}}else if(pe(null),typeof window<"u")try{localStorage.removeItem(ye)}catch(s){console.error("Failed to clear manual CPM base value from local storage",s)}return}if(!(typeof window>"u"))try{const s=localStorage.getItem(ye);if(s){const o=JSON.parse(s);o&&typeof o.value=="number"&&Number.isFinite(o.value)?pe(o.value):pe(null)}else pe(null)}catch(s){console.error("Failed to restore manual CPM base value from local storage",s)}},[ye,w?.manualCpmBase]),a.useEffect(()=>{if(!ve){M(null);return}const t=w?.manualT8Base;if(t!==void 0){if(typeof t=="number"&&Number.isFinite(t)){if(M(t),typeof window<"u")try{localStorage.setItem(ve,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual T-8 base value to local storage",s)}}else if(M(null),typeof window<"u")try{localStorage.removeItem(ve)}catch(s){console.error("Failed to clear manual T-8 base value from local storage",s)}return}if(!(typeof window>"u"))try{const s=localStorage.getItem(ve);if(s){const o=JSON.parse(s);o&&typeof o.value=="number"&&Number.isFinite(o.value)?M(o.value):M(null)}else M(null)}catch(s){console.error("Failed to restore manual T-8 base value from local storage",s)}},[ve,w?.manualT8Base]);const nt=a.useCallback(async({finalValue:t,baseValue:s})=>{if(!D?.uid||!B)return;const o=t==null?null:Number(t),r=s===void 0?void 0:s==null?null:Number(s),c={manualCpm:o};r!==void 0&&(c.manualCpmBase=r);try{await B(c),be&&typeof window<"u"&&(c.manualCpm===null?localStorage.removeItem(be):localStorage.setItem(be,JSON.stringify({value:c.manualCpm}))),r!==void 0&&ye&&typeof window<"u"&&(r===null?localStorage.removeItem(ye):localStorage.setItem(ye,JSON.stringify({value:r}))),await ua(D.uid,{manual:{cpm:{value:o,base:r===void 0?z:r}},manualUpdatedAt:new Date().toISOString()})}catch(l){throw console.error("Failed to persist manual CPM value in profile",l),l}},[ye,z,be,B,D?.uid]),rt=a.useCallback(async({finalValue:t,baseValue:s})=>{if(!D?.uid||!B)return;const o=t==null?null:Number(t),r=s===void 0?void 0:s==null?null:Number(s),c={manualT8:o};r!==void 0&&(c.manualT8Base=r);try{await B(c),ge&&typeof window<"u"&&(c.manualT8===null?localStorage.removeItem(ge):localStorage.setItem(ge,JSON.stringify({value:c.manualT8}))),r!==void 0&&ve&&typeof window<"u"&&(r===null?localStorage.removeItem(ve):localStorage.setItem(ve,JSON.stringify({value:r}))),await ua(D.uid,{manual:{t8:{value:o,riseDay:r===void 0?j:r}},manualUpdatedAt:new Date().toISOString()})}catch(l){throw console.error("Failed to persist manual T-8 value in profile",l),l}},[ve,j,ge,B,D?.uid]);a.useEffect(()=>{if(!be){De(null),Te(!1),tt.current=!1;return}const t=w?.manualCpm;if(typeof t=="number"&&Number.isFinite(t)){if(De(t),Te(!0),typeof window<"u")try{localStorage.setItem(be,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual CPM value to local storage",s)}return}if(t===null&&(De(null),Te(!1),typeof window<"u"))try{localStorage.removeItem(be)}catch(s){console.error("Failed to clear manual CPM value from local storage",s)}},[be,w?.manualCpm]),a.useEffect(()=>{if(!ge){Fe(null),Pe(!1),at.current=!1;return}const t=w?.manualT8;if(typeof t=="number"&&Number.isFinite(t)){if(Fe(t),Pe(!0),typeof window<"u")try{localStorage.setItem(ge,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual T-8 value to local storage",s)}return}if(t===null&&(Fe(null),Pe(!1),typeof window<"u"))try{localStorage.removeItem(ge)}catch(s){console.error("Failed to clear manual T-8 value from local storage",s)}},[ge,w?.manualT8]),a.useEffect(()=>{if(!be||tt.current||!D?.uid)return;if(w?.manualCpm!==void 0){tt.current=!0;return}if(typeof window>"u"){tt.current=!0;return}try{const s=localStorage.getItem(be);if(s){const o=JSON.parse(s);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){De(o.value),Te(!0);let r=z;try{if(ye){const c=localStorage.getItem(ye);if(c){const l=JSON.parse(c);l&&typeof l.value=="number"&&Number.isFinite(l.value)?r=l.value:r=null}}}catch(c){console.error("Failed to read manual CPM base value from local storage",c)}pe(typeof r=="number"&&Number.isFinite(r)?r:null),nt({finalValue:o.value,baseValue:r}).catch(c=>console.error("Failed to migrate manual CPM value to profile storage",c))}}}catch(s){console.error("Failed to restore manual CPM value from local storage",s)}finally{tt.current=!0}},[ye,z,be,nt,w?.manualCpm,D?.uid]),a.useEffect(()=>{if(!ge||at.current||!D?.uid)return;if(w?.manualT8!==void 0){at.current=!0;return}if(typeof window>"u"){at.current=!0;return}try{const s=localStorage.getItem(ge);if(s){const o=JSON.parse(s);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){Fe(o.value),Pe(!0);let r=j;try{if(ve){const c=localStorage.getItem(ve);if(c){const l=JSON.parse(c);l&&typeof l.value=="number"&&Number.isFinite(l.value)?r=l.value:r=null}}}catch(c){console.error("Failed to read manual T-8 base value from local storage",c)}M(typeof r=="number"&&Number.isFinite(r)?r:null),rt({finalValue:o.value,baseValue:r}).catch(c=>console.error("Failed to migrate manual T-8 value to profile storage",c))}}}catch(s){console.error("Failed to restore manual T-8 value from local storage",s)}finally{at.current=!0}},[ve,j,ge,rt,w?.manualT8,D?.uid]),a.useEffect(()=>{R(i?.startDate||"")},[i?.startDate]);const ea=a.useCallback(t=>{if(!t?.startDate)return null;try{const s=ue(t.startDate);if(Number.isNaN(s.getTime()))return null;const o=Ke(s,"dd/MM/yyyy",{locale:ca});if(!t.endDate)return`${o} - En curso`;const r=ue(t.endDate);if(Number.isNaN(r.getTime()))return o;const c=Ke(r,"dd/MM/yyyy",{locale:ca});return`${o} - ${c}`}catch{return null}},[]),Pt=a.useMemo(()=>{const t=[];if(Array.isArray(F)&&F.length>0&&F.forEach((s,o)=>{const r=ea(s);t.push({...s,displayName:s.name||r||`Ciclo archivado ${o+1}`,dateRangeLabel:r,source:"archived",ignoredForAutoCalculations:!!s.ignoredForAutoCalculations})}),i?.id){const s=ea(i);t.push({...i,displayName:i.name||s||"Ciclo actual",dateRangeLabel:s,source:"current",ignoredForAutoCalculations:!!i.ignoredForAutoCalculations})}return t},[F,i,ea]),C=a.useMemo(()=>{const o=[...Pt.map(u=>{if(!u.startDate||!u.endDate)return null;try{const N=ue(u.startDate),k=ue(u.endDate);if(Number.isNaN(N.getTime())||Number.isNaN(k.getTime())||Ka(N,k))return null;const m=Dt(St(k),St(N))+1;return!Number.isFinite(m)||m<=0?null:{...u,duration:m,ignoredForAutoCalculations:!!u.ignoredForAutoCalculations}}catch(N){return console.error("Failed to compute cycle duration for CPM calculation",N),null}}).filter(Boolean)].sort((u,N)=>{const k=typeof u.duration=="number"&&Number.isFinite(u.duration)?u.duration:Number.POSITIVE_INFINITY,m=typeof N.duration=="number"&&Number.isFinite(N.duration)?N.duration:Number.POSITIVE_INFINITY;return k-m}).map(u=>{const N=!!u.ignoredForAutoCalculations;return{...u,isIgnored:N,isIncluded:!N}}),r=o.filter(u=>u.isIncluded),c=o.length-r.length,l=r.length;if(l<6)return{value:null,cycleCount:l,shortestCycle:null,deduction:null,canCompute:!1,cyclesConsidered:o,ignoredCount:c};const h=r[0]??null,g=l>=12?20:21,y=typeof h?.duration=="number"&&Number.isFinite(h.duration)?Math.max(1,h.duration-g):null;return{value:y,cycleCount:l,shortestCycle:h,deduction:g,canCompute:y!==null,cyclesConsidered:o,ignoredCount:c}},[Pt]),b=a.useMemo(()=>{const t=m=>{if(m==null||m==="")return null;const P=Number.parseFloat(String(m).replace(",","."));return Number.isFinite(P)?P:null},s=m=>{if(!m)return null;const P=t(m.temperature),O=t(m.temperature_corrected);return m.use_corrected&&O!==null?O:P!==null?P:O!==null?O:null},o=m=>{const P=[m?.temperature_chart,m?.temperature_raw,m?.temperature_corrected];for(const O of P){const ce=t(O);if(ce!==null)return ce}if(Array.isArray(m?.measurements)){const ce=m.measurements.find(Oe=>Oe&&Oe.selected&&s(Oe)!==null)||m.measurements.find(Oe=>s(Oe)!==null);if(ce){const Oe=s(ce);if(Oe!==null)return Oe}}return null},r=m=>{if(!m)return null;try{const P=ue(m);return Number.isNaN(P.getTime())?null:P}catch{return null}},c=Pt.filter(m=>m&&m.startDate&&Array.isArray(m.data)&&m.data.length>0).sort((m,P)=>{const O=r(m.startDate),ce=r(P.startDate);return!O&&!ce?0:O?ce?ce-O:-1:1}),l=[],h=[];for(const m of c){const P=m.data.filter(jt=>jt&&jt.isoDate).map(jt=>({...jt,displayTemperature:o(jt)}));if(P.length===0)continue;const{ovulationDetails:O}=tn(P);if(!O?.confirmed)continue;const ce=Number.isInteger(O?.ovulationIndex)?O.ovulationIndex:Number.isInteger(O?.confirmationIndex)?O.confirmationIndex:null;if(ce==null||ce<0||ce>=P.length)continue;const Oe=P[ce],_t=Number(Oe?.cycleDay);if(!Number.isFinite(_t)||_t<=0)continue;const Bs=Math.max(1,_t-8),Lt=!!m.ignoredForAutoCalculations,La={cycleId:m.id,riseDay:_t,t8Day:Bs,displayName:m.displayName||m.name||"Ciclo sin nombre",dateRangeLabel:m.dateRangeLabel,isIgnored:Lt,isIncluded:!Lt,ignoredForAutoCalculations:Lt};l.push(La),!Lt&&h.length<12&&h.push(La)}const g=h.length,y=l.reduce((m,P)=>m+(P.isIgnored?1:0),0);if(g===0)return{value:null,cycleCount:g,earliestCycle:null,cyclesConsidered:l,canCompute:!1,rawValue:null,ignoredCount:y};const u=h.reduce((m,P)=>P.t8Day<m.t8Day?P:m),N=u.t8Day,k=g>=6;return{value:k?N:null,cycleCount:g,earliestCycle:u,cyclesConsidered:l,canCompute:k,rawValue:N,ignoredCount:y}},[Pt]);a.useEffect(()=>{if(va.current||!w)return;let t=w?.cpmMode;["auto","manual","none"].includes(t)||(t=V?"manual":C.canCompute?"auto":"none"),Je(t),Re(t),va.current=!0},[C.canCompute,V,w]),a.useEffect(()=>{if(Ca.current||!w)return;let t=w?.t8Mode;["auto","manual","none"].includes(t)||(t=U?"manual":b.canCompute?"auto":"none"),Xe(t),et(t),Ca.current=!0},[b.canCompute,U,w]),a.useEffect(()=>{if(!D?.uid){Qt.current=null;return}const t=l=>typeof l=="number"&&Number.isFinite(l)?l:null,s=l=>l?{id:l.id??null,name:l.name??null,displayName:l.displayName??null,startDate:l.startDate??null,endDate:l.endDate??null,duration:t(l.duration),source:l.source??null,dateRangeLabel:l.dateRangeLabel??null}:null,o=l=>l?{id:l.id??null,name:l.name??null,displayName:l.displayName??null,startDate:l.startDate??null,endDate:l.endDate??null,riseDay:t(l.riseDay),t8Day:t(l.t8Day),source:l.source??null,dateRangeLabel:l.dateRangeLabel??null}:null,r={automatic:{cpm:{value:t(C?.value),cycleCount:t(C?.cycleCount)??0,ignoredCount:t(C?.ignoredCount)??0,deduction:t(C?.deduction),canCompute:!!C?.canCompute,shortestCycle:s(C?.shortestCycle)},t8:{value:t(b?.value),cycleCount:t(b?.cycleCount)??0,ignoredCount:t(b?.ignoredCount)??0,canCompute:!!b?.canCompute,riseDay:t(b?.earliestCycle?.riseDay),earliestCycle:o(b?.earliestCycle)}}},c=JSON.stringify(r);Qt.current!==c&&(Qt.current=c,ua(D.uid,{...r,automaticUpdatedAt:new Date().toISOString()}).catch(l=>{console.error("Failed to persist automatic metrics snapshot",l)}))},[C,b,D?.uid]);const q=a.useMemo(()=>{const t=C.cycleCount??0,s=`${t} ciclo${t===1?"":"s"}`,o=6,r=["auto","manual","none"].includes(ie)?ie:"auto",c=r==="manual"&&V?"Manual":r==="auto"&&C.canCompute?"Automático":r==="none"?"Sin usar":"Automático",l=C.cyclesConsidered??[],h=!!C.canCompute,g=C.ignoredCount??0,y=typeof C.deduction=="number"&&Number.isFinite(C.deduction)?C.deduction:null,u=C.shortestCycle??null,N=typeof C.value=="number"&&Number.isFinite(C.value)?C.value:null;let k;if(t===0)k=g>0?"Todos los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos finalizados con fecha de finalización.";else if(!h)k=`Hay ${s} finalizado${t===1?"":"s"}. Se necesitan ${o} para calcular el CPM automáticamente.`,g>0&&(k+=` (${g} ciclo${g===1?"":"s"} ignorado${g===1?"":"s"}).`);else{const m=u?.dateRangeLabel||u?.displayName||u?.name||"Ciclo sin nombre",P=typeof u?.duration=="number"&&Number.isFinite(u.duration)?`${u.duration} días`:"duración desconocida",O=[`Calculado con ${s}.`,`Ciclo más corto: ${m} (${P}).`];y!==null&&O.push(`Deducción aplicada: ${y} días.`),N!==null&&O.push(`Resultado: ${N} días.`),g>0&&O.push(`${g} ciclo${g===1?"":"s"} ignorado${g===1?"":"s"}.`),k=O.join(" ")}return{sourceLabel:c,summary:k,highlightLabel:s,cycleCount:t,requiredCycles:o,canCompute:h,detailsAvailable:l.length>0,cycles:l,deduction:y,shortestCycle:u,value:N,ignoredCount:g}},[C,ie,V]),ta=a.useMemo(()=>{const t=b.cycleCount,s=`${t} ciclo${t===1?"":"s"}`,o=6,r=["auto","manual","none"].includes(W)?W:"auto",c=r==="manual"&&U?"Manual":r==="auto"&&b.canCompute?"Automático":r==="none"?"Sin usar":"Automático",l=b.ignoredCount??0,h=b.earliestCycle?.displayName||b.earliestCycle?.name||"Ciclo sin nombre",g=b.earliestCycle?.riseDay,y=typeof g=="number"&&Number.isFinite(g)?`Día ${g}`:"día desconocido",u=b.earliestCycle?.t8Day,N=typeof u=="number"&&Number.isFinite(u)?`T-8 Día ${u}`:null;let k;if(t===0)k=l>0?"Los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos con ovulación confirmada por temperatura.";else if(!b.canCompute)k=`Hay ${s} con ovulación confirmada por temperatura (se necesitan ${o}).`,l>0&&(k+=` ${l} ciclo${l===1?"":"s"} ignorado${l===1?"":"s"}.`);else{const m=[`${h} (${y}${N?` → ${N}`:""}).`];l>0&&m.push(`${l} ciclo${l===1?"":"s"} ignorado${l===1?"":"s"}.`),k=m.join(" ")}return{sourceLabel:c,summary:k,highlightLabel:s,cycleCount:t,requiredCycles:o,ignoredCount:l}},[b,U,W]),Ue=a.useCallback((t,s)=>typeof t!="number"||!Number.isFinite(t)?null:t.toLocaleString("es-ES",s),[]),es=a.useMemo(()=>pn({computedCpmData:C,cpmSelection:ie,isManualCpm:V,manualCpmBaseValue:z,manualCpmValue:Y,formatNumber:Ue}),[C,ie,Ue,V,z,Y]),ts=a.useMemo(()=>xn({computedT8Data:b,t8Selection:W,isManualT8:U,manualT8BaseValue:j,manualT8Value:E,formatNumber:Ue}),[b,Ue,U,j,E,W]),as=Ue(q.value,{maximumFractionDigits:1})??(typeof q.value=="number"&&Number.isFinite(q.value)?`${q.value}`:"—");Ue(Y,{maximumFractionDigits:1})??(typeof Y=="number"&&Number.isFinite(Y)&&`${Y}`);const wa=["auto","manual","none"].includes(ie)?ie:"auto",ot=wa==="manual"?V?"manual":"none":wa==="auto"?"auto":"none";ot==="manual"||ot==="auto"&&C.canCompute;const ss=ot==="manual"?"Manual":ot==="auto"?"Automático":"Sin usar",ns=Ue(b.value,{maximumFractionDigits:0})??(typeof b.value=="number"&&Number.isFinite(b.value)?`${b.value}`:"—");Ue(E,{maximumFractionDigits:0})??(typeof E=="number"&&Number.isFinite(E)&&`${E}`);const Na=["auto","manual","none"].includes(W)?W:"auto",lt=Na==="manual"?U?"manual":"none":Na==="auto"?"auto":"none";lt==="manual"||lt==="auto"&&b.canCompute;const rs=lt==="manual"?"Manual":lt==="auto"?"Automático":"Sin usar";a.useMemo(()=>fe||(_.trim()?"final":S.trim()?"base":null),[S,fe,_]);const ja=a.useMemo(()=>{if(X==="manual"){if(de||je)return!0;const t=S.trim()!==""&&!de,s=_.trim()!==""&&!je;return!t&&!s}return!1},[X,de,S,je,_]),os=a.useMemo(()=>!!(V||S.trim()||_.trim()),[V,S,_]);a.useMemo(()=>p||(Me.trim()?"final":Se.trim()?"base":null),[Se,p,Me]);const Da=a.useMemo(()=>{if(K==="manual"){if(Be||d)return!0;const t=Se.trim()!==""&&!Be,s=Me.trim()!==""&&!d;return!t&&!s}return!1},[Be,Se,d,Me,K]),ls=a.useMemo(()=>!!(U||Se.trim()||Me.trim()),[U,Se,Me]),Sa=a.useCallback(t=>{if(!t)return;const s=t.cycleId||t.id;if(s){if(i?.id&&s===i.id){x("/");return}x(`/cycle/${s}`)}},[i?.id,x]),Ma=a.useCallback(async(t,s)=>{if(t){ya(o=>o.includes(t)?o:[...o,t]);try{await ae(t,s),$({title:s?"Ciclo ignorado":"Ciclo incluido",description:s?"El ciclo se excluyó del cálculo automático.":"El ciclo se volvió a incluir en el cálculo automático."})}catch{}finally{ya(o=>o.filter(r=>r!==t))}}},[ae,$]),it=a.useCallback((t,s)=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),s())},[]),is=a.useCallback(()=>{const t=typeof C.shortestCycle?.duration=="number"&&Number.isFinite(C.shortestCycle.duration)?C.shortestCycle.duration:null,s=typeof C.value=="number"&&Number.isFinite(C.value)?C.value:null,o=typeof z=="number"&&Number.isFinite(z),r=typeof Y=="number"&&Number.isFinite(Y),c=V&&o?z:t,l=V&&r?Y:s;Ge(typeof c=="number"&&Number.isFinite(c)?String(c):""),le(typeof l=="number"&&Number.isFinite(l)?String(l):""),me(""),ee(""),Qe(null),Re(ie),He(!1),oe(!0)},[C,ie,V,z,Y]),$t=a.useCallback(()=>{He(!1),Ye(!1),Ve(!1),oe(!1)},[]),cs=a.useCallback(t=>{const{value:s}=t.target;if(Ge(s),Qe("base"),me(""),ee(""),!s.trim()){le("");return}const o=Number.parseInt(s,10);if(!Number.isFinite(o)){me("El ciclo más corto debe ser ≥ 1"),le("");return}if(o<1){me("El día de subida debe ser ≥ 1"),le("");return}const r=Math.max(1,o-fa);le(String(r))},[]),us=a.useCallback(t=>{const{value:s}=t.target;if(le(s),Qe("final"),ee(""),me(""),!s.trim())return;const o=s.replace(",","."),r=Number.parseFloat(o);if(!Number.isFinite(r)){ee("Introduce un número válido.");return}if(r<1){ee("El CPM debe ser ≥ 1");return}},[]),Fa=a.useCallback(async()=>{if(de||je)return!1;const t=S.trim(),s=_.trim(),o=fe??(s?"final":t?"base":null);if(!o)return ee("Introduce un valor."),!1;let r=z,c;if(o==="base"){if(!t)return me("Introduce un número entero válido."),!1;const y=Number.parseInt(t,10);if(!Number.isFinite(y))return me("Introduce un número entero válido."),!1;const u=Math.max(1,y-fa);r=y,c=u,le(String(u)),ee("")}else{if(!s)return ee("Introduce un valor."),!1;const y=s.replace(",","."),u=Number.parseFloat(y);if(!Number.isFinite(u)||u<1)return ee("El CPM debe ser ≥ 1 día"),!1;if(c=u,!t)r=null;else{const N=Number.parseInt(t,10);if(!Number.isFinite(N)||N<1)return me("Introduce un número entero válido."),!1;r=N}}const l=Y,h=V,g=z;De(c),Te(!0),pe(typeof r=="number"&&Number.isFinite(r)?r:null);try{return await nt({finalValue:c,baseValue:r}),oe(!1),$({title:"CPM actualizado",description:"El CPM manual se guardó en tu perfil."}),!0}catch(y){return console.error("Failed to save manual CPM value",y),De(l),pe(g),Te(h),ee("No se pudo guardar el CPM. Inténtalo de nuevo."),!1}},[V,de,S,z,fe,je,_,Y,nt,$]),ka=a.useCallback(async()=>{const t=Y,s=V,o=z;De(null),pe(null),Te(!1),Ge(""),le(""),me(""),ee(""),Qe(null);try{await nt({finalValue:null,baseValue:null}),$({title:"CPM borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(r){console.error("Failed to delete manual CPM value",r),De(t),pe(o),Te(s),ee("No se pudo borrar el CPM. Inténtalo de nuevo.")}},[V,z,Y,nt,$]),ds=a.useCallback(async()=>{Ve(!0);try{await ka(),Ye(!1);const t=q.canCompute?"auto":"none";Je(t),Re(t),await yt(t)}finally{Ve(!1)}},[q.canCompute,ka,yt]),ct=a.useCallback(t=>{Re(t)},[]),ms=a.useCallback(async()=>{const t=X;if(t==="manual"){if(!await Fa())return;Je("manual"),Re("manual"),await yt("manual");return}const s=["auto","none"].includes(t)?t:"auto";Je(s),Re(s),await yt(s),$t()},[X,$t,Fa,yt]),fs=a.useCallback(()=>{const t=typeof j=="number"&&Number.isFinite(j),s=typeof E=="number"&&Number.isFinite(E),o=U&&t?j:null,r=U&&s?E:null;ht(typeof o=="number"&&Number.isFinite(o)?String(o):""),Ee(typeof r=="number"&&Number.isFinite(r)?String(r):""),n(""),f(""),v(null),et(W),Yt(!1),Ze(!0)},[U,j,E,W]),Ot=a.useCallback(()=>{Ze(!1),Yt(!1),bt(!1),Xt(!1)},[]),ps=a.useCallback(t=>{const{value:s}=t.target;if(ht(s),v("base"),n(""),f(""),!s.trim()){Ee("");return}const o=Number.parseInt(s,10);if(!Number.isFinite(o)){n("Introduce un número entero válido."),Ee("");return}if(o<1){n("Introduce un número entero válido."),Ee("");return}const r=Math.max(1,o-8);Ee(String(r))},[]),xs=a.useCallback(t=>{const{value:s}=t.target;if(Ee(s),v("final"),f(""),n(""),!s.trim())return;const o=Number.parseInt(s,10);(!Number.isFinite(o)||o<1)&&f("El T-8 debe ser ≥ 1")},[]),Ia=a.useCallback(async()=>{if(Be||d)return!1;const t=Se.trim(),s=Me.trim(),o=p??(s?"final":t?"base":null);if(!o)return f("Introduce un valor."),!1;let r=j,c;if(o==="base"){if(!t)return n("Introduce un número entero válido."),!1;const y=Number.parseInt(t,10);if(!Number.isFinite(y)||y<1)return n("Introduce un número entero válido."),!1;const u=Math.max(1,y-8);r=y,c=u,Ee(String(u)),f("")}else{if(!s)return f("Introduce un valor."),!1;const y=Number.parseInt(s,10);if(!Number.isFinite(y)||y<1)return f("El T-8 debe ser ≥ 1"),!1;if(c=y,!t)r=null;else{const u=Number.parseInt(t,10);if(!Number.isFinite(u)||u<1)return n("Introduce un número entero válido."),!1;r=u}}const l=E,h=U,g=j;Fe(c),Pe(!0),M(typeof r=="number"&&Number.isFinite(r)?r:null);try{return await rt({finalValue:c,baseValue:r}),Ze(!1),$({title:"T-8 actualizado",description:"El T-8 manual se guardó en tu perfil."}),!0}catch(y){return console.error("Failed to save manual T-8 value",y),Fe(l),M(g),Pe(h),f("No se pudo guardar el T-8. Inténtalo de nuevo."),!1}},[U,Be,Se,j,p,d,Me,E,rt,$]),Ta=a.useCallback(async()=>{const t=E,s=U,o=j;Fe(null),M(null),Pe(!1),ht(""),Ee(""),n(""),f(""),v(null);try{await rt({finalValue:null,baseValue:null}),$({title:"T-8 borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(r){console.error("Failed to delete manual T-8 value",r),Fe(t),M(o),Pe(s),n("No se pudo borrar el T-8. Inténtalo de nuevo.")}},[U,j,E,rt,$]),hs=a.useCallback(async()=>{Xt(!0);try{await Ta(),bt(!1);const t=b.canCompute?"auto":"none";Xe(t),et(t),await gt(t)}finally{Xt(!1)}},[b.canCompute,Ta,gt]),ut=a.useCallback(t=>{et(t)},[]),bs=a.useCallback(async()=>{const t=K;if(t==="manual"){if(!await Ia())return;Xe("manual"),et("manual"),await gt("manual");return}const s=["auto","none"].includes(t)?t:"auto";Xe(s),et(s),await gt(s),Ot()},[Ot,Ia,gt,K]),_e=a.useCallback(()=>{Ie(null),qe(null),ft(!1),re(null)},[]),ys=a.useCallback(()=>{R(i?.startDate||""),L(""),_e(),Ae(!0)},[i?.startDate,_e]),$e=a.useCallback(()=>{Ae(!1),L(""),_e(),R(i?.startDate||"")},[i?.startDate,_e]),gs=a.useCallback(async()=>{if(i?.id){try{const t=await ne(i.id);if(t){ga(t),Kt(!0);return}}catch(t){console.error("Failed to preview undo cycle",t);return}Et(!0);try{await Q(i.id),Tt(!1),$e()}catch(t){console.error("Failed to undo cycle",t)}finally{Et(!1)}}},[i?.id,$e,Q,ne]),vs=a.useCallback(async()=>{if(i?.id){Et(!0);try{await Q(i.id),Kt(!1),Tt(!1),$e()}catch(t){console.error("Failed to undo cycle",t)}finally{Et(!1)}}},[i?.id,$e,Q]),Cs=a.useCallback(()=>{_e()},[_e]),ws=a.useCallback(async()=>{if(!Z){L("La fecha de inicio es obligatoria");return}if(i?.id){L(""),he(!0);try{const t=H?await H(i.id,Z):null;if(t){Ie(Z),qe(null),re(t),ft(!0),he(!1);return}await A(i.id,Z),await te({silent:!0}),$e()}catch(t){console.error("Error updating start date from dashboard:",t),L("No se pudo actualizar la fecha de inicio"),$({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{he(!1)}}},[Z,i?.id,H,A,te,$,$e]),Ns=a.useCallback(async()=>{if(!i?.id||!xe){_e();return}he(!0),ft(!1);try{await A(i.id,xe),await te({silent:!0}),$e()}catch(t){console.error("Error forcing start date from dashboard:",t),L("No se pudo actualizar la fecha de inicio"),$({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{he(!1),_e()}},[i?.id,xe,A,te,$,$e,_e]),[js,We]=a.useState(!1),[Ds,Ea]=a.useState(!1),[aa,sa]=a.useState(!1),[Pa,na]=a.useState(null),[$a,At]=a.useState(!1),[vt,Ct]=a.useState(null),[Ss,wt]=a.useState(null),[Ms,Nt]=a.useState(null),Fs=!!(vt&&String(vt.id||"").startsWith("placeholder-")),ks=a.useMemo(()=>i?.data?.find(s=>s?.peak_marker==="peak")?.isoDate||null,[i?.data]),[Rt,Bt]=a.useState(!1),ra=a.useCallback(()=>{typeof window>"u"||window.localStorage.removeItem(da)},[]),Oa=a.useCallback(t=>{typeof window>"u"||!t||window.localStorage.setItem(da,JSON.stringify(t))},[]),oa=a.useCallback(()=>{if(typeof window>"u")return null;const t=window.localStorage.getItem(da);if(!t)return null;try{return JSON.parse(t)}catch{return null}},[]),Aa=a.useCallback(()=>{ra(),We(!1),Ct(null),wt(null),Bt(!1),Nt(null)},[ra]),Ra=a.useCallback(async()=>{At(!1),typeof B=="function"&&await B({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[B]),Is=a.useCallback(t=>{Ct(t)},[]),Ts=a.useCallback((t,s=null)=>{Ct(t),wt(s??null),We(!0)},[]),Es=a.useCallback(async(t,s=!0)=>{if(!i?.id||!t?.isoDate)return;const o=c=>{if(c==null||c==="")return null;const l=parseFloat(String(c).replace(",","."));return Number.isFinite(l)?l:null},r=s??!(t.peak_marker==="peak"||t.peakStatus==="P");try{const c=t.timestamp?Ke(ue(t.timestamp),"HH:mm"):Ke(new Date,"HH:mm");let l=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:t.time??c,time_corrected:t.time_corrected??c,selected:!0,use_corrected:t.use_corrected??!1}];l.length===0&&(l=[{temperature:null,temperature_corrected:null,time:c,time_corrected:c,selected:!0,use_corrected:!1}]);const h=l.map((u,N)=>{const k=u.time||c,m=u.time_corrected||k;return{temperature:o(u.temperature??u.temperature_raw),time:k,selected:N===0?!0:!!u.selected,temperature_corrected:o(u.temperature_corrected),time_corrected:m,use_corrected:!!u.use_corrected}});h.some(u=>u.selected)||(h[0].selected=!0);const g={isoDate:t.isoDate,measurements:h,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",ignored:t.ignored??!1,peak_marker:r?"peak":null},y=t?.id&&!String(t.id).startsWith("placeholder-")?t:null;await I(g,y)}catch(c){console.error("Error toggling peak marker from dashboard:",c)}},[I,i?.id]),Ps=async(t,{keepFormOpen:s=!1}={})=>{Ea(!0);try{await I(t,vt),ra(),s||(We(!1),Ct(null),wt(null),Bt(!1),Nt(null))}finally{Ea(!1)}},Ba=a.useCallback(()=>{sa(!1),na(null),Rt&&(We(!0),Nt(oa()))},[Rt,oa]),_a=async t=>{await ke(t),sa(!1),na(null),Rt?(We(!0),Nt(oa())):(wt(null),We(!0)),w?.fertilityStartConfig?.postpartum===!0&&At(!0)},la=a.useCallback((t=null,s=null)=>{s?(Oa(s),Nt(s),Bt(!0)):Bt(!1),na(t||null),sa(!0)},[Oa]),$s=a.useMemo(()=>{if(!i?.startDate)return null;try{return Dt(St(new Date),ue(i.startDate))+1}catch(t){return console.error("Error calculating current day:",t),null}},[i?.startDate]),Os=a.useMemo(()=>{const t=[],s=h=>["auto","manual","none"].includes(h)?h:"auto",o=(h,g,y)=>{const u=Number(g);if(!Number.isFinite(u)||u<0)return;const N=Number(y),k=Number.isFinite(N)&&N>0,m=k?h==="CPM"?`ciclo base: ${N}`:`base ${h}: ${N}`:null;t.push({source:h,day:Math.max(1,u),reason:m?`Manual desde dashboard (${m})`:"Manual desde dashboard",kind:"calculator",isManual:!0,manualBase:k?N:null})},r=(h,g,y)=>{if(!y)return;const u=Number(g);Number.isFinite(u)&&t.push({source:h,day:Math.max(1,u),reason:"Automático desde dashboard",kind:"calculator"})},c=s(ie);c==="manual"?o("CPM",Y,z):c==="auto"&&r("CPM",C?.value,C?.canCompute);const l=s(W);return l==="manual"?o("T8",E,j):l==="auto"&&r("T8",b?.value,b?.canCompute),t},[C?.canCompute,C?.value,b?.canCompute,b?.value,ie,z,Y,j,E,W]),As=a.useMemo(()=>({calculators:{cpm:ie!=="none",t8:W!=="none"}}),[ie,W]),Rs=a.useMemo(()=>{const t=[];return Array.isArray(F)&&F.length>0&&t.push(...F),i&&t.push(i),t},[F,i]);return an(i?.data??[],!1,"portrait",void 0,i?.id,5,!1,As,Rs,Os,!1),G&&!i?.id?e.jsx("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:e.jsx("div",{className:"w-full rounded-3xl  p-4 text-center shadow-sm",children:e.jsx("p",{className:"text-sm font-semibold text-fertiliapp-fuerte",children:"Cargando..."})})}):i?.id?i?.startDate?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mx-auto flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] w-full flex-col space-y-4 px-4 pb-10 pt-4",children:e.jsxs(J.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex flex-1 flex-col gap-3",children:[e.jsx(hn,{cycleData:{...i,currentDay:$s,records:i.data},onEdit:Ts,onTogglePeak:Es,currentPeakIsoDate:ks,onEditStartDate:ys,handleOpenCpmDialog:is,handleOpenT8Dialog:fs,cpmMetric:es,t8Metric:ts}),e.jsx(dt,{open:Ft,onOpenChange:t=>{t||$t()},children:e.jsxs(mt,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col overflow-hidden rounded-3xl border border-rose-100 bg-white/95 p-0 text-gray-800 shadow-xl",children:[e.jsxs(zt,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(Vt,{children:"Editar CPM"}),e.jsx(Ja,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${ot==="manual"||ot==="auto"?"bg-rose-100 text-rose-700":"bg-gray-100 text-gray-600"}`,children:ss})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>ct("auto"),onKeyDown:t=>it(t,()=>ct("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${X==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-fertiliapp-suave"} ${q.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:q.canCompute&&q.value!==null?`CPM automático: ${as} días`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${X==="auto"?"border-emerald-400 bg-emerald-400":"border-fertiliapp-suave bg-white"}`,children:X==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>He(t=>!t),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":pt,children:q.highlightLabel})]}),q.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:q.summary}),!q.detailsAvailable&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."}),pt&&q.detailsAvailable&&e.jsx("div",{className:"mt-2 space-y-2",children:q.cycles.length>0?e.jsx("ul",{className:"space-y-1",children:q.cycles.map((t,s)=>{const o=t.cycleId||t.id||`${t.displayName||t.name||t.startDate||"cycle"}-${s}`,r=typeof t.duration=="number"&&Number.isFinite(t.duration)?`${t.duration} días`:"duración desconocida",c=!!(q.shortestCycle&&q.shortestCycle===t),l=t.cycleId||t.id,h=!!(t.isIgnored||t.ignoredForAutoCalculations),g=l?ba.includes(l):!1,y=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${h?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/50"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${y} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>Sa(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(ma,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Duración: ",r]}),c&&e.jsx("span",{className:"rounded-full bg-rose-100 px-2 py-0.5 font-semibold text-rose-600",children:"Ciclo más corto"})]}),h&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Ce,{type:"button",variant:"outline",size:"xs",disabled:!l||g,onClick:()=>l&&Ma(l,!h),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:h?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":h?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":h,children:g?e.jsxs(e.Fragment,{children:[e.jsx(Ua,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):h?e.jsx(Ha,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(Ya,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":X==="manual",onClick:()=>ct("manual"),onKeyDown:t=>it(t,()=>ct("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${X==="manual"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${X==="manual"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:X==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Wt,{htmlFor:"manual-cpm-base",className:"text-xs text-gray-600",children:"Ciclo más corto"}),e.jsx(Jt,{id:"manual-cpm-base",type:"number",inputMode:"numeric",step:"1",min:"1",value:S,onChange:cs,placeholder:"Introduce un entero","aria-describedby":fe?"manual-cpm-helper":void 0}),de&&e.jsx("p",{className:"text-xs text-red-500",children:de})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Wt,{htmlFor:"manual-cpm-final",className:"text-xs text-gray-600",children:"CPM obtenido"}),e.jsx(Jt,{id:"manual-cpm-final",type:"number",inputMode:"decimal",step:"0.1",min:"1",value:_,onChange:us,placeholder:"Introduce el valor","aria-describedby":fe?"manual-cpm-helper":void 0}),je&&e.jsx("p",{className:"text-xs text-red-500",children:je})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:[fe&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-cpm-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:fe==="base"?"Usando Ciclo más corto como base":"Usando CPM (final)"})}),e.jsx(Ce,{type:"button",variant:"outline",onClick:()=>Ye(!0),disabled:!os,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"})]}),ja&&X==="manual"&&!V&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":X==="none",onClick:()=>ct("none"),onKeyDown:t=>it(t,()=>ct("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${X==="none"?"border-emerald-300 bg-emerald-50/60":"border-dashed border-rose-200 bg-white/70 hover:border-rose-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${X==="none"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:X==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(Ut,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:$t,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(Ce,{type:"button",onClick:ms,disabled:ja,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(dt,{open:xt,onOpenChange:Ye,children:e.jsxs(mt,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(zt,{children:e.jsx(Vt,{children:"¿Estás segura de que quieres borrar el valor manual de CPM?"})}),e.jsxs(Ut,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:()=>Ye(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(Ce,{type:"button",variant:"destructive",onClick:ds,disabled:kt,className:"w-full sm:w-auto",children:kt?"Borrando…":"Borrar"})]})]})}),e.jsx(dt,{open:It,onOpenChange:t=>{t||Ot()},children:e.jsxs(mt,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col rounded-3xl border border-rose-100 bg-white/95 text-gray-800 shadow-xl overflow-hidden p-0",children:[e.jsxs(zt,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(Vt,{children:"Editar T-8"}),e.jsx(Ja,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${lt==="manual"||lt==="auto"?"bg-rose-100 text-rose-700":"bg-gray-100 text-gray-600"}`,children:rs})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>ut("auto"),onKeyDown:t=>it(t,()=>ut("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${K==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"} ${b.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:b.canCompute&&b.value!==null?`T-8 automático: Día ${ns}`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${K==="auto"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:K==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>Yt(t=>!t),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":xa,children:ta.highlightLabel})]}),ta.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:ta.summary}),b.cycleCount===0&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."}),xa&&b.cycleCount>0&&e.jsx("div",{className:"mt-2 space-y-2",children:b.cyclesConsidered.length>0?e.jsx("ul",{className:"space-y-1",children:b.cyclesConsidered.map((t,s)=>{const o=t.cycleId||`${t.displayName}-${t.riseDay}-${s}`,r=typeof t.riseDay=="number"&&Number.isFinite(t.riseDay)?t.riseDay:"—",c=t.cycleId||t.id,l=!!(t.isIgnored||t.ignoredForAutoCalculations),h=c?ba.includes(c):!1,g=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${l?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/40"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${g} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>Sa(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(ma,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Día de subida: ",r]}),Number.isFinite(t.t8Day)&&e.jsxs("span",{children:["T-8: Día ",t.t8Day]})]}),l&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Ce,{type:"button",variant:"outline",size:"icon",disabled:!c||h,onClick:()=>c&&Ma(c,!l),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:l?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":l?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":l,children:h?e.jsxs(e.Fragment,{children:[e.jsx(Ua,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):l?e.jsx(Ha,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(Ya,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":K==="manual",onClick:()=>ut("manual"),onKeyDown:t=>it(t,()=>ut("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${K==="manual"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${K==="manual"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:K==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Wt,{htmlFor:"manual-t8-base",className:"text-xs text-gray-600",children:"Ciclo con subida (día)"}),e.jsx(Jt,{id:"manual-t8-base",type:"number",inputMode:"numeric",step:"1",min:"1",value:Se,onChange:ps,placeholder:"Día de subida","aria-describedby":p?"manual-t8-helper":void 0}),Be&&e.jsx("p",{className:"text-xs text-red-500",children:Be})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Wt,{htmlFor:"manual-t8-final",className:"text-xs text-gray-600",children:"T-8 manual (día)"}),e.jsx(Jt,{id:"manual-t8-final",type:"number",inputMode:"numeric",step:"1",min:"1",value:Me,onChange:xs,placeholder:"Día del T-8","aria-describedby":p?"manual-t8-helper":void 0}),d&&e.jsx("p",{className:"text-xs text-red-500",children:d})]})]}),e.jsx("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:p&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-t8-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:p==="base"?"Usando día de subida como base":"Usando T-8 manual"})})}),e.jsx(Ce,{type:"button",variant:"outline",onClick:()=>bt(!0),disabled:!ls,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"}),Da&&K==="manual"&&!U&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":K==="none",onClick:()=>ut("none"),onKeyDown:t=>it(t,()=>ut("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${K==="none"?"border-emerald-300 bg-emerald-50/60":"border-dashed border-rose-200 bg-white/70 hover:border-rose-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${K==="none"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:K==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(Ut,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:Ot,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(Ce,{type:"button",onClick:bs,disabled:Da,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(dt,{open:qa,onOpenChange:bt,children:e.jsxs(mt,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(zt,{children:e.jsx(Vt,{children:"¿Estás segura de que quieres borrar el valor manual de T-8?"})}),e.jsxs(Ut,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:()=>bt(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(Ce,{type:"button",variant:"destructive",onClick:hs,disabled:ha,className:"w-full sm:w-auto",children:ha?"Borrando…":"Borrar"})]})]})}),e.jsx(dt,{open:Le,onOpenChange:t=>{t||$e()},children:e.jsx(mt,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Xs,{cycle:i,startDate:Z,endDate:i.endDate,otherCycles:[...F??[],i].filter(Boolean),onStartDateChange:t=>R(t),onSave:ws,onCancel:$e,isProcessing:se||G||Gt,dateError:Ne,includeEndDate:!1,showOverlapDialog:Ht,overlapCycle:Mt,overlapImpactPreview:ze,onConfirmOverlap:Ns,onCancelOverlap:Cs,onClearError:()=>L(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",onUndoCycle:st?()=>Tt(!0):void 0,isUndoingCycle:Gt,className:"w-full"})})})]})}),e.jsx(Qs,{isOpen:Ga,onClose:()=>Tt(!1),onConfirm:gs,title:"Deshacer ciclo",confirmLabel:"Deshacer ciclo",cancelLabel:"Cancelar",description:Za,isProcessing:Gt}),e.jsx(Zs,{isOpen:Qa,onCancel:()=>{Kt(!1),ga(null)},onConfirm:vs,title:"Este cambio ajustará otros ciclos",description:"Deshacer el ciclo actual unirá ciclos y moverá registros.",confirmLabel:"Aplicar cambios",affectedCycles:qt?.affectedCycles||[],impactSummary:qt?.impactSummary,adjustedCyclesPreview:qt?.adjustedCyclesPreview||[]}),e.jsx(dt,{open:js,onOpenChange:t=>{if(t){We(!0);return}Rt||aa||Aa()},children:e.jsx(mt,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",onInteractOutside:t=>{t.preventDefault()},onPointerDownOutside:t=>{t.preventDefault()},children:e.jsx(qs,{onSubmit:Ps,onCancel:Aa,initialData:vt,cycleStartDate:i.startDate,cycleEndDate:i.endDate,isProcessing:Ds,isEditing:!!vt&&!Fs,cycleData:i.data,onDateSelect:Is,initialSectionKey:Ss,onOpenNewCycle:la,formDraft:Ms})})}),e.jsx(bn,{onAddRecord:()=>{Ct(null),wt(null),We(!0)},onAddCycle:()=>la()}),e.jsx(za,{isOpen:aa,onClose:Ba,onPreview:t=>T?.(t,i?.id),onConfirm:_a,currentCycleStartDate:i.startDate,currentCycleRecords:i?.data??[],initialStartDate:Pa}),e.jsx(Va,{isOpen:$a,onClose:()=>At(!1),onConfirm:Ra})]}):e.jsx("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:e.jsx("div",{className:"w-full rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:e.jsx("p",{className:"text-sm font-semibold text-slate-800",children:"Cargando..."})})}):e.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[e.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[e.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>la(),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),e.jsx(za,{isOpen:aa,onClose:Ba,onPreview:t=>T?.(t,i?.id),onConfirm:_a,currentCycleRecords:i?.data??[],initialStartDate:Pa}),e.jsx(Va,{isOpen:$a,onClose:()=>At(!1),onConfirm:Ra})]})};export{In as default};
