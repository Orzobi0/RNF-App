import{c as ge,r as n,f as A,j as e,B as he,b as be,p as G,d as de,s as ue,m as u,e as we}from"./index-830127db.js";import{C as ke}from"./CycleDatesEditor-254cc7d5.js";import{D as je,c as ve,C as De,a as Ne,i as Se}from"./computePeakStatuses-630ea28a.js";import{u as Ce,P as Me}from"./badge-96ec44c3.js";import{D as me,a as pe,b as Ee,c as Pe,d as _e,e as Oe,u as Te}from"./useCycleData-5b813aa3.js";import{I as Fe}from"./input-cbf91fa7.js";import{C as Re}from"./ChartTooltip-859bf87e.js";import{P as Ae}from"./pen-square-a78f7160.js";import"./OverlapWarningDialog-3396aeb9.js";import"./label-da4c6ed7.js";import"./checkbox-be556efa.js";import"./eye-dba9030b.js";const Ie=ge("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),ze=ge("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]),xe=({isOpen:a,onClose:k,onConfirm:S,currentCycleStartDate:j})=>{const[O,g]=n.useState(A(new Date,"yyyy-MM-dd"));Ce(a,k);const h=!j,p=()=>{S(O)},C=h?"":A(new Date(j),"dd/MM/yyyy"),H=(()=>{if(h)return"";const d=new Date(O);return d.setDate(d.getDate()-1),A(d,"dd/MM/yyyy")})();return e.jsx(me,{open:a,onOpenChange:k,children:e.jsxs(pe,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(Ee,{children:[e.jsx(Pe,{children:"Iniciar nuevo ciclo"}),e.jsx(_e,{className:"text-gray-600",children:h?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${C} - ${H}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsx(Fe,{id:"startDate",type:"date",value:O,onChange:d=>g(d.target.value),max:A(new Date,"yyyy-MM-dd"),min:h?void 0:A(new Date(j),"yyyy-MM-dd"),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),e.jsxs(Oe,{className:"sm:justify-end",children:[e.jsx(he,{variant:"outline",onClick:k,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(he,{variant:"primary",onClick:p,className:"bg-pink-600 hover:bg-pink-700 text-white",children:h?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})})},Le=({cycleData:a,onEdit:k,onTogglePeak:S,currentPeakIsoDate:j,onEditStartDate:O=()=>{}})=>{var Q,s;const g=a.records||[],[h,p]=n.useState(null),[C,H]=n.useState({clientX:0,clientY:0}),[d,v]=n.useState(0),T=n.useRef(!1),I=n.useRef(null),m=n.useRef(null),y=a.startDate?G(a.startDate):null,q=ue(new Date),ee=n.useMemo(()=>ve(g),[g]),f=28,F=140,D=F+15,M=D*2,b=n.useMemo(()=>{const t=g.reduce((r,i)=>{const l=(i==null?void 0:i.cycleDay)??null;if(l)return Math.max(r,l);if(!y||!(i!=null&&i.isoDate))return r;try{const o=G(i.isoDate),x=de(o,y)+1;return Number.isFinite(x)?Math.max(r,x):r}catch(o){return console.error("Error calculating record day for wheel:",o),r}},0);return Math.max(a.currentDay,t,f)},[a.currentDay,g,y,f]),E=Math.max(b-f,0),c=E>0;n.useEffect(()=>{if(!c){T.current=!0,v(0);return}v(t=>{const r=Math.min(t,E),i=Math.max(0,Math.min(Math.max(a.currentDay-f,0),E)),l=a.currentDay>=r+1&&a.currentDay<=r+f;return T.current?l?r!==t?r:t:i:(T.current=!0,i)})},[c,E,a.currentDay,f]);const B=n.useCallback(t=>Math.max(0,Math.min(t,E)),[E]),R=n.useCallback(t=>{!c||t===0||v(r=>B(r+t))},[B,c]),te=n.useCallback(t=>{if(!c)return;t.preventDefault();const r=Math.abs(t.deltaY)>Math.abs(t.deltaX)?t.deltaY:t.deltaX;r!==0&&R(r>0?1:-1)},[R,c]),ae=n.useCallback(t=>{var r,i;c&&(I.current=((i=(r=t.touches)==null?void 0:r[0])==null?void 0:i.clientX)??null)},[c]),P=n.useCallback(t=>{var l,o;if(!c||I.current===null)return;const r=((o=(l=t.touches)==null?void 0:l[0])==null?void 0:o.clientX)??null;if(r===null)return;const i=r-I.current;Math.abs(i)<24||(R(i<0?1:-1),I.current=r)},[R,c]),se=n.useCallback(()=>{I.current=null},[]),Y=t=>{switch(t){case"red":return{main:"#ef4444",light:"#fee2e2",glow:"rgba(239, 68, 68, 0.3)",border:"none"};case"white":return{main:"#f8fafc",light:"#ffe4e6",glow:"rgba(248, 250, 252, 0.3)"};case"green":return{main:"#22c55e",light:"#22c55e",glow:"rgba(34, 197, 94, 0.3)",border:"none"};case"yellow":return{main:"#facc15",light:"#fef08a",glow:"rgba(250, 204, 21, 0.3)",border:"none"};case"spot":return{main:"#ef4444",light:"#ef4444",glow:"rgba(239, 68, 68, 0.3)",border:"#fee2e2",pattern:"url(#spotting-pattern-dashboard)"};default:return{main:"#d1d5db",light:"#f8fafc",glow:"rgba(209, 213, 219, 0.3)"}}},J=n.useMemo(()=>g.reduce((t,r)=>{if(!r)return t;const i=Number(r.cycleDay);if(Number.isFinite(i)&&i>0)return t.has(i)||t.set(i,r),t;if(!y||!r.isoDate)return t;try{const l=G(r.isoDate),o=de(l,y)+1;Number.isFinite(o)&&o>0&&!t.has(o)&&t.set(o,{...r,cycleDay:o})}catch(l){console.error("Error mapping record by day for wheel:",l)}return t},new Map),[g,y]),L=(()=>Array.from({length:f},(t,r)=>{const i=d+r+1,l=J.get(i)??null,o=y?we(y,i-1):null,x=o?A(o,"yyyy-MM-dd"):null,N=o?Se(ue(o),q):!1,_=l?{...l,cycleDay:l.cycleDay??i}:null,w=(r+d)/f*2*Math.PI-Math.PI/2,ce=D+F*Math.cos(w),Z=D+F*Math.sin(w);let U=i<=a.currentDay&&_?Y(_.fertility_symbol):{main:"#b5b6ba",light:"#c8cacf",glow:"rgba(229, 231, 235, 0.3)"};const fe=i===a.currentDay;fe&&(_?U={...Y(_.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:U={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const ye=x&&ee[x]||null;return{x:ce,y:Z,day:i,colors:U,isActive:i<=a.currentDay,isToday:fe,hasRecord:!!_,record:_,isoDate:x,canShowPlaceholder:!!(!_&&x&&!N),peakStatus:ye}}))(),W=2*Math.PI/f,X=-Math.PI/2-W/2,K=F-18,$=F+10,re=D+K*Math.cos(X),ne=D+K*Math.sin(X),ie=D+$*Math.cos(X),le=D+$*Math.sin(X);n.useEffect(()=>{c&&p(null)},[d,c]);const oe=(t,r)=>{if(r.stopPropagation(),!m.current){p(null);return}const i=m.current.getBoundingClientRect();let l,o;r.touches&&r.touches[0]?(l=r.touches[0].clientX,o=r.touches[0].clientY):(l=r.clientX,o=r.clientY);const x=t.canShowPlaceholder&&t.isoDate?{id:`placeholder-${t.isoDate}`,isoDate:t.isoDate,cycleDay:t.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:t.peakStatus,peak_marker:t.peakStatus==="P"?"peak":null}:null,N=t.record?{...t.record,cycleDay:t.record.cycleDay??t.day,peakStatus:t.peakStatus,peak_marker:t.record.peak_marker??(t.peakStatus==="P"?"peak":null)}:x;if(N&&j&&N.isoDate===j&&(N.peak_marker="peak",N.peakStatus=N.peakStatus||"P"),!N){p(null);return}H({clientX:l-i.left,clientY:o-i.top}),p(N)};return n.useEffect(()=>{if(!h)return;const t=r=>{m.current&&!m.current.contains(r.target)&&p(null)};return document.addEventListener("mousedown",t),document.addEventListener("touchstart",t),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("touchstart",t)}},[h]),e.jsxs("div",{className:"relative flex flex-col flex-1 min-h-full overflow-y-hidden",children:[e.jsxs(u.div,{className:"px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:O,className:"text-sm font-medium text-pink-700 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1.5 inline-flex items-center gap-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white/40",title:"Editar fecha de inicio del ciclo",children:[e.jsx(Ae,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(u.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:[e.jsxs("div",{className:"text-center mb-3 flex-shrink-0",children:[e.jsxs(u.div,{ref:m,className:"relative inline-flex items-center justify-center mb-4",style:{width:M,height:M},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15,delay:.3},onWheel:te,onTouchStart:ae,onTouchMove:P,onTouchEnd:se,children:[e.jsxs("svg",{className:"w-full h-full",viewBox:`0 0 ${M} ${M}`,onClick:()=>p(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"50%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.0)"}),e.jsx("stop",{offset:"60%",stopColor:"rgba(244,114,182,0.12)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(190,24,93,0.10)"})]})]}),e.jsx("circle",{cx:D,cy:D,r:F-30,fill:"url(#ringGlow)",stroke:"rgba(255,255,255,0.35)",strokeWidth:"0.5"}),c&&e.jsx("line",{x1:re,y1:ne,x2:ie,y2:le,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(u.g,{transition:{type:"spring",stiffness:100,damping:22},initial:!1,animate:{rotate:-(d*360)/f},style:{transformOrigin:"center",transformBox:"view-box"},children:L.map((t,r)=>e.jsxs("g",{children:[!(t.isToday&&!t.hasRecord)&&t.isActive&&e.jsx("circle",{cx:t.x+.3,cy:t.y+.3,r:t.isToday?11:10,fill:"rgba(0, 0, 0, 0.2)",opacity:.5}),t.isToday&&e.jsx("circle",{cx:t.x,cy:t.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}}),e.jsx(u.circle,{cx:t.x,cy:t.y,r:t.isToday?11:10,fill:t.colors.pattern||(t.isActive&&t.hasRecord?t.colors.main:"rgba(255,255,255,0.001)"),stroke:t.colors.border==="none"?"none":t.colors.border||"rgba(158,158,158,0.4)",strokeWidth:t.colors.border==="none"?0:t.isToday?1.8:t.colors.border?.6:.8,onClick:i=>oe(t,i),initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.6,delay:.8+r*.02,type:"spring",stiffness:400,damping:25},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.2))",cursor:"pointer"}}),t.peakStatus&&e.jsx("g",{children:t.peakStatus==="P"?e.jsx(u.text,{x:t.x,y:t.y+4,textAnchor:"middle",fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none",filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))"},initial:{scale:.2,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.95+r*.02,type:"spring",stiffness:320,damping:22},children:"✖"}):e.jsx(u.text,{x:t.x,y:t.y+4,textAnchor:"middle",fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},initial:{scale:.2,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.95+r*.02,type:"spring",stiffness:320,damping:22},children:t.peakStatus})})]},r))})]}),h&&e.jsx("div",{onClick:t=>t.stopPropagation(),children:e.jsx(Re,{point:h,position:C,chartWidth:((Q=m.current)==null?void 0:Q.clientWidth)||0,chartHeight:((s=m.current)==null?void 0:s.clientHeight)||0,onEdit:k,onClose:()=>p(null),onTogglePeak:S,currentPeakIsoDate:j})}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[e.jsxs(u.div,{className:"text-center  backdrop-blur-md rounded-full p-4",initial:{opacity:0,scale:.5},animate:{opacity:1,scale:1},transition:{delay:1,type:"spring",stiffness:200},style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"},children:[e.jsx("span",{className:"text-5xl font-bold text-pink-700 block",children:a.currentDay}),e.jsx("span",{className:"text-800 text-pink-700 font-medium mt-0.5 block",children:"día del ciclo"})]}),e.jsx(u.div,{className:"mt-2 px-2.5 py-1  backdrop-blur-sm rounded-full border border-pink-200",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.3},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.1))"},children:e.jsx("span",{className:"text-md font-medium text-pink-900",children:a.currentDay<=7?"Menstrual":a.currentDay<=14?"Folicular":a.currentDay<=21?"Ovulatoria":"Lútea"})})]})]}),c&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>R(-1),disabled:d===0,children:e.jsx(De,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-xs font-semibold text-rose-600 tracking-wide uppercase",children:"Rueda del ciclo"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",d+1]}),e.jsx("span",{className:"text-xs text-rose-400",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",Math.min(d+f,b)]})]}),e.jsx("input",{type:"range",min:0,max:E,value:d,onChange:t=>v(B(Number(t.target.value))),className:"w-44 accent-rose-500"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>R(1),disabled:d===E,children:e.jsx(Ne,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0",children:[e.jsxs(u.div,{className:"relative bg-gradient-to-br from-pink-50/90 to-rose-50/90 backdrop-blur-md rounded-3xl p-4 border border-pink-200/30",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.5},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.08))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.7)"},children:[e.jsx("h3",{className:"font-bold mb-6 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Símbolos"}),e.jsx("div",{className:"grid grid-cols-2 gap-2.5",children:[{label:"Menstrual",color:"#ef4444"},{label:"Moco (Fértil)",color:"#f8fafc",stroke:"#c2c6cc"},{label:"Seco (Rel. Infértil)",color:"#22c55e"},{label:"Moco (No fértil)",color:"#facc15",stroke:"#fef08a"},{label:"Spotting",color:"#ef4444",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(t=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[t.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-4 h-4 rounded-full border ${t.pattern?"pattern-bg":""}`,style:{backgroundColor:t.color,borderColor:t.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${t.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:t.label})]},t.label))}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-300/40 to-rose-400/40 rounded-full"})]}),e.jsxs(u.div,{className:"relative bg-gradient-to-br from-pink-50/70 to-rose-50/50 backdrop-blur-md rounded-3xl p-4 border border-pink-200/40",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.6},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.1))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.8)"},children:[e.jsx("h3",{className:"font-bold mb-3 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Cálculo"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"CPM"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"bg-white/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-gray-200/50 shadow-sm",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"Sin datos"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"T-8"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"bg-white/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-gray-200/50 shadow-sm",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"Sin datos"})})]})]}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-500/40 to-rose-400/40 rounded-full"})]})]})]})]})},We=({onAddRecord:a,onAddCycle:k})=>{const[S,j]=n.useState(!1);return e.jsxs("div",{className:"fixed bottom-[calc(var(--bottom-nav-height)+1rem)] right-6 flex flex-col items-end space-y-3 z-50",children:[S&&e.jsxs(e.Fragment,{children:[e.jsxs(u.button,{onClick:k,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white shadow-lg",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(147, 51, 234, 0.3))"},children:[e.jsx(Ie,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]}),e.jsxs(u.button,{onClick:a,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(ze,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]})]}),e.jsx(u.button,{onClick:()=>j(!S),className:"w-14 h-14 bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-full shadow-lg flex items-center justify-center",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 6px 16px rgba(236, 72, 153, 0.4))"},children:e.jsx(u.span,{animate:{rotate:S?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(Me,{className:"h-6 w-6"})})})]})},Ze=()=>{const{currentCycle:a,addOrUpdateDataPoint:k,startNewCycle:S,isLoading:j,updateCycleDates:O,checkCycleOverlap:g,forceUpdateCycleStart:h,refreshData:p}=Te(),{toast:C}=be(),[H,d]=n.useState(!1),[v,T]=n.useState(()=>(a==null?void 0:a.startDate)||""),[I,m]=n.useState(""),[y,q]=n.useState(null),[ee,f]=n.useState(null),[F,V]=n.useState(!1),[D,M]=n.useState(!1);n.useEffect(()=>{T((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate]);const b=n.useCallback(()=>{q(null),f(null),V(!1)},[]),E=n.useCallback(()=>{T((a==null?void 0:a.startDate)||""),m(""),b(),d(!0)},[a==null?void 0:a.startDate,b]),c=n.useCallback(()=>{d(!1),m(""),b(),T((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate,b]),B=n.useCallback(()=>{b()},[b]),R=n.useCallback(async()=>{if(!v){m("La fecha de inicio es obligatoria");return}if(a!=null&&a.id){m(""),M(!0);try{const s=g?await g(a.id,v):null;if(s){q(v),f(s),V(!0),M(!1);return}await O(a.id,v),await p({silent:!0}),C({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),c()}catch(s){console.error("Error updating start date from dashboard:",s),m("No se pudo actualizar la fecha de inicio"),C({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{M(!1)}}},[v,a==null?void 0:a.id,g,O,p,C,c]),te=n.useCallback(async()=>{if(!(a!=null&&a.id)||!y){b();return}M(!0),V(!1);try{await h(a.id,y),await p({silent:!0}),C({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),c()}catch(s){console.error("Error forcing start date from dashboard:",s),m("No se pudo actualizar la fecha de inicio"),C({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{M(!1),b()}},[a==null?void 0:a.id,y,h,p,C,c,b]),[ae,P]=n.useState(!1),[se,Y]=n.useState(!1),[J,z]=n.useState(!1),[L,W]=n.useState(null),X=!!(L&&String(L.id||"").startsWith("placeholder-")),K=n.useMemo(()=>{var t;const s=(t=a==null?void 0:a.data)==null?void 0:t.find(r=>(r==null?void 0:r.peak_marker)==="peak");return(s==null?void 0:s.isoDate)||null},[a==null?void 0:a.data]),$=n.useCallback(()=>{P(!1),W(null)},[]),re=n.useCallback(s=>{W(s)},[]),ne=n.useCallback(s=>{W(s),P(!0)},[]),ie=n.useCallback(async(s,t=!0)=>{if(!(a!=null&&a.id)||!(s!=null&&s.isoDate))return;const r=l=>{if(l==null||l==="")return null;const o=parseFloat(String(l).replace(",","."));return Number.isFinite(o)?o:null},i=t??!(s.peak_marker==="peak"||s.peakStatus==="P");try{const l=s.timestamp?A(G(s.timestamp),"HH:mm"):A(new Date,"HH:mm");let o=Array.isArray(s.measurements)&&s.measurements.length>0?s.measurements:[{temperature:s.temperature_chart??s.temperature_raw??null,temperature_corrected:s.temperature_corrected??null,time:s.time??l,time_corrected:s.time_corrected??l,selected:!0,use_corrected:s.use_corrected??!1}];o.length===0&&(o=[{temperature:null,temperature_corrected:null,time:l,time_corrected:l,selected:!0,use_corrected:!1}]);const x=o.map((w,ce)=>{const Z=w.time||l,U=w.time_corrected||Z;return{temperature:r(w.temperature??w.temperature_raw),time:Z,selected:ce===0?!0:!!w.selected,temperature_corrected:r(w.temperature_corrected),time_corrected:U,use_corrected:!!w.use_corrected}});x.some(w=>w.selected)||(x[0].selected=!0);const N={isoDate:s.isoDate,measurements:x,mucusSensation:s.mucus_sensation??s.mucusSensation??"",mucusAppearance:s.mucus_appearance??s.mucusAppearance??"",fertility_symbol:s.fertility_symbol??"none",observations:s.observations??"",ignored:s.ignored??!1,peak_marker:i?"peak":null},_=s!=null&&s.id&&!String(s.id).startsWith("placeholder-")?s:null;await k(N,_)}catch(l){console.error("Error toggling peak marker from dashboard:",l)}},[k,a==null?void 0:a.id]);if(j&&!(a!=null&&a.id))return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:e.jsx("p",{className:"text-center text-gray-600 text-lg",children:"Cargando..."})});if(!(a!=null&&a.id))return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br ffrom-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-gray-600 text-lg",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>z(!0),className:"px-6 py-3 rounded-lg bg-pink-600 hover:bg-pink-700 text-white shadow",children:"Iniciar ciclo"})]}),e.jsx(xe,{isOpen:J,onClose:()=>z(!1),onConfirm:async s=>{await S(s),z(!1),P(!0)}})]});const le=de(ue(new Date),G(a.startDate))+1,oe=async(s,{keepFormOpen:t=!1}={})=>{Y(!0);try{await k(s,L),t||(P(!1),W(null))}finally{Y(!1)}},Q=async s=>{await S(s),z(!1),P(!0)};return e.jsxs("div",{className:"min-h-[calc(100dvh-var(--bottom-nav-safe))] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative overflow-hidden flex flex-col",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"max-w-md mx-auto flex-1 w-full flex flex-col",children:e.jsxs(u.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex-1 flex flex-col",children:[e.jsx(Le,{cycleData:{...a,currentDay:le,records:a.data},onEdit:ne,onTogglePeak:ie,currentPeakIsoDate:K,onEditStartDate:E}),e.jsx(me,{open:H,onOpenChange:s=>{s||c()},children:e.jsx(pe,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(ke,{cycle:a,startDate:v,endDate:a.endDate,onStartDateChange:s=>T(s),onSave:R,onCancel:c,isProcessing:D,dateError:I,includeEndDate:!1,showOverlapDialog:F,overlapCycle:ee,onConfirmOverlap:te,onCancelOverlap:B,onClearError:()=>m(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",className:"w-full"})})})]})}),e.jsx(me,{open:ae,onOpenChange:s=>{s?P(!0):$()},children:e.jsx(pe,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(je,{onSubmit:oe,onCancel:$,initialData:L,cycleStartDate:a.startDate,cycleEndDate:a.endDate,isProcessing:se,isEditing:!!L&&!X,cycleData:a.data,onDateSelect:re})})}),e.jsx(We,{onAddRecord:()=>{W(null),P(!0)},onAddCycle:()=>z(!0)}),e.jsx(xe,{isOpen:J,onClose:()=>z(!1),onConfirm:Q,currentCycleStartDate:a.startDate})]})};export{Ze as default};
