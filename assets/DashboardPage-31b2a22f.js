import{c as we,r as n,f as W,j as e,B as ye,b as De,p as J,d as me,s as pe,m,e as Ne}from"./index-a6c447c5.js";import{C as Se}from"./CycleDatesEditor-3688eabe.js";import{D as Ce,c as Me,C as Ee,a as Pe,i as _e}from"./computePeakStatuses-5c65dc01.js";import{u as Oe,P as Te}from"./badge-29ccf1d1.js";import{D as fe,a as he,b as Re,c as Fe,d as Ae,e as Ie,u as ze}from"./useCycleData-1ec13a38.js";import{I as Le}from"./input-620e50d2.js";import{C as We}from"./ChartTooltip-03720f40.js";import{P as Xe}from"./pen-square-ec264279.js";import"./OverlapWarningDialog-60ecf11f.js";import"./label-fe40f887.js";import"./checkbox-2914330c.js";import"./eye-0f3c0a93.js";const He=we("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),Be=we("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]),be=({isOpen:a,onClose:j,onConfirm:S,currentCycleStartDate:v})=>{const[O,y]=n.useState(W(new Date,"yyyy-MM-dd"));Oe(a,j);const g=!v,h=()=>{S(O)},C=g?"":W(new Date(v),"dd/MM/yyyy"),U=(()=>{if(g)return"";const d=new Date(O);return d.setDate(d.getDate()-1),W(d,"dd/MM/yyyy")})();return e.jsx(fe,{open:a,onOpenChange:j,children:e.jsxs(he,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(Re,{children:[e.jsx(Fe,{children:"Iniciar nuevo ciclo"}),e.jsx(Ae,{className:"text-gray-600",children:g?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${C} - ${U}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsx(Le,{id:"startDate",type:"date",value:O,onChange:d=>y(d.target.value),max:W(new Date,"yyyy-MM-dd"),min:g?void 0:W(new Date(v),"yyyy-MM-dd"),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),e.jsxs(Ie,{className:"sm:justify-end",children:[e.jsx(ye,{variant:"outline",onClick:j,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(ye,{variant:"primary",onClick:h,className:"bg-pink-600 hover:bg-pink-700 text-white",children:g?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})})},Ye=({cycleData:a,onEdit:j,onTogglePeak:S,currentPeakIsoDate:v,onEditStartDate:O=()=>{}})=>{var f,_;const y=a.records||[],[g,h]=n.useState(null),[C,U]=n.useState({clientX:0,clientY:0}),[d,D]=n.useState(0),T=n.useRef(!1),X=n.useRef(null),p=n.useRef(null),b=a.startDate?J(a.startDate):null,K=pe(new Date),se=n.useMemo(()=>Me(y),[y]),x=28,R=140,u=R+15,M=u*2,w=n.useMemo(()=>{const t=y.reduce((r,i)=>{const l=(i==null?void 0:i.cycleDay)??null;if(l)return Math.max(r,l);if(!b||!(i!=null&&i.isoDate))return r;try{const o=J(i.isoDate),k=me(o,b)+1;return Number.isFinite(k)?Math.max(r,k):r}catch(o){return console.error("Error calculating record day for wheel:",o),r}},0);return Math.max(a.currentDay,t,x)},[a.currentDay,y,b,x]),E=Math.max(w-x,0),c=E>0;n.useEffect(()=>{if(!c){T.current=!0,D(0);return}D(t=>{const r=Math.min(t,E),i=Math.max(0,Math.min(Math.max(a.currentDay-x,0),E)),l=a.currentDay>=r+1&&a.currentDay<=r+x;return T.current?l?r!==t?r:t:i:(T.current=!0,i)})},[c,E,a.currentDay,x]);const G=n.useCallback(t=>Math.max(0,Math.min(t,E)),[E]),F=n.useCallback(t=>{!c||t===0||D(r=>G(r+t))},[G,c]),re=n.useCallback(t=>{if(!c)return;t.preventDefault();const r=Math.abs(t.deltaY)>Math.abs(t.deltaX)?t.deltaY:t.deltaX;r!==0&&F(r>0?1:-1)},[F,c]),ne=n.useCallback(t=>{var r,i;c&&(X.current=((i=(r=t.touches)==null?void 0:r[0])==null?void 0:i.clientX)??null)},[c]),P=n.useCallback(t=>{var l,o;if(!c||X.current===null)return;const r=((o=(l=t.touches)==null?void 0:l[0])==null?void 0:o.clientX)??null;if(r===null)return;const i=r-X.current;Math.abs(i)<24||(F(i<0?1:-1),X.current=r)},[F,c]),ie=n.useCallback(()=>{X.current=null},[]),q=t=>{switch(t){case"red":return{main:"#ef4444",light:"#fee2e2",glow:"rgba(239, 68, 68, 0.3)",border:"none"};case"white":return{main:"#f8fafc",light:"#ffe4e6",glow:"rgba(248, 250, 252, 0.3)"};case"green":return{main:"#22c55e",light:"#22c55e",glow:"rgba(34, 197, 94, 0.3)",border:"none"};case"yellow":return{main:"#facc15",light:"#fef08a",glow:"rgba(250, 204, 21, 0.3)",border:"none"};case"spot":return{main:"#ef4444",light:"#ef4444",glow:"rgba(239, 68, 68, 0.3)",border:"#fee2e2",pattern:"url(#spotting-pattern-dashboard)"};default:return{main:"#d1d5db",light:"#f8fafc",glow:"rgba(209, 213, 219, 0.3)"}}},Z=n.useMemo(()=>y.reduce((t,r)=>{if(!r)return t;const i=Number(r.cycleDay);if(Number.isFinite(i)&&i>0)return t.has(i)||t.set(i,r),t;if(!b||!r.isoDate)return t;try{const l=J(r.isoDate),o=me(l,b)+1;Number.isFinite(o)&&o>0&&!t.has(o)&&t.set(o,{...r,cycleDay:o})}catch(l){console.error("Error mapping record by day for wheel:",l)}return t},new Map),[y,b]),A=(()=>Array.from({length:x},(t,r)=>{const i=d+r+1,l=Z.get(i)??null,o=b?Ne(b,i-1):null,k=o?W(o,"yyyy-MM-dd"):null,N=o?_e(pe(o),K):!1,B=l?{...l,cycleDay:l.cycleDay??i}:null,xe=(r+d)/x*2*Math.PI-Math.PI/2,ke=u+R*Math.cos(xe),je=u+R*Math.sin(xe);let ue=i<=a.currentDay&&B?q(B.fertility_symbol):{main:"#b5b6ba",light:"#c8cacf",glow:"rgba(229, 231, 235, 0.3)"};const ge=i===a.currentDay;ge&&(B?ue={...q(B.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:ue={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const ve=k&&se[k]||null;return{x:ke,y:je,day:i,colors:ue,isActive:i<=a.currentDay,isToday:ge,hasRecord:!!B,record:B,isoDate:k,canShowPlaceholder:!!(!B&&k&&!N),peakStatus:ve}}))(),I=d*360/x,ee=-I*Math.PI/180,V=Math.cos(ee),Y=Math.sin(ee),le=n.useCallback((t,r)=>{const i=t-u,l=r-u;return{x:u+i*V-l*Y,y:u+i*Y+l*V}},[u,V,Y]),oe=2*Math.PI/x,$=-Math.PI/2-oe/2,te=R-18,ae=R+10,ce=u+te*Math.cos($),s=u+te*Math.sin($),z=u+ae*Math.cos($),L=u+ae*Math.sin($);n.useEffect(()=>{c&&h(null)},[d,c]);const de=(t,r)=>{if(r.stopPropagation(),!p.current){h(null);return}const i=p.current.getBoundingClientRect();let l,o;r.touches&&r.touches[0]?(l=r.touches[0].clientX,o=r.touches[0].clientY):(l=r.clientX,o=r.clientY);const k=t.canShowPlaceholder&&t.isoDate?{id:`placeholder-${t.isoDate}`,isoDate:t.isoDate,cycleDay:t.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:t.peakStatus,peak_marker:t.peakStatus==="P"?"peak":null}:null,N=t.record?{...t.record,cycleDay:t.record.cycleDay??t.day,peakStatus:t.peakStatus,peak_marker:t.record.peak_marker??(t.peakStatus==="P"?"peak":null)}:k;if(N&&v&&N.isoDate===v&&(N.peak_marker="peak",N.peakStatus=N.peakStatus||"P"),!N){h(null);return}U({clientX:l-i.left,clientY:o-i.top}),h(N)};return n.useEffect(()=>{if(!g)return;const t=r=>{p.current&&!p.current.contains(r.target)&&h(null)};return document.addEventListener("mousedown",t),document.addEventListener("touchstart",t),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("touchstart",t)}},[g]),e.jsxs("div",{className:"relative flex flex-col flex-1 min-h-full overflow-y-hidden",children:[e.jsxs(m.div,{className:"px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:O,className:"text-sm font-medium text-pink-700 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1.5 inline-flex items-center gap-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white/40",title:"Editar fecha de inicio del ciclo",children:[e.jsx(Xe,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(m.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:[e.jsxs("div",{className:"text-center mb-3 flex-shrink-0",children:[e.jsxs(m.div,{ref:p,className:"relative inline-flex items-center justify-center mb-4",style:{width:M,height:M},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15,delay:.3},onWheel:re,onTouchStart:ne,onTouchMove:P,onTouchEnd:ie,children:[e.jsxs("svg",{className:"w-full h-full",viewBox:`0 0 ${M} ${M}`,onClick:()=>h(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"50%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.0)"}),e.jsx("stop",{offset:"60%",stopColor:"rgba(244,114,182,0.12)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(190,24,93,0.10)"})]})]}),e.jsx("circle",{cx:u,cy:u,r:R-30,fill:"url(#ringGlow)",stroke:"rgba(255,255,255,0.35)",strokeWidth:"0.5"}),c&&e.jsx("line",{x1:ce,y1:s,x2:z,y2:L,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(m.g,{transition:{type:"spring",stiffness:100,damping:22},initial:!1,animate:{rotate:-I},style:{transformOrigin:"center",transformBox:"view-box"},children:A.map((t,r)=>e.jsxs("g",{children:[!(t.isToday&&!t.hasRecord)&&t.isActive&&e.jsx("circle",{cx:t.x+.3,cy:t.y+.3,r:t.isToday?11:10,fill:"rgba(0, 0, 0, 0.2)",opacity:.5}),t.isToday&&e.jsx("circle",{cx:t.x,cy:t.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}}),e.jsx(m.circle,{cx:t.x,cy:t.y,r:t.isToday?11:10,fill:t.colors.pattern||(t.isActive&&t.hasRecord?t.colors.main:"rgba(255,255,255,0.001)"),stroke:t.colors.border==="none"?"none":t.colors.border||"rgba(158,158,158,0.4)",strokeWidth:t.colors.border==="none"?0:t.isToday?1.8:t.colors.border?.6:.8,onClick:i=>de(t,i),initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.2,delay:.1,type:"tween",stiffness:400,damping:25},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.2))",cursor:"pointer"}})]},r))}),A.map((t,r)=>{if(!t.peakStatus)return null;const{x:i,y:l}=le(t.x,t.y),o={key:`peak-${r}`,x:i,y:l+4,textAnchor:"middle",initial:{scale:.2,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.95+r*.02,type:"spring",stiffness:320,damping:22}};return t.peakStatus==="P"?e.jsx(m.text,{...o,fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none",filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))"},children:"✖"}):e.jsx(m.text,{...o,fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:t.peakStatus})})]}),g&&e.jsx("div",{onClick:t=>t.stopPropagation(),children:e.jsx(We,{point:g,position:C,chartWidth:((f=p.current)==null?void 0:f.clientWidth)||0,chartHeight:((_=p.current)==null?void 0:_.clientHeight)||0,onEdit:j,onClose:()=>h(null),onTogglePeak:S,currentPeakIsoDate:v})}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[e.jsxs(m.div,{className:"text-center  backdrop-blur-md rounded-full p-4",initial:{opacity:0,scale:.5},animate:{opacity:1,scale:1},transition:{delay:1,type:"spring",stiffness:200},style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"},children:[e.jsx("span",{className:"text-5xl font-bold text-pink-700 block",children:a.currentDay}),e.jsx("span",{className:"text-800 text-pink-700 font-medium mt-0.5 block",children:"día del ciclo"})]}),e.jsx(m.div,{className:"mt-2 px-2.5 py-1  backdrop-blur-sm rounded-full border border-pink-200",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.3},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.1))"},children:e.jsx("span",{className:"text-md font-medium text-pink-900",children:a.currentDay<=7?"Menstrual":a.currentDay<=14?"Folicular":a.currentDay<=21?"Ovulatoria":"Lútea"})})]})]}),c&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>F(-1),disabled:d===0,children:e.jsx(Ee,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",d+1]}),e.jsx("span",{className:"text-xs text-rose-400",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",Math.min(d+x,w)]})]}),e.jsx("input",{type:"range",min:0,max:E,value:d,onChange:t=>D(G(Number(t.target.value))),className:"w-44 accent-rose-500"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>F(1),disabled:d===E,children:e.jsx(Pe,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0",children:[e.jsxs(m.div,{className:"relative bg-gradient-to-br from-pink-50/90 to-rose-50/90 backdrop-blur-md rounded-3xl p-4 border border-pink-200/30",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.5},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.08))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.7)"},children:[e.jsx("h3",{className:"font-bold mb-4 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Símbolos"}),e.jsx("div",{className:"grid grid-cols-2 gap-2.5",children:[{label:"Menstrual",color:"#ef4444"},{label:"Moco (Fértil)",color:"#f8fafc",stroke:"#c2c6cc"},{label:"Seco (Rel. Infértil)",color:"#22c55e"},{label:"Moco (No fértil)",color:"#facc15",stroke:"#fef08a"},{label:"Spotting",color:"#ef4444",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(t=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[t.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-4 h-4 rounded-full border ${t.pattern?"pattern-bg":""}`,style:{backgroundColor:t.color,borderColor:t.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${t.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:t.label})]},t.label))}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-300/40 to-rose-400/40 rounded-full"})]}),e.jsxs(m.div,{className:"relative bg-gradient-to-br from-pink-50/70 to-rose-50/50 backdrop-blur-md rounded-3xl p-4 border border-pink-200/40",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.6},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.1))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.8)"},children:[e.jsx("h3",{className:"font-bold mb-3 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Cálculo"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"CPM"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"bg-white/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-gray-200/50 shadow-sm",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"Sin datos"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"T-8"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"bg-white/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-gray-200/50 shadow-sm",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"Sin datos"})})]})]}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-500/40 to-rose-400/40 rounded-full"})]})]})]})]})},$e=({onAddRecord:a,onAddCycle:j})=>{const[S,v]=n.useState(!1);return e.jsxs("div",{className:"fixed bottom-[calc(var(--bottom-nav-height)+1rem)] right-6 flex flex-col items-end space-y-3 z-50",children:[S&&e.jsxs(e.Fragment,{children:[e.jsxs(m.button,{onClick:j,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white shadow-lg",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(147, 51, 234, 0.3))"},children:[e.jsx(He,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]}),e.jsxs(m.button,{onClick:a,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(Be,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]})]}),e.jsx(m.button,{onClick:()=>v(!S),className:"w-14 h-14 bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-full shadow-lg flex items-center justify-center",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 6px 16px rgba(236, 72, 153, 0.4))"},children:e.jsx(m.span,{animate:{rotate:S?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(Te,{className:"h-6 w-6"})})})]})},rt=()=>{const{currentCycle:a,addOrUpdateDataPoint:j,startNewCycle:S,isLoading:v,updateCycleDates:O,checkCycleOverlap:y,forceUpdateCycleStart:g,refreshData:h}=ze(),{toast:C}=De(),[U,d]=n.useState(!1),[D,T]=n.useState(()=>(a==null?void 0:a.startDate)||""),[X,p]=n.useState(""),[b,K]=n.useState(null),[se,x]=n.useState(null),[R,Q]=n.useState(!1),[u,M]=n.useState(!1);n.useEffect(()=>{T((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate]);const w=n.useCallback(()=>{K(null),x(null),Q(!1)},[]),E=n.useCallback(()=>{T((a==null?void 0:a.startDate)||""),p(""),w(),d(!0)},[a==null?void 0:a.startDate,w]),c=n.useCallback(()=>{d(!1),p(""),w(),T((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate,w]),G=n.useCallback(()=>{w()},[w]),F=n.useCallback(async()=>{if(!D){p("La fecha de inicio es obligatoria");return}if(a!=null&&a.id){p(""),M(!0);try{const s=y?await y(a.id,D):null;if(s){K(D),x(s),Q(!0),M(!1);return}await O(a.id,D),await h({silent:!0}),C({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),c()}catch(s){console.error("Error updating start date from dashboard:",s),p("No se pudo actualizar la fecha de inicio"),C({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{M(!1)}}},[D,a==null?void 0:a.id,y,O,h,C,c]),re=n.useCallback(async()=>{if(!(a!=null&&a.id)||!b){w();return}M(!0),Q(!1);try{await g(a.id,b),await h({silent:!0}),C({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),c()}catch(s){console.error("Error forcing start date from dashboard:",s),p("No se pudo actualizar la fecha de inicio"),C({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{M(!1),w()}},[a==null?void 0:a.id,b,g,h,C,c,w]),[ne,P]=n.useState(!1),[ie,q]=n.useState(!1),[Z,H]=n.useState(!1),[A,I]=n.useState(null),ee=!!(A&&String(A.id||"").startsWith("placeholder-")),V=n.useMemo(()=>{var z;const s=(z=a==null?void 0:a.data)==null?void 0:z.find(L=>(L==null?void 0:L.peak_marker)==="peak");return(s==null?void 0:s.isoDate)||null},[a==null?void 0:a.data]),Y=n.useCallback(()=>{P(!1),I(null)},[]),le=n.useCallback(s=>{I(s)},[]),oe=n.useCallback(s=>{I(s),P(!0)},[]),$=n.useCallback(async(s,z=!0)=>{if(!(a!=null&&a.id)||!(s!=null&&s.isoDate))return;const L=f=>{if(f==null||f==="")return null;const _=parseFloat(String(f).replace(",","."));return Number.isFinite(_)?_:null},de=z??!(s.peak_marker==="peak"||s.peakStatus==="P");try{const f=s.timestamp?W(J(s.timestamp),"HH:mm"):W(new Date,"HH:mm");let _=Array.isArray(s.measurements)&&s.measurements.length>0?s.measurements:[{temperature:s.temperature_chart??s.temperature_raw??null,temperature_corrected:s.temperature_corrected??null,time:s.time??f,time_corrected:s.time_corrected??f,selected:!0,use_corrected:s.use_corrected??!1}];_.length===0&&(_=[{temperature:null,temperature_corrected:null,time:f,time_corrected:f,selected:!0,use_corrected:!1}]);const t=_.map((l,o)=>{const k=l.time||f,N=l.time_corrected||k;return{temperature:L(l.temperature??l.temperature_raw),time:k,selected:o===0?!0:!!l.selected,temperature_corrected:L(l.temperature_corrected),time_corrected:N,use_corrected:!!l.use_corrected}});t.some(l=>l.selected)||(t[0].selected=!0);const r={isoDate:s.isoDate,measurements:t,mucusSensation:s.mucus_sensation??s.mucusSensation??"",mucusAppearance:s.mucus_appearance??s.mucusAppearance??"",fertility_symbol:s.fertility_symbol??"none",observations:s.observations??"",ignored:s.ignored??!1,peak_marker:de?"peak":null},i=s!=null&&s.id&&!String(s.id).startsWith("placeholder-")?s:null;await j(r,i)}catch(f){console.error("Error toggling peak marker from dashboard:",f)}},[j,a==null?void 0:a.id]);if(v&&!(a!=null&&a.id))return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:e.jsx("p",{className:"text-center text-gray-600 text-lg",children:"Cargando..."})});if(!(a!=null&&a.id))return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br ffrom-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-gray-600 text-lg",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>H(!0),className:"px-6 py-3 rounded-lg bg-pink-600 hover:bg-pink-700 text-white shadow",children:"Iniciar ciclo"})]}),e.jsx(be,{isOpen:Z,onClose:()=>H(!1),onConfirm:async s=>{await S(s),H(!1),P(!0)}})]});const te=me(pe(new Date),J(a.startDate))+1,ae=async(s,{keepFormOpen:z=!1}={})=>{q(!0);try{await j(s,A),z||(P(!1),I(null))}finally{q(!1)}},ce=async s=>{await S(s),H(!1),P(!0)};return e.jsxs("div",{className:"min-h-[calc(100dvh-var(--bottom-nav-safe))] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative overflow-hidden flex flex-col",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"max-w-md mx-auto flex-1 w-full flex flex-col",children:e.jsxs(m.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex-1 flex flex-col",children:[e.jsx(Ye,{cycleData:{...a,currentDay:te,records:a.data},onEdit:oe,onTogglePeak:$,currentPeakIsoDate:V,onEditStartDate:E}),e.jsx(fe,{open:U,onOpenChange:s=>{s||c()},children:e.jsx(he,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Se,{cycle:a,startDate:D,endDate:a.endDate,onStartDateChange:s=>T(s),onSave:F,onCancel:c,isProcessing:u,dateError:X,includeEndDate:!1,showOverlapDialog:R,overlapCycle:se,onConfirmOverlap:re,onCancelOverlap:G,onClearError:()=>p(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",className:"w-full"})})})]})}),e.jsx(fe,{open:ne,onOpenChange:s=>{s?P(!0):Y()},children:e.jsx(he,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Ce,{onSubmit:ae,onCancel:Y,initialData:A,cycleStartDate:a.startDate,cycleEndDate:a.endDate,isProcessing:ie,isEditing:!!A&&!ee,cycleData:a.data,onDateSelect:le})})}),e.jsx($e,{onAddRecord:()=>{I(null),P(!0)},onAddCycle:()=>H(!0)}),e.jsx(be,{isOpen:Z,onClose:()=>H(!1),onConfirm:ce,currentCycleStartDate:a.startDate})]})};export{rt as default};
