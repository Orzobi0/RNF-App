import{c as Aa,h as ts,i as ss,r as s,p as ns,f as Be,j as e,B as ue,d as rs,s as os,e as ls,a as is,b as cs,u as us,g as Me,k as ja,l as Sa,m as Z,n as ds}from"./index-a7b876ee.js";import{L as mt,C as ms,P as fs}from"./CycleDatesEditor-2252eb48.js";import{i as ht,C as Ua,D as ps,c as xs,a as bs}from"./computePeakStatuses-93cb3295.js";import{u as hs,e as ft,P as gs}from"./badge-a7e9b0c3.js";import{D as Ye,a as qe,b as ya,c as va,d as Wa,e as Na,u as ys}from"./useCycleData-3c889a19.js";import{I as Ca}from"./input-4ca4bf6c.js";import{c as vs,u as Ns,C as Cs}from"./useFertilityChart-08cb569a.js";import{L as Pa}from"./label-c685ab7e.js";import"./OverlapWarningDialog-becbd304.js";import"./checkbox-7666851b.js";import"./eye-a5e52431.js";const pt=Aa("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]),ws=Aa("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),xt=Aa("CheckCircle2",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),js=Aa("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]);function Ss(){!ts.current&&ss();const[y]=s.useState(ns.current);return y}const bt=({isOpen:y,onClose:r,onConfirm:P,currentCycleStartDate:T})=>{const[ye,ee]=s.useState(Be(new Date,"yyyy-MM-dd"));hs(y,r);const A=!T,_=()=>{P(ye)},B=A?"":Be(new Date(T),"dd/MM/yyyy"),E=(()=>{if(A)return"";const L=new Date(ye);return L.setDate(L.getDate()-1),Be(L,"dd/MM/yyyy")})();return e.jsx(Ye,{open:y,onOpenChange:r,children:e.jsxs(qe,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(ya,{children:[e.jsx(va,{children:"Iniciar nuevo ciclo"}),e.jsx(Wa,{className:"text-gray-600",children:A?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${B} - ${E}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsx(Ca,{id:"startDate",type:"date",value:ye,onChange:L=>ee(L.target.value),max:Be(new Date,"yyyy-MM-dd"),min:A?void 0:Be(new Date(T),"yyyy-MM-dd"),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),e.jsxs(Na,{className:"sm:justify-end",children:[e.jsx(ue,{variant:"outline",onClick:r,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(ue,{variant:"primary",onClick:_,className:"bg-pink-600 hover:bg-pink-700 text-white",children:A?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})})},ks="metrics",Ds="summary",Va=async(y,r)=>{if(!y||!r||typeof r!="object")throw new Error("A valid userId and data object are required to save metrics.");const P=rs(ls,`users/${y}/${ks}`,Ds);await os(P,r,{merge:!0})},wa=20;function Fs({cycleCount:y,deduction:r}){return typeof r=="number"&&Number.isFinite(r)?r:(typeof y=="number"&&Number.isFinite(y)?y:0)>=12?20:21}function Ms({computedCpmData:y,cpmSelection:r,isManualCpm:P,manualCpmBaseValue:T,manualCpmValue:ye,formatNumber:ee}){var me;const A=typeof((me=y.shortestCycle)==null?void 0:me.duration)=="number"&&Number.isFinite(y.shortestCycle.duration)?y.shortestCycle.duration:null,_=typeof y.value=="number"&&Number.isFinite(y.value)?y.value:null,B=P&&r==="manual",E=r==="auto",L=r==="none",D=B?T:E?A:null,de=B?ye:E?_:null,ie=ee(D,{maximumFractionDigits:0}),O=ee(de,{maximumFractionDigits:2}),ne=`Ciclo más corto: ${ie??"—"}`,Ie=`CPM = ${O??"—"}`;let X="Sin datos disponibles",z=!0;if(typeof de=="number"&&Number.isFinite(de)){if(B)typeof T=="number"&&Number.isFinite(T)?(X=`${ee(T,{maximumFractionDigits:0})??`${T}`} − ${wa}`,z=!1):(X="Valor definido manualmente",z=!0);else if(E&&typeof A=="number"&&Number.isFinite(A)){const je=Fs({cycleCount:y.cycleCount??0,deduction:y.deduction});X=`${ee(A,{maximumFractionDigits:0})??`${A}`} − ${je}`,z=!1}}return(typeof de!="number"||!Number.isFinite(de))&&(X="Sin datos disponibles",z=!0),{title:"CPM",baseText:ne,finalText:Ie,microCopy:X,microCopyMuted:z,modeLabel:L?"Sin usar":B?"Manual":"Auto",microCopyId:"cpm-metric-microcopy",baseValue:D,finalValue:de,baseFormatted:ie,finalFormatted:O,isManual:B}}function Is({computedT8Data:y,t8Selection:r,isManualT8:P,manualT8BaseValue:T,manualT8Value:ye,formatNumber:ee}){var je;const A=typeof((je=y.earliestCycle)==null?void 0:je.riseDay)=="number"&&Number.isFinite(y.earliestCycle.riseDay)?y.earliestCycle.riseDay:null,_=typeof y.value=="number"&&Number.isFinite(y.value)?y.value:null,B=y&&typeof y.canCompute=="boolean"?y.canCompute:!0,E=P&&r==="manual",L=r==="auto"&&B,D=r==="none",de=E?T:L?A:null,ie=E?ye:L?_:null,O=ee(de,{maximumFractionDigits:0}),ne=ee(ie,{maximumFractionDigits:0}),Ie=`Día de subida: ${O??"—"}`,X=`T-8 = ${ne??"—"}`;let z="Sin datos disponibles",re=!0;return typeof ie=="number"&&Number.isFinite(ie)&&(E?typeof T=="number"&&Number.isFinite(T)?(z=`${ee(T,{maximumFractionDigits:0})??`${T}`} − 8`,re=!1):(z="Valor definido manualmente",re=!0):L&&typeof A=="number"&&Number.isFinite(A)&&(z=`${ee(A,{maximumFractionDigits:0})??`${A}`} − 8`,re=!1)),(typeof ie!="number"||!Number.isFinite(ie))&&(z="Sin datos disponibles",re=!0),{title:"T-8",baseText:Ie,finalText:X,microCopy:z,microCopyMuted:re,modeLabel:D?"Sin usar":E?"Manual":"Auto",microCopyId:"t8-metric-microcopy",baseValue:de,finalValue:ie,baseFormatted:O,finalFormatted:ne,isManual:E}}const Ts=({cycleData:y,onEdit:r,onTogglePeak:P,currentPeakIsoDate:T,onEditStartDate:ye=()=>{},handleOpenCpmDialog:ee=()=>{},handleOpenT8Dialog:A=()=>{},cpmMetric:_={},t8Metric:B={}})=>{var Pe,ge;const E=y.records||[],[L,D]=s.useState(null),[de,ie]=s.useState({clientX:0,clientY:0}),[O,ne]=s.useState(0),[Ie,X]=s.useState([]),z=s.useRef(!1),re=s.useRef(null),me=s.useRef(null),je=s.useRef(new Map),Le=s.useRef(null),Te=Ss(),fe=y.startDate?Me(y.startDate):null,We=Sa(new Date),u=s.useMemo(()=>xs(E),[E]);s.useEffect(()=>{const n=je.current,f=new Map,h=[];E.forEach(N=>{if(!N)return;let v=N.cycleDay;if(!v&&fe&&N.isoDate)try{v=ja(Me(N.isoDate),fe)+1}catch{v=null}if(!v)return;const M=JSON.stringify({temp:N.displayTemperature??N.temperature_chart??null,symbol:N.fertility_symbol??null,sensation:N.mucus_sensation??N.mucusSensation??"",appearance:N.mucus_appearance??N.mucusAppearance??"",observations:N.observations??"",relations:N.had_relations??N.hadRelations??!1,updatedAt:N.updatedAt??N.timestamp??null});if(f.set(v,M),n.size>0){const k=n.get(v);(!k||k!==M)&&h.push(v)}}),je.current=f,!Te&&h.length&&X(N=>{const v=new Set(N);return h.forEach(M=>v.add(M)),Array.from(v)})},[fe,Te,E]),s.useEffect(()=>{if(Te||Ie.length===0)return;const n=setTimeout(()=>{X([])},1400);return Le.current=n,()=>{Le.current&&clearTimeout(Le.current)}},[Te,Ie]);const x=28,V=140,K=V+15,ce=K*2,Ee=s.useMemo(()=>{const n=E.reduce((f,h)=>{const N=(h==null?void 0:h.cycleDay)??null;if(N)return Math.max(f,N);if(!fe||!(h!=null&&h.isoDate))return f;try{const v=Me(h.isoDate),M=ja(v,fe)+1;return Number.isFinite(M)?Math.max(f,M):f}catch(v){return console.error("Error calculating record day for wheel:",v),f}},0);return Math.max(y.currentDay,n,x)},[y.currentDay,E,fe,x]),Y=Math.max(Ee-x,0),$=Y>0;s.useEffect(()=>{if(!$){z.current=!0,ne(0);return}ne(n=>{const f=Math.min(n,Y),h=Math.max(0,Math.min(Math.max(y.currentDay-x,0),Y)),N=y.currentDay>=f+1&&y.currentDay<=f+x;return z.current?N?f!==n?f:n:h:(z.current=!0,h)})},[$,Y,y.currentDay,x]);const pe=s.useCallback(n=>Math.max(0,Math.min(n,Y)),[Y]),xe=s.useCallback(n=>{!$||n===0||ne(f=>pe(f+n))},[pe,$]),Se=s.useRef(0),ae=s.useRef(0),be=s.useCallback(n=>{!$||n===0||(ae.current+=n,!Se.current&&(Se.current=requestAnimationFrame(()=>{const f=Math.sign(ae.current);ne(h=>pe(h+f)),ae.current=0,Se.current=0})))},[$,pe]),Ge=s.useCallback(n=>{if(!$)return;n.preventDefault();const f=Math.abs(n.deltaY)>Math.abs(n.deltaX)?n.deltaY:n.deltaX;f!==0&&be(f>0?1:-1)},[xe,$]),U=s.useCallback(n=>{var f,h;$&&(re.current=((h=(f=n.touches)==null?void 0:f[0])==null?void 0:h.clientX)??null)},[$]),he=s.useCallback(n=>{var N,v;if(!$||re.current===null)return;const f=((v=(N=n.touches)==null?void 0:N[0])==null?void 0:v.clientX)??null;if(f===null)return;const h=f-re.current;Math.abs(h)<24||(be(h<0?1:-1),re.current=f)},[xe,$]),q=s.useCallback(()=>{re.current=null},[]),ke=n=>{switch(n){case"red":return{main:"#ef4444",light:"#fee2e2",glow:"rgba(239, 68, 68, 0.3)",border:"none"};case"white":return{main:"#f8fafc",light:"#ffe4e6",glow:"rgba(248, 250, 252, 0.3)",border:"none"};case"green":return{main:"#22c55e",light:"#22c55e",glow:"rgba(34, 197, 94, 0.3)",border:"none"};case"yellow":return{main:"#facc15",light:"#fef08a",glow:"rgba(250, 204, 21, 0.3)",border:"none"};case"spot":return{main:"#ef4444",light:"#ef4444",glow:"rgba(239, 68, 68, 0.3)",border:"#fee2e2",pattern:"url(#spotting-pattern-dashboard)"};default:return{main:"#d1d5db",light:"#f8fafc",glow:"rgba(209, 213, 219, 0.3)",border:"none"}}},W=s.useMemo(()=>E.reduce((n,f)=>{if(!f)return n;const h=Number(f.cycleDay);if(Number.isFinite(h)&&h>0)return n.has(h)||n.set(h,f),n;if(!fe||!f.isoDate)return n;try{const N=Me(f.isoDate),v=ja(N,fe)+1;Number.isFinite(v)&&v>0&&!n.has(v)&&n.set(v,{...f,cycleDay:v})}catch(N){console.error("Error mapping record by day for wheel:",N)}return n},new Map),[E,fe]),te=(()=>Array.from({length:x},(n,f)=>{const h=O+f+1,N=W.get(h)??null,v=fe?ds(fe,h-1):null,M=v?Be(v,"yyyy-MM-dd"):null,k=v?ht(Sa(v),We):!1,se=N?{...N,cycleDay:N.cycleDay??h}:null,R=(f+O)/x*2*Math.PI-Math.PI/2,Ae=K+V*Math.cos(R),oe=K+V*Math.sin(R);let ze=h<=y.currentDay&&se?ke(se.fertility_symbol):{main:"#c1abb6",light:"#c8cacf",glow:"rgba(229, 231, 235, 0.3)"};const J=h===y.currentDay;J&&(se?ze={...ke(se.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:ze={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const Ve=M&&u[M]||null;return{x:Ae,y:oe,day:h,colors:ze,isActive:h<=y.currentDay,isToday:J,hasRecord:!!se,record:se,isoDate:M,canShowPlaceholder:!!(!se&&M&&!k),peakStatus:Ve}}))(),Qe=s.useMemo(()=>new Set(Ie),[Ie]),H=O*360/x,Re=-H*Math.PI/180,Ze=Math.cos(Re),He=Math.sin(Re),Ba=s.useCallback((n,f)=>{const h=n-K,N=f-K;return{x:K+h*Ze-N*He,y:K+h*He+N*Ze}},[K,Ze,He]),Je=2*Math.PI/x,Xe=-Math.PI/2-Je/2,ea=V-18,ka=V+10,da=K+ea*Math.cos(Xe),De=K+ea*Math.sin(Xe),ma=K+ka*Math.cos(Xe),Fe=K+ka*Math.sin(Xe);s.useEffect(()=>{$&&D(null)},[O,$]);const $e=(n,f)=>{if(f.stopPropagation(),!me.current){D(null);return}const h=me.current.getBoundingClientRect();let N,v;f.touches&&f.touches[0]?(N=f.touches[0].clientX,v=f.touches[0].clientY):(N=f.clientX,v=f.clientY);const M=n.canShowPlaceholder&&n.isoDate?{id:`placeholder-${n.isoDate}`,isoDate:n.isoDate,cycleDay:n.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:n.peakStatus,peak_marker:n.peakStatus==="P"?"peak":null}:null,k=n.record?{...n.record,cycleDay:n.record.cycleDay??n.day,peakStatus:n.peakStatus,peak_marker:n.record.peak_marker??(n.peakStatus==="P"?"peak":null)}:M;if(k&&T&&k.isoDate===T&&(k.peak_marker="peak",k.peakStatus=k.peakStatus||"P"),!k){D(null);return}ie({clientX:N-h.left,clientY:v-h.top}),D(k)};return s.useEffect(()=>{if(!L)return;const n=f=>{me.current&&!me.current.contains(f.target)&&D(null)};return document.addEventListener("mousedown",n),document.addEventListener("touchstart",n),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}},[L]),e.jsxs("div",{className:"relative flex flex-1 flex-col overflow-y-hidden",children:[e.jsxs(Z.div,{className:"px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:ye,className:"text-sm font-medium text-pink-700 backdrop-blur-sm rounded-full px-3 py-1.5 inline-flex items-center gap-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white/40",title:"Editar fecha de inicio del ciclo",children:[e.jsx(fs,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(Z.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:[e.jsxs("div",{className:"text-center mb-3 flex-shrink-0",children:[e.jsxs(Z.div,{ref:me,className:"relative inline-flex items-center justify-center mb-4",style:{width:ce,height:ce},initial:{opacity:0},animate:{opacity:1},transition:{duration:.18,ease:"easeOut"},onWheel:Ge,onTouchStart:U,onTouchMove:he,onTouchEnd:q,children:[e.jsxs("svg",{className:"w-full h-full wheel-no-tap",viewBox:`0 0 ${ce} ${ce}`,onClick:()=>D(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"50%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.0)"}),e.jsx("stop",{offset:"60%",stopColor:"rgba(244,114,182,0.12)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(190,24,93,0.10)"})]})]}),e.jsx("filter",{id:"dotShadow",x:"-30%",y:"-30%",width:"160%",height:"160%",colorInterpolationFilters:"sRGB",children:e.jsx("feDropShadow",{dx:"0",dy:"0.8",stdDeviation:"0.8",floodColor:"#000",floodOpacity:"0.22"})}),e.jsx("circle",{cx:K,cy:K,r:V-30,fill:"url(#ringGlow)",stroke:"rgba(255,255,255,0.35)",strokeWidth:"0.5"}),$&&e.jsx("line",{x1:da,y1:De,x2:ma,y2:Fe,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(Z.g,{transition:{type:"tween",duration:.18,ease:[.2,.8,.2,1]},initial:!1,animate:{rotate:-H},style:{transformOrigin:"center",transformBox:"view-box",willChange:"transform"},children:te.map((n,f)=>e.jsxs("g",{children:[e.jsx("g",{filter:n.isActive?"url(#dotShadow)":void 0,children:e.jsx(Z.circle,{cx:n.x,cy:n.y,r:n.isToday?11:10,fill:n.colors.pattern||(n.isActive?n.colors.main:"rgba(255,255,255,0.001)"),stroke:n.colors.border==="none"?"none":n.colors.border||"rgba(158,158,158,0.4)",strokeWidth:n.colors.border==="none"?0:n.isToday?1.8:n.colors.border?.6:.8,onClick:h=>$e(n,h),initial:!1,animate:{scale:1,opacity:1,y:0},transition:{duration:.95,ease:"easeOut"},whileTap:Te?void 0:{y:2,scale:.75,opacity:.95,transition:{duration:.08,ease:"easeOut"}},style:{cursor:"pointer"}})}),!Te&&Qe.has(n.day)&&e.jsxs(Z.g,{pointerEvents:"none",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{transformOrigin:`${n.x}px ${n.y}px`},children:[e.jsx(Z.circle,{cx:n.x,cy:n.y-12,r:4,fill:n.colors.main,initial:{y:-18,scale:.5,opacity:0},animate:{y:[-18,0,2],scale:[.5,1.05,.8],opacity:[0,1,0]},transition:{duration:.6,ease:"easeOut",times:[0,.6,1]}}),e.jsx(Z.circle,{cx:n.x,cy:n.y,r:n.isToday?12:10,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:2,fill:"none",initial:{scale:.5,opacity:.9},animate:{scale:1.4,opacity:0},transition:{duration:.55,ease:[.16,1,.3,1],delay:.05}}),e.jsx(Z.circle,{cx:n.x,cy:n.y,r:n.isToday?14:12,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:1.5,fill:"none",initial:{scale:.6,opacity:.6},animate:{scale:1.9,opacity:0},transition:{duration:.9,ease:"easeOut",delay:.1}})]},`dot-splash-${n.day}`),n.isToday&&e.jsx("circle",{cx:n.x,cy:n.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}})]},f))}),te.map((n,f)=>{if(!n.peakStatus)return null;const{x:h,y:N}=Ba(n.x,n.y);return n.peakStatus==="P"?e.jsx("text",{x:h,y:N+4,textAnchor:"middle",fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none"},children:"✖"}):e.jsx("text",{x:h,y:N+4,textAnchor:"middle",fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:n.peakStatus})})]}),L&&e.jsx("div",{onClick:n=>n.stopPropagation(),children:e.jsx(Cs,{point:L,position:de,chartWidth:((Pe=me.current)==null?void 0:Pe.clientWidth)||0,chartHeight:((ge=me.current)==null?void 0:ge.clientHeight)||0,onEdit:r,onClose:()=>D(null),onTogglePeak:P,currentPeakIsoDate:T})}),e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:e.jsxs(Z.div,{className:"text-center  backdrop-blur-md rounded-full p-4",initial:{opacity:0},animate:{opacity:1},transition:{duration:.2,delay:.2,ease:"easeOut"},style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"},children:[e.jsx("span",{className:"text-5xl font-bold text-pink-700 block",children:y.currentDay}),e.jsx("span",{className:"text-800 text-pink-700 font-medium mt-0.5 block",children:"día del ciclo"})]})})]}),$&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full text-rose-500 shadow-xs transition hover:border hover:border-rose-500/20",onClick:()=>xe(-1),disabled:O===0,children:e.jsx(bs,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",O+1]}),e.jsx("span",{className:"text-xs text-rose-400",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",Math.min(O+x,Ee)]})]}),e.jsx("input",{type:"range",min:0,max:Y,value:O,onChange:n=>ne(pe(Number(n.target.value))),className:"w-40 accent-rose-500"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full text-rose-500 shadow-xs transition hover:border hover:border-rose-500/20",onClick:()=>be(1),disabled:O===Y,children:e.jsx(Ua,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0",children:[e.jsxs(Z.div,{className:"relative bg-gradient-to-br from-pink-50/90 to-rose-50/90 backdrop-blur-md rounded-3xl p-4 border border-pink-200/30",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.5},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.08))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.7)"},children:[e.jsx("h3",{className:"font-bold mb-4 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Símbolos"}),e.jsx("div",{className:"grid grid-cols-2 gap-2.5",children:[{label:"Menstrual",color:"#ef4444"},{label:"Moco (Fértil)",color:"#f8fafc",stroke:"#c2c6cc"},{label:"Seco",color:"#22c55e"},{label:"Moco (No fértil)",color:"#facc15",stroke:"#fef08a"},{label:"Spotting",color:"#ef4444",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(n=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[n.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-4 h-4 rounded-full border ${n.pattern?"pattern-bg":""}`,style:{backgroundColor:n.color,borderColor:n.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${n.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:n.label})]},n.label))}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-300/40 to-rose-400/40 rounded-full"})]}),e.jsxs(Z.div,{className:"relative bg-gradient-to-br from-pink-50/70 to-rose-50/50 backdrop-blur-md rounded-3xl p-3 border border-pink-200/40",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.6},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.1))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.8)"},children:[e.jsx("h3",{className:"font-bold mb-2 text-gray-800 flex items-center gap-2 justify-center text-[11px] tracking-wide uppercase",children:"Cálculo"}),e.jsxs("div",{className:"grid grid-cols-2 gap-y-3",children:[e.jsxs("button",{type:"button",onClick:ee,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (Ciclo más corto)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"Ciclo más corto"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:(_==null?void 0:_.baseFormatted)??"—"})})]}),e.jsxs("button",{type:"button",onClick:ee,className:"flex flex-col items-center gap-0.5","aria-label":"Editar CPM (resultado)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"CPM"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:(_==null?void 0:_.finalFormatted)??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mb-0.5",children:(_==null?void 0:_.modeLabel)??"Auto"})]}),e.jsxs("button",{type:"button",onClick:A,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (Día de subida)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"Día de subida"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:(B==null?void 0:B.baseFormatted)??"—"})})]}),e.jsxs("button",{type:"button",onClick:A,className:"flex flex-col items-center gap-0.5","aria-label":"Editar T-8 (resultado)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"T-8"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:(B==null?void 0:B.finalFormatted)??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:(B==null?void 0:B.modeLabel)??"Auto"})]})]}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-500/40 to-rose-400/40 rounded-full"})]})]})]})]})},Es=({onAddRecord:y,onAddCycle:r})=>{const[P,T]=s.useState(!1);return e.jsxs("div",{className:"fixed right-4 top-12 md:top-6 flex flex-col-reverse items-end space-y-2 z-50",children:[P&&e.jsxs("div",{className:"flex flex-col space-y-2 mt-1",children:[e.jsxs(Z.button,{onClick:y,className:"flex items-center gap-1 px-4 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(js,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]}),e.jsxs(Z.button,{onClick:r,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white shadow-lg",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(147, 51, 234, 0.3))"},children:[e.jsx(ws,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]})]}),e.jsx(Z.button,{onClick:()=>T(!P),className:"w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-full shadow-lg flex items-center justify-center",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 4px 12px rgba(236, 72, 153, 0.35))"},children:e.jsx(Z.span,{animate:{rotate:P?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(gs,{className:"h-5 w-5"})})})]})},Ws=()=>{const y=is(),{currentCycle:r,archivedCycles:P,addOrUpdateDataPoint:T,startNewCycle:ye,isLoading:ee,updateCycleDates:A,checkCycleOverlap:_,forceUpdateCycleStart:B,refreshData:E,setCycleIgnoreForAutoCalculations:L}=ys(),{toast:D}=cs(),[de,ie]=s.useState(!1),[O,ne]=s.useState(()=>(r==null?void 0:r.startDate)||""),[Ie,X]=s.useState(""),[z,re]=s.useState(null),[me,je]=s.useState(null),[Le,Te]=s.useState(!1),[fe,We]=s.useState(!1),{user:u,preferences:x,savePreferences:V}=us(),[Ha,K]=s.useState(!1),[ce,Ee]=s.useState(""),[Y,$]=s.useState(""),[pe,xe]=s.useState(""),[Se,ae]=s.useState(""),[be,Ge]=s.useState(null),[U,he]=s.useState(null),[q,ke]=s.useState(null),[W,Oe]=s.useState(!1),[te,Qe]=s.useState("auto"),[H,Re]=s.useState("auto"),[Ze,He]=s.useState(!1),[Ba,Je]=s.useState(!1),[Xe,ea]=s.useState(!1),[ka,da]=s.useState(!1),[De,ma]=s.useState(""),[Fe,$e]=s.useState(""),[Pe,ge]=s.useState(""),[n,f]=s.useState(""),[h,N]=s.useState(null),[v,M]=s.useState(null),[k,se]=s.useState(null),[R,Ae]=s.useState(!1),[oe,ze]=s.useState("auto"),[J,Ve]=s.useState("auto"),[Ja,Oa]=s.useState(!1),[gt,fa]=s.useState(!1),[Xa,Ra]=s.useState(!1),[Ka,Ya]=s.useState([]),aa=s.useRef(!1),ta=s.useRef(!1),_a=s.useRef(null),qa=s.useRef(!1),Ga=s.useRef(!1),ve=s.useMemo(()=>u!=null&&u.uid?`rnf_manual_cpm_${u.uid}`:null,[u==null?void 0:u.uid]),Ne=s.useMemo(()=>u!=null&&u.uid?`rnf_manual_cpm_base_${u.uid}`:null,[u==null?void 0:u.uid]),Ce=s.useMemo(()=>u!=null&&u.uid?`rnf_manual_t8_${u.uid}`:null,[u==null?void 0:u.uid]),we=s.useMemo(()=>u!=null&&u.uid?`rnf_manual_t8_base_${u.uid}`:null,[u==null?void 0:u.uid]),pa=s.useCallback(async a=>{if(!(!(u!=null&&u.uid)||!V)&&["auto","manual","none"].includes(a))try{await V({cpmMode:a})}catch(t){console.error("Failed to persist CPM mode",t)}},[V,u==null?void 0:u.uid]),xa=s.useCallback(async a=>{if(!(!(u!=null&&u.uid)||!V)&&["auto","manual","none"].includes(a))try{await V({t8Mode:a})}catch(t){console.error("Failed to persist T-8 mode",t)}},[V,u==null?void 0:u.uid]);s.useEffect(()=>{aa.current=!1},[ve]),s.useEffect(()=>{ta.current=!1},[Ce]),s.useEffect(()=>{if(!Ne){he(null);return}const a=x==null?void 0:x.manualCpmBase;if(a!==void 0){if(typeof a=="number"&&Number.isFinite(a)){if(he(a),typeof window<"u")try{localStorage.setItem(Ne,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual CPM base value to local storage",t)}}else if(he(null),typeof window<"u")try{localStorage.removeItem(Ne)}catch(t){console.error("Failed to clear manual CPM base value from local storage",t)}return}if(!(typeof window>"u"))try{const t=localStorage.getItem(Ne);if(t){const o=JSON.parse(t);o&&typeof o.value=="number"&&Number.isFinite(o.value)?he(o.value):he(null)}else he(null)}catch(t){console.error("Failed to restore manual CPM base value from local storage",t)}},[Ne,x==null?void 0:x.manualCpmBase]),s.useEffect(()=>{if(!we){M(null);return}const a=x==null?void 0:x.manualT8Base;if(a!==void 0){if(typeof a=="number"&&Number.isFinite(a)){if(M(a),typeof window<"u")try{localStorage.setItem(we,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual T-8 base value to local storage",t)}}else if(M(null),typeof window<"u")try{localStorage.removeItem(we)}catch(t){console.error("Failed to clear manual T-8 base value from local storage",t)}return}if(!(typeof window>"u"))try{const t=localStorage.getItem(we);if(t){const o=JSON.parse(t);o&&typeof o.value=="number"&&Number.isFinite(o.value)?M(o.value):M(null)}else M(null)}catch(t){console.error("Failed to restore manual T-8 base value from local storage",t)}},[we,x==null?void 0:x.manualT8Base]);const sa=s.useCallback(async({finalValue:a,baseValue:t})=>{if(!(u!=null&&u.uid)||!V)return;const o=a==null?null:Number(a),l=t===void 0?void 0:t==null?null:Number(t),i={manualCpm:o};l!==void 0&&(i.manualCpmBase=l);try{await V(i),ve&&typeof window<"u"&&(i.manualCpm===null?localStorage.removeItem(ve):localStorage.setItem(ve,JSON.stringify({value:i.manualCpm}))),l!==void 0&&Ne&&typeof window<"u"&&(l===null?localStorage.removeItem(Ne):localStorage.setItem(Ne,JSON.stringify({value:l}))),await Va(u.uid,{manual:{cpm:{value:o,base:l===void 0?U:l}},manualUpdatedAt:new Date().toISOString()})}catch(c){throw console.error("Failed to persist manual CPM value in profile",c),c}},[Ne,U,ve,V,u==null?void 0:u.uid]),na=s.useCallback(async({finalValue:a,baseValue:t})=>{if(!(u!=null&&u.uid)||!V)return;const o=a==null?null:Number(a),l=t===void 0?void 0:t==null?null:Number(t),i={manualT8:o};l!==void 0&&(i.manualT8Base=l);try{await V(i),Ce&&typeof window<"u"&&(i.manualT8===null?localStorage.removeItem(Ce):localStorage.setItem(Ce,JSON.stringify({value:i.manualT8}))),l!==void 0&&we&&typeof window<"u"&&(l===null?localStorage.removeItem(we):localStorage.setItem(we,JSON.stringify({value:l}))),await Va(u.uid,{manual:{t8:{value:o,riseDay:l===void 0?v:l}},manualUpdatedAt:new Date().toISOString()})}catch(c){throw console.error("Failed to persist manual T-8 value in profile",c),c}},[we,v,Ce,V,u==null?void 0:u.uid]);s.useEffect(()=>{if(!ve){ke(null),Oe(!1),aa.current=!1;return}const a=x==null?void 0:x.manualCpm;if(typeof a=="number"&&Number.isFinite(a)){if(ke(a),Oe(!0),typeof window<"u")try{localStorage.setItem(ve,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual CPM value to local storage",t)}return}if(a===null&&(ke(null),Oe(!1),typeof window<"u"))try{localStorage.removeItem(ve)}catch(t){console.error("Failed to clear manual CPM value from local storage",t)}},[ve,x==null?void 0:x.manualCpm]),s.useEffect(()=>{if(!Ce){se(null),Ae(!1),ta.current=!1;return}const a=x==null?void 0:x.manualT8;if(typeof a=="number"&&Number.isFinite(a)){if(se(a),Ae(!0),typeof window<"u")try{localStorage.setItem(Ce,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual T-8 value to local storage",t)}return}if(a===null&&(se(null),Ae(!1),typeof window<"u"))try{localStorage.removeItem(Ce)}catch(t){console.error("Failed to clear manual T-8 value from local storage",t)}},[Ce,x==null?void 0:x.manualT8]),s.useEffect(()=>{if(!ve||aa.current||!(u!=null&&u.uid))return;if((x==null?void 0:x.manualCpm)!==void 0){aa.current=!0;return}if(typeof window>"u"){aa.current=!0;return}try{const t=localStorage.getItem(ve);if(t){const o=JSON.parse(t);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){ke(o.value),Oe(!0);let l=U;try{if(Ne){const i=localStorage.getItem(Ne);if(i){const c=JSON.parse(i);c&&typeof c.value=="number"&&Number.isFinite(c.value)?l=c.value:l=null}}}catch(i){console.error("Failed to read manual CPM base value from local storage",i)}he(typeof l=="number"&&Number.isFinite(l)?l:null),sa({finalValue:o.value,baseValue:l}).catch(i=>console.error("Failed to migrate manual CPM value to profile storage",i))}}}catch(t){console.error("Failed to restore manual CPM value from local storage",t)}finally{aa.current=!0}},[Ne,U,ve,sa,x==null?void 0:x.manualCpm,u==null?void 0:u.uid]),s.useEffect(()=>{if(!Ce||ta.current||!(u!=null&&u.uid))return;if((x==null?void 0:x.manualT8)!==void 0){ta.current=!0;return}if(typeof window>"u"){ta.current=!0;return}try{const t=localStorage.getItem(Ce);if(t){const o=JSON.parse(t);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){se(o.value),Ae(!0);let l=v;try{if(we){const i=localStorage.getItem(we);if(i){const c=JSON.parse(i);c&&typeof c.value=="number"&&Number.isFinite(c.value)?l=c.value:l=null}}}catch(i){console.error("Failed to read manual T-8 base value from local storage",i)}M(typeof l=="number"&&Number.isFinite(l)?l:null),na({finalValue:o.value,baseValue:l}).catch(i=>console.error("Failed to migrate manual T-8 value to profile storage",i))}}}catch(t){console.error("Failed to restore manual T-8 value from local storage",t)}finally{ta.current=!0}},[we,v,Ce,na,x==null?void 0:x.manualT8,u==null?void 0:u.uid]),s.useEffect(()=>{ne((r==null?void 0:r.startDate)||"")},[r==null?void 0:r.startDate]);const La=s.useCallback(a=>{if(!(a!=null&&a.startDate))return null;try{const t=Me(a.startDate);if(Number.isNaN(t.getTime()))return null;const o=Be(t,"dd/MM/yyyy",{locale:ft});if(!a.endDate)return`${o} - En curso`;const l=Me(a.endDate);if(Number.isNaN(l.getTime()))return o;const i=Be(l,"dd/MM/yyyy",{locale:ft});return`${o} - ${i}`}catch{return null}},[]),Da=s.useMemo(()=>{const a=[];if(Array.isArray(P)&&P.length>0&&P.forEach((t,o)=>{const l=La(t);a.push({...t,displayName:t.name||l||`Ciclo archivado ${o+1}`,dateRangeLabel:l,source:"archived",ignoredForAutoCalculations:!!t.ignoredForAutoCalculations})}),r!=null&&r.id){const t=La(r);a.push({...r,displayName:r.name||t||"Ciclo actual",dateRangeLabel:t,source:"current",ignoredForAutoCalculations:!!r.ignoredForAutoCalculations})}return a},[P,r,La]),g=s.useMemo(()=>{const o=[...Da.map(m=>{if(!m.startDate||!m.endDate)return null;try{const j=Me(m.startDate),I=Me(m.endDate);if(Number.isNaN(j.getTime())||Number.isNaN(I.getTime())||ht(j,I))return null;const p=ja(Sa(I),Sa(j))+1;return!Number.isFinite(p)||p<=0?null:{...m,duration:p,ignoredForAutoCalculations:!!m.ignoredForAutoCalculations}}catch(j){return console.error("Failed to compute cycle duration for CPM calculation",j),null}}).filter(Boolean)].sort((m,j)=>{const I=typeof m.duration=="number"&&Number.isFinite(m.duration)?m.duration:Number.POSITIVE_INFINITY,p=typeof j.duration=="number"&&Number.isFinite(j.duration)?j.duration:Number.POSITIVE_INFINITY;return I-p}).map(m=>{const j=!!m.ignoredForAutoCalculations;return{...m,isIgnored:j,isIncluded:!j}}),l=o.filter(m=>m.isIncluded),i=o.length-l.length,c=l.length;if(c<6)return{value:null,cycleCount:c,shortestCycle:null,deduction:null,canCompute:!1,cyclesConsidered:o,ignoredCount:i};const d=l[0]??null,w=c>=12?20:21,C=typeof(d==null?void 0:d.duration)=="number"&&Number.isFinite(d.duration)?d.duration-w:null;return{value:C,cycleCount:c,shortestCycle:d,deduction:w,canCompute:C!==null,cyclesConsidered:o,ignoredCount:i}},[Da]),b=s.useMemo(()=>{const a=p=>{if(p==null||p==="")return null;const F=Number.parseFloat(String(p).replace(",","."));return Number.isFinite(F)?F:null},t=p=>{if(!p)return null;const F=a(p.temperature),S=a(p.temperature_corrected);return p.use_corrected&&S!==null?S:F!==null?F:S!==null?S:null},o=p=>{const F=[p==null?void 0:p.temperature_chart,p==null?void 0:p.temperature_raw,p==null?void 0:p.temperature_corrected];for(const S of F){const Q=a(S);if(Q!==null)return Q}if(Array.isArray(p==null?void 0:p.measurements)){const Q=p.measurements.find(le=>le&&le.selected&&t(le)!==null)||p.measurements.find(le=>t(le)!==null);if(Q){const le=t(Q);if(le!==null)return le}}return null},l=p=>{if(!p)return null;try{const F=Me(p);return Number.isNaN(F.getTime())?null:F}catch{return null}},i=Da.filter(p=>p&&p.startDate&&Array.isArray(p.data)&&p.data.length>0).sort((p,F)=>{const S=l(p.startDate),Q=l(F.startDate);return!S&&!Q?0:S?Q?Q-S:-1:1}),c=[],d=[];for(const p of i){const F=p.data.filter(ga=>ga&&ga.isoDate).map(ga=>({...ga,displayTemperature:o(ga)}));if(F.length===0)continue;const{ovulationDetails:S}=vs(F);if(!(S!=null&&S.confirmed))continue;const Q=Number.isInteger(S==null?void 0:S.ovulationIndex)?S.ovulationIndex:Number.isInteger(S==null?void 0:S.confirmationIndex)?S.confirmationIndex:null;if(Q==null||Q<0||Q>=F.length)continue;const le=F[Q],Ea=Number(le==null?void 0:le.cycleDay);if(!Number.isFinite(Ea)||Ea<=0)continue;const as=Math.max(1,Ea-8),$a=!!p.ignoredForAutoCalculations,dt={cycleId:p.id,riseDay:Ea,t8Day:as,displayName:p.displayName||p.name||"Ciclo sin nombre",dateRangeLabel:p.dateRangeLabel,isIgnored:$a,isIncluded:!$a,ignoredForAutoCalculations:$a};c.push(dt),!$a&&d.length<12&&d.push(dt)}const w=d.length,C=c.reduce((p,F)=>p+(F.isIgnored?1:0),0);if(w===0)return{value:null,cycleCount:w,earliestCycle:null,cyclesConsidered:c,canCompute:!1,rawValue:null,ignoredCount:C};const m=d.reduce((p,F)=>F.t8Day<p.t8Day?F:p),j=m.t8Day,I=w>=6;return{value:I?j:null,cycleCount:w,earliestCycle:m,cyclesConsidered:c,canCompute:I,rawValue:j,ignoredCount:C}},[Da]);s.useEffect(()=>{if(qa.current||!x)return;let a=x==null?void 0:x.cpmMode;["auto","manual","none"].includes(a)||(a=W?"manual":g.canCompute?"auto":"none"),Qe(a),Re(a),qa.current=!0},[g.canCompute,W,x]),s.useEffect(()=>{if(Ga.current||!x)return;let a=x==null?void 0:x.t8Mode;["auto","manual","none"].includes(a)||(a=R?"manual":b.canCompute?"auto":"none"),ze(a),Ve(a),Ga.current=!0},[b.canCompute,R,x]),s.useEffect(()=>{var c;if(!(u!=null&&u.uid)){_a.current=null;return}const a=d=>typeof d=="number"&&Number.isFinite(d)?d:null,t=d=>d?{id:d.id??null,name:d.name??null,displayName:d.displayName??null,startDate:d.startDate??null,endDate:d.endDate??null,duration:a(d.duration),source:d.source??null,dateRangeLabel:d.dateRangeLabel??null}:null,o=d=>d?{id:d.id??null,name:d.name??null,displayName:d.displayName??null,startDate:d.startDate??null,endDate:d.endDate??null,riseDay:a(d.riseDay),t8Day:a(d.t8Day),source:d.source??null,dateRangeLabel:d.dateRangeLabel??null}:null,l={automatic:{cpm:{value:a(g==null?void 0:g.value),cycleCount:a(g==null?void 0:g.cycleCount)??0,ignoredCount:a(g==null?void 0:g.ignoredCount)??0,deduction:a(g==null?void 0:g.deduction),canCompute:!!(g!=null&&g.canCompute),shortestCycle:t(g==null?void 0:g.shortestCycle)},t8:{value:a(b==null?void 0:b.value),cycleCount:a(b==null?void 0:b.cycleCount)??0,ignoredCount:a(b==null?void 0:b.ignoredCount)??0,canCompute:!!(b!=null&&b.canCompute),riseDay:a((c=b==null?void 0:b.earliestCycle)==null?void 0:c.riseDay),earliestCycle:o(b==null?void 0:b.earliestCycle)}}},i=JSON.stringify(l);_a.current!==i&&(_a.current=i,Va(u.uid,{...l,automaticUpdatedAt:new Date().toISOString()}).catch(d=>{console.error("Failed to persist automatic metrics snapshot",d)}))},[g,b,u==null?void 0:u.uid]);const G=s.useMemo(()=>{const a=g.cycleCount??0,t=`${a} ciclo${a===1?"":"s"}`,o=6,l=["auto","manual","none"].includes(te)?te:"auto",i=l==="manual"&&W?"Manual":l==="auto"&&g.canCompute?"Automático":l==="none"?"Sin usar":"Automático",c=g.cyclesConsidered??[],d=!!g.canCompute,w=g.ignoredCount??0,C=typeof g.deduction=="number"&&Number.isFinite(g.deduction)?g.deduction:null,m=g.shortestCycle??null,j=typeof g.value=="number"&&Number.isFinite(g.value)?g.value:null;let I;if(a===0)I=w>0?"Todos los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos finalizados con fecha de finalización.";else if(!d)I=`Hay ${t} finalizado${a===1?"":"s"}. Se necesitan ${o} para calcular el CPM automáticamente.`,w>0&&(I+=` (${w} ciclo${w===1?"":"s"} ignorado${w===1?"":"s"}).`);else{const p=(m==null?void 0:m.dateRangeLabel)||(m==null?void 0:m.displayName)||(m==null?void 0:m.name)||"Ciclo sin nombre",F=typeof(m==null?void 0:m.duration)=="number"&&Number.isFinite(m.duration)?`${m.duration} días`:"duración desconocida",S=[`Calculado con ${t}.`,`Ciclo más corto: ${p} (${F}).`];C!==null&&S.push(`Deducción aplicada: ${C} días.`),j!==null&&S.push(`Resultado: ${j} días.`),w>0&&S.push(`${w} ciclo${w===1?"":"s"} ignorado${w===1?"":"s"}.`),I=S.join(" ")}return{sourceLabel:i,summary:I,highlightLabel:t,cycleCount:a,requiredCycles:o,canCompute:d,detailsAvailable:c.length>0,cycles:c,deduction:C,shortestCycle:m,value:j,ignoredCount:w}},[g,te,W]),za=s.useMemo(()=>{var p,F,S,Q;const a=b.cycleCount,t=`${a} ciclo${a===1?"":"s"}`,o=6,l=["auto","manual","none"].includes(oe)?oe:"auto",i=l==="manual"&&R?"Manual":l==="auto"&&b.canCompute?"Automático":l==="none"?"Sin usar":"Automático",c=b.ignoredCount??0,d=((p=b.earliestCycle)==null?void 0:p.displayName)||((F=b.earliestCycle)==null?void 0:F.name)||"Ciclo sin nombre",w=(S=b.earliestCycle)==null?void 0:S.riseDay,C=typeof w=="number"&&Number.isFinite(w)?`Día ${w}`:"día desconocido",m=(Q=b.earliestCycle)==null?void 0:Q.t8Day,j=typeof m=="number"&&Number.isFinite(m)?`T-8 Día ${m}`:null;let I;if(a===0)I=c>0?"Los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos con ovulación confirmada por temperatura.";else if(!b.canCompute)I=`Hay ${t} con ovulación confirmada por temperatura (se necesitan ${o}).`,c>0&&(I+=` ${c} ciclo${c===1?"":"s"} ignorado${c===1?"":"s"}.`);else{const le=[`${d} (${C}${j?` → ${j}`:""}).`];c>0&&le.push(`${c} ciclo${c===1?"":"s"} ignorado${c===1?"":"s"}.`),I=le.join(" ")}return{sourceLabel:i,summary:I,highlightLabel:t,cycleCount:a,requiredCycles:o,ignoredCount:c}},[b,R,oe]),Ue=s.useCallback((a,t)=>typeof a!="number"||!Number.isFinite(a)?null:a.toLocaleString("es-ES",t),[]),yt=s.useMemo(()=>Ms({computedCpmData:g,cpmSelection:te,isManualCpm:W,manualCpmBaseValue:U,manualCpmValue:q,formatNumber:Ue}),[g,te,Ue,W,U,q]),vt=s.useMemo(()=>Is({computedT8Data:b,t8Selection:oe,isManualT8:R,manualT8BaseValue:v,manualT8Value:k,formatNumber:Ue}),[b,Ue,R,v,k,oe]),Nt=Ue(G.value,{maximumFractionDigits:1})??(typeof G.value=="number"&&Number.isFinite(G.value)?`${G.value}`:"—");Ue(q,{maximumFractionDigits:1})??(typeof q=="number"&&Number.isFinite(q)&&`${q}`);const Qa=["auto","manual","none"].includes(te)?te:"auto",Fa=Qa==="manual"?W?"manual":"none":Qa==="auto"&&g.canCompute?"auto":"none",Ct=Fa==="manual"?"Manual":Fa==="auto"?"Automático":"Sin usar",wt=Ue(b.value,{maximumFractionDigits:0})??(typeof b.value=="number"&&Number.isFinite(b.value)?`${b.value}`:"—");Ue(k,{maximumFractionDigits:0})??(typeof k=="number"&&Number.isFinite(k)&&`${k}`);const Za=["auto","manual","none"].includes(oe)?oe:"auto",Ma=Za==="manual"?R?"manual":"none":Za==="auto"&&b.canCompute?"auto":"none",jt=Ma==="manual"?"Manual":Ma==="auto"?"Automático":"Sin usar";s.useMemo(()=>be||(Y.trim()?"final":ce.trim()?"base":null),[ce,be,Y]);const et=s.useMemo(()=>{if(H==="manual"){if(pe||Se)return!0;const a=ce.trim()!==""&&!pe,t=Y.trim()!==""&&!Se;return!a&&!t}return!1},[H,pe,ce,Se,Y]),St=s.useMemo(()=>!!(W||ce.trim()||Y.trim()),[W,ce,Y]);s.useMemo(()=>h||(Fe.trim()?"final":De.trim()?"base":null),[De,h,Fe]);const at=s.useMemo(()=>{if(J==="manual"){if(Pe||n)return!0;const a=De.trim()!==""&&!Pe,t=Fe.trim()!==""&&!n;return!a&&!t}return!1},[Pe,De,n,Fe,J]),kt=s.useMemo(()=>!!(R||De.trim()||Fe.trim()),[R,De,Fe]),tt=s.useCallback(a=>{if(!a)return;const t=a.cycleId||a.id;if(t){if(r!=null&&r.id&&t===r.id){y("/");return}y(`/cycle/${t}`)}},[r==null?void 0:r.id,y]),st=s.useCallback(async(a,t)=>{if(a){Ya(o=>o.includes(a)?o:[...o,a]);try{await L(a,t),D({title:t?"Ciclo ignorado":"Ciclo incluido",description:t?"El ciclo se excluyó del cálculo automático.":"El ciclo se volvió a incluir en el cálculo automático."})}catch{}finally{Ya(o=>o.filter(l=>l!==a))}}},[L,D]),ra=s.useCallback((a,t)=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),t())},[]),Dt=s.useCallback(()=>{var d;const a=typeof((d=g.shortestCycle)==null?void 0:d.duration)=="number"&&Number.isFinite(g.shortestCycle.duration)?g.shortestCycle.duration:null,t=typeof g.value=="number"&&Number.isFinite(g.value)?g.value:null,o=typeof U=="number"&&Number.isFinite(U),l=typeof q=="number"&&Number.isFinite(q),i=W&&o?U:a,c=W&&l?q:t;Ee(typeof i=="number"&&Number.isFinite(i)?String(i):""),$(typeof c=="number"&&Number.isFinite(c)?String(c):""),xe(""),ae(""),Ge(null),Re(te),He(!1),K(!0)},[g,te,W,U,q]),Ia=s.useCallback(()=>{He(!1),Je(!1),ea(!1),K(!1)},[]),Ft=s.useCallback(a=>{const{value:t}=a.target;if(Ee(t),Ge("base"),xe(""),ae(""),!t.trim()){$("");return}const o=Number.parseInt(t,10);if(!Number.isFinite(o)){xe("Introduce un número entero válido."),$("");return}const l=o-wa;if(l<0){xe("El resultado debe ser ≥ 0 días"),$("");return}$(String(l))},[]),Mt=s.useCallback(a=>{const{value:t}=a.target;if($(t),Ge("final"),ae(""),xe(""),!t.trim()){Ee("");return}const o=t.replace(",","."),l=Number.parseFloat(o);if(!Number.isFinite(l)){ae("Introduce un número válido."),Ee("");return}if(l<0){ae("El CPM debe ser ≥ 0"),Ee("");return}const i=l+wa,c=Math.round(i);Ee(String(c))},[]),nt=s.useCallback(async()=>{if(pe||Se)return!1;const a=ce.trim(),t=Y.trim(),o=be??(t?"final":a?"base":null);if(!o)return ae("Introduce un valor."),fasle;let l=U,i;if(o==="base"){if(!a)return xe("Introduce un número entero válido."),!1;const C=Number.parseInt(a,10);if(!Number.isFinite(C))return xe("Introduce un número entero válido."),!1;const m=C-wa;if(m<0)return xe("El resultado debe ser ≥ 0 días"),!1;l=C,i=m,$(String(m)),ae("")}else{if(!t)return ae("Introduce un valor."),!1;const C=t.replace(",","."),m=Number.parseFloat(C);if(!Number.isFinite(m)||m<0)return ae("El CPM debe ser ≥ 0 días"),!1;i=m;const j=Number.parseInt(a,10);Number.isFinite(j)&&j-wa>=0?l=j:a||(l=null)}const c=q,d=W,w=U;ke(i),Oe(!0),he(typeof l=="number"&&Number.isFinite(l)?l:null);try{return await sa({finalValue:i,baseValue:l}),K(!1),D({title:"CPM actualizado",description:"El CPM manual se guardó en tu perfil."}),!0}catch(C){return console.error("Failed to save manual CPM value",C),ke(c),he(w),Oe(d),ae("No se pudo guardar el CPM. Inténtalo de nuevo."),fasle}},[W,pe,ce,U,be,Se,Y,q,sa,D]),rt=s.useCallback(async()=>{const a=q,t=W,o=U;ke(null),he(null),Oe(!1),Ee(""),$(""),xe(""),ae(""),Ge(null);try{await sa({finalValue:null,baseValue:null}),D({title:"CPM borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(l){console.error("Failed to delete manual CPM value",l),ke(a),he(o),Oe(t),ae("No se pudo borrar el CPM. Inténtalo de nuevo.")}},[W,U,q,sa,D]),It=s.useCallback(async()=>{ea(!0);try{await rt(),Je(!1);const a=G.canCompute?"auto":"none";Qe(a),Re(a),await pa(a)}finally{ea(!1)}},[G.canCompute,rt,pa]),oa=s.useCallback(a=>{Re(a)},[]),Tt=s.useCallback(async()=>{const a=H;if(a==="manual"){if(!await nt())return;Qe("manual"),Re("manual"),await pa("manual");return}const t=["auto","none"].includes(a)?a:"auto";Qe(t),Re(t),await pa(t),Ia()},[H,Ia,nt,pa]),Et=s.useCallback(()=>{const a=typeof v=="number"&&Number.isFinite(v),t=typeof k=="number"&&Number.isFinite(k),o=R&&a?v:null,l=R&&t?k:null;ma(typeof o=="number"&&Number.isFinite(o)?String(o):""),$e(typeof l=="number"&&Number.isFinite(l)?String(l):""),ge(""),f(""),N(null),Ve(oe),Oa(!1),da(!0)},[R,v,k,oe]),Ta=s.useCallback(()=>{da(!1),Oa(!1),fa(!1),Ra(!1)},[]),$t=s.useCallback(a=>{const{value:t}=a.target;if(ma(t),N("base"),ge(""),f(""),!t.trim()){$e("");return}const o=Number.parseInt(t,10);if(!Number.isFinite(o)){ge("Introduce un número entero válido."),$e("");return}if(o<9){ge("El T-8 debe ser ≥ 1"),$e("");return}const l=Math.max(1,o-8);$e(String(l))},[]),Pt=s.useCallback(a=>{const{value:t}=a.target;if($e(t),N("final"),f(""),ge(""),!t.trim())return;const o=Number.parseInt(t,10);(!Number.isFinite(o)||o<1)&&f("El T-8 debe ser ≥ 1")},[]),ot=s.useCallback(async()=>{if(Pe||n)return!1;const a=De.trim(),t=Fe.trim(),o=h??(t?"final":a?"base":null);if(!o)return f("Introduce un valor."),!1;let l=v,i;if(o==="base"){if(!a)return ge("Introduce un número entero válido."),!1;const C=Number.parseInt(a,10);if(!Number.isFinite(C))return ge("Introduce un número entero válido."),!1;if(C<9)return ge("El T-8 debe ser ≥ 1"),!1;const m=Math.max(1,C-8);l=C,i=m,$e(String(m)),f("")}else{if(!t)return f("Introduce un valor."),!1;const C=Number.parseInt(t,10);if(!Number.isFinite(C)||C<1)return f("El T-8 debe ser ≥ 1"),!1;i=C;const m=Number.parseInt(a,10);Number.isFinite(m)&&m>=9?l=m:a||(l=null)}const c=k,d=R,w=v;se(i),Ae(!0),M(typeof l=="number"&&Number.isFinite(l)?l:null);try{return await na({finalValue:i,baseValue:l}),da(!1),D({title:"T-8 actualizado",description:"El T-8 manual se guardó en tu perfil."}),!0}catch(C){return console.error("Failed to save manual T-8 value",C),se(c),M(w),Ae(d),f("No se pudo guardar el T-8. Inténtalo de nuevo."),!1}},[R,Pe,De,v,h,n,Fe,k,na,D]),lt=s.useCallback(async()=>{const a=k,t=R,o=v;se(null),M(null),Ae(!1),ma(""),$e(""),ge(""),f(""),N(null);try{await na({finalValue:null,baseValue:null}),D({title:"T-8 borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(l){console.error("Failed to delete manual T-8 value",l),se(a),M(o),Ae(t),ge("No se pudo borrar el T-8. Inténtalo de nuevo.")}},[R,v,k,na,D]),At=s.useCallback(async()=>{Ra(!0);try{await lt(),fa(!1);const a=b.canCompute?"auto":"none";ze(a),Ve(a),await xa(a)}finally{Ra(!1)}},[b.canCompute,lt,xa]),la=s.useCallback(a=>{Ve(a)},[]),Bt=s.useCallback(async()=>{const a=J;if(a==="manual"){if(!await ot())return;ze("manual"),Ve("manual"),await xa("manual");return}const t=["auto","none"].includes(a)?a:"auto";ze(t),Ve(t),await xa(t),Ta()},[Ta,ot,xa,J]),_e=s.useCallback(()=>{re(null),je(null),Te(!1)},[]),Ot=s.useCallback(()=>{ne((r==null?void 0:r.startDate)||""),X(""),_e(),ie(!0)},[r==null?void 0:r.startDate,_e]),ia=s.useCallback(()=>{ie(!1),X(""),_e(),ne((r==null?void 0:r.startDate)||"")},[r==null?void 0:r.startDate,_e]),Rt=s.useCallback(()=>{_e()},[_e]),_t=s.useCallback(async()=>{if(!O){X("La fecha de inicio es obligatoria");return}if(r!=null&&r.id){X(""),We(!0);try{const a=_?await _(r.id,O):null;if(a){re(O),je(a),Te(!0),We(!1);return}await A(r.id,O),await E({silent:!0}),D({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),ia()}catch(a){console.error("Error updating start date from dashboard:",a),X("No se pudo actualizar la fecha de inicio"),D({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{We(!1)}}},[O,r==null?void 0:r.id,_,A,E,D,ia]),Lt=s.useCallback(async()=>{if(!(r!=null&&r.id)||!z){_e();return}We(!0),Te(!1);try{await B(r.id,z),await E({silent:!0}),D({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),ia()}catch(a){console.error("Error forcing start date from dashboard:",a),X("No se pudo actualizar la fecha de inicio"),D({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{We(!1),_e()}},[r==null?void 0:r.id,z,B,E,D,ia,_e]),[zt,Ke]=s.useState(!1),[Vt,it]=s.useState(!1),[ct,ca]=s.useState(!1),[ba,ha]=s.useState(null),[Ut,ua]=s.useState(null),Wt=!!(ba&&String(ba.id||"").startsWith("placeholder-")),Ht=s.useMemo(()=>{var t;const a=(t=r==null?void 0:r.data)==null?void 0:t.find(o=>(o==null?void 0:o.peak_marker)==="peak");return(a==null?void 0:a.isoDate)||null},[r==null?void 0:r.data]),ut=s.useCallback(()=>{Ke(!1),ha(null),ua(null)},[]),Jt=s.useCallback(a=>{ha(a)},[]),Xt=s.useCallback((a,t=null)=>{ha(a),ua(t??null),Ke(!0)},[]),Kt=s.useCallback(async(a,t=!0)=>{if(!(r!=null&&r.id)||!(a!=null&&a.isoDate))return;const o=i=>{if(i==null||i==="")return null;const c=parseFloat(String(i).replace(",","."));return Number.isFinite(c)?c:null},l=t??!(a.peak_marker==="peak"||a.peakStatus==="P");try{const i=a.timestamp?Be(Me(a.timestamp),"HH:mm"):Be(new Date,"HH:mm");let c=Array.isArray(a.measurements)&&a.measurements.length>0?a.measurements:[{temperature:a.temperature_chart??a.temperature_raw??null,temperature_corrected:a.temperature_corrected??null,time:a.time??i,time_corrected:a.time_corrected??i,selected:!0,use_corrected:a.use_corrected??!1}];c.length===0&&(c=[{temperature:null,temperature_corrected:null,time:i,time_corrected:i,selected:!0,use_corrected:!1}]);const d=c.map((m,j)=>{const I=m.time||i,p=m.time_corrected||I;return{temperature:o(m.temperature??m.temperature_raw),time:I,selected:j===0?!0:!!m.selected,temperature_corrected:o(m.temperature_corrected),time_corrected:p,use_corrected:!!m.use_corrected}});d.some(m=>m.selected)||(d[0].selected=!0);const w={isoDate:a.isoDate,measurements:d,mucusSensation:a.mucus_sensation??a.mucusSensation??"",mucusAppearance:a.mucus_appearance??a.mucusAppearance??"",fertility_symbol:a.fertility_symbol??"none",observations:a.observations??"",ignored:a.ignored??!1,peak_marker:l?"peak":null},C=a!=null&&a.id&&!String(a.id).startsWith("placeholder-")?a:null;await T(w,C)}catch(i){console.error("Error toggling peak marker from dashboard:",i)}},[T,r==null?void 0:r.id]);if(ee&&!(r!=null&&r.id))return e.jsx("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:e.jsx("p",{className:"text-center text-gray-600 text-lg",children:"Cargando..."})});if(!(r!=null&&r.id))return e.jsxs("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-gray-600 text-lg",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>ca(!0),className:"px-6 py-3 rounded-lg bg-pink-600 hover:bg-pink-700 text-white shadow",children:"Iniciar ciclo"})]}),e.jsx(bt,{isOpen:ct,onClose:()=>ca(!1),onConfirm:async a=>{await ye(a),ca(!1),ua(null),Ke(!0)}})]});const Yt=ja(Sa(new Date),Me(r.startDate))+1,qt=s.useMemo(()=>{const a=[],t=d=>["auto","manual","none"].includes(d)?d:"auto",o=(d,w,C)=>{const m=Number(w);if(!Number.isFinite(m)||m<=0)return;const j=Number(C),I=Number.isFinite(j)&&j>0,p=I?d==="CPM"?`ciclo base: ${j}`:`base ${d}: ${j}`:null;a.push({source:d,day:Math.max(1,m),reason:p?`Manual desde dashboard (${p})`:"Manual desde dashboard",kind:"calculator",isManual:!0,manualBase:I?j:null})},l=(d,w,C)=>{if(!C)return;const m=Number(w);Number.isFinite(m)&&a.push({source:d,day:Math.max(1,m),reason:"Automático desde dashboard",kind:"calculator"})},i=t(te);i==="manual"?o("CPM",q,U):i==="auto"&&l("CPM",g==null?void 0:g.value,g==null?void 0:g.canCompute);const c=t(oe);return c==="manual"?o("T8",k,v):c==="auto"&&l("T8",b==null?void 0:b.value,b==null?void 0:b.canCompute),a},[g==null?void 0:g.canCompute,g==null?void 0:g.value,b==null?void 0:b.canCompute,b==null?void 0:b.value,te,U,q,v,k,oe]),Gt=s.useMemo(()=>({calculators:{cpm:te!=="none",t8:oe!=="none"}}),[te,oe]),Qt=s.useMemo(()=>{const a=[];return Array.isArray(P)&&P.length>0&&a.push(...P),r&&a.push(r),a},[P,r]);Ns((r==null?void 0:r.data)??[],!1,"portrait",void 0,r==null?void 0:r.id,5,!1,Gt,Qt,qt);const Zt=async(a,{keepFormOpen:t=!1}={})=>{it(!0);try{await T(a,ba),t||(Ke(!1),ha(null),ua(null))}finally{it(!1)}},es=async a=>{await ye(a),ca(!1),ua(null),Ke(!0)};return e.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"max-w-md mx-auto flex w-full flex-1 flex-col",children:e.jsxs(Z.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex flex-1 flex-col",children:[e.jsx(Ts,{cycleData:{...r,currentDay:Yt,records:r.data},onEdit:Xt,onTogglePeak:Kt,currentPeakIsoDate:Ht,onEditStartDate:Ot,handleOpenCpmDialog:Dt,handleOpenT8Dialog:Et,cpmMetric:yt,t8Metric:vt}),e.jsx(Ye,{open:Ha,onOpenChange:a=>{a||Ia()},children:e.jsxs(qe,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col rounded-3xl border border-pink-100 bg-white/95 text-gray-800 shadow-xl overflow-hidden p-0",children:[e.jsxs(ya,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(va,{children:"Editar CPM"}),e.jsx(Wa,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${Fa==="manual"?"bg-rose-100 text-rose-700":Fa==="auto"?"bg-emerald-50 text-emerald-700":"bg-gray-100 text-gray-600"}`,children:Ct})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>oa("auto"),onKeyDown:a=>ra(a,()=>oa("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${H==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-emerald-200"} ${G.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:G.canCompute&&G.value!==null?`CPM automático: ${Nt} días`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${H==="auto"?"border-emerald-400 bg-emerald-400":"border-emerald-300 bg-white"}`,children:H==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>He(a=>!a),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":Ze,children:G.highlightLabel})]}),G.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:G.summary}),!G.detailsAvailable&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."}),Ze&&G.detailsAvailable&&e.jsx("div",{className:"mt-2 space-y-2",children:G.cycles.length>0?e.jsx("ul",{className:"space-y-1",children:G.cycles.map((a,t)=>{const o=a.cycleId||a.id||`${a.displayName||a.name||a.startDate||"cycle"}-${t}`,l=typeof a.duration=="number"&&Number.isFinite(a.duration)?`${a.duration} días`:"duración desconocida",i=!!(G.shortestCycle&&G.shortestCycle===a),c=a.cycleId||a.id,d=!!(a.isIgnored||a.ignoredForAutoCalculations),w=c?Ka.includes(c):!1,C=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${d?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/50"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${C} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>tt(a),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:a.dateRangeLabel||a.displayName||a.name||"Ciclo sin nombre"}),e.jsx(Ua,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Duración: ",l]}),i&&e.jsx("span",{className:"rounded-full bg-rose-100 px-2 py-0.5 font-semibold text-rose-600",children:"Ciclo más corto"})]}),d&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(ue,{type:"button",variant:"outline",size:"xs",disabled:!c||w,onClick:()=>c&&st(c,!d),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:d?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":d?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":d,children:w?e.jsxs(e.Fragment,{children:[e.jsx(mt,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):d?e.jsx(pt,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(xt,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":H==="manual",onClick:()=>oa("manual"),onKeyDown:a=>ra(a,()=>oa("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${H==="manual"?"border-rose-300 bg-rose-50":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${H==="manual"?"border-rose-400 bg-rose-400":"border-rose-300 bg-white"}`,children:H==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Pa,{htmlFor:"manual-cpm-base",className:"text-xs text-gray-600",children:"Ciclo más corto"}),e.jsx(Ca,{id:"manual-cpm-base",type:"number",inputMode:"numeric",step:"1",min:"0",value:ce,onChange:Ft,placeholder:"Introduce un entero","aria-describedby":be?"manual-cpm-helper":void 0}),pe&&e.jsx("p",{className:"text-xs text-red-500",children:pe})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Pa,{htmlFor:"manual-cpm-final",className:"text-xs text-gray-600",children:"CPM obtenido"}),e.jsx(Ca,{id:"manual-cpm-final",type:"number",inputMode:"decimal",step:"0.1",min:"0",value:Y,onChange:Mt,placeholder:"Introduce el valor","aria-describedby":be?"manual-cpm-helper":void 0}),Se&&e.jsx("p",{className:"text-xs text-red-500",children:Se})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:[be&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-cpm-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:be==="base"?"Usando Ciclo más corto como base":"Usando CPM (final)"})}),e.jsx(ue,{type:"button",variant:"outline",onClick:()=>Je(!0),disabled:!St,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"})]}),et&&H==="manual"&&!W&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":H==="none",onClick:()=>oa("none"),onKeyDown:a=>ra(a,()=>oa("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${H==="none"?"border-gray-300 bg-gray-50":"border-dashed border-rose-200 bg-white/70 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${H==="none"?"border-gray-400 bg-gray-400":"border-gray-300 bg-white"}`,children:H==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(Na,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(ue,{type:"button",variant:"secondary",onClick:Ia,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(ue,{type:"button",onClick:Tt,disabled:et,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(Ye,{open:Ba,onOpenChange:Je,children:e.jsxs(qe,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(ya,{children:e.jsx(va,{children:"¿Estás segura de que quieres borrar el valor manual de CPM?"})}),e.jsxs(Na,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(ue,{type:"button",variant:"secondary",onClick:()=>Je(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(ue,{type:"button",variant:"destructive",onClick:It,disabled:Xe,className:"w-full sm:w-auto",children:Xe?"Borrando…":"Borrar"})]})]})}),e.jsx(Ye,{open:ka,onOpenChange:a=>{a||Ta()},children:e.jsxs(qe,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col rounded-3xl border border-pink-100 bg-white/95 text-gray-800 shadow-xl overflow-hidden p-0",children:[e.jsxs(ya,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(va,{children:"Editar T-8"}),e.jsx(Wa,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${Ma==="manual"?"bg-rose-100 text-rose-700":Ma==="auto"?"bg-emerald-50 text-emerald-700":"bg-gray-100 text-gray-600"}`,children:jt})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>la("auto"),onKeyDown:a=>ra(a,()=>la("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${J==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-emerald-200"} ${b.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:b.canCompute&&b.value!==null?`T-8 automático: Día ${wt}`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${J==="auto"?"border-emerald-400 bg-emerald-400":"border-emerald-300 bg-white"}`,children:J==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>Oa(a=>!a),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":Ja,children:za.highlightLabel})]}),za.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:za.summary}),b.cycleCount===0&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."}),Ja&&b.cycleCount>0&&e.jsx("div",{className:"mt-2 space-y-2",children:b.cyclesConsidered.length>0?e.jsx("ul",{className:"space-y-1",children:b.cyclesConsidered.map((a,t)=>{const o=a.cycleId||`${a.displayName}-${a.riseDay}-${t}`,l=typeof a.riseDay=="number"&&Number.isFinite(a.riseDay)?a.riseDay:"—",i=a.cycleId||a.id,c=!!(a.isIgnored||a.ignoredForAutoCalculations),d=i?Ka.includes(i):!1,w=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${c?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/40"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${w} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>tt(a),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:a.dateRangeLabel||a.displayName||a.name||"Ciclo sin nombre"}),e.jsx(Ua,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Día de subida: ",l]}),Number.isFinite(a.t8Day)&&e.jsxs("span",{children:["T-8: Día ",a.t8Day]})]}),c&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(ue,{type:"button",variant:"outline",size:"icon",disabled:!i||d,onClick:()=>i&&st(i,!c),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:c?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":c?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":c,children:d?e.jsxs(e.Fragment,{children:[e.jsx(mt,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):c?e.jsx(pt,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(xt,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":J==="manual",onClick:()=>la("manual"),onKeyDown:a=>ra(a,()=>la("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${J==="manual"?"border-rose-300 bg-rose-50":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${J==="manual"?"border-rose-400 bg-rose-400":"border-rose-300 bg-white"}`,children:J==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Pa,{htmlFor:"manual-t8-base",className:"text-xs text-gray-600",children:"Ciclo con subida (día)"}),e.jsx(Ca,{id:"manual-t8-base",type:"number",inputMode:"numeric",step:"1",min:"9",value:De,onChange:$t,placeholder:"Día de subida","aria-describedby":h?"manual-t8-helper":void 0}),Pe&&e.jsx("p",{className:"text-xs text-red-500",children:Pe})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Pa,{htmlFor:"manual-t8-final",className:"text-xs text-gray-600",children:"T-8 manual (día)"}),e.jsx(Ca,{id:"manual-t8-final",type:"number",inputMode:"numeric",step:"1",min:"1",value:Fe,onChange:Pt,placeholder:"Día del T-8","aria-describedby":h?"manual-t8-helper":void 0}),n&&e.jsx("p",{className:"text-xs text-red-500",children:n})]})]}),e.jsx("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:h&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-t8-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:h==="base"?"Usando día de subida como base":"Usando T-8 manual"})})}),e.jsx(ue,{type:"button",variant:"outline",onClick:()=>fa(!0),disabled:!kt,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"}),at&&J==="manual"&&!R&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":J==="none",onClick:()=>la("none"),onKeyDown:a=>ra(a,()=>la("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${J==="none"?"border-gray-300 bg-gray-50":"border-dashed border-rose-200 bg-white/70 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${J==="none"?"border-gray-400 bg-gray-400":"border-gray-300 bg-white"}`,children:J==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(Na,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(ue,{type:"button",variant:"secondary",onClick:Ta,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(ue,{type:"button",onClick:Bt,disabled:at,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(Ye,{open:gt,onOpenChange:fa,children:e.jsxs(qe,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(ya,{children:e.jsx(va,{children:"¿Estás segura de que quieres borrar el valor manual de T-8?"})}),e.jsxs(Na,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(ue,{type:"button",variant:"secondary",onClick:()=>fa(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(ue,{type:"button",variant:"destructive",onClick:At,disabled:Xa,className:"w-full sm:w-auto",children:Xa?"Borrando…":"Borrar"})]})]})}),e.jsx(Ye,{open:de,onOpenChange:a=>{a||ia()},children:e.jsx(qe,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(ms,{cycle:r,startDate:O,endDate:r.endDate,onStartDateChange:a=>ne(a),onSave:_t,onCancel:ia,isProcessing:fe,dateError:Ie,includeEndDate:!1,showOverlapDialog:Le,overlapCycle:me,onConfirmOverlap:Lt,onCancelOverlap:Rt,onClearError:()=>X(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",className:"w-full"})})})]})}),e.jsx(Ye,{open:zt,onOpenChange:a=>{a?Ke(!0):ut()},children:e.jsx(qe,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(ps,{onSubmit:Zt,onCancel:ut,initialData:ba,cycleStartDate:r.startDate,cycleEndDate:r.endDate,isProcessing:Vt,isEditing:!!ba&&!Wt,cycleData:r.data,onDateSelect:Jt,initialSectionKey:Ut})})}),e.jsx(Es,{onAddRecord:()=>{ha(null),ua(null),Ke(!0)},onAddCycle:()=>ca(!0)}),e.jsx(bt,{isOpen:ct,onClose:()=>ca(!1),onConfirm:es,currentCycleStartDate:r.startDate})]})};export{Ws as default};
