import{c as rt,r as s,f as te,j as e,B as Z,a as Vt,b as Ht,u as Wt,p as ee,d as Ue,s as Oe,m as P,e as Xt}from"./index-9c052d95.js";import{C as Yt,P as Gt}from"./CycleDatesEditor-13f0a133.js";import{i as bt,C as Ze,D as Jt,c as Ut,a as qt}from"./computePeakStatuses-53226450.js";import{u as Kt,e as pt,P as Qt}from"./badge-4d2a43e0.js";import{D as $e,a as Ae,b as et,c as tt,d as at,e as st,u as Zt}from"./useCycleData-5c7fca7c.js";import{I as nt}from"./input-38433acf.js";import{c as ea,C as ta}from"./useFertilityChart-1eac94a6.js";import{L as ft}from"./label-79a0a783.js";import{P as xt}from"./pencil-d686d72a.js";import"./OverlapWarningDialog-691979ea.js";import"./checkbox-33f1ec29.js";import"./eye-2851a226.js";const aa=rt("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),sa=rt("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]),ht=rt("HelpCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),gt=({isOpen:C,onClose:n,onConfirm:B,currentCycleStartDate:L})=>{const[de,Me]=s.useState(te(new Date,"yyyy-MM-dd"));Kt(C,n);const ae=!L,xe=()=>{B(de)},Ne=ae?"":te(new Date(L),"dd/MM/yyyy"),me=(()=>{if(ae)return"";const E=new Date(de);return E.setDate(E.getDate()-1),te(E,"dd/MM/yyyy")})();return e.jsx($e,{open:C,onOpenChange:n,children:e.jsxs(Ae,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(et,{children:[e.jsx(tt,{children:"Iniciar nuevo ciclo"}),e.jsx(at,{className:"text-gray-600",children:ae?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${Ne} - ${me}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsx(nt,{id:"startDate",type:"date",value:de,onChange:E=>Me(E.target.value),max:te(new Date,"yyyy-MM-dd"),min:ae?void 0:te(new Date(L),"yyyy-MM-dd"),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),e.jsxs(st,{className:"sm:justify-end",children:[e.jsx(Z,{variant:"outline",onClick:n,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(Z,{variant:"primary",onClick:xe,className:"bg-pink-600 hover:bg-pink-700 text-white",children:ae?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})})},na=({cycleData:C,onEdit:n,onTogglePeak:B,currentPeakIsoDate:L,onEditStartDate:de=()=>{},formattedCpmValue:Me="-",cpmInfoText:ae="Sin datos",handleOpenCpmDialog:xe=()=>{},formattedT8Value:Ne="-",handleOpenT8Dialog:me=()=>{}})=>{var ie,ce;const E=C.records||[],[D,se]=s.useState(null),[_e,pe]=s.useState({clientX:0,clientY:0}),[A,je]=s.useState(0),H=s.useRef(!1),ne=s.useRef(null),X=s.useRef(null),Y=C.startDate?ee(C.startDate):null,Re=Oe(new Date),qe=s.useMemo(()=>Ut(E),[E]),$=28,fe=140,c=fe+15,y=c*2,re=s.useMemo(()=>{const a=E.reduce((l,u)=>{const h=(u==null?void 0:u.cycleDay)??null;if(h)return Math.max(l,h);if(!Y||!(u!=null&&u.isoDate))return l;try{const N=ee(u.isoDate),R=Ue(N,Y)+1;return Number.isFinite(R)?Math.max(l,R):l}catch(N){return console.error("Error calculating record day for wheel:",N),l}},0);return Math.max(C.currentDay,a,$)},[C.currentDay,E,Y,$]),G=Math.max(re-$,0),M=G>0;s.useEffect(()=>{if(!M){H.current=!0,je(0);return}je(a=>{const l=Math.min(a,G),u=Math.max(0,Math.min(Math.max(C.currentDay-$,0),G)),h=C.currentDay>=l+1&&C.currentDay<=l+$;return H.current?h?l!==a?l:a:u:(H.current=!0,u)})},[M,G,C.currentDay,$]);const he=s.useCallback(a=>Math.max(0,Math.min(a,G)),[G]),J=s.useCallback(a=>{!M||a===0||je(l=>he(l+a))},[he,M]),Le=s.useCallback(a=>{if(!M)return;a.preventDefault();const l=Math.abs(a.deltaY)>Math.abs(a.deltaX)?a.deltaY:a.deltaX;l!==0&&J(l>0?1:-1)},[J,M]),oe=s.useCallback(a=>{var l,u;M&&(ne.current=((u=(l=a.touches)==null?void 0:l[0])==null?void 0:u.clientX)??null)},[M]),U=s.useCallback(a=>{var h,N;if(!M||ne.current===null)return;const l=((N=(h=a.touches)==null?void 0:h[0])==null?void 0:N.clientX)??null;if(l===null)return;const u=l-ne.current;Math.abs(u)<24||(J(u<0?1:-1),ne.current=l)},[J,M]),q=s.useCallback(()=>{ne.current=null},[]),O=a=>{switch(a){case"red":return{main:"#ef4444",light:"#fee2e2",glow:"rgba(239, 68, 68, 0.3)",border:"none"};case"white":return{main:"#f8fafc",light:"#ffe4e6",glow:"rgba(248, 250, 252, 0.3)",border:"none"};case"green":return{main:"#22c55e",light:"#22c55e",glow:"rgba(34, 197, 94, 0.3)",border:"none"};case"yellow":return{main:"#facc15",light:"#fef08a",glow:"rgba(250, 204, 21, 0.3)",border:"none"};case"spot":return{main:"#ef4444",light:"#ef4444",glow:"rgba(239, 68, 68, 0.3)",border:"#fee2e2",pattern:"url(#spotting-pattern-dashboard)"};default:return{main:"#d1d5db",light:"#f8fafc",glow:"rgba(209, 213, 219, 0.3)",border:"none"}}},K=s.useMemo(()=>E.reduce((a,l)=>{if(!l)return a;const u=Number(l.cycleDay);if(Number.isFinite(u)&&u>0)return a.has(u)||a.set(u,l),a;if(!Y||!l.isoDate)return a;try{const h=ee(l.isoDate),N=Ue(h,Y)+1;Number.isFinite(N)&&N>0&&!a.has(N)&&a.set(N,{...l,cycleDay:N})}catch(h){console.error("Error mapping record by day for wheel:",h)}return a},new Map),[E,Y]),Ce=(()=>Array.from({length:$},(a,l)=>{const u=A+l+1,h=K.get(u)??null,N=Y?Xt(Y,u-1):null,R=N?te(N,"yyyy-MM-dd"):null,j=N?bt(Oe(N),Re):!1,k=h?{...h,cycleDay:h.cycleDay??u}:null,Xe=(l+A)/$*2*Math.PI-Math.PI/2,Qe=c+fe*Math.cos(Xe),T=c+fe*Math.sin(Xe);let Te=u<=C.currentDay&&k?O(k.fertility_symbol):{main:"#b5b6ba",light:"#c8cacf",glow:"rgba(229, 231, 235, 0.3)"};const ke=u===C.currentDay;ke&&(k?Te={...O(k.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:Te={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const Ye=R&&qe[R]||null;return{x:Qe,y:T,day:u,colors:Te,isActive:u<=C.currentDay,isToday:ke,hasRecord:!!k,record:k,isoDate:R,canShowPlaceholder:!!(!k&&R&&!j),peakStatus:Ye}}))(),ze=A*360/$,ge=-ze*Math.PI/180,be=Math.cos(ge),ye=Math.sin(ge),Be=s.useCallback((a,l)=>{const u=a-c,h=l-c;return{x:c+u*be-h*ye,y:c+u*ye+h*be}},[c,be,ye]),le=2*Math.PI/$,z=-Math.PI/2-le/2,W=fe-18,_=fe+10,Q=c+W*Math.cos(z),Ve=c+W*Math.sin(z),Ie=c+_*Math.cos(z),He=c+_*Math.sin(z);s.useEffect(()=>{M&&se(null)},[A,M]);const We=(a,l)=>{if(l.stopPropagation(),!X.current){se(null);return}const u=X.current.getBoundingClientRect();let h,N;l.touches&&l.touches[0]?(h=l.touches[0].clientX,N=l.touches[0].clientY):(h=l.clientX,N=l.clientY);const R=a.canShowPlaceholder&&a.isoDate?{id:`placeholder-${a.isoDate}`,isoDate:a.isoDate,cycleDay:a.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:a.peakStatus,peak_marker:a.peakStatus==="P"?"peak":null}:null,j=a.record?{...a.record,cycleDay:a.record.cycleDay??a.day,peakStatus:a.peakStatus,peak_marker:a.record.peak_marker??(a.peakStatus==="P"?"peak":null)}:R;if(j&&L&&j.isoDate===L&&(j.peak_marker="peak",j.peakStatus=j.peakStatus||"P"),!j){se(null);return}pe({clientX:h-u.left,clientY:N-u.top}),se(j)};return s.useEffect(()=>{if(!D)return;const a=l=>{X.current&&!X.current.contains(l.target)&&se(null)};return document.addEventListener("mousedown",a),document.addEventListener("touchstart",a),()=>{document.removeEventListener("mousedown",a),document.removeEventListener("touchstart",a)}},[D]),e.jsxs("div",{className:"relative flex flex-1 flex-col overflow-y-hidden",children:[e.jsxs(P.div,{className:"px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:de,className:"text-sm font-medium text-pink-700 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1.5 inline-flex items-center gap-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white/40",title:"Editar fecha de inicio del ciclo",children:[e.jsx(Gt,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(P.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:[e.jsxs("div",{className:"text-center mb-3 flex-shrink-0",children:[e.jsxs(P.div,{ref:X,className:"relative inline-flex items-center justify-center mb-4",style:{width:y,height:y},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15,delay:.3},onWheel:Le,onTouchStart:oe,onTouchMove:U,onTouchEnd:q,children:[e.jsxs("svg",{className:"w-full h-full",viewBox:`0 0 ${y} ${y}`,onClick:()=>se(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"50%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.0)"}),e.jsx("stop",{offset:"60%",stopColor:"rgba(244,114,182,0.12)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(190,24,93,0.10)"})]})]}),e.jsx("circle",{cx:c,cy:c,r:fe-30,fill:"url(#ringGlow)",stroke:"rgba(255,255,255,0.35)",strokeWidth:"0.5"}),M&&e.jsx("line",{x1:Q,y1:Ve,x2:Ie,y2:He,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(P.g,{transition:{type:"spring",stiffness:100,damping:22},initial:!1,animate:{rotate:-ze},style:{transformOrigin:"center",transformBox:"view-box"},children:Ce.map((a,l)=>e.jsxs("g",{children:[!(a.isToday&&!a.hasRecord)&&a.isActive&&e.jsx("circle",{cx:a.x+.3,cy:a.y+.3,r:a.isToday?11:10,fill:"rgba(0, 0, 0, 0.2)",opacity:1}),a.isToday&&e.jsx("circle",{cx:a.x,cy:a.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}}),e.jsx(P.circle,{cx:a.x,cy:a.y,r:a.isToday?11:10,fill:a.colors.pattern||(a.isActive&&a.hasRecord?a.colors.main:"rgba(255,255,255,0.001)"),stroke:a.colors.border==="none"?"none":a.colors.border||"rgba(158,158,158,0.4)",strokeWidth:a.colors.border==="none"?0:a.isToday?1.8:a.colors.border?.6:.8,onClick:u=>We(a,u),initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.2,delay:.1,type:"tween",stiffness:400,damping:25},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.2))",cursor:"pointer"}})]},l))}),Ce.map((a,l)=>{if(!a.peakStatus)return null;const{x:u,y:h}=Be(a.x,a.y),N={key:`peak-${l}`,x:u,y:h+4,textAnchor:"middle",initial:{scale:.2,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.95+l*.02,type:"spring",stiffness:320,damping:22}};return a.peakStatus==="P"?e.jsx(P.text,{...N,fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none",filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))"},children:"✖"}):e.jsx(P.text,{...N,fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:a.peakStatus})})]}),D&&e.jsx("div",{onClick:a=>a.stopPropagation(),children:e.jsx(ta,{point:D,position:_e,chartWidth:((ie=X.current)==null?void 0:ie.clientWidth)||0,chartHeight:((ce=X.current)==null?void 0:ce.clientHeight)||0,onEdit:n,onClose:()=>se(null),onTogglePeak:B,currentPeakIsoDate:L})}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[e.jsxs(P.div,{className:"text-center  backdrop-blur-md rounded-full p-4",initial:{opacity:0,scale:.5},animate:{opacity:1,scale:1},transition:{delay:1,type:"spring",stiffness:200},style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"},children:[e.jsx("span",{className:"text-5xl font-bold text-pink-700 block",children:C.currentDay}),e.jsx("span",{className:"text-800 text-pink-700 font-medium mt-0.5 block",children:"día del ciclo"})]}),e.jsx(P.div,{className:"mt-2 px-2.5 py-1  backdrop-blur-sm rounded-full border border-pink-200",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.3},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.1))"},children:e.jsx("span",{className:"text-md font-medium text-pink-900",children:C.currentDay<=7?"Menstrual":C.currentDay<=14?"Folicular":C.currentDay<=21?"Ovulatoria":"Lútea"})})]})]}),M&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>J(-1),disabled:A===0,children:e.jsx(qt,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",A+1]}),e.jsx("span",{className:"text-xs text-rose-400",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",Math.min(A+$,re)]})]}),e.jsx("input",{type:"range",min:0,max:G,value:A,onChange:a=>je(he(Number(a.target.value))),className:"w-44 accent-rose-500"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>J(1),disabled:A===G,children:e.jsx(Ze,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0",children:[e.jsxs(P.div,{className:"relative bg-gradient-to-br from-pink-50/90 to-rose-50/90 backdrop-blur-md rounded-3xl p-4 border border-pink-200/30",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.5},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.08))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.7)"},children:[e.jsx("h3",{className:"font-bold mb-4 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Símbolos"}),e.jsx("div",{className:"grid grid-cols-2 gap-2.5",children:[{label:"Menstrual",color:"#ef4444"},{label:"Moco (Fértil)",color:"#f8fafc",stroke:"#c2c6cc"},{label:"Seco (Rel. Infértil)",color:"#22c55e"},{label:"Moco (No fértil)",color:"#facc15",stroke:"#fef08a"},{label:"Spotting",color:"#ef4444",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(a=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[a.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-4 h-4 rounded-full border ${a.pattern?"pattern-bg":""}`,style:{backgroundColor:a.color,borderColor:a.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${a.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:a.label})]},a.label))}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-300/40 to-rose-400/40 rounded-full"})]}),e.jsxs(P.div,{className:"relative bg-gradient-to-br from-pink-50/70 to-rose-50/50 backdrop-blur-md rounded-3xl p-4 border border-pink-200/40",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.6},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.1))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.8)"},children:[e.jsx("h3",{className:"font-bold mb-3 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Cálculo"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"CPM"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"flex w-full items-center justify-center gap-4",children:e.jsxs("button",{type:"button",onClick:xe,className:"group relative flex h-16 w-16 flex-col items-center justify-center rounded-full bg-gradient-to-br from-white via-pink-50/30 to-rose-50/40 text-pink-700 shadow-lg backdrop-blur-xl transition-all duration-300 hover:shadow-xl hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2 focus:ring-offset-transparent border border-pink-200/40",children:[e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-pink-300/0 group-hover:border-pink-300/30 transition-all duration-300 animate-pulse"}),e.jsx(xt,{className:"absolute top-1 right-1 w-2 h-2 text-pink-400/60 group-hover:text-pink-500/80 transition-colors"}),e.jsx("span",{className:"text-lg font-bold group-hover:scale-110 transition-transform duration-200",children:Me})]})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"T-8"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"flex w-full items-center justify-center gap-4",children:e.jsxs("button",{type:"button",onClick:me,className:"group relative flex h-16 w-16 flex-col items-center justify-center rounded-full bg-gradient-to-br from-white via-pink-50/30 to-rose-50/40 text-pink-700 shadow-lg backdrop-blur-xl transition-all duration-300 hover:shadow-xl hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2 focus:ring-offset-transparent border border-pink-200/40",children:[e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-pink-300/0 group-hover:border-pink-300/30 transition-all duration-300 animate-pulse"}),e.jsx(xt,{className:"absolute top-1 right-1 w-2 h-2 text-pink-400/60 group-hover:text-pink-500/80 transition-colors"}),e.jsx("span",{className:"text-lg font-bold group-hover:scale-110 transition-transform duration-200",children:Ne})]})})]})]}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-500/40 to-rose-400/40 rounded-full"})]})]})]})]})},ra=({onAddRecord:C,onAddCycle:n})=>{const[B,L]=s.useState(!1);return e.jsxs("div",{className:"fixed bottom-[calc(var(--bottom-nav-height)+1rem)] right-6 flex flex-col items-end space-y-3 z-50",children:[B&&e.jsxs(e.Fragment,{children:[e.jsxs(P.button,{onClick:n,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white shadow-lg",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(147, 51, 234, 0.3))"},children:[e.jsx(aa,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]}),e.jsxs(P.button,{onClick:C,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(sa,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]})]}),e.jsx(P.button,{onClick:()=>L(!B),className:"w-14 h-14 bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-full shadow-lg flex items-center justify-center",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 6px 16px rgba(236, 72, 153, 0.4))"},children:e.jsx(P.span,{animate:{rotate:B?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(Qt,{className:"h-6 w-6"})})})]})},ba=()=>{const C=Vt(),{currentCycle:n,archivedCycles:B,addOrUpdateDataPoint:L,startNewCycle:de,isLoading:Me,updateCycleDates:ae,checkCycleOverlap:xe,forceUpdateCycleStart:Ne,refreshData:me,setCycleIgnoreForAutoCalculations:E}=Zt(),{toast:D}=Ht(),[se,_e]=s.useState(!1),[pe,A]=s.useState(()=>(n==null?void 0:n.startDate)||""),[je,H]=s.useState(""),[ne,X]=s.useState(null),[Y,Re]=s.useState(null),[qe,$]=s.useState(!1),[fe,we]=s.useState(!1),{user:c,preferences:y,savePreferences:re}=Wt(),[G,M]=s.useState(!1),[he,J]=s.useState(""),[Le,oe]=s.useState(""),[U,q]=s.useState(null),[O,K]=s.useState(!1),[Ke,Ce]=s.useState(!1),[ze,ge]=s.useState(!1),[be,ye]=s.useState(""),[Be,le]=s.useState(""),[z,W]=s.useState(null),[_,Q]=s.useState(!1),[Ve,Ie]=s.useState(!1),[He,We]=s.useState([]),ie=s.useRef(!1),ce=s.useRef(!1),a=s.useMemo(()=>c!=null&&c.uid?`rnf_manual_cpm_${c.uid}`:null,[c==null?void 0:c.uid]),l=s.useMemo(()=>c!=null&&c.uid?`rnf_manual_t8_${c.uid}`:null,[c==null?void 0:c.uid]);s.useEffect(()=>{ie.current=!1},[a]),s.useEffect(()=>{ce.current=!1},[l]);const u=s.useCallback(async t=>{if(!(c!=null&&c.uid)||!re)return;const r=t==null?{manualCpm:null}:{manualCpm:Number(t)};try{await re(r),a&&typeof window<"u"&&(r.manualCpm===null?localStorage.removeItem(a):localStorage.setItem(a,JSON.stringify({value:r.manualCpm})))}catch(o){throw console.error("Failed to persist manual CPM value in profile",o),o}},[a,re,c==null?void 0:c.uid]),h=s.useCallback(async t=>{if(!(c!=null&&c.uid)||!re)return;const r=t==null?{manualT8:null}:{manualT8:Number(t)};try{await re(r),l&&typeof window<"u"&&(r.manualT8===null?localStorage.removeItem(l):localStorage.setItem(l,JSON.stringify({value:r.manualT8})))}catch(o){throw console.error("Failed to persist manual T-8 value in profile",o),o}},[l,re,c==null?void 0:c.uid]);s.useEffect(()=>{if(!a){q(null),K(!1),ie.current=!1;return}const t=y==null?void 0:y.manualCpm;if(typeof t=="number"&&Number.isFinite(t)){if(q(t),K(!0),typeof window<"u")try{localStorage.setItem(a,JSON.stringify({value:t}))}catch(r){console.error("Failed to sync manual CPM value to local storage",r)}return}if(t===null&&(q(null),K(!1),typeof window<"u"))try{localStorage.removeItem(a)}catch(r){console.error("Failed to clear manual CPM value from local storage",r)}},[a,y==null?void 0:y.manualCpm]),s.useEffect(()=>{if(!l){W(null),Q(!1),ce.current=!1;return}const t=y==null?void 0:y.manualT8;if(typeof t=="number"&&Number.isFinite(t)){if(W(t),Q(!0),typeof window<"u")try{localStorage.setItem(l,JSON.stringify({value:t}))}catch(r){console.error("Failed to sync manual T-8 value to local storage",r)}return}if(t===null&&(W(null),Q(!1),typeof window<"u"))try{localStorage.removeItem(l)}catch(r){console.error("Failed to clear manual T-8 value from local storage",r)}},[l,y==null?void 0:y.manualT8]),s.useEffect(()=>{if(!a||ie.current||!(c!=null&&c.uid))return;if((y==null?void 0:y.manualCpm)!==void 0){ie.current=!0;return}if(typeof window>"u"){ie.current=!0;return}try{const r=localStorage.getItem(a);if(r){const o=JSON.parse(r);o&&typeof o.value=="number"&&Number.isFinite(o.value)&&(q(o.value),K(!0),u(o.value).catch(x=>console.error("Failed to migrate manual CPM value to profile storage",x)))}}catch(r){console.error("Failed to restore manual CPM value from local storage",r)}finally{ie.current=!0}},[a,u,y==null?void 0:y.manualCpm,c==null?void 0:c.uid]),s.useEffect(()=>{if(!l||ce.current||!(c!=null&&c.uid))return;if((y==null?void 0:y.manualT8)!==void 0){ce.current=!0;return}if(typeof window>"u"){ce.current=!0;return}try{const r=localStorage.getItem(l);if(r){const o=JSON.parse(r);o&&typeof o.value=="number"&&Number.isFinite(o.value)&&(W(o.value),Q(!0),h(o.value).catch(x=>console.error("Failed to migrate manual T-8 value to profile storage",x)))}}catch(r){console.error("Failed to restore manual T-8 value from local storage",r)}finally{ce.current=!0}},[l,h,y==null?void 0:y.manualT8,c==null?void 0:c.uid]),s.useEffect(()=>{A((n==null?void 0:n.startDate)||"")},[n==null?void 0:n.startDate]);const N=s.useCallback(t=>{if(!(t!=null&&t.startDate))return null;try{const r=ee(t.startDate);if(Number.isNaN(r.getTime()))return null;const o=te(r,"dd/MM/yyyy",{locale:pt});if(!t.endDate)return`${o} - En curso`;const x=ee(t.endDate);if(Number.isNaN(x.getTime()))return o;const d=te(x,"dd/MM/yyyy",{locale:pt});return`${o} - ${d}`}catch{return null}},[]),R=s.useMemo(()=>{const t=[];if(Array.isArray(B)&&B.length>0&&B.forEach((r,o)=>{const x=N(r);t.push({...r,displayName:r.name||x||`Ciclo archivado ${o+1}`,dateRangeLabel:x,source:"archived",ignoredForAutoCalculations:!!r.ignoredForAutoCalculations})}),n!=null&&n.id){const r=N(n);t.push({...n,displayName:n.name||r||"Ciclo actual",dateRangeLabel:r,source:"current",ignoredForAutoCalculations:!!n.ignoredForAutoCalculations})}return t},[B,n,N]),j=s.useMemo(()=>{const o=[...R.map(f=>{if(!f.startDate||!f.endDate)return null;try{const v=ee(f.startDate),F=ee(f.endDate);if(Number.isNaN(v.getTime())||Number.isNaN(F.getTime())||bt(v,F))return null;const i=Ue(Oe(F),Oe(v))+1;return!Number.isFinite(i)||i<=0?null:{...f,duration:i,ignoredForAutoCalculations:!!f.ignoredForAutoCalculations}}catch(v){return console.error("Failed to compute cycle duration for CPM calculation",v),null}}).filter(Boolean)].sort((f,v)=>{const F=typeof f.duration=="number"&&Number.isFinite(f.duration)?f.duration:Number.POSITIVE_INFINITY,i=typeof v.duration=="number"&&Number.isFinite(v.duration)?v.duration:Number.POSITIVE_INFINITY;return F-i}).map(f=>{const v=!!f.ignoredForAutoCalculations;return{...f,isIgnored:v,isIncluded:!v}}),x=o.filter(f=>f.isIncluded),d=o.length-x.length,p=x.length;if(p<6)return{value:null,cycleCount:p,shortestCycle:null,deduction:null,canCompute:!1,cyclesConsidered:o,ignoredCount:d};const m=x[0]??null,S=p>=12?20:21,g=typeof(m==null?void 0:m.duration)=="number"&&Number.isFinite(m.duration)?m.duration-S:null;return{value:g,cycleCount:p,shortestCycle:m,deduction:S,canCompute:g!==null,cyclesConsidered:o,ignoredCount:d}},[R]),k=s.useMemo(()=>{const t=i=>{if(i==null||i==="")return null;const b=Number.parseFloat(String(i).replace(",","."));return Number.isFinite(b)?b:null},r=i=>{if(!i)return null;const b=t(i.temperature),w=t(i.temperature_corrected);return i.use_corrected&&w!==null?w:b!==null?b:w!==null?w:null},o=i=>{const b=[i==null?void 0:i.temperature_chart,i==null?void 0:i.temperature_raw,i==null?void 0:i.temperature_corrected];for(const w of b){const I=t(w);if(I!==null)return I}if(Array.isArray(i==null?void 0:i.measurements)){const I=i.measurements.find(V=>V&&V.selected&&r(V)!==null)||i.measurements.find(V=>r(V)!==null);if(I){const V=r(I);if(V!==null)return V}}return null},x=i=>{if(!i)return null;try{const b=ee(i);return Number.isNaN(b.getTime())?null:b}catch{return null}},d=R.filter(i=>i&&i.startDate&&Array.isArray(i.data)&&i.data.length>0).sort((i,b)=>{const w=x(i.startDate),I=x(b.startDate);return!w&&!I?0:w?I?I-w:-1:1}),p=[],m=[];for(const i of d){const b=i.data.filter(Ee=>Ee&&Ee.isoDate).map(Ee=>({...Ee,displayTemperature:o(Ee)}));if(b.length===0)continue;const{ovulationDetails:w}=ea(b);if(!(w!=null&&w.confirmed))continue;const I=Number.isInteger(w==null?void 0:w.ovulationIndex)?w.ovulationIndex:Number.isInteger(w==null?void 0:w.confirmationIndex)?w.confirmationIndex:null;if(I==null||I<0||I>=b.length)continue;const V=b[I],Ge=Number(V==null?void 0:V.cycleDay);if(!Number.isFinite(Ge)||Ge<=0)continue;const Bt=Math.max(1,Ge-8),Je=!!i.ignoredForAutoCalculations,mt={cycleId:i.id,riseDay:Ge,t8Day:Bt,displayName:i.displayName||i.name||"Ciclo sin nombre",dateRangeLabel:i.dateRangeLabel,isIgnored:Je,isIncluded:!Je,ignoredForAutoCalculations:Je};p.push(mt),!Je&&m.length<12&&m.push(mt)}const S=m.length,g=p.reduce((i,b)=>i+(b.isIgnored?1:0),0);if(S===0)return{value:null,cycleCount:S,earliestCycle:null,cyclesConsidered:p,canCompute:!1,rawValue:null,ignoredCount:g};const f=m.reduce((i,b)=>b.t8Day<i.t8Day?b:i),v=f.t8Day,F=S>=6;return{value:F?v:null,cycleCount:S,earliestCycle:f,cyclesConsidered:p,canCompute:F,rawValue:v,ignoredCount:g}},[R]),Xe=s.useMemo(()=>{const t=O?U:j.value;return typeof t!="number"||!Number.isFinite(t)?"-":t.toLocaleString("es-ES",{maximumFractionDigits:2})},[j.value,O,U]),Qe=s.useMemo(()=>{const t=_?z:k.value;return typeof t!="number"||!Number.isFinite(t)?"-":Math.round(t).toLocaleString("es-ES",{maximumFractionDigits:0})},[k.value,_,z]),T=s.useMemo(()=>{const t=j.cycleCount??0,r=`${t} ciclo${t===1?"":"s"}`,o=6,x=O?"Manual":"Automático",d=j.cyclesConsidered??[],p=!!j.canCompute,m=j.ignoredCount??0,S=typeof j.deduction=="number"&&Number.isFinite(j.deduction)?j.deduction:null,g=j.shortestCycle??null,f=typeof j.value=="number"&&Number.isFinite(j.value)?j.value:null;let v;if(t===0)v=m>0?"Todos los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos finalizados con fecha de finalización.";else if(!p)v=`Hay ${r} finalizado${t===1?"":"s"}. Se necesitan ${o} para calcular el CPM automáticamente.`,m>0&&(v+=` (${m} ciclo${m===1?"":"s"} ignorado${m===1?"":"s"}).`);else{const F=(g==null?void 0:g.dateRangeLabel)||(g==null?void 0:g.displayName)||(g==null?void 0:g.name)||"Ciclo sin nombre",i=typeof(g==null?void 0:g.duration)=="number"&&Number.isFinite(g.duration)?`${g.duration} días`:"duración desconocida",b=[`Calculado con ${r}.`,`Ciclo más corto: ${F} (${i}).`];S!==null&&b.push(`Deducción aplicada: ${S} días.`),f!==null&&b.push(`Resultado: ${f} días.`),m>0&&b.push(`${m} ciclo${m===1?"":"s"} ignorado${m===1?"":"s"}.`),v=b.join(" ")}return{sourceLabel:x,summary:v,highlightLabel:r,cycleCount:t,requiredCycles:o,canCompute:p,detailsAvailable:d.length>0,cycles:d,deduction:S,shortestCycle:g,value:f,ignoredCount:m}},[j,O]),Te=T.summary,ke=s.useMemo(()=>{var F,i,b,w;const t=k.cycleCount,r=`${t} ciclo${t===1?"":"s"}`,o=6,x=_?"Manual":"Automático",d=k.ignoredCount??0,p=((F=k.earliestCycle)==null?void 0:F.displayName)||((i=k.earliestCycle)==null?void 0:i.name)||"Ciclo sin nombre",m=(b=k.earliestCycle)==null?void 0:b.riseDay,S=typeof m=="number"&&Number.isFinite(m)?`Día ${m}`:"día desconocido",g=(w=k.earliestCycle)==null?void 0:w.t8Day,f=typeof g=="number"&&Number.isFinite(g)?`T-8 Día ${g}`:null;let v;if(t===0)v=d>0?"Los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos con ovulación confirmada por temperatura.";else if(!k.canCompute)v=`Hay ${r} con ovulación confirmada por temperatura (se necesitan ${o}).`,d>0&&(v+=` ${d} ciclo${d===1?"":"s"} ignorado${d===1?"":"s"}.`);else{const I=[`${p} (${S}${f?` → ${f}`:""}).`];d>0&&I.push(`${d} ciclo${d===1?"":"s"} ignorado${d===1?"":"s"}.`),v=I.join(" ")}return{sourceLabel:x,summary:v,highlightLabel:r,cycleCount:t,requiredCycles:o,ignoredCount:d}},[k,_]),Ye=s.useCallback(t=>{if(!t)return;const r=t.cycleId||t.id;if(r){if(n!=null&&n.id&&r===n.id){C("/");return}C(`/cycle/${r}`)}},[n==null?void 0:n.id,C]),ot=s.useCallback(async(t,r)=>{if(t){We(o=>o.includes(t)?o:[...o,t]);try{await E(t,r),D({title:r?"Ciclo ignorado":"Ciclo incluido",description:r?"El ciclo se excluyó del cálculo automático.":"El ciclo se volvió a incluir en el cálculo automático."})}catch{}finally{We(o=>o.filter(x=>x!==t))}}},[E,D]),yt=s.useCallback(()=>{const t=O?U:typeof j.value=="number"&&Number.isFinite(j.value)?j.value:"";J(t===""?"":String(t)),oe(""),Ce(!1),M(!0)},[j.value,O,U]),lt=s.useCallback(()=>{Ce(!1),M(!1)},[]),vt=s.useCallback(t=>{J(t.target.value),oe("")},[]),Nt=s.useCallback(async()=>{const t=he.trim();if(!t){oe("Introduce un valor numérico válido.");return}const r=t.replace(",","."),o=Number.parseFloat(r);if(!Number.isFinite(o)||o<0){oe("Introduce un valor numérico válido mayor o igual a 0.");return}const x=U,d=O;q(o),K(!0);try{await u(o),M(!1),D({title:"CPM actualizado",description:"El CPM manual se guardó en tu perfil."})}catch(p){console.error("Failed to save manual CPM value",p),q(x),K(d),oe("No se pudo guardar el CPM. Inténtalo de nuevo.")}},[O,he,U,u,D]),jt=s.useCallback(async()=>{const t=U,r=O;q(null),K(!1),J(""),oe("");try{await u(null),M(!1),D({title:"CPM restablecido",description:"El cálculo automático volverá a mostrarse."})}catch(o){console.error("Failed to reset manual CPM value",o),q(t),K(r),oe("No se pudo restablecer el CPM. Inténtalo de nuevo.")}},[O,U,u,D]),wt=s.useCallback(()=>{const t=_?z:typeof k.value=="number"&&Number.isFinite(k.value)?k.value:"";ye(t===""?"":String(t)),le(""),Ie(!1),ge(!0)},[k.value,_,z]),it=s.useCallback(()=>{ge(!1),Ie(!1)},[]),Ct=s.useCallback(t=>{ye(t.target.value),le("")},[]),kt=s.useCallback(async()=>{const t=be.trim();if(!t){le("Introduce un número entero válido.");return}const r=t.replace(",","."),o=Number.parseInt(r,10);if(!Number.isFinite(o)||o<1){le("Introduce un número entero mayor o igual a 1.");return}const x=z,d=_;W(o),Q(!0);try{await h(o),ge(!1),D({title:"T-8 actualizado",description:"El T-8 manual se guardó en tu perfil."})}catch(p){console.error("Failed to save manual T-8 value",p),W(x),Q(d),le("No se pudo guardar el T-8. Inténtalo de nuevo.")}},[_,be,z,h,D]),Dt=s.useCallback(async()=>{const t=z,r=_;W(null),Q(!1),ye(""),le("");try{await h(null),ge(!1),D({title:"T-8 restablecido",description:"El cálculo automático volverá a mostrarse."})}catch(o){console.error("Failed to reset manual T-8 value",o),W(t),Q(r),le("No se pudo restablecer el T-8. Inténtalo de nuevo.")}},[_,z,h,D]),ue=s.useCallback(()=>{X(null),Re(null),$(!1)},[]),St=s.useCallback(()=>{A((n==null?void 0:n.startDate)||""),H(""),ue(),_e(!0)},[n==null?void 0:n.startDate,ue]),De=s.useCallback(()=>{_e(!1),H(""),ue(),A((n==null?void 0:n.startDate)||"")},[n==null?void 0:n.startDate,ue]),Mt=s.useCallback(()=>{ue()},[ue]),It=s.useCallback(async()=>{if(!pe){H("La fecha de inicio es obligatoria");return}if(n!=null&&n.id){H(""),we(!0);try{const t=xe?await xe(n.id,pe):null;if(t){X(pe),Re(t),$(!0),we(!1);return}await ae(n.id,pe),await me({silent:!0}),D({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),De()}catch(t){console.error("Error updating start date from dashboard:",t),H("No se pudo actualizar la fecha de inicio"),D({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{we(!1)}}},[pe,n==null?void 0:n.id,xe,ae,me,D,De]),Tt=s.useCallback(async()=>{if(!(n!=null&&n.id)||!ne){ue();return}we(!0),$(!1);try{await Ne(n.id,ne),await me({silent:!0}),D({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),De()}catch(t){console.error("Error forcing start date from dashboard:",t),H("No se pudo actualizar la fecha de inicio"),D({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{we(!1),ue()}},[n==null?void 0:n.id,ne,Ne,me,D,De,ue]),[Ft,ve]=s.useState(!1),[Pt,ct]=s.useState(!1),[ut,Se]=s.useState(!1),[Fe,Pe]=s.useState(null),Et=!!(Fe&&String(Fe.id||"").startsWith("placeholder-")),$t=s.useMemo(()=>{var r;const t=(r=n==null?void 0:n.data)==null?void 0:r.find(o=>(o==null?void 0:o.peak_marker)==="peak");return(t==null?void 0:t.isoDate)||null},[n==null?void 0:n.data]),dt=s.useCallback(()=>{ve(!1),Pe(null)},[]),At=s.useCallback(t=>{Pe(t)},[]),Ot=s.useCallback(t=>{Pe(t),ve(!0)},[]),_t=s.useCallback(async(t,r=!0)=>{if(!(n!=null&&n.id)||!(t!=null&&t.isoDate))return;const o=d=>{if(d==null||d==="")return null;const p=parseFloat(String(d).replace(",","."));return Number.isFinite(p)?p:null},x=r??!(t.peak_marker==="peak"||t.peakStatus==="P");try{const d=t.timestamp?te(ee(t.timestamp),"HH:mm"):te(new Date,"HH:mm");let p=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:t.time??d,time_corrected:t.time_corrected??d,selected:!0,use_corrected:t.use_corrected??!1}];p.length===0&&(p=[{temperature:null,temperature_corrected:null,time:d,time_corrected:d,selected:!0,use_corrected:!1}]);const m=p.map((f,v)=>{const F=f.time||d,i=f.time_corrected||F;return{temperature:o(f.temperature??f.temperature_raw),time:F,selected:v===0?!0:!!f.selected,temperature_corrected:o(f.temperature_corrected),time_corrected:i,use_corrected:!!f.use_corrected}});m.some(f=>f.selected)||(m[0].selected=!0);const S={isoDate:t.isoDate,measurements:m,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",ignored:t.ignored??!1,peak_marker:x?"peak":null},g=t!=null&&t.id&&!String(t.id).startsWith("placeholder-")?t:null;await L(S,g)}catch(d){console.error("Error toggling peak marker from dashboard:",d)}},[L,n==null?void 0:n.id]);if(Me&&!(n!=null&&n.id))return e.jsx("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:e.jsx("p",{className:"text-center text-gray-600 text-lg",children:"Cargando..."})});if(!(n!=null&&n.id))return e.jsxs("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br ffrom-rose-100 via-pink-100 to-rose-100",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-gray-600 text-lg",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>Se(!0),className:"px-6 py-3 rounded-lg bg-pink-600 hover:bg-pink-700 text-white shadow",children:"Iniciar ciclo"})]}),e.jsx(gt,{isOpen:ut,onClose:()=>Se(!1),onConfirm:async t=>{await de(t),Se(!1),ve(!0)}})]});const Rt=Ue(Oe(new Date),ee(n.startDate))+1,Lt=async(t,{keepFormOpen:r=!1}={})=>{ct(!0);try{await L(t,Fe),r||(ve(!1),Pe(null))}finally{ct(!1)}},zt=async t=>{await de(t),Se(!1),ve(!0)};return e.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"max-w-md mx-auto flex w-full flex-1 flex-col",children:e.jsxs(P.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex flex-1 flex-col",children:[e.jsx(na,{cycleData:{...n,currentDay:Rt,records:n.data},onEdit:Ot,onTogglePeak:_t,currentPeakIsoDate:$t,onEditStartDate:St,formattedCpmValue:Xe,cpmInfoText:Te,handleOpenCpmDialog:yt,formattedT8Value:Qe,handleOpenT8Dialog:wt}),e.jsx($e,{open:G,onOpenChange:t=>{t||lt()},children:e.jsxs(Ae,{className:"w-[90vw] max-w-sm rounded-3xl border border-pink-100 bg-white/95 text-gray-800 shadow-xl",children:[e.jsxs(et,{className:"space-y-2 text-left",children:[e.jsx(tt,{children:"Editar CPM"}),e.jsx(at,{children:"Personaliza el CPM introduciendo un valor manual. Si no se establece, se calculará automáticamente"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ht,{className:"mt-0.5 h-4 w-4 text-rose-500"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Origen del dato"}),e.jsx("span",{className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600",children:T.sourceLabel})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-1 text-xs text-rose-600",children:[e.jsx("span",{className:"font-semibold",children:"Datos disponibles:"}),T.detailsAvailable?e.jsx("button",{type:"button",onClick:()=>Ce(t=>!t),className:"inline-flex items-center font-semibold text-rose-700 underline decoration-rose-300 underline-offset-2 transition hover:text-rose-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 rounded-sm","aria-expanded":Ke,children:T.highlightLabel}):e.jsx("span",{className:"text-rose-500",children:T.highlightLabel})]}),e.jsx("p",{className:"text-[11px] text-rose-500",children:T.summary}),T.canCompute&&T.deduction!==null&&e.jsxs("p",{className:"text-[11px] text-rose-500",children:["Deducción aplicada: ",T.deduction," días."]})]})]}),Ke&&T.detailsAvailable&&e.jsx("div",{className:"mt-2 space-y-2",children:T.cycles.length>0?e.jsx("ul",{className:"space-y-1",children:T.cycles.map((t,r)=>{const o=t.cycleId||t.id||`${t.displayName||t.name||t.startDate||"cycle"}-${r}`,x=typeof t.duration=="number"&&Number.isFinite(t.duration)?`${t.duration} días`:"duración desconocida",d=!!(T.shortestCycle&&T.shortestCycle===t),p=t.cycleId||t.id,m=!!(t.isIgnored||t.ignoredForAutoCalculations),S=p?He.includes(p):!1,g=S?"Guardando…":m?"Incluir":"Ignorar",f=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${m?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/50"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${f} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>Ye(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(Ze,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Duración: ",x]}),d&&e.jsx("span",{className:"rounded-full bg-rose-100 px-2 py-0.5 font-semibold text-rose-600",children:"Ciclo más corto"})]}),m&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Z,{type:"button",variant:"outline",size:"xs",disabled:!p||S,onClick:()=>p&&ot(p,!m),className:"shrink-0 self-center text-[10px]",title:m?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático",children:g})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ft,{htmlFor:"manual-cpm-input",className:"text-xs text-gray-600",children:"CPM manual"}),e.jsx(nt,{id:"manual-cpm-input",type:"number",inputMode:"decimal",min:"0",step:"0.1",value:he,onChange:vt,placeholder:"Introduce un valor"}),Le&&e.jsx("p",{className:"text-xs text-red-500",children:Le})]})]}),e.jsxs(st,{className:"sm:flex-row sm:items-center sm:justify-between",children:[e.jsx(Z,{type:"button",variant:"ghost",onClick:jt,disabled:!O,className:"text-pink-600 hover:text-pink-700 disabled:text-gray-400",children:"Restablecer automático"}),e.jsxs("div",{className:"flex w-full items-center justify-end gap-2 sm:w-auto",children:[e.jsx(Z,{type:"button",variant:"secondary",onClick:lt,children:"Cancelar"}),e.jsx(Z,{type:"button",onClick:Nt,children:"Guardar"})]})]})]})}),e.jsx($e,{open:ze,onOpenChange:t=>{t||it()},children:e.jsxs(Ae,{className:"w-[90vw] max-w-sm rounded-3xl border border-pink-100 bg-white/95 text-gray-800 shadow-xl",children:[e.jsxs(et,{className:"space-y-2 text-left",children:[e.jsx(tt,{children:"Editar T-8"}),e.jsx(at,{children:"Personaliza el T-8 introduciendo un valor manual. Si no se establece, se calculará automáticamente."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ht,{className:"mt-0.5 h-4 w-4 text-rose-500"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Origen del dato"}),e.jsx("span",{className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600",children:ke.sourceLabel})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-1 text-xs text-rose-600",children:[e.jsx("span",{className:"font-semibold",children:"Datos disponibles:"}),e.jsx("button",{type:"button",onClick:()=>Ie(t=>!t),className:"inline-flex items-center font-semibold text-rose-700 underline decoration-rose-300 underline-offset-2 transition hover:text-rose-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 rounded-sm","aria-expanded":Ve,children:ke.highlightLabel})]}),e.jsx("p",{className:"text-[11px] text-rose-500",children:ke.summary}),Ve&&e.jsx("div",{className:"mt-2 space-y-2",children:k.cyclesConsidered.length>0?e.jsx("ul",{className:"space-y-1",children:k.cyclesConsidered.map((t,r)=>{const o=t.cycleId||`${t.displayName}-${t.riseDay}-${r}`,x=typeof t.riseDay=="number"&&Number.isFinite(t.riseDay)?t.riseDay:"—",d=t.cycleId||t.id,p=!!(t.isIgnored||t.ignoredForAutoCalculations),m=d?He.includes(d):!1,S=m?"Guardando…":p?"Incluir":"Ignorar",g=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${p?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/40"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${g} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>Ye(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(Ze,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Día de subida: ",x]}),Number.isFinite(t.t8Day)&&e.jsxs("span",{children:["T-8: Día ",t.t8Day]})]}),p&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Z,{type:"button",variant:"outline",size:"xs",disabled:!d||m,onClick:()=>d&&ot(d,!p),className:"shrink-0 self-center text-[10px]",title:p?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático",children:S})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."})})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ft,{htmlFor:"manual-t8-input",className:"text-xs text-gray-600",children:"T-8 manual"}),e.jsx(nt,{id:"manual-t8-input",type:"number",inputMode:"numeric",min:"1",step:"1",value:be,onChange:Ct,placeholder:"Introduce un valor"}),Be&&e.jsx("p",{className:"text-xs text-red-500",children:Be})]})]}),e.jsxs(st,{className:"sm:flex-row sm:items-center sm:justify-between",children:[e.jsx(Z,{type:"button",variant:"ghost",onClick:Dt,disabled:!_,className:"text-pink-600 hover:text-pink-700 disabled:text-gray-400",children:"Restablecer automático"}),e.jsxs("div",{className:"flex w-full items-center justify-end gap-2 sm:w-auto",children:[e.jsx(Z,{type:"button",variant:"secondary",onClick:it,children:"Cancelar"}),e.jsx(Z,{type:"button",onClick:kt,children:"Guardar"})]})]})]})}),e.jsx($e,{open:se,onOpenChange:t=>{t||De()},children:e.jsx(Ae,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Yt,{cycle:n,startDate:pe,endDate:n.endDate,onStartDateChange:t=>A(t),onSave:It,onCancel:De,isProcessing:fe,dateError:je,includeEndDate:!1,showOverlapDialog:qe,overlapCycle:Y,onConfirmOverlap:Tt,onCancelOverlap:Mt,onClearError:()=>H(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",className:"w-full"})})})]})}),e.jsx($e,{open:Ft,onOpenChange:t=>{t?ve(!0):dt()},children:e.jsx(Ae,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Jt,{onSubmit:Lt,onCancel:dt,initialData:Fe,cycleStartDate:n.startDate,cycleEndDate:n.endDate,isProcessing:Pt,isEditing:!!Fe&&!Et,cycleData:n.data,onDateSelect:At})})}),e.jsx(ra,{onAddRecord:()=>{Pe(null),ve(!0)},onAddCycle:()=>Se(!0)}),e.jsx(gt,{isOpen:ut,onClose:()=>Se(!1),onConfirm:zt,currentCycleStartDate:n.startDate})]})};export{ba as default};
