import{c as de,r as a,j as e,B as V,k as q,f as o,b as ue,a as xe,m as G,A as he,L as fe,q as me,C as re,t as pe}from"./index-zK-HmiqL.js";import{D as ye,a as ge,b as ve,c as je,d as be,e as Ce,u as Ne}from"./useCycleData-CU56DzlV.js";import{H as we,a as De}from"./HeaderIconButton-DOhbd7H1.js";import{B as ke,l as Ee}from"./badge-Beaezihm.js";import{u as Se,P as le}from"./useBackClose-BVMeEWJ8.js";import{I as ne}from"./input-BYR0bTFe.js";import{O as Ae,D as Me}from"./DeletionDialog-BlIlVKy1.js";const Te=de("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),ee=({isOpen:v,onClose:j,onConfirm:H,initialStartDate:E,initialEndDate:S,includeEndDate:h=!0,title:W="Editar Fechas del Ciclo",description:J,cycleId:$,checkOverlap:A,errorMessage:b,conflictCycle:i,onResetError:p})=>{const[n,C]=a.useState(E||""),[f,M]=a.useState(S||""),[y,d]=a.useState(""),[z,g]=a.useState(null),[N,K]=a.useState(null),[Q,T]=a.useState(!1);Se(v,j),a.useEffect(()=>{C(E||""),M(S||"")},[E,S]);const u=()=>{if(!i)return null;const l=F=>{if(!F)return null;try{return q(o(F),"dd/MM/yyyy")}catch(Z){return console.error("Error formatting conflict date",Z),F}},D=l(i.startDate)??"sin fecha de inicio",X=i.endDate?l(i.endDate):"en curso";return`Conflicto con el ciclo del ${D} al ${X}.`},L=()=>{d(""),p&&p()},w=l=>{C(l),L()},Y=l=>{M(l),d(""),p&&p()},O=u(),I=async()=>{if(h&&!f){d("La fecha de fin es obligatoria");return}if(h&&n&&f&&f<n){d("La fecha de fin no puede ser anterior a la fecha de inicio.");return}const l=h?{startDate:n,endDate:f}:{startDate:n};if(A&&$&&n){const D=await A($,n,h&&f||void 0);if(D){g(D),K(l),T(!0);return}}H(l)};return e.jsxs(e.Fragment,{children:[e.jsx(ye,{open:v,onOpenChange:j,children:e.jsxs(ge,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(ve,{children:[e.jsx(je,{children:W}),e.jsx(be,{className:"text-gray-600",children:J??(h?"Modifica la fecha de inicio y fin del ciclo.":"Modifica la fecha de inicio del ciclo.")})]}),(b||i)&&e.jsxs("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[e.jsx("p",{className:"font-semibold text-red-800",children:"No se pudo guardar el ciclo"}),b&&e.jsx("p",{className:"mt-1",children:b}),O&&e.jsx("p",{className:"mt-1",children:O}),e.jsx("p",{className:"mt-3 text-xs text-red-600",children:"Ajusta las fechas para que no se superpongan con ciclos existentes."})]}),e.jsxs("div",{className:"my-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Inicio del ciclo"}),e.jsx(ne,{id:"startDate",type:"date",value:n,onChange:l=>w(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),h&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"text-gray-700 text-sm",children:"Fin del ciclo"}),e.jsx(ne,{id:"endDate",type:"date",value:f||"",onChange:l=>Y(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"}),y&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:y})]})]}),e.jsxs(Ce,{className:"sm:justify-end",children:[e.jsx(V,{variant:"outline",onClick:j,className:"border-gray-300 text-titulo hover:bg-gray-100",children:"Cancelar"}),e.jsx(V,{variant:"primary",onClick:I,className:"bg-pink-600 hover:bg-pink-700 text-white",children:"Guardar"})]})]})}),e.jsx(Ae,{isOpen:Q,conflictCycle:z,onCancel:()=>T(!1),onConfirm:()=>{T(!1),N&&H({...N,force:!0})}})]})},qe=()=>{const{currentCycle:v,archivedCycles:j,isLoading:H,addArchivedCycle:E,updateCycleDates:S,deleteCycle:h,checkCycleOverlap:W}=Ne(),{toast:J}=ue(),$=xe(),[A,b]=a.useState(!1),[i,p]=a.useState(null),[n,C]=a.useState(null),[f,M]=a.useState(!1),[y,d]=a.useState(null),[z,g]=a.useState(null),[N,K]=a.useState("all"),[Q,T]=a.useState(!1),u=a.useRef(null),L=a.useRef(!1),w=a.useRef(!1),Y=t=>{if(!t)return"Las fechas ingresadas se superponen con otro ciclo.";const s=x=>{if(!x)return null;try{return q(o(x),"dd/MM/yyyy")}catch(m){return console.error("Error parsing conflict date",m),x}},c=s(t.startDate)??"sin fecha de inicio",r=t.endDate?s(t.endDate):"en curso";return`Las fechas ingresadas se superponen con el ciclo del ${c} al ${r}.`},O=()=>{d(null),b(!0)},I=()=>{b(!1),d(null)},l=async({startDate:t,endDate:s})=>{if(t&&s&&o(s)<o(t)){d({message:"La fecha de fin no puede ser anterior a la fecha de inicio.",conflictCycle:null});return}try{await E(t,s),I()}catch(c){const r=c.code==="cycle-overlap"?Y(c.conflictCycle):"No se pudo crear el ciclo.";d({message:r,conflictCycle:c.conflictCycle||null})}},D=async({startDate:t,endDate:s,force:c})=>{if(i)try{const r=i.startDate,x=i.endDate,m=t!==void 0&&t!==r,k=s!==void 0&&s!==x,U=m?t:r,R=k?s:x;if(U&&R&&o(R)<o(U)){g({message:"La fecha de fin no puede ser anterior a la fecha de inicio.",conflictCycle:null});return}await S(i.id,t,s),p(null),g(null)}catch(r){const x=r.code==="cycle-overlap"?Y(r.conflictCycle):"No se pudieron actualizar las fechas.";g({message:x,conflictCycle:r.conflictCycle||null})}},X=t=>{C(t)},F=async()=>{if(n){M(!0);try{await h(n.id),J({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),C(null)}catch(t){console.error("Error deleting archived cycle:",t)}finally{M(!1)}}},Z=t=>{$(t.isCurrent?"/":`/cycle/${t.id}`)},te=t=>{L.current=!1,u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{L.current=!0,X(t)},1500)},P=(t,s=!0)=>{u.current&&(clearTimeout(u.current),u.current=null),!L.current&&s&&Z(t)};a.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]);const B=v.id?[{...v,isCurrent:!0,needsCompletion:!v.endDate},...j]:j,ie=B&&B.length>0;if(H&&!ie)return e.jsx("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:e.jsx("div",{className:"text-center text-slate-600 p-8",children:"Cargando ciclos archivados..."})});if(!B||B.length===0)return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"flex flex-1 items-center justify-center px-4",children:e.jsx(G.div,{className:"text-center text-slate-600 flex flex-col items-center max-w-md",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"bg-white/70 mt-6 backdrop-blur-md rounded-3xl p-8 border border-pink-200/50 shadow-sm",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center",children:e.jsx(he,{className:"w-10 h-10 text-subtitulo"})}),e.jsx("h2",{className:"text-2xl font-semibold text-subtitulo mb-4",children:"No hay ciclos archivados"}),e.jsx("p",{className:"text-subtitulo mb-8",children:"Cuando inicies un nuevo ciclo, el anterior aparecerá aquí."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(V,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl hover:brightness-95 text-white shadow-sm",children:e.jsx(fe,{to:"/",children:"Volver al Ciclo Actual"})}),e.jsxs(V,{onClick:O,className:"bg-fertiliapp-fuerte hover:brightness-95 rounded-3xl text-white shadow-sm",children:[e.jsx(le,{className:"mr-2 h-4 w-4"})," Crear Ciclo"]})]})]})})}),e.jsx(ee,{isOpen:A,onClose:I,onConfirm:l,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:y?.message,conflictCycle:y?.conflictCycle,onResetError:()=>d(null)})]});const _=[...B].sort((t,s)=>o(s.startDate)-o(t.startDate)),oe=Array.from(new Set(_.map(t=>{try{return o(t.startDate).getFullYear()}catch(s){return console.error("Error parsing startDate for year filter",s),null}}).filter(Boolean))).sort((t,s)=>s-t),se=N==="all"?_:_.filter(t=>{try{return o(t.startDate).getFullYear()===Number(N)}catch(s){return console.error("Error filtering cycle by year",s),!1}});return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[e.jsx("div",{className:"relative z-10 flex flex-1",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 py-6 flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col",children:[e.jsx(G.div,{className:"mb-4",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/80 p-3 shadow-sm backdrop-blur-md",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[e.jsx("div",{className:"flex min-w-0 items-center gap-2",children:e.jsx("span",{className:"truncate text-[21px] font-semibold leading-tight text-titulo",children:"Mis ciclos"})}),e.jsx("div",{className:"truncate text-[13px] text-base",children:"Historial de ciclos"})]}),e.jsxs("div",{className:"flex shrink-0 items-center gap-2",children:[e.jsxs(we,{type:"button",onClick:O,"aria-label":"Añadir ciclo",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Añadir ciclo"})]}),e.jsx(De,{type:"button",onClick:()=>T(t=>!t),"aria-label":"Filtrar por año",children:e.jsx(Te,{className:"h-5 w-5"})})]})]})})}),Q&&e.jsx("div",{className:"mb-4 flex w-full justify-center",children:e.jsxs("div",{className:"flex w-full max-w-md items-center gap-2 rounded-3xl border border-fertiliapp-suave bg-white/90 px-3 py-2 shadow-sm",children:[e.jsx("span",{className:"text-xs font-medium text-slate-700",children:"Año"}),e.jsxs("select",{id:"year-filter",value:N,onChange:t=>K(t.target.value),className:"flex-1 rounded-3xl border border-pink-100 bg-white px-3 py-2 text-sm text-slate-700 shadow-inner focus:outline-none focus:ring-2 focus:ring-fertiliapp",children:[e.jsx("option",{value:"all",children:"Todos"}),oe.map(t=>e.jsx("option",{value:t,children:t},t))]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-1 sm:pr-0 pb-6",children:e.jsxs(G.div,{className:"space-y-3 px-1",variants:{hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"show",children:[se.map(t=>{const s=ce=>q(ce,"dd MMM yy",{locale:Ee}),c=t.startDate?o(t.startDate):null,r=t.endDate?o(t.endDate):null,x=!!r,m=c&&r&&r<c?r:c,k=c&&r&&r<c?c:r,U=x&&k?s(k):"En curso",R=t.data?t.data.length:0,ae=m&&k?Math.max(1,me(k,m)+1):null;return e.jsx(G.button,{type:"button",className:"w-full max-w-[480px] mx-auto bg-white/80 backdrop-blur-md border border-fertiliapp-suave shadow-md hover:shadow-sm transition-all duration-300 hover:bg-white/90 rounded-3xl active:scale-[0.98] cursor-pointer select-none",variants:{hidden:{opacity:0,y:20},show:{opacity:1,y:0}},onMouseDown:()=>te(t),onMouseUp:()=>P(t),onMouseLeave:()=>P(t,!1),onTouchStart:()=>{w.current=!1,te(t)},onTouchMove:()=>{w.current=!0,P(t,!1)},onTouchEnd:()=>{w.current?(w.current=!1,P(t,!1)):P(t,!0)},children:e.jsx("div",{className:"p-2.5",children:e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"w-10 h-10 bg-fertiliapp-fuerte rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(re,{className:"w-5 h-5 text-white"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsxs("h2",{className:"truncate text-[15px] font-semibold text-slate-700",children:[m?s(m):""," - ",U]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 text-[12px] text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(pe,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[R," registro",R!==1?"s":""]})]}),t.endDate&&ae&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(re,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[ae," días"]})]}),t.isCurrent&&e.jsx(ke,{className:"rounded-full bg-fertiliapp-fuerte px-2 py-0.5 text-[11px] text-white",children:"Ciclo actual"})]})]})]})})},t.id)}),se.length===0&&e.jsx("div",{className:"mt-6 rounded-3xl border border-dashed border-fertiliapp-suave bg-white/70 p-6 text-center text-slate-600 shadow-inner",children:"No hay ciclos para el año seleccionado."})]})})]})}),e.jsx(ee,{isOpen:A,onClose:I,onConfirm:l,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:y?.message,conflictCycle:y?.conflictCycle,onResetError:()=>d(null)}),e.jsx(ee,{isOpen:!!i,onClose:()=>{p(null),g(null)},onConfirm:D,initialStartDate:i?.startDate,initialEndDate:i?.endDate,cycleId:i?.id,checkOverlap:W,title:"Editar Fechas del Ciclo",description:"Actualiza las fechas del ciclo.",errorMessage:z?.message,conflictCycle:z?.conflictCycle,onResetError:()=>g(null)}),e.jsx(Me,{isOpen:!!n,onClose:()=>C(null),onConfirm:F,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:n?`¿Estás seguro de que quieres eliminar el ciclo ${q(o(n.startDate),"dd/MM/yyyy")} - ${n.endDate?q(o(n.endDate),"dd/MM/yyyy"):"En curso"}? Esta acción no se puede deshacer.`:"",isProcessing:f})]})};export{qe as default};
