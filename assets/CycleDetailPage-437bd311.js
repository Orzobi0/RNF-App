import{c as Z,r as t,e as ee,f as de,g as ue,P as fe,h as me,i as he,a as pe,u as ye,b as ge,j as s,m as W,B as $,L as we,X as xe}from"./index-1b0fe1a0.js";import{g as Ce,F as De,R as Ee}from"./generatePlaceholders-26f1d0e5.js";import{R as ve,D as be}from"./DeletionDialog-5365865d.js";import{P as X,D as ke}from"./DataEntryForm-8234e9d4.js";import{E as Re}from"./EditCycleDatesDialog-c69612db.js";import{a as je,p as R,d as G,s as _,f as H}from"./useCycleData-270ed225.js";import{T as Fe}from"./badge-e000eb74.js";import{E as Se}from"./eye-off-ea0ccfbb.js";import{E as Me}from"./eye-16f81715.js";import"./ChartTooltip-2ac35f64.js";import"./dialog-9f479f94.js";import"./input-2e2fdcf0.js";import"./label-a061ee7d.js";const Ne=Z("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]),ze=Z("Maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]);function te(){const a=t.useRef(!1);return ee(()=>(a.current=!0,()=>{a.current=!1}),[]),a}function Le(){const a=te(),[m,n]=t.useState(0),o=t.useCallback(()=>{a.current&&n(m+1)},[m]);return[t.useCallback(()=>de.postRender(o),[o]),m]}class Ie extends t.Component{getSnapshotBeforeUpdate(m){const n=this.props.childRef.current;if(n&&m.isPresent&&!this.props.isPresent){const o=this.props.sizeRef.current;o.height=n.offsetHeight||0,o.width=n.offsetWidth||0,o.top=n.offsetTop,o.left=n.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function $e({children:a,isPresent:m}){const n=t.useId(),o=t.useRef(null),i=t.useRef({width:0,height:0,top:0,left:0});return t.useInsertionEffect(()=>{const{width:w,height:C,top:x,left:c}=i.current;if(m||!o.current||!w||!C)return;o.current.dataset.motionPopId=n;const e=document.createElement("style");return document.head.appendChild(e),e.sheet&&e.sheet.insertRule(`
          [data-motion-pop-id="${n}"] {
            position: absolute !important;
            width: ${w}px !important;
            height: ${C}px !important;
            top: ${x}px !important;
            left: ${c}px !important;
          }
        `),()=>{document.head.removeChild(e)}},[m]),t.createElement(Ie,{isPresent:m,childRef:o,sizeRef:i},t.cloneElement(a,{ref:o}))}const J=({children:a,initial:m,isPresent:n,onExitComplete:o,custom:i,presenceAffectsLayout:w,mode:C})=>{const x=ue(Pe),c=t.useId(),e=t.useMemo(()=>({id:c,initial:m,isPresent:n,custom:i,onExitComplete:d=>{x.set(d,!0);for(const u of x.values())if(!u)return;o&&o()},register:d=>(x.set(d,!1),()=>x.delete(d))}),w?void 0:[n]);return t.useMemo(()=>{x.forEach((d,u)=>x.set(u,!1))},[n]),t.useEffect(()=>{!n&&!x.size&&o&&o()},[n]),C==="popLayout"&&(a=t.createElement($e,{isPresent:n},a)),t.createElement(fe.Provider,{value:e},a)};function Pe(){return new Map}function Oe(a){return t.useEffect(()=>()=>a(),[])}const P=a=>a.key||"";function Ae(a,m){a.forEach(n=>{const o=P(n);m.set(o,n)})}function _e(a){const m=[];return t.Children.forEach(a,n=>{t.isValidElement(n)&&m.push(n)}),m}const Q=({children:a,custom:m,initial:n=!0,onExitComplete:o,exitBeforeEnter:i,presenceAffectsLayout:w=!0,mode:C="sync"})=>{const x=t.useContext(me).forceRender||Le()[0],c=te(),e=_e(a);let d=e;const u=t.useRef(new Map).current,D=t.useRef(d),k=t.useRef(new Map).current,j=t.useRef(!0);if(ee(()=>{j.current=!1,Ae(e,k),D.current=d}),Oe(()=>{j.current=!0,k.clear(),u.clear()}),j.current)return t.createElement(t.Fragment,null,d.map(y=>t.createElement(J,{key:P(y),isPresent:!0,initial:n?void 0:!1,presenceAffectsLayout:w,mode:C},y)));d=[...d];const b=D.current.map(P),z=e.map(P),F=b.length;for(let y=0;y<F;y++){const g=b[y];z.indexOf(g)===-1&&!u.has(g)&&u.set(g,void 0)}return C==="wait"&&u.size&&(d=[]),u.forEach((y,g)=>{if(z.indexOf(g)!==-1)return;const I=k.get(g);if(!I)return;const q=b.indexOf(g);let S=y;if(!S){const U=()=>{u.delete(g);const O=Array.from(k.keys()).filter(p=>!z.includes(p));if(O.forEach(p=>k.delete(p)),D.current=e.filter(p=>{const M=P(p);return M===g||O.includes(M)}),!u.size){if(c.current===!1)return;x(),o&&o()}};S=t.createElement(J,{key:P(I),isPresent:!1,onExitComplete:U,custom:m,presenceAffectsLayout:w,mode:C},I),u.set(g,S)}d.splice(q,0,S)}),d=d.map(y=>{const g=y.key;return u.has(g)?y:t.createElement(J,{key:P(y),isPresent:!0,presenceAffectsLayout:w,mode:C},y)}),t.createElement(t.Fragment,null,u.size?d:d.map(y=>t.cloneElement(y)))},qe=()=>{const[a,m]=t.useState(!1),[n,o]=t.useState("portrait"),i=t.useCallback(async(c="portrait")=>{const e=document.documentElement;try{e.requestFullscreen?await e.requestFullscreen():e.mozRequestFullScreen?await e.mozRequestFullScreen():e.webkitRequestFullscreen?await e.webkitRequestFullscreen():e.msRequestFullscreen&&await e.msRequestFullscreen(),typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.lock&&await window.screen.orientation.lock(`${c}-primary`).catch(()=>{}),o(c)}catch{}},[]),w=t.useCallback(async()=>{try{document.exitFullscreen?await document.exitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.msExitFullscreen&&await document.msExitFullscreen(),typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.unlock&&window.screen.orientation.unlock()}catch{}},[]),C=t.useCallback(async()=>{a?await w():await i(n)},[a,i,w,n]),x=t.useCallback(async()=>{const c=n==="portrait"?"landscape":"portrait";a?window.screen&&window.screen.orientation&&window.screen.orientation.lock&&await window.screen.orientation.lock(`${c}-primary`).catch(()=>{}):await i(c),o(c)},[n,a,i]);return t.useEffect(()=>{const c=()=>{const e=!!(document.fullscreenElement||document.webkitIsFullScreen||document.mozFullScreenElement||document.msFullscreenElement);m(e),!e&&typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.unlock&&window.screen.orientation.unlock()};return document.addEventListener("fullscreenchange",c),document.addEventListener("webkitfullscreenchange",c),document.addEventListener("mozfullscreenchange",c),document.addEventListener("MSFullscreenChange",c),()=>{document.removeEventListener("fullscreenchange",c),document.removeEventListener("webkitfullscreenchange",c),document.removeEventListener("mozfullscreenchange",c),document.removeEventListener("MSFullscreenChange",c)}},[]),{isFullScreen:a,orientation:n,toggleFullScreen:C,rotateScreen:x}},ne=28,Ue=({cycleData:a,addOrUpdateDataPointForCycle:m,deleteRecordForCycle:n,toggleIgnoreRecordForCycle:o,isFullScreen:i,toggleFullScreen:w,orientation:C,rotateScreen:x,showInterpretation:c,setShowInterpretation:e,chartDisplayData:d,showForm:u,setShowForm:D,editingRecord:k,setEditingRecord:j,recordToDelete:b,setRecordToDelete:z,isProcessing:F,toast:y,onEditCycleDates:g,onDeleteCycle:I})=>{const q=C==="landscape"?ne:5,S=p=>{const M=()=>{j(p),D(!0)};i?(w(),setTimeout(M,300)):M()},U=p=>{const M=a.data.find(V=>V.id===p);z(M)},O=()=>{b&&n(b.id)};return s.jsxs("div",{className:`w-full ${i?"h-full overflow-hidden":"max-w-4xl mx-auto"}`,children:[s.jsxs(W.div,{className:"flex flex-wrap items-center justify-between gap-4 mb-8",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:[!i&&s.jsx($,{variant:"outline",asChild:!0,className:"w-full sm:w-auto mt-4 sm:mt-0 border-pink-500 text-pink-400 hover:bg-pink-500/20 hover:text-pink-300",children:s.jsxs(we,{to:"/archived-cycles",children:[s.jsx(Ne,{className:"mr-2 h-4 w-4"})," Mis Ciclos"]})}),!i&&s.jsxs("h1",{className:"w-full text-2xl sm:text-3xl font-bold hover:text-pink-300 text-center",children:["Detalle del Ciclo (",H(R(a.startDate),"dd/MM/yyyy"),")"]}),!i&&s.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto mt-4 sm:mt-0",children:[s.jsxs($,{variant:"outline",onClick:g,className:"w-full sm:w-auto border-pink-500 text-pink-400 hover:bg-pink-500/20 hover:text-pink-300",children:[s.jsx(X,{className:"mr-2 h-4 w-4"})," Editar Fechas"]}),s.jsxs($,{variant:"destructive",onClick:I,className:"w-full sm:w-auto",children:[s.jsx(Fe,{className:"mr-2 h-4 w-4"})," Eliminar Ciclo"]})]})]}),s.jsx(Q,{children:!u&&(d.length>0||i)&&s.jsxs(W.div,{initial:{opacity:0,scale:i?1:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:i?1:.9},transition:{duration:.5},className:`shadow-2xl rounded-xl ${i?"w-full h-full p-0 fixed inset-0 z-50 bg-white":"p-4 sm:p-6 mb-4 bg-white/70 backdrop-blur-md ring-1 ring-[#FFB1DD]/50"} relative`,style:{boxShadow:"0 4px 8px rgba(0,0,0,0.04)"},children:[!i&&s.jsx("h2",{className:"text-xl font-medium text-[#393C65] mb-4 bg-white bg-opacity-90 px-4 py-2 rounded-md",children:"Gráfica"}),s.jsx(De,{data:d,isFullScreen:i,orientation:C,onToggleIgnore:o,onEdit:S,cycleId:a.id,showInterpretation:c,visibleDays:q}),s.jsxs($,{onClick:()=>e(p=>!p),variant:"ghost",size:"sm",className:`absolute ${i?"top-4 right-20":"top-2 right-20"} flex items-center font-semibold py-1 px-2 rounded-lg transition-colors ${c?"bg-[#E27DBF] text-white hover:bg-[#d46ab3]":"bg-transparent text-[#393C65] hover:bg-[#E27DBF]/20"}`,children:[c?s.jsx(Se,{className:"mr-2 h-4 w-4"}):s.jsx(Me,{className:"mr-2 h-4 w-4"}),c?"Ocultar":"Interpretar"]}),s.jsx($,{onClick:x,variant:"ghost",size:"icon",className:`absolute ${i?"top-4 right-12 text-white bg-slate-700/50 hover:bg-slate-600/70":"top-2 right-12 text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:"Cambiar orientación",children:s.jsx(Ee,{className:"h-5 w-5"})}),s.jsx($,{onClick:w,variant:"ghost",size:"icon",className:`absolute ${i?"top-4 right-4 text-white bg-slate-700/50 hover:bg-slate-600/70":"top-2 right-2 text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:i?"Salir de Pantalla Completa":"Ver en Pantalla Completa",children:i?s.jsx(xe,{className:"h-6 w-6"}):s.jsx(ze,{className:"h-5 w-5"})})]})}),!i&&s.jsxs(s.Fragment,{children:[s.jsx(Q,{children:u&&s.jsx(W.div,{initial:{opacity:0,y:20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:20,height:0},transition:{duration:.3},className:"overflow-hidden mb-8",children:s.jsx(ke,{onSubmit:m,initialData:k,onCancel:()=>{D(!1),j(null)},cycleStartDate:a.startDate,cycleEndDate:a.endDate,isProcessing:F,isEditing:!!k,cycleData:a.data})},"data-entry-form-detail")}),!u&&s.jsx("div",{className:"my-8",children:s.jsxs($,{onClick:()=>{j(null),D(!0)},className:"w-full sm:w-auto bg-gradient-to-r from-pink-500 to-fuchsia-600 hover:from-pink-600 hover:to-fuchsia-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-lg",disabled:F,children:[s.jsx(X,{className:"mr-2 h-5 w-5"})," Añadir registro en este ciclo"]})}),s.jsx(ve,{records:a.data,onEdit:S,onDelete:U,isArchiveView:!0,isProcessing:F})]}),s.jsx(be,{isOpen:!!b,onClose:()=>z(null),onConfirm:O,recordDate:b?H(R(b.isoDate),"dd/MM/yyyy"):"",isProcessing:F})]})},tt=()=>{const{cycleId:a}=he(),m=pe(),{user:n}=ye(),{getCycleById:o,isLoading:i,refreshData:w,toggleIgnoreRecord:C,updateCycleDates:x,deleteCycle:c}=je(a),[e,d]=t.useState(null),{toast:u}=ge(),[D,k]=t.useState(null),[j,b]=t.useState(!1),[z,F]=t.useState(null),[y,g]=t.useState(!1),{isFullScreen:I,toggleFullScreen:q,orientation:S,rotateScreen:U}=qe(),[O,p]=t.useState(!1),[M,V]=t.useState(!1);t.useEffect(()=>{(async()=>{if(n){let h=await o(a);if(!h){const f=localStorage.getItem(`fertilityData_cycle_${n.uid}_${a}`);if(f){const l=JSON.parse(f);h={...l,data:T(l.data||[],l.startDate)}}}h?d(h):(u({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),m("/archived-cycles"))}})()},[a,n,o,u,m]);const Y=(r,h)=>{const f=_(R(r)),l=_(R(h));return G(f,l)+1},T=(r,h)=>!r||!Array.isArray(r)||!h?[]:[...r].sort((l,L)=>R(l.isoDate)-R(L.isoDate)).map(l=>({...l,ignored:l.ignored||!1,cycleDay:Y(l.isoDate,h)})),K=r=>{if(!n||!r||!r.id)return;const h={...r,data:r.data.map(({cycleDay:f,...l})=>l)};localStorage.setItem(`fertilityData_cycle_${n.uid}_${r.id}`,JSON.stringify(h))},ae=r=>{if(!e||!n)return;p(!0);const h=r.temperature_raw,f=r.temperature_corrected,L=r.use_corrected||!1?f??h:h??f;let A;const E={...r,temperature_chart:L,isoDate:H(_(R(r.isoDate)),"yyyy-MM-dd"),cycleDay:Y(r.isoDate,e.startDate),ignored:D?r.ignored??D.ignored:r.ignored||!1};if(D)A=e.data.map(B=>B.id===D.id?{...B,...E,id:D.id}:B);else{const B={...E,id:crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)};A=[...e.data,B]}const v=T(A,e.startDate),N={...e,data:v};K(N),d(N),u({title:D?"Registro actualizado":"Nuevo registro añadido",description:"Datos para el ciclo actualizados."}),b(!1),k(null),p(!1),w()},se=r=>{if(!e||!n)return;p(!0);const h=e.data.filter(L=>L.id!==r),f=T(h,e.startDate),l={...e,data:f};K(l),d(l),u({title:"Registro eliminado",description:"El registro ha sido eliminado del ciclo.",variant:"destructive"}),F(null),p(!1),w()},re=(r,h)=>{if(!e||!n||e.id!==r)return;p(!0),C(r,h),d(l=>{if(!l)return null;const L=l.data.map(v=>v.id===h?{...v,ignored:!v.ignored}:v),A=T(L,l.startDate),E={...l,data:A};return K(E),E});const f=e.data.find(l=>l.id===h);u({title:`Registro ${f&&!f.ignored?"despreciado":"restaurado"}`,description:`El registro del ${f?H(R(f.isoDate),"dd/MM/yyyy"):""} ha sido ${f&&!f.ignored?"marcado como despreciado":"restaurado"}.`}),p(!1)},oe=async({startDate:r,endDate:h})=>{if(!(!e||!n)){p(!0);try{await x(e.id,r,h);const f=await o(e.id);f&&(K(f),d(f)),u({title:"Fechas actualizadas",description:"Las fechas del ciclo han sido modificadas."}),g(!1)}catch(f){console.error(f)}p(!1)}},ie=async()=>{if(!(!e||!n)&&window.confirm("¿Eliminar este ciclo?")){p(!0);try{await c(e.id),u({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),m("/archived-cycles")}catch(r){console.error(r)}p(!1)}},ce=t.useCallback(()=>{if(!e||!e.startDate)return[];const r=R(e.startDate),h=e.data.reduce((E,v)=>{const N=R(v.isoDate);return N>E?N:E},r),f=e.endDate?R(e.endDate):null;let l;if(f)l=G(_(f),r)+1;else{const E=_(new Date),v=h>E?h:E,N=G(_(v),r);l=Math.max(ne,N+1)}return Ce(r,l).map(E=>{const v=e.data.find(N=>N.isoDate===E.isoDate);return v?{...v,date:E.date}:E})},[e]);if(i||!e)return s.jsx("div",{className:"text-center text-slate-300 p-8",children:"Cargando detalles del ciclo..."});const le=ce();return s.jsxs(s.Fragment,{children:[s.jsx(Ue,{cycleData:e,addOrUpdateDataPointForCycle:ae,deleteRecordForCycle:se,toggleIgnoreRecordForCycle:re,isFullScreen:I,toggleFullScreen:q,orientation:S,rotateScreen:U,showInterpretation:M,setShowInterpretation:V,chartDisplayData:le,showForm:j,setShowForm:b,editingRecord:D,setEditingRecord:k,recordToDelete:z,setRecordToDelete:F,isProcessing:O,toast:u,onEditCycleDates:()=>g(!0),onDeleteCycle:ie}),s.jsx(Re,{isOpen:y,onClose:()=>g(!1),onConfirm:oe,initialStartDate:e.startDate,initialEndDate:e.endDate})]})};export{tt as default};
