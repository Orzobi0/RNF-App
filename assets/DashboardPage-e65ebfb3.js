import{c as ye,r as n,f as I,j as e,B as xe,b as je,p as G,d as ue,s as me,m,e as ve}from"./index-094431a6.js";import{C as De,P as Ne}from"./CycleDatesEditor-ae4b5b89.js";import{D as Se,c as Ce,C as Me,a as Ee,i as Pe}from"./computePeakStatuses-cc1a8250.js";import{u as _e,P as Oe}from"./badge-98f311a3.js";import{D as pe,a as fe,b as Te,c as Fe,d as Re,e as Ae,u as Ie}from"./useCycleData-0b42a521.js";import{I as ze}from"./input-cce78a3a.js";import{C as Le}from"./ChartTooltip-e20861b8.js";import"./OverlapWarningDialog-800934cb.js";import"./label-b3767793.js";import"./checkbox-f5e56bc8.js";import"./eye-2e9ccd1a.js";import"./eye-off-e3755f54.js";const We=ye("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),Xe=ye("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]),ge=({isOpen:a,onClose:k,onConfirm:N,currentCycleStartDate:j})=>{const[T,y]=n.useState(I(new Date,"yyyy-MM-dd"));_e(a,k);const x=!j,h=()=>{N(T)},S=x?"":I(new Date(j),"dd/MM/yyyy"),$=(()=>{if(x)return"";const d=new Date(T);return d.setDate(d.getDate()-1),I(d,"dd/MM/yyyy")})();return e.jsx(pe,{open:a,onOpenChange:k,children:e.jsxs(fe,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(Te,{children:[e.jsx(Fe,{children:"Iniciar nuevo ciclo"}),e.jsx(Re,{className:"text-gray-600",children:x?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${S} - ${$}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsx(ze,{id:"startDate",type:"date",value:T,onChange:d=>y(d.target.value),max:I(new Date,"yyyy-MM-dd"),min:x?void 0:I(new Date(j),"yyyy-MM-dd"),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),e.jsxs(Ae,{className:"sm:justify-end",children:[e.jsx(xe,{variant:"outline",onClick:k,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(xe,{variant:"primary",onClick:h,className:"bg-pink-600 hover:bg-pink-700 text-white",children:x?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})})},He=({cycleData:a,onEdit:k,onTogglePeak:N,currentPeakIsoDate:j,onEditStartDate:T=()=>{}})=>{var P,_;const y=a.records||[],[x,h]=n.useState(null),[S,$]=n.useState({clientX:0,clientY:0}),[d,v]=n.useState(0),F=n.useRef(!1),z=n.useRef(null),p=n.useRef(null),b=a.startDate?G(a.startDate):null,q=me(new Date),te=n.useMemo(()=>Ce(y),[y]),f=28,R=140,g=R+15,C=g*2,w=n.useMemo(()=>{const t=y.reduce((s,i)=>{const l=(i==null?void 0:i.cycleDay)??null;if(l)return Math.max(s,l);if(!b||!(i!=null&&i.isoDate))return s;try{const o=G(i.isoDate),D=ue(o,b)+1;return Number.isFinite(D)?Math.max(s,D):s}catch(o){return console.error("Error calculating record day for wheel:",o),s}},0);return Math.max(a.currentDay,t,f)},[a.currentDay,y,b,f]),M=Math.max(w-f,0),c=M>0;n.useEffect(()=>{if(!c){F.current=!0,v(0);return}v(t=>{const s=Math.min(t,M),i=Math.max(0,Math.min(Math.max(a.currentDay-f,0),M)),l=a.currentDay>=s+1&&a.currentDay<=s+f;return F.current?l?s!==t?s:t:i:(F.current=!0,i)})},[c,M,a.currentDay,f]);const B=n.useCallback(t=>Math.max(0,Math.min(t,M)),[M]),A=n.useCallback(t=>{!c||t===0||v(s=>B(s+t))},[B,c]),ae=n.useCallback(t=>{if(!c)return;t.preventDefault();const s=Math.abs(t.deltaY)>Math.abs(t.deltaX)?t.deltaY:t.deltaX;s!==0&&A(s>0?1:-1)},[A,c]),se=n.useCallback(t=>{var s,i;c&&(z.current=((i=(s=t.touches)==null?void 0:s[0])==null?void 0:i.clientX)??null)},[c]),E=n.useCallback(t=>{var l,o;if(!c||z.current===null)return;const s=((o=(l=t.touches)==null?void 0:l[0])==null?void 0:o.clientX)??null;if(s===null)return;const i=s-z.current;Math.abs(i)<24||(A(i<0?1:-1),z.current=s)},[A,c]),re=n.useCallback(()=>{z.current=null},[]),Y=t=>{switch(t){case"red":return{main:"#ef4444",light:"#fee2e2",glow:"rgba(239, 68, 68, 0.3)",border:"none"};case"white":return{main:"#f8fafc",light:"#ffe4e6",glow:"rgba(248, 250, 252, 0.3)"};case"green":return{main:"#22c55e",light:"#22c55e",glow:"rgba(34, 197, 94, 0.3)",border:"none"};case"yellow":return{main:"#facc15",light:"#fef08a",glow:"rgba(250, 204, 21, 0.3)",border:"none"};case"spot":return{main:"#ef4444",light:"#ef4444",glow:"rgba(239, 68, 68, 0.3)",border:"#fee2e2",pattern:"url(#spotting-pattern-dashboard)"};default:return{main:"#d1d5db",light:"#f8fafc",glow:"rgba(209, 213, 219, 0.3)"}}},J=n.useMemo(()=>y.reduce((t,s)=>{if(!s)return t;const i=Number(s.cycleDay);if(Number.isFinite(i)&&i>0)return t.has(i)||t.set(i,s),t;if(!b||!s.isoDate)return t;try{const l=G(s.isoDate),o=ue(l,b)+1;Number.isFinite(o)&&o>0&&!t.has(o)&&t.set(o,{...s,cycleDay:o})}catch(l){console.error("Error mapping record by day for wheel:",l)}return t},new Map),[y,b]),W=(()=>Array.from({length:f},(t,s)=>{const i=d+s+1,l=J.get(i)??null,o=b?ve(b,i-1):null,D=o?I(o,"yyyy-MM-dd"):null,u=o?Pe(me(o),q):!1,O=l?{...l,cycleDay:l.cycleDay??i}:null,ee=(s+d)%f/f*2*Math.PI-Math.PI/2,be=g+R*Math.cos(ee),we=g+R*Math.sin(ee);let de=i<=a.currentDay&&O?Y(O.fertility_symbol):{main:"#b5b6ba",light:"#c8cacf",glow:"rgba(229, 231, 235, 0.3)"};const he=i===a.currentDay;he&&(O?de={...Y(O.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:de={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const ke=D&&te[D]||null;return{x:be,y:we,day:i,colors:de,isActive:i<=a.currentDay,isToday:he,hasRecord:!!O,record:O,isoDate:D,canShowPlaceholder:!!(!O&&D&&!u),peakStatus:ke}}))(),X=2*Math.PI/f,H=-Math.PI/2-X/2,K=R-18,U=R+10,ne=g+K*Math.cos(H),ie=g+K*Math.sin(H),le=g+U*Math.cos(H),oe=g+U*Math.sin(H),Q=360/f,Z=n.useMemo(()=>-(d*Q),[d,Q]);n.useEffect(()=>{c&&h(null)},[d,c]);const r=(t,s)=>{if(s.stopPropagation(),!p.current){h(null);return}const i=p.current.getBoundingClientRect();let l,o;s.touches&&s.touches[0]?(l=s.touches[0].clientX,o=s.touches[0].clientY):(l=s.clientX,o=s.clientY);const D=t.canShowPlaceholder&&t.isoDate?{id:`placeholder-${t.isoDate}`,isoDate:t.isoDate,cycleDay:t.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:t.peakStatus,peak_marker:t.peakStatus==="P"?"peak":null}:null,u=t.record?{...t.record,cycleDay:t.record.cycleDay??t.day,peakStatus:t.peakStatus,peak_marker:t.record.peak_marker??(t.peakStatus==="P"?"peak":null)}:D;if(u&&j&&u.isoDate===j&&(u.peak_marker="peak",u.peakStatus=u.peakStatus||"P"),!u){h(null);return}$({clientX:l-i.left,clientY:o-i.top}),h(u)};return n.useEffect(()=>{if(!x)return;const t=s=>{p.current&&!p.current.contains(s.target)&&h(null)};return document.addEventListener("mousedown",t),document.addEventListener("touchstart",t),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("touchstart",t)}},[x]),e.jsxs("div",{className:"relative flex flex-col flex-1 min-h-full overflow-y-hidden",children:[e.jsxs(m.div,{className:"px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:T,className:"text-sm font-medium text-pink-700 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1.5 inline-flex items-center gap-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white/40",title:"Editar fecha de inicio del ciclo",children:[e.jsx(Ne,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(m.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:[e.jsxs("div",{className:"text-center mb-3 flex-shrink-0",children:[e.jsxs(m.div,{ref:p,className:"relative inline-flex items-center justify-center mb-4",style:{width:C,height:C},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15,delay:.3},onWheel:ae,onTouchStart:se,onTouchMove:E,onTouchEnd:re,children:[e.jsxs("svg",{className:"w-full h-full",viewBox:`0 0 ${C} ${C}`,onClick:()=>h(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"50%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.0)"}),e.jsx("stop",{offset:"60%",stopColor:"rgba(244,114,182,0.12)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(190,24,93,0.10)"})]})]}),e.jsx("circle",{cx:g,cy:g,r:R-30,fill:"url(#ringGlow)",stroke:"rgba(255,255,255,0.35)",strokeWidth:"0.5"}),c&&e.jsx("line",{x1:ne,y1:ie,x2:le,y2:oe,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(m.g,{animate:{rotate:Z},transition:{type:"spring",stiffness:140,damping:18},initial:!1,style:{transformOrigin:`${g}px ${g}px`,transformBox:"fill-box"},children:W.map((t,s)=>e.jsxs("g",{children:[!(t.isToday&&!t.hasRecord)&&t.isActive&&e.jsx("circle",{cx:t.x+.3,cy:t.y+.3,r:t.isToday?11:10,fill:"rgba(0, 0, 0, 0.2)",opacity:.5}),t.isToday&&e.jsx("circle",{cx:t.x,cy:t.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}}),e.jsx(m.circle,{cx:t.x,cy:t.y,r:t.isToday?11:10,fill:t.colors.pattern||(t.isActive&&t.hasRecord?t.colors.main:"rgba(255,255,255,0.001)"),stroke:t.colors.border==="none"?"none":t.colors.border||"rgba(158,158,158,0.4)",strokeWidth:t.colors.border==="none"?0:t.isToday?1.8:t.colors.border?.6:.8,onClick:i=>r(t,i),initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.6,delay:.8+s*.02,type:"spring",stiffness:400,damping:25},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.2))",cursor:"pointer"}}),t.peakStatus&&e.jsx("g",{transform:`rotate(${-Z} ${t.x} ${t.y})`,children:t.peakStatus==="P"?e.jsx(m.text,{x:t.x,y:t.y+4,textAnchor:"middle",fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none",filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))"},initial:{scale:.2,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.95+s*.02,type:"spring",stiffness:320,damping:22},children:"✖"}):e.jsx(m.text,{x:t.x,y:t.y+4,textAnchor:"middle",fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},initial:{scale:.2,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.95+s*.02,type:"spring",stiffness:320,damping:22},children:t.peakStatus})})]},s))})]}),x&&e.jsx("div",{onClick:t=>t.stopPropagation(),children:e.jsx(Le,{point:x,position:S,chartWidth:((P=p.current)==null?void 0:P.clientWidth)||0,chartHeight:((_=p.current)==null?void 0:_.clientHeight)||0,onEdit:k,onClose:()=>h(null),onTogglePeak:N,currentPeakIsoDate:j})}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[e.jsxs(m.div,{className:"text-center  backdrop-blur-md rounded-full p-4",initial:{opacity:0,scale:.5},animate:{opacity:1,scale:1},transition:{delay:1,type:"spring",stiffness:200},style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"},children:[e.jsx("span",{className:"text-5xl font-bold text-pink-700 block",children:a.currentDay}),e.jsx("span",{className:"text-800 text-pink-700 font-medium mt-0.5 block",children:"día del ciclo"})]}),e.jsx(m.div,{className:"mt-2 px-2.5 py-1  backdrop-blur-sm rounded-full border border-pink-200",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.3},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.1))"},children:e.jsx("span",{className:"text-md font-medium text-pink-900",children:a.currentDay<=7?"Menstrual":a.currentDay<=14?"Folicular":a.currentDay<=21?"Ovulatoria":"Lútea"})})]})]}),c&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>A(-1),disabled:d===0,children:e.jsx(Me,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"text-xs font-semibold text-rose-600 tracking-wide uppercase",children:"Rueda del ciclo"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",d+1]}),e.jsx("span",{className:"text-xs text-rose-400",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",Math.min(d+f,w)]})]}),e.jsx("input",{type:"range",min:0,max:M,value:d,onChange:t=>v(B(Number(t.target.value))),className:"w-44 accent-rose-500"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>A(1),disabled:d===M,children:e.jsx(Ee,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0",children:[e.jsxs(m.div,{className:"relative bg-gradient-to-br from-pink-50/90 to-rose-50/90 backdrop-blur-md rounded-3xl p-4 border border-pink-200/30",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.5},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.08))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.7)"},children:[e.jsx("h3",{className:"font-bold mb-6 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Símbolos"}),e.jsx("div",{className:"grid grid-cols-2 gap-2.5",children:[{label:"Menstrual",color:"#ef4444"},{label:"Moco (Fértil)",color:"#f8fafc",stroke:"#c2c6cc"},{label:"Seco (Rel. Infértil)",color:"#22c55e"},{label:"Moco (No fértil)",color:"#facc15",stroke:"#fef08a"},{label:"Spotting",color:"#ef4444",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(t=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[t.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-4 h-4 rounded-full border ${t.pattern?"pattern-bg":""}`,style:{backgroundColor:t.color,borderColor:t.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${t.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:t.label})]},t.label))}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-300/40 to-rose-400/40 rounded-full"})]}),e.jsxs(m.div,{className:"relative bg-gradient-to-br from-pink-50/70 to-rose-50/50 backdrop-blur-md rounded-3xl p-4 border border-pink-200/40",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.6},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.1))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.8)"},children:[e.jsx("h3",{className:"font-bold mb-3 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Cálculo"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"CPM"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"bg-white/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-gray-200/50 shadow-sm",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"Sin datos"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"T-8"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"bg-white/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-gray-200/50 shadow-sm",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"Sin datos"})})]})]}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-500/40 to-rose-400/40 rounded-full"})]})]})]})]})},$e=({onAddRecord:a,onAddCycle:k})=>{const[N,j]=n.useState(!1);return e.jsxs("div",{className:"fixed bottom-[calc(var(--bottom-nav-height)+1rem)] right-6 flex flex-col items-end space-y-3 z-50",children:[N&&e.jsxs(e.Fragment,{children:[e.jsxs(m.button,{onClick:k,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white shadow-lg",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(147, 51, 234, 0.3))"},children:[e.jsx(We,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]}),e.jsxs(m.button,{onClick:a,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(Xe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]})]}),e.jsx(m.button,{onClick:()=>j(!N),className:"w-14 h-14 bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-full shadow-lg flex items-center justify-center",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 6px 16px rgba(236, 72, 153, 0.4))"},children:e.jsx(m.span,{animate:{rotate:N?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(Oe,{className:"h-6 w-6"})})})]})},at=()=>{const{currentCycle:a,addOrUpdateDataPoint:k,startNewCycle:N,isLoading:j,updateCycleDates:T,checkCycleOverlap:y,forceUpdateCycleStart:x,refreshData:h}=Ie(),{toast:S}=je(),[$,d]=n.useState(!1),[v,F]=n.useState(()=>(a==null?void 0:a.startDate)||""),[z,p]=n.useState(""),[b,q]=n.useState(null),[te,f]=n.useState(null),[R,V]=n.useState(!1),[g,C]=n.useState(!1);n.useEffect(()=>{F((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate]);const w=n.useCallback(()=>{q(null),f(null),V(!1)},[]),M=n.useCallback(()=>{F((a==null?void 0:a.startDate)||""),p(""),w(),d(!0)},[a==null?void 0:a.startDate,w]),c=n.useCallback(()=>{d(!1),p(""),w(),F((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate,w]),B=n.useCallback(()=>{w()},[w]),A=n.useCallback(async()=>{if(!v){p("La fecha de inicio es obligatoria");return}if(a!=null&&a.id){p(""),C(!0);try{const r=y?await y(a.id,v):null;if(r){q(v),f(r),V(!0),C(!1);return}await T(a.id,v),await h({silent:!0}),S({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),c()}catch(r){console.error("Error updating start date from dashboard:",r),p("No se pudo actualizar la fecha de inicio"),S({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{C(!1)}}},[v,a==null?void 0:a.id,y,T,h,S,c]),ae=n.useCallback(async()=>{if(!(a!=null&&a.id)||!b){w();return}C(!0),V(!1);try{await x(a.id,b),await h({silent:!0}),S({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),c()}catch(r){console.error("Error forcing start date from dashboard:",r),p("No se pudo actualizar la fecha de inicio"),S({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{C(!1),w()}},[a==null?void 0:a.id,b,x,h,S,c,w]),[se,E]=n.useState(!1),[re,Y]=n.useState(!1),[J,L]=n.useState(!1),[W,X]=n.useState(null),H=!!(W&&String(W.id||"").startsWith("placeholder-")),K=n.useMemo(()=>{var P;const r=(P=a==null?void 0:a.data)==null?void 0:P.find(_=>(_==null?void 0:_.peak_marker)==="peak");return(r==null?void 0:r.isoDate)||null},[a==null?void 0:a.data]),U=n.useCallback(()=>{E(!1),X(null)},[]),ne=n.useCallback(r=>{X(r)},[]),ie=n.useCallback(r=>{X(r),E(!0)},[]),le=n.useCallback(async(r,P=!0)=>{if(!(a!=null&&a.id)||!(r!=null&&r.isoDate))return;const _=s=>{if(s==null||s==="")return null;const i=parseFloat(String(s).replace(",","."));return Number.isFinite(i)?i:null},t=P??!(r.peak_marker==="peak"||r.peakStatus==="P");try{const s=r.timestamp?I(G(r.timestamp),"HH:mm"):I(new Date,"HH:mm");let i=Array.isArray(r.measurements)&&r.measurements.length>0?r.measurements:[{temperature:r.temperature_chart??r.temperature_raw??null,temperature_corrected:r.temperature_corrected??null,time:r.time??s,time_corrected:r.time_corrected??s,selected:!0,use_corrected:r.use_corrected??!1}];i.length===0&&(i=[{temperature:null,temperature_corrected:null,time:s,time_corrected:s,selected:!0,use_corrected:!1}]);const l=i.map((u,O)=>{const ce=u.time||s,ee=u.time_corrected||ce;return{temperature:_(u.temperature??u.temperature_raw),time:ce,selected:O===0?!0:!!u.selected,temperature_corrected:_(u.temperature_corrected),time_corrected:ee,use_corrected:!!u.use_corrected}});l.some(u=>u.selected)||(l[0].selected=!0);const o={isoDate:r.isoDate,measurements:l,mucusSensation:r.mucus_sensation??r.mucusSensation??"",mucusAppearance:r.mucus_appearance??r.mucusAppearance??"",fertility_symbol:r.fertility_symbol??"none",observations:r.observations??"",ignored:r.ignored??!1,peak_marker:t?"peak":null},D=r!=null&&r.id&&!String(r.id).startsWith("placeholder-")?r:null;await k(o,D)}catch(s){console.error("Error toggling peak marker from dashboard:",s)}},[k,a==null?void 0:a.id]);if(j&&!(a!=null&&a.id))return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:e.jsx("p",{className:"text-center text-gray-600 text-lg",children:"Cargando..."})});if(!(a!=null&&a.id))return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br ffrom-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-gray-600 text-lg",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>L(!0),className:"px-6 py-3 rounded-lg bg-pink-600 hover:bg-pink-700 text-white shadow",children:"Iniciar ciclo"})]}),e.jsx(ge,{isOpen:J,onClose:()=>L(!1),onConfirm:async r=>{await N(r),L(!1),E(!0)}})]});const oe=ue(me(new Date),G(a.startDate))+1,Q=async(r,{keepFormOpen:P=!1}={})=>{Y(!0);try{await k(r,W),P||(E(!1),X(null))}finally{Y(!1)}},Z=async r=>{await N(r),L(!1),E(!0)};return e.jsxs("div",{className:"min-h-[calc(100dvh-var(--bottom-nav-safe))] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative overflow-hidden flex flex-col",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"max-w-md mx-auto flex-1 w-full flex flex-col",children:e.jsxs(m.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex-1 flex flex-col",children:[e.jsx(He,{cycleData:{...a,currentDay:oe,records:a.data},onEdit:ie,onTogglePeak:le,currentPeakIsoDate:K,onEditStartDate:M}),e.jsx(pe,{open:$,onOpenChange:r=>{r||c()},children:e.jsx(fe,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(De,{cycle:a,startDate:v,endDate:a.endDate,onStartDateChange:r=>F(r),onSave:A,onCancel:c,isProcessing:g,dateError:z,includeEndDate:!1,showOverlapDialog:R,overlapCycle:te,onConfirmOverlap:ae,onCancelOverlap:B,onClearError:()=>p(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",className:"w-full"})})})]})}),e.jsx(pe,{open:se,onOpenChange:r=>{r?E(!0):U()},children:e.jsx(fe,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Se,{onSubmit:Q,onCancel:U,initialData:W,cycleStartDate:a.startDate,cycleEndDate:a.endDate,isProcessing:re,isEditing:!!W&&!H,cycleData:a.data,onDateSelect:ne})})}),e.jsx($e,{onAddRecord:()=>{X(null),E(!0)},onAddCycle:()=>L(!0)}),e.jsx(ge,{isOpen:J,onClose:()=>L(!1),onConfirm:Z,currentCycleStartDate:a.startDate})]})};export{at as default};
