import{h as me,a as he,u as ye,b as pe,r as o,f as v,p as u,j as a,B as N,L as W,g as ge,s as G,d as De}from"./index-e84ae47f.js";import{R as xe}from"./RecordsList-8aa66fff.js";import{D as ve}from"./computePeakStatuses-1cb03412.js";import{T as we,D as H}from"./DeletionDialog-9bcd306e.js";import{C as Ce,P as Ee}from"./CycleDatesEditor-4d5ec674.js";import{O as be}from"./OverlapWarningDialog-cf4973a4.js";import{u as je,D as Ne,a as Se}from"./useCycleData-09262d0a.js";import{A as Oe}from"./arrow-left-c923ae35.js";import"./badge-2d3d489e.js";import"./eye-853f9d7c.js";import"./input-693389fa.js";import"./label-962136e3.js";import"./select-973da53b.js";import"./eye-off-dac0e639.js";const ke=(c,f)=>{const i=G(u(c)),l=G(u(f));return De(i,l)+1},Re=(c,f)=>!c||!Array.isArray(c)||!f?[]:[...c].sort((l,S)=>u(l.isoDate)-u(S.isoDate)).map(l=>({...l,ignored:l.ignored||!1,cycleDay:ke(l.isoDate,f)})),We=()=>{const{cycleId:c}=me(),f=he(),{user:i}=ye(),{getCycleById:l,isLoading:S,addOrUpdateDataPoint:K,deleteRecord:Q,updateCycleDates:$,deleteCycle:V,checkCycleOverlap:q,forceUpdateCycleStart:X}=je(),{toast:n}=pe(),[e,w]=o.useState(null),[C,g]=o.useState(null),[Y,D]=o.useState(!1),[x,F]=o.useState(null),[m,h]=o.useState(!1),[Z,O]=o.useState(!1),[k,R]=o.useState(!1),[p,E]=o.useState(""),[b,j]=o.useState(""),[ee,y]=o.useState(""),[T,L]=o.useState(!1),[I,M]=o.useState(null),[B,P]=o.useState(null),_=e?`${v(u(e.startDate),"dd/MM/yyyy")} - ${e.endDate?v(u(e.endDate),"dd/MM/yyyy"):"En curso"}`:"",A=o.useCallback(t=>{if(!i||!(t!=null&&t.id))return;const s={...t,data:(t.data||[]).map(({cycleDay:d,...r})=>r)};localStorage.setItem(`fertilityData_cycle_${i.uid}_${t.id}`,JSON.stringify(s))},[i]);o.useEffect(()=>{(async()=>{if(!i)return;let s=await l(c);if(!s){const d=localStorage.getItem(`fertilityData_cycle_${i.uid}_${c}`);if(d){const r=JSON.parse(d);s={...r,data:Re(r.data||[],r.startDate)}}}s?w(s):(n({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),f("/archived-cycles"))})()},[c,i,l,n,f]),o.useEffect(()=>{e&&(E(e.startDate||""),j(e.endDate||""))},[e]);const te=async(t,{keepFormOpen:s=!1}={})=>{if(!e||!i)return;const d=!!C;h(!0);try{await K(t,C,e.id);const r=await l(e.id);r&&(A(r),w(r)),n({title:d?"Registro actualizado":"Nuevo registro añadido",description:"Datos para el ciclo actualizados."}),s||(D(!1),g(null))}catch(r){console.error("Error adding/updating data point:",r),n({title:"Error",description:"No se pudo guardar el registro.",variant:"destructive"})}finally{h(!1)}},ae=async t=>{if(!(!e||!i)){h(!0);try{await Q(t,e.id);const s=await l(e.id);s&&(A(s),w(s)),n({title:"Registro eliminado",description:"El registro ha sido eliminado."})}catch(s){console.error("Error deleting record:",s),n({title:"Error",description:"No se pudo eliminar el registro.",variant:"destructive"})}finally{h(!1)}}},se=async({startDate:t,endDate:s,force:d})=>{if(!e||!i)return!1;h(!0);try{d?(await X(e.id,t),s!==void 0&&await $(e.id,void 0,s)):await $(e.id,t,s);const r=await l(e.id);return r&&(A(r),w(r)),n({title:"Fechas actualizadas",description:"Las fechas del ciclo han sido modificadas."}),!0}catch(r){return console.error(r),n({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"}),!1}finally{h(!1)}},re=()=>{e&&O(!0)},oe=async()=>{if(!(!e||!i)){h(!0);try{await V(e.id),n({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),f("/archived-cycles"),O(!1)}catch(t){console.error(t),n({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{h(!1)}}},ie=()=>{!k&&e&&(E(e.startDate||""),j(e.endDate||""),y("")),R(t=>!t)},le=()=>{e&&(E(e.startDate||""),j(e.endDate||"")),y(""),R(!1)},z=async t=>{await se(t)&&(R(!1),y(""))},ne=async()=>{if(!p){y("La fecha de inicio es obligatoria");return}if(b&&b<p){y("La fecha de fin no puede ser anterior al inicio");return}y("");const t={startDate:p,endDate:b||void 0};if(q&&(e!=null&&e.id)&&p){const s=await q(e.id,p);if(s){M(t),P(s),L(!0);return}}await z(t)},U=async()=>{I&&await z({...I,force:!0}),L(!1),M(null),P(null)},J=()=>{L(!1),M(null),P(null)},ce=t=>{g(t),D(!0)},de=()=>{g(null),D(!0)},ue=t=>{if(!e)return;const s=(e.data||[]).find(d=>d.id===t);F(s||null)},fe=()=>{x&&ae(x.id)};return S&&!e||!e?a.jsx("div",{className:"text-center text-slate-300 p-8",children:"Cargando detalles del ciclo..."}):a.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative",children:[a.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),a.jsx("div",{className:"relative z-10 px-4 py-6",children:a.jsxs("div",{className:"w-full max-w-4xl mx-auto",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("div",{className:"flex items-center justify-between gap-2 mb-2",children:a.jsx(N,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:a.jsxs(W,{to:"/archived-cycles",children:[a.jsx(Oe,{className:"mr-2 h-4 w-4"})," Mis Ciclos"]})})}),a.jsx("div",{className:"text-center",children:a.jsxs("button",{type:"button",onClick:ie,className:`text-2xl sm:text-3xl font-bold px-4 py-3 rounded-xl transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2 ${k?"bg-rose-200/80 text-rose-700 shadow-inner":"bg-rose-200/50 hover:bg-rose-200/70 text-rose-700"}`,children:["Detalle de ciclo (",v(u(e.startDate),"dd/MM/yyyy")," -"," ",e.endDate?v(u(e.endDate),"dd/MM/yyyy"):"En curso",")"]})})]}),k&&a.jsxs("div",{className:"mb-6 mx-auto w-full max-w-xl",children:[a.jsx(Ce,{cycle:e,startDate:p,endDate:b,onStartDateChange:t=>E(t),onEndDateChange:t=>j(t),onSave:ne,onCancel:le,isProcessing:m,dateError:ee,includeEndDate:!0,showOverlapDialog:T,overlapCycle:B,onConfirmOverlap:U,onCancelOverlap:J,onClearError:()=>y(""),className:"w-full mb-4"}),a.jsxs("div",{className:"rounded-2xl border border-rose-100 bg-white/90 p-5 shadow-lg",children:[a.jsx("h3",{className:"text-lg font-semibold text-rose-700 mb-2",children:"Eliminar ciclo"}),a.jsx("p",{className:"text-sm text-slate-600 mb-3",children:"Esta acción no se puede deshacer. Se eliminarán todos los registros asociados."}),a.jsxs(N,{onClick:re,disabled:m,className:"w-full sm:w-auto bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600 text-white shadow-md",children:[a.jsx(we,{className:"mr-2 h-4 w-4"})," Eliminar ciclo"]})]})]}),a.jsxs("div",{className:"mb-4 flex justify-center gap-4",children:[a.jsx(N,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",disabled:m,children:a.jsxs(W,{to:`/chart/${e.id}`,children:[a.jsx(ge,{className:"mr-2 h-4 w-4"})," Gráfica"]})}),a.jsxs(N,{onClick:de,className:"bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},disabled:m,children:[a.jsx(Ee,{className:"mr-2 h-4 w-4"})," Añadir registro en este ciclo"]})]}),a.jsx(xe,{records:e.data,onEdit:ce,onDelete:ue,isProcessing:m}),a.jsx(Ne,{open:Y,onOpenChange:t=>{t||(D(!1),g(null))},children:a.jsx(Se,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:a.jsx(ve,{onSubmit:te,initialData:C,onCancel:()=>{D(!1),g(null)},cycleStartDate:e.startDate,cycleEndDate:e.endDate,isProcessing:m,isEditing:!!C,cycleData:e.data})})}),a.jsx(H,{isOpen:!!x,onClose:()=>F(null),onConfirm:fe,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:x?`¿Estás seguro de que quieres eliminar el registro del ${v(u(x.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:m}),a.jsx(H,{isOpen:Z,onClose:()=>O(!1),onConfirm:oe,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:_?`¿Estás seguro de que quieres eliminar el ciclo ${_}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:m}),a.jsx(be,{isOpen:T,conflictCycle:B,onCancel:J,onConfirm:U})]})})]})};export{We as default};
