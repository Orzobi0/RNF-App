import{c as me,b as he,r as s,p as n,E as w,s as pe,f as B,j as o,m as N,B as G}from"./index-65a39a90.js";import{P as xe,C as ge}from"./CycleDatesEditor-0db50ef5.js";import{R as be}from"./RecordsList-1441e981.js";import{m as H,e as $,i as J,f as De,D as ve}from"./computePeakStatuses-9c417235.js";import{D as we}from"./DeletionDialog-aaefd1b0.js";import{u as ye,D as Se,a as je}from"./useCycleData-834d83be.js";import{P as Ee,e as ke}from"./badge-b2616664.js";import"./OverlapWarningDialog-26e0e497.js";import"./eye-020a87c7.js";import"./input-49c2a17b.js";import"./label-61f7cfb2.js";import"./select-e07d8604.js";import"./eye-off-a74b0232.js";const Ne=me("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),Ve=()=>{const{currentCycle:e,addOrUpdateDataPoint:K,deleteRecord:Q,isLoading:W,updateCycleDates:T,checkCycleOverlap:R,forceUpdateCycleStart:I,refreshData:y}=ye(),{toast:c}=he(),[X,p]=s.useState(!1),[M,x]=s.useState(null),[g,O]=s.useState(null),[b,S]=s.useState(!1),[Y,U]=s.useState(!1),[u,j]=s.useState(()=>(e==null?void 0:e.startDate)||""),[Z,f]=s.useState(""),[z,_]=s.useState(null),[ee,q]=s.useState(null),[te,P]=s.useState(!1),[A,D]=s.useState(!1),[r,F]=s.useState(null),L=s.useRef(null),V=s.useRef(!1);s.useEffect(()=>{j((e==null?void 0:e.startDate)||"")},[e==null?void 0:e.startDate]);const m=s.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?[...e.data].filter(a=>a==null?void 0:a.isoDate).sort((a,i)=>{const k=n(a.isoDate);return n(i.isoDate)-k}).map(a=>a.isoDate):[]},[e==null?void 0:e.data]);s.useEffect(()=>{if(!m.length){F(null);return}(!r||!m.includes(r))&&F(m[0])},[m,r]),s.useEffect(()=>{r&&L.current&&V.current&&L.current.scrollIntoView({behavior:"smooth",block:"start"})},[r]),s.useEffect(()=>{window.scrollTo({top:0,behavior:"auto"})},[]);const h=s.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?e.data.map(a=>{if(!(a!=null&&a.isoDate))return null;const i=n(a.isoDate);return w(i)?i:null}).filter(Boolean):[]},[e==null?void 0:e.data]),E=s.useMemo(()=>new Set(m),[m]),l=s.useMemo(()=>{if(!(e!=null&&e.startDate))return null;const t=n(e.startDate);if(!w(t))return null;let a;if(e!=null&&e.endDate)a=n(e.endDate);else{const i=pe(new Date),k=[t,i];h.length&&k.push(H(h)),a=H(k)}return w(a)?{from:t,to:a}:{from:t,to:t}},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,h]),ae=s.useMemo(()=>{const t={};return l&&(t.outsideCycle=a=>$(a,l.from)||J(a,l.to),t.insideCycleNoRecord=a=>{if($(a,l.from)||J(a,l.to))return!1;const i=B(a,"yyyy-MM-dd");return!E.has(i)}),h.length&&(t.hasRecord=h),t},[l,h,E]),se=s.useCallback((t,a)=>{if(!t)return;const i=B(t,"yyyy-MM-dd");(a!=null&&a.hasRecord||E.has(i))&&(V.current=!0,F(i))},[E]),d=s.useCallback(()=>{_(null),q(null),P(!1)},[]),oe=s.useCallback(()=>{j((e==null?void 0:e.startDate)||""),f(""),d(),U(!0)},[e==null?void 0:e.startDate,d]),v=s.useCallback(()=>{U(!1),f(""),d(),j((e==null?void 0:e.startDate)||"")},[e==null?void 0:e.startDate,d]),ie=s.useCallback(()=>{d()},[d]),re=s.useCallback(async()=>{if(!u){f("La fecha de inicio es obligatoria");return}if(e!=null&&e.id){f(""),D(!0);try{const t=R?await R(e.id,u):null;if(t){_(u),q(t),P(!0),D(!1);return}await T(e.id,u),await y({silent:!0}),c({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),v()}catch(t){console.error("Error updating start date from records page:",t),f("No se pudo actualizar la fecha de inicio"),c({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{D(!1)}}},[u,e==null?void 0:e.id,R,T,y,c,v]),ne=s.useCallback(async()=>{if(!(e!=null&&e.id)||!z){d();return}D(!0),P(!1);try{await I(e.id,z),await y({silent:!0}),c({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),v()}catch(t){console.error("Error forcing start date from records page:",t),f("No se pudo actualizar la fecha de inicio"),c({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{D(!1),d()}},[e==null?void 0:e.id,z,I,y,c,v,d]),C=s.useCallback(()=>{p(!1),x(null)},[]),le=t=>{x(t),p(!0)},de=t=>{const a=e.data.find(i=>i.id===t);O(a)},ce=s.useCallback(t=>{x(t)},[]),fe=async(t,{keepFormOpen:a=!1}={})=>{S(!0);try{await K(t,M),a||(p(!1),x(null))}catch{c({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{S(!1)}},ue=async()=>{if(g){S(!0);try{await Q(g.id),O(null)}catch{c({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{S(!1)}}};return W&&!(e!=null&&e.id)?o.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:[o.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),o.jsx("p",{className:"text-center text-slate-600 text-lg",children:"Cargando..."})]}):e!=null&&e.id?o.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative",children:[o.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),o.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 relative z-10",children:[o.jsxs(N.div,{className:"flex flex-col sm:flex-row justify-between items-center mb-6",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:[o.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-700 mb-4 sm:mb-0 flex items-center",children:[o.jsx(Ne,{className:"mr-3 h-8 w-8 text-pink-500"}),"Mis Registros"]}),o.jsxs("div",{className:"w-full sm:w-auto justify-center flex gap-2 sm:items-center",children:[o.jsxs(G,{type:"button",variant:"outline",onClick:oe,className:"border-pink-200 text-pink-600 hover:bg-pink-50",disabled:b||A,children:[o.jsx(xe,{className:"mr-2 h-4 w-4"}),"Editar fecha inicio"]}),o.jsxs(G,{type:"button",onClick:()=>{x(null),p(!0)},className:"bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",disabled:b,style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[o.jsx(Ee,{className:"mr-2 h-4 w-4"}),"Añadir registro"]})]})]}),Y&&o.jsx(N.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:o.jsx(ge,{cycle:e,startDate:u,endDate:e.endDate,onStartDateChange:t=>j(t),onSave:re,onCancel:v,isProcessing:A,dateError:Z,includeEndDate:!1,showOverlapDialog:te,overlapCycle:ee,onConfirmOverlap:ne,onCancelOverlap:ie,onClearError:()=>f(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente."})}),o.jsx(N.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.4,delay:.05},className:"mb-5 flex justify-center",children:o.jsx(De,{mode:"single",locale:ke,defaultMonth:r&&w(n(r))?n(r):l==null?void 0:l.to,selected:r&&w(n(r))?n(r):void 0,onDayClick:se,modifiers:ae,className:"w-full max-w-md sm:max-w-lg rounded-2xl border border-pink-100 shadow-sm bg-white/60 backdrop-blur-sm p-3 mx-auto [&_button]:text-slate-900 [&_button:hover]:bg-rose-100 [&_button[aria-selected=true]]:bg-rose-500",classNames:{day_selected:"bg-rose-500 text-white hover:bg-rose-500 hover:text-white focus:bg-rose-500 focus:text-white",day_today:"bg-rose-200 text-rose-700 font-semibold"},modifiersClassNames:{hasRecord:"relative font-semibold after:absolute after:bottom-1.5 after:left-1/2 after:-translate-x-1/2 after:w-1.5 after:h-1.5 after:rounded-full after:bg-rose-500 after:content-['']",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})}),o.jsx(N.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},ref:L,children:o.jsx(be,{records:e.data,onEdit:le,onDelete:de,isProcessing:b,selectedDate:r})})]}),o.jsx(Se,{open:X,onOpenChange:t=>{t?p(!0):C()},children:o.jsx(je,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:o.jsx(ve,{onSubmit:fe,onCancel:C,initialData:M,cycleStartDate:e.startDate,cycleEndDate:e.endDate,isProcessing:b,isEditing:!!M,cycleData:e.data,onDateSelect:ce})})}),o.jsx(we,{isOpen:!!g,onClose:()=>O(null),onConfirm:ue,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:g?`¿Estás seguro de que quieres eliminar el registro del ${B(n(g.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:b})]}):o.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:[o.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),o.jsx("p",{className:"text-center text-slate-600 text-lg",children:"No hay ciclo activo."})]})};export{Ve as default};
