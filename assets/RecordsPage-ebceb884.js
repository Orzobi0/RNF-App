import{c as me,b as he,r as s,p as n,E as y,s as pe,f as B,j as i,m as N,B as G}from"./index-094431a6.js";import{P as xe,C as ge}from"./CycleDatesEditor-ae4b5b89.js";import{R as be}from"./RecordsList-aca1b009.js";import{m as H,e as $,i as J,f as De,D as ve}from"./computePeakStatuses-cc1a8250.js";import{D as ye}from"./DeletionDialog-18caf2a0.js";import{u as we,D as Se,a as je}from"./useCycleData-0b42a521.js";import{P as Ee,e as ke}from"./badge-98f311a3.js";import"./OverlapWarningDialog-800934cb.js";import"./eye-2e9ccd1a.js";import"./input-cce78a3a.js";import"./label-b3767793.js";import"./checkbox-f5e56bc8.js";import"./eye-off-e3755f54.js";const Ne=me("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),Ve=()=>{const{currentCycle:e,addOrUpdateDataPoint:K,deleteRecord:Q,isLoading:W,updateCycleDates:T,checkCycleOverlap:R,forceUpdateCycleStart:A,refreshData:w}=we(),{toast:c}=he(),[X,p]=s.useState(!1),[M,x]=s.useState(null),[g,O]=s.useState(null),[b,S]=s.useState(!1),[Y,I]=s.useState(!1),[u,j]=s.useState(()=>(e==null?void 0:e.startDate)||""),[Z,f]=s.useState(""),[z,U]=s.useState(null),[ee,_]=s.useState(null),[te,P]=s.useState(!1),[q,D]=s.useState(!1),[r,F]=s.useState(null),L=s.useRef(null),V=s.useRef(!1);s.useEffect(()=>{j((e==null?void 0:e.startDate)||"")},[e==null?void 0:e.startDate]);const m=s.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?[...e.data].filter(a=>a==null?void 0:a.isoDate).sort((a,o)=>{const k=n(a.isoDate);return n(o.isoDate)-k}).map(a=>a.isoDate):[]},[e==null?void 0:e.data]);s.useEffect(()=>{if(!m.length){F(null);return}(!r||!m.includes(r))&&F(m[0])},[m,r]),s.useEffect(()=>{r&&L.current&&V.current&&L.current.scrollIntoView({behavior:"smooth",block:"start"})},[r]),s.useEffect(()=>{window.scrollTo({top:0,behavior:"auto"})},[]);const h=s.useMemo(()=>{var t;return(t=e==null?void 0:e.data)!=null&&t.length?e.data.map(a=>{if(!(a!=null&&a.isoDate))return null;const o=n(a.isoDate);return y(o)?o:null}).filter(Boolean):[]},[e==null?void 0:e.data]),E=s.useMemo(()=>new Set(m),[m]),l=s.useMemo(()=>{if(!(e!=null&&e.startDate))return null;const t=n(e.startDate);if(!y(t))return null;let a;if(e!=null&&e.endDate)a=n(e.endDate);else{const o=pe(new Date),k=[t,o];h.length&&k.push(H(h)),a=H(k)}return y(a)?{from:t,to:a}:{from:t,to:t}},[e==null?void 0:e.startDate,e==null?void 0:e.endDate,h]),ae=s.useMemo(()=>{const t={};return l&&(t.outsideCycle=a=>$(a,l.from)||J(a,l.to),t.insideCycleNoRecord=a=>{if($(a,l.from)||J(a,l.to))return!1;const o=B(a,"yyyy-MM-dd");return!E.has(o)}),h.length&&(t.hasRecord=h),t},[l,h,E]),se=s.useCallback((t,a)=>{if(!t)return;const o=B(t,"yyyy-MM-dd");(a!=null&&a.hasRecord||E.has(o))&&(V.current=!0,F(o))},[E]),d=s.useCallback(()=>{U(null),_(null),P(!1)},[]),ie=s.useCallback(()=>{j((e==null?void 0:e.startDate)||""),f(""),d(),I(!0)},[e==null?void 0:e.startDate,d]),v=s.useCallback(()=>{I(!1),f(""),d(),j((e==null?void 0:e.startDate)||"")},[e==null?void 0:e.startDate,d]),oe=s.useCallback(()=>{d()},[d]),re=s.useCallback(async()=>{if(!u){f("La fecha de inicio es obligatoria");return}if(e!=null&&e.id){f(""),D(!0);try{const t=R?await R(e.id,u):null;if(t){U(u),_(t),P(!0),D(!1);return}await T(e.id,u),await w({silent:!0}),c({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),v()}catch(t){console.error("Error updating start date from records page:",t),f("No se pudo actualizar la fecha de inicio"),c({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{D(!1)}}},[u,e==null?void 0:e.id,R,T,w,c,v]),ne=s.useCallback(async()=>{if(!(e!=null&&e.id)||!z){d();return}D(!0),P(!1);try{await A(e.id,z),await w({silent:!0}),c({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),v()}catch(t){console.error("Error forcing start date from records page:",t),f("No se pudo actualizar la fecha de inicio"),c({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{D(!1),d()}},[e==null?void 0:e.id,z,A,w,c,v,d]),C=s.useCallback(()=>{p(!1),x(null)},[]),le=t=>{x(t),p(!0)},de=t=>{const a=e.data.find(o=>o.id===t);O(a)},ce=s.useCallback(t=>{x(t)},[]),fe=async(t,{keepFormOpen:a=!1}={})=>{S(!0);try{await K(t,M),a||(p(!1),x(null))}catch{c({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{S(!1)}},ue=async()=>{if(g){S(!0);try{await Q(g.id),O(null)}catch{c({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{S(!1)}}};return W&&!(e!=null&&e.id)?i.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:[i.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),i.jsx("p",{className:"text-center text-slate-600 text-lg",children:"Cargando..."})]}):e!=null&&e.id?i.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative",children:[i.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),i.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 relative z-10",children:[i.jsx(N.div,{className:"flex flex-col gap-4 mb-6",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:i.jsxs("div",{className:"flex flex-wrap items-center gap-3 justify-between sm:justify-start",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(Ne,{className:"h-8 w-8 text-pink-500"}),i.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-700",children:"Mis Registros"})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs(G,{type:"button",variant:"outline",size:"icon",onClick:ie,className:"border-pink-200 rounded-full text-pink-600 hover:bg-pink-50",disabled:b||q,"aria-label":"Editar fecha de inicio",children:[i.jsx(xe,{className:"h-4 w-4"}),i.jsx("span",{className:"sr-only",children:"Editar fecha de inicio"})]}),i.jsxs(G,{type:"button",size:"icon",onClick:()=>{x(null),p(!0)},className:"rounded-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",disabled:b,style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},"aria-label":"Añadir registro",children:[i.jsx(Ee,{className:"h-4 w-4"}),i.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]})]})}),Y&&i.jsx(N.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:i.jsx(ge,{cycle:e,startDate:u,endDate:e.endDate,onStartDateChange:t=>j(t),onSave:re,onCancel:v,isProcessing:q,dateError:Z,includeEndDate:!1,showOverlapDialog:te,overlapCycle:ee,onConfirmOverlap:ne,onCancelOverlap:oe,onClearError:()=>f(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente."})}),i.jsx(N.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.4,delay:.05},className:"mb-5 flex justify-center",children:i.jsx(De,{mode:"single",locale:ke,defaultMonth:r&&y(n(r))?n(r):l==null?void 0:l.to,selected:r&&y(n(r))?n(r):void 0,onDayClick:se,modifiers:ae,className:"w-full max-w-md sm:max-w-lg rounded-2xl border border-pink-100 shadow-sm bg-white/60 backdrop-blur-sm p-3 mx-auto [&_button]:text-slate-900 [&_button:hover]:bg-rose-100 [&_button[aria-selected=true]]:bg-rose-500",classNames:{day_selected:"border border-rose-500 text-white hover:bg-rose-500 hover:text-white focus:bg-rose-500 focus:text-white",day_today:"bg-rose-200 text-rose-700 font-semibold"},modifiersClassNames:{hasRecord:"relative font-semibold after:absolute after:bottom-1.5 after:left-1/2 after:-translate-x-1/2 after:w-1.5 after:h-1.5 after:rounded-full after:bg-rose-500 after:content-['']",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})}),i.jsx(N.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},ref:L,children:i.jsx(be,{records:e.data,onEdit:le,onDelete:de,isProcessing:b,selectedDate:r})})]}),i.jsx(Se,{open:X,onOpenChange:t=>{t?p(!0):C()},children:i.jsx(je,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:i.jsx(ve,{onSubmit:fe,onCancel:C,initialData:M,cycleStartDate:e.startDate,cycleEndDate:e.endDate,isProcessing:b,isEditing:!!M,cycleData:e.data,onDateSelect:ce})})}),i.jsx(ye,{isOpen:!!g,onClose:()=>O(null),onConfirm:ue,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:g?`¿Estás seguro de que quieres eliminar el registro del ${B(n(g.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:b})]}):i.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 flex items-center justify-center",children:[i.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),i.jsx("p",{className:"text-center text-slate-600 text-lg",children:"No hay ciclo activo."})]})};export{Ve as default};
