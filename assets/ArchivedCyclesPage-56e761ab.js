import{r,j as e,B as L,f as S,p as c,b as le,a as ie,m as H,A as X,L as oe,C as Y,k as ce}from"./index-8c1bb4d0.js";import{D as de,a as ue,b as me,c as xe,d as he,e as fe,u as ge}from"./useCycleData-a1f868e4.js";import{u as pe,P as Z,e as _,B as ve}from"./badge-6bd7af9d.js";import{I as ee}from"./input-6cdf51b4.js";import{O as ye}from"./OverlapWarningDialog-7409f0f1.js";import{D as je}from"./DeletionDialog-dad1e6ec.js";const K=({isOpen:D,onClose:w,onConfirm:P,initialStartDate:A,initialEndDate:v,includeEndDate:x=!0,title:V="Editar Fechas del Ciclo",description:W,cycleId:I,checkOverlap:F,errorMessage:E,conflictCycle:h,onResetError:y})=>{const[t,T]=r.useState(A||""),[l,k]=r.useState(v||""),[$,j]=r.useState(""),[i,b]=r.useState(null),[m,M]=r.useState(null),[u,f]=r.useState(!1);pe(D,w),r.useEffect(()=>{T(A||""),k(v||"")},[A,v]);const B=()=>{if(!h)return null;const n=g=>{if(!g)return null;try{return S(c(g),"dd/MM/yyyy")}catch(N){return console.error("Error formatting conflict date",N),g}},C=n(h.startDate)??"sin fecha de inicio",U=h.endDate?n(h.endDate):"en curso";return`Conflicto con el ciclo del ${C} al ${U}.`},R=()=>{j(""),y&&y()},O=n=>{T(n),R()},q=n=>{k(n),j(""),y&&y()},z=B(),J=async()=>{if(x&&!l){j("La fecha de fin es obligatoria");return}if(x&&t&&l&&l<t){j("La fecha de fin no puede ser anterior al inicio");return}const n=x?{startDate:t,endDate:l}:{startDate:t};if(F&&I&&t){const C=await F(I,t,x&&l||void 0);if(C){b(C),M(n),f(!0);return}}P(n)};return e.jsxs(e.Fragment,{children:[e.jsx(de,{open:D,onOpenChange:w,children:e.jsxs(ue,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(me,{children:[e.jsx(xe,{children:V}),e.jsx(he,{className:"text-gray-600",children:W??(x?"Modifica la fecha de inicio y fin del ciclo.":"Modifica la fecha de inicio del ciclo.")})]}),(E||h)&&e.jsxs("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[e.jsx("p",{className:"font-semibold text-red-800",children:"No se pudo guardar el ciclo"}),E&&e.jsx("p",{className:"mt-1",children:E}),z&&e.jsx("p",{className:"mt-1",children:z}),e.jsx("p",{className:"mt-3 text-xs text-red-600",children:"Ajusta las fechas para que no se superpongan con ciclos existentes."})]}),e.jsxs("div",{className:"my-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Inicio del ciclo"}),e.jsx(ee,{id:"startDate",type:"date",value:t,onChange:n=>O(n.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),x&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"text-gray-700 text-sm",children:"Fin del ciclo"}),e.jsx(ee,{id:"endDate",type:"date",value:l||"",onChange:n=>q(n.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"}),$&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:$})]})]}),e.jsxs(fe,{className:"sm:justify-end",children:[e.jsx(L,{variant:"outline",onClick:w,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(L,{variant:"primary",onClick:J,className:"bg-pink-600 hover:bg-pink-700 text-white",children:"Guardar"})]})]})}),e.jsx(ye,{isOpen:u,conflictCycle:i,onCancel:()=>f(!1),onConfirm:()=>{f(!1),m&&P({...m,force:!0})}})]})},Me=()=>{const{currentCycle:D,archivedCycles:w,isLoading:P,addArchivedCycle:A,updateCycleDates:v,deleteCycle:x,checkCycleOverlap:V,forceUpdateCycleStart:W,forceShiftNextCycleStart:I}=ge(),{toast:F}=le(),E=ie(),[h,y]=r.useState(!1),[t,T]=r.useState(null),[l,k]=r.useState(null),[$,j]=r.useState(!1),[i,b]=r.useState(null),[m,M]=r.useState(null),u=r.useRef(null),f=r.useRef(!1),B=s=>{if(!s)return"Las fechas ingresadas se superponen con otro ciclo.";const a=p=>{if(!p)return null;try{return S(c(p),"dd/MM/yyyy")}catch(G){return console.error("Error parsing conflict date",G),p}},d=a(s.startDate)??"sin fecha de inicio",o=s.endDate?a(s.endDate):"en curso";return`Las fechas ingresadas se superponen con el ciclo del ${d} al ${o}.`},R=()=>{b(null),y(!0)},O=()=>{y(!1),b(null)},q=async({startDate:s,endDate:a})=>{try{await A(s,a),O()}catch(d){const o=d.code==="cycle-overlap"?B(d.conflictCycle):"No se pudo crear el ciclo.";b({message:o,conflictCycle:d.conflictCycle||null})}},z=async({startDate:s,endDate:a,force:d})=>{if(t)try{const o=t.startDate,p=t.endDate,G=s!==void 0&&s!==o,ae=a!==void 0&&a!==p,re=G&&o&&s&&c(s)<c(o),ne=G?s:o,Q=ae?a:p;d&&re?(await W(t.id,s),a!==void 0&&await v(t.id,void 0,a)):d&&Q?(await I(t.id,Q,ne),await v(t.id,s,a)):await v(t.id,s,a),T(null),M(null)}catch(o){const p=o.code==="cycle-overlap"?B(o.conflictCycle):"No se pudieron actualizar las fechas.";M({message:p,conflictCycle:o.conflictCycle||null})}},J=s=>{k(s)},n=async()=>{if(l){j(!0);try{await x(l.id),F({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),k(null)}catch(s){console.error("Error deleting archived cycle:",s)}finally{j(!1)}}},C=s=>{E(s.isCurrent?"/":`/cycle/${s.id}`)},U=s=>{f.current=!1,u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{f.current=!0,J(s)},1500)},g=(s,a=!0)=>{u.current&&(clearTimeout(u.current),u.current=null),!f.current&&a&&C(s)};r.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]);const N=D.id?[{...D,isCurrent:!0,needsCompletion:!D.endDate},...w]:w,se=N&&N.length>0;if(P&&!se)return e.jsxs("div",{className:"relative flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"text-center text-slate-600 p-8",children:"Cargando ciclos archivados..."})]});if(!N||N.length===0)return e.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"flex flex-1 items-center justify-center px-4",children:e.jsx(H.div,{className:"text-center text-slate-600 flex flex-col items-center max-w-md",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"bg-white/70 backdrop-blur-md rounded-3xl p-8 border border-pink-200/50 shadow-lg",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center",children:e.jsx(X,{className:"w-10 h-10 text-pink-500"})}),e.jsx("h2",{className:"text-2xl font-semibold text-slate-700 mb-4",children:"No hay ciclos archivados"}),e.jsx("p",{className:"text-slate-600 mb-8",children:"Cuando inicies un nuevo ciclo, el anterior aparecerá aquí."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(L,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",children:e.jsx(oe,{to:"/",children:"Volver al Ciclo Actual"})}),e.jsxs(L,{onClick:R,className:"bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white shadow-lg",children:[e.jsx(Z,{className:"mr-2 h-4 w-4"})," Crear Ciclo"]})]})]})})}),e.jsx(K,{isOpen:h,onClose:O,onConfirm:q,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:i==null?void 0:i.message,conflictCycle:i==null?void 0:i.conflictCycle,onResetError:()=>b(null)})]});const te=[...N].sort((s,a)=>c(a.startDate)-c(s.startDate));return e.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 py-6 relative z-10",children:[e.jsxs(H.div,{className:"flex flex-col sm:flex-row justify-between items-center mb-8",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-700 mb-4 sm:mb-0 flex items-center",children:[e.jsx(X,{className:"mr-3 h-8 w-8 text-pink-500"}),"Mis Ciclos"]}),e.jsxs(L,{onClick:R,className:"rounded-3xl bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(Z,{className:"mr-2 h-4 w-4"})," Añadir Ciclo"]})]}),e.jsx(H.div,{className:"space-y-3",variants:{hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"show",children:te.map(s=>{const a=s.endDate?S(c(s.endDate),"dd/MM/yyyy",{locale:_}):"En curso",d=s.data?s.data.length:0;return e.jsx(H.button,{type:"button",className:"w-full bg-white/80 backdrop-blur-md border border-pink-200/50 shadow-lg hover:shadow-xl transition-all duration-300 hover:bg-white/90 rounded-3xl active:scale-[0.98] cursor-pointer select-none",variants:{hidden:{opacity:0,y:20},show:{opacity:1,y:0}},onMouseDown:()=>U(s),onMouseUp:()=>g(s),onMouseLeave:()=>g(s,!1),onTouchStart:()=>U(s),onTouchEnd:()=>g(s),onTouchMove:()=>g(s,!1),onClick:o=>{o.preventDefault(),f.current||C(s)},children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Y,{className:"w-6 h-6 text-pink-600"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center flex-wrap gap-2 mb-1.5",children:e.jsxs("h2",{className:"text-lg font-semibold text-slate-700",children:[S(c(s.startDate),"dd/MM/yyyy",{locale:_})," - ",a]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-2 text-sm text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ce,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[d," registro",d!==1?"s":""]})]}),s.endDate&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Y,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[Math.ceil((c(s.endDate)-c(s.startDate))/(1e3*60*60*24))+1," días"]})]}),s.isCurrent&&e.jsx(ve,{className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white text-xs",children:"Ciclo actual"})]})]})]})})},s.id)})})]}),e.jsx(K,{isOpen:h,onClose:O,onConfirm:q,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:i==null?void 0:i.message,conflictCycle:i==null?void 0:i.conflictCycle,onResetError:()=>b(null)}),e.jsx(K,{isOpen:!!t,onClose:()=>{T(null),M(null)},onConfirm:z,initialStartDate:t==null?void 0:t.startDate,initialEndDate:t==null?void 0:t.endDate,cycleId:t==null?void 0:t.id,checkOverlap:V,title:"Editar Fechas del Ciclo",description:"Actualiza las fechas del ciclo.",errorMessage:m==null?void 0:m.message,conflictCycle:m==null?void 0:m.conflictCycle,onResetError:()=>M(null)}),e.jsx(je,{isOpen:!!l,onClose:()=>k(null),onConfirm:n,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:l?`¿Estás seguro de que quieres eliminar el ciclo ${S(c(l.startDate),"dd/MM/yyyy")} - ${l.endDate?S(c(l.endDate),"dd/MM/yyyy"):"En curso"}? Esta acción no se puede deshacer.`:"",isProcessing:$})]})};export{Me as default};
