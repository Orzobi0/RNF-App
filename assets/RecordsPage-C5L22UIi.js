import{c as mt,r as n,g as y,f as u,j as a,H as D,B as ct,K as ea,S,Q as Le,l as j,u as Va,b as Ua,V as Ya,n as Xa,m as ge}from"./index-DKDve1bt.js";import{L as dt,T as qa,a as Wa,N as Ga,P as Ka,C as Qa}from"./PostpartumExitDialog-Cpj4GPqp.js";import{T as Za,e as Ja,d as es,b as ts,m as Wt,f as ye,g as as,A as ss,h as rs,D as ns}from"./DataEntryForm-BA2ItfuX.js";import{l as De,P as os}from"./badge-Bv0PJFOO.js";import{a as ls,H as is,D as cs}from"./DeletionDialog-CF9wx8xT.js";import{u as ds,D as us,a as ms}from"./useCycleData-B59yyua_.js";import{c as fs,F as Gt,i as Fe}from"./computePeakStatuses-DDireWCn.js";import"./OverlapWarningDialog-BdysBLfz.js";import"./input-3y406qNm.js";import"./label-CjCq2AfR.js";import"./eye-B04h8Q7I.js";const Kt=mt("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),ps=mt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),hs=mt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),xs=({isoDate:d,cycleDay:w,details:o,peakStatus:b,isPeakDay:k,onEdit:m,onDelete:T,onAdd:M,onToggleRelations:ve,isProcessing:E})=>{const Oe=!!o?.record,Ce=n.useMemo(()=>{if(!d)return null;try{return y(u(d),"dd/MM/yyyy",{locale:De})}catch{return null}},[d]),ue=o?.symbolInfo?.label||"Sin símbolo",Pe=o?.symbolInfo?.value||"none",$e=o?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",Se=()=>{!o?.record||!m||m(o.record,null)},Q=()=>{!o?.record?.id||!T||T(o.record.id)},ze=()=>{!d||!M||M(d)},F=(N,r=null)=>{if(o?.record&&m){m(o.record,N,r);return}d&&M&&M(d,N,r)},He=()=>{!d||!ve||ve(d)},H=(N,r={})=>N&&typeof N=="string"&&N.trim().length>0||typeof N=="number"?N:r.placeholder||"—",Be=o?.hasTemperature?`${o.displayTemp} °C`:"—",Ve=o?.timeValue||"—",Ue=!!o?.timeValue,Ye=o?.hasMucusSensation?o.mucusSensation:"—",Xe=o?.hasMucusAppearance?o.mucusAppearance:"—",Ne=o?.observationsText?.trim(),Z=!!o?.hasRelations;let J=null,me=null;b&&(b==="P"||k?(J="Día pico",me="peak"):(J=`+${b}`,me="post-peak"));const qe=()=>{switch(Pe){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!d)return a.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const B="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return a.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Ce,w?` · Día ${w}`:""]}),J&&a.jsx("span",{className:D("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:J})]}),a.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[a.jsx("button",{type:"button",onClick:()=>F("symbol","fertilitySymbol"),className:D("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",qe(),$e),title:ue,"aria-label":ue}),Oe?a.jsxs(a.Fragment,{children:[a.jsxs(ct,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Se,disabled:E,children:[E?a.jsx(dt,{className:"h-4 w-4 animate-spin"}):a.jsx(hs,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Editar registro"})]}),a.jsxs(ct,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Q,disabled:E,children:[E?a.jsx(dt,{className:"h-4 w-4 animate-spin"}):a.jsx(qa,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):a.jsxs(ct,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:ze,disabled:E,children:[E&&a.jsx(dt,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),a.jsxs("div",{className:"mt-4 space-y-3",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("temperature","temperature"),className:D(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[a.jsx(Za,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"font-semibold",children:H(Be)}),o?.showCorrectedIndicator&&a.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),a.jsxs("button",{type:"button",onClick:()=>F("temperature","time"),className:D(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ue?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[a.jsx(Ja,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:H(Ve)})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("sensation","mucusSensation"),className:D(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[a.jsx(es,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:H(Ye)})]}),a.jsxs("button",{type:"button",onClick:()=>F("appearance","mucusAppearance"),className:D(B,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[a.jsx(ts,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"font-semibold",children:H(Xe)})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>F("observations","observations"),className:D(B,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ne?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[a.jsx(ps,{className:"h-5 w-5 shrink-0 opacity-80"}),a.jsx("span",{className:"truncate",children:H(Ne,{placeholder:"-"})})]}),a.jsx("button",{type:"button",onClick:He,disabled:E,className:D("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Z?"border-rose-50 bg-rose-50":"border-slate-200 bg-white",E&&"opacity-70 cursor-not-allowed"),title:Z?"Hubo relaciones":"Sin relaciones","aria-label":Z?"Hubo relaciones":"Sin relaciones",children:a.jsx(ea,{className:D("h-4 shrink-0 w-4",Z?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},ta=d=>d.replace(".","").toLowerCase(),be=d=>ta(y(d,"MMM",{locale:De})),gs=d=>ta(y(d,"d MMM yyyy",{locale:De})),ys=({startDate:d,endDate:w})=>{if(!w){if(!d)return"Mis registros";const M=u(d);return S(M)?`${gs(M)} - actualidad`:"Mis registros"}if(!d)return"Mis registros";const o=u(d),b=u(w);if(!S(o)||!S(b))return"Mis registros";const k=o.getFullYear()===b.getFullYear();if(k&&o.getMonth()===b.getMonth())return`${o.getDate()}–${b.getDate()} ${be(o)} ${o.getFullYear()}`;if(k)return`${o.getDate()} ${be(o)} – ${b.getDate()} ${be(b)} ${o.getFullYear()}`;const T=`${o.getFullYear()}–${String(b.getFullYear()).slice(-2)}`;return`${o.getDate()} ${be(o)} – ${b.getDate()} ${be(b)} · ${T}`},bs=({startDate:d,endDate:w,recordCount:o=0,referenceDate:b=new Date})=>{if(!d)return`${o} registros`;const k=u(d);if(!S(k))return`${o} registros`;if(!w)return`Día ${Le(j(b),j(k))+1} · ${o} registros`;const m=u(w);return S(m)?`${Le(j(m),j(k))+1} días · ${o} registros`:`${o} registros`},ws=d=>Gt.find(w=>w.value===d)||Gt[0],Qt=10,ut=60,Zt=750,Jt=120,Ds=85,vs=5,we=180,Cs=d=>{if(d==null||d==="")return null;const w=Number(typeof d=="string"?d.replace(",","."):d);return Number.isFinite(w)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(w):null},Ss=({cycle:d,headerTitle:w,headerIcon:o=Kt,headerActions:b,topAccessory:k,includeEndDate:m=!1,addOrUpdateDataPoint:T,deleteRecord:M,isLoading:ve,updateCycleDates:E,checkCycleOverlap:Oe,forceShiftNextCycleStart:Ce,forceUpdateCycleStart:ue,startNewCycle:Pe,refreshData:$e,afterRecordsContent:Se=null,onRequestDeleteCycle:Q=null,dateEditorDeleteTitle:ze="Eliminar ciclo",dateEditorDeleteDescription:F="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:He="Eliminar ciclo",isDeletingCycle:H=!1}={})=>{const{currentCycle:Be,addOrUpdateDataPoint:Ve,deleteRecord:Ue,isLoading:Ye,updateCycleDates:Xe,checkCycleOverlap:Ne,forceUpdateCycleStart:Z,forceShiftNextCycleStart:J,startNewCycle:me,refreshData:qe}=ds(),{preferences:B,savePreferences:N}=Va(),r=d??Be,aa=ve??Ye,We=T||(async(e,t)=>{if(r?.id)return Ve(e,t,r.id)}),sa=M||(async e=>{if(r?.id)return Ue(e,r.id)}),je=E||(async(e,t,s)=>Xe(e??r?.id,t,s)),Ge=Oe??Ne,ft=ue||(async(e,t)=>Z(e??r?.id,t)),Ke=Ce||(async(e,t,s)=>J(e??r?.id,t,s)),ra=Pe??me,ke=$e??qe,{toast:R}=Ua(),[na,V]=n.useState(!1),[Qe,ee]=n.useState(null),[te,Ze]=n.useState(null),[ae,se]=n.useState(!1),[oa,pt]=n.useState(!1),[U,Me]=n.useState(()=>r?.startDate||""),[Y,Ee]=n.useState(()=>r?.endDate||""),[la,L]=n.useState(""),[O,ht]=n.useState(null),[Je,xt]=n.useState(null),[et,gt]=n.useState(!1),[ia,yt]=n.useState(null),[ca,tt]=n.useState(!1),[at,fe]=n.useState(!1),[h,X]=n.useState(null),[da,q]=n.useState(null),[ua,pe]=n.useState(null),[ma,re]=n.useState(null),[fa,st]=n.useState(!1),[pa,rt]=n.useState(!1),bt=r?.data?.length??0,wt=!r?.endDate,ha=n.useCallback(async()=>{rt(!1),typeof N=="function"&&await N({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[N]),xa=n.useMemo(()=>w||ys({startDate:r?.startDate,endDate:r?.endDate}),[r?.endDate,r?.startDate,w]),Dt=n.useMemo(()=>bs({startDate:r?.startDate,endDate:r?.endDate,recordCount:bt}),[r?.endDate,r?.startDate,bt]),vt=!0,Re=n.useRef(null),Ct=n.useRef(null),St=n.useRef(0),[Nt,jt]=n.useState(0),_e=n.useCallback(()=>{const e=Re.current;if(!e){St.current=0,jt(0);return}const s=e.getBoundingClientRect().height;St.current=s,jt(l=>Math.abs(l-s)>.5?s:l)},[]);n.useLayoutEffect(()=>{let e=window.requestAnimationFrame(_e);const t=()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)};window.addEventListener("resize",t);let s;return typeof ResizeObserver<"u"&&(s=new ResizeObserver(()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(_e)}),Re.current&&s.observe(Re.current)),()=>{window.removeEventListener("resize",t),s&&s.disconnect(),e&&window.cancelAnimationFrame(e)}},[_e]);const kt=n.useMemo(()=>Math.max(Math.round(Nt+Qt),Qt),[Nt]);n.useEffect(()=>{Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate]);const Ae=n.useMemo(()=>r?.data?.length?[...r.data].filter(e=>e?.isoDate).sort((e,t)=>{const s=u(e.isoDate);return u(t.isoDate)-s}).map(e=>e.isoDate):[],[r?.data]);n.useEffect(()=>{const e=Ct.current;e&&e.scrollTo({top:0,behavior:"auto"})},[]);const ne=n.useMemo(()=>r?.data?.length?r.data.map(e=>{if(!e?.isoDate)return null;const t=u(e.isoDate);return S(t)?t:null}).filter(Boolean):[],[r?.data]),Mt=n.useMemo(()=>new Set(Ae),[Ae]),W=n.useMemo(()=>fs(r?.data??[]),[r?.data]),oe=n.useMemo(()=>{const e=new Map;return r?.data?.length&&r.data.forEach(t=>{if(!t?.isoDate)return;const s=t.measurements?.find(Ba=>Ba?.selected)||(t.temperature_chart||t.temperature_raw?{temperature:t.temperature_chart??t.temperature_raw,temperature_corrected:t.temperature_corrected??null,time:t.timestamp?y(u(t.timestamp),"HH:mm"):null,use_corrected:t.use_corrected??!1}:null),l=s?.use_corrected??t.use_corrected??!1,c=s?.temperature_corrected??t.temperature_corrected??null,i=s?.temperature??t.temperature_chart??t.temperature_raw??null,p=Cs(l&&c!==null&&c!==void 0&&c!==""?c:i??c),g=p!==null,C=l&&c!==null&&c!==void 0&&c!=="";let x=null;s?.time?x=s.time:t.timestamp&&S(u(t.timestamp))&&(x=y(u(t.timestamp),"HH:mm"));const _=t.mucusSensation??t.mucus_sensation??"",ce=t.mucusAppearance??t.mucus_appearance??"",de=!!_,z=!!ce,it=de||z,xe=t.observations||"",Te=!!xe,$a=!!(t.had_relations??t.hadRelations??!1),qt=W[t.isoDate]||null,za=t.peak_marker==="peak"||qt==="P",Ha=ws(t.fertility_symbol);e.set(t.isoDate,{record:t,symbolInfo:Ha,hasTemperature:g,displayTemp:p,showCorrectedIndicator:C,timeValue:x,hasMucus:it,hasMucusSensation:de,hasMucusAppearance:z,mucusSensation:_,mucusAppearance:ce,hasObservations:Te,observationsText:xe,hasRelations:$a,peakStatus:qt,isPeakDay:za})}),e},[r?.data,W]),f=n.useMemo(()=>{if(!r?.startDate)return null;const e=u(r.startDate);if(!S(e))return null;let t;if(r?.endDate)t=u(r.endDate);else{const s=j(new Date),l=[e,s];ne.length&&l.push(Wt(ne)),t=Wt(l)}return S(t)?{from:e,to:t}:{from:e,to:e}},[r?.startDate,r?.endDate,ne]),ga=n.useMemo(()=>{const e={};return f&&(e.outsideCycle=t=>ye(t,f.from)||Fe(t,f.to),e.insideCycleNoRecord=t=>{if(ye(t,f.from)||Fe(t,f.to))return!1;const s=y(t,"yyyy-MM-dd");return!Mt.has(s)}),ne.length&&(e.hasRecord=ne),e},[f,ne,Mt]),ya=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:D(Ya({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[Et,nt]=n.useState(()=>h&&S(u(h))?u(h):f?.to?f.to:j(new Date)),he=n.useRef(!1),A=n.useRef(null),ba=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),G=n.useRef(null),Rt=n.useRef(null),_t=n.useRef(null),At=n.useRef(0),[wa,Da]=n.useState(0),[It,Tt]=n.useState(!1),P=n.useCallback(e=>{At.current=e,Da(e)},[]),Ft=n.useCallback(()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(e)})}),[]),le=n.useCallback((e,{duration:t=we}={})=>{A.current&&(cancelAnimationFrame(A.current),A.current=null);const s=At.current,l=e-s;return Math.abs(l)<.5||t<=0?(P(e),Promise.resolve()):new Promise(c=>{const i=g=>1-Math.pow(1-g,3),v=performance.now(),p=g=>{const C=g-v,x=Math.min(1,C/t),_=s+l*i(x);if(P(_),x<1){A.current=requestAnimationFrame(p);return}A.current=null,c()};A.current=requestAnimationFrame(p)})},[P]),va=n.useMemo(()=>({labelDay:e=>{const t=y(e,"yyyy-MM-dd"),s=oe.get(t),l=y(e,"d MMM",{locale:De}),c=s?.peakStatus??W[t]??null,i=[];if(s?.hasTemperature&&s?.hasMucus?i.push("temperatura y moco"):s?.hasTemperature?i.push("temperatura"):s?.hasMucus&&i.push("moco"),s?.hasRelations&&i.push("RS"),c){const v=c==="P"?"pico ✖":`pico +${c}`;i.push(v)}return i.length?`${l}: ${i.join("; ")}`:l}}),[W,oe]),Ca=n.useCallback(({date:e,activeModifiers:t})=>{const s=y(e,"yyyy-MM-dd"),l=oe.get(s),c=l?.hasTemperature??!1,i=l?.hasMucus??!1,v=l?.hasRelations??!1,p=l?.peakStatus??W[s]??null,g=l?.symbolInfo,C=g?.value,x=t.selected,_=t.today,ce=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",c?"bg-amber-500":"bg-transparent",c&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),de=D("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",i?"bg-teal-500":"bg-transparent",i&&x?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),z=!!(C&&C!=="none"),it=D("relative z-10 text-[1.15rem] leading-none",t.outside||t.outsideCycle?"text-slate-300":x?z?"text-white":"text-fertiliapp-fuerte":_?"text-subtitulo font-semibold":"text-slate-700"),xe=p==="P"?"✖":p?`+${p}`:null,Te=z?D("pointer-events-none absolute inset-0 rounded-full transition-opacity",g?.color??"",g?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",C==="white"?"ring-1 ring-slate-300/70":"",x?"opacity-50":"opacity-25"):null;return a.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[a.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[_&&!x&&!(t.outside||t.outsideCycle)&&a.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),x&&a.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[2px] rounded-full bg-tarjeta border-2 border-fertiliapp-fuerte"}),Te&&a.jsx("span",{className:Te,"aria-hidden":"true"}),a.jsx("span",{className:it,children:y(e,"d")}),v&&a.jsx(ea,{"aria-hidden":"true",className:"pointer-events-none absolute -bottom-[0.2px] -right-[0.2px] h-2 w-2 text-rose-500 fill-current"})]}),a.jsxs("div",{className:"mt-[0.2rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[a.jsx("span",{className:ce}),a.jsx("span",{className:de})]}),xe&&a.jsx("span",{"aria-hidden":"true",className:D("pointer-events-none absolute -top-[1px] right-[0.5px] rounded-sm px-[2px] text-[0.75rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",x?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:xe})]})},[W,oe]),$=n.useMemo(()=>{if(!r?.startDate)return[];const e=u(r.startDate);if(!S(e))return[];const t=j(e),s=j(new Date);let l=f?.to?j(f.to):s;Fe(l,s)&&(l=s),ye(l,t)&&(l=t);const c=Le(l,t)+1;if(c<=0)return[];const i=[];for(let v=c-1;v>=0;v-=1){const p=Xa(t,v),g=y(p,"yyyy-MM-dd"),C=Le(p,t)+1,x=oe.get(g)||null;i.push({isoDate:g,date:p,cycleDay:C,details:x})}return i},[r?.startDate,f,oe]),ie=n.useMemo(()=>new Set($.map(e=>e.isoDate)),[$]),Sa=n.useMemo(()=>{const e=new Map;return $.forEach(t=>{e.set(t.isoDate,t)}),e},[$]),Lt=h&&Sa.get(h)||null,ot=Lt?.details??null,Ot=ot?.peakStatus??(h?W[h]??null:null),Na=ot?.isPeakDay??Ot==="P",Ie=n.useMemo(()=>{if(!f)return null;const e=f?.to?y(j(f.to),"yyyy-MM-dd"):null,t=f?.from?y(j(f.from),"yyyy-MM-dd"):null;if(!r?.endDate){const s=y(j(new Date),"yyyy-MM-dd");if(ie.has(s))return s}return e&&ie.has(e)?e:t&&ie.has(t)?t:Ae[0]??null},[r?.endDate,f,ie,Ae]);n.useEffect(()=>{if(!(h&&ie.has(h))){if(!Ie){h!==null&&X(null);return}h!==Ie&&X(Ie)}},[h,ie,Ie]);const Pt=n.useCallback(e=>{if(!e)return;const t=y(e,"yyyy-MM-dd");f&&(ye(e,f.from)||Fe(e,f.to))||X(t)},[f]);n.useEffect(()=>{if(!h)return;const e=u(h);S(e)&&nt(t=>t&&t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()?t:e)},[h]);const $t=n.useCallback(e=>{nt(t=>{const s=t??f?.to??j(new Date);return as(s,e==="next"?1:-1)})},[f]);n.useEffect(()=>{const e=Rt.current;if(!e)return;const t=e.querySelector(".records-calendar-day-grid");t&&(_t.current=t)},[Et,vt,P]);const lt=n.useCallback(async e=>{if(he.current)return;he.current=!0;const s=_t.current?.getBoundingClientRect()?.width??0,l=e==="next"?-Jt:Jt,c=s?e==="next"?-s:s:l,i=-c;try{await le(c,{duration:we}),$t(e),P(i),await Ft(),await le(0,{duration:we})}finally{he.current=!1}},[le,$t,P,Ft]),I=n.useCallback(()=>{ht(null),xt(null),gt(!1),yt(null),tt(!1)},[]);n.useEffect(()=>()=>{A.current&&(cancelAnimationFrame(A.current),A.current=null),G.current&&(G.current(),G.current=null)},[]);const zt=n.useCallback(()=>{Me(r?.startDate||""),Ee(r?.endDate||""),L(""),I(),pt(!0)},[r?.startDate,r?.endDate,I]),K=n.useCallback(()=>{pt(!1),L(""),I(),Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate,I]),ja=n.useCallback(()=>{Q&&(K(),Q())},[K,Q]),ka=n.useCallback(e=>{if(he.current||e.pointerType==="mouse"&&e.button!==0)return;const t=e.target.closest(".records-calendar-day-grid");if(!t)return;const s=ba.current;s.active=!0,s.pointerId=e.pointerId,s.startX=e.clientX,s.startTime=performance.now(),s.dragging=!1;const l=t.getBoundingClientRect().width||0;s.gridWidth=l,s.swipeThreshold=l?Math.max(ut,l*.25):ut;const c=p=>{if(!s.active||p.pointerId!==s.pointerId)return;const g=p.clientX-s.startX;if(!s.dragging&&Math.abs(g)>vs&&(s.dragging=!0,Tt(!0)),!s.dragging)return;const C=s.gridWidth?s.gridWidth*.7:Ds,x=Math.max(-C,Math.min(C,g));p.preventDefault(),P(x)},i=async p=>{if(!s.active||p.pointerId!==s.pointerId)return;G.current?.(),G.current=null,s.active=!1;const g=p.clientX-s.startX,C=performance.now()-s.startTime,x=C>0?g/C*1e3:0,_=s.swipeThreshold||ut,ce=g<=-_||x<=-Zt,de=g>=_||x>=Zt,z=s.dragging;if(s.dragging=!1,Tt(!1),he.current){await le(0,{duration:we});return}if(z&&ce){await lt("next");return}if(z&&de){await lt("prev");return}await le(0,{duration:we})},v=()=>{window.removeEventListener("pointermove",c,{capture:!0}),window.removeEventListener("pointerup",i,{capture:!0}),window.removeEventListener("pointercancel",i,{capture:!0})};G.current?.(),G.current=v,window.addEventListener("pointermove",c,{capture:!0,passive:!1}),window.addEventListener("pointerup",i,{capture:!0}),window.addEventListener("pointercancel",i,{capture:!0})},[lt,le,vt,P]),Ma=n.useCallback(()=>{I()},[I]),Ea=n.useCallback(async()=>{if(!U){L("La fecha de inicio es obligatoria");return}if(m&&Y&&Y<U){L("La fecha de fin no puede ser anterior al inicio");return}if(r?.id){L(""),fe(!0);try{const e=Ge?await Ge(r.id,U,m&&Y||void 0):null;if(e){ht(U),xt((m&&Y||void 0)??null),gt(!!m),yt(e),tt(!0),fe(!1);return}await je(r.id,U,m&&Y||void 0),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),K()}catch(e){console.error("Error updating start date from records page:",e),L("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{fe(!1)}}},[U,Y,m,r?.id,Ge,je,ke,R,K]),Ra=n.useCallback(async()=>{if(!r?.id||!O){I();return}fe(!0),tt(!1);try{const e=r.startDate,t=r.endDate??void 0,s=O!==e,l=s&&O&&e&&ye(u(O),u(e)),c=et?Je??void 0:void 0,i=et&&Je!==null&&c!==t;if(l&&await ft(r.id,O),i&&c&&Ke){const v=s?O:e;await Ke(r.id,c,v)}await je(r.id,s?O:void 0,c),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),K()}catch(e){console.error("Error adjusting cycle dates from records page:",e),L("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{fe(!1),I()}},[r?.id,r?.startDate,r?.endDate,O,et,Je,ft,Ke,je,ke,R,K,I]),Ht=n.useCallback(()=>{V(!1),ee(null),q(null),pe(null),re(null)},[]),Bt=n.useCallback((e,t=null,s=null)=>{e&&(ee(e),q(e.isoDate??null),pe(t),re(s??null),e.isoDate&&X(e.isoDate),V(!0))},[]),_a=n.useCallback((e,t=null,s=null)=>Bt(e,s,t),[Bt]),Aa=e=>{const t=r?.data?.find(s=>s.id===e);Ze(t||null)},Ia=n.useCallback(e=>{ee(e)},[]),Ta=n.useCallback((e,t=null,s=null)=>{e&&(X(e),ee(null),q(e),pe(s),re(t),V(!0))},[]),Vt=n.useCallback(()=>{const e=$.length?$[0].isoDate:r?.startDate||null,t=h||e||null;ee(null),q(t),pe(null),re(null),t&&X(t),V(!0)},[$,r?.startDate,h]),Ut=n.useCallback((e,t={})=>{const s=r?.data?.find(i=>i.isoDate===e)||null,l=s?.timestamp&&S(u(s.timestamp))?y(u(s.timestamp),"HH:mm"):y(new Date,"HH:mm"),c=s?.measurements?.length?s.measurements.map((i,v)=>{const p=i?.time||(i?.timestamp&&S(u(i.timestamp))?y(u(i.timestamp),"HH:mm"):l);return{temperature:i?.temperature??i?.temperature_raw??"",temperature_corrected:i?.temperature_corrected??"",time:p,time_corrected:i?.time_corrected||p,use_corrected:!!i?.use_corrected,selected:!!(i?.selected??v===0)}}):[{temperature:"",temperature_corrected:"",time:l,time_corrected:l,use_corrected:!1,selected:!0}];return{isoDate:e,measurements:c,mucusSensation:s?.mucusSensation??s?.mucus_sensation??"",mucusAppearance:s?.mucusAppearance??s?.mucus_appearance??"",fertility_symbol:s?.fertility_symbol??s?.fertilitySymbol??"none",observations:s?.observations??"",peak_marker:s?.peak_marker??null,ignored:s?.ignored??!1,...t}},[r?.data]),Fa=async(e,{keepFormOpen:t=!1}={})=>{se(!0);try{await We(e,Qe),t||(V(!1),ee(null),q(null),pe(null),re(null))}catch{R({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{se(!1),t&&q(e?.isoDate??null)}},La=n.useCallback(async e=>{if(!e)return;const t=r?.data?.find(c=>c.isoDate===e)||null,s=!!(t?.had_relations??t?.hadRelations??!1),l=Ut(e,{had_relations:!s,hadRelations:!s});se(!0);try{await We(l,t)}catch{R({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{se(!1)}},[We,Ut,r?.data,R]),Oa=async()=>{if(te){se(!0);try{const e=te.isoDate;await sa(te.id),Ze(null),q(null),e&&h===e&&X(e)}catch{R({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{se(!1)}}},Yt={openDateEditor:zt,openAddRecord:Vt,isProcessing:ae,isUpdatingDates:at,cycle:r},Pa=typeof b=="function"?b(Yt):a.jsxs(a.Fragment,{children:[a.jsxs(ls,{type:"button",onClick:zt,className:"text-subtitulo",disabled:ae||at,"aria-label":m?"Editar fechas del ciclo":"Editar fecha de inicio",children:[a.jsx(Wa,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:m?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),a.jsxs(is,{type:"button",onClick:Vt,disabled:ae,"aria-label":"Añadir registro",children:[a.jsx(os,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),Xt=typeof k=="function"?k({...Yt}):k??null;return aa&&!r?.id?a.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:a.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):r?.id?a.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[a.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[a.jsx("div",{ref:Re,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:a.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:a.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[a.jsx(ge.div,{className:"flex flex-col gap-2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:a.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/50 p-3 shadow-sm backdrop-blur-md",children:a.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[a.jsxs("div",{className:"flex items-center justify-between gap-2 text-[10px] uppercase tracking-[0.18em] text-base",children:[a.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[Xt&&a.jsx("div",{className:"flex items-center",children:Xt}),a.jsx("span",{children:wt?"CICLO ACTUAL":"CICLO ARCHIVADO"})]}),a.jsx("div",{className:"flex shrink-0 items-center gap-2",children:Pa})]}),a.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[a.jsx(o,{className:"h-5 w-5 text-subtitulo"}),a.jsx("span",{className:D("font-semibold text-titulo leading-tight","text-[21px] sm:text-[22px]"),children:xa})]}),Dt&&a.jsx("div",{className:"text-[13px] text-base whitespace-nowrap",children:Dt})]})})}),oa&&a.jsx(ge.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:a.jsx(Qa,{cycle:r,startDate:U,endDate:m?Y:r?.endDate,onStartDateChange:e=>Me(e),onEndDateChange:m?e=>Ee(e):void 0,onSave:Ea,onCancel:K,isProcessing:at,dateError:la,includeEndDate:m,showOverlapDialog:ca,overlapCycle:ia,onConfirmOverlap:Ra,onCancelOverlap:Ma,onClearError:()=>L(""),saveLabel:m?"Guardar fechas":"Guardar cambios",title:m?"Editar fechas del ciclo":"Editar fecha de inicio",description:m?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:Q?ja:void 0,deleteTitle:ze,deleteDescription:F,deleteLabel:He,isDeletingCycle:H})}),a.jsx(ss,{initial:!1,children:a.jsx(ge.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:a.jsx("div",{ref:Rt,onPointerDown:ka,"data-calendar-dragging":It?"true":"false",className:D("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:[transform:translate3d(var(--calendar-drag-x,0px),0,0)]",It?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${wa}px`},children:a.jsx(rs,{mode:"single",locale:De,month:Et??void 0,onMonthChange:nt,selected:h&&S(u(h))?u(h):void 0,onSelect:Pt,onDayClick:Pt,modifiers:ga,labels:va,components:{DayContent:Ca},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:ya,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),a.jsxs("div",{ref:Ct,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:kt,maxHeight:`calc(h-app - ${kt}px )`,WebkitOverflowScrolling:"touch"},children:[a.jsx(ge.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:$.length===0?a.jsx(ge.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:a.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[a.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:a.jsx(Kt,{className:"h-9 w-9"})}),a.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),a.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):a.jsx(xs,{isoDate:h,cycleDay:Lt?.cycleDay??null,details:ot,peakStatus:Ot,isPeakDay:Na,onEdit:_a,onDelete:Aa,onAdd:Ta,onToggleRelations:La,isProcessing:ae})}),Se&&a.jsx("div",{className:"pt-4 space-y-4",children:Se})]})]}),a.jsx(us,{open:na,onOpenChange:e=>{e?V(!0):Ht()},children:a.jsx(ms,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:a.jsx(ns,{onSubmit:Fa,onCancel:Ht,initialData:Qe,cycleStartDate:r?.startDate,cycleEndDate:r?.endDate,isProcessing:ae,isEditing:!!Qe,cycleData:r?.data,onDateSelect:Ia,defaultIsoDate:da,focusedField:ua,initialSectionKey:ma})})}),a.jsx(cs,{isOpen:!!te,onClose:()=>Ze(null),onConfirm:Oa,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:te?`¿Estás seguro de que quieres eliminar el registro del ${y(u(te.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:ae})]}):a.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[a.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[a.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),a.jsx("button",{onClick:()=>st(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),a.jsx(Ga,{isOpen:fa,onClose:()=>st(!1),onConfirm:async e=>{await ra(e),st(!1),re(null),V(!0),B?.fertilityStartConfig?.postpartum===!0&&rt(!0)}}),a.jsx(Ka,{isOpen:pa,onClose:()=>rt(!1),onConfirm:ha})]})},Ls=()=>a.jsx(Ss,{});export{Ss as RecordsExperience,Ls as default};
