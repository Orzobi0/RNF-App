import{c as Fa,r as s,f as Me,j as e,B as Q,d as Yt,s as qt,e as Gt,a as Qt,b as Zt,u as es,p as Fe,g as ka,h as fa,m as Z,i as as}from"./index-8c1bb4d0.js";import{L as it,C as ts,P as ss}from"./CycleDatesEditor-5cdf72be.js";import{i as ft,C as Ra,D as ns,c as rs,a as ls}from"./computePeakStatuses-347fa954.js";import{u as os,e as ct,P as is}from"./badge-6bd7af9d.js";import{D as _e,a as Le,b as ca,c as ua,d as Va,e as da,u as cs}from"./useCycleData-a1f868e4.js";import{I as ma}from"./input-6cdf51b4.js";import{c as us,C as ds}from"./useFertilityChart-9a56e2e7.js";import{L as Da}from"./label-60015da2.js";import"./OverlapWarningDialog-7409f0f1.js";import"./checkbox-a510d285.js";import"./eye-5bd09b1b.js";const ut=Fa("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]),ms=Fa("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),dt=Fa("CheckCircle2",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),fs=Fa("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]),mt=({isOpen:j,onClose:i,onConfirm:W,currentCycleStartDate:ee})=>{const[Ee,Re]=s.useState(Me(new Date,"yyyy-MM-dd"));os(j,i);const ge=!ee,H=()=>{W(Ee)},X=ge?"":Me(new Date(ee),"dd/MM/yyyy"),ae=(()=>{if(ge)return"";const te=new Date(Ee);return te.setDate(te.getDate()-1),Me(te,"dd/MM/yyyy")})();return e.jsx(_e,{open:j,onOpenChange:i,children:e.jsxs(Le,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(ca,{children:[e.jsx(ua,{children:"Iniciar nuevo ciclo"}),e.jsx(Va,{className:"text-gray-600",children:ge?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${X} - ${ae}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsx(ma,{id:"startDate",type:"date",value:Ee,onChange:te=>Re(te.target.value),max:Me(new Date,"yyyy-MM-dd"),min:ge?void 0:Me(new Date(ee),"yyyy-MM-dd"),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),e.jsxs(da,{className:"sm:justify-end",children:[e.jsx(Q,{variant:"outline",onClick:i,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(Q,{variant:"primary",onClick:H,className:"bg-pink-600 hover:bg-pink-700 text-white",children:ge?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})})},ps="metrics",xs="summary",La=async(j,i)=>{if(!j||!i||typeof i!="object")throw new Error("A valid userId and data object are required to save metrics.");const W=Yt(Gt,`users/${j}/${ps}`,xs);await qt(W,i,{merge:!0})},bs=({cycleData:j,onEdit:i,onTogglePeak:W,currentPeakIsoDate:ee,onEditStartDate:Ee=()=>{},handleOpenCpmDialog:Re=()=>{},handleOpenT8Dialog:ge=()=>{},cpmMetric:H={},t8Metric:X={}})=>{var de,Ue;const ae=j.records||[],[te,k]=s.useState(null),[Ma,pa]=s.useState({clientX:0,clientY:0}),[V,we]=s.useState(0),ta=s.useRef(!1),se=s.useRef(null),ye=s.useRef(null),ve=j.startDate?Fe(j.startDate):null,Ia=fa(new Date),xa=s.useMemo(()=>rs(ae),[ae]),ne=28,Se=140,M=Se+15,d=M*2,y=s.useMemo(()=>{const r=ae.reduce((x,g)=>{const N=(g==null?void 0:g.cycleDay)??null;if(N)return Math.max(x,N);if(!ve||!(g!=null&&g.isoDate))return x;try{const w=Fe(g.isoDate),E=ka(w,ve)+1;return Number.isFinite(E)?Math.max(x,E):x}catch(w){return console.error("Error calculating record day for wheel:",w),x}},0);return Math.max(j.currentDay,r,ne)},[j.currentDay,ae,ve,ne]),J=Math.max(y-ne,0),A=J>0;s.useEffect(()=>{if(!A){ta.current=!0,we(0);return}we(r=>{const x=Math.min(r,J),g=Math.max(0,Math.min(Math.max(j.currentDay-ne,0),J)),N=j.currentDay>=x+1&&j.currentDay<=x+ne;return ta.current?N?x!==r?x:r:g:(ta.current=!0,g)})},[A,J,j.currentDay,ne]);const Ie=s.useCallback(r=>Math.max(0,Math.min(r,J)),[J]),re=s.useCallback(r=>{!A||r===0||we(x=>Ie(x+r))},[Ie,A]),Ne=s.useRef(0),K=s.useRef(0),ie=s.useCallback(r=>{!A||r===0||(K.current+=r,!Ne.current&&(Ne.current=requestAnimationFrame(()=>{const x=Math.sign(K.current);we(g=>Ie(g+x)),K.current=0,Ne.current=0})))},[A,Ie]),$e=s.useCallback(r=>{if(!A)return;r.preventDefault();const x=Math.abs(r.deltaY)>Math.abs(r.deltaX)?r.deltaY:r.deltaX;x!==0&&ie(x>0?1:-1)},[re,A]),Ce=s.useCallback(r=>{var x,g;A&&(se.current=((g=(x=r.touches)==null?void 0:x[0])==null?void 0:g.clientX)??null)},[A]),Pe=s.useCallback(r=>{var N,w;if(!A||se.current===null)return;const x=((w=(N=r.touches)==null?void 0:N[0])==null?void 0:w.clientX)??null;if(x===null)return;const g=x-se.current;Math.abs(g)<24||(ie(g<0?1:-1),se.current=x)},[re,A]),Y=s.useCallback(()=>{se.current=null},[]),ce=r=>{switch(r){case"red":return{main:"#ef4444",light:"#fee2e2",glow:"rgba(239, 68, 68, 0.3)",border:"none"};case"white":return{main:"#f8fafc",light:"#ffe4e6",glow:"rgba(248, 250, 252, 0.3)",border:"none"};case"green":return{main:"#22c55e",light:"#22c55e",glow:"rgba(34, 197, 94, 0.3)",border:"none"};case"yellow":return{main:"#facc15",light:"#fef08a",glow:"rgba(250, 204, 21, 0.3)",border:"none"};case"spot":return{main:"#ef4444",light:"#ef4444",glow:"rgba(239, 68, 68, 0.3)",border:"#fee2e2",pattern:"url(#spotting-pattern-dashboard)"};default:return{main:"#d1d5db",light:"#f8fafc",glow:"rgba(209, 213, 219, 0.3)",border:"none"}}},Ve=s.useMemo(()=>ae.reduce((r,x)=>{if(!x)return r;const g=Number(x.cycleDay);if(Number.isFinite(g)&&g>0)return r.has(g)||r.set(g,x),r;if(!ve||!x.isoDate)return r;try{const N=Fe(x.isoDate),w=ka(N,ve)+1;Number.isFinite(w)&&w>0&&!r.has(w)&&r.set(w,{...x,cycleDay:w})}catch(N){console.error("Error mapping record by day for wheel:",N)}return r},new Map),[ae,ve]),q=(()=>Array.from({length:ne},(r,x)=>{const g=V+x+1,N=Ve.get(g)??null,w=ve?as(ve,g-1):null,E=w?Me(w,"yyyy-MM-dd"):null,P=w?ft(fa(w),Ia):!1,me=N?{...N,cycleDay:N.cycleDay??g}:null,F=(x+V)/ne*2*Math.PI-Math.PI/2,le=M+Se*Math.cos(F),z=M+Se*Math.sin(F);let fe=g<=j.currentDay&&me?ce(me.fertility_symbol):{main:"#c1abb6",light:"#c8cacf",glow:"rgba(229, 231, 235, 0.3)"};const B=g===j.currentDay;B&&(me?fe={...ce(me.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:fe={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const De=E&&xa[E]||null;return{x:le,y:z,day:g,colors:fe,isActive:g<=j.currentDay,isToday:B,hasRecord:!!me,record:me,isoDate:E,canShowPlaceholder:!!(!me&&E&&!P),peakStatus:De}}))(),_=V*360/ne,je=-_*Math.PI/180,T=Math.cos(je),ue=Math.sin(je),O=s.useCallback((r,x)=>{const g=r-M,N=x-M;return{x:M+g*T-N*ue,y:M+g*ue+N*T}},[M,T,ue]),ba=2*Math.PI/ne,Be=-Math.PI/2-ba/2,ze=Se-18,ha=Se+10,Ae=M+ze*Math.cos(Be),ga=M+ze*Math.sin(Be),sa=M+ha*Math.cos(Be),Ta=M+ha*Math.sin(Be);s.useEffect(()=>{A&&k(null)},[V,A]);const na=(r,x)=>{if(x.stopPropagation(),!ye.current){k(null);return}const g=ye.current.getBoundingClientRect();let N,w;x.touches&&x.touches[0]?(N=x.touches[0].clientX,w=x.touches[0].clientY):(N=x.clientX,w=x.clientY);const E=r.canShowPlaceholder&&r.isoDate?{id:`placeholder-${r.isoDate}`,isoDate:r.isoDate,cycleDay:r.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:r.peakStatus,peak_marker:r.peakStatus==="P"?"peak":null}:null,P=r.record?{...r.record,cycleDay:r.record.cycleDay??r.day,peakStatus:r.peakStatus,peak_marker:r.record.peak_marker??(r.peakStatus==="P"?"peak":null)}:E;if(P&&ee&&P.isoDate===ee&&(P.peak_marker="peak",P.peakStatus=P.peakStatus||"P"),!P){k(null);return}pa({clientX:N-g.left,clientY:w-g.top}),k(P)};return s.useEffect(()=>{if(!te)return;const r=x=>{ye.current&&!ye.current.contains(x.target)&&k(null)};return document.addEventListener("mousedown",r),document.addEventListener("touchstart",r),()=>{document.removeEventListener("mousedown",r),document.removeEventListener("touchstart",r)}},[te]),e.jsxs("div",{className:"relative flex flex-1 flex-col overflow-y-hidden",children:[e.jsxs(Z.div,{className:"px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:Ee,className:"text-sm font-medium text-pink-700 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1.5 inline-flex items-center gap-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white/40",title:"Editar fecha de inicio del ciclo",children:[e.jsx(ss,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(Z.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:[e.jsxs("div",{className:"text-center mb-3 flex-shrink-0",children:[e.jsxs(Z.div,{ref:ye,className:"relative inline-flex items-center justify-center mb-4",style:{width:d,height:d},initial:{opacity:0},animate:{opacity:1},transition:{duration:.18,ease:"easeOut"},onWheel:$e,onTouchStart:Ce,onTouchMove:Pe,onTouchEnd:Y,children:[e.jsxs("svg",{className:"w-full h-full",viewBox:`0 0 ${d} ${d}`,onClick:()=>k(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"50%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.0)"}),e.jsx("stop",{offset:"60%",stopColor:"rgba(244,114,182,0.12)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(190,24,93,0.10)"})]})]}),e.jsx("filter",{id:"dotShadow",x:"-30%",y:"-30%",width:"160%",height:"160%",colorInterpolationFilters:"sRGB",children:e.jsx("feDropShadow",{dx:"0",dy:"0.8",stdDeviation:"0.8",floodColor:"#000",floodOpacity:"0.22"})}),e.jsx("circle",{cx:M,cy:M,r:Se-30,fill:"url(#ringGlow)",stroke:"rgba(255,255,255,0.35)",strokeWidth:"0.5"}),A&&e.jsx("line",{x1:Ae,y1:ga,x2:sa,y2:Ta,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(Z.g,{transition:{type:"tween",duration:.18,ease:[.2,.8,.2,1]},initial:!1,animate:{rotate:-_},style:{transformOrigin:"center",transformBox:"view-box",willChange:"transform"},children:q.map((r,x)=>e.jsxs("g",{children:[e.jsx("g",{filter:r.isActive?"url(#dotShadow)":void 0,children:e.jsx(Z.circle,{cx:r.x,cy:r.y,r:r.isToday?11:10,fill:r.colors.pattern||(r.isActive?r.colors.main:"rgba(255,255,255,0.001)"),stroke:r.colors.border==="none"?"none":r.colors.border||"rgba(158,158,158,0.4)",strokeWidth:r.colors.border==="none"?0:r.isToday?1.8:r.colors.border?.6:.8,onClick:g=>na(r,g),initial:!1,animate:{scale:1,opacity:1},transition:{duration:.15},style:{cursor:"pointer"}})}),r.isToday&&e.jsx("circle",{cx:r.x,cy:r.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}})]},x))}),q.map((r,x)=>{if(!r.peakStatus)return null;const{x:g,y:N}=O(r.x,r.y);return r.peakStatus==="P"?e.jsx("text",{x:g,y:N+4,textAnchor:"middle",fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none"},children:"✖"}):e.jsx("text",{x:g,y:N+4,textAnchor:"middle",fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:r.peakStatus})})]}),te&&e.jsx("div",{onClick:r=>r.stopPropagation(),children:e.jsx(ds,{point:te,position:Ma,chartWidth:((de=ye.current)==null?void 0:de.clientWidth)||0,chartHeight:((Ue=ye.current)==null?void 0:Ue.clientHeight)||0,onEdit:i,onClose:()=>k(null),onTogglePeak:W,currentPeakIsoDate:ee})}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[e.jsxs(Z.div,{className:"text-center  backdrop-blur-md rounded-full p-4",initial:{opacity:0},animate:{opacity:1},transition:{duration:.2,delay:.2,ease:"easeOut"},style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"},children:[e.jsx("span",{className:"text-5xl font-bold text-pink-700 block",children:j.currentDay}),e.jsx("span",{className:"text-800 text-pink-700 font-medium mt-0.5 block",children:"día del ciclo"})]}),e.jsx(Z.div,{className:"mt-2 px-2.5 py-1  backdrop-blur-sm rounded-full border border-pink-200",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2,delay:.25,ease:"easeOut"},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.1))"},children:e.jsx("span",{className:"text-md font-medium text-pink-900",children:j.currentDay<=7?"Menstrual":j.currentDay<=14?"Folicular":j.currentDay<=21?"Ovulatoria":"Lútea"})})]})]}),A&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full text-rose-500 shadow-xs transition hover:border hover:border-rose-500/20",onClick:()=>re(-1),disabled:V===0,children:e.jsx(ls,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",V+1]}),e.jsx("span",{className:"text-xs text-rose-400",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",Math.min(V+ne,y)]})]}),e.jsx("input",{type:"range",min:0,max:J,value:V,onChange:r=>we(Ie(Number(r.target.value))),className:"w-40 accent-rose-500"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full text-rose-500 shadow-xs transition hover:border hover:border-rose-500/20",onClick:()=>ie(1),disabled:V===J,children:e.jsx(Ra,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0",children:[e.jsxs(Z.div,{className:"relative bg-gradient-to-br from-pink-50/90 to-rose-50/90 backdrop-blur-md rounded-3xl p-4 border border-pink-200/30",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.5},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.08))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.7)"},children:[e.jsx("h3",{className:"font-bold mb-4 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Símbolos"}),e.jsx("div",{className:"grid grid-cols-2 gap-2.5",children:[{label:"Menstrual",color:"#ef4444"},{label:"Moco (Fértil)",color:"#f8fafc",stroke:"#c2c6cc"},{label:"Seco",color:"#22c55e"},{label:"Moco (No fértil)",color:"#facc15",stroke:"#fef08a"},{label:"Spotting",color:"#ef4444",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(r=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[r.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-4 h-4 rounded-full border ${r.pattern?"pattern-bg":""}`,style:{backgroundColor:r.color,borderColor:r.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${r.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:r.label})]},r.label))}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-300/40 to-rose-400/40 rounded-full"})]}),e.jsxs(Z.div,{className:"relative bg-gradient-to-br from-pink-50/70 to-rose-50/50 backdrop-blur-md rounded-3xl p-3 border border-pink-200/40",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.6},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.1))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.8)"},children:[e.jsx("h3",{className:"font-bold mb-2 text-gray-800 flex items-center gap-2 justify-center text-[11px] tracking-wide uppercase",children:"Cálculo"}),e.jsxs("div",{className:"grid grid-cols-2 gap-y-3",children:[e.jsxs("button",{type:"button",onClick:Re,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (Ciclo más corto)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"Ciclo más corto"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-12 h-12 text-base font-bold text-rose-700",children:(H==null?void 0:H.baseFormatted)??"—"})})]}),e.jsxs("button",{type:"button",onClick:Re,className:"flex flex-col items-center gap-0.5","aria-label":"Editar CPM (resultado)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"CPM"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:(H==null?void 0:H.finalFormatted)??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:(H==null?void 0:H.modeLabel)??"Auto"})]}),e.jsxs("button",{type:"button",onClick:ge,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (Día de subida)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"Día de subida"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-12 h-12 text-base font-bold text-rose-700",children:(X==null?void 0:X.baseFormatted)??"—"})})]}),e.jsxs("button",{type:"button",onClick:ge,className:"flex flex-col items-center gap-0.5","aria-label":"Editar T-8 (resultado)",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-700",children:"T-8"}),e.jsx("div",{className:"h-12 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:(X==null?void 0:X.finalFormatted)??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:(X==null?void 0:X.modeLabel)??"Auto"})]})]}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-500/40 to-rose-400/40 rounded-full"})]})]})]})]})},hs=({onAddRecord:j,onAddCycle:i})=>{const[W,ee]=s.useState(!1);return e.jsxs("div",{className:"fixed right-4 top-12 md:top-6 flex flex-col-reverse items-end space-y-2 z-50",children:[W&&e.jsxs("div",{className:"flex flex-col space-y-2 mt-1",children:[e.jsxs(Z.button,{onClick:j,className:"flex items-center gap-1 px-4 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(fs,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]}),e.jsxs(Z.button,{onClick:i,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white shadow-lg",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(147, 51, 234, 0.3))"},children:[e.jsx(ms,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]})]}),e.jsx(Z.button,{onClick:()=>ee(!W),className:"w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-full shadow-lg flex items-center justify-center",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 4px 12px rgba(236, 72, 153, 0.35))"},children:e.jsx(Z.span,{animate:{rotate:W?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(is,{className:"h-5 w-5"})})})]})},Ms=()=>{const j=Qt(),{currentCycle:i,archivedCycles:W,addOrUpdateDataPoint:ee,startNewCycle:Ee,isLoading:Re,updateCycleDates:ge,checkCycleOverlap:H,forceUpdateCycleStart:X,refreshData:ae,setCycleIgnoreForAutoCalculations:te}=cs(),{toast:k}=Zt(),[Ma,pa]=s.useState(!1),[V,we]=s.useState(()=>(i==null?void 0:i.startDate)||""),[ta,se]=s.useState(""),[ye,ve]=s.useState(null),[Ia,xa]=s.useState(null),[ne,Se]=s.useState(!1),[za,M]=s.useState(!1),{user:d,preferences:y,savePreferences:J}=es(),[A,Ie]=s.useState(!1),[re,Ne]=s.useState(""),[K,ie]=s.useState(""),[$e,Ce]=s.useState(""),[Pe,Y]=s.useState(""),[ce,Ve]=s.useState(null),[I,q]=s.useState(null),[_,je]=s.useState(null),[T,ue]=s.useState(!1),[O,ba]=s.useState("auto"),[Be,ze]=s.useState(!1),[ha,Ae]=s.useState(!1),[ga,sa]=s.useState(!1),[Ta,na]=s.useState(!1),[de,Ue]=s.useState(""),[r,x]=s.useState(""),[g,N]=s.useState(""),[w,E]=s.useState(""),[P,me]=s.useState(null),[F,le]=s.useState(null),[z,fe]=s.useState(null),[B,De]=s.useState(!1),[U,Ua]=s.useState("auto"),[Ha,Ea]=s.useState(!1),[pt,ra]=s.useState(!1),[Ja,$a]=s.useState(!1),[Wa,Xa]=s.useState([]),He=s.useRef(!1),Je=s.useRef(!1),Pa=s.useRef(null),pe=s.useMemo(()=>d!=null&&d.uid?`rnf_manual_cpm_${d.uid}`:null,[d==null?void 0:d.uid]),oe=s.useMemo(()=>d!=null&&d.uid?`rnf_manual_cpm_base_${d.uid}`:null,[d==null?void 0:d.uid]),xe=s.useMemo(()=>d!=null&&d.uid?`rnf_manual_t8_${d.uid}`:null,[d==null?void 0:d.uid]),be=s.useMemo(()=>d!=null&&d.uid?`rnf_manual_t8_base_${d.uid}`:null,[d==null?void 0:d.uid]);s.useEffect(()=>{He.current=!1},[pe]),s.useEffect(()=>{Je.current=!1},[xe]),s.useEffect(()=>{if(!oe){q(null);return}const a=y==null?void 0:y.manualCpmBase;if(a!==void 0){if(typeof a=="number"&&Number.isFinite(a)){if(q(a),typeof window<"u")try{localStorage.setItem(oe,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual CPM base value to local storage",t)}}else if(q(null),typeof window<"u")try{localStorage.removeItem(oe)}catch(t){console.error("Failed to clear manual CPM base value from local storage",t)}return}if(!(typeof window>"u"))try{const t=localStorage.getItem(oe);if(t){const l=JSON.parse(t);l&&typeof l.value=="number"&&Number.isFinite(l.value)?q(l.value):q(null)}else q(null)}catch(t){console.error("Failed to restore manual CPM base value from local storage",t)}},[oe,y==null?void 0:y.manualCpmBase]),s.useEffect(()=>{if(!be){le(null);return}const a=y==null?void 0:y.manualT8Base;if(a!==void 0){if(typeof a=="number"&&Number.isFinite(a)){if(le(a),typeof window<"u")try{localStorage.setItem(be,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual T-8 base value to local storage",t)}}else if(le(null),typeof window<"u")try{localStorage.removeItem(be)}catch(t){console.error("Failed to clear manual T-8 base value from local storage",t)}return}if(!(typeof window>"u"))try{const t=localStorage.getItem(be);if(t){const l=JSON.parse(t);l&&typeof l.value=="number"&&Number.isFinite(l.value)?le(l.value):le(null)}else le(null)}catch(t){console.error("Failed to restore manual T-8 base value from local storage",t)}},[be,y==null?void 0:y.manualT8Base]);const We=s.useCallback(async({finalValue:a,baseValue:t})=>{if(!(d!=null&&d.uid)||!J)return;const l=a==null?null:Number(a),n=t===void 0?void 0:t==null?null:Number(t),o={manualCpm:l};n!==void 0&&(o.manualCpmBase=n);try{await J(o),pe&&typeof window<"u"&&(o.manualCpm===null?localStorage.removeItem(pe):localStorage.setItem(pe,JSON.stringify({value:o.manualCpm}))),n!==void 0&&oe&&typeof window<"u"&&(n===null?localStorage.removeItem(oe):localStorage.setItem(oe,JSON.stringify({value:n}))),await La(d.uid,{manual:{cpm:{value:l,base:n===void 0?I:n}},manualUpdatedAt:new Date().toISOString()})}catch(u){throw console.error("Failed to persist manual CPM value in profile",u),u}},[oe,I,pe,J,d==null?void 0:d.uid]),Xe=s.useCallback(async({finalValue:a,baseValue:t})=>{if(!(d!=null&&d.uid)||!J)return;const l=a==null?null:Number(a),n=t===void 0?void 0:t==null?null:Number(t),o={manualT8:l};n!==void 0&&(o.manualT8Base=n);try{await J(o),xe&&typeof window<"u"&&(o.manualT8===null?localStorage.removeItem(xe):localStorage.setItem(xe,JSON.stringify({value:o.manualT8}))),n!==void 0&&be&&typeof window<"u"&&(n===null?localStorage.removeItem(be):localStorage.setItem(be,JSON.stringify({value:n}))),await La(d.uid,{manual:{t8:{value:l,riseDay:n===void 0?F:n}},manualUpdatedAt:new Date().toISOString()})}catch(u){throw console.error("Failed to persist manual T-8 value in profile",u),u}},[be,F,xe,J,d==null?void 0:d.uid]);s.useEffect(()=>{if(!pe){je(null),ue(!1),He.current=!1;return}const a=y==null?void 0:y.manualCpm;if(typeof a=="number"&&Number.isFinite(a)){if(je(a),ue(!0),typeof window<"u")try{localStorage.setItem(pe,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual CPM value to local storage",t)}return}if(a===null&&(je(null),ue(!1),typeof window<"u"))try{localStorage.removeItem(pe)}catch(t){console.error("Failed to clear manual CPM value from local storage",t)}},[pe,y==null?void 0:y.manualCpm]),s.useEffect(()=>{if(!xe){fe(null),De(!1),Je.current=!1;return}const a=y==null?void 0:y.manualT8;if(typeof a=="number"&&Number.isFinite(a)){if(fe(a),De(!0),typeof window<"u")try{localStorage.setItem(xe,JSON.stringify({value:a}))}catch(t){console.error("Failed to sync manual T-8 value to local storage",t)}return}if(a===null&&(fe(null),De(!1),typeof window<"u"))try{localStorage.removeItem(xe)}catch(t){console.error("Failed to clear manual T-8 value from local storage",t)}},[xe,y==null?void 0:y.manualT8]),s.useEffect(()=>{if(!pe||He.current||!(d!=null&&d.uid))return;if((y==null?void 0:y.manualCpm)!==void 0){He.current=!0;return}if(typeof window>"u"){He.current=!0;return}try{const t=localStorage.getItem(pe);if(t){const l=JSON.parse(t);if(l&&typeof l.value=="number"&&Number.isFinite(l.value)){je(l.value),ue(!0);let n=I;try{if(oe){const o=localStorage.getItem(oe);if(o){const u=JSON.parse(o);u&&typeof u.value=="number"&&Number.isFinite(u.value)?n=u.value:n=null}}}catch(o){console.error("Failed to read manual CPM base value from local storage",o)}q(typeof n=="number"&&Number.isFinite(n)?n:null),We({finalValue:l.value,baseValue:n}).catch(o=>console.error("Failed to migrate manual CPM value to profile storage",o))}}}catch(t){console.error("Failed to restore manual CPM value from local storage",t)}finally{He.current=!0}},[oe,I,pe,We,y==null?void 0:y.manualCpm,d==null?void 0:d.uid]),s.useEffect(()=>{if(!xe||Je.current||!(d!=null&&d.uid))return;if((y==null?void 0:y.manualT8)!==void 0){Je.current=!0;return}if(typeof window>"u"){Je.current=!0;return}try{const t=localStorage.getItem(xe);if(t){const l=JSON.parse(t);if(l&&typeof l.value=="number"&&Number.isFinite(l.value)){fe(l.value),De(!0);let n=F;try{if(be){const o=localStorage.getItem(be);if(o){const u=JSON.parse(o);u&&typeof u.value=="number"&&Number.isFinite(u.value)?n=u.value:n=null}}}catch(o){console.error("Failed to read manual T-8 base value from local storage",o)}le(typeof n=="number"&&Number.isFinite(n)?n:null),Xe({finalValue:l.value,baseValue:n}).catch(o=>console.error("Failed to migrate manual T-8 value to profile storage",o))}}}catch(t){console.error("Failed to restore manual T-8 value from local storage",t)}finally{Je.current=!0}},[be,F,xe,Xe,y==null?void 0:y.manualT8,d==null?void 0:d.uid]),s.useEffect(()=>{we((i==null?void 0:i.startDate)||"")},[i==null?void 0:i.startDate]);const Ba=s.useCallback(a=>{if(!(a!=null&&a.startDate))return null;try{const t=Fe(a.startDate);if(Number.isNaN(t.getTime()))return null;const l=Me(t,"dd/MM/yyyy",{locale:ct});if(!a.endDate)return`${l} - En curso`;const n=Fe(a.endDate);if(Number.isNaN(n.getTime()))return l;const o=Me(n,"dd/MM/yyyy",{locale:ct});return`${l} - ${o}`}catch{return null}},[]),ya=s.useMemo(()=>{const a=[];if(Array.isArray(W)&&W.length>0&&W.forEach((t,l)=>{const n=Ba(t);a.push({...t,displayName:t.name||n||`Ciclo archivado ${l+1}`,dateRangeLabel:n,source:"archived",ignoredForAutoCalculations:!!t.ignoredForAutoCalculations})}),i!=null&&i.id){const t=Ba(i);a.push({...i,displayName:i.name||t||"Ciclo actual",dateRangeLabel:t,source:"current",ignoredForAutoCalculations:!!i.ignoredForAutoCalculations})}return a},[W,i,Ba]),h=s.useMemo(()=>{const l=[...ya.map(m=>{if(!m.startDate||!m.endDate)return null;try{const v=Fe(m.startDate),$=Fe(m.endDate);if(Number.isNaN(v.getTime())||Number.isNaN($.getTime())||ft(v,$))return null;const p=ka(fa($),fa(v))+1;return!Number.isFinite(p)||p<=0?null:{...m,duration:p,ignoredForAutoCalculations:!!m.ignoredForAutoCalculations}}catch(v){return console.error("Failed to compute cycle duration for CPM calculation",v),null}}).filter(Boolean)].sort((m,v)=>{const $=typeof m.duration=="number"&&Number.isFinite(m.duration)?m.duration:Number.POSITIVE_INFINITY,p=typeof v.duration=="number"&&Number.isFinite(v.duration)?v.duration:Number.POSITIVE_INFINITY;return $-p}).map(m=>{const v=!!m.ignoredForAutoCalculations;return{...m,isIgnored:v,isIncluded:!v}}),n=l.filter(m=>m.isIncluded),o=l.length-n.length,u=n.length;if(u<6)return{value:null,cycleCount:u,shortestCycle:null,deduction:null,canCompute:!1,cyclesConsidered:l,ignoredCount:o};const c=n[0]??null,S=u>=12?20:21,f=typeof(c==null?void 0:c.duration)=="number"&&Number.isFinite(c.duration)?c.duration-S:null;return{value:f,cycleCount:u,shortestCycle:c,deduction:S,canCompute:f!==null,cyclesConsidered:l,ignoredCount:o}},[ya]),b=s.useMemo(()=>{const a=p=>{if(p==null||p==="")return null;const C=Number.parseFloat(String(p).replace(",","."));return Number.isFinite(C)?C:null},t=p=>{if(!p)return null;const C=a(p.temperature),D=a(p.temperature_corrected);return p.use_corrected&&D!==null?D:C!==null?C:D!==null?D:null},l=p=>{const C=[p==null?void 0:p.temperature_chart,p==null?void 0:p.temperature_raw,p==null?void 0:p.temperature_corrected];for(const D of C){const R=a(D);if(R!==null)return R}if(Array.isArray(p==null?void 0:p.measurements)){const R=p.measurements.find(he=>he&&he.selected&&t(he)!==null)||p.measurements.find(he=>t(he)!==null);if(R){const he=t(R);if(he!==null)return he}}return null},n=p=>{if(!p)return null;try{const C=Fe(p);return Number.isNaN(C.getTime())?null:C}catch{return null}},o=ya.filter(p=>p&&p.startDate&&Array.isArray(p.data)&&p.data.length>0).sort((p,C)=>{const D=n(p.startDate),R=n(C.startDate);return!D&&!R?0:D?R?R-D:-1:1}),u=[],c=[];for(const p of o){const C=p.data.filter(ia=>ia&&ia.isoDate).map(ia=>({...ia,displayTemperature:l(ia)}));if(C.length===0)continue;const{ovulationDetails:D}=us(C);if(!(D!=null&&D.confirmed))continue;const R=Number.isInteger(D==null?void 0:D.ovulationIndex)?D.ovulationIndex:Number.isInteger(D==null?void 0:D.confirmationIndex)?D.confirmationIndex:null;if(R==null||R<0||R>=C.length)continue;const he=C[R],wa=Number(he==null?void 0:he.cycleDay);if(!Number.isFinite(wa)||wa<=0)continue;const Kt=Math.max(1,wa-8),Sa=!!p.ignoredForAutoCalculations,ot={cycleId:p.id,riseDay:wa,t8Day:Kt,displayName:p.displayName||p.name||"Ciclo sin nombre",dateRangeLabel:p.dateRangeLabel,isIgnored:Sa,isIncluded:!Sa,ignoredForAutoCalculations:Sa};u.push(ot),!Sa&&c.length<12&&c.push(ot)}const S=c.length,f=u.reduce((p,C)=>p+(C.isIgnored?1:0),0);if(S===0)return{value:null,cycleCount:S,earliestCycle:null,cyclesConsidered:u,canCompute:!1,rawValue:null,ignoredCount:f};const m=c.reduce((p,C)=>C.t8Day<p.t8Day?C:p),v=m.t8Day,$=S>=6;return{value:$?v:null,cycleCount:S,earliestCycle:m,cyclesConsidered:u,canCompute:$,rawValue:v,ignoredCount:f}},[ya]);s.useEffect(()=>{var u;if(!(d!=null&&d.uid)){Pa.current=null;return}const a=c=>typeof c=="number"&&Number.isFinite(c)?c:null,t=c=>c?{id:c.id??null,name:c.name??null,displayName:c.displayName??null,startDate:c.startDate??null,endDate:c.endDate??null,duration:a(c.duration),source:c.source??null,dateRangeLabel:c.dateRangeLabel??null}:null,l=c=>c?{id:c.id??null,name:c.name??null,displayName:c.displayName??null,startDate:c.startDate??null,endDate:c.endDate??null,riseDay:a(c.riseDay),t8Day:a(c.t8Day),source:c.source??null,dateRangeLabel:c.dateRangeLabel??null}:null,n={automatic:{cpm:{value:a(h==null?void 0:h.value),cycleCount:a(h==null?void 0:h.cycleCount)??0,ignoredCount:a(h==null?void 0:h.ignoredCount)??0,deduction:a(h==null?void 0:h.deduction),canCompute:!!(h!=null&&h.canCompute),shortestCycle:t(h==null?void 0:h.shortestCycle)},t8:{value:a(b==null?void 0:b.value),cycleCount:a(b==null?void 0:b.cycleCount)??0,ignoredCount:a(b==null?void 0:b.ignoredCount)??0,canCompute:!!(b!=null&&b.canCompute),riseDay:a((u=b==null?void 0:b.earliestCycle)==null?void 0:u.riseDay),earliestCycle:l(b==null?void 0:b.earliestCycle)}}},o=JSON.stringify(n);Pa.current!==o&&(Pa.current=o,La(d.uid,{...n,automaticUpdatedAt:new Date().toISOString()}).catch(c=>{console.error("Failed to persist automatic metrics snapshot",c)}))},[h,b,d==null?void 0:d.uid]);const L=s.useMemo(()=>{const a=h.cycleCount??0,t=`${a} ciclo${a===1?"":"s"}`,l=6,n=T?"Manual":"Automático",o=h.cyclesConsidered??[],u=!!h.canCompute,c=h.ignoredCount??0,S=typeof h.deduction=="number"&&Number.isFinite(h.deduction)?h.deduction:null,f=h.shortestCycle??null,m=typeof h.value=="number"&&Number.isFinite(h.value)?h.value:null;let v;if(a===0)v=c>0?"Todos los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos finalizados con fecha de finalización.";else if(!u)v=`Hay ${t} finalizado${a===1?"":"s"}. Se necesitan ${l} para calcular el CPM automáticamente.`,c>0&&(v+=` (${c} ciclo${c===1?"":"s"} ignorado${c===1?"":"s"}).`);else{const $=(f==null?void 0:f.dateRangeLabel)||(f==null?void 0:f.displayName)||(f==null?void 0:f.name)||"Ciclo sin nombre",p=typeof(f==null?void 0:f.duration)=="number"&&Number.isFinite(f.duration)?`${f.duration} días`:"duración desconocida",C=[`Calculado con ${t}.`,`Ciclo más corto: ${$} (${p}).`];S!==null&&C.push(`Deducción aplicada: ${S} días.`),m!==null&&C.push(`Resultado: ${m} días.`),c>0&&C.push(`${c} ciclo${c===1?"":"s"} ignorado${c===1?"":"s"}.`),v=C.join(" ")}return{sourceLabel:n,summary:v,highlightLabel:t,cycleCount:a,requiredCycles:l,canCompute:u,detailsAvailable:o.length>0,cycles:o,deduction:S,shortestCycle:f,value:m,ignoredCount:c}},[h,T]),Aa=s.useMemo(()=>{var $,p,C,D;const a=b.cycleCount,t=`${a} ciclo${a===1?"":"s"}`,l=6,n=B?"Manual":"Automático",o=b.ignoredCount??0,u=(($=b.earliestCycle)==null?void 0:$.displayName)||((p=b.earliestCycle)==null?void 0:p.name)||"Ciclo sin nombre",c=(C=b.earliestCycle)==null?void 0:C.riseDay,S=typeof c=="number"&&Number.isFinite(c)?`Día ${c}`:"día desconocido",f=(D=b.earliestCycle)==null?void 0:D.t8Day,m=typeof f=="number"&&Number.isFinite(f)?`T-8 Día ${f}`:null;let v;if(a===0)v=o>0?"Los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos con ovulación confirmada por temperatura.";else if(!b.canCompute)v=`Hay ${t} con ovulación confirmada por temperatura (se necesitan ${l}).`,o>0&&(v+=` ${o} ciclo${o===1?"":"s"} ignorado${o===1?"":"s"}.`);else{const R=[`${u} (${S}${m?` → ${m}`:""}).`];o>0&&R.push(`${o} ciclo${o===1?"":"s"} ignorado${o===1?"":"s"}.`),v=R.join(" ")}return{sourceLabel:n,summary:v,highlightLabel:t,cycleCount:a,requiredCycles:l,ignoredCount:o}},[b,B]),G=s.useCallback((a,t)=>typeof a!="number"||!Number.isFinite(a)?null:a.toLocaleString("es-ES",t),[]),ke=s.useMemo(()=>typeof h.deduction=="number"&&Number.isFinite(h.deduction)?h.deduction:(h.cycleCount??0)>=12?20:21,[h.cycleCount,h.deduction]),Ke=T&&O==="manual",va=O==="auto",Ka=O==="none",xt=s.useMemo(()=>{var v;const a=typeof((v=h.shortestCycle)==null?void 0:v.duration)=="number"&&Number.isFinite(h.shortestCycle.duration)?h.shortestCycle.duration:null,t=typeof h.value=="number"&&Number.isFinite(h.value)?h.value:null,l=Ke?I:va?a:null,n=Ke?_:va?t:null,o=G(l,{maximumFractionDigits:0}),u=G(n,{maximumFractionDigits:2}),c=`Ciclo más corto: ${o??"—"}`,S=`CPM = ${u??"—"}`;let f="Sin datos disponibles",m=!0;return typeof n=="number"&&Number.isFinite(n)&&(Ke?typeof I=="number"&&Number.isFinite(I)?(f=`${G(I,{maximumFractionDigits:0})??`${I}`} − ${ke}`,m=!1):(f="Valor definido manualmente",m=!0):va&&typeof a=="number"&&Number.isFinite(a)&&(f=`${G(a,{maximumFractionDigits:0})??`${a}`} − ${ke}`,m=!1)),(typeof n!="number"||!Number.isFinite(n))&&(f="Sin datos disponibles",m=!0),{title:"CPM",baseText:c,finalText:S,microCopy:f,microCopyMuted:m,modeLabel:Ka?"Sin usar":Ke?"Manual":"Auto",microCopyId:"cpm-metric-microcopy",baseValue:l,finalValue:n,baseFormatted:o,finalFormatted:u,isManual:Ke}},[h,ke,G,Ka,I,_,va,Ke]),Ye=B&&U==="manual",Na=U==="auto",Ya=U==="none",bt=s.useMemo(()=>{var v;const a=typeof((v=b.earliestCycle)==null?void 0:v.riseDay)=="number"&&Number.isFinite(b.earliestCycle.riseDay)?b.earliestCycle.riseDay:null,t=typeof b.value=="number"&&Number.isFinite(b.value)?b.value:null,l=Ye?F:Na?a:null,n=Ye?z:Na?t:null,o=G(l,{maximumFractionDigits:0}),u=G(n,{maximumFractionDigits:0}),c=`Día de subida: ${o??"—"}`,S=`T-8 = ${u??"—"}`;let f="Sin datos disponibles",m=!0;return typeof n=="number"&&Number.isFinite(n)&&(Ye?typeof F=="number"&&Number.isFinite(F)?(f=`${G(F,{maximumFractionDigits:0})??`${F}`} − 8`,m=!1):(f="Valor definido manualmente",m=!0):Na&&typeof a=="number"&&Number.isFinite(a)&&(f=`${G(a,{maximumFractionDigits:0})??`${a}`} − 8`,m=!1)),(typeof n!="number"||!Number.isFinite(n))&&(f="Sin datos disponibles",m=!0),{title:"T-8",baseText:c,finalText:S,microCopy:f,microCopyMuted:m,modeLabel:Ya?"Sin usar":Ye?"Manual":"Auto",microCopyId:"t8-metric-microcopy",baseValue:l,finalValue:n,baseFormatted:o,finalFormatted:u,isManual:Ye}},[b,G,Ya,F,z,Na,Ye]),ht=G(L.value,{maximumFractionDigits:1})??(typeof L.value=="number"&&Number.isFinite(L.value)?`${L.value}`:"—");G(_,{maximumFractionDigits:1})??(typeof _=="number"&&Number.isFinite(_)&&`${_}`);const Ca=O==="manual"&&T?"manual":O==="auto"?"auto":"none",gt=Ca==="manual"?"Manual":Ca==="auto"?"Automático":"Sin usar",yt=G(b.value,{maximumFractionDigits:0})??(typeof b.value=="number"&&Number.isFinite(b.value)?`${b.value}`:"—");G(z,{maximumFractionDigits:0})??(typeof z=="number"&&Number.isFinite(z)&&`${z}`);const ja=U==="manual"&&B?"manual":U==="auto"?"auto":"none",vt=ja==="manual"?"Manual":ja==="auto"?"Automático":"Sin usar",Oa=s.useMemo(()=>ce||(K.trim()?"final":re.trim()?"base":null),[re,ce,K]),qa=s.useMemo(()=>$e||Pe?!0:Oa==="base"?re.trim()===""||K.trim()==="":Oa==="final"?K.trim()==="":!0,[$e,re,Pe,K,Oa]),Nt=s.useMemo(()=>!!(T||re.trim()||K.trim()),[T,re,K]),_a=s.useMemo(()=>P||(r.trim()?"final":de.trim()?"base":null),[de,P,r]),Ga=s.useMemo(()=>g||w?!0:_a==="base"?de.trim()===""||r.trim()==="":_a==="final"?r.trim()==="":!0,[g,de,w,r,_a]),Ct=s.useMemo(()=>!!(B||de.trim()||r.trim()),[B,de,r]),Qa=s.useCallback(a=>{if(!a)return;const t=a.cycleId||a.id;if(t){if(i!=null&&i.id&&t===i.id){j("/");return}j(`/cycle/${t}`)}},[i==null?void 0:i.id,j]),Za=s.useCallback(async(a,t)=>{if(a){Xa(l=>l.includes(a)?l:[...l,a]);try{await te(a,t),k({title:t?"Ciclo ignorado":"Ciclo incluido",description:t?"El ciclo se excluyó del cálculo automático.":"El ciclo se volvió a incluir en el cálculo automático."})}catch{}finally{Xa(l=>l.filter(n=>n!==a))}}},[te,k]),qe=s.useCallback((a,t)=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),t())},[]),jt=s.useCallback(()=>{var o;const a=typeof((o=h.shortestCycle)==null?void 0:o.duration)=="number"&&Number.isFinite(h.shortestCycle.duration)?h.shortestCycle.duration:null,t=typeof h.value=="number"&&Number.isFinite(h.value)?h.value:null,l=T?I:a,n=T?_:t;Ne(typeof l=="number"&&Number.isFinite(l)?String(l):""),ie(typeof n=="number"&&Number.isFinite(n)?String(n):""),Ce(""),Y(""),Ve(T?typeof I=="number"&&Number.isFinite(I)?"base":typeof _=="number"&&Number.isFinite(_)?"final":null:null),ze(!1),ba(u=>T?"manual":u==="none"?"none":"auto"),Ie(!0)},[L.canCompute,h,T,I,_]),et=s.useCallback(()=>{ze(!1),Ae(!1),sa(!1),Ie(!1)},[]),wt=s.useCallback(a=>{const{value:t}=a.target;if(Ne(t),Ve("base"),Ce(""),Y(""),!t.trim()){ie("");return}const l=Number.parseInt(t,10);if(!Number.isFinite(l)){Ce("Introduce un número entero válido."),ie("");return}const n=l-ke;if(n<0){Ce("El resultado debe ser ≥ 0 días"),ie("");return}ie(String(n))},[ke]),St=s.useCallback(a=>{const{value:t}=a.target;if(ie(t),Ve("final"),Y(""),Ce(""),!t.trim()){Ne("");return}const l=t.replace(",","."),n=Number.parseFloat(l);if(!Number.isFinite(n)){Y("Introduce un número válido."),Ne("");return}if(n<0){Y("El CPM debe ser ≥ 0"),Ne("");return}const o=n+ke,u=Math.round(o);Ne(String(u))},[ke]),Dt=s.useCallback(async()=>{if($e||Pe)return;const a=re.trim(),t=K.trim(),l=ce??(t?"final":a?"base":null);if(!l){Y("Introduce un valor.");return}let n=I,o;if(l==="base"){if(!a){Ce("Introduce un número entero válido.");return}const f=Number.parseInt(a,10);if(!Number.isFinite(f)){Ce("Introduce un número entero válido.");return}const m=f-ke;if(m<0){Ce("El resultado debe ser ≥ 0 días");return}n=f,o=m,ie(String(m)),Y("")}else{if(!t){Y("Introduce un valor.");return}const f=t.replace(",","."),m=Number.parseFloat(f);if(!Number.isFinite(m)||m<0){Y("El CPM debe ser ≥ 0 días");return}o=m;const v=Number.parseInt(a,10);Number.isFinite(v)&&v-ke>=0?n=v:a||(n=null)}const u=_,c=T,S=I;je(o),ue(!0),q(typeof n=="number"&&Number.isFinite(n)?n:null);try{await We({finalValue:o,baseValue:n}),Ie(!1),k({title:"CPM actualizado",description:"El CPM manual se guardó en tu perfil."})}catch(f){console.error("Failed to save manual CPM value",f),je(u),q(S),ue(c),Y("No se pudo guardar el CPM. Inténtalo de nuevo.")}},[ke,T,$e,re,oe,I,ce,Pe,K,_,We,k]),at=s.useCallback(async()=>{const a=_,t=T,l=I;je(null),q(null),ue(!1),Ne(""),ie(""),Ce(""),Y(""),Ve(null);try{await We({finalValue:null,baseValue:null}),k({title:"CPM borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(n){console.error("Failed to delete manual CPM value",n),je(a),q(l),ue(t),Y("No se pudo borrar el CPM. Inténtalo de nuevo.")}},[T,I,_,We,k]),kt=s.useCallback(async()=>{sa(!0);try{await at(),Ae(!1)}finally{sa(!1)}},[at]),Ge=s.useCallback(a=>{ba(a)},[]),Ft=s.useCallback(()=>{var o;const a=typeof((o=b.earliestCycle)==null?void 0:o.riseDay)=="number"&&Number.isFinite(b.earliestCycle.riseDay)?b.earliestCycle.riseDay:null,t=typeof b.value=="number"&&Number.isFinite(b.value)?b.value:null,l=B?F:a,n=B?z:t;Ue(typeof l=="number"&&Number.isFinite(l)?String(l):""),x(typeof n=="number"&&Number.isFinite(n)?String(n):""),N(""),E(""),me(B?typeof F=="number"&&Number.isFinite(F)?"base":typeof z=="number"&&Number.isFinite(z)?"final":null:null),Ea(!1),Ua(u=>B?"manual":u==="none"?"none":"auto"),na(!0)},[b,B,F,z]),tt=s.useCallback(()=>{na(!1),Ea(!1),ra(!1),$a(!1)},[]),Mt=s.useCallback(a=>{const{value:t}=a.target;if(Ue(t),me("base"),N(""),E(""),!t.trim()){x("");return}const l=Number.parseInt(t,10);if(!Number.isFinite(l)){N("Introduce un número entero válido."),x("");return}if(l<9){N("El T-8 debe ser ≥ 1"),x("");return}const n=Math.max(1,l-8);x(String(n))},[]),It=s.useCallback(a=>{const{value:t}=a.target;if(x(t),me("final"),E(""),N(""),!t.trim())return;const l=Number.parseInt(t,10);(!Number.isFinite(l)||l<1)&&E("El T-8 debe ser ≥ 1")},[]),Tt=s.useCallback(async()=>{if(g||w)return;const a=de.trim(),t=r.trim(),l=P??(t?"final":a?"base":null);if(!l){E("Introduce un valor.");return}let n=F,o;if(l==="base"){if(!a){N("Introduce un número entero válido.");return}const f=Number.parseInt(a,10);if(!Number.isFinite(f)){N("Introduce un número entero válido.");return}if(f<9){N("El T-8 debe ser ≥ 1");return}const m=Math.max(1,f-8);n=f,o=m,x(String(m)),E("")}else{if(!t){E("Introduce un valor.");return}const f=Number.parseInt(t,10);if(!Number.isFinite(f)||f<1){E("El T-8 debe ser ≥ 1");return}o=f;const m=Number.parseInt(a,10);Number.isFinite(m)&&m>=9?n=m:a||(n=null)}const u=z,c=B,S=F;fe(o),De(!0),le(typeof n=="number"&&Number.isFinite(n)?n:null);try{await Xe({finalValue:o,baseValue:n}),na(!1),k({title:"T-8 actualizado",description:"El T-8 manual se guardó en tu perfil."})}catch(f){console.error("Failed to save manual T-8 value",f),fe(u),le(S),De(c),E("No se pudo guardar el T-8. Inténtalo de nuevo.")}},[B,g,de,F,P,w,r,z,Xe,k]),st=s.useCallback(async()=>{const a=z,t=B,l=F;fe(null),le(null),De(!1),Ue(""),x(""),N(""),E(""),me(null);try{await Xe({finalValue:null,baseValue:null}),k({title:"T-8 borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(n){console.error("Failed to delete manual T-8 value",n),fe(a),le(l),De(t),N("No se pudo borrar el T-8. Inténtalo de nuevo.")}},[B,F,z,Xe,k]),Et=s.useCallback(async()=>{$a(!0);try{await st(),ra(!1)}finally{$a(!1)}},[st]),Qe=s.useCallback(a=>{Ua(a)},[]),Te=s.useCallback(()=>{ve(null),xa(null),Se(!1)},[]),$t=s.useCallback(()=>{we((i==null?void 0:i.startDate)||""),se(""),Te(),pa(!0)},[i==null?void 0:i.startDate,Te]),Ze=s.useCallback(()=>{pa(!1),se(""),Te(),we((i==null?void 0:i.startDate)||"")},[i==null?void 0:i.startDate,Te]),Pt=s.useCallback(()=>{Te()},[Te]),Bt=s.useCallback(async()=>{if(!V){se("La fecha de inicio es obligatoria");return}if(i!=null&&i.id){se(""),M(!0);try{const a=H?await H(i.id,V):null;if(a){ve(V),xa(a),Se(!0),M(!1);return}await ge(i.id,V),await ae({silent:!0}),k({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),Ze()}catch(a){console.error("Error updating start date from dashboard:",a),se("No se pudo actualizar la fecha de inicio"),k({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{M(!1)}}},[V,i==null?void 0:i.id,H,ge,ae,k,Ze]),At=s.useCallback(async()=>{if(!(i!=null&&i.id)||!ye){Te();return}M(!0),Se(!1);try{await X(i.id,ye),await ae({silent:!0}),k({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),Ze()}catch(a){console.error("Error forcing start date from dashboard:",a),se("No se pudo actualizar la fecha de inicio"),k({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{M(!1),Te()}},[i==null?void 0:i.id,ye,X,ae,k,Ze,Te]),[Ot,Oe]=s.useState(!1),[_t,nt]=s.useState(!1),[rt,ea]=s.useState(!1),[la,oa]=s.useState(null),[Lt,aa]=s.useState(null),Rt=!!(la&&String(la.id||"").startsWith("placeholder-")),Vt=s.useMemo(()=>{var t;const a=(t=i==null?void 0:i.data)==null?void 0:t.find(l=>(l==null?void 0:l.peak_marker)==="peak");return(a==null?void 0:a.isoDate)||null},[i==null?void 0:i.data]),lt=s.useCallback(()=>{Oe(!1),oa(null),aa(null)},[]),zt=s.useCallback(a=>{oa(a)},[]),Ut=s.useCallback((a,t=null)=>{oa(a),aa(t??null),Oe(!0)},[]),Ht=s.useCallback(async(a,t=!0)=>{if(!(i!=null&&i.id)||!(a!=null&&a.isoDate))return;const l=o=>{if(o==null||o==="")return null;const u=parseFloat(String(o).replace(",","."));return Number.isFinite(u)?u:null},n=t??!(a.peak_marker==="peak"||a.peakStatus==="P");try{const o=a.timestamp?Me(Fe(a.timestamp),"HH:mm"):Me(new Date,"HH:mm");let u=Array.isArray(a.measurements)&&a.measurements.length>0?a.measurements:[{temperature:a.temperature_chart??a.temperature_raw??null,temperature_corrected:a.temperature_corrected??null,time:a.time??o,time_corrected:a.time_corrected??o,selected:!0,use_corrected:a.use_corrected??!1}];u.length===0&&(u=[{temperature:null,temperature_corrected:null,time:o,time_corrected:o,selected:!0,use_corrected:!1}]);const c=u.map((m,v)=>{const $=m.time||o,p=m.time_corrected||$;return{temperature:l(m.temperature??m.temperature_raw),time:$,selected:v===0?!0:!!m.selected,temperature_corrected:l(m.temperature_corrected),time_corrected:p,use_corrected:!!m.use_corrected}});c.some(m=>m.selected)||(c[0].selected=!0);const S={isoDate:a.isoDate,measurements:c,mucusSensation:a.mucus_sensation??a.mucusSensation??"",mucusAppearance:a.mucus_appearance??a.mucusAppearance??"",fertility_symbol:a.fertility_symbol??"none",observations:a.observations??"",ignored:a.ignored??!1,peak_marker:n?"peak":null},f=a!=null&&a.id&&!String(a.id).startsWith("placeholder-")?a:null;await ee(S,f)}catch(o){console.error("Error toggling peak marker from dashboard:",o)}},[ee,i==null?void 0:i.id]);if(Re&&!(i!=null&&i.id))return e.jsx("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:e.jsx("p",{className:"text-center text-gray-600 text-lg",children:"Cargando..."})});if(!(i!=null&&i.id))return e.jsxs("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-gray-600 text-lg",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>ea(!0),className:"px-6 py-3 rounded-lg bg-pink-600 hover:bg-pink-700 text-white shadow",children:"Iniciar ciclo"})]}),e.jsx(mt,{isOpen:rt,onClose:()=>ea(!1),onConfirm:async a=>{await Ee(a),ea(!1),aa(null),Oe(!0)}})]});const Jt=ka(fa(new Date),Fe(i.startDate))+1,Wt=async(a,{keepFormOpen:t=!1}={})=>{nt(!0);try{await ee(a,la),t||(Oe(!1),oa(null),aa(null))}finally{nt(!1)}},Xt=async a=>{await Ee(a),ea(!1),aa(null),Oe(!0)};return e.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"max-w-md mx-auto flex w-full flex-1 flex-col",children:e.jsxs(Z.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex flex-1 flex-col",children:[e.jsx(bs,{cycleData:{...i,currentDay:Jt,records:i.data},onEdit:Ut,onTogglePeak:Ht,currentPeakIsoDate:Vt,onEditStartDate:$t,handleOpenCpmDialog:jt,handleOpenT8Dialog:Ft,cpmMetric:xt,t8Metric:bt}),e.jsx(_e,{open:A,onOpenChange:a=>{a||et()},children:e.jsxs(Le,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col rounded-3xl border border-pink-100 bg-white/95 text-gray-800 shadow-xl overflow-hidden p-0",children:[e.jsxs(ca,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(ua,{children:"Editar CPM"}),e.jsx(Va,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${Ca==="manual"?"bg-rose-100 text-rose-700":Ca==="auto"?"bg-emerald-50 text-emerald-700":"bg-gray-100 text-gray-600"}`,children:gt})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>Ge("auto"),onKeyDown:a=>qe(a,()=>Ge("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${O==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-emerald-200"} ${L.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:L.canCompute&&L.value!==null?`CPM automático: ${ht} días`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${O==="auto"?"border-emerald-400 bg-emerald-400":"border-emerald-300 bg-white"}`,children:O==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>ze(a=>!a),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":Be,children:L.highlightLabel})]}),L.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:L.summary}),!L.detailsAvailable&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."}),Be&&L.detailsAvailable&&e.jsx("div",{className:"mt-2 space-y-2",children:L.cycles.length>0?e.jsx("ul",{className:"space-y-1",children:L.cycles.map((a,t)=>{const l=a.cycleId||a.id||`${a.displayName||a.name||a.startDate||"cycle"}-${t}`,n=typeof a.duration=="number"&&Number.isFinite(a.duration)?`${a.duration} días`:"duración desconocida",o=!!(L.shortestCycle&&L.shortestCycle===a),u=a.cycleId||a.id,c=!!(a.isIgnored||a.ignoredForAutoCalculations),S=u?Wa.includes(u):!1,f=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${c?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/50"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${f} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>Qa(a),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:a.dateRangeLabel||a.displayName||a.name||"Ciclo sin nombre"}),e.jsx(Ra,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Duración: ",n]}),o&&e.jsx("span",{className:"rounded-full bg-rose-100 px-2 py-0.5 font-semibold text-rose-600",children:"Ciclo más corto"})]}),c&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Q,{type:"button",variant:"outline",size:"xs",disabled:!u||S,onClick:()=>u&&Za(u,!c),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:c?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":c?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":c,children:S?e.jsxs(e.Fragment,{children:[e.jsx(it,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):c?e.jsx(ut,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(dt,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},l)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":O==="manual",onClick:()=>Ge("manual"),onKeyDown:a=>qe(a,()=>Ge("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${O==="manual"?"border-rose-300 bg-rose-50":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${O==="manual"?"border-rose-400 bg-rose-400":"border-rose-300 bg-white"}`,children:O==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Da,{htmlFor:"manual-cpm-base",className:"text-xs text-gray-600",children:"Ciclo más corto"}),e.jsx(ma,{id:"manual-cpm-base",type:"number",inputMode:"numeric",step:"1",min:"0",value:re,onChange:wt,placeholder:"Introduce un entero","aria-describedby":ce?"manual-cpm-helper":void 0}),$e&&e.jsx("p",{className:"text-xs text-red-500",children:$e})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Da,{htmlFor:"manual-cpm-final",className:"text-xs text-gray-600",children:"CPM obtenido"}),e.jsx(ma,{id:"manual-cpm-final",type:"number",inputMode:"decimal",step:"0.1",min:"0",value:K,onChange:St,placeholder:"Introduce el valor","aria-describedby":ce?"manual-cpm-helper":void 0}),Pe&&e.jsx("p",{className:"text-xs text-red-500",children:Pe})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:[ce&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-cpm-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:ce==="base"?"Usando Ciclo más corto como base":"Usando CPM (final)"})}),e.jsx(Q,{type:"button",variant:"outline",onClick:()=>Ae(!0),disabled:!Nt,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"})]}),qa&&!T&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":O==="none",onClick:()=>Ge("none"),onKeyDown:a=>qe(a,()=>Ge("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${O==="none"?"border-gray-300 bg-gray-50":"border-dashed border-rose-200 bg-white/70 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${O==="none"?"border-gray-400 bg-gray-400":"border-gray-300 bg-white"}`,children:O==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(da,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(Q,{type:"button",variant:"secondary",onClick:et,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(Q,{type:"button",onClick:Dt,disabled:qa,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(_e,{open:ha,onOpenChange:Ae,children:e.jsxs(Le,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(ca,{children:e.jsx(ua,{children:"¿Estás segura de que quieres borrar el valor manual de CPM?"})}),e.jsxs(da,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(Q,{type:"button",variant:"secondary",onClick:()=>Ae(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(Q,{type:"button",variant:"destructive",onClick:kt,disabled:ga,className:"w-full sm:w-auto",children:ga?"Borrando…":"Borrar"})]})]})}),e.jsx(_e,{open:Ta,onOpenChange:a=>{a||tt()},children:e.jsxs(Le,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col rounded-3xl border border-pink-100 bg-white/95 text-gray-800 shadow-xl overflow-hidden p-0",children:[e.jsxs(ca,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(ua,{children:"Editar T-8"}),e.jsx(Va,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${ja==="manual"?"bg-rose-100 text-rose-700":ja==="auto"?"bg-emerald-50 text-emerald-700":"bg-gray-100 text-gray-600"}`,children:vt})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>Qe("auto"),onKeyDown:a=>qe(a,()=>Qe("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${U==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-emerald-200"} ${b.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:b.canCompute&&b.value!==null?`T-8 automático: Día ${yt}`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${U==="auto"?"border-emerald-400 bg-emerald-400":"border-emerald-300 bg-white"}`,children:U==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>Ea(a=>!a),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":Ha,children:Aa.highlightLabel})]}),Aa.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:Aa.summary}),b.cycleCount===0&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."}),Ha&&b.cycleCount>0&&e.jsx("div",{className:"mt-2 space-y-2",children:b.cyclesConsidered.length>0?e.jsx("ul",{className:"space-y-1",children:b.cyclesConsidered.map((a,t)=>{const l=a.cycleId||`${a.displayName}-${a.riseDay}-${t}`,n=typeof a.riseDay=="number"&&Number.isFinite(a.riseDay)?a.riseDay:"—",o=a.cycleId||a.id,u=!!(a.isIgnored||a.ignoredForAutoCalculations),c=o?Wa.includes(o):!1,S=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${u?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/40"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${S} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>Qa(a),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:a.dateRangeLabel||a.displayName||a.name||"Ciclo sin nombre"}),e.jsx(Ra,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Día de subida: ",n]}),Number.isFinite(a.t8Day)&&e.jsxs("span",{children:["T-8: Día ",a.t8Day]})]}),u&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Q,{type:"button",variant:"outline",size:"icon",disabled:!o||c,onClick:()=>o&&Za(o,!u),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:u?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":u?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":u,children:c?e.jsxs(e.Fragment,{children:[e.jsx(it,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):u?e.jsx(ut,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(dt,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},l)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":U==="manual",onClick:()=>Qe("manual"),onKeyDown:a=>qe(a,()=>Qe("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${U==="manual"?"border-rose-300 bg-rose-50":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${U==="manual"?"border-rose-400 bg-rose-400":"border-rose-300 bg-white"}`,children:U==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Da,{htmlFor:"manual-t8-base",className:"text-xs text-gray-600",children:"Ciclo con subida (día)"}),e.jsx(ma,{id:"manual-t8-base",type:"number",inputMode:"numeric",step:"1",min:"9",value:de,onChange:Mt,placeholder:"Día de subida","aria-describedby":P?"manual-t8-helper":void 0}),g&&e.jsx("p",{className:"text-xs text-red-500",children:g})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Da,{htmlFor:"manual-t8-final",className:"text-xs text-gray-600",children:"T-8 manual (día)"}),e.jsx(ma,{id:"manual-t8-final",type:"number",inputMode:"numeric",step:"1",min:"1",value:r,onChange:It,placeholder:"Día del T-8","aria-describedby":P?"manual-t8-helper":void 0}),w&&e.jsx("p",{className:"text-xs text-red-500",children:w})]})]}),e.jsx("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:P&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-t8-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:P==="base"?"Usando día de subida como base":"Usando T-8 manual"})})}),e.jsx(Q,{type:"button",variant:"outline",onClick:()=>ra(!0),disabled:!Ct,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"}),Ga&&!B&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":U==="none",onClick:()=>Qe("none"),onKeyDown:a=>qe(a,()=>Qe("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${U==="none"?"border-gray-300 bg-gray-50":"border-dashed border-rose-200 bg-white/70 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${U==="none"?"border-gray-400 bg-gray-400":"border-gray-300 bg-white"}`,children:U==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(da,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(Q,{type:"button",variant:"secondary",onClick:tt,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(Q,{type:"button",onClick:Tt,disabled:Ga,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(_e,{open:pt,onOpenChange:ra,children:e.jsxs(Le,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(ca,{children:e.jsx(ua,{children:"¿Estás segura de que quieres borrar el valor manual de T-8?"})}),e.jsxs(da,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(Q,{type:"button",variant:"secondary",onClick:()=>ra(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(Q,{type:"button",variant:"destructive",onClick:Et,disabled:Ja,className:"w-full sm:w-auto",children:Ja?"Borrando…":"Borrar"})]})]})}),e.jsx(_e,{open:Ma,onOpenChange:a=>{a||Ze()},children:e.jsx(Le,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(ts,{cycle:i,startDate:V,endDate:i.endDate,onStartDateChange:a=>we(a),onSave:Bt,onCancel:Ze,isProcessing:za,dateError:ta,includeEndDate:!1,showOverlapDialog:ne,overlapCycle:Ia,onConfirmOverlap:At,onCancelOverlap:Pt,onClearError:()=>se(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",className:"w-full"})})})]})}),e.jsx(_e,{open:Ot,onOpenChange:a=>{a?Oe(!0):lt()},children:e.jsx(Le,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(ns,{onSubmit:Wt,onCancel:lt,initialData:la,cycleStartDate:i.startDate,cycleEndDate:i.endDate,isProcessing:_t,isEditing:!!la&&!Rt,cycleData:i.data,onDateSelect:zt,initialSectionKey:Lt})})}),e.jsx(hs,{onAddRecord:()=>{oa(null),aa(null),Oe(!0)},onAddCycle:()=>ea(!0)}),e.jsx(mt,{isOpen:rt,onClose:()=>ea(!1),onConfirm:Xt,currentCycleStartDate:i.startDate})]})};export{Ms as default};
