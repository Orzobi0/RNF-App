import{c as xt,r,g as y,f as m,j as s,H as C,B as ft,K as ra,V as S,S as Pe,l as N,u as Wa,b as Ga,W as Ka,n as Za,m as be}from"./index-1Lm-G_PV.js";import{L as pt,T as Ja,a as Qa,N as es,P as ts,C as as}from"./PostpartumExitDialog-CEK8JgwJ.js";import{T as ss,e as rs,d as ns,b as os,m as Jt,f as we,g as ls,A as is,h as cs,D as us}from"./DataEntryForm-DyT-Zmik.js";import{l as Ce,P as ds}from"./badge-BIiH4rlp.js";import{a as ms,H as fs,D as ps}from"./DeletionDialog-Cv8FnlL5.js";import{u as hs,D as xs,a as gs}from"./useCycleData-O3LOYKfm.js";import{c as ys,F as Qt,i as Oe}from"./computePeakStatuses-P7Htr2a9.js";import"./OverlapWarningDialog-BV8YTdug.js";import"./input-Dw-8uckr.js";import"./label-EI0mLLM6.js";import"./eye-BO0jdhTY.js";const ea=xt("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),bs=xt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),ws=xt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),Ds=({isoDate:c,cycleDay:w,details:o,peakStatus:b,isPeakDay:j,onEdit:p,onDelete:T,onAdd:M,onToggleRelations:Se,isProcessing:E})=>{const $e=!!o?.record,Ne=r.useMemo(()=>{if(!c)return null;try{return y(m(c),"dd/MM/yyyy",{locale:Ce})}catch{return null}},[c]),me=o?.symbolInfo?.label||"Sin símbolo",ze=o?.symbolInfo?.value||"none",Be=o?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",je=()=>{!o?.record||!p||p(o.record,null)},Q=()=>{!o?.record?.id||!T||T(o.record.id)},He=()=>{!c||!M||M(c)},F=(k,L=null)=>{if(o?.record&&p){p(o.record,k,L);return}c&&M&&M(c,k,L)},Ve=()=>{!c||!Se||Se(c)},H=(k,L={})=>k&&typeof k=="string"&&k.trim().length>0||typeof k=="number"?k:L.placeholder||"—",Ue=o?.hasTemperature?`${o.displayTemp} °C`:"—",Ye=o?.timeValue||"—",Xe=!!o?.timeValue,qe=o?.hasMucusSensation?o.mucusSensation:"—",We=o?.hasMucusAppearance?o.mucusAppearance:"—",ke=o?.observationsText?.trim(),ee=!!o?.hasRelations;let te=null,fe=null;b&&(b==="P"||j?(te="Día pico",fe="peak"):(te=`+${b}`,fe="post-peak"));const Ge=()=>{switch(ze){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!c)return s.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const V="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return s.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Ne,w?` · Día ${w}`:""]}),te&&s.jsx("span",{className:C("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:te})]}),s.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[s.jsx("button",{type:"button",onClick:()=>F("symbol","fertilitySymbol"),className:C("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ge(),Be),title:me,"aria-label":me}),$e?s.jsxs(s.Fragment,{children:[s.jsxs(ft,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:je,disabled:E,children:[E?s.jsx(pt,{className:"h-4 w-4 animate-spin"}):s.jsx(ws,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Editar registro"})]}),s.jsxs(ft,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:Q,disabled:E,children:[E?s.jsx(pt,{className:"h-4 w-4 animate-spin"}):s.jsx(Ja,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):s.jsxs(ft,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:He,disabled:E,children:[E&&s.jsx(pt,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),s.jsxs("div",{className:"mt-4 space-y-3",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>F("temperature","temperature"),className:C(V,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[s.jsx(ss,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"font-semibold",children:H(Ue)}),o?.showCorrectedIndicator&&s.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),s.jsxs("button",{type:"button",onClick:()=>F("temperature","time"),className:C(V,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Xe?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[s.jsx(rs,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:H(Ye)})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>F("sensation","mucusSensation"),className:C(V,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[s.jsx(ns,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:H(qe)})]}),s.jsxs("button",{type:"button",onClick:()=>F("appearance","mucusAppearance"),className:C(V,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[s.jsx(os,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:H(We)})]})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>F("observations","observations"),className:C(V,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",ke?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[s.jsx(bs,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"truncate",children:H(ke,{placeholder:"-"})})]}),s.jsx("button",{type:"button",onClick:Ve,disabled:E,className:C("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",ee?"border-rose-50 bg-rose-50":"border-slate-200 bg-white",E&&"opacity-70 cursor-not-allowed"),title:ee?"Hubo relaciones":"Sin relaciones","aria-label":ee?"Hubo relaciones":"Sin relaciones",children:s.jsx(ra,{className:C("h-4 shrink-0 w-4",ee?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},na=c=>c.replace(".","").toLowerCase(),De=c=>na(y(c,"MMM",{locale:Ce})),vs=c=>na(y(c,"d MMM yyyy",{locale:Ce})),Cs=({startDate:c,endDate:w})=>{if(!w){if(!c)return"Mis registros";const M=m(c);return S(M)?`${vs(M)} - actualidad`:"Mis registros"}if(!c)return"Mis registros";const o=m(c),b=m(w);if(!S(o)||!S(b))return"Mis registros";const j=o.getFullYear()===b.getFullYear();if(j&&o.getMonth()===b.getMonth())return`${o.getDate()}–${b.getDate()} ${De(o)} ${o.getFullYear()}`;if(j)return`${o.getDate()} ${De(o)} – ${b.getDate()} ${De(b)} ${o.getFullYear()}`;const T=`${o.getFullYear()}–${String(b.getFullYear()).slice(-2)}`;return`${o.getDate()} ${De(o)} – ${b.getDate()} ${De(b)} · ${T}`},Ss=({startDate:c,endDate:w,recordCount:o=0,referenceDate:b=new Date})=>{if(!c)return`${o} registros`;const j=m(c);if(!S(j))return`${o} registros`;if(!w)return`Día ${Pe(N(b),N(j))+1} · ${o} registros`;const p=m(w);return S(p)?`${Pe(N(p),N(j))+1} días · ${o} registros`:`${o} registros`},Ns=c=>Qt.find(w=>w.value===c)||Qt[0],ta=10,ht=60,aa=750,sa=120,js=85,ks=5,ve=180,Ms=c=>{if(c==null||c==="")return null;const w=Number(typeof c=="string"?c.replace(",","."):c);return Number.isFinite(w)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(w):null},Es=({cycle:c,headerTitle:w,headerIcon:o=ea,headerActions:b,topAccessory:j,includeEndDate:p=!1,addOrUpdateDataPoint:T,deleteRecord:M,isLoading:Se,updateCycleDates:E,checkCycleOverlap:$e,forceShiftNextCycleStart:Ne,forceUpdateCycleStart:me,startNewCycle:ze,refreshData:Be,afterRecordsContent:je=null,onRequestDeleteCycle:Q=null,dateEditorDeleteTitle:He="Eliminar ciclo",dateEditorDeleteDescription:F="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:Ve="Eliminar ciclo",isDeletingCycle:H=!1}={})=>{const{currentCycle:Ue,addOrUpdateDataPoint:Ye,deleteRecord:Xe,isLoading:qe,updateCycleDates:We,checkCycleOverlap:ke,forceUpdateCycleStart:ee,forceShiftNextCycleStart:te,startNewCycle:fe,refreshData:Ge,getMeasurementsForEntry:V}=hs(),{preferences:k,savePreferences:L}=Wa(),n=c??Ue,oa=Se??qe,Ke=T||(async(e,t)=>{if(n?.id)return Ye(e,t,n.id)}),la=M||(async e=>{if(n?.id)return Xe(e,n.id)}),Me=E||(async(e,t,a)=>We(e??n?.id,t,a)),Ze=$e??ke,gt=me||(async(e,t)=>ee(e??n?.id,t)),Je=Ne||(async(e,t,a)=>te(e??n?.id,t,a)),ia=ze??fe,Ee=Be??Ge,Qe=V,{toast:R}=Ga(),[ca,U]=r.useState(!1),[et,Y]=r.useState(null),[ae,tt]=r.useState(null),[se,re]=r.useState(!1),[ua,at]=r.useState(!1),[da,yt]=r.useState(!1),[X,Re]=r.useState(()=>n?.startDate||""),[q,_e]=r.useState(()=>n?.endDate||""),[ma,O]=r.useState(""),[P,bt]=r.useState(null),[st,wt]=r.useState(null),[rt,Dt]=r.useState(!1),[fa,vt]=r.useState(null),[pa,nt]=r.useState(!1),[ot,pe]=r.useState(!1),[x,W]=r.useState(null),[ha,G]=r.useState(null),[xa,he]=r.useState(null),[ga,ne]=r.useState(null),[ya,lt]=r.useState(!1),[ba,it]=r.useState(!1),Ct=n?.data?.length??0,St=!n?.endDate,wa=r.useCallback(async()=>{it(!1),typeof L=="function"&&await L({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[L]),Da=r.useMemo(()=>w||Cs({startDate:n?.startDate,endDate:n?.endDate}),[n?.endDate,n?.startDate,w]),Nt=r.useMemo(()=>Ss({startDate:n?.startDate,endDate:n?.endDate,recordCount:Ct}),[n?.endDate,n?.startDate,Ct]),jt=!0,Ae=r.useRef(null),kt=r.useRef(null),Mt=r.useRef(0),xe=r.useRef(null),[Et,Rt]=r.useState(0),Ie=r.useCallback(()=>{const e=Ae.current;if(!e){Mt.current=0,Rt(0);return}const a=e.getBoundingClientRect().height;Mt.current=a,Rt(l=>Math.abs(l-a)>.5?a:l)},[]);r.useLayoutEffect(()=>{let e=window.requestAnimationFrame(Ie);const t=()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(Ie)};window.addEventListener("resize",t);let a;return typeof ResizeObserver<"u"&&(a=new ResizeObserver(()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(Ie)}),Ae.current&&a.observe(Ae.current)),()=>{window.removeEventListener("resize",t),a&&a.disconnect(),e&&window.cancelAnimationFrame(e)}},[Ie]);const _t=r.useMemo(()=>Math.max(Math.round(Et+ta),ta),[Et]);r.useEffect(()=>{Re(n?.startDate||""),_e(n?.endDate||"")},[n?.startDate,n?.endDate]);const Te=r.useMemo(()=>n?.data?.length?[...n.data].filter(e=>e?.isoDate).sort((e,t)=>{const a=m(e.isoDate);return m(t.isoDate)-a}).map(e=>e.isoDate):[],[n?.data]);r.useEffect(()=>{const e=kt.current;e&&e.scrollTo({top:0,behavior:"auto"})},[]);const oe=r.useMemo(()=>n?.data?.length?n.data.map(e=>{if(!e?.isoDate)return null;const t=m(e.isoDate);return S(t)?t:null}).filter(Boolean):[],[n?.data]),At=r.useMemo(()=>new Set(Te),[Te]),K=r.useMemo(()=>ys(n?.data??[]),[n?.data]),le=r.useMemo(()=>{const e=new Map;return n?.data?.length&&n.data.forEach(t=>{if(!t?.isoDate)return;const a=t.measurements?.find(qa=>qa?.selected)||(t.temperature_chart||t.temperature_raw?{temperature:t.temperature_chart??t.temperature_raw,temperature_corrected:t.temperature_corrected??null,time:t.timestamp?y(m(t.timestamp),"HH:mm"):null,use_corrected:t.use_corrected??!1}:null),l=a?.use_corrected??t.use_corrected??!1,i=a?.temperature_corrected??t.temperature_corrected??null,u=a?.temperature??t.temperature_chart??t.temperature_raw??null,g=Ms(l&&i!==null&&i!==void 0&&i!==""?i:u??i),d=g!==null,v=l&&i!==null&&i!==void 0&&i!=="";let f=null;a?.time?f=a.time:t.timestamp&&S(m(t.timestamp))&&(f=y(m(t.timestamp),"HH:mm"));const _=t.mucusSensation??t.mucus_sensation??"",ue=t.mucusAppearance??t.mucus_appearance??"",de=!!_,B=!!ue,mt=de||B,ye=t.observations||"",Le=!!ye,Ua=!!(t.had_relations??t.hadRelations??!1),Zt=K[t.isoDate]||null,Ya=t.peak_marker==="peak"||Zt==="P",Xa=Ns(t.fertility_symbol);e.set(t.isoDate,{record:t,symbolInfo:Xa,hasTemperature:d,displayTemp:g,showCorrectedIndicator:v,timeValue:f,hasMucus:mt,hasMucusSensation:de,hasMucusAppearance:B,mucusSensation:_,mucusAppearance:ue,hasObservations:Le,observationsText:ye,hasRelations:Ua,peakStatus:Zt,isPeakDay:Ya})}),e},[n?.data,K]),h=r.useMemo(()=>{if(!n?.startDate)return null;const e=m(n.startDate);if(!S(e))return null;let t;if(n?.endDate)t=m(n.endDate);else{const a=N(new Date),l=[e,a];oe.length&&l.push(Jt(oe)),t=Jt(l)}return S(t)?{from:e,to:t}:{from:e,to:e}},[n?.startDate,n?.endDate,oe]),va=r.useMemo(()=>{const e={};return h&&(e.outsideCycle=t=>we(t,h.from)||Oe(t,h.to),e.insideCycleNoRecord=t=>{if(we(t,h.from)||Oe(t,h.to))return!1;const a=y(t,"yyyy-MM-dd");return!At.has(a)}),oe.length&&(e.hasRecord=oe),e},[h,oe,At]),Ca=r.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:C(Ka({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[It,ct]=r.useState(()=>x&&S(m(x))?m(x):h?.to?h.to:N(new Date)),ge=r.useRef(!1),A=r.useRef(null),Sa=r.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),Z=r.useRef(null),Tt=r.useRef(null),Ft=r.useRef(null),Lt=r.useRef(0),[Na,ja]=r.useState(0),[Ot,Pt]=r.useState(!1),$=r.useCallback(e=>{Lt.current=e,ja(e)},[]),$t=r.useCallback(()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(e)})}),[]),ie=r.useCallback((e,{duration:t=ve}={})=>{A.current&&(cancelAnimationFrame(A.current),A.current=null);const a=Lt.current,l=e-a;return Math.abs(l)<.5||t<=0?($(e),Promise.resolve()):new Promise(i=>{const u=d=>1-Math.pow(1-d,3),D=performance.now(),g=d=>{const v=d-D,f=Math.min(1,v/t),_=a+l*u(f);if($(_),f<1){A.current=requestAnimationFrame(g);return}A.current=null,i()};A.current=requestAnimationFrame(g)})},[$]),ka=r.useMemo(()=>({labelDay:e=>{const t=y(e,"yyyy-MM-dd"),a=le.get(t),l=y(e,"d MMM",{locale:Ce}),i=a?.peakStatus??K[t]??null,u=[];if(a?.hasTemperature&&a?.hasMucus?u.push("temperatura y moco"):a?.hasTemperature?u.push("temperatura"):a?.hasMucus&&u.push("moco"),a?.hasRelations&&u.push("RS"),i){const D=i==="P"?"pico ✖":`pico +${i}`;u.push(D)}return u.length?`${l}: ${u.join("; ")}`:l}}),[K,le]),Ma=r.useCallback(({date:e,activeModifiers:t})=>{const a=y(e,"yyyy-MM-dd"),l=le.get(a),i=l?.hasTemperature??!1,u=l?.hasMucus??!1,D=l?.hasRelations??!1,g=l?.peakStatus??K[a]??null,d=l?.symbolInfo,v=d?.value,f=t.selected,_=t.today,ue=C("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",i?"bg-amber-500":"bg-transparent",i&&f?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),de=C("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",u?"bg-teal-500":"bg-transparent",u&&f?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),B=!!(v&&v!=="none"),mt=C("relative z-10 text-[1.15rem] leading-none",t.outside||t.outsideCycle?"text-slate-300":f?B?"text-white":"text-fertiliapp-fuerte":_?"text-subtitulo font-semibold":"text-slate-700"),ye=g==="P"?"✖":g?`+${g}`:null,Le=B?C("pointer-events-none absolute inset-0 rounded-full transition-opacity",d?.color??"",d?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",v==="white"?"ring-1 ring-slate-300/70":"",f?"opacity-50":"opacity-25"):null;return s.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[s.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[_&&!f&&!(t.outside||t.outsideCycle)&&s.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),f&&s.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[2px] rounded-full bg-tarjeta border-2 border-fertiliapp-fuerte"}),Le&&s.jsx("span",{className:Le,"aria-hidden":"true"}),s.jsx("span",{className:mt,children:y(e,"d")}),D&&s.jsx(ra,{"aria-hidden":"true",className:"pointer-events-none absolute -bottom-[0.2px] -right-[0.2px] h-2 w-2 text-rose-500 fill-current"})]}),s.jsxs("div",{className:"mt-[0.2rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[s.jsx("span",{className:ue}),s.jsx("span",{className:de})]}),ye&&s.jsx("span",{"aria-hidden":"true",className:C("pointer-events-none absolute -top-[1px] right-[0.5px] rounded-sm px-[2px] text-[0.75rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",f?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:ye})]})},[K,le]),z=r.useMemo(()=>{if(!n?.startDate)return[];const e=m(n.startDate);if(!S(e))return[];const t=N(e),a=N(new Date);let l=h?.to?N(h.to):a;Oe(l,a)&&(l=a),we(l,t)&&(l=t);const i=Pe(l,t)+1;if(i<=0)return[];const u=[];for(let D=i-1;D>=0;D-=1){const g=Za(t,D),d=y(g,"yyyy-MM-dd"),v=Pe(g,t)+1,f=le.get(d)||null;u.push({isoDate:d,date:g,cycleDay:v,details:f})}return u},[n?.startDate,h,le]),ce=r.useMemo(()=>new Set(z.map(e=>e.isoDate)),[z]),Ea=r.useMemo(()=>{const e=new Map;return z.forEach(t=>{e.set(t.isoDate,t)}),e},[z]),zt=x&&Ea.get(x)||null,ut=zt?.details??null,Bt=ut?.peakStatus??(x?K[x]??null:null),Ra=ut?.isPeakDay??Bt==="P",Fe=r.useMemo(()=>{if(!h)return null;const e=h?.to?y(N(h.to),"yyyy-MM-dd"):null,t=h?.from?y(N(h.from),"yyyy-MM-dd"):null;if(!n?.endDate){const a=y(N(new Date),"yyyy-MM-dd");if(ce.has(a))return a}return e&&ce.has(e)?e:t&&ce.has(t)?t:Te[0]??null},[n?.endDate,h,ce,Te]);r.useEffect(()=>{if(!(x&&ce.has(x))){if(!Fe){x!==null&&W(null);return}x!==Fe&&W(Fe)}},[x,ce,Fe]);const Ht=r.useCallback(e=>{if(!e)return;const t=y(e,"yyyy-MM-dd");h&&(we(e,h.from)||Oe(e,h.to))||W(t)},[h]);r.useEffect(()=>{if(!x)return;const e=m(x);S(e)&&ct(t=>t&&t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()?t:e)},[x]);const Vt=r.useCallback(e=>{ct(t=>{const a=t??h?.to??N(new Date);return ls(a,e==="next"?1:-1)})},[h]);r.useEffect(()=>{const e=Tt.current;if(!e)return;const t=e.querySelector(".records-calendar-day-grid");t&&(Ft.current=t)},[It,jt,$]);const dt=r.useCallback(async e=>{if(ge.current)return;ge.current=!0;const a=Ft.current?.getBoundingClientRect()?.width??0,l=e==="next"?-sa:sa,i=a?e==="next"?-a:a:l,u=-i;try{await ie(i,{duration:ve}),Vt(e),$(u),await $t(),await ie(0,{duration:ve})}finally{ge.current=!1}},[ie,Vt,$,$t]),I=r.useCallback(()=>{bt(null),wt(null),Dt(!1),vt(null),nt(!1)},[]);r.useEffect(()=>()=>{A.current&&(cancelAnimationFrame(A.current),A.current=null),Z.current&&(Z.current(),Z.current=null)},[]);const Ut=r.useCallback(()=>{Re(n?.startDate||""),_e(n?.endDate||""),O(""),I(),yt(!0)},[n?.startDate,n?.endDate,I]),J=r.useCallback(()=>{yt(!1),O(""),I(),Re(n?.startDate||""),_e(n?.endDate||"")},[n?.startDate,n?.endDate,I]),_a=r.useCallback(()=>{Q&&(J(),Q())},[J,Q]),Aa=r.useCallback(e=>{if(ge.current||e.pointerType==="mouse"&&e.button!==0)return;const t=e.target.closest(".records-calendar-day-grid");if(!t)return;const a=Sa.current;a.active=!0,a.pointerId=e.pointerId,a.startX=e.clientX,a.startTime=performance.now(),a.dragging=!1;const l=t.getBoundingClientRect().width||0;a.gridWidth=l,a.swipeThreshold=l?Math.max(ht,l*.25):ht;const i=g=>{if(!a.active||g.pointerId!==a.pointerId)return;const d=g.clientX-a.startX;if(!a.dragging&&Math.abs(d)>ks&&(a.dragging=!0,Pt(!0)),!a.dragging)return;const v=a.gridWidth?a.gridWidth*.7:js,f=Math.max(-v,Math.min(v,d));g.preventDefault(),$(f)},u=async g=>{if(!a.active||g.pointerId!==a.pointerId)return;Z.current?.(),Z.current=null,a.active=!1;const d=g.clientX-a.startX,v=performance.now()-a.startTime,f=v>0?d/v*1e3:0,_=a.swipeThreshold||ht,ue=d<=-_||f<=-aa,de=d>=_||f>=aa,B=a.dragging;if(a.dragging=!1,Pt(!1),ge.current){await ie(0,{duration:ve});return}if(B&&ue){await dt("next");return}if(B&&de){await dt("prev");return}await ie(0,{duration:ve})},D=()=>{window.removeEventListener("pointermove",i,{capture:!0}),window.removeEventListener("pointerup",u,{capture:!0}),window.removeEventListener("pointercancel",u,{capture:!0})};Z.current?.(),Z.current=D,window.addEventListener("pointermove",i,{capture:!0,passive:!1}),window.addEventListener("pointerup",u,{capture:!0}),window.addEventListener("pointercancel",u,{capture:!0})},[dt,ie,jt,$]),Ia=r.useCallback(()=>{I()},[I]),Ta=r.useCallback(async()=>{if(!X){O("La fecha de inicio es obligatoria");return}if(p&&q&&q<X){O("La fecha de fin no puede ser anterior al inicio");return}if(n?.id){O(""),pe(!0);try{const e=Ze?await Ze(n.id,X,p&&q||void 0):null;if(e){bt(X),wt((p&&q||void 0)??null),Dt(!!p),vt(e),nt(!0),pe(!1);return}await Me(n.id,X,p&&q||void 0),await Ee({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),J()}catch(e){console.error("Error updating start date from records page:",e),O("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{pe(!1)}}},[X,q,p,n?.id,Ze,Me,Ee,R,J]),Fa=r.useCallback(async()=>{if(!n?.id||!P){I();return}pe(!0),nt(!1);try{const e=n.startDate,t=n.endDate??void 0,a=P!==e,l=a&&P&&e&&we(m(P),m(e)),i=rt?st??void 0:void 0,u=rt&&st!==null&&i!==t;if(l&&await gt(n.id,P),u&&i&&Je){const D=a?P:e;await Je(n.id,i,D)}await Me(n.id,a?P:void 0,i),await Ee({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),J()}catch(e){console.error("Error adjusting cycle dates from records page:",e),O("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{pe(!1),I()}},[n?.id,n?.startDate,n?.endDate,P,rt,st,gt,Je,Me,Ee,R,J,I]),Yt=r.useCallback(()=>{U(!1),Y(null),G(null),he(null),ne(null),at(!1),xe.current=null},[]),Xt=r.useCallback(async(e,t=null,a=null)=>{if(!e)return;xe.current=e.id??null,Y(e),G(e.isoDate??null),he(t),ne(a??null),e.isoDate&&W(e.isoDate),U(!0);const l=e?.measurementsLoaded||Array.isArray(e?.measurements)&&e.measurements.length>0;if(Qe&&e?.id&&n?.id&&!l){at(!0);try{const i=await Qe(n.id,e.id);xe.current===e.id&&Y(u=>u?.id===e.id?{...u,measurements:i,measurementsLoaded:!0}:u)}finally{at(!1)}}},[n?.id,Qe]),La=r.useCallback((e,t=null,a=null)=>Xt(e,a,t),[Xt]),Oa=e=>{const t=n?.data?.find(a=>a.id===e);tt(t||null)},Pa=r.useCallback(e=>{Y(e)},[]),$a=r.useCallback((e,t=null,a=null)=>{e&&(xe.current=null,W(e),Y(null),G(e),he(a),ne(t),U(!0))},[]),qt=r.useCallback(()=>{const e=z.length?z[0].isoDate:n?.startDate||null,t=x||e||null;xe.current=null,Y(null),G(t),he(null),ne(null),t&&W(t),U(!0)},[z,n?.startDate,x]),Wt=r.useCallback((e,t={})=>{const a=n?.data?.find(d=>d.isoDate===e)||null,l=a?.timestamp&&S(m(a.timestamp))?y(m(a.timestamp),"HH:mm"):y(new Date,"HH:mm"),i=a?.temperature_raw??a?.temperature??"",u=a?.temperature_corrected??"",D=!!a?.use_corrected,g=a?.measurements?.length?a.measurements.map((d,v)=>{const f=d?.time||(d?.timestamp&&S(m(d.timestamp))?y(m(d.timestamp),"HH:mm"):l);return{temperature:d?.temperature??d?.temperature_raw??i,temperature_corrected:d?.temperature_corrected??u,time:f,time_corrected:d?.time_corrected||f,use_corrected:d?.use_corrected!==void 0?!!d?.use_corrected:D,selected:!!(d?.selected??v===0)}}):[{temperature:i,temperature_corrected:u,time:l,time_corrected:l,use_corrected:D,selected:!0}];return{isoDate:e,measurements:g,mucusSensation:a?.mucusSensation??a?.mucus_sensation??"",mucusAppearance:a?.mucusAppearance??a?.mucus_appearance??"",fertility_symbol:a?.fertility_symbol??a?.fertilitySymbol??"none",observations:a?.observations??"",peak_marker:a?.peak_marker??null,ignored:a?.ignored??!1,...t}},[n?.data]),za=async(e,{keepFormOpen:t=!1}={})=>{re(!0);try{await Ke(e,et),R({title:"Guardado",duration:2e3}),t||(U(!1),Y(null),G(null),he(null),ne(null))}catch{R({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{re(!1),t&&G(e?.isoDate??null)}},Ba=r.useCallback(async e=>{if(!e)return;const t=n?.data?.find(i=>i.isoDate===e)||null,a=!!(t?.had_relations??t?.hadRelations??!1),l=Wt(e,{had_relations:!a,hadRelations:!a});re(!0);try{await Ke(l,t)}catch{R({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{re(!1)}},[Ke,Wt,n?.data,R]),Ha=async()=>{if(ae){re(!0);try{const e=ae.isoDate;await la(ae.id),tt(null),G(null),e&&x===e&&W(e)}catch{R({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{re(!1)}}},Gt={openDateEditor:Ut,openAddRecord:qt,isProcessing:se,isUpdatingDates:ot,cycle:n},Va=typeof b=="function"?b(Gt):s.jsxs(s.Fragment,{children:[s.jsxs(ms,{type:"button",onClick:Ut,className:"text-subtitulo",disabled:se||ot,"aria-label":p?"Editar fechas del ciclo":"Editar fecha de inicio",children:[s.jsx(Qa,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:p?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),s.jsxs(fs,{type:"button",onClick:qt,disabled:se,"aria-label":"Añadir registro",children:[s.jsx(ds,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),Kt=typeof j=="function"?j({...Gt}):j??null;return oa&&!n?.id?s.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:s.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):n?.id?s.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[s.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[s.jsx("div",{ref:Ae,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:s.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:s.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[s.jsx(be.div,{className:"flex flex-col gap-2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:s.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/50 p-3 shadow-sm backdrop-blur-md",children:s.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[s.jsxs("div",{className:"flex items-center justify-between gap-2 text-[10px] uppercase tracking-[0.18em] text-base",children:[s.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[Kt&&s.jsx("div",{className:"flex items-center",children:Kt}),s.jsx("span",{children:St?"CICLO ACTUAL":"CICLO ARCHIVADO"})]}),s.jsx("div",{className:"flex shrink-0 items-center gap-2",children:Va})]}),s.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[s.jsx(o,{className:"h-5 w-5 text-subtitulo"}),s.jsx("span",{className:C("font-semibold text-titulo leading-tight","text-[21px] sm:text-[22px]"),children:Da})]}),Nt&&s.jsx("div",{className:"text-[13px] text-base whitespace-nowrap",children:Nt})]})})}),da&&s.jsx(be.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:s.jsx(as,{cycle:n,startDate:X,endDate:p?q:n?.endDate,onStartDateChange:e=>Re(e),onEndDateChange:p?e=>_e(e):void 0,onSave:Ta,onCancel:J,isProcessing:ot,dateError:ma,includeEndDate:p,showOverlapDialog:pa,overlapCycle:fa,onConfirmOverlap:Fa,onCancelOverlap:Ia,onClearError:()=>O(""),saveLabel:p?"Guardar fechas":"Guardar cambios",title:p?"Editar fechas del ciclo":"Editar fecha de inicio",description:p?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onDeleteCycle:Q?_a:void 0,deleteTitle:He,deleteDescription:F,deleteLabel:Ve,isDeletingCycle:H})}),s.jsx(is,{initial:!1,children:s.jsx(be.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:s.jsx("div",{ref:Tt,onPointerDown:Aa,"data-calendar-dragging":Ot?"true":"false",className:C("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:[transform:translate3d(var(--calendar-drag-x,0px),0,0)]",Ot?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${Na}px`},children:s.jsx(cs,{mode:"single",locale:Ce,month:It??void 0,onMonthChange:ct,selected:x&&S(m(x))?m(x):void 0,onSelect:Ht,onDayClick:Ht,modifiers:va,labels:ka,components:{DayContent:Ma},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:Ca,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),s.jsxs("div",{ref:kt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:_t,maxHeight:`calc(h-app - ${_t}px )`,WebkitOverflowScrolling:"touch"},children:[s.jsx(be.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:z.length===0?s.jsx(be.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:s.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[s.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:s.jsx(ea,{className:"h-9 w-9"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),s.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):s.jsx(Ds,{isoDate:x,cycleDay:zt?.cycleDay??null,details:ut,peakStatus:Bt,isPeakDay:Ra,onEdit:La,onDelete:Oa,onAdd:$a,onToggleRelations:Ba,isProcessing:se})}),je&&s.jsx("div",{className:"pt-4 space-y-4",children:je})]})]}),s.jsx(xs,{open:ca,onOpenChange:e=>{e?U(!0):Yt()},children:s.jsx(gs,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:s.jsx(us,{onSubmit:za,onCancel:Yt,initialData:et,cycleStartDate:n?.startDate,cycleEndDate:n?.endDate,isProcessing:se||ua,isEditing:!!et,cycleData:n?.data,onDateSelect:Pa,defaultIsoDate:ha,focusedField:xa,initialSectionKey:ga})})}),s.jsx(ps,{isOpen:!!ae,onClose:()=>tt(null),onConfirm:Ha,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:ae?`¿Estás seguro de que quieres eliminar el registro del ${y(m(ae.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:se})]}):s.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[s.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[s.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),s.jsx("button",{onClick:()=>lt(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),s.jsx(es,{isOpen:ya,onClose:()=>lt(!1),onConfirm:async e=>{await ia(e),lt(!1),ne(null),U(!0),k?.fertilityStartConfig?.postpartum===!0&&it(!0)}}),s.jsx(ts,{isOpen:ba,onClose:()=>it(!1),onConfirm:wa})]})},Bs=()=>s.jsx(Es,{});export{Es as RecordsExperience,Bs as default};
