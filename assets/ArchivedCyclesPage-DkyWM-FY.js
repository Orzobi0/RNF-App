import{c as ue,r,j as e,B as U,g as L,f as o,b as xe,a as he,m as Y,A as fe,L as me,C as te,o as pe}from"./index-DH3_E9Yn.js";import{D as ye,a as ge,b as ve,c as je,d as be,e as Ce,u as Ne}from"./useCycleData-BKkKqmXq.js";import{H as we,a as De,D as ke}from"./DeletionDialog-DcHdHws2.js";import{u as Ee,P as se,B as Se,l as Me}from"./badge-CdG7NQBE.js";import{I as ae}from"./input-DQhpSuZa.js";import{O as Ae}from"./OverlapWarningDialog-CkV2JUiC.js";const Te=ue("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),X=({isOpen:j,onClose:b,onConfirm:P,initialStartDate:D,initialEndDate:m,includeEndDate:x=!0,title:G="Editar Fechas del Ciclo",description:V,cycleId:B,checkOverlap:R,errorMessage:k,conflictCycle:h,onResetError:p})=>{const[a,E]=r.useState(D||""),[n,C]=r.useState(m||""),[H,y]=r.useState(""),[N,g]=r.useState(null),[S,w]=r.useState(null),[M,A]=r.useState(!1);Ee(j,b),r.useEffect(()=>{E(D||""),C(m||"")},[D,m]);const W=()=>{if(!h)return null;const l=O=>{if(!O)return null;try{return L(o(O),"dd/MM/yyyy")}catch(K){return console.error("Error formatting conflict date",K),O}},f=l(h.startDate)??"sin fecha de inicio",q=h.endDate?l(h.endDate):"en curso";return`Conflicto con el ciclo del ${f} al ${q}.`},J=()=>{y(""),p&&p()},c=l=>{E(l),J()},T=l=>{C(l),y(""),p&&p()},v=W(),$=async()=>{if(x&&!n){y("La fecha de fin es obligatoria");return}if(x&&a&&n&&n<a){y("La fecha de fin no puede ser anterior al inicio");return}const l=x?{startDate:a,endDate:n}:{startDate:a};if(R&&B&&a){const f=await R(B,a,x&&n||void 0);if(f){g(f),w(l),A(!0);return}}P(l)};return e.jsxs(e.Fragment,{children:[e.jsx(ye,{open:j,onOpenChange:b,children:e.jsxs(ge,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(ve,{children:[e.jsx(je,{children:G}),e.jsx(be,{className:"text-gray-600",children:V??(x?"Modifica la fecha de inicio y fin del ciclo.":"Modifica la fecha de inicio del ciclo.")})]}),(k||h)&&e.jsxs("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[e.jsx("p",{className:"font-semibold text-red-800",children:"No se pudo guardar el ciclo"}),k&&e.jsx("p",{className:"mt-1",children:k}),v&&e.jsx("p",{className:"mt-1",children:v}),e.jsx("p",{className:"mt-3 text-xs text-red-600",children:"Ajusta las fechas para que no se superpongan con ciclos existentes."})]}),e.jsxs("div",{className:"my-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Inicio del ciclo"}),e.jsx(ae,{id:"startDate",type:"date",value:a,onChange:l=>c(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),x&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"text-gray-700 text-sm",children:"Fin del ciclo"}),e.jsx(ae,{id:"endDate",type:"date",value:n||"",onChange:l=>T(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"}),H&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:H})]})]}),e.jsxs(Ce,{className:"sm:justify-end",children:[e.jsx(U,{variant:"outline",onClick:b,className:"border-gray-300 text-titulo hover:bg-gray-100",children:"Cancelar"}),e.jsx(U,{variant:"primary",onClick:$,className:"bg-pink-600 hover:bg-pink-700 text-white",children:"Guardar"})]})]})}),e.jsx(Ae,{isOpen:M,conflictCycle:N,onCancel:()=>A(!1),onConfirm:()=>{A(!1),S&&P({...S,force:!0})}})]})},Re=()=>{const{currentCycle:j,archivedCycles:b,isLoading:P,addArchivedCycle:D,updateCycleDates:m,deleteCycle:x,checkCycleOverlap:G,forceUpdateCycleStart:V,forceShiftNextCycleStart:B}=Ne(),{toast:R}=xe(),k=he(),[h,p]=r.useState(!1),[a,E]=r.useState(null),[n,C]=r.useState(null),[H,y]=r.useState(!1),[N,g]=r.useState(null),[S,w]=r.useState(null),[M,A]=r.useState("all"),[W,J]=r.useState(!1),c=r.useRef(null),T=r.useRef(!1),v=r.useRef(!1),$=t=>{if(!t)return"Las fechas ingresadas se superponen con otro ciclo.";const s=u=>{if(!u)return null;try{return L(o(u),"dd/MM/yyyy")}catch(z){return console.error("Error parsing conflict date",z),u}},d=s(t.startDate)??"sin fecha de inicio",i=t.endDate?s(t.endDate):"en curso";return`Las fechas ingresadas se superponen con el ciclo del ${d} al ${i}.`},l=()=>{g(null),p(!0)},f=()=>{p(!1),g(null)},q=async({startDate:t,endDate:s})=>{try{await D(t,s),f()}catch(d){const i=d.code==="cycle-overlap"?$(d.conflictCycle):"No se pudo crear el ciclo.";g({message:i,conflictCycle:d.conflictCycle||null})}},O=async({startDate:t,endDate:s,force:d})=>{if(a)try{const i=a.startDate,u=a.endDate,z=t!==void 0&&t!==i,oe=s!==void 0&&s!==u,ce=z&&i&&t&&o(t)<o(i),de=z?t:i,ee=oe?s:u;d&&ce?(await V(a.id,t),s!==void 0&&await m(a.id,void 0,s)):d&&ee?(await B(a.id,ee,de),await m(a.id,t,s)):await m(a.id,t,s),E(null),w(null)}catch(i){const u=i.code==="cycle-overlap"?$(i.conflictCycle):"No se pudieron actualizar las fechas.";w({message:u,conflictCycle:i.conflictCycle||null})}},K=t=>{C(t)},re=async()=>{if(n){y(!0);try{await x(n.id),R({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),C(null)}catch(t){console.error("Error deleting archived cycle:",t)}finally{y(!1)}}},le=t=>{k(t.isCurrent?"/":`/cycle/${t.id}`)},Z=t=>{T.current=!1,c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{T.current=!0,K(t)},1500)},F=(t,s=!0)=>{c.current&&(clearTimeout(c.current),c.current=null),!T.current&&s&&le(t)};r.useEffect(()=>()=>{c.current&&clearTimeout(c.current)},[]);const I=j.id?[{...j,isCurrent:!0,needsCompletion:!j.endDate},...b]:b,ie=I&&I.length>0;if(P&&!ie)return e.jsx("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:e.jsx("div",{className:"text-center text-slate-600 p-8",children:"Cargando ciclos archivados..."})});if(!I||I.length===0)return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"flex flex-1 items-center justify-center px-4",children:e.jsx(Y.div,{className:"text-center text-slate-600 flex flex-col items-center max-w-md",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"bg-white/70 mt-6 backdrop-blur-md rounded-3xl p-8 border border-pink-200/50 shadow-sm",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center",children:e.jsx(fe,{className:"w-10 h-10 text-subtitulo"})}),e.jsx("h2",{className:"text-2xl font-semibold text-subtitulo mb-4",children:"No hay ciclos archivados"}),e.jsx("p",{className:"text-subtitulo mb-8",children:"Cuando inicies un nuevo ciclo, el anterior aparecerá aquí."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(U,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl hover:brightness-95 text-white shadow-sm",children:e.jsx(me,{to:"/",children:"Volver al Ciclo Actual"})}),e.jsxs(U,{onClick:l,className:"bg-fertiliapp-fuerte hover:brightness-95 rounded-3xl text-white shadow-sm",children:[e.jsx(se,{className:"mr-2 h-4 w-4"})," Crear Ciclo"]})]})]})})}),e.jsx(X,{isOpen:h,onClose:f,onConfirm:q,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:N?.message,conflictCycle:N?.conflictCycle,onResetError:()=>g(null)})]});const Q=[...I].sort((t,s)=>o(s.startDate)-o(t.startDate)),ne=Array.from(new Set(Q.map(t=>{try{return o(t.startDate).getFullYear()}catch(s){return console.error("Error parsing startDate for year filter",s),null}}).filter(Boolean))).sort((t,s)=>s-t),_=M==="all"?Q:Q.filter(t=>{try{return o(t.startDate).getFullYear()===Number(M)}catch(s){return console.error("Error filtering cycle by year",s),!1}});return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[e.jsx("div",{className:"relative z-10 flex flex-1",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 py-6 flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col",children:[e.jsx(Y.div,{className:"mb-4",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/80 p-3 shadow-sm backdrop-blur-md",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[e.jsx("div",{className:"flex min-w-0 items-center gap-2",children:e.jsx("span",{className:"truncate text-[21px] font-semibold leading-tight text-titulo",children:"Mis ciclos"})}),e.jsx("div",{className:"truncate text-[13px] text-base",children:"Historial de ciclos"})]}),e.jsxs("div",{className:"flex shrink-0 items-center gap-2",children:[e.jsxs(we,{type:"button",onClick:l,"aria-label":"Añadir ciclo",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Añadir ciclo"})]}),e.jsx(De,{type:"button",onClick:()=>J(t=>!t),"aria-label":"Filtrar por año",children:e.jsx(Te,{className:"h-5 w-5"})})]})]})})}),W&&e.jsx("div",{className:"mb-4 flex w-full justify-center",children:e.jsxs("div",{className:"flex w-full max-w-md items-center gap-2 rounded-3xl border border-fertiliapp-suave bg-white/90 px-3 py-2 shadow-sm",children:[e.jsx("span",{className:"text-xs font-medium text-slate-700",children:"Año"}),e.jsxs("select",{id:"year-filter",value:M,onChange:t=>A(t.target.value),className:"flex-1 rounded-3xl border border-pink-100 bg-white px-3 py-2 text-sm text-slate-700 shadow-inner focus:outline-none focus:ring-2 focus:ring-fertiliapp",children:[e.jsx("option",{value:"all",children:"Todos"}),ne.map(t=>e.jsx("option",{value:t,children:t},t))]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-1 sm:pr-0 pb-6",children:e.jsxs(Y.div,{className:"space-y-3 px-1",variants:{hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"show",children:[_.map(t=>{const s=u=>L(o(u),"dd MMM yy",{locale:Me}),d=t.endDate?s(t.endDate):"En curso",i=t.data?t.data.length:0;return e.jsx(Y.button,{type:"button",className:"w-full max-w-[480px] mx-auto bg-white/80 backdrop-blur-md border border-fertiliapp-suave shadow-md hover:shadow-sm transition-all duration-300 hover:bg-white/90 rounded-3xl active:scale-[0.98] cursor-pointer select-none",variants:{hidden:{opacity:0,y:20},show:{opacity:1,y:0}},onMouseDown:()=>Z(t),onMouseUp:()=>F(t),onMouseLeave:()=>F(t,!1),onTouchStart:()=>{v.current=!1,Z(t)},onTouchMove:()=>{v.current=!0,F(t,!1)},onTouchEnd:()=>{v.current?(v.current=!1,F(t,!1)):F(t,!0)},children:e.jsx("div",{className:"p-2.5",children:e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"w-10 h-10 bg-fertiliapp-fuerte rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(te,{className:"w-5 h-5 text-white"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsxs("h2",{className:"truncate text-[15px] font-semibold text-slate-700",children:[s(t.startDate)," - ",d]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 text-[12px] text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(pe,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[i," registro",i!==1?"s":""]})]}),t.endDate&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(te,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[Math.ceil((o(t.endDate)-o(t.startDate))/(1e3*60*60*24))+1," días"]})]}),t.isCurrent&&e.jsx(Se,{className:"rounded-full bg-fertiliapp-fuerte px-2 py-0.5 text-[11px] text-white",children:"Ciclo actual"})]})]})]})})},t.id)}),_.length===0&&e.jsx("div",{className:"mt-6 rounded-3xl border border-dashed border-fertiliapp-suave bg-white/70 p-6 text-center text-slate-600 shadow-inner",children:"No hay ciclos para el año seleccionado."})]})})]})}),e.jsx(X,{isOpen:h,onClose:f,onConfirm:q,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:N?.message,conflictCycle:N?.conflictCycle,onResetError:()=>g(null)}),e.jsx(X,{isOpen:!!a,onClose:()=>{E(null),w(null)},onConfirm:O,initialStartDate:a?.startDate,initialEndDate:a?.endDate,cycleId:a?.id,checkOverlap:G,title:"Editar Fechas del Ciclo",description:"Actualiza las fechas del ciclo.",errorMessage:S?.message,conflictCycle:S?.conflictCycle,onResetError:()=>w(null)}),e.jsx(ke,{isOpen:!!n,onClose:()=>C(null),onConfirm:re,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:n?`¿Estás seguro de que quieres eliminar el ciclo ${L(o(n.startDate),"dd/MM/yyyy")} - ${n.endDate?L(o(n.endDate),"dd/MM/yyyy"):"En curso"}? Esta acción no se puede deshacer.`:"",isProcessing:H})]})};export{Re as default};
