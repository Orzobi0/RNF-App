import{c as ee,o as n,j as e,B as d,k as f,C as K,f as y,g as W,r as A}from"./index-BrkKcvYr.js";import{b as Q,c as X,d as _,e as U,i as we,u as de}from"./useBackClose-C07k0QgV.js";import{O as ue}from"./DeletionDialog-vRraKZqj.js";import{l as M,i as V}from"./badge-Bg-zWaI6.js";import{i as ce,D as fe,a as me,b as he,c as xe,d as ye,e as pe}from"./useCycleData-NykkPLt1.js";const Ae=ee("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]),Re=ee("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),De=ee("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),oe=s=>{if(!s)return"";const l=new Date(s);if(Number.isNaN(l.getTime()))return s;const m=String(l.getDate()).padStart(2,"0"),h=String(l.getMonth()+1).padStart(2,"0"),u=String(l.getFullYear());return`${m}/${h}/${u}`},Pe=({cycle:s,startDate:l,endDate:m,onStartDateChange:h,onEndDateChange:u,onSave:b,onCancel:c,isProcessing:v=!1,dateError:R="",includeEndDate:x=!0,showOverlapDialog:P=!1,overlapCycle:j=null,overlapImpactPreview:i=null,onConfirmOverlap:E,onCancelOverlap:o,title:z="Editar fechas del ciclo",description:G="Actualiza las fechas de inicio y fin del ciclo. Guarda los cambios cuando termines.",saveLabel:I="Guardar",cancelLabel:Y="Cancelar",onClearError:C,className:O="mb-6 mx-auto w-full max-w-xl",onDeleteCycle:F,deleteTitle:Z="Eliminar ciclo",deleteDescription:r="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",deleteLabel:p="Eliminar ciclo",isDeletingCycle:$=!1,onUndoCycle:te,isUndoingCycle:k=!1,otherCycles:ge=[]})=>{const ae=s?.startDate?oe(s.startDate):null,be=s?.endDate?oe(s.endDate):"En curso",se=ae?`Fecha actual: ${ae}${x?` — ${be}`:""}`:null,g=t=>{if(!t)return null;const a=y(t);return W(a)?n(a):null},L=g(l),T=g(m),N=g(s?.startDate),re=g(s?.endDate),le=n(new Date),ie=(t,a)=>a||(t?ce(t,le)?t:le:null),ne=(s?.data??[]).map(t=>g(t?.isoDate)).filter(Boolean),w=ge.filter(t=>t?.id&&s?.id&&t.id!==s.id).map(t=>{const a=g(t?.startDate),J=g(t?.endDate);return a?{from:a,to:ie(a,J)??a}:null}).filter(Boolean),D=N?{from:N,to:ie(N,re)??N}:void 0,B=(t,a)=>!!(a?.from&&V(t,a.from)),q=(t,a)=>a?.to?V(t,a.to)&&!V(a.from,a.to):!1,H=(t,a)=>!a?.from||!a?.to||V(a.from,a.to)?!1:ce(t,a.from)&&we(t,a.to),S=(t,a,J)=>a.some(Ne=>J(t,Ne)),ve=t=>{C&&C(),h?.(t.target.value)},je=t=>{C&&C(),u?.(t.target.value)},Ce=t=>{t.preventDefault(),b?.()};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`${O} rounded-3xl border border-rose-100 bg-white/90 p-5 shadow-md`,children:e.jsx("form",{onSubmit:Ce,className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-titulo mb-1",children:z}),e.jsx("p",{className:"text-sm text-slate-600",children:G}),se&&e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:se}),e.jsxs("div",{className:`grid ${x?"grid-cols-2 gap-4":"grid-cols-1 gap-4"}`,children:[e.jsxs("label",{className:"flex h-full flex-col text-sm text-slate-700",children:["Inicio del ciclo",e.jsxs(Q,{children:[e.jsx(X,{asChild:!0,children:e.jsxs(d,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-fertiliapp-suave bg-white text-left font-normal text-slate-800",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),L?f(L,"PPP",{locale:M}):"Selecciona una fecha"]})}),e.jsx(_,{className:"w-auto p-0",align:"start",children:e.jsx(U,{mode:"single",selected:L,onSelect:t=>{t&&ve({target:{value:f(n(t),"yyyy-MM-dd")}})},locale:M,initialFocus:!0,defaultMonth:L??N??new Date,enableSwipeNavigation:!0,modifiers:{hasRecord:ne,inActiveCycleStart:t=>B(t,D),inActiveCycleMiddle:t=>H(t,D),inActiveCycleEnd:t=>q(t,D),inOtherCycleStart:t=>S(t,w,B),inOtherCycleMiddle:t=>S(t,w,H),inOtherCycleEnd:t=>S(t,w,q)},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycleStart:"in-cycle-range-start",inActiveCycleMiddle:"in-cycle-range-middle",inActiveCycleEnd:"in-cycle-range-end",inOtherCycleStart:"in-other-cycle-range-start",inOtherCycleMiddle:"in-other-cycle-range-middle",inOtherCycleEnd:"in-other-cycle-range-end"}})})]})]}),x&&e.jsxs("label",{className:"flex h-full flex-col text-sm text-slate-700",children:["Fin del ciclo",e.jsxs(Q,{children:[e.jsx(X,{asChild:!0,children:e.jsxs(d,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-fertiliapp-suave bg-white text-left font-normal text-slate-800",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),T?f(T,"PPP",{locale:M}):"Selecciona una fecha"]})}),e.jsx(_,{className:"w-auto p-0",align:"start",children:e.jsx(U,{mode:"single",selected:T,onSelect:t=>{t&&je({target:{value:f(n(t),"yyyy-MM-dd")}})},locale:M,initialFocus:!0,defaultMonth:T??re??N??new Date,enableSwipeNavigation:!0,modifiers:{hasRecord:ne,inActiveCycleStart:t=>B(t,D),inActiveCycleMiddle:t=>H(t,D),inActiveCycleEnd:t=>q(t,D),inOtherCycleStart:t=>S(t,w,B),inOtherCycleMiddle:t=>S(t,w,H),inOtherCycleEnd:t=>S(t,w,q)},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycleStart:"in-cycle-range-start",inActiveCycleMiddle:"in-cycle-range-middle",inActiveCycleEnd:"in-cycle-range-end",inOtherCycleStart:"in-other-cycle-range-start",inOtherCycleMiddle:"in-other-cycle-range-middle",inOtherCycleEnd:"in-other-cycle-range-end"}})})]})]})]}),R&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:R}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-3 justify-center",children:[e.jsx(d,{type:"button",variant:"outline",onClick:c,className:"border-fertiliapp-suave text-titulo hover:brightness-95",disabled:v||k,children:Y}),e.jsx(d,{type:"submit",className:"bg-fertiliapp-fuerte text-white shadow hover:brightness-95",disabled:v||k,children:I})]}),te&&e.jsxs("div",{className:"mt-4 rounded-3xl bg-amber-50 p-4 text-left",children:[e.jsx("h3",{className:"font-semibold text-slate-800 mb-2",children:"Deshacer ciclo"}),e.jsx("p",{className:"text-sm text-slate-700 mb-3",children:"Une el ciclo actual con el anterior y mueve todos los registros."}),e.jsx(d,{type:"button",onClick:te,disabled:v||k,className:"w-full sm:w-auto bg-amber-500 hover:brightness-95 text-white shadow-md",children:k?"Deshaciendo…":"Deshacer ciclo"})]}),F&&e.jsxs("div",{className:"mt-6 rounded-3xl bg-alerta-2-suave p-4 text-left",children:[e.jsx("h3",{className:"font-semibold text-slate-800 mb-2",children:Z}),r&&e.jsx("p",{className:"text-sm text-slate-800 mb-3",children:r}),e.jsxs(d,{type:"button",onClick:F,disabled:v||$||k,className:"w-full sm:w-auto bg-alerta-2 hover:brightness-95 text-white shadow-md",children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),p]})]})]})})}),e.jsx(ue,{isOpen:P,conflictCycle:j,title:i?"Este cambio ajustará otros ciclos":void 0,description:i?"Revisa el impacto antes de confirmar.":void 0,confirmLabel:i?"Aplicar cambios":void 0,affectedCycles:i?.affectedCycles||[],impactSummary:i?.impactSummary,adjustedCyclesPreview:i?.adjustedCyclesPreview||[],onCancel:o,onConfirm:E})]})},Fe=({isOpen:s,onClose:l,onConfirm:m,onPreview:h,currentCycleStartDate:u,currentCycleRecords:b=[]})=>{const[c,v]=A.useState(f(new Date,"yyyy-MM-dd")),[R,x]=A.useState(!1),[P,j]=A.useState(null),[i,E]=A.useState(null);de(s,l);const o=!u,z=A.useMemo(()=>{if(o||!c||!b.length)return!1;const r=n(y(c));return W(r)?b.some(p=>{if(!p?.isoDate)return!1;const $=n(y(p.isoDate));return W($)?$.getTime()>=r.getTime():!1}):!1},[b,o,c]),G=async()=>{if(h){const r=await h(c);if(r){E(r),j(c),x(!0);return}}if(!o&&z){j(c),x(!0);return}m(c)},I=()=>{P&&(x(!1),m(P),j(null),E(null))},Y=o?"":f(y(u),"dd/MM/yyyy"),C=(()=>{if(o)return"";const r=new Date(c);return r.setDate(r.getDate()-1),f(r,"dd/MM/yyyy")})(),O=c?n(y(c)):null,F=b.map(r=>{if(!r?.isoDate)return null;const p=n(y(r.isoDate));return W(p)?p:null}).filter(Boolean),Z=u?{from:n(y(u)),to:n(new Date)}:void 0;return e.jsxs(e.Fragment,{children:[e.jsx(fe,{open:s,onOpenChange:l,children:e.jsxs(me,{className:"bg-white border-pink-100 text-gray-800 rounded-3xl",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Iniciar nuevo ciclo"}),e.jsx(ye,{className:"text-gray-600",children:o?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${Y} - ${C}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsxs(Q,{children:[e.jsx(X,{asChild:!0,children:e.jsxs(d,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-gray-200 bg-gray-50 text-left font-normal text-gray-800",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),O?f(O,"PPP",{locale:M}):"Selecciona una fecha"]})}),e.jsx(_,{className:"w-auto p-0",align:"start",children:e.jsx(U,{mode:"single",selected:O,onSelect:r=>{r&&v(f(n(r),"yyyy-MM-dd"))},locale:M,initialFocus:!0,disabled:[{after:n(new Date)},...o?[]:[{before:n(y(u))}]],modifiers:{hasRecord:F,inActiveCycle:Z},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycle:"in-cycle-soft-outline"}})})]})]}),e.jsxs(pe,{className:"sm:justify-end",children:[e.jsx(d,{variant:"outline",onClick:l,className:"border-gray-300 text-subtitulo hover:brightness-95",children:"Cancelar"}),e.jsx(d,{variant:"primary",onClick:G,className:"bg-fertiliapp-fuerte hover:brightness-95 text-white",children:o?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})}),e.jsx(ue,{isOpen:R,onCancel:()=>{x(!1),j(null),E(null)},onConfirm:I,conflictCycle:o?null:{startDate:u,endDate:null},message:"Este nuevo ciclo actual coincide en fechas con el ciclo anterior. Los registros se pasarán al nuevo ciclo si continúas. ¿Deseas continuar?",title:i?"Este cambio ajustará otros ciclos":void 0,description:i?"Se aplicarán ajustes en ciclos y/o registros antes de guardar.":void 0,confirmLabel:i?"Aplicar cambios":void 0,affectedCycles:i?.affectedCycles||[],impactSummary:i?.impactSummary,adjustedCyclesPreview:i?.adjustedCyclesPreview||[]})]})},$e=({isOpen:s,onClose:l,onConfirm:m})=>(de(s,l),e.jsx(fe,{open:s,onOpenChange:h=>{h||l()},children:e.jsxs(me,{className:"bg-white/95 backdrop-blur border border-fertiliapp-fuerte text-slate-700",children:[e.jsxs(he,{children:[e.jsx(xe,{className:"text-lg font-semibold text-fertiliapp-fuerte",children:"Modo postparto activado"}),e.jsx(ye,{className:"text-slate-600",children:"Se ha añadido un nuevo ciclo. ¿Deseas desactivar el modo postparto?"})]}),e.jsxs(pe,{className:"sm:justify-end gap-2",children:[e.jsx(d,{type:"button",variant:"outline",onClick:l,className:"border-pink-200 text-fertiliapp-fuerte hover:bg-pink-50 hover:text-fertiliapp-fuerte",children:"No"}),e.jsx(d,{type:"button",onClick:m,className:"bg-fertiliapp-fuerte hover:brightness-95 text-white shadow-lg",children:"Sí"})]})]})}));export{Pe as C,Ae as L,Fe as N,$e as P,De as T,Re as a};
