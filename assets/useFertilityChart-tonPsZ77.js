import{r as _,j as a,m as Me,B as tt,K as St,g as lt,f as Ye,Q as ft}from"./index-Ck3e0O9m.js";import{l as wt,B as Mt}from"./badge-CIoXRNss.js";import{X as kt,b as ct,P as ut,c as nt,T as Nt,d as Pt}from"./DataEntryForm-CRvk9Tt4.js";import{a as Tt,c as At}from"./computePeakStatuses-D9iHsp4z.js";const Qt=({point:e,position:r,chartWidth:i,chartHeight:h,onToggleIgnore:m,onEdit:n,onClose:c,onTogglePeak:b,currentPeakIsoDate:k})=>{if(!e)return null;const y=.6,w=200,I=120,S=w*y,C=I*y,A=_.useRef(null),[H,o]=_.useState(C),[f,N]=_.useState(!1);_.useEffect(()=>{A.current&&o(A.current.offsetHeight),N(!1)},[e]);const g=r.clientX>i*.66,M=r.clientY+H>h;let v=g?r.clientX-S-10:r.clientX+10,z=M?r.clientY:r.clientY+10;v+S>i&&(v=i-S-10),z+H>h&&(z=h-H-10),v<10&&(v=10),z<10&&(z=10);const L=!e.id||String(e.id).startsWith("placeholder-"),D=e.temperature_chart??e.displayTemperature??null,q=Tt(e.fertility_symbol),G=e.timestamp||e.isoDate,F=W=>{if(W==null)return null;const K=String(W).trim();return K.length?K:null},O=W=>{if(!W)return null;try{const K=Ye(W),ee=K.getTime();return Number.isNaN(ee)?null:lt(K,"HH:mm")}catch{return null}},te=(()=>{if(!Array.isArray(e.measurements)||e.measurements.length===0)return null;const W=e.measurements.filter(Boolean);if(!W.length)return null;const K=[...W.filter(ee=>ee?.selected),...W.filter(ee=>!ee?.selected)];for(const ee of K){const Ne=!!ee?.use_corrected?F(ee?.time_corrected)??F(ee?.time):F(ee?.time);if(Ne)return Ne}return null})(),B=(e.use_corrected?[F(e.time_corrected),F(e.time)]:[F(e.time)]).find(Boolean)??O(e.timestamp),$=te??B,X=e.mucus_sensation??e.mucusSensation??"",ye=e.mucus_appearance??e.mucusAppearance??"",J=e.observations??"",me=!!(e.had_relations??e.hadRelations),Ie=q&&q.value!=="none",oe=D!=null,V=!!(X&&X.trim()||ye&&ye.trim()),je=!!(J&&J.trim()),Z=!(oe||Ie||V||je||me),ne=e.peakStatus||(e.peak_marker==="peak"?"P":null),ve=ne&&{P:"Día pico",1:"Post pico 1",2:"Post pico 2",3:"Post pico 3"}[ne]||null,Y=!!(b&&e.isoDate),ae=!!k,Se=ae&&e.isoDate===k||ne==="P"||e.peak_marker==="peak",re=Se?"remove":ae?"update":"assign",ce=re==="assign"?"Asignar día pico":re==="update"?"Actualizar día pico":"Quitar día pico",U=ce,Pe=async()=>{if(!(!b||f)){N(!0);try{await b(e,!Se),c&&c()}catch(W){console.error("Error toggling peak marker from tooltip:",W)}finally{N(!1)}}},ke=()=>{ue()},ue=W=>{n&&(n(e,W),c&&c())},pe=(W=>{switch(W){case"red":return{bg:"bg-red-500",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};case"white":return{bg:"bg-slate-100 border-2 border-slate-300",light:"bg-slate-50",border:"border-slate-200",text:"text-slate-700",glow:"shadow-slate-200/50"};case"green":return{bg:"bg-green-500",light:"bg-green-50",border:"border-green-200",text:"text-green-700",glow:"shadow-green-200/50"};case"yellow":return{bg:"bg-yellow-400",light:"bg-yellow-50",border:"border-yellow-200",text:"text-yellow-700",glow:"shadow-yellow-200/50"};case"spot":return{bg:"bg-red-500 pattern-bg",light:"bg-red-50",border:"border-red-200",text:"text-red-700",glow:"shadow-red-200/50"};default:return{bg:"bg-gray-400",light:"bg-gray-50",border:"border-gray-200",text:"text-gray-700",glow:"shadow-gray-200/50"}}})(e.fertility_symbol);return a.jsxs(Me.div,{ref:A,initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:20},transition:{duration:.25,ease:[.16,1,.3,1]},className:"absolute z-50",style:{top:z,left:v,width:S},children:[a.jsx("div",{className:"origin-top-left",style:{transform:`scale(${y})`,width:w,minHeight:I},children:a.jsxs("div",{className:"relative tooltip-surface--gradient backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden",children:[a.jsx(tt,{variant:"ghost",size:"icon",onClick:c,className:"absolute top-2 right-2 z-20 text-gray-400 hover:text-fertiliapp-fuerte hover:bg-fertiliapp-suave rounded-full w-6 h-6 transition-all duration-200",children:a.jsx(kt,{size:20})}),me&&a.jsx("div",{className:"absolute right-3 top-9 pointer-events-none","aria-hidden":"true",title:"Relaciones registradas",children:a.jsx(St,{className:"w-4 h-4 text-fertiliapp-fuerte",fill:"currentColor"})}),a.jsxs("div",{className:"p-2",children:[a.jsxs("div",{className:"mb-2 relative",children:[a.jsx("div",{className:"w-5 h-5 bg-fertiliapp-fuerte rounded-full absolute top-2 left-2 flex items-center justify-center shadow-lg",children:a.jsx(ct,{className:"w-2 h-2 text-white",fill:"currentColor"})}),a.jsxs("div",{className:"mb-1 pl-8",children:[a.jsxs("div",{className:"flex items-baseline justify-start gap-2",children:[a.jsx("h3",{className:"font-bold text-left text-lg text-gray-800 tabular-nums tracking-wide",children:G?lt(Ye(G),"dd/MM",{locale:wt}):"Fecha"}),a.jsxs("span",{className:"text-sm text-fertiliapp-fuerte font-medium whitespace-nowrap",children:["Día ",e.cycleDay||"N/A"]})]}),ve&&a.jsx("div",{className:"mt-1 flex justify-start",children:a.jsx(Mt,{className:"bg-tarjeta text-fertiliapp-fuerte border border-fertiliapp-suave px-2 py-0 text-[11px]",children:ve})})]})]}),Z?a.jsxs("div",{className:"pt-1 space-y-3",children:[a.jsx(Me.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl border border-dashed border-fertiliapp-suave bg-fertiliapp-suave/60 p-2 text-center",children:a.jsx("p",{className:"text-sm font-semibold text-titulo",children:"Sin datos registrados para este día."})}),(Y||n)&&a.jsxs(Me.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center w-full justify-between pt-2 border-t border-gray-100",children:[Y&&a.jsx(ut,{mode:re,size:"sm",onClick:Pe,pending:f,"aria-label":U,title:ce,className:"shrink-0"}),n&&a.jsxs(tt,{onClick:ke,variant:"outline",size:"sm",className:"flex items-center gap-1.5 px-2 py-1.5 bg-white/80 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-gray-200 hover:border-blue-300 text-gray-700 hover:text-blue-700 rounded-full transition-all duration-200 shadow-sm hover:shadow-md text-xs",children:[a.jsx(nt,{className:"h-4 w-4"}),a.jsx("span",{className:"font-medium",children:"Añadir datos"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-1",children:[oe&&a.jsx(Me.button,{type:"button",onClick:()=>ue("temperature"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.1},className:"w-full text-left bg-temp-suave rounded-2xl p-1 border border-temp focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-temp",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-temp rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Nt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsx("span",{className:"text-md font-bold text-gray-800",children:parseFloat(D).toFixed(2)}),a.jsx("span",{className:"text-md text-gray-600",children:"°C"}),e.use_corrected&&a.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_4px_rgba(245,158,11,0.65)]",title:"Temperatura corregida"})]}),$&&a.jsx("span",{className:"text-sm font-medium text-gray-500 whitespace-nowrap",children:$})]})})]})}),Ie&&a.jsx(Me.button,{type:"button",onClick:()=>ue("symbol"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.15},className:`w-full text-left ${pe.light} rounded-3xl p-1 ${pe.border} border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pink-200`,disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:`w-6 h-6 ${pe.bg} rounded-lg flex items-center justify-center shadow-lg ${pe.glow} shadow-lg`,children:a.jsx("div",{className:"w-2 h-2 bg-white/90 rounded-full shadow-sm"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:`text-md font-semibold ${pe.text}`,children:q.label})})]})}),a.jsxs("div",{className:"grid grid-cols-1 gap-1",children:[a.jsx(Me.button,{type:"button",onClick:()=>ue("sensation"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"w-full text-left bg-sensacion-suave rounded-3xl p-1 border border-sensacion focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-200",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-sensacion rounded-lg flex items-center justify-center shadow-md",children:a.jsx(Pt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-sensacion-fuerte",children:X||"-"})})]})}),a.jsx(Me.button,{type:"button",onClick:()=>ue("appearance"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.25},className:"w-full text-left bg-apariencia-suave rounded-3xl p-1 border border-apariencia focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-emerald-200",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-apariencia rounded-lg flex items-center justify-center shadow-md",children:a.jsx(ct,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-md font-semibold text-apariencia-fuerte",children:ye||"-"})})]})}),je&&a.jsx(Me.button,{type:"button",onClick:()=>ue("observations"),initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"w-full text-left bg-observaciones-suave rounded-3xl p-1 border border-observaciones focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-violet-200",disabled:!n,children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-6 h-6 bg-observaciones rounded-lg flex items-center justify-center shadow-md",children:a.jsx(nt,{className:"w-4 h-4 text-white"})}),a.jsx("div",{className:"flex-1 text-left",children:a.jsx("span",{className:"text-sm font-semibold text-observaciones-fuerte",children:J})})]})})]})]}),(n||m&&!L&&e.id||Y&&!L)&&a.jsxs(Me.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[Y&&!L&&a.jsx(ut,{mode:re,size:"sm",onClick:Pe,pending:f,"aria-label":U,title:ce,className:"shrink-0"}),a.jsx("div",{className:"flex items-center gap-1.5 sm:gap-2 ml-3 pl-3 border-l border-gray-200/70",children:n&&a.jsxs(tt,{onClick:ke,size:"sm",className:"h-8 px-2.5 bg-white/80 text-gray-700 rounded-full border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-white hover:shadow focus-visible:ring-2 focus-visible:ring-blue-200 transition-all",children:[a.jsx(nt,{className:"h-4 w-4 mr-1.5"}),a.jsx("span",{className:"font-medium",children:L?"Añadir datos":""})]})})]})]})]})]})}),a.jsx("div",{className:"absolute -inset-2 tooltip-glow rounded-3xl blur-xl -z-10"})]})},Dt=({baselineTemp:e,firstHighIndex:r,processedData:i,isValid:h})=>{if(r==null)return{confirmed:!1};const m=e+.2,n=[],c=[],b=new Set,k=o=>{o==null||b.has(o)||(b.add(o),c.push(o))};let y=0,w=!1,I=null,S=!1;const C=r>0?r-1:null,A=()=>C!=null?[C,...c]:[...c],H=()=>({confirmed:!1,requireRebaseline:!0,usedIndices:A(),highSequenceIndices:[...c]});for(let o=r;o<i.length;o+=1){const f=i[o];if(!h(f))break;const N=f.displayTemperature;if(!Number.isFinite(N))break;if(N>e){if(k(o),n.push({index:o,temp:N}),!w&&n.length===3&&n[2].temp<m&&(S=!0),!w&&n.length===4&&n[2].temp>=m)return{confirmed:!0,confirmationIndex:n[3].index,usedIndices:A(),highSequenceIndices:[...c],rule:"pp-4-high"};if(!w&&S&&n.length===5)return{confirmed:!0,confirmationIndex:n[4].index,usedIndices:A(),highSequenceIndices:[...c],rule:"pp-ex1-5-high"};if(w){if(n.length===4&&I==null)if(N>=m)I=o;else return H();if(I!=null&&n.length>=5){const g=n[n.length-1].index;if(g!==I)return{confirmed:!0,confirmationIndex:g,usedIndices:A(),highSequenceIndices:[...c],rule:"pp-ex2-5-high"}}}continue}if(N<=e){if(y+=1,k(o),y>=2)return H();if(n.length>0&&n.length<3&&!w){w=!0;continue}break}break}return{confirmed:!1,usedIndices:A(),highSequenceIndices:[...c]}},Ue={0:0,1:.4,2:.8,3:1},jt={M:.8,F:1,"M+":1,white:.4},Ct=(e,r=0,i=1)=>!Number.isFinite(e)||e<r?r:e>i?i:e,Ft=e=>e?String(e).toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),""):"",pt=e=>Ft(e).replace(/\s+/g," ").trim(),ht=(e,r=[])=>{if(!e)return null;let i=null;return r.forEach((h,m)=>{const{patterns:n=[],level:c,descriptor:b,negatedLevel:k,allowedModifiers:y=null,disallowedModifiers:w=null,selectionScore:I,forceSelection:S=!1}=h||{};n.forEach(C=>{if(!C)return;const A=new RegExp(`(?:^|[^a-z0-9])(?:(no|muy|poco|leve)\\s+)?(${C})(?=$|[^a-z0-9])`,"g");let H;for(;(H=A.exec(e))!==null;){const o=H[1]?H[1].trim():null;if(y&&!y.includes(o)||w&&w.includes(o))continue;let f=c;o==="no"?f=k??1:o==="muy"?f=Math.min(3,c+1):(o==="poco"||o==="leve")&&(f=Math.max(0,c-1));const N=I??f+m*.001,g=typeof b=="function"?b({modifier:o}):b;(!i||S||f>i.level||f===i.level&&N>i.selectionScore)&&(i={level:f,baseLevel:c,descriptor:g,modifier:o,selectionScore:N,force:S})}})}),i},_t=[{patterns:["escurridiz\\w*"],level:3,descriptor:"escurridiza",selectionScore:4},{patterns:["lubric\\w*","aceitos\\w*","oleos\\w*"],level:3,descriptor:"lubricada"},{patterns:["empapad\\w*"],level:2,descriptor:"empapada"},{patterns:["mojad\\w*"],level:2,descriptor:"mojada"},{patterns:["resbalad\\w*","desliz\\w*"],level:2,descriptor:"resbaladiza"},{patterns:["resbalos\\w*"],level:2,descriptor:"resbalosa"},{patterns:["humed\\w*"],level:1,descriptor:"húmeda"},{patterns:["pegajos\\w*","viscos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["asper\\w*"],level:0,descriptor:"áspera",selectionScore:.6},{patterns:["sin\\s+humedad"],level:0,descriptor:"sin humedad",selectionScore:.5},{patterns:["seca","seco","tirant\\w*"],level:0,descriptor:"seca"}],Lt=[{patterns:["poco\\s+elastic\\w*","leve\\s+elastic\\w*"],level:1,descriptor:"poco elástico",forceSelection:!0,selectionScore:20},{patterns:["amarillent\\w*"],level:1,descriptor:"amarillento"},{patterns:["cristalin\\w*"],level:3,descriptor:"cristalino",selectionScore:4},{patterns:["liquid\\w*","acuos\\w*","transpar\\w*"],level:3,descriptor:"líquido",selectionScore:4},{patterns:["como\\s+agua"],level:3,descriptor:"como agua",selectionScore:3.8},{patterns:["estirabl\\w*"],level:3,descriptor:"estirable",selectionScore:3.6},{patterns:["ch"],level:3,descriptor:"clara de huevo",selectionScore:3.5},{patterns:["clara\\s*(?:de)?\\s*huevo"],level:3,descriptor:"clara de huevo",selectionScore:3.4},{patterns:["filant\\w*","hilad\\w*","elastic\\w*"],level:3,descriptor:({modifier:e})=>e==="no"?"no filante":e==="poco"||e==="leve"?"poco filante":"filante",negatedLevel:1},{patterns:["cremos\\w*","lechos\\w*","leche","crema","manteq\\w*","pastos\\w*"],level:2,descriptor:"cremosa"},{patterns:["turbio\\w*"],level:2,descriptor:"turbio",selectionScore:2.6},{patterns:["pegajos\\w*","grumos\\w*","grumoso","gomos\\w*"],level:1,descriptor:"pegajosa"},{patterns:["espes\\w*"],level:1,descriptor:"espeso"},{patterns:["nada\\s+visible"],level:0,descriptor:"sin moco",selectionScore:1},{patterns:["sin\\s+moco","ausente","nulo"],level:0,descriptor:"sin moco"}],gt=e=>{if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e)){const i=Math.round(e);if(i>=0&&i<=3)return i}const r=String(e).trim();return/^[0-3]$/.test(r)?Number.parseInt(r,10):null},bt=e=>{const r=gt(e);if(r!=null)return{level:r,reason:`S${r}`,descriptor:`S${r}`,hasInput:!0};const i=e!=null?String(e).trim():"",h=pt(e),m=i.length>0;if(!h)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^s\s*0?$/.test(h))return{level:0,reason:"seca",descriptor:"seca",hasInput:!0};if(h==="h")return{level:1,reason:"húmeda",descriptor:"húmeda",hasInput:!0};const n=ht(h,_t);return n?{level:Math.max(0,Math.min(3,n.level)),reason:n.descriptor,descriptor:n.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},xt=e=>{const r=gt(e);if(r!=null)return{level:r,reason:`M${r}`,descriptor:`M${r}`,hasInput:!0};const i=e!=null?String(e).trim():"",h=pt(e),m=i.length>0;if(!h)return{level:0,reason:null,descriptor:null,hasInput:m};if(/^m\s*0$/.test(h))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};if(/[∅ø]/i.test(i))return{level:0,reason:"sin moco",descriptor:"sin moco",hasInput:!0};const n=ht(h,Lt);return n?{level:Math.max(0,Math.min(3,n.level)),reason:n.descriptor,descriptor:n.descriptor,hasInput:!0}:{level:0,reason:null,descriptor:null,hasInput:m}},Rt=e=>String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),zt=({appearance:e,observations:r,fertilitySymbol:i})=>{const h=[e,r,i].map(n=>String(n||"").toUpperCase()),m=n=>{if(!n)return!1;const b=`(?:^|[^\\p{L}\\p{N}])${Rt(n)}(?=$|[^\\p{L}\\p{N}])`,k=new RegExp(b,"u");return h.some(y=>k.test(y))};return m("M+")?"M+":m("M")?"M":m("F")||m("FER")?"F":String(i||"").toLowerCase()==="white"?"white":"none"},Et=e=>{if(e==null)return"";const r=String(e).trim().toUpperCase();return r==="P"||r==="PEAK"?"P":r==="1"||r==="P1"||r==="P+1"?"1":r==="2"||r==="P2"||r==="P+2"?"2":r==="3"||r==="P3"||r==="P+3"?"3":""},Ve=e=>!Number.isFinite(e)||e<0?0:e>3?3:e,Bt=(e,r,i)=>{const h=e?.mucusSensation??e?.mucus_sensation,m=e?.mucusAppearance??e?.mucus_appearance,n=e?.fertility_symbol??e?.fertilitySymbol,c=e?.observations??e?.notes,b=e?.peak_marker??e?.peakMarker??null,k=typeof b=="string"?b.trim().toLowerCase()==="peak":!1,y=bt(h),w=xt(m);let I=Ve(y.level),S=Ve(w.level);const C=[];y.reason&&C.push(`S:${y.reason}`),w.reason&&C.push(`M:${w.reason}`);const A=zt({appearance:m,observations:c,fertilitySymbol:n}),H=A;let o=A;o==="white"&&(S=Math.max(S,1)),o==="M"&&(S=Math.max(S,2)),o==="M+"&&(S=Math.max(S,3)),o==="F"&&(S=Math.max(S,3),I=Math.max(I,3));const f=Ue[I]??0,N=Ue[S]??0,g=Math.max(f,N);o&&o!=="none"&&C.push(`symbol:${o}`);const M=jt[o]??0,v=Ct(Math.max(g,M)),z=r!=null&&Number.isFinite(r)?g>=r+.4-1e-9:!1;z&&C.push("cambioBIP");const L={hasSensation:!!y.hasInput,hasAppearance:!!w.hasInput,hasSymbol:n!=null&&String(n).trim()!==""&&String(n).trim().toLowerCase()!=="none",hasObservation:c!=null&&String(c).trim()!==""};L.hasAny=L.hasSensation||L.hasAppearance||L.hasSymbol||L.hasObservation;const D=Et(e?.normalizedPeakStatus??e?.peakStatus??e?.peak_marker);return{index:i,S:I,M:S,symbolDetected:o,rawSymbol:H,isPeakMarked:k,scoreCore:g,scoreFertil:v,hasChangeBIP:z,reasons:C,entryFlags:L,descriptors:{sensation:y.descriptor??y.reason??null,appearance:w.descriptor??w.reason??null},normalizedPeakStatus:D}},$t=(e=[])=>{if(!Array.isArray(e)||e.length===0)return{days:[],bipScore:0};const r=[];for(let m=0;m<Math.min(6,e.length);m+=1){const n=e[m];if(!n||String(n?.fertility_symbol||"").toLowerCase()==="red")continue;const b=bt(n?.mucusSensation??n?.mucus_sensation),k=xt(n?.mucusAppearance??n?.mucus_appearance),y=Ue[Ve(b.level)]??0,w=Ue[Ve(k.level)]??0;r.push(Math.max(y,w))}const i=r.length>0?Math.max(...r):0;return{days:e.map((m,n)=>Bt(m,i,n)),bipScore:i}},Ht=e=>{for(let r=0;r<e.length;r+=1){const i=e[r];if(i){if(i.isPeakMarked)return{source:"Interno",day:r+1,reason:"P",kind:"profile"};if(i.symbolDetected==="white"||i.rawSymbol==="white")return{source:"Interno",day:r+1,reason:"white",kind:"profile"};if(i.symbolDetected==="M+"||i.symbolDetected==="F")return{source:"Interno",day:r+1,reason:"M+",kind:"profile"};if(i.symbolDetected==="M")return{source:"Interno",day:r+1,reason:"M",kind:"profile"};if(i.M>=2||i.S>=2)return{source:"Interno",day:r+1,reason:"S/M>=2",kind:"profile"}}}return null},Ot=(e,r)=>{const i=e.filter(n=>n&&Number.isFinite(n.day)).map(n=>({...n}));if(i.length===0)return{status:"indeterminado",selectedDay:null,selectedMode:r,usedCandidates:[],notes:["Sin candidatos disponibles"]};const h=[...i].sort((n,c)=>{const b=Number.isFinite(n.day)?n.day:Number.POSITIVE_INFINITY,k=Number.isFinite(c.day)?c.day:Number.POSITIVE_INFINITY;return b-k}),m=Math.min(...h.map(n=>Math.round(n.day)));return{status:m!=null?"ok":"indeterminado",selectedDay:m??null,selectedMode:r,usedCandidates:h,notes:[]}},Wt=({processedData:e=[],config:r={},calculatorCandidates:i=[],context:h={}})=>{const{calculators:m={cpm:!0,t8:!0},postpartum:n=!1,combineMode:c="conservador"}=r||{},k=new Set(["conservador","estandar"]).has(c)?c:"conservador",{postPeakStartIndex:y=null,temperatureInfertileStartIndex:w=null,temperatureConfirmationIndex:I=null,temperatureRule:S=null,todayIndex:C=null}=h||{},{days:A,bipScore:H}=$t(e),o=Array.isArray(A)?A.length:0,f=t=>Number.isInteger(t)&&t>=0&&t<o,N=t=>{const l=t?.peak_marker??t?.peakMarker??null;return typeof l=="string"&&l.trim().toLowerCase()==="peak"},M=(()=>{if(!Array.isArray(e)||e.length===0)return null;for(let t=e.length-1;t>=0;t-=1)if(N(e[t]))return t;return null})(),v=f(M)?M:null,z=[],L=t=>{!t||!Number.isFinite(t.day)||z.push({originalSource:t.originalSource??t.source,...t,kind:t.kind??"profile"})};L(Ht(A));const D=[],q=[];n&&D.push("Calculadoras CPM/T-8 omitidas por configuración de posparto."),n||i.forEach(t=>{if(!t)return;const l=typeof t.source=="string"?t.source.toUpperCase().replace(/-/g,""):"";if(!(l==="CPM"&&m.cpm||l==="T8"&&m.t8))return;const R={...t,source:l,kind:"calculator"};k==="conservador"?L(R):q.push(R)});const G=z.map(t=>({...t})),F=k==="conservador"?z:z.filter(t=>t.kind!=="calculator"),O=Ot(F,k);O.ignoredCalculatorCandidates=q,O.notes=Array.from(new Set([...O.notes??[],...D].filter(Boolean)));const be=t=>{if(!Number.isFinite(t))return null;const l=Math.max(1,Math.round(t));return e.length>0?Math.min(l,e.length):l},te=Number.isFinite(O.selectedDay)?be(O.selectedDay):null;if(te!=null&&te!==O.selectedDay){const t=`El día calculado (${O.selectedDay}) supera la duración del ciclo. Se usa ${te}.`;O.notes=Array.from(new Set([...O.notes??[],t])),O.selectedDay=te}let xe=null;te!=null&&te>=1&&(xe=te-1);const B=A.length>0?A.length-1:null,$=Number.isInteger(xe)&&xe>=0?xe:null;let X=null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(y)){const t=Math.max($,Math.min(y-1,B));X=t>=$?t:$}else if(f(v)){const t=Math.min(B,v+2),l=Math.max($,t);X=l>=$?l:$}else X=B;const ye=t=>t===0?"P":t===-1?"P−1":t===-2?"P−2":t===1?"P+1":t===2?"P+2":null,J=t=>Number.isInteger(t)?B==null||B<0?t>=0?t:null:t<0?null:t>B?B:t:null,me=t=>{if(!Number.isInteger(t)||t<0||t>=e.length)return null;const l=e[t]?.isoDate;if(!l)return null;try{const T=Ye(l);return Number.isNaN(T?.getTime?.())?null:T}catch{return null}},Ie=t=>{const l=me(t);if(!l)return null;try{return lt(l,"dd/MM")}catch{return null}};let oe=null,V=null;if(f(v)){const t=v+3;f(t)&&(oe=t);const l=v+4;f(l)&&(V=l);const T=J(v),R=me(T);if(R)for(let he=T+1;he<e.length;he+=1){const ze=me(he);if(!ze)continue;const Ee=ft(ze,R);if(oe==null&&Ee>=3&&(oe=J(he)),V==null&&Ee>=4&&(V=J(he)),oe!=null&&V!=null)break}}const je=J(I),ie=J(w);let Z=je;if(Z==null&&ie!=null){const t=J(ie-1);t!=null&&t>=0&&(Z=t)}const ne=k==="conservador"?V??null:oe??null,Ce=null,ve=[ne,ie].filter(t=>Number.isInteger(t)),Y=ve.length>0?Math.min(...ve):null,ae=Number.isInteger(ne),fe=Number.isInteger(ie),Se=ae&&fe?Math.max(ne,ie):null;if($!=null&&B!=null&&B>=$)if(Number.isInteger(Y)){const t=Math.max($,Y-1);X=Math.min(t,B)}else X=B;const re=X??B??null,ce=Y;let U=null;ae&&fe?U=k==="conservador"?"P+4 y T+3":"P+3 y T+3":ae?U=k==="conservador"?"P+4":"P+3":fe&&(U=S??"Temperatura");const Pe={conservador:"modo conservador",estandar:"modo estándar",marcador:"marcador explícito"},ke=O?.selectedMode??k??"conservador",ue=O?.usedCandidates??[],Te=ue.some(t=>t?.kind==="profile"),pe=ue.some(t=>t?.kind==="calculator"),W=A.some(t=>t?.entryFlags?.hasAppearance||t?.entryFlags?.hasSensation||t?.symbolDetected&&t.symbolDetected!=="none");let K=`Fase fértil abierta (${Pe[ke]??ke}).`;ke==="marcador"?K="Fase fértil abierta (ajustada por tus marcadores).":Te&&W?K="Fase fértil abierta (basada en tus observaciones de moco).":pe&&!Te&&(K="Inicio fértil estimado por calculadora (según tus ciclos anteriores).");const ee=ae&&fe,He="Infertilidad absoluta postovulatoria",Ge=`Ventana cerrada por doble criterio: ${U??"criterio indeterminado"}.`,le=J(v),Ke=Ie(le),Fe=Ie(Z),Oe="Infertilidad estimada por moco",We=Ke?`Fase de infertilidad alcanzada por determinación de día pico el ${Ke}.`:"Fase de infertilidad alcanzada por determinación de día pico.",qe="Infertilidad estimada por temperatura",Qe=Fe?`Infertilidad estimada por temperatura desde el ${Fe}.`:"Infertilidad estimada por temperatura.",de=new Array(A.length).fill(null);let s=null,u=0,d=null;const x={inicio:0,aumento:1,alta:2,muyAlta:3},p=t=>{if(!t)return[];const l=[];if(Number.isFinite(t.M)&&t.M>0){const T=t.descriptors?.appearance;l.push(`M${t.M}${T?` (${T})`:""}`)}if(Number.isFinite(t.S)&&t.S>0){const T=t.descriptors?.sensation;l.push(`S${t.S}${T?` (${T})`:""}`)}return t.symbolDetected&&t.symbolDetected!=="none"&&(t.symbolDetected==="white"?l.push("white"):l.push(`símbolo ${t.symbolDetected}`)),t.hasChangeBIP&&l.push("cambio BIP"),l},P=["inicio","aumento","alta","muyAlta"];for(let t=0;t<A.length;t+=1){const l=A[t];if(!l){de[t]=null;continue}const T=Number.isInteger(Y),R=T?t>=Y:!1,he=Number.isInteger(Se)?t>=Se:!1,ze=$!=null&&re!=null&&t>=$&&(T?t<Y:t<=re)&&!R,Ee=Number.isInteger(C)&&C!=null?t>C:!1;if(!ze){if(u=0,s=null,!(R||re!=null&&t>re)||!T){de[t]=null;continue}const Xe=!!l.entryFlags?.hasAny,et=Xe?null:"Sin registro hoy; estimación basada en días adyacentes.";let Re=null,Be=null,$e=null;if(he&&ee?(Re=He,Be=Ge,$e="absolute"):ae&&t>=ne?(Re=Oe,Be=We,$e="mucus"):fe&&t>=ie&&(Re=qe,Be=Qe,$e="temperature"),!$e){de[t]=null;continue}de[t]={index:t,state:"infertil",status:$e,title:Re,header:Re,body:Be,detail:U,hasRecord:Xe,inherited:!1,note:et,isFertile:!1,phase:"postOvulatory",label:Re,summaryText:Be,reasonsList:[],reasonsText:"",showFertilityStatus:!Ee};continue}const _e=!!l.entryFlags?.hasAny;let Ae=0;l.isPeakMarked||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3||l.M>=3?Ae=3:l.M>=2||l.S>=2||l.symbolDetected==="M"?Ae=2:(l.M>=1||l.S>=1||l.hasChangeBIP)&&(Ae=1),_e?(u=0,s=Ae):u+=1;const yt=l.M>=2||l.symbolDetected==="M+"||l.symbolDetected==="F"||l.S>=3;let we=Ae,Q=null;{if(!_e){const Xe=s??Ae,et=Math.floor(u/2);we=Math.max(0,Xe-et)}const Ze=Math.max(0,Math.min(3,we));Q=P[Ze]}const ot=p(l),De=ot.join("; "),Le=le!=null?t-le:null,Je=Le!=null?ye(Le):null,It=_e?null:"Sin registro hoy; estimación basada en días adyacentes.";Q!=="waiting"&&(Le===0||Le===1||Le===2?(Q="muyAlta",we=Math.max(we,3)):Le===3?(x[Q]<x.alta&&(Q="alta"),we=Math.max(we,2)):d!=null&&t-d<=3&&(x[Q]<x.aumento&&(Q="aumento"),we=Math.max(we,1))),(Q==="alta"||Q==="muyAlta"||yt)&&(d=t);let ge,se;switch(Q){case"waiting":ge="Fertilidad en espera de confirmación por temperatura",se="Final de moco alcanzado (≥P+3). Ventana mantenida hasta confirmación térmica (T+3).";break;case"aumento":ge="Aumento de fertilidad",se=De?`Signos en aumento: ${De}.`:"Signos en aumento.";break;case"alta":ge="Fertilidad alta",se=De?`Signos fértiles claros (${De}).`:"Signos fértiles claros.";break;case"muyAlta":{ge="Fertilidad muy alta",se=`Día de máxima fertilidad${Je?` (${Je})`:""}.`,se+=De?` Signos pico: ${De}.`:" Signos pico presentes.";break}default:ge="Ventana fértil abierta",se="Hoy sin signos destacables, a la espera de registrar más datos.";break}_e||(Q==="alta"?(ge="Fertilidad estimada alta",se=`${se} Sin datos apuntados este día; se estima en base a días cercanos.`):Q==="muyAlta"?(ge="Fertilidad estimada muy alta",se=`${se} Sin datos apuntados este día; se estima en base a días cercanos.`):(Q==="aumento"||Q==="inicio")&&(ge="Ventana fértil abierta (sin registro hoy)",se=`${se} Sin datos apuntados este día; se estima en base a días cercanos.`));const vt={index:t,state:Q,level:Q==="waiting"?Ae:we,title:ge,header:K,body:se,reasonsList:ot,reasonsText:De,hasRecord:_e,inherited:!_e,note:It,isFertile:!0,phase:"fertile",label:ge,summaryText:se,delta:Je,showFertilityStatus:!Ee,reasonParts:{symbol:l.symbolDetected??null,appearance:l.descriptors?.appearance??null,sensation:l.descriptors?.sensation??null}};de[t]=vt}re!=null&&(X=re);let j=null;if(Number.isInteger(C)&&de.length>0){const t=Math.min(Math.max(C,0),de.length-1);let l=null;for(let T=t;T>=0;T-=1){const R=de[T];if(R&&(l||(l=R),R.isFertile)){j=R;break}}!j&&l&&(j=l)}const E={bipScore:H,effectivePeakIndex:v,candidatesBeforeAggregate:G,closureDetail:U,waitingStartIndex:Ce,pPlus3Index:oe,pPlus4Index:V,temperatureConfirmationIndex:Z,temperatureInfertileIndex:ie,temperatureRule:S??null,mucusInfertileStartIndex:ne,postOvulatoryStartIndex:ce,firstEstimateIndex:Y,absoluteStartIndex:Se};return{fertileStartFinalIndex:xe,fertileWindow:$!=null&&X!=null?{startIndex:$,endIndex:X,waitingStartIndex:Ce,closureDetail:U,temperatureConfirmationIndex:Z,temperatureInfertileStartIndex:ie,mucusInfertileStartIndex:ne,postOvulatoryStartIndex:ce,temperatureRule:S??null}:null,dailyAssessments:de,currentAssessment:j,candidates:G,aggregate:O,debug:E}},dt=e=>{if(!e)return null;try{const r=new Date(e);return Number.isNaN(r.getTime())?null:r}catch{return null}},qt=(e=[])=>{if(!Array.isArray(e)||e.length===0)return null;const i=e.map(c=>{if(!c?.startDate||!c?.endDate)return null;const b=dt(c.startDate),k=dt(c.endDate);if(!b||!k||k<b)return null;const y=Math.round((k-b)/(1e3*60*60*24))+1;if(!Number.isFinite(y)||y<=0)return null;const w=!!c?.ignoredForAutoCalculations;return{duration:y,ignored:w}}).filter(Boolean).filter(c=>!c.ignored);if(i.length<6)return null;const h=i.reduce((c,b)=>b.duration<c.duration?b:c),m=i.length>=12?20:21,n=h.duration-m;return Number.isFinite(n)?{source:"CPM",day:Math.max(1,Math.round(n)),reason:`ciclo_mas_corto=${h.duration}`,kind:"calculator"}:null},rt=e=>{if(e==null||e==="")return null;const r=Number.parseFloat(String(e).replace(",","."));return Number.isFinite(r)?r:null},Xt=e=>{const r=[e?.temperature_chart,e?.temperature_raw,e?.temperature_corrected];for(const i of r){const h=rt(i);if(h!==null)return h}if(Array.isArray(e?.measurements)){const i=n=>{if(!n)return null;const c=rt(n.temperature),b=rt(n.temperature_corrected);return n.use_corrected&&b!==null?b:c!==null?c:b!==null?b:null},m=e.measurements.find(n=>n&&n.selected&&i(n)!==null)||e.measurements.find(n=>i(n)!==null);if(m){const n=i(m);if(n!==null)return n}}return null},Yt=(e=[],r)=>{if(!Array.isArray(e)||e.length===0||typeof r!="function")return null;const i=[];if(e.forEach(m=>{if(!m?.data||!Array.isArray(m.data)||!m.startDate)return;const n=m.data.filter(S=>S&&S.isoDate).map(S=>({...S,displayTemperature:Xt(S)}));if(n.length===0)return;const{ovulationDetails:c}=r(n);if(!c?.confirmed)return;const b=Number.isInteger(c?.ovulationIndex)?c.ovulationIndex:Number.isInteger(c?.confirmationIndex)?c.confirmationIndex:null;if(b==null||b<0||b>=n.length)return;const k=n[b],y=Number(k?.cycleDay);if(!Number.isFinite(y)||y<=0)return;const w=Math.max(1,Math.round(y-8)),I={riseDay:y,t8Day:w,ignored:!!m?.ignoredForAutoCalculations};!I.ignored&&i.length<12&&i.push(I)}),i.length<6)return null;const h=i.reduce((m,n)=>n.t8Day<m.t8Day?n:m);return{source:"T8",day:Math.max(1,Math.round(h.t8Day)),reason:`t8=${h.t8Day}`,kind:"calculator"}},st={calculators:{cpm:!0,t8:!0},combineMode:"conservador"},it=36.1,at=37.5,mt=(e=[],r={})=>{const{postpartum:i=!1}=r,h=o=>o&&o.displayTemperature!=null&&!o.ignored,m=6,n=.05,c=o=>{if(!o||o.length!==m)return null;const f=o.map(M=>M.temp);if(f.some(M=>!Number.isFinite(M)))return null;const N=f.reduce((M,v)=>v>M?v:M,f[0]),g=f.reduce((M,v)=>v>=N-n&&v<N?M+1:M,0);return g>=2?null:{baselineTemp:N,baselineStartIndex:o[0].index,baselineIndices:o.map(M=>M.index),baselineBorderlineCount:g}},b=o=>{const f=[];for(let N=o;N<e.length;N+=1){const g=e[N];if(!h(g))continue;const M=g.displayTemperature;if(Number.isFinite(M)&&(f.push({index:N,temp:M}),f.length>m&&f.shift(),f.length===m)){const v=c(f);if(!v)continue;let z=null;for(let L=N+1;L<e.length;L+=1){const D=e[L];if(!h(D))continue;const q=D.displayTemperature;if(Number.isFinite(q)&&q>v.baselineTemp){z=L;break}}return{baselineTemp:v.baselineTemp,baselineStartIndex:v.baselineStartIndex,baselineIndices:v.baselineIndices,baselineBorderlineCount:v.baselineBorderlineCount,firstHighIndex:z}}}return null},k={confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null};let y=null,w=null,I=null,S=[],C=k,A=0;const H=({baselineTemp:o,firstHighIndex:f})=>{if(f==null)return{confirmed:!1};const N=o+.2,g=[],M=[],v=new Set,z=F=>{F==null||v.has(F)||(v.add(F),M.push(F))};let L=null,D=!1;const q=f>0?f-1:null,G=()=>q!=null?[q,...M]:[...M];for(let F=f;F<e.length;F++){const O=e[F];if(!h(O))break;const be=O.displayTemperature;if(!Number.isFinite(be))break;if(be>o){if(z(F),g.push({index:F,temp:be}),g.length===3&&g[2].temp>=N)return{confirmed:!0,confirmationIndex:g[2].index,usedIndices:G(),highSequenceIndices:[...M],rule:"3-high"};if(g.length===4&&g[2].temp<N&&g[3].temp>o)return{confirmed:!0,confirmationIndex:g[3].index,usedIndices:G(),highSequenceIndices:[...M],rule:"german-3+1"};if(L!==null&&g.length===3&&g[2].temp>=N)return{confirmed:!0,confirmationIndex:g[2].index,usedIndices:G(),highSequenceIndices:[...M],rule:"german-2nd-exception"};if(g.length===5&&g[3].temp>o&&g[4].temp>=N)return{confirmed:!0,confirmationIndex:g[4].index,usedIndices:G(),highSequenceIndices:[...M],rule:"5-high"};continue}if(be>=o-.05&&L===null&&g.length>0&&g.length<3){L=F,z(F),g.push({index:F,temp:o});continue}if(!D&&g.length>0&&g.length<3){D=!0,z(F);continue}break}return{confirmed:!1,usedIndices:G(),highSequenceIndices:[...M]}};for(;A<e.length;){const o=b(A);if(!o)break;if(y=o.baselineTemp,w=o.baselineStartIndex,S=Array.isArray(o.baselineIndices)?[...o.baselineIndices]:[],I=o.firstHighIndex,o.baselineBorderlineCount,I==null){A=w+1;continue}const f=i?Dt({...o,processedData:e,isValid:h}):H(o);if(f?.requireRebaseline){A=w+1;continue}if(f?.confirmed){const N=f.highSequenceIndices?.length?f.highSequenceIndices[0]:null,g=Number.isInteger(f.confirmationIndex)?Math.max(0,Math.min(f.confirmationIndex,e.length-1)):null;let M=null;g!=null&&(M=Math.max(0,Math.min(g,e.length-1))),C={confirmed:!0,confirmationIndex:g,infertileStartIndex:M,rule:f.rule,highSequenceIndices:f.highSequenceIndices??f.usedIndices,usedIndices:f.usedIndices,ovulationIndex:I??N??null};break}A=w+1}return{baselineTemp:y,baselineStartIndex:w,firstHighIndex:I,baselineIndices:S,ovulationDetails:C}},Jt=(e,r,i,h,m,n=5,c=!1,b=null,k=[],y=null,w=!1)=>{const I=_.useRef(null),S=_.useRef(null),[C,A]=_.useState({width:0,height:0,viewportWidth:0,viewportHeight:0}),[H,o]=_.useState(null),[f,N]=_.useState({x:0,y:0}),[g,M]=_.useState(null),v=_.useCallback(()=>{o(null),M(null)},[]),z=s=>{if(s==null)return"";const u=String(s).trim().toUpperCase();return u==="P"||u==="PEAK"?"P":u==="1"||u==="P1"||u==="P+1"?"1":u==="2"||u==="P2"||u==="P+2"?"2":u==="3"||u==="P3"||u==="P+3"?"3":""},L=_.useMemo(()=>At(e),[e]),D=_.useMemo(()=>{const s=d=>{if(d==null||d==="")return null;const x=parseFloat(String(d).replace(",","."));return Number.isFinite(x)?x:null},u=d=>{if(!d)return null;const x=s(d.temperature),p=s(d.temperature_corrected);return d.use_corrected&&p!==null?p:x!==null?x:p!==null?p:null};return e.map(d=>{const x=[d?.temperature_chart,d?.temperature_raw,d?.temperature_corrected];let p=null;for(const l of x)if(l!=null&&l!==""){p=l;break}if(p==null&&Array.isArray(d?.measurements)){const T=d.measurements.find(R=>R&&R.selected&&u(R)!==null)||d.measurements.find(R=>u(R)!==null);T&&(p=u(T))}const P=d?.isoDate,j=d?.peak_marker??d?.peakStatus??null,E=P?L[P]??j:j,t=z(E);return{...d,displayTemperature:s(p),peakStatus:E??null,normalizedPeakStatus:t}})},[e,L]),q=_.useMemo(()=>{if(!Array.isArray(D)||D.length===0)return null;const s=new Date;let u=null;return D.forEach((d,x)=>{if(d?.isoDate)try{const p=Ye(d.isoDate);if(Number.isNaN(p?.getTime?.()))return;ft(p,s)<=0&&(u=x)}catch{}}),u},[D]);_.useLayoutEffect(()=>{const s=()=>{if(!I.current)return;const d=I.current.parentElement||I.current;let x=d.clientWidth||600,p=d.clientHeight||400,P=I.current.clientWidth>0?I.current.clientWidth:x,j,E,t,l;if(r){let T=window.innerWidth,R=window.innerHeight;if(c&&R>T&&([T,R]=[R,T]),P=T,t=T,l=R,i==="portrait"&&!c){const he=Math.max(30,T*.05);j=(T-he)/n*e.length}else j=T/n*e.length;E=R}else j=P/n*e.length,E=p,t=P,l=p;A({width:j,height:E,viewportWidth:t,viewportHeight:l})};s(),window.addEventListener("resize",s);let u;if(I.current){const d=I.current.parentElement||I.current;u=new ResizeObserver(s),u.observe(d)}return()=>{window.removeEventListener("resize",s),u&&u.disconnect()}},[r,e.length,n,i,c]);const G=_.useMemo(()=>D.filter(s=>s&&s.isoDate&&!s.ignored&&s.displayTemperature!==null&&s.displayTemperature!==void 0),[D]),F=_.useMemo(()=>D.filter(s=>s&&s.isoDate),[D]),O=G.length>0,be=_.useMemo(()=>!Array.isArray(D)||D.length===0?!1:D.some(s=>s?s.displayTemperature!=null||["mucusAppearance","mucus_appearance","mucusSensation","mucus_sensation"].some(P=>{const j=s?.[P];return j!=null&&String(j).trim()!==""})||(()=>{const P=s?.fertility_symbol??s?.fertilitySymbol;return P==null?!1:String(P).trim()!==""})()||(()=>{const P=s?.observations??s?.notes;return P==null?!1:String(P).trim()!==""})()?!0:z(s?.normalizedPeakStatus??s?.peakStatus??s?.peak_marker)!=="":!1),[D]),te=_.useMemo(()=>{const s=b??{},u=(j,E)=>typeof j=="boolean"?j:E,d={cpm:u(s?.calculators?.cpm,st.calculators.cpm),t8:u(s?.calculators?.t8,st.calculators.t8)},p=new Set(["conservador","estandar"]).has(s?.combineMode)?s.combineMode:st.combineMode,P=!!s?.postpartum;return{calculators:d,combineMode:p,postpartum:P}},[b]),xe=_.useMemo(()=>{if(Array.isArray(y)&&y.length>0)return y.map(x=>{if(!x)return null;const{source:p,day:P,reason:j}=x,E=typeof p=="string"?p.toUpperCase().replace(/-/g,""):"";if(E!=="CPM"&&E!=="T8")return null;const t=Number(P);return Number.isFinite(t)?{source:E,originalSource:p??E,day:t,reason:typeof j=="string"?j:"",kind:"calculator"}:null}).filter(Boolean);const s=Array.isArray(k)?k:[];if(!s.length)return[];const u=qt(s),d=Yt(s,mt);return[u,d].filter(Boolean)},[y,k]),{peakDayIndex:B,thirdDayIndex:$,peakInfertilityStartIndex:X}=_.useMemo(()=>{if(!F.length)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};const s=F.map(x=>x?.normalizedPeakStatus??z(x?.peakStatus??x?.peak_marker));let u=null,d=null;if(s.forEach((x,p)=>{x==="P"&&u==null&&(u=p),x==="3"&&d==null&&(d=p)}),u==null)return{peakDayIndex:null,thirdDayIndex:null,peakInfertilityStartIndex:null};if(d!=null){const x=F.length-1,p=Math.min(d+1,x);return{peakDayIndex:u,thirdDayIndex:d,peakInfertilityStartIndex:p}}return{peakDayIndex:u,thirdDayIndex:null,peakInfertilityStartIndex:null}},[F]),{baselineTemp:ye,baselineStartIndex:J,firstHighIndex:me,baselineIndices:Ie,ovulationDetails:oe}=_.useMemo(()=>mt(D,{postpartum:te.postpartum}),[D,te.postpartum]),V=_.useMemo(()=>({...oe??{confirmed:!1,confirmationIndex:null,infertileStartIndex:null,rule:null,highSequenceIndices:[],usedIndices:[],ovulationIndex:null},baselineTemp:ye,baselineIndices:Ie,baselineStartIndex:J,firstHighIndex:me,peakDayIndex:B,peakInfertilityStartIndex:X,thirdDayIndex:$}),[oe,ye,Ie,J,me,B,X,$]),je=_.useMemo(()=>Wt({processedData:D,config:te,calculatorCandidates:xe,context:{postPeakStartIndex:X,peakThirdDayIndex:V?.thirdDayIndex??null,temperatureInfertileStartIndex:V?.infertileStartIndex??null,temperatureConfirmationIndex:V?.confirmationIndex??null,temperatureRule:V?.rule??null,todayIndex:q}}),[D,te,xe,V?.thirdDayIndex,V?.infertileStartIndex,V?.confirmationIndex,V?.rule,B,X,q]),ie=_.useMemo(()=>D.map((s,u)=>{if(!s)return s;const d=Number.isInteger(q)?u>q:!1;return{...s,isFutureDay:d}}),[D,q]),Z=_.useMemo(()=>ie.filter(s=>s&&s.isoDate),[ie]),{tempMin:ne,tempMax:Ce}=_.useMemo(()=>{const s=G.map(t=>t.displayTemperature).filter(t=>t!=null);if(s.length===0)return{tempMin:it,tempMax:at};const u=at-it,d=Math.min(...s),x=Math.max(...s);let p=Math.min(d,it),P=Math.max(x,at);const j=t=>Math.floor(t*10)/10,E=t=>Math.ceil(t*10)/10;if(p=j(p),P=E(P),P-p<u){const t=(p+P)/2;p=j(t-u/2),P=E(t+u/2)}return Math.abs(p-d)<1e-9&&(p=j(p-.1)),Math.abs(P-x)<1e-9&&(P=E(P+.1)),{tempMin:parseFloat(p.toFixed(1)),tempMax:parseFloat(P.toFixed(1))}},[G]),ve=Ce-ne,Y=C.width,ae=C.viewportHeight||C.height,fe=C.viewportWidth||Y,Se=9,re=(s=1)=>{if(!r)return Se*s;const u=Math.min(Y,ae);return Math.max(8,Math.min(Se*s,u/(Z.length>0?40/s:40)))},ce=Math.round(re(r?1.6:2)),U=c||i==="landscape",Pe=r?9:7.5,ke=Pe+(w?r?2:1.5:0),ue=r?1:.75,Te=Math.round(ce*(Pe+ue)),pe=Math.round(ce*(ke+ue)),W=Te,K=w?Math.max(0,pe-Te):0,ee=w?pe:Te,He=Math.max(ae-ee,ce*(r?10:8)),Ne=ee+Math.max(He,0),Ge=Ne+K,le={top:r?Math.max(U?6:12,ae*(U?.015:.03)):12,right:r?Math.max(U?35:30,Math.min(Y,fe)*(U?.02:.05)):50,bottom:Math.max(0,W-1),left:r?Math.max(U?45:20,Math.min(Y,fe)*(U?.02:.05)):50},Fe=Math.max(0,Math.round(ce*4)),Oe=Ne-le.bottom-Fe,We=s=>{const u=Ne-le.top-le.bottom-Fe;return s==null||ve===0||u<=0?Oe:Oe-(s-ne)/ve*u},qe=s=>{const u=r&&!(c||i==="landscape")?5:10,d=r&&!(c||i==="landscape")?25:0,x=15,p=r?Math.max(U?8:18,Math.min(Y,fe)*(U?.01:.05)):20,P=le.right+x,j=Y-le.left-P-u-p*2-d*(Z.length-1);if(j<=0)return le.left+u+p+d*s;const E=Z.length>1?Z.length-1:1;return E===0||Z.length===0?le.left+u+p+d*s:le.left+u+p+s*(j/(Z.length===1?1:E))+d*s},Qe=(s,u,d)=>{if(!s){v();return}const x=I.current.getBoundingClientRect();let p,P;if(d.type.startsWith("touch")){const l=d.changedTouches[0];p=l.clientX,P=l.clientY}else p=d.clientX,P=d.clientY;const j=qe(u),E=s.displayTemperature??s.temperature_chart??null,t=We(E);N({svgX:j,svgY:t,clientX:p-x.left+I.current.scrollLeft,clientY:P-x.top+I.current.scrollTop}),M(u),o(s)};_.useEffect(()=>{const s=u=>{if(S.current&&!S.current.contains(u.target)){const d=I.current?.querySelectorAll("circle, text, rect");let x=!1;if(d){for(let p of d)if(p.contains(u.target)){x=!0;break}}x||v()}};return H&&(document.addEventListener("mousedown",s),document.addEventListener("touchstart",s)),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("touchstart",s)}},[H,v]);const de=s=>{h&&s&&(h(m,s),v())};return{chartRef:I,tooltipRef:S,dimensions:{...C,contentHeight:Ne,scrollableContentHeight:Ge,extraScrollableHeight:K,viewportHeight:ae},activePoint:H,activeIndex:g,tooltipPosition:f,processedData:ie,validDataForLine:G,allDataPoints:Z,tempMin:ne,tempMax:Ce,tempRange:ve,padding:le,textRowHeight:ce,setActivePoint:o,setActiveIndex:M,getY:We,getX:qe,handlePointInteraction:Qe,clearActivePoint:v,handleToggleIgnore:de,responsiveFontSize:re,baselineTemp:ye,baselineStartIndex:J,baselineIndices:Ie,firstHighIndex:me,ovulationDetails:V,fertilityStart:je,hasTemperatureData:O,hasAnyObservation:be,graphBottomInset:Fe,todayIndex:q}};export{Qt as C,qt as a,Yt as b,mt as c,Jt as u};
