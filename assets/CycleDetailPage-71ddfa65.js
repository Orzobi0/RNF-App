import{c as B,l as F,a as J,u as V,b as H,r as o,f as S,p as f,j as t,B as y,L as R,k as W,h as L,g as Z}from"./index-8c1bb4d0.js";import{D as G}from"./DeletionDialog-dad1e6ec.js";import{u as K}from"./useCycleData-a1f868e4.js";import{RecordsExperience as Q}from"./RecordsPage-1c21047e.js";import{A as X}from"./arrow-left-078474d7.js";import{P as Y}from"./badge-6bd7af9d.js";import"./CycleDatesEditor-5cdf72be.js";import"./OverlapWarningDialog-7409f0f1.js";import"./computePeakStatuses-347fa954.js";import"./input-6cdf51b4.js";import"./label-60015da2.js";import"./checkbox-a510d285.js";import"./eye-5bd09b1b.js";const ee=B("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),se=(r,d)=>{const a=L(f(r)),l=L(f(d));return Z(a,l)+1},ae=(r,d)=>!r||!Array.isArray(r)||!d?[]:[...r].sort((l,h)=>f(l.isoDate)-f(h.isoDate)).map(l=>({...l,ignored:l.ignored||!1,cycleDay:se(l.isoDate,d)})),ye=()=>{const{cycleId:r}=F(),d=J(),{user:a}=V(),{getCycleById:l,isLoading:h,addOrUpdateDataPoint:x,deleteRecord:b,updateCycleDates:k,deleteCycle:v,checkCycleOverlap:$,forceUpdateCycleStart:D,refreshData:j}=K(),{toast:u}=H(),[e,N]=o.useState(null),[A,g]=o.useState(!1),[w,E]=o.useState(!1),p=e?`${S(f(e.startDate),"dd/MM/yyyy")} - ${e.endDate?S(f(e.endDate),"dd/MM/yyyy"):"En curso"}`:"",C=o.useCallback(s=>{if(!a||!(s!=null&&s.id))return;const i={...s,data:(s.data||[]).map(({cycleDay:n,...c})=>c)};localStorage.setItem(`fertilityData_cycle_${a.uid}_${s.id}`,JSON.stringify(i))},[a]),m=o.useCallback(async()=>{if(!a||!r)return null;const s=await l(r);return s&&(C(s),N(s)),s},[r,l,C,a]);o.useEffect(()=>{(async()=>{if(!a)return;let i=await l(r);if(!i){const n=localStorage.getItem(`fertilityData_cycle_${a.uid}_${r}`);if(n){const c=JSON.parse(n);i={...c,data:ae(c.data||[],c.startDate)}}}i?(C(i),N(i)):(u({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),d("/archived-cycles"))})()},[r,a,l,u,d]);const O=o.useCallback(async(s,i)=>{if(!(e!=null&&e.id)||!a)return;const n=!!i;await x(s,i,e.id),await m()&&u({title:n?"Registro actualizado":"Nuevo registro añadido",description:"Datos del ciclo actualizados."})},[e==null?void 0:e.id,a,x,m,u]),P=o.useCallback(async s=>{!(e!=null&&e.id)||!a||(await b(s,e.id),await m(),u({title:"Registro eliminado",description:"El registro ha sido eliminado."}))},[e==null?void 0:e.id,a,b,m,u]),I=o.useCallback(async(s,i,n)=>{const c=s??(e==null?void 0:e.id);!a||!c||await k(c,i,n)},[e==null?void 0:e.id,a,k]),U=o.useCallback(async(s,i)=>{const n=s??(e==null?void 0:e.id);!a||!n||await D(n,i)},[e==null?void 0:e.id,a,D]),q=o.useCallback(async s=>{await j(s),await m()},[j,m]),z=()=>{g(!0)},M=o.useCallback(async()=>{if(!(!(e!=null&&e.id)||!a)){E(!0);try{await v(e.id),u({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),d("/archived-cycles")}catch(s){console.error(s),u({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{E(!1),g(!1)}}},[e==null?void 0:e.id,v,d,u,a]),T=o.useCallback(()=>t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(y,{asChild:!0,variant:"outline",size:"icon",className:"shrink-0 ml-2 rounded-full border-pink-300 text-pink-600 hover:bg-pink-50 hover:border-pink-400",children:t.jsxs(R,{to:"/archived-cycles","aria-label":"Volver a mis ciclos",children:[t.jsx(X,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:"Mis ciclos"})]})}),t.jsx("div",{className:"items-center justify-center px-4 py-3",children:t.jsxs("h2",{className:"text-2xl font-semibold text-rose-700 truncate",children:[e!=null&&e.name?`${e.name} · `:"",p]})})]}),[e==null?void 0:e.name,p]),_=o.useCallback(({openDateEditor:s,openAddRecord:i,isProcessing:n,isUpdatingDates:c})=>t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(y,{asChild:!0,variant:"outline",size:"icon",className:"border-pink-300 text-pink-600 rounded-full hover:bg-pink-50 hover:border-pink-400",children:t.jsx(R,{to:`/chart/${r}`,"aria-label":"Ver gráfica del ciclo",children:t.jsx(W,{className:"h-4 w-4"})})}),t.jsx(y,{type:"button",variant:"outline",size:"icon",onClick:s,"aria-pressed":c,className:"border-pink-300 text-pink-600 rounded-full hover:bg-pink-50 hover:border-pink-400",disabled:c,"aria-label":"Editar fechas del ciclo",children:t.jsx(ee,{className:"h-4 w-4"})}),t.jsx(y,{type:"button",size:"icon",onClick:i,className:"rounded-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow",disabled:n,"aria-label":"Añadir registro al ciclo",children:t.jsx(Y,{className:"h-4 w-4"})})]}),[r]);return h&&!e||!e?t.jsx("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-pink-600",children:t.jsx("p",{children:"Cargando detalles del ciclo..."})}):t.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),t.jsx(Q,{cycle:e,isLoading:h,addOrUpdateDataPoint:O,deleteRecord:P,updateCycleDates:I,checkCycleOverlap:$,forceUpdateCycleStart:U,refreshData:q,includeEndDate:!0,headerActions:_,topAccessory:T,headerTitle:"Mis registros",onRequestDeleteCycle:z,isDeletingCycle:w,dateEditorDeleteDescription:p?`Se eliminará el ciclo ${p} y todos sus registros asociados.`:"Se eliminará este ciclo y todos sus registros asociados."}),t.jsx(G,{isOpen:A,onClose:()=>g(!1),onConfirm:M,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:p?`¿Estás seguro de que quieres eliminar el ciclo ${p}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:w})]})};export{ye as default};
