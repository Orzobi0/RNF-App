import{c as oe,r as l,g as ce,a as de,u as ue,b as me,p as w,d as se,s as U,j as e,B as C,L as fe,f as K,e as he,X as pe}from"./index-091bc822.js";import{g as ge,F as xe,R as we}from"./generatePlaceholders-6ff1d6b9.js";import{R as ye,D as ve}from"./DeletionDialog-92631ac5.js";import{D as be}from"./DataEntryForm-8a2d2643.js";import{O as De}from"./OverlapWarningDialog-8764e8c9.js";import{a as Ce}from"./useCycleData-3d93d17f.js";import{D as je,a as Ee}from"./dialog-51f02635.js";import{T as Ne}from"./badge-ba0d7950.js";import{E as ke}from"./eye-off-2409ea2a.js";import{E as Se}from"./eye-1d723979.js";import"./ChartTooltip-fb88c83e.js";import"./input-b64dc7c3.js";import"./label-98f269bf.js";const Fe=oe("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]),Le=oe("Maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]),Re=oe("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),Oe=()=>{const[r,F]=l.useState(!1),[d,y]=l.useState("portrait"),n=l.useCallback(async(c="portrait")=>{const f=document.documentElement;try{f.requestFullscreen?await f.requestFullscreen():f.mozRequestFullScreen?await f.mozRequestFullScreen():f.webkitRequestFullscreen?await f.webkitRequestFullscreen():f.msRequestFullscreen&&await f.msRequestFullscreen(),typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.lock&&await window.screen.orientation.lock(`${c}-primary`).catch(()=>{}),y(c)}catch{}},[]),D=l.useCallback(async()=>{try{document.exitFullscreen?await document.exitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.msExitFullscreen&&await document.msExitFullscreen(),typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.unlock&&window.screen.orientation.unlock()}catch{}},[]),L=l.useCallback(async()=>{r?await D():await n(d)},[r,n,D,d]),q=l.useCallback(async()=>{const c=d==="portrait"?"landscape":"portrait";r?window.screen&&window.screen.orientation&&window.screen.orientation.lock&&await window.screen.orientation.lock(`${c}-primary`).catch(()=>{}):await n(c),y(c)},[d,r,n]);return l.useEffect(()=>{const c=()=>{const f=!!(document.fullscreenElement||document.webkitIsFullScreen||document.mozFullScreenElement||document.msFullscreenElement);F(f),!f&&typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.unlock&&window.screen.orientation.unlock()};return document.addEventListener("fullscreenchange",c),document.addEventListener("webkitfullscreenchange",c),document.addEventListener("mozfullscreenchange",c),document.addEventListener("MSFullscreenChange",c),()=>{document.removeEventListener("fullscreenchange",c),document.removeEventListener("webkitfullscreenchange",c),document.removeEventListener("mozfullscreenchange",c),document.removeEventListener("MSFullscreenChange",c)}},[]),{isFullScreen:r,orientation:d,toggleFullScreen:L,rotateScreen:q}},ne=28,Me=10,ze=({cycleData:r,addOrUpdateDataPointForCycle:F,deleteRecordForCycle:d,toggleIgnoreRecordForCycle:y,isFullScreen:n,toggleFullScreen:D,orientation:L,rotateScreen:q,showInterpretation:c,setShowInterpretation:f,onToggleInterpretation:P,chartDisplayData:Q,showForm:o,setShowForm:v,editingRecord:h,setEditingRecord:j,recordToDelete:E,setRecordToDelete:G,isProcessing:b,toast:re,onUpdateCycleDates:H,onDeleteCycle:M,checkOverlap:V,cycleId:Y})=>{const ee=L==="portrait"?Me:ne,J=m=>{const S=()=>{j(m),v(!0)};n?(D(),setTimeout(S,300)):S()},g=m=>{const S=r.data.find(Z=>Z.id===m);G(S)},te=()=>{E&&d(E.id)},[R,_]=l.useState(!1);l.useEffect(()=>{!n&&R&&_(!1)},[n,R]);const[B,O]=l.useState(!1),[x,z]=l.useState(r.startDate||""),[I,$]=l.useState(r.endDate||""),[W,N]=l.useState(""),[ae,T]=l.useState(!1),[a,t]=l.useState(null),[i,s]=l.useState(null);l.useEffect(()=>{z(r.startDate||""),$(r.endDate||"")},[r.startDate,r.endDate]);const A=()=>{B||(z(r.startDate||""),$(r.endDate||""),N("")),O(m=>!m)},X=()=>{z(r.startDate||""),$(r.endDate||""),N(""),O(!1)},u=async m=>{await H(m)&&(O(!1),N(""))},p=async m=>{if(m.preventDefault(),!x){N("La fecha de inicio es obligatoria");return}if(I&&I<x){N("La fecha de fin no puede ser anterior al inicio");return}N("");const S={startDate:x,endDate:I||void 0};if(V&&Y&&x){const Z=await V(Y,x);if(Z){t(S),s(Z),T(!0);return}}await u(S)},k=async()=>{a&&await u({...a,force:!0}),T(!1),t(null),s(null)},ie=()=>{T(!1),t(null),s(null)},le=()=>{window.confirm("¿Eliminar este ciclo?")&&(M(),O(!1))};return e.jsxs("div",{className:`w-full ${n?"h-full overflow-hidden":"max-w-4xl mx-auto"}`,children:[!n&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center justify-between gap-2 mb-2",children:e.jsx(C,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:e.jsxs(fe,{to:"/archived-cycles",children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"})," Mis Ciclos"]})})}),e.jsx("div",{className:"text-center",children:e.jsxs("button",{type:"button",onClick:A,className:`text-2xl sm:text-3xl font-bold px-4 py-3 rounded-xl transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2 ${B?"bg-rose-200/80 text-rose-700 shadow-inner":"bg-rose-100/60 hover:bg-rose-200/70 text-rose-700"}`,children:["Detalle de ciclo (",K(w(r.startDate),"dd/MM/yyyy")," - ",r.endDate?K(w(r.endDate),"dd/MM/yyyy"):"En curso",")"]})})]}),B&&!n&&e.jsxs("div",{className:"mb-6 mx-auto w-full max-w-xl rounded-2xl border border-rose-100 bg-white/90 p-5 shadow-lg",children:[e.jsx("form",{onSubmit:p,className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-rose-700 mb-1",children:"Editar fechas del ciclo"}),e.jsx("p",{className:"text-sm text-slate-600 mb-3",children:"Actualiza las fechas de inicio y fin del ciclo. Guarda los cambios cuando termines."}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"flex flex-col text-sm text-slate-700",children:["Inicio del ciclo",e.jsx("input",{type:"date",value:x,onChange:m=>z(m.target.value),className:"mt-1 rounded-lg border border-rose-200 bg-rose-50/60 px-3 py-2 text-slate-800 focus:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-300"})]}),e.jsxs("label",{className:"flex flex-col text-sm text-slate-700",children:["Fin del ciclo",e.jsx("input",{type:"date",value:I||"",onChange:m=>$(m.target.value),className:"mt-1 rounded-lg border border-rose-200 bg-rose-50/60 px-3 py-2 text-slate-800 focus:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-300"})]})]}),W&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:W}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2 justify-center",children:[e.jsx(C,{type:"button",variant:"outline",onClick:X,className:"border-rose-200 text-rose-600 hover:bg-rose-50",disabled:b,children:"Cancelar"}),e.jsx(C,{type:"submit",className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",disabled:b,children:"Guardar"})]})]})}),e.jsxs("div",{className:"mt-6 border-t border-rose-100 pt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-rose-700 mb-2",children:"Eliminar ciclo"}),e.jsx("p",{className:"text-sm text-slate-600 mb-3",children:"Esta acción no se puede deshacer. Se eliminarán todos los registros asociados."}),e.jsxs(C,{variant:"destructive",onClick:le,disabled:b,className:"w-full sm:w-auto",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"})," Eliminar ciclo"]})]})]}),e.jsx(De,{isOpen:ae,conflictCycle:i,onCancel:ie,onConfirm:k}),!o&&!R&&!n&&e.jsxs("div",{className:"mb-4 flex justify-center gap-4",children:[e.jsxs(C,{onClick:()=>{_(!0),D()},className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:[e.jsx(he,{className:"mr-2 h-4 w-4"})," Gráfica"]}),e.jsxs(C,{onClick:()=>{j(null),v(!0)},className:"bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},disabled:b,children:[e.jsx(Re,{className:"mr-2 h-4 w-4"})," Añadir registro en este ciclo"]})]}),!o&&(R||n)&&e.jsxs("div",{className:n?"fixed inset-0 z-50 h-[100dvh] w-[100dvw] overflow-x-auto overflow-y-auto":"p-4 sm:p-6 mb-4 bg-white/70 backdrop-blur-md ring-1 ring-[#FFB1DD]/50 shadow-2xl rounded-xl relative",style:n?{background:"linear-gradient(135deg, #FFFAFC 0%, #f7eaef 100%)"}:{boxShadow:"0 4px 8px rgba(0,0,0,0.04)"},children:[!n&&e.jsx("h2",{className:"text-xl font-medium text-slate-700 mb-4 bg-white bg-opacity-90 px-4 py-2 rounded-md",children:"Gráfica"}),e.jsx(xe,{data:Q,isFullScreen:n,orientation:L,onToggleIgnore:y,onEdit:J,cycleId:r.id,showInterpretation:c,visibleDays:ee,reduceMotion:!0,forceLandscape:L==="landscape"}),e.jsxs(C,{onClick:P,onTouchEnd:P,variant:"ghost",size:"sm",className:`absolute ${n?"top-4 right-20":"top-2 right-20"} flex items-center font-semibold py-1 px-2 rounded-lg transition-colors ${c?"bg-[#E27DBF] text-white hover:bg-[#d46ab3]":"bg-transparent text-slate-700 hover:bg-[#E27DBF]/20"}`,children:[c?e.jsx(ke,{className:"mr-2 h-4 w-4"}):e.jsx(Se,{className:"mr-2 h-4 w-4"}),c?"Ocultar":"Interpretar"]}),e.jsx(C,{onClick:q,variant:"ghost",size:"icon",className:`absolute ${n?"top-4 right-12 text-white bg-slate-700/50 hover:bg-slate-600/70":"top-2 right-12 text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:"Cambiar orientación",children:e.jsx(we,{className:"h-5 w-5"})}),e.jsx(C,{onClick:()=>{n?(D(),_(!1)):D()},variant:"ghost",size:"icon",className:`absolute ${n?"top-4 right-4 text-white bg-slate-700/50 hover:bg-slate-600/70":"top-2 right-2 text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:n?"Salir de Pantalla Completa":"Ver en Pantalla Completa",children:n?e.jsx(pe,{className:"h-6 w-6"}):e.jsx(Le,{className:"h-5 w-5"})})]}),!n&&e.jsxs(e.Fragment,{children:[e.jsx(ye,{records:r.data,onEdit:J,onDelete:g,isArchiveView:!0,isProcessing:b}),e.jsx(je,{open:o,onOpenChange:m=>{m||(v(!1),j(null))},children:e.jsx(Ee,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(be,{onSubmit:F,initialData:h,onCancel:()=>{v(!1),j(null)},cycleStartDate:r.startDate,cycleEndDate:r.endDate,isProcessing:b,isEditing:!!h,cycleData:r.data})})})]}),e.jsx(ve,{isOpen:!!E,onClose:()=>G(null),onConfirm:te,recordDate:E?K(w(E.isoDate),"dd/MM/yyyy"):"",isProcessing:b})]})},Je=()=>{const{cycleId:r}=ce(),F=de(),{user:d}=ue(),{getCycleById:y,isLoading:n,addOrUpdateDataPoint:D,deleteRecord:L,toggleIgnoreRecord:q,updateCycleDates:c,deleteCycle:f,checkCycleOverlap:P,forceUpdateCycleStart:Q}=Ce(),[o,v]=l.useState(null),{toast:h}=me(),[j,E]=l.useState(null),[G,b]=l.useState(!1),[re,H]=l.useState(null),{isFullScreen:M,toggleFullScreen:V,orientation:Y,rotateScreen:ee}=Oe(),[J,g]=l.useState(!1),[te,R]=l.useState(!1),_=a=>{a.preventDefault(),R(t=>!t)};l.useEffect(()=>{(async()=>{if(d){let t=await y(r);if(!t){const i=localStorage.getItem(`fertilityData_cycle_${d.uid}_${r}`);if(i){const s=JSON.parse(i);t={...s,data:O(s.data||[],s.startDate)}}}t?v(t):(h({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),F("/archived-cycles"))}})()},[r,d,y,h,F]);const B=(a,t)=>{const i=U(w(a)),s=U(w(t));return se(i,s)+1},O=(a,t)=>!a||!Array.isArray(a)||!t?[]:[...a].sort((s,A)=>w(s.isoDate)-w(A.isoDate)).map(s=>({...s,ignored:s.ignored||!1,cycleDay:B(s.isoDate,t)})),x=a=>{if(!d||!a||!a.id)return;const t={...a,data:a.data.map(({cycleDay:i,...s})=>s)};localStorage.setItem(`fertilityData_cycle_${d.uid}_${a.id}`,JSON.stringify(t))},z=async a=>{if(!o||!d)return;const t=!!j;g(!0);try{await D(a,j,o.id);const i=await y(o.id);i&&(x(i),v(i)),h({title:t?"Registro actualizado":"Nuevo registro añadido",description:"Datos para el ciclo actualizados."}),b(!1),E(null)}catch(i){console.error("Error adding/updating data point:",i),h({title:"Error",description:"No se pudo guardar el registro.",variant:"destructive"})}finally{g(!1)}},I=async a=>{if(!(!o||!d)){g(!0);try{await L(a,o.id);const t=await y(o.id);t&&(x(t),v(t)),h({title:"Registro eliminado",description:"El registro ha sido eliminado del ciclo.",variant:"destructive"})}catch(t){console.error("Error deleting record:",t),h({title:"Error",description:"No se pudo eliminar el registro.",variant:"destructive"})}finally{H(null),g(!1)}}},$=(a,t)=>{if(!o||!d||o.id!==a)return;g(!0),q(a,t),v(s=>{if(!s)return null;const A=s.data.map(p=>p.id===t?{...p,ignored:!p.ignored}:p),X=O(A,s.startDate),u={...s,data:X};return x(u),u});const i=o.data.find(s=>s.id===t);h({title:`Registro ${i&&!i.ignored?"despreciado":"restaurado"}`,description:`El registro del ${i?K(w(i.isoDate),"dd/MM/yyyy"):""} ha sido ${i&&!i.ignored?"marcado como despreciado":"restaurado"}.`}),g(!1)},W=async({startDate:a,endDate:t,force:i})=>{if(!o||!d)return!1;g(!0);try{i?(await Q(o.id,a),t!==void 0&&await c(o.id,void 0,t)):await c(o.id,a,t);const s=await y(o.id);return s&&(x(s),v(s)),h({title:"Fechas actualizadas",description:"Las fechas del ciclo han sido modificadas."}),!0}catch(s){return console.error(s),!1}finally{g(!1)}},N=async()=>{if(!(!o||!d)){g(!0);try{await f(o.id),h({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),F("/archived-cycles")}catch(a){console.error(a)}g(!1)}},ae=l.useCallback(()=>{if(!o||!o.startDate)return[];const a=w(o.startDate),t=o.data.reduce((u,p)=>{const k=w(p.isoDate);return k>u?k:u},a),i=o.endDate?w(o.endDate):null;let s;if(i)s=se(U(i),a)+1;else{const u=U(new Date),p=t>u?t:u,k=se(U(p),a);s=Math.max(ne,k+1)}return ge(a,s).map(u=>{const p=o.data.find(k=>k.isoDate===u.isoDate);return p?{...p,date:u.date}:u})},[o]);if(n&&!o||!o)return e.jsx("div",{className:"text-center text-slate-300 p-8",children:"Cargando detalles del ciclo..."});const T=ae();return e.jsxs("div",{className:`min-h-[100dvh] ${M?"":"bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative"}`,children:[!M&&e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:`${M?"":"relative z-10 px-4 py-6"}`,children:e.jsx(ze,{cycleData:o,addOrUpdateDataPointForCycle:z,deleteRecordForCycle:I,toggleIgnoreRecordForCycle:$,isFullScreen:M,toggleFullScreen:V,orientation:Y,rotateScreen:ee,showInterpretation:te,setShowInterpretation:R,onToggleInterpretation:_,chartDisplayData:T,showForm:G,setShowForm:b,editingRecord:j,setEditingRecord:E,recordToDelete:re,setRecordToDelete:H,isProcessing:J,toast:h,onUpdateCycleDates:W,onDeleteCycle:N,checkOverlap:P,cycleId:o.id})})]})};export{Je as default};
