import{c as Kt,m as je,j as e,r as f,l as tt,f as et,n as Qt,g as gt,k as Pt,K as es,q as ts,M as ss,u as ns,N as Lt,B as lt,L as Et,X as as}from"./index-C041RoKp.js";import{b as rs,g as os,i as is,d as ls,D as cs}from"./computePeakStatuses-Dl9gvYQS.js";import{u as ds,C as us,a as fs,b as hs,c as ps}from"./useFertilityChart-Bo-tTrQP.js";import{u as ms,D as xs,a as gs}from"./useCycleData-fUMApAkg.js";import{C as At,S as ys,a as bs,b as ws,d as js,e as Cs}from"./checkbox-DTslPdqR.js";import{L as Ss}from"./label-DmhTYPl7.js";import{A as Is}from"./arrow-left-CEy_h0Do.js";import{E as vs,a as ks}from"./eye-fkTjB7nE.js";import"./input-D9upNPQ0.js";import"./badge-BbO7fxzd.js";const Ms=Kt("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),Ns=Kt("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),Ls=({padding:a,chartWidth:c,chartHeight:p,tempMin:h,tempMax:Q,tempRange:y,getY:z,getX:H,allDataPoints:L=[],responsiveFontSize:m,isFullScreen:re,showLeftLabels:Y=!1,reduceMotion:P=!1,graphBottomY:V,chartAreaHeight:w,rowsZoneHeight:K})=>{const i={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.3,ease:"easeOut"}}},k=[];if(y>0){const E=y<=2.5?.1:.5;for(let j=h;j<=Q+1e-9;j+=E)k.push(parseFloat(j.toFixed(1)))}else for(let E=35.8;E<=37.2+1e-9;E+=.1)k.push(parseFloat(E.toFixed(1)));const B=P?"g":je.g;return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"bgGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fffbfc"}),e.jsx("stop",{offset:"50%",stopColor:"#fff5f7"}),e.jsx("stop",{offset:"100%",stopColor:"#fff1f3"})]}),e.jsxs("linearGradient",{id:"dataZoneGradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fff7fb"}),e.jsx("stop",{offset:"50%",stopColor:"#ffe4f0"}),e.jsx("stop",{offset:"100%",stopColor:"#fff7fb"})]}),e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsxs("filter",{id:"softShadow",children:[e.jsx("feGaussianBlur",{in:"SourceAlpha",stdDeviation:"2"}),e.jsx("feOffset",{dx:"0",dy:"1",result:"offsetblur"}),e.jsx("feComponentTransfer",{children:e.jsx("feFuncA",{type:"linear",slope:"0.2"})}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"pointGlow",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsx("filter",{id:"textShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.8)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]})]}),e.jsx("rect",{x:a.left,y:a.top,width:c-a.left-a.right,height:w,fill:"url(#bgGradientChart)",opacity:2,rx:12,style:{filter:"drop-shadow(0 4px 12px rgba(244, 114, 182, 0.1))"}}),e.jsx("rect",{x:a.left,y:a.top,width:c-a.left-a.right,height:w,fill:"white",stroke:"url(#tempLineGradientChart)",strokeWidth:"1",strokeOpacity:"0.2",rx:"12",style:{filter:"url(#softShadow)"}}),e.jsx("rect",{x:a.left,y:V,width:c-a.left-a.right,height:K,fill:"url(#dataZoneGradient)",rx:"8",style:{filter:"drop-shadow(0 -1px 2px rgba(244, 114, 182, 0.05))"}}),k.map((E,j)=>{const le=z(E),x=E.toFixed(1).endsWith(".0")||E.toFixed(1).endsWith(".5"),ee=x?E.toFixed(1):`.${E.toFixed(1).split(".")[1]}`;return e.jsxs(B,{...P?{}:{variants:i},children:[e.jsx("line",{x1:a.left,y1:le,x2:c-a.right,y2:le,stroke:x?"#f9a8d4":"#fce7f3",strokeWidth:x?1.5:1,opacity:x?.5:.3,strokeDasharray:x?"0":"4,4",style:{filter:x?"drop-shadow(0 1px 3px rgba(244, 114, 182, 0.15))":"none",opacity:x?1:.7}}),Y&&e.jsx("text",{x:a.left-m(1),y:le+m(.35),textAnchor:"end",fontSize:m(x?1.1:1),fontWeight:x?"700":"600",fill:x?"#be185d":"#db2777",opacity:x?.9:.7,style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:ee}),e.jsx("text",{x:c-a.right+m(1),y:le+m(.35),textAnchor:"start",fontSize:m(x?1.1:1),fontWeight:x?"700":"600",fill:x?"#be185d":"#db2777",opacity:x?.9:.7,style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:ee})]},`temp-tick-${j}`)}),L.map((E,j)=>{const le=H(j);return e.jsx("line",{x1:le,y1:a.top,x2:le,y2:V,stroke:"#fce7f3",strokeWidth:"1",opacity:"0.6",style:{filter:"drop-shadow(0 0 1px rgba(244, 114, 182, 0.05))"}},`day-grid-${j}`)}),e.jsx("rect",{x:a.left,y:a.top,width:c-a.left-a.right,height:w,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"2",strokeOpacity:"0.4",rx:"12"}),e.jsx("rect",{x:a.left+1,y:a.top+1,width:c-a.left-a.right-2,height:w-2,fill:"none",stroke:"white",strokeWidth:"0.5",rx:"11",opacity:"0.9"}),Y&&e.jsx(B,{...P?{}:{variants:i},children:e.jsx("text",{x:a.left+m(1.2),y:a.top+m(1.5),textAnchor:"middle",fontSize:m(1.4),fontWeight:"800",fill:"#be185d",style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:"°C"})})]})},Rs=({data:a,allDataPoints:c,getX:p,getY:h,baselineY:Q,temperatureField:y="temperature",reduceMotion:z=!1})=>{if(!a||a.length<2)return null;let H="",L=null;const m=[];if(c.forEach((P,V)=>{const w=a.find(K=>K.id===P.id);if(w&&w[y]!==null&&w[y]!==void 0&&!w.ignored){const K=p(V),i=h(w[y]);m.push({x:K,y:i}),L!==null&&V===L+1?H+=` L ${K} ${i}`:H+=`${H?" ":""}M ${K} ${i}`,L=V}}),m.length<2)return null;const re=H.includes("L"),Y=m.length>1?m.map(({x:P,y:V},w)=>`${w===0?"M":"L"} ${P} ${V}`).join(" "):"";return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsx("filter",{id:"lineShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"3",floodColor:"rgba(244, 114, 182, 0.4)"})})]}),re&&(z?e.jsx("path",{d:H,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"}}):e.jsx(je.path,{d:H,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.4},transition:{duration:.8,ease:"easeInOut",delay:.2}})),Y&&(z?e.jsx("path",{d:Y,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65}):e.jsx(je.path,{d:Y,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.65},transition:{duration:.8,ease:"easeInOut"}})),re&&(z?e.jsx("path",{d:H,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"}}):e.jsx(je.path,{d:H,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1,ease:"easeInOut",delay:.4}}))]})},$t="var(--color-sensacion-fuerte)",Wt="var(--color-apariencia-fuerte)",zt="var(--color-observaciones-fuerte)",Gt="#be123c",Es="rgba(148, 163, 184, 0.35)",As="rgba(226, 232, 240, 0.6)",Ds="rgba(148, 163, 184, 0.5)",Ht="✖",Dt="#7f1d1d",Ot="#ec4899",Ut="drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))",Os="#be185d",Fs="#2563eb",Ts="#be185d",Ps="rgba(244, 114, 182, 0.35)",Bs=a=>{if(!a)return"";const[c,p]=a.split("/");return`${parseInt(c,10)}/${parseInt(p,10)}`},Bt='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',_s=()=>{if(typeof document>"u")return(p,h)=>{const Q=/(\d+(?:\.\d+)?)px/.exec(h||""),y=Q?Number(Q[1]):12;return p.length*y*.6};const c=document.createElement("canvas").getContext("2d");return c?(p,h)=>(c.font=h,c.measureText(p).width):(p,h)=>{const Q=/(\d+(?:\.\d+)?)px/.exec(h||""),y=Q?Number(Q[1]):12;return p.length*y*.6}},$s=(a,c,p)=>`${c} ${a}px ${p}`,Yt=(a="",{maxWidth:c,maxLines:p=2,fontSize:h,fontWeight:Q=700,fontFamily:y=Bt,fallback:z="–",measureTextWidth:H})=>{if(!a)return[z,...Array.from({length:Math.max(0,p-1)},()=>"")];const L=$s(h,Q,y),m=i=>H(i,L),re=String(a).trim(),Y=/\s/.test(re),P=Y?re.split(/\s+/):Array.from(re),V=Y?" ":"",w=[],K=i=>{const k=Array.from(i);let B="";for(;k.length;){const E=B+k[0];if(m(E)<=c||!B){if(B=E,k.shift(),m(B)>c&&B.length>1){k.unshift(...Array.from(B.slice(1))),B=B[0];break}}else break}return[B,k.join("")]};for(;P.length&&w.length<p;){let i="";for(;P.length;){const k=P[0],B=i?`${i}${V}${k}`:k;if(m(B)<=c){i=B,P.shift();continue}if(!i)if(Y){const[E,j]=K(k);i=E,j?P[0]=j:P.shift()}else{const[E,j]=K(k);i=E,j?P[0]=j:P.shift()}break}w.push(i),!i&&P.length&&w.push(P.shift())}if(P.length&&w.length){const i=w.length-1;let k=w[i]||"";for(;k&&m(`${k}…`)>c;)k=k.slice(0,-1);w[i]=k?`${k}…`:"…"}for(;w.length<p;)w.push("");return w};function Ft(a="",c,p="–"){return a?a.split(/\s+/).slice(0,c).join(" "):p}const Ws=({data:a,getX:c,getY:p,isFullScreen:h,orientation:Q,responsiveFontSize:y,onPointInteraction:z,clearActivePoint:H,activePoint:L,padding:m,chartHeight:re,chartWidth:Y,temperatureField:P="temperature_chart",textRowHeight:V,compact:w=!1,reduceMotion:K=!1,showInterpretation:i=!1,ovulationDetails:k=null,firstHighIndex:B=null,baselineIndices:E=[],graphBottomLift:j=0,graphBottomY:le,rowsZoneHeight:x,showRelationsRow:ee=!1})=>{const ne={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},he={hidden:{opacity:0,scale:.3},visible:{opacity:1,scale:1,transition:{duration:.6,ease:[.34,1.56,.64,1],type:"spring",stiffness:120,damping:12}}},u=le,de=h?9:7.5,st=h?1:.75,De=ee?de+(h?2:1.5):null,ve=de+st,A=Math.max(1,Math.floor(x/ve)),te=Math.max(V,A),be=u+te*1,ae=u+te*2,Oe=u+te*3,bt=u+te*(h?5:4.5),Fe=u+te*(h?7:6),ke=u+te*(h?9:7.5),Me=ee?ke+te*(h?2:1.5):null,ct=Y-m.left-m.right,nt=te*(h?2:1.5),wt=Math.min(Math.max(nt*.46,14),12),_=K?"g":je.g,D=Array.isArray(a)?a.length:0,at=f.useMemo(()=>tt(new Date),[]),Te=f.useMemo(()=>_s(),[]),Pe=f.useMemo(()=>{if(!i)return new Map;const l=Array.isArray(k?.highSequenceIndices)?k.highSequenceIndices:[],g=new Map;return l.forEach((d,$)=>{const se=Number(d);Number.isInteger(se)&&se>=0&&se<D&&!g.has(se)&&g.set(se,$+1)}),g},[i,k,D]),ue=f.useMemo(()=>{if(!i)return new Map;const l=Array.isArray(E)?E:[];if(!l.length)return new Map;const g=new Set,d=[],$=X=>{const fe=Number(X);Number.isInteger(fe)&&fe>=0&&fe<D&&!g.has(fe)&&(g.add(fe),d.push(fe))};if(l.forEach(X=>{$(X)}),B!=null){const X=Number(B);Number.isInteger(X)&&$(X-1)}if(!d.length)return new Map;const se=[...d].sort((X,fe)=>X-fe),we=new Map;let me=1;for(let X=se.length-1;X>=0&&!(me>6);X-=1)we.set(se[X],me),me+=1;return we},[i,E,D,B]);return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsx("filter",{id:"rowShadowChart",x:"-10%",y:"-10%",width:"120%",height:"120%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"4",floodColor:"rgba(244, 114, 182, 0.2)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#fb7185"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"pointGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("radialGradient",{id:"tempPointGradientChart",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FDF2F8"}),e.jsx("stop",{offset:"50%",stopColor:"#F9A8D4"}),e.jsx("stop",{offset:"85%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#DB2777"})]}),e.jsxs("radialGradient",{id:"tempPointIgnoredGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFFFFF"}),e.jsx("stop",{offset:"80%",stopColor:"#F8FAFC"}),e.jsx("stop",{offset:"100%",stopColor:"#E2E8F0"})]}),e.jsxs("radialGradient",{id:"ovulationPointGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#dbeafe"}),e.jsx("stop",{offset:"50%",stopColor:"#93c5fd"}),e.jsx("stop",{offset:"85%",stopColor:"#3b82f6"}),e.jsx("stop",{offset:"100%",stopColor:"#2563eb"})]})]}),h&&Q!=="portrait"&&e.jsx(je.g,{variants:ne,children:[{label:"Fecha",row:1,color:h?"#374151":"#6B7280"},{label:"Día",row:2,color:h?"#374151":"#6B7280"},{label:"Símbolo",row:3,color:h?"#374151":"#6B7280"},{label:"Sens.",row:h?5:4.5,color:$t},{label:"Apar.",row:h?7:6,color:Wt},{label:"Observ.",row:h?9:7.5,color:zt},...ee&&De!=null?[{label:"RS",row:De,color:Gt}]:[]].map(({label:l,row:g,color:d})=>e.jsx("text",{x:m.left-y(.5),y:u+te*g,textAnchor:"end",fontSize:y(1.05),fontWeight:"700",fill:d,style:{filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:l},l))}),a.map((l,g)=>{const d=c(g),$=l[P]!=null?p(l[P]):u,se=l.temperature_raw,we=l.temperature_corrected,me=l.use_corrected&&se!=null&&we!=null&&Math.abs(we-se)>.01,X=me?p(se):null,fe="#60666f",Be=l[P]!=null,Ce=!!(l.had_relations??l.hadRelations);Be||l.mucus_sensation||l.mucus_appearance||l.fertility_symbol;const _e=String(l.id||"").startsWith("placeholder-"),rt=k?.peakDayIndex,pe=i&&rt!=null&&!l.ignored&&Be&&g===rt,$e=rs(l.fertility_symbol),Xe=os($e.value),Ne=$e.pattern==="spotting-pattern"?"url(#spotting-pattern-chart)":Xe.main,Ge=Xe.border==="none"?"none":Xe.border||Ps,jt=Xe.border==="none"?0:$e.value==="white"?1.6:1,xe=l.isoDate?is(tt(et(l.isoDate)),tt(new Date)):!1,J=y(h?1.8:2),He=Oe-J*.75+J/2+2,oe=l.peakStatus?String(l.peakStatus).toUpperCase():null,ie=oe==="P"||oe==="X",Le=oe&&!ie,dt=ie?Ht:oe||"–",Re=ie||["1","2","3"].includes(oe),ge=!_e&&$e.value!=="none",Je=!!l.isoDate&&!xe?{pointerEvents:"all",style:{cursor:"pointer"},onClick:ze=>z(l,g,ze)}:{},Ye=(l.isoDate?ls(et(l.isoDate),at):!1)?Ts:fe,F=Pe.has(g),Ze=F?Pe.get(g):null,Ve=ue.has(g),qe=Ve?ue.get(g):null,Ee=y(h?.75:1.2),ot=Math.max(.5,Ee*.18),Ct=$-Ee*(h?2.6:1.8),St=$+Ee*(h?1.9:1.6),Qe=D>0?ct/D:ct,We=2,ft=Math.min(12,Math.max(4,Qe*.12)),it=Math.max(0,Qe-ft*2),Se=y(.95),It=y(.9),Ie=y(.9),vt=y(.9),ht=y(.8),t=y(.8),n=y(.8),s=(ze,xt,Nt,kt)=>{const _t=Yt(ze,{maxWidth:it,maxLines:3,fontSize:Nt,fontWeight:700,fontFamily:Bt,fallback:xt,measureTextWidth:Te});return _t[2]?{lines:Yt(ze,{maxWidth:it,maxLines:3,fontSize:kt,fontWeight:700,fontFamily:Bt,fallback:xt,measureTextWidth:Te}),fontSize:kt}:{lines:_t,fontSize:Nt}},r=h?Ft(l.mucus_sensation,We,xe?"":"–"):l.mucus_sensation,o=h?Ft(l.mucus_appearance,We,xe?"":"–"):l.mucus_appearance,v=h?Ft(l.observations,We,""):l.observations,T=s(r,xe?"":"–",It,ht),b=s(o,xe?"":"–",Ie,t),U=s(v,"",vt,n),[S,M,I]=T.lines,[G,C,R]=b.lines,[O,N,Z]=U.lines,q=T.fontSize,W=b.fontSize,ye=U.fontSize,ce=(ze,xt,Nt)=>Math.max(1,[ze,xt,Nt].filter(kt=>kt&&String(kt).trim()!=="").length),pt=ce(S,M,I),Ae=ce(G,C,R),Ke=ce(O,N,Z),mt=(ze,xt)=>ze-(xt-1)*Se/2,Xt=mt(bt,pt),Jt=mt(Fe,Ae),Zt=mt(ke,Ke);return e.jsxs(_,{...K?{}:{variants:ne},...Je,children:[Be&&e.jsxs(_,{...K?{}:{variants:he},children:[me&&X!==null&&e.jsxs("g",{pointerEvents:"none",children:[e.jsx("line",{x1:d,y1:X,x2:d,y2:$,stroke:Es,strokeWidth:1,strokeDasharray:"4 4"}),e.jsx("circle",{cx:d,cy:X,r:3,fill:As,stroke:Ds,strokeWidth:1}),e.jsx("circle",{cx:d,cy:X,r:1,fill:"rgba(255, 255, 255, 0.6)"})]}),e.jsx("circle",{cx:d,cy:$,r:pe?3.5:2.8,fill:l.ignored?"url(#tempPointIgnoredGradient)":pe?"url(#ovulationPointGradient)":"url(#tempPointGradientChart)",stroke:l.use_corrected?"#941616":l.ignored?"#94A3B8":pe?"#1d4ed8":"#E91E63",strokeWidth:l.ignored?1.5:pe?2.2:2,style:{filter:pe?"drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3))":"drop-shadow(0 2px 3px rgba(244, 114, 182, 0.25))",cursor:"pointer"},pointerEvents:"all",onClick:ze=>z(l,g,ze)}),!l.ignored&&e.jsx("circle",{cx:d,cy:$,r:pe?1.2:.9,fill:pe?"rgba(239, 246, 255, 0.95)":"rgba(255, 255, 255, 0.9)",style:{filter:pe?"drop-shadow(0 1px 3px rgba(37, 99, 235, 0.45))":"drop-shadow(0 1px 2px rgba(244, 114, 182, 0.3))"}}),i&&Be&&!l.ignored&&F&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:d,y:Ct,textAnchor:"middle",fontSize:Ee,fontWeight:"900",fill:Os,strokeWidth:ot,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Ze})}),i&&Be&&!l.ignored&&Ve&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:d,y:St,textAnchor:"middle",fontSize:Ee,fontWeight:"800",fill:Fs,stroke:"#ffffff",strokeWidth:ot,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.85))"},children:qe})})]}),e.jsx("text",{x:d,y:be,textAnchor:"middle",fontSize:y(1.05),fontWeight:"900",fill:Ye,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Bs(l.date)}),e.jsx("text",{x:d,y:ae,textAnchor:"middle",fontSize:y(1),fontWeight:"900",fill:Ye,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:l.cycleDay}),ge?e.jsxs("g",{children:[e.jsx("rect",{x:d-J/2+1,y:Oe-J*.75+1,width:J,height:J,fill:"rgba(0, 0, 0, 0.1)",rx:J*.3,opacity:.5}),e.jsx("rect",{x:d-J/2-4,y:Oe-J*.75,width:J*1.4,height:J,fill:Ne,stroke:Ge,strokeWidth:jt,rx:J*.2,style:{filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.25))"}}),oe&&e.jsx("g",{pointerEvents:"none",children:ie?e.jsx("text",{x:d,y:He,textAnchor:"middle",fontSize:y(1.35),fontWeight:"900",fill:Ot,stroke:"#fff",strokeWidth:1.5,paintOrder:"stroke",style:{filter:Ut},children:Ht}):e.jsx("text",{x:d,y:He,textAnchor:"middle",fontSize:y(oe?1.1:1),fontWeight:"800",fill:Dt,style:{filter:"drop-shadow(0 1px 1px rgba(255,255,255,0.9))"},children:oe})})]}):e.jsxs("g",{children:[Re&&e.jsx("rect",{x:d-J/2-4,y:Oe-J*.75,width:J*1.4,height:J,fill:"transparent",stroke:ie?Ot:Dt,strokeWidth:1,rx:J*.2}),e.jsx("text",{x:d,y:He,textAnchor:"middle",fontSize:y(ie?1.35:Le?1.1:1),fill:ie?Ot:Le?Dt:fe,fontWeight:ie?"900":Le?"800":"500",style:{filter:ie?Ut:Le?"drop-shadow(0 1px 1px rgba(255,255,255,0.9))":"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:dt})]}),!w&&e.jsxs("text",{x:d,y:Xt,textAnchor:"middle",fontSize:q,fontWeight:"700",fill:$t,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x:d,dy:0,children:S}),M&&e.jsx("tspan",{x:d,dy:Se,children:M}),I&&e.jsx("tspan",{x:d,dy:Se,children:I})]}),!w&&e.jsxs("text",{x:d,y:Jt,textAnchor:"middle",fontSize:W,fontWeight:"700",fill:Wt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x:d,dy:0,children:G}),C&&e.jsx("tspan",{x:d,dy:Se,children:C}),R&&e.jsx("tspan",{x:d,dy:Se,children:R})]}),!w&&e.jsxs("text",{x:d,y:Zt,textAnchor:"middle",fontSize:ye,fontWeight:"700",fill:zt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x:d,dy:0,children:O}),N&&e.jsx("tspan",{x:d,dy:Se,children:N}),Z&&e.jsx("tspan",{x:d,dy:Se,children:Z})]}),ee&&Me!=null&&e.jsx("text",{x:d,y:Me,textAnchor:"middle",fontSize:wt,fontWeight:"700",fill:Ce?Gt:"transparent","aria-label":Ce?`Relación registrada el ${l.isoDate||`día ${g+1}`}`:void 0,children:Ce?"❤":""})]},`pt-${g}-${l.isoDate||l.timestamp}`)})]})},zs="var(--color-sensacion-fuerte)",Gs="var(--color-apariencia-fuerte)",Hs="var(--color-observaciones-fuerte)",Us=({padding:a,chartHeight:c,tempMin:p,tempMax:h,tempRange:Q,getY:y,responsiveFontSize:z,textRowHeight:H,isFullScreen:L,graphBottomY:m,rowsZoneHeight:re,showRelationsRow:Y=!1})=>{const P={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},V=[];if(Q>0){const x=Q<=2.5?.1:.5;for(let ee=p;ee<=h+1e-9;ee+=x)V.push(parseFloat(ee.toFixed(1)))}else for(let x=35.8;x<=37.2+1e-9;x+=.1)V.push(parseFloat(x.toFixed(1)));const w=m,K=L?9:7.5,i=L?1:.75,k=Y?K+(L?2:1.5):null,B=K+i,E=Math.max(1,Math.floor(re/B)),j=Math.max(H,E),le=f.useMemo(()=>{const x=[{label:"Fecha",row:1,color:"#374151",icon:null},{label:"Día",row:2,color:"#374151",icon:null},{label:"Símbolo",row:3,color:"#374151",icon:null},{label:"Sens.",row:L?5:4.5,color:zs,icon:"◊"},{label:"Apar.",row:L?7:6,color:Gs,icon:"○"},{label:"Obs.",row:L?9:7.5,color:Hs,icon:"✦"}];return Y&&k!=null&&x.push({label:"RS",row:k,color:"#f44336",icon:"♥"}),x},[L,k,Y]);return e.jsxs("svg",{width:a.left,height:c,className:"font-sans pointer-events-none",children:[e.jsx("defs",{children:e.jsx("filter",{id:"textShadowLegend",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.9)"})})}),V.map((x,ee)=>{const ne=y(x),he=x.toFixed(1).endsWith(".0")||x.toFixed(1).endsWith(".5"),u=he?x.toFixed(1):`.${x.toFixed(1).split(".")[1]}`;return e.jsx(je.g,{variants:P,children:e.jsx("text",{x:a.left-z(1.2),y:ne+z(.35),textAnchor:"end",fontSize:z(he?1.15:1),fontWeight:he?"800":"700",fill:he?"#be185d":"#db2777",opacity:he?1:.85,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:u})},`temp-tick-fixed-${ee}`)}),e.jsx(je.g,{variants:P,children:le.map(({label:x,row:ee,color:ne,icon:he})=>e.jsxs("g",{children:[he&&e.jsx("text",{x:a.left-z(2.8),y:w+j*ee,textAnchor:"middle",fontSize:z(.8),fontWeight:"600",fill:ne,opacity:.7,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:he}),e.jsx("text",{x:a.left-z(.8),y:w+j*ee,textAnchor:"end",fontSize:z(1.05),fontWeight:"800",fill:ne,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:x})]},x))})]})},Ys=({data:a,isFullScreen:c,orientation:p,onToggleIgnore:h,onEdit:Q,onTogglePeak:y,cycleId:z,initialScrollIndex:H=0,visibleDays:L=5,showInterpretation:m=!1,reduceMotion:re=!1,forceLandscape:Y=!1,currentPeakIsoDate:P=null,showRelationsRow:V=!1,fertilityStartConfig:w=null,fertilityCalculatorCycles:K=[],fertilityCalculatorCandidates:i=null,onShowPhaseInfo:k=null,isArchivedCycle:B=!1,cycleEndDate:E=null})=>{const{chartRef:j,tooltipRef:le,dimensions:x,activePoint:ee,activeIndex:ne,tooltipPosition:he,allDataPoints:u,validDataForLine:de,tempMin:st,tempMax:De,tempRange:ve,padding:A,textRowHeight:te,getY:be,getX:ae,handlePointInteraction:Oe,handleToggleIgnore:bt,responsiveFontSize:Fe,clearActivePoint:ke,baselineTemp:Me,baselineStartIndex:ct,baselineIndices:nt,firstHighIndex:wt,ovulationDetails:_,fertilityStart:D,hasAnyObservation:at,graphBottomInset:Te,todayIndex:Pe}=ds(a,c,p,h,z,L,Y,w,K,i,V),ue=f.useRef(null);if(!ue.current){const t=Math.random().toString(36).slice(2,10);ue.current=`fertility-chart-${z??"default"}-${t}`}const l=ue.current;if(!u||u.length===0)return e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-pink-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),e.jsx("p",{className:"text-slate-400 font-medium",children:"No hay datos para mostrar en el gráfico"})]});const g=x.width,d=x.contentHeight??x.height,$=x.scrollableContentHeight??d,se=d-A.bottom-(Te||0),we=Math.max(d-se,0),me=Me!=null?be(Me):null,X=!!_?.confirmed,fe=Me!=null&&X,Be=ae(0),Ce=u.length>0?ae(u.length-1):g-A.right,_e=X?"#F59E0B":"#94A3B8",rt=X?"6 4":"4 4",pe=X?1:.7,$e=3,Xe=g===0,Ne=ne!=null?ae(ne):null,Ge=ne!=null?ne>0?ae(ne-1):Ne:null,jt=ne!=null?ne<u.length-1?ae(ne+1):Ne:null,xe=Math.max((g-A.left-A.right)/Math.max(u.length,1),0),J=ne!=null?Math.max((jt!=null&&Ge!=null?jt-Ge:0)||xe,xe,0):0,He=f.useMemo(()=>{const t=new Map;return de.forEach(n=>{n&&n.id!=null&&t.set(n.id,n)}),t},[de]),oe=f.useMemo(()=>Number.isInteger(D?.fertileStartFinalIndex)?D.fertileStartFinalIndex:null,[D]),ie=Math.max(d-A.top-A.bottom-(Te||0),0),Le=f.useCallback(t=>!Number.isFinite(t)||!u.length||t<=0?A.left:ae(t),[u,ae,A.left]),dt=f.useCallback(t=>!Number.isFinite(t)||!u.length||t>=u.length-1?g-A.right:ae(t+1),[u,g,ae,A.right]),Re=f.useCallback((t,n,{inclusiveEnd:s=!0}={})=>{if(!Number.isFinite(t)||!Number.isFinite(n)||u.length===0)return null;const r=I=>Math.max(0,Math.min(u.length-1,Math.floor(I))),o=I=>Math.max(0,Math.min(u.length-1,Math.floor(I))),v=I=>Math.max(0,Math.min(u.length,Math.floor(I))),T=r(t),b=s?o(n):v(n),U=T<=0?A.left:Le(T);let S;s?S=b>=u.length-1?g-A.right:dt(b):b<=0?S=A.left:b>=u.length?S=g-A.right:S=Le(b);const M=Math.max(S-U,0);return M<=0?null:{x:U,width:M}},[u,g,Le,dt,A.left,A.right]),ge=u.length>0?u.length-1:null,ut=f.useMemo(()=>{if(!B||!E||ge==null)return null;const t=typeof E=="string"?E:null;if(!t)return null;const n=u.findIndex(s=>s?.isoDate===t);if(n>=0)return Math.min(n,ge);for(let s=u.length-1;s>=0;s-=1){const r=u[s]?.isoDate;if(typeof r=="string"&&r<=t)return Math.min(s,ge)}return null},[B,E,u,ge]),Je=f.useMemo(()=>ge==null?null:B?Number.isInteger(ut)?Math.min(ut,ge):ge:Number.isInteger(Pe)?Math.min(Pe,ge):ge,[ut,B,Pe,ge]),Ue=ie>0?A.top+ie*.5:null,Ye=Ue!=null?Math.max(se-Ue,0):0,F=f.useMemo(()=>{if(!m||!at)return null;const t=D?.debug,n=Number.isInteger(t?.mucusInfertileStartIndex)?t.mucusInfertileStartIndex:null,s=Number.isInteger(D?.fertileWindow?.temperatureInfertileStartIndex)?D.fertileWindow.temperatureInfertileStartIndex:null,r=[n,s].filter(Ae=>Number.isInteger(Ae)).sort((Ae,Ke)=>Ae-Ke)[0],o=Number.isInteger(r)?r:Number.isInteger(t?.postOvulatoryStartIndex)?t.postOvulatoryStartIndex:null,v=Number.isInteger(n)&&Number.isInteger(s)?Math.max(n,s):null,T=Number.isInteger(v)?v:Number.isInteger(t?.absoluteStartIndex)?t.absoluteStartIndex:null,b={confirmed:!!_?.confirmed,rule:_?.rule??null,baselineTemp:_?.baselineTemp??null,baselineIndices:Array.isArray(_?.baselineIndices)?_.baselineIndices:[],firstHighIndex:Number.isInteger(_?.firstHighIndex)?_.firstHighIndex:null,highSequenceIndices:Array.isArray(_?.highSequenceIndices)?_.highSequenceIndices:[],confirmationIndex:Number.isInteger(_?.confirmationIndex)?_.confirmationIndex:null,startIndex:s},U={peakDayIndex:Number.isInteger(_?.peakDayIndex)?_.peakDayIndex:null,thirdDayIndex:Number.isInteger(_?.thirdDayIndex)?_.thirdDayIndex:null,startIndex:n},S=s!=null,M=n!=null;if(!S&&!M)return null;const I=Number.isInteger(o)?o:null;if(I==null)return null;let G="pending",C="",R="Infertilidad postovulatoria",O="Fase postovulatoria: se ha cumplido un criterio de cierre; falta el segundo para confirmar la infertilidad absoluta.";const N="Infertilidad absoluta",Z="Fase postovulatoria alcanzada (se ha confirmado día pico y subida de temperatura).",q="Confirmación completa: doble criterio (día pico + temperatura).";let W=R,ye=O,ce=C,pt="pending";return S&&M?(G="absolute",R=N,O=q,C=Z,Number.isInteger(s)&&(!Number.isInteger(n)||s<=n)?(b.rule,ce=`Temperatura confirmada el ${b.confirmationIndex!=null?`D${b.confirmationIndex+1}`:"—"}. A la espera de determinación del día pico.`,ye=ce,W="Infertilidad estimada por temperatura"):(ce=`Alcanzado ${U.thirdDayIndex!=null?"3° día postpico":"4º día postpico"} tras alcanzar día pico el ${U.peakDayIndex+1} del ciclo`,ye=ce,W="Infertilidad estimada por moco")):S?(b.rule,C=`Temperatura confirmada el ${b.confirmationIndex!=null?`D${b.confirmationIndex+1}`:"—"}. A la espera de determinación del día pico.`,O=C,R="Infertilidad estimada por temperatura",ce=C,ye=O,W=R):(C=`Alcanzado ${U.thirdDayIndex!=null?"3° día postpico":"4º día postpico"} tras seleccionar día pico el ${U.peakDayIndex+1} del ciclo`,O=C,R="Infertilidad estimada por moco",ce=C,ye=O,W=R),{phase:"postOvulatory",status:G,startIndex:I,absoluteStartIndex:T,estimated:{status:pt,label:W,tooltip:ye,message:ce},absolute:{label:N,tooltip:q,message:Z},reasons:{type:"post",status:G,mucus:U,temperature:b},message:C,label:R,tooltip:O}},[m,at,_,D]),Ze=f.useMemo(()=>{if(!m||ie<=0||Ue==null||Ye<=0||u.length===0)return[];const t=[],n=u.length-1,s=Number.isInteger(Je)&&Je>=0?Math.min(Je,n):n,r=(M,I)=>{if(!F)return;const G=F.startIndex,C=Number.isInteger(F.absoluteStartIndex)?F.absoluteStartIndex:null,R=F.estimated??F,O=F.absolute??F,N=C??G,Z=F.status==="absolute"?n:Math.min(n,I);if(C!=null&&C>G){const q=Math.min(C-1,I),W=Re(G,q);W&&M.push({key:"post-pending",phase:"postOvulatory",status:R.status??"pending",bounds:W,startIndex:G,endIndex:q,displayLabel:R.label,tooltip:R.tooltip,message:R.message,reasons:F.reasons})}if(N<=Z){const q=Re(N,Z);q&&M.push({key:"post-absolute",phase:"postOvulatory",status:C!=null?"absolute":F.status,bounds:q,startIndex:N,endIndex:Z,displayLabel:C!=null?O.label:F.label,tooltip:C!=null?O.tooltip:F.tooltip,message:C!=null?O.message:F.message,reasons:F.reasons})}},o=Number.isInteger(oe),v=Number.isFinite(F?.startIndex);if(!o&&!v){const M=Math.min(s,n);if(M<0)return t;const I=Re(0,M);return I&&t.push({key:"relative-default",phase:"relativeInfertile",status:"default",bounds:I,startIndex:0,endIndex:M,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (preovulatoria: sin día fértil por CPM/T-8 ni signos de moco fértil)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:null,aggregate:D?.aggregate??null,bipScore:D?.debug?.bipScore??null}}),t}if(!o&&v){const M=F.startIndex,I=Math.min(M-1,s);if(I>=0){const G=Re(0,I);G&&t.push({key:"no-fertile-window",phase:"nodata",status:"no-fertile-window",bounds:G,startIndex:0,endIndex:I,displayLabel:"Sin ventana fértil identificable",tooltip:"Sin ventana fértil identificable",message:"Sin ventana fértil identificable",reasons:{type:"nofertile",status:"no-fertile-window",message:"No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."}})}return Number.isFinite(F.startIndex)&&F.startIndex<=n&&r(t,s),t}if(o&&oe>0){const M=Math.min(oe-1,s);if(M>=0){const I=Re(0,M);I&&t.push({key:"relative",phase:"relativeInfertile",status:"default",bounds:I,startIndex:0,endIndex:M,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (fase relativamente infértil preovulatoria)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:oe,aggregate:D?.aggregate??null,bipScore:D?.debug?.bipScore??null}})}}const T=o?Math.max(oe,0):0,b=F?.startIndex,U=Number.isFinite(b)&&b!=null?Math.min(b-1,n):n,S=Math.min(U,s);if(S>=T){const M=Re(T,S);if(M){const I=Number.isInteger(D?.debug?.explicitStartDay)?D.debug.explicitStartDay:null,G=D?.aggregate?.usedCandidates??[],C=G.some(N=>N?.kind==="profile"),R=G.some(N=>N?.kind==="calculator");let O=null;o&&I!=null&&I===oe?O="marker":C?O="profiles":R&&(O="calculator"),t.push({key:"fertile",phase:"fertile",status:"default",bounds:M,startIndex:T,endIndex:S,displayLabel:"Fértil",tooltip:"Fértil",message:"Fértil",reasons:{type:"fertile",startIndex:T,endIndex:S,source:O,details:D?.debug??null,notes:D?.aggregate?.notes??[],statusSummary:D?.currentAssessment??null,dailyAssessments:D?.dailyAssessments??[],window:D?.fertileWindow??null,aggregate:D?.aggregate??null}})}}return F&&Number.isFinite(F.startIndex)&&F.startIndex<=n&&r(t,s),t},[m,ie,Ue,Ye,u.length,oe,D,F,at,Re,Je]),Ve=`${l}-phase-relative-gradient`,qe=`${l}-phase-fertile-gradient`,Ee=`${l}-phase-post-pending-gradient`,ot=`${l}-phase-post-absolute-gradient`,Ct=t=>t.phase==="relativeInfertile"?"#065F46":t.phase==="fertile"?"#9D174D":t.phase==="postOvulatory"?t.status==="pending"?"#075985":"#1E3A8A":t.phase==="nodata"?"#475569":"hsl(var(--foreground))",St="0 1px 1px var(--phase-text-shadow, rgba(15, 23, 42, 0.2))",Qe=f.useMemo(()=>{if(!m||!_?.confirmed)return null;const t=Array.isArray(_?.highSequenceIndices)?_.highSequenceIndices:[];if(t.length<2)return null;const n=t.map(s=>{if(s==null||s<0||s>=u.length)return null;const r=u[s],o=He.get(r?.id);return!o||!Number.isFinite(o.displayTemperature)?null:{x:ae(s),y:be(o.displayTemperature)}}).filter(Boolean);return n.length<2?null:n.map(({x:s,y:r},o)=>`${o===0?"M":"L"} ${s} ${r}`).join(" ")},[m,_,u,He,ae,be]),[We,ft]=f.useState({w:typeof window<"u"?window.innerWidth:0,h:typeof window<"u"?window.innerHeight:0}),it=We.w<We.h;f.useEffect(()=>{const t=()=>ft({w:window.innerWidth,h:window.innerHeight});return window.addEventListener("resize",t),window.addEventListener("orientationchange",t),()=>{window.removeEventListener("resize",t),window.removeEventListener("orientationchange",t)}},[]),f.useEffect(()=>{if(!j.current)return;const t=j.current.clientWidth/L;j.current.scrollLeft=Math.max(0,t*H)},[H,L,x.width,p]);const Se=c&&Y&&it,It=Se,Ie="w-full h-full bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",vt=c?`${Ie} h-full ${It?"overflow-y-auto overflow-x-auto":"overflow-x-auto overflow-y-auto"}`:`${Ie} overflow-x-auto overflow-y-visible border border-pink-100/50`,ht=!c||p==="portrait";return e.jsx(je.div,{className:"relative w-full h-full",initial:!1,children:e.jsxs(je.div,{ref:j,className:`relative p-0 ${c?"":"rounded-2xl"} ${vt}`,style:{touchAction:"auto",boxShadow:c?"inset 0 1px 3px rgba(244, 114, 182, 0.1)":"0 8px 32px rgba(244, 114, 182, 0.12), 0 2px 8px rgba(244, 114, 182, 0.08)",...Se?{position:"absolute",top:"50%",left:"50%",width:`${We.h}px`,height:`${We.w}px`,transform:"translate(-50%, -50%) rotate(90deg)",transformOrigin:"center center"}:{}},initial:!1,children:[Xe&&e.jsx("div",{className:"flex items-center justify-center w-full h-full text-slate-400",children:"Cargando..."}),e.jsx("div",{className:"inline-block",style:{width:g,height:d},children:e.jsx("div",{className:"relative h-full overflow-y-auto",style:{height:d,maxHeight:$},children:e.jsxs("div",{className:"relative",style:{width:g,height:$},children:[ht&&e.jsx("div",{className:"absolute left-0 top-0 h-full bg-transparent pointer-events-none z-10",style:{width:A.left},children:e.jsx(Us,{padding:A,chartHeight:$,tempMin:st,tempMax:De,tempRange:ve,getY:be,responsiveFontSize:Fe,textRowHeight:te,isFullScreen:c,graphBottomY:se,rowsZoneHeight:we,showRelationsRow:V})}),e.jsxs(je.svg,{width:g,height:$,className:"font-sans flex-shrink-0",viewBox:`0 0 ${g} ${$}`,preserveAspectRatio:"xMidYMid meet",initial:!1,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#F472B6"}),e.jsx("stop",{offset:"50%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#E91E63"})]}),e.jsxs("linearGradient",{id:"tempAreaGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(244, 114, 182, 0.18)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(244, 114, 182, 0.02)"})]}),e.jsxs("linearGradient",{id:Ve,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-rel)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-rel)",stopOpacity:"var(--phase-rel-stop, 0.28)"})]}),e.jsxs("linearGradient",{id:qe,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-fertile)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-fertile)",stopOpacity:"var(--phase-fertile-stop, 0.27)"})]}),e.jsxs("linearGradient",{id:Ee,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post)",stopOpacity:"var(--phase-post-stop, 0.45)"})]}),e.jsxs("linearGradient",{id:ot,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post-abs)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post-abs)",stopOpacity:"var(--phase-post-abs-stop, 0.7)"})]}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"chartShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"baselineGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("rect",{width:"100%",height:"100%",fill:"transparent"}),e.jsx(Ls,{padding:A,chartWidth:g,chartHeight:d,tempMin:st,tempMax:De,tempRange:ve,getY:be,getX:ae,allDataPoints:u,responsiveFontSize:Fe,isFullScreen:c,showLeftLabels:!ht,reduceMotion:re,graphBottomY:se,chartAreaHeight:Math.max(d-A.top-A.bottom-(Te||0),0),rowsZoneHeight:we}),m&&Ze.length>0&&Ue!=null&&Ye>0&&e.jsx("g",{children:Ze.map(t=>{const n=Ue,s=Ye,o=t.phase==="postOvulatory"?t.status==="pending"?`url(#${Ee})`:`url(#${ot})`:t.phase==="relativeInfertile"?`url(#${Ve})`:t.phase==="fertile"?`url(#${qe})`:t.phase==="nodata"?"rgba(203, 213, 225, 0.2)":`url(#${qe})`,v=c?14:13,T=Math.max(Fe(1.1),v),b=t.bounds.width<120,U=Math.max(t.bounds.width-16,0),S=Math.max(T*.58,1),M=Math.max(1,Math.floor(U/S)),I=t.tooltip??t.displayLabel??t.message??"";let G=t.displayLabel??t.message??"";if(b&&G.length>M){const W=Math.max(M-1,1);G=`${G.slice(0,W).trimEnd()}${G.length>W?"…":""}`}const C=b?t.bounds.x+8:t.bounds.x+t.bounds.width/2,R=b?"start":"middle",O=n+s/2,N=Ct(t),Z=W=>{typeof W?.stopPropagation=="function"&&W.stopPropagation(),typeof k=="function"&&k({phase:t.phase,status:t.status,reasons:t.reasons,message:t.message,startIndex:t.startIndex,endIndex:t.endIndex,label:t.displayLabel??t.message??null})},q=W=>{(W.key==="Enter"||W.key===" ")&&(W.preventDefault(),Z(W))};return e.jsxs("g",{children:[e.jsx("rect",{x:t.bounds.x,y:n,width:t.bounds.width,height:s,fill:o,pointerEvents:"none"}),e.jsxs("text",{x:C,y:O,fill:N,fontSize:T,fontWeight:600,dominantBaseline:"middle",textAnchor:R,role:"button","aria-label":I,tabIndex:0,onClick:Z,onKeyDown:q,style:{cursor:"pointer",userSelect:"none",lineHeight:1.2,textShadow:St},pointerEvents:"auto",children:[e.jsx("title",{children:I}),G]})]},t.key)})}),m&&fe&&me!==null&&(re?e.jsx("line",{x1:Be,y1:me,x2:Ce,y2:me,stroke:_e,strokeWidth:$e,strokeDasharray:rt,opacity:pe}):e.jsx(je.path,{d:`M ${Be} ${me} L ${Ce} ${me}`,stroke:_e,strokeWidth:$e,strokeDasharray:rt,opacity:pe,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:pe},transition:{duration:4,ease:"easeInOut",delay:.5}})),e.jsx(Rs,{data:de,allDataPoints:u,getX:ae,getY:be,baselineY:se,temperatureField:"displayTemperature",reduceMotion:re}),Qe&&e.jsx("g",{pointerEvents:"none",children:e.jsx("path",{d:Qe,fill:"none",stroke:"#cc0e93",strokeWidth:4,strokeLinecap:"round",strokeLinejoin:"round",opacity:.9})}),ne!==null&&Ne!==null&&J>0&&e.jsx("g",{pointerEvents:"none",children:(()=>{const t=se,n=Math.max(3,Math.min(14,J*.4)),s=Math.max(n*2,te*.85);return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:Ne,y1:0,x2:Ne,y2:t,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:n}),e.jsx("line",{x1:Ne,y1:t,x2:Ne,y2:d,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:s})]})})()}),e.jsx(Ws,{data:u,getX:ae,getY:be,isFullScreen:c,orientation:p,responsiveFontSize:Fe,onPointInteraction:Oe,clearActivePoint:ke,activePoint:ee,padding:A,chartHeight:d,chartWidth:g,temperatureField:"displayTemperature",textRowHeight:te,graphBottomY:se,rowsZoneHeight:we,compact:!1,reduceMotion:re,showInterpretation:m,ovulationDetails:_,baselineStartIndex:ct,firstHighIndex:wt,baselineIndices:nt,graphBottomLift:Te,showRelationsRow:V})]})]})})}),ee&&e.jsx(je.div,{ref:le,initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:10},transition:{duration:.12,ease:"easeOut"},children:e.jsx(us,{point:ee,position:he,chartWidth:g,chartHeight:d,onToggleIgnore:bt,onEdit:Q,onClose:ke,onTogglePeak:y,currentPeakIsoDate:P})})]})})};function Vs(a,c){if(!a||!c)return[];const p=typeof a=="string"?et(a):a;return[...Array(c)].map((h,Q)=>{const y=Qt(p,Q),z=gt(y,"yyyy-MM-dd"),H=gt(y,"dd/MM"),L=Pt(tt(y),tt(p))+1;return{date:H,isoDate:z,cycleDay:L,temperature:null,mucusSensation:null,mucusAppearance:null,had_relations:!1,hadRelations:!1,id:`placeholder-${z}`,ignored:!1,peak_marker:null}})}const qs=({isOpen:a,onClose:c,children:p,ariaLabel:h,containerClassName:Q="",backdropClassName:y="bg-black/40"})=>{if(f.useEffect(()=>{if(!a)return;const L=Y=>{Y.key==="Escape"&&typeof c=="function"&&c()};document.addEventListener("keydown",L);const{body:m}=document,re=m.style.overflow;return m.style.overflow="hidden",()=>{document.removeEventListener("keydown",L),m.style.overflow=re}},[a,c]),!a||typeof document>"u")return null;const z=()=>{typeof c=="function"&&c()},H=L=>{L.stopPropagation()};return es.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center px-4 py-8",children:[e.jsx("div",{className:`absolute inset-0 ${y}`,onClick:z,"aria-hidden":"true"}),e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":h??void 0,className:`relative z-[101] w-full max-w-md overflow-hidden rounded-3xl bg-white shadow-2xl shadow-rose-200/50 focus:outline-none focus-visible:ring-2 focus-visible:ring-pink-200 ${Q}`,onClick:H,children:p})]}),document.body)},Vt="fertility-chart-settings",Mt=a=>a?String(a).toUpperCase().replace(/-/g,""):"",Ks=a=>{const c=Mt(a);return c==="T8"?"T-8":c==="CPM"?"CPM":a??""},yt=()=>({calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"estandar"}),qt={showRelationsRow:!0,fertilityStartConfig:yt()},Xs=[{key:"cpm",label:"CPM"},{key:"t8",label:"T-8"}],Rt={conservador:"Conservador",estandar:"Estándar"},Tt=a=>{const c=yt(),p={calculators:{...c.calculators},postpartum:c.postpartum,combineMode:c.combineMode};return a&&typeof a=="object"&&(Object.keys(p.calculators).forEach(h=>{typeof a?.calculators?.[h]=="boolean"&&(p.calculators[h]=a.calculators[h])}),Object.prototype.hasOwnProperty.call(Rt,a.combineMode)&&(p.combineMode=a.combineMode),typeof a.postpartum=="boolean"?p.postpartum=a.postpartum:a.postpartum!=null&&(p.postpartum=!!a.postpartum)),p},cn=()=>{const{cycleId:a}=ts(),c=ss(),{currentCycle:p,archivedCycles:h,isLoading:Q,addOrUpdateDataPoint:y,toggleIgnoreRecord:z,getCycleById:H}=ms(),[L,m]=f.useState(null),[re,Y]=f.useState(!1),[P,V]=f.useState(!1),w=!a||a===p.id,K=w?null:h.find(t=>t.id===a);f.useEffect(()=>{if(w){m(null),Y(!1),V(!1);return}if(K){m(null),Y(!1),V(!1);return}let t=!0;return Y(!0),H(a).then(n=>{t&&(n?(m(n),V(!1)):(m(null),V(!0)))}).catch(()=>{t&&(m(null),V(!0))}).finally(()=>{t&&Y(!1)}),()=>{t=!1}},[w,K,H,a]);const i=w?p:K||L,k=!w&&!K,B=!w&&i?.id,E=w?Q&&!p?.id:re||Q&&!K&&!L,{preferences:j,savePreferences:le}=ns(),x=j?.manualCpm,ee=j?.manualCpmBase,ne=j?.manualT8,he=j?.manualT8Base,u=["auto","manual","none"].includes(j?.cpmMode)?j.cpmMode:"auto",de=["auto","manual","none"].includes(j?.t8Mode)?j.t8Mode:"auto",st=f.useMemo(()=>{if(!B||!i?.startDate)return"";const t=r=>{if(!r)return null;try{return gt(et(r),"dd/MM/yyyy")}catch(o){return console.error("Error formatting cycle date",o),r}},n=t(i.startDate),s=t(i.endDate)??"Sin fecha de fin";return n?`Ciclo ${n} - ${s}`:""},[B,i?.startDate,i?.endDate]),De=f.useMemo(()=>{const t=[];return Array.isArray(h)&&h.length>0&&t.push(...h),p?.id&&t.push(p),i?.id&&!t.some(n=>n?.id===i.id)&&t.push(i),t},[h,p,i]),[ve,A]=f.useState(typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait"),[te,be]=f.useState(!1),[ae,Oe]=f.useState(!1),[bt,Fe]=f.useState(!1),[ke,Me]=f.useState(null),[ct,nt]=f.useState(null),[wt,_]=f.useState(!1),[D,at]=f.useState(!1),[Te,Pe]=f.useState(!1),[ue,l]=f.useState(null),[g,d]=f.useState(()=>{const t={showRelationsRow:qt.showRelationsRow,fertilityStartConfig:Tt(qt.fertilityStartConfig)};if(typeof window>"u")return t;try{const n=window.localStorage.getItem(Vt);if(n){const s=JSON.parse(n),r={...t,...s};return typeof s?.showRelationsRow=="boolean"?r.showRelationsRow=s.showRelationsRow:s?.showRelationsRow!=null&&(r.showRelationsRow=!!s.showRelationsRow),r.fertilityStartConfig=Tt(s?.fertilityStartConfig),r}}catch(n){console.warn("No se pudieron cargar los ajustes del gráfico.",n)}return t});f.useEffect(()=>{j&&d(t=>{const n=t.fertilityStartConfig??yt(),s={...n};let r=!1;return typeof j.showRelationsRow=="boolean"&&t.showRelationsRow!==j.showRelationsRow&&(r=!0),Object.prototype.hasOwnProperty.call(Rt,j.combineMode)&&n.combineMode!==j.combineMode&&(s.combineMode=j.combineMode,r=!0),r?{...t,showRelationsRow:typeof j.showRelationsRow=="boolean"?j.showRelationsRow:t.showRelationsRow,fertilityStartConfig:s}:t})},[j]);const $=f.useMemo(()=>Tt(g.fertilityStartConfig),[g.fertilityStartConfig]),se=f.useMemo(()=>({...$,calculators:{...$.calculators,cpm:$.calculators.cpm&&u!=="none",t8:$.calculators.t8&&de!=="none"}}),[$,u,de]);f.useEffect(()=>{if(!(typeof window>"u"))try{const t={...g,fertilityStartConfig:$};window.localStorage.setItem(Vt,JSON.stringify(t))}catch(t){console.warn("No se pudieron guardar los ajustes del gráfico.",t)}},[g,$]);const we=f.useRef(!1),me=!!(ke&&String(ke.id||"").startsWith("placeholder-"));if(f.useEffect(()=>{const t=async()=>{const n=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);if(be(n),!n){try{await(typeof window<"u"?window.screen?.orientation:null)?.unlock?.()}catch{}Oe(!1);const s=typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait";A(s)}};return document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("MSFullscreenChange",t),()=>{document.removeEventListener("fullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.removeEventListener("MSFullscreenChange",t)}},[]),f.useLayoutEffect(()=>{window.dispatchEvent(new Event("resize"))},[ve,te]),f.useEffect(()=>{if(typeof window>"u")return;const t=()=>{if(ae)return;const n=window.innerWidth>window.innerHeight?"landscape":"portrait";A(s=>s===n?s:n),window.dispatchEvent(new Event("resize"))};return window.addEventListener("resize",t),window.addEventListener("orientationchange",t),t(),()=>{window.removeEventListener("resize",t),window.removeEventListener("orientationchange",t)}},[ae]),E)return e.jsx(Lt,{children:e.jsx("div",{className:"flex h-full flex-col items-center justify-center space-y-4 bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-fertiliapp-fuerte",children:e.jsx("p",{children:"Cargando…"})})});if(!i?.id)return a&&P?e.jsx(Lt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-fertiliapp-fuerte",children:[e.jsx("p",{children:"No se encontró el ciclo solicitado."}),e.jsx(lt,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl text-white shadow",children:e.jsx(Et,{to:"/archived-cycles",children:"Volver a Mis Ciclos"})})]})}):e.jsx(Lt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-fertiliapp-fuerte",children:[e.jsx("p",{children:"No hay ciclo activo."}),e.jsx(lt,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl text-white shadow",children:e.jsx(Et,{to:"/records",children:"Ir a Mis Registros"})})]})});const X=28,fe=10,Be=25,Ce=et(i.startDate),_e=i.data||[],rt=f.useMemo(()=>(Array.isArray(_e)?_e.find(n=>n?.peak_marker==="peak"):null)?.isoDate||null,[_e]),pe=_e.reduce((t,n)=>{const s=et(n.isoDate);return s>t?s:t},Ce),$e=tt(new Date),Xe=pe>$e?pe:$e,Ne=Pt(tt(Xe),Ce),Ge=Math.max(X,Ne+1),xe=Vs(Ce,Ge).map(t=>{const n=_e.find(s=>s.isoDate===t.isoDate);return n?{...n,date:t.date}:t}),J=te?ve==="portrait"?fe:Be:ve==="portrait"?fe:X;let He=0;if(ve!=="landscape"){const t=Pt(new Date,tt(Ce)),n=Math.min(Math.max(t,0),Ge-1);let s=Math.min(Ge,n+1);n<J-1&&(s=Math.min(Ge,J)),He=Math.max(0,s-J)}const oe={backgroundColor:"#fff7fb",backgroundImage:`
      radial-gradient(120% 120% at 0% 0%, rgba(251,113,133,0.18) 0, transparent 55%),
      radial-gradient(110% 110% at 100% 0%, rgba(244,114,182,0.16) 0, transparent 55%),
      radial-gradient(130% 130% at 0% 100%, rgba(251,113,133,0.08) 0, transparent 60%),
      radial-gradient(140% 140% at 100% 100%, rgba(255,255,255,0.9) 0, rgba(255,247,250,0.3) 40%, transparent 70%)
    `},ie="calc(var(--app-vh, 1vh) * 100)",Le="var(--bottom-nav-safe)",dt=te?{...oe,height:ie,maxHeight:ie,paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"}:{...oe,height:`calc(${ie} - ${Le})`,maxHeight:`calc(${ie} - ${Le})`,paddingTop:"env(safe-area-inset-top)"},Re=(t,n=null)=>{Me(t),nt(n??null),Fe(!0)},ge=async(t,n)=>{try{if(await z(t,n),k){const s=await H(t);s&&m(s)}}catch(s){console.error("Error toggling ignore state:",s)}},ut=t=>{const n=t===!0;d(s=>({...s,showRelationsRow:n})),typeof le=="function"&&le({showRelationsRow:n}).catch(s=>{console.error("Failed to persist relations row preference",s)})},Je=(t,n)=>{d(s=>{const r=s.fertilityStartConfig??yt(),o=n===!0;return r.calculators?.[t]===o?s:{...s,fertilityStartConfig:{...r,calculators:{...r.calculators,[t]:o}}}})},Ue=t=>{Object.prototype.hasOwnProperty.call(Rt,t)&&(d(n=>{const s=n.fertilityStartConfig??yt();return s.combineMode===t?n:{...n,fertilityStartConfig:{...s,combineMode:t}}}),typeof le=="function"&&le({combineMode:t}).catch(n=>{console.error("Failed to persist combine mode preference",n)}))},Ye=t=>{d(n=>{const s=n.fertilityStartConfig??yt(),r=t===!0;return s.postpartum===r?n:{...n,fertilityStartConfig:{...s,postpartum:r}}})},F=c?.state?.fertilityCalculatorCandidates,Ze=i?.fertilityCalculatorCandidates,Ve=f.useMemo(()=>{const t=[Array.isArray(F)?F:null,Array.isArray(Ze)?Ze:null].find(n=>Array.isArray(n)&&n.length>0);return t?t.map(n=>{if(!n)return null;const{source:s,day:r,reason:o}=n;if(s!=="CPM"&&s!=="T8")return null;const v=Number(r);return Number.isFinite(v)?{source:s,day:v,reason:typeof o=="string"?o:""}:null}).filter(Boolean):null},[F,Ze]),qe=f.useMemo(()=>{const t=fs(De),n=hs(De,ps),s=[];return u==="auto"&&t&&s.push(t),de==="auto"&&n&&s.push(n),s},[De,u,de]),Ee=f.useMemo(()=>{const t=[],n=(s,r,o,v)=>{if(s!=="manual")return;const T=Number(o);if(!Number.isFinite(T)||T<=0)return;const b=Number(v),U=Number.isFinite(b)&&b>0,S=U?Number.isInteger(b)?`${b}`:`${Number(b.toFixed(2))}`:null,M=U?r==="CPM"?`ciclo base: ${S} días`:`base ${Ks(r)}: ${S}`:null,I=M?`Manual desde dashboard (${M})`:"Manual desde dashboard";t.push({source:r,day:Math.max(1,T),reason:I,kind:"calculator",isManual:!0,manualBase:U?b:null})};return n(u,"CPM",x,ee),n(de,"T8",ne,he),t},[u,x,ee,ne,he,de]),ot=f.useMemo(()=>{const t=new Map;(Array.isArray(Ve)?Ve:[]).forEach(o=>{const v=Mt(o?.source);v&&t.set(v,o)});const n=new Map;Ee.forEach(o=>{const v=Mt(o?.source);v&&n.set(v,o)});const s=u==="manual"?n.get("CPM")??t.get("CPM")??null:u==="auto"?qe.find(o=>Mt(o?.source)==="CPM")??null:null,r=de==="manual"?n.get("T8")??t.get("T8")??null:de==="auto"?qe.find(o=>Mt(o?.source)==="T8")??null:null;return[s,r].filter(Boolean)},[qe,u,Ee,Ve,de]),Ct=async(t,n=!0)=>{if(!i?.id||!t?.isoDate)return;const s=o=>{if(o==null||o==="")return null;const v=parseFloat(String(o).replace(",","."));return Number.isFinite(v)?v:null},r=n??!(t.peak_marker==="peak"||t.peakStatus==="P");_(!0);try{const o=t.timestamp?gt(et(t.timestamp),"HH:mm"):gt(new Date,"HH:mm");let v=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:o,time_corrected:t.time_corrected??o,selected:!0,use_corrected:t.use_corrected??!1}];v.length===0&&(v=[{temperature:null,temperature_corrected:null,time:o,time_corrected:o,selected:!0,use_corrected:!1}]);const T=v.map((S,M)=>{const I=S.time||o,G=S.time_corrected||I;return{temperature:s(S.temperature??S.temperature_raw),time:I,selected:M===0?!0:!!S.selected,temperature_corrected:s(S.temperature_corrected),time_corrected:G,use_corrected:!!S.use_corrected}});T.some(S=>S.selected)||(T[0].selected=!0);const b={isoDate:t.isoDate,measurements:T,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",had_relations:t.had_relations??t.hadRelations??!1,ignored:t.ignored??!1,peak_marker:r?"peak":null},U=t?.id&&!String(t.id).startsWith("placeholder-")?t:null;await y(b,U,i.id)}catch(o){console.error("Error toggling peak marker:",o)}finally{_(!1)}},St=async(t,{keepFormOpen:n=!1}={})=>{if(i?.id){_(!0);try{if(await y(t,ke,i.id),k){const s=await H(i.id);s&&m(s)}n||(Fe(!1),Me(null),nt(null))}finally{_(!1)}}},Qe=()=>{Fe(!1),Me(null),nt(null)},We=t=>{Me(t)},ft=()=>{at(t=>!t)},it=f.useCallback(()=>{l(null)},[]),Se=t=>{if(t.preventDefault(),we.current){we.current=!1;return}ft()},It=t=>{t.pointerType==="touch"&&(t.preventDefault(),we.current=!0,ft())},Ie=f.useCallback(t=>{if(!Number.isInteger(t)||t<0||t>=xe.length)return"—";const n=xe[t],s=n?.isoDate??n?.date;if(!s)return"—";try{const r=typeof s=="string"?et(s):s;return gt(r,"dd/MM")}catch(r){return console.error("Error formatting date from index",r),"—"}},[xe]),vt=f.useCallback((t={})=>{if(!t)return;const n=t.phase??null,s=t.reasons??{},r=s?.aggregate??null,o=Array.isArray(r?.usedCandidates)?r.usedCandidates:[],v=Array.isArray(r?.ignoredCalculatorCandidates)?r.ignoredCalculatorCandidates:[],T=s?.window??s?.fertileWindow??null,b=Number.isInteger(s?.startIndex)?s.startIndex:Number.isInteger(s?.fertileStartFinalIndex)?s.fertileStartFinalIndex:null,U=r?.selectedMode??$?.combineMode??null,S=s?.source==="marker"||s?.details?.explicitStartDay!=null?"Ajustado por marcadores":{conservador:"Conservador",estandar:"Estándar"}[U]??null,M=N=>(N?.source??N?.originalSource??"").toString().toUpperCase(),I=()=>{const N=Number.isInteger(b)?b+1:null;return N?{candidate:o.find(q=>Number.isFinite(q?.day)&&Math.round(q.day)===N)??o[0]??null,dayNumber:N}:{candidate:null,dayNumber:null}},G=()=>{const{candidate:N}=I(),Z=M(N);if(Z==="CPM")return"alcanzar valor CPM";if(Z==="T8"||Z==="T-8")return"alcanzar valor T-8";if(s?.source==="marker"||s?.details?.explicitStartDay!=null)return"marcador";const q=(N?.reason??"").toUpperCase(),W=q.includes("S")||q.includes("BIP");return!q&&!Z?null:W?"cambio en la sensación":"presencia de moco"};let C="",R="",O=null;if(n==="relativeInfertile"){C="Relativamente infértil";const N=Number.isInteger(b),Z=U==="estandar"&&Array.isArray(v)&&v.length>0,q=G(),W=Ie(b);N?(R=`Fin de fase por ${q??"—"}.`,O=W!=="—"?`Inicio fértil: ${W}.`:null):U==="conservador"?R="A la espera de cálculo (CPM/T-8) o signos de moco/sensación.":Z?R="Referencia alcanzada (CPM/T-8). A la espera de signos de moco/sensación.":R="A la espera de signos de moco/sensación."}else if(n==="fertile"){C="Fase fértil";const N=G()??"—",q=Ie(b)??"—",W=Number.isFinite(T?.endIndex),ye=Number.isInteger(T?.mucusInfertileStartIndex),ce=Number.isInteger(T?.temperatureInfertileStartIndex);R=`Iniciada el ${q} por ${N}.`,W?ye&&ce?O="Finalizada por doble criterio.":ye?O="Finalizada por día pico.":ce&&(O="Finalizada por temperatura."):O="A la espera de cierre por día pico y/o confirmación de temperatura."}else if(n==="postOvulatory"){const N=(t?.displayLabel??t?.label??"").toLowerCase(),Z=t?.status??s?.status??null,q=Ie(Number.isInteger(s?.temperature?.confirmationIndex)?s.temperature.confirmationIndex:Number.isInteger(s?.temperature?.startIndex)?s.temperature.startIndex:T?.temperatureInfertileStartIndex),W=Ie(s?.mucus?.peakDayIndex),ye=Ie(Number.isInteger(s?.mucus?.infertileStartIndex)?s.mucus.infertileStartIndex:t?.startIndex),ce=Ie(t?.startIndex);if(Z==="absolute"||t?.displayLabel==="Infertilidad absoluta")C="Infertilidad postovulatoria confirmada",R=`Comienza el ${ce}.`,O=`Confirmada por temperatura (${q}) y 3.º/4.º día postpico (${ye}).`;else if(N.includes("moco")){C="Infertilidad post-pico";const pt=Number.isInteger(s?.mucus?.infertileStartIndex)?s.mucus.infertileStartIndex:Number.isInteger(t?.startIndex)?t.startIndex:null,Ae=Number.isInteger(s?.mucus?.peakDayIndex)?s.mucus.peakDayIndex:null;let Ke="día postpico";if(Number.isInteger(pt)&&Number.isInteger(Ae)){const mt=pt-Ae;mt===3?Ke="3.º día postpico":mt===4&&(Ke="4.º día postpico")}R=`Alcanzada el ${ce} por ${Ke}. Día pico: ${W}.`,O="A la espera de confirmación por temperatura."}else N.includes("temperatura")?(C="Infertilidad postovulatoria por temperatura",R=`Temperatura confirmada el ${q}.`,O="A la espera de determinación del día pico."):(C="Fase postovulatoria",R="Interpretación postovulatoria disponible.",O=Z==="pending"?"Pendiente completar el segundo criterio.":null)}else if(n==="nodata")(s?.status??t?.status??null)==="no-fertile-window"?(C="Sin ventana fértil identificable",R="No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."):(C="Sin datos suficientes",R="Añade registros de sensación, moco o temperatura para interpretar el ciclo.");else if(t?.message)C=t.message;else return;C&&l({title:C,message:R,description:O,modeLabel:S})},[$,Ie,xe.length,l]),ht=async()=>{const t=document.documentElement,n=typeof window<"u"?window.screen?.orientation:null,s=()=>{A("landscape"),be(!0),Oe(!0)};if(te){if(n?.unlock)try{await n.unlock()}catch(o){console.error(o)}try{const o=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen,v=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;o&&v&&await o.call(document)}catch(o){console.error(o)}Oe(!1);const r=typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait";A(r),be(!1)}else{const r=t.requestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullscreen,o=!!r,v=!!n?.lock;if(!o&&!v){s();return}let T=!1,b=!1;try{r&&(await r.call(t),T=!0)}catch(S){console.error(S)}if(v)try{await n.lock("landscape"),b=!0}catch(S){console.error(S)}const U=T||b;s()}};return e.jsx(Lt,{hideBottomNav:te,children:e.jsxs("div",{className:te?"fixed inset-0 z-50 h-app w-[100vw] overflow-y-auto overflow-x-hidden":"relative w-full h-full overflow-y-auto overflow-x-hidden",style:dt,children:[B&&!te&&e.jsx(lt,{asChild:!0,variant:"ghost",className:"absolute top-4 left-4 z-10 bg-white/80 text-slate-700 hover:bg-[#E27DBF]/20",children:e.jsxs(Et,{to:`/cycle/${i.id}`,className:"flex items-center gap-1",children:[e.jsx(Is,{className:"h-4 w-4"}),st&&e.jsx("span",{className:"ml-1 text-xs font-semibold text-slate-700 sm:text-sm",children:st})]})}),e.jsx(lt,{onClick:()=>Pe(t=>!t),variant:"ghost",size:"icon",className:"absolute top-16 right-4 z-10 p-2 rounded-full bg-white shadow-lg shadow-secundario text-secundario hover:brightness-95","aria-label":"Ajustes del gráfico",children:e.jsx(Ns,{className:"h-4 w-4"})}),e.jsx(lt,{onClick:Se,onPointerUp:It,variant:"ghost",size:"icon",className:`absolute top-4 right-20 z-10 p-2 rounded-full transition-colors ${D?"bg-fertiliapp-fuerte text-white shadow-lg shadow-fertiliapp-fuerte/50 border-fertiliapp-fuerte/70":"bg-white/80 text-fertiliapp-fuerte border border-fertiliapp-fuerte hover:brightness-95 shadow-md"}`,children:D?e.jsx(vs,{className:"h-4 w-4"}):e.jsx(ks,{className:"h-4 w-4"})}),e.jsx(lt,{onClick:ht,className:"absolute top-4 right-4 z-10 bg-white/80 rounded-full text-slate-600 hover:bg-pink-50/80 shadow-md border border-pink-200/50 backdrop-blur-sm","aria-label":te?"Salir de pantalla completa":"Rotar gráfico",children:e.jsx(Ms,{className:"w-4 h-4"})}),e.jsx(Ys,{data:xe,isFullScreen:te,orientation:ve,onToggleIgnore:ge,onEdit:Re,onTogglePeak:Ct,cycleId:i.id,initialScrollIndex:He,visibleDays:J,showInterpretation:D,reduceMotion:!0,forceLandscape:ae||ve==="landscape",currentPeakIsoDate:rt,showRelationsRow:g.showRelationsRow,fertilityStartConfig:se,fertilityCalculatorCycles:De,fertilityCalculatorCandidates:ot,onShowPhaseInfo:vt,isArchivedCycle:!w,cycleEndDate:i?.endDate??null}),Te&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/30",onClick:()=>Pe(!1),"aria-hidden":"true"}),e.jsx("div",{className:`fixed top-0 right-0 z-50 h-app w-72 sm:w-80 transform transition-transform duration-300 ease-in-out ${Te?"translate-x-0":"translate-x-full"}`,role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col gap-6 border-xl rounded-xl border-rose-100/60 bg-white p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-titulo",children:"Ajustes del gráfico"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Personaliza la visualización del gráfico"})]}),e.jsx(lt,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-slate-600",onClick:()=>Pe(!1),"aria-label":"Cerrar ajustes del gráfico",children:"×"})]}),e.jsxs("div",{className:"space-y-4 overflow-y-auto pr-1",children:[e.jsxs("div",{className:"rounded-2xl border border-rose-100/70 bg-rose-50/40 p-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"max-w-xs",children:[e.jsx(Ss,{htmlFor:"toggle-relations-row",className:"text-sm font-semibold text-slate-700",children:"Mostrar fila RS"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Añade una fila dedicada a las relaciones sexuales debajo de la gráfica."})]}),e.jsx(At,{id:"toggle-relations-row",checked:g.showRelationsRow,onCheckedChange:ut,className:"mt-1"})]}),e.jsxs("div",{className:"rounded-2xl border border-amber-100/70 bg-amber-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Calculadoras complementarias"}),e.jsx("p",{className:"text-xs text-slate-500",children:"CPM y T-8 se combinan con los perfiles activos, salvo que actives el modo posparto."})]}),$.postpartum&&e.jsx("p",{className:"text-xs font-medium text-rose-500",children:"El modo posparto está activo: CPM y T-8 se omiten del cálculo final."}),e.jsx("div",{className:"space-y-2",children:Xs.map(t=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-sm text-slate-700",children:t.label}),e.jsx(At,{checked:!!$.calculators?.[t.key],onCheckedChange:n=>Je(t.key,n)})]},t.key))})]}),e.jsxs("div",{className:"rounded-2xl border border-sky-100/70 bg-sky-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Modo de combinación"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Determina cómo se elige el inicio fértil a partir de los candidatos disponibles."})]}),e.jsxs(ys,{value:$.combineMode,onValueChange:Ue,children:[e.jsx(bs,{className:"w-full bg-white/80 border-slate-200 text-sm rounded-3xl text-slate-700",children:e.jsx(ws,{placeholder:"Selecciona un modo"})}),e.jsx(js,{className:"bg-white border-slate-200 text-slate-700 rounded-3xl",children:Object.entries(Rt).map(([t,n])=>e.jsx(Cs,{value:t,className:"text-sm rounded-3xl",children:n},t))})]}),e.jsxs("div",{className:"flex items-start justify-between gap-3 pt-1",children:[e.jsxs("div",{className:"max-w-[65%]",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-700",children:"Modo posparto"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Ignora automáticamente CPM y T-8."})]}),e.jsx(At,{checked:!!$.postpartum,onCheckedChange:Ye,className:"mt-1"})]})]})]})]})}),e.jsx(qs,{isOpen:!!ue,onClose:it,ariaLabel:"Detalle de interpretación del ciclo",containerClassName:"p-6",children:ue&&e.jsxs("div",{className:"space-y-3 text-left",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-fertiliapp-fuerte",children:ue.title}),ue.modeLabel&&e.jsx("span",{className:"rounded-full border border-secundario bg-secundario-suave px-3 py-1 text-[11px] font-semibold text-secundario-fuerte",children:ue.modeLabel})]}),e.jsx("button",{type:"button",onClick:it,className:"rounded-full p-1 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-200","aria-label":"Cerrar detalle de interpretación",children:e.jsx(as,{className:"h-5 w-5"})})]}),ue.message&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-700",children:ue.message}),ue.description&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-500",children:ue.description})]})}),e.jsx(xs,{open:bt,onOpenChange:t=>{t||Qe()},children:e.jsx(gs,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(cs,{onSubmit:St,onCancel:Qe,initialData:ke,cycleStartDate:i.startDate,cycleEndDate:i.endDate,isProcessing:wt,isEditing:!!ke&&!me,cycleData:i.data,onDateSelect:We,initialSectionKey:ct})})})]})})};export{cn as default};
