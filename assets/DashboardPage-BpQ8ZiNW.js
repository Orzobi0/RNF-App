import{c as Wt,h as Ms,i as Fs,r as a,p as ks,d as Is,s as Ts,e as Es,a as Ps,b as $s,u as Os,f as ue,g as ta,k as Ke,l as Aa,n as St,o as Mt,j as e,m as H,B as Ce}from"./index-BrkKcvYr.js";import{N as ka,P as Ia,L as Ta,C as As,a as Bs}from"./PostpartumExitDialog-U6uUCT8H.js";import{D as Rs,A as Ea}from"./DataEntryForm-BAptPWhC.js";import{D as _s,O as Ls}from"./DeletionDialog-vRraKZqj.js";import{u as zs,i as Ba,D as ft,a as pt,b as _t,c as Lt,d as Pa,e as zt}from"./useCycleData-NykkPLt1.js";import{c as Vs,u as Us,C as Ws}from"./useFertilityChart-CRYIdz-T.js";import{c as Hs,g as Js}from"./computePeakStatuses-DXv7gS4Y.js";import{L as Vt,I as Ut}from"./label-DG8WrZKe.js";import{l as aa}from"./badge-Bg-zWaI6.js";import{C as na,a as Xs,P as Ys}from"./useBackClose-C07k0QgV.js";import"./peak-mode-button-CxuwCOgG.js";import"./eye-DF71BUjW.js";const $a=Wt("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]),Ks=Wt("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),Oa=Wt("CheckCircle2",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),qs=Wt("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]);function Gs(){!Ms.current&&Fs();const[x]=a.useState(ks.current);return x}const Qs="metrics",Zs="summary",sa=async(x,i)=>{if(!x||!i||typeof i!="object")throw new Error("A valid userId and data object are required to save metrics.");const T=Is(Es,`users/${x}/${Qs}`,Zs);await Ts(T,i,{merge:!0})},ra=20;function en({cycleCount:x,deduction:i}){return typeof i=="number"&&Number.isFinite(i)?i:(typeof x=="number"&&Number.isFinite(x)?x:0)>=12?20:21}function tn({computedCpmData:x,cpmSelection:i,isManualCpm:T,manualCpmBaseValue:$,manualCpmValue:Re,formatNumber:Z}){const _=typeof x.shortestCycle?.duration=="number"&&Number.isFinite(x.shortestCycle.duration)?x.shortestCycle.duration:null,_e=typeof x.value=="number"&&Number.isFinite(x.value)?x.value:null,ee=T&&i==="manual",O=i==="auto",te=i==="none",ae=ee?$:O?_:null,q=ee?Re:O?_e:null,ne=Z(ae,{maximumFractionDigits:0}),E=Z(q,{maximumFractionDigits:2}),Le=`Ciclo más corto: ${ne??"—"}`,$e=`CPM = ${E??"—"}`;let G="Sin datos disponibles",A=!0;if(typeof q=="number"&&Number.isFinite(q)){if(ee)typeof $=="number"&&Number.isFinite($)?(G=`${Z($,{maximumFractionDigits:0})??`${$}`} − ${ra}`,A=!1):(G="Valor definido manualmente",A=!0);else if(O&&typeof _=="number"&&Number.isFinite(_)){const L=en({cycleCount:x.cycleCount??0,deduction:x.deduction});G=`${Z(_,{maximumFractionDigits:0})??`${_}`} − ${L}`,A=!1}}return(typeof q!="number"||!Number.isFinite(q))&&(G="Sin datos disponibles",A=!0),{title:"CPM",baseText:Le,finalText:$e,microCopy:G,microCopyMuted:A,modeLabel:te?"Sin usar":ee?"Manual":"Auto",microCopyId:"cpm-metric-microcopy",baseValue:ae,finalValue:q,baseFormatted:ne,finalFormatted:E,isManual:ee}}function an({computedT8Data:x,t8Selection:i,isManualT8:T,manualT8BaseValue:$,manualT8Value:Re,formatNumber:Z}){const _=typeof x.earliestCycle?.riseDay=="number"&&Number.isFinite(x.earliestCycle.riseDay)?x.earliestCycle.riseDay:null,_e=typeof x.value=="number"&&Number.isFinite(x.value)?x.value:null,ee=x&&typeof x.canCompute=="boolean"?x.canCompute:!0,O=T&&i==="manual",te=i==="auto"&&ee,ae=i==="none",q=O?$:te?_:null,ne=O?Re:te?_e:null,E=Z(q,{maximumFractionDigits:0}),Le=Z(ne,{maximumFractionDigits:0}),$e=`Día de subida: ${E??"—"}`,G=`T-8 = ${Le??"—"}`;let A="Sin datos disponibles",Ne=!0;return typeof ne=="number"&&Number.isFinite(ne)&&(O?typeof $=="number"&&Number.isFinite($)?(A=`${Z($,{maximumFractionDigits:0})??`${$}`} − 8`,Ne=!1):(A="Valor definido manualmente",Ne=!0):te&&typeof _=="number"&&Number.isFinite(_)&&(A=`${Z(_,{maximumFractionDigits:0})??`${_}`} − 8`,Ne=!1)),(typeof ne!="number"||!Number.isFinite(ne))&&(A="Sin datos disponibles",Ne=!0),{title:"T-8",baseText:$e,finalText:G,microCopy:A,microCopyMuted:Ne,modeLabel:ae?"Sin usar":O?"Manual":"Auto",microCopyId:"t8-metric-microcopy",baseValue:q,finalValue:ne,baseFormatted:E,finalFormatted:Le,isManual:O}}const sn=({cycleData:x,onEdit:i,onTogglePeak:T,currentPeakIsoDate:$,onEditStartDate:Re=()=>{},handleOpenCpmDialog:Z=()=>{},handleOpenT8Dialog:_=()=>{},cpmMetric:_e={},t8Metric:ee={}})=>{const O=x.records||[],[te,ae]=a.useState(null),[q,ne]=a.useState({clientX:0,clientY:0}),[E,Le]=a.useState(!1),[$e,G]=a.useState(!1),[A,Ne]=a.useState([]),L=a.useRef(!0),xe=a.useRef(null),Fe=a.useRef(null),Ft=a.useRef(new Map),qe=a.useRef(null),ze=Gs(),re=x.startDate?ue(x.startDate):null,Ht=Mt(new Date),xt=a.useMemo(()=>Hs(O),[O]);a.useEffect(()=>{const n=Ft.current,d=new Map,f=[];O.forEach(p=>{if(!p)return;let v=p.cycleDay;if(!v&&re&&p.isoDate)try{v=St(ue(p.isoDate),re)+1}catch{v=null}if(!v)return;const j=JSON.stringify({temp:p.displayTemperature??p.temperature_chart??null,symbol:p.fertility_symbol??null,sensation:p.mucus_sensation??p.mucusSensation??"",appearance:p.mucus_appearance??p.mucusAppearance??"",observations:p.observations??"",relations:p.had_relations??p.hadRelations??!1,updatedAt:p.updatedAt??p.timestamp??null});if(d.set(v,j),n.size>0){const M=n.get(v);(!M||M!==j)&&f.push(v)}}),Ft.current=d,!ze&&f.length&&Ne(p=>{const v=new Set(p),j=v.size;return f.forEach(M=>v.add(M)),v.size===j?p:Array.from(v)})},[re,ze,O]),a.useEffect(()=>{if(ze||A.length===0)return;const n=setTimeout(()=>{Ne([])},1400);return qe.current=n,()=>{qe.current&&clearTimeout(qe.current)}},[ze,A]);const se=28,he=140,N=he+15,B=N*2,kt=a.useMemo(()=>{const n=O.reduce((d,f)=>{const p=f?.cycleDay??null;if(p)return Math.max(d,p);if(!re||!f?.isoDate)return d;try{const v=ue(f.isoDate),j=St(v,re)+1;return Number.isFinite(j)?Math.max(d,j):d}catch(v){return console.error("Error calculating record day for wheel:",v),d}},0);return Math.max(x.currentDay,n,se)},[x.currentDay,O,re,se]),oe=Math.max(kt-se,0),S=oe>0,Ge=a.useMemo(()=>S?Math.max(0,Math.min(Math.max(x.currentDay-se,0),oe)):0,[x.currentDay,S,oe,se]),[R,le]=a.useState(Ge);a.useEffect(()=>{L.current||(L.current=!0)},[Ge,R]),a.useEffect(()=>{if(!S){L.current=!0,le(0);return}le(n=>{const d=Math.min(n,oe),f=Math.max(0,Math.min(Math.max(x.currentDay-se,0),oe)),p=x.currentDay>=d+1&&x.currentDay<=d+se;return L.current?p?d!==n?d:n:f:(L.current=!0,f)})},[S,oe,x.currentDay,se]);const de=a.useCallback(n=>Math.max(0,Math.min(n,oe)),[oe]),me=a.useCallback(n=>{!S||n===0||le(d=>de(d+n))},[de,S]),we=a.useRef(0),Q=a.useRef(0),fe=a.useCallback(n=>{!S||n===0||(Q.current+=n,!we.current&&(we.current=requestAnimationFrame(()=>{const d=Math.sign(Q.current);le(f=>de(f+d)),Q.current=0,we.current=0})))},[S,de]),Qe=a.useCallback(n=>{if(!S)return;n.preventDefault();const d=Math.abs(n.deltaY)>Math.abs(n.deltaX)?n.deltaY:n.deltaX;d!==0&&fe(d>0?1:-1)},[me,S]),z=a.useCallback(n=>{S&&(xe.current=n.touches?.[0]?.clientX??null)},[S]),pe=a.useCallback(n=>{if(!S||xe.current===null)return;const d=n.touches?.[0]?.clientX??null;if(d===null)return;const f=d-xe.current;Math.abs(f)<24||(fe(f<0?1:-1),xe.current=d)},[me,S]),J=a.useCallback(()=>{xe.current=null},[]),je=a.useCallback(n=>({...Js(n),...n==="spot"?{pattern:"url(#spotting-pattern-dashboard)"}:{}}),[]),V=a.useMemo(()=>O.reduce((n,d)=>{if(!d)return n;const f=Number(d.cycleDay);if(Number.isFinite(f)&&f>0)return n.has(f)||n.set(f,d),n;if(!re||!d.isoDate)return n;try{const p=ue(d.isoDate),v=St(p,re)+1;Number.isFinite(v)&&v>0&&!n.has(v)&&n.set(v,{...d,cycleDay:v})}catch(p){console.error("Error mapping record by day for wheel:",p)}return n},new Map),[O,re]),ke={main:"#b4a9b0",light:"#c1b6bd",glow:"rgba(212, 194, 206, 0.16)",border:"#c1b6bd"},We=Array.from({length:se},(n,d)=>{const f=R+d+1,p=V.get(f)??null,v=re?Aa(re,f-1):null,j=v?Ke(v,"yyyy-MM-dd"):null,M=v?Ba(Mt(v),Ht):!1,k=p?{...p,cycleDay:p.cycleDay??f}:null,Me=(d+R)/se*2*Math.PI-Math.PI/2,U=N+he*Math.cos(Me),Te=N+he*Math.sin(Me);let W=f<=x.currentDay&&k?je(k.fertility_symbol):ke;!k&&f<x.currentDay?W={main:"transparent",light:"transparent",glow:"rgba(180, 169, 176, 0.1)",border:"rgba(180, 169, 176, 0.4)"}:(M||f>x.currentDay)&&(W={main:"transparent",light:"transparent",glow:"rgba(251, 192, 203, 0.1)",border:"rgba(252, 170, 185, 0.35)"});const Xe=f===x.currentDay;Xe&&(k?W={...je(k.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:W={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const Y=j&&xt[j]||null;return{x:U,y:Te,day:f,colors:W,isActive:f<=x.currentDay,isToday:Xe,hasRecord:!!k,record:k,isoDate:j,canShowPlaceholder:!!(!k&&j&&!M),peakStatus:Y}}),X=a.useMemo(()=>new Set(A),[A]),Oe=R*360/se,ht=-Oe*Math.PI/180,He=Math.cos(ht),bt=Math.sin(ht),Je=a.useCallback((n,d)=>{const f=n-N,p=d-N;return{x:N+f*He-p*bt,y:N+f*bt+p*He}},[N,He,bt]),It=2*Math.PI/se,Ve=-Math.PI/2-It/2,Tt=he-18,Ze=he+10,De=N+Tt*Math.cos(Ve),yt=N+Tt*Math.sin(Ve),Se=N+Ze*Math.cos(Ve),Ie=N+Ze*Math.sin(Ve);a.useEffect(()=>{S&&ae(null)},[R,S]);const Ae=(n,d)=>{if(d.stopPropagation(),!Fe.current){ae(null);return}const f=Fe.current.getBoundingClientRect();let p,v;d.touches&&d.touches[0]?(p=d.touches[0].clientX,v=d.touches[0].clientY):(p=d.clientX,v=d.clientY);const j=n.canShowPlaceholder&&n.isoDate?{id:`placeholder-${n.isoDate}`,isoDate:n.isoDate,cycleDay:n.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:n.peakStatus,peak_marker:n.peakStatus==="P"?"peak":null}:null,M=n.record?{...n.record,cycleDay:n.record.cycleDay??n.day,peakStatus:n.peakStatus,peak_marker:n.record.peak_marker??(n.peakStatus==="P"?"peak":null)}:j;if(M&&$&&M.isoDate===$&&(M.peak_marker="peak",M.peakStatus=M.peakStatus||"P"),!M){ae(null);return}ne({clientX:p-f.left,clientY:v-f.top}),ae(M)};return a.useEffect(()=>{if(!te)return;const n=d=>{Fe.current&&!Fe.current.contains(d.target)&&ae(null)};return document.addEventListener("mousedown",n),document.addEventListener("touchstart",n),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}},[te]),e.jsxs("div",{className:"relative flex flex-col space-y-4",children:[e.jsxs(H.div,{className:"relative overflow-hidden px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-titulo mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:Re,className:"inline-flex items-center gap-1.5 rounded-full bg-white/60 px-3 py-1.5 text-sm font-semibold text-subtitulo shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white",title:"Editar fecha de inicio del ciclo",children:[e.jsx(Bs,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(H.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.2,delay:.1},children:[e.jsxs("div",{className:"relative overflow-hidden rounded-[75px]   p-4  mb-4",children:[e.jsxs("div",{className:"pointer-events-none absolute inset-0",children:[e.jsx("div",{className:"absolute inset-0 "}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 h-1/2 "})]}),e.jsx("div",{className:"relative text-center flex-shrink-0",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(H.div,{ref:Fe,className:"relative inline-flex items-center justify-center mb-4 drop-shadow-[0_15px_35px_rgba(221,86,101,0.22)]",style:{width:B,height:B},initial:{opacity:0},animate:{opacity:1},transition:{duration:.18,ease:"easeOut"},onWheel:Qe,onTouchStart:z,onTouchMove:pe,onTouchEnd:J,children:[e.jsxs("svg",{className:"w-full h-full wheel-no-tap",viewBox:`0 0 ${B} ${B}`,onClick:()=>ae(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"78%",fx:"30%",fy:"20%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFE7E8",stopOpacity:"0.98"}),e.jsx("stop",{offset:"60%",stopColor:"#FFC0C1",stopOpacity:"0.95"}),e.jsx("stop",{offset:"100%",stopColor:"#FFB5B3",stopOpacity:"0.95"})]}),e.jsxs("filter",{id:"circleDepthShadow",children:[e.jsx("feDropShadow",{dx:"0",dy:"10",stdDeviation:"10",floodColor:"rgba(221,86,101,0.22)",floodOpacity:"1"}),e.jsx("feDropShadow",{dx:"0",dy:"4",stdDeviation:"4",floodColor:"rgba(221,86,101,0.18)",floodOpacity:"1"})]}),e.jsx("filter",{id:"dotShadow",x:"-30%",y:"-30%",width:"160%",height:"160%",colorInterpolationFilters:"sRGB",children:e.jsx("feDropShadow",{dx:"0",dy:"0.8",stdDeviation:"0.8",floodColor:"#000",floodOpacity:"0.22"})}),e.jsx("filter",{id:"whiteSymbolShadow",children:e.jsx("feDropShadow",{dx:"0",dy:"0.5",stdDeviation:"0.8",floodColor:"rgba(189,16,44,0.3)"})}),e.jsx("filter",{id:"activePointHighlight",children:e.jsx("feDropShadow",{dx:"0",dy:"-1",stdDeviation:"0.5",floodColor:"rgba(255,255,255,0.7)",floodOpacity:"1"})}),e.jsxs("filter",{id:"bevel",children:[e.jsx("feFlood",{floodColor:"rgba(255,255,255,0.4)",result:"top"}),e.jsx("feFlood",{floodColor:"rgba(0,0,0,0.2)",result:"bottom"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"top"}),e.jsx("feMergeNode",{in:"bottom"}),e.jsx("feMergeNode",{})]})]})]}),e.jsx("circle",{cx:N,cy:N,r:he-28,fill:"url(#ringGlow)",stroke:"rgba(255,225,228,0.8)",strokeWidth:1.2,filter:"url(#circleDepthShadow)"}),S&&e.jsx("line",{x1:De,y1:yt,x2:Se,y2:Ie,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(H.g,{transition:{type:"tween",duration:.18,ease:[.2,.8,.2,1]},initial:!1,animate:L.current?{rotate:-Oe}:!1,style:{transformOrigin:"center",transformBox:"view-box",willChange:"transform"},children:We.map((n,d)=>e.jsxs("g",{children:[e.jsx("g",{filter:n.isActive?"url(#activePointHighlight)":n.isToday?"url(#bevel)":void 0,children:e.jsx(H.circle,{cx:n.x,cy:n.y,r:n.isToday?12:11,fill:n.colors.pattern||(n.isActive?n.colors.main:"rgba(255,255,255,0.001)"),stroke:n.colors.border&&n.colors.border!=="none"?n.colors.border:"rgba(255,255,255,0.3)",strokeWidth:n.colors.border&&n.colors.border!=="none"?n.isToday?2.2:1.2:0,filter:n.fertilitysymbol==="white"?"url(#whiteSymbolShadow)":n.isActive?"url(#dotShadow)":void 0,strokeLinecap:"round",onClick:f=>Ae(n,f),initial:!1,whileTap:ze||!L.current?void 0:{y:2,scale:.75,opacity:.95,transition:{duration:.08,ease:"easeOut"}},style:{cursor:"pointer"}})}),!ze&&X.has(n.day)&&e.jsxs(H.g,{pointerEvents:"none",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{transformOrigin:`${n.x}px ${n.y}px`},children:[e.jsx(H.circle,{cx:n.x,cy:n.y-12,r:4,fill:n.colors.main,initial:{y:-18,scale:.5,opacity:0},animate:{y:[-18,0,2],scale:[.5,1.05,.8],opacity:[0,1,0]},transition:{duration:.6,ease:"easeOut",times:[0,.6,1]}}),e.jsx(H.circle,{cx:n.x,cy:n.y,r:n.isToday?12:10,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:2,fill:"none",initial:{scale:.5,opacity:.9},animate:{scale:1.4,opacity:0},transition:{duration:.55,ease:[.16,1,.3,1],delay:.05}}),e.jsx(H.circle,{cx:n.x,cy:n.y,r:n.isToday?14:12,stroke:n.colors.border==="none"?n.colors.main:n.colors.border||n.colors.main,strokeWidth:1.5,fill:"none",initial:{scale:.6,opacity:.6},animate:{scale:1.9,opacity:0},transition:{duration:.9,ease:"easeOut",delay:.1}})]},`dot-splash-${n.day}`),n.isToday&&e.jsx("circle",{cx:n.x,cy:n.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}})]},d))}),We.map((n,d)=>{if(!n.peakStatus)return null;const{x:f,y:p}=Je(n.x,n.y);return n.peakStatus==="P"?e.jsx("text",{x:f,y:p+4,textAnchor:"middle",fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none"},children:"✖"}):e.jsx("text",{x:f,y:p+4,textAnchor:"middle",fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:n.peakStatus})})]}),te&&e.jsx("div",{onClick:n=>n.stopPropagation(),children:e.jsx(Ws,{point:te,position:q,chartWidth:Fe.current?.clientWidth||0,chartHeight:Fe.current?.clientHeight||0,onEdit:i,onClose:()=>ae(null),onTogglePeak:T,currentPeakIsoDate:$})}),e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:e.jsxs(H.div,{className:"flex flex-col items-center gap-2",initial:{opacity:0},animate:{opacity:1},transition:{duration:.1,delay:.1,ease:"easeOut"},children:[e.jsx("div",{className:"flex items-center justify-center ",children:e.jsx("p",{className:"text-6xl font-semibold text-fertiliapp-fuerte leading-none",children:x.currentDay})}),e.jsx("p",{className:"mt-1 text-[15px] font-medium uppercase tracking-wide text-fertiliapp-fuerte",children:"DÍA DEL CICLO"})]})})]}),S&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full text-fertiliapp-fuerte shadow-xs transition hover:border hover:bg-fertiliapp-fuerte/20",onClick:()=>me(-1),disabled:R===0,children:e.jsx(Xs,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-fertiliapp-fuerte",children:["Día ",R+1]}),e.jsx("span",{className:"text-xs text-fertiliapp-fuerte",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-fertiliapp-fuerte",children:["Día ",Math.min(R+se,kt)]})]}),e.jsx("input",{type:"range",min:0,max:oe,value:R,onChange:n=>le(de(Number(n.target.value))),className:"w-40 range-fertiliapp"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full text-fertiliapp-fuerte shadow-xs transition hover:border hover:bg-fertiliapp-fuerte/20",onClick:()=>fe(1),disabled:R===oe,children:e.jsx(na,{className:"w-4 h-4"})})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0 items-start",children:[e.jsxs(H.div,{className:`relative overflow-hidden rounded-3xl bg-white/60 border border-secundario-suave shadow-[0_14px_35px_rgba(148,163,184,0.18)] backdrop-blur-md p-1 transition-[width] duration-300 ease-in-out mx-auto ${E?"w-full":"w-[80%]"}`,initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.2,delay:.1},children:[e.jsxs("button",{type:"button",onClick:()=>Le(n=>!n),className:"group flex w-full items-center justify-between gap-3 rounded-2xl px-3 py-2 text-left transition",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-700 tracking-tight uppercase",children:"SÍMBOLOS"}),e.jsx("div",{className:"absolute top-4.5 right-4 w-1.5 h-1.5 bg-secundario rounded-full"})]}),e.jsx(Ea,{initial:!1,children:E&&e.jsx(H.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},className:"grid grid-cols-2 gap-2.5 rounded-3xl bg-white/40 p-2 overflow-hidden",children:[{label:"Menstrual",color:"#fb7185"},{label:"Moco (Fértil)",color:"#fdf5f8",stroke:"#fb7185"},{label:"Seco",color:"#67C5A4"},{label:"Moco (No fértil)",color:"#F7B944"},{label:"Spotting",color:"#fb7185",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(n=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[n.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-5 h-5 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-5 h-5 rounded-full border ${n.pattern?"pattern-bg":""}`,style:{backgroundColor:n.color,borderColor:n.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${n.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:n.label})]},n.label))},"symbols")})]}),e.jsxs(H.div,{className:`relative overflow-hidden rounded-3xl bg-white/60 border border-secundario-suave shadow-[0_14px_35px_rgba(148,163,184,0.18)] backdrop-blur-md p-1 transition-[width] duration-300 ease-in-out mx-auto ${$e?"w-full":"w-[80%]"}`,initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.2,delay:.1},children:[e.jsxs("button",{type:"button",onClick:()=>G(n=>!n),className:"group flex w-full items-center justify-between gap-3 rounded-2xl px-3 py-2 text-left transition",children:[e.jsx("span",{className:"text-sm font-semibold text-slate-800 tracking-tight uppercase",children:"CÁLCULO"}),e.jsx("div",{className:"absolute top-4.5 right-4 w-1.5 h-1.5 bg-secundario rounded-full"})]}),e.jsx(Ea,{initial:!1,children:$e&&e.jsxs(H.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},className:"grid grid-cols-2 gap-2.5 rounded-3xl bg-white/40 p-2 overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:Z,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (Ciclo más corto)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"Ciclo más corto"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:_e?.baseFormatted??"—"})})]}),e.jsxs("button",{type:"button",onClick:Z,className:"flex flex-col items-center gap-1.5","aria-label":"Editar CPM (resultado)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"CPM"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:_e?.finalFormatted??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:_e?.modeLabel??"Auto"})]}),e.jsxs("button",{type:"button",onClick:_,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (Día de subida)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"Día de subida"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/70 shadow-sm w-10 h-10 text-base font-bold text-rose-700",children:ee?.baseFormatted??"—"})})]}),e.jsxs("button",{type:"button",onClick:_,className:"flex flex-col items-center gap-1.5","aria-label":"Editar T-8 (resultado)",children:[e.jsx("span",{className:"flex items-center justify-center text-[10px] font-medium text-gray-700 leading-tight text-center h-8",children:"T-8"}),e.jsx("div",{className:"h-10 flex items-end",children:e.jsx("div",{className:"flex items-center justify-center rounded-full border border-rose-200/70 bg-white/80 shadow-sm w-10 h-10 text-sm font-semibold text-rose-700",children:ee?.finalFormatted??"—"})}),e.jsx("span",{className:"text-[9px] font-semibold text-rose-600 mt-0.5",children:ee?.modeLabel??"Auto"})]})]},"calc-card")})]})]})]})]})},nn=({onAddRecord:x,onAddCycle:i})=>{const[T,$]=a.useState(!1);return e.jsxs("div",{className:"fixed right-4 top-12 md:top-6 flex flex-col-reverse items-end space-y-2 z-50",children:[T&&e.jsxs("div",{className:"flex flex-col space-y-2 mt-1",children:[e.jsxs(H.button,{onClick:x,className:"flex items-center gap-1 px-4 h-10 rounded-full bg-fertiliapp-fuerte hover:brightness-50 text-white/90 shadow-sm shadow-[#DD5665]",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(244, 114, 182, 0.28))"},children:[e.jsx(qs,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]}),e.jsxs(H.button,{onClick:i,className:"flex items-center gap-3 px-4 h-10 rounded-full bg-white/80 hover:brightness-50 text-fertiliapp-fuerte shadow-sm shadow-[#DD5665]",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(244, 114, 182, 0.2))"},children:[e.jsx(Ks,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]})]}),e.jsx(H.button,{onClick:()=>$(!T),className:"flex items-center justify-center rounded-full bg-white/80 border border-fertiliapp-fuerte text-fertiliapp-fuerte hover:brightness-95 shadow-sm shadow-[#5BA9B8] w-12 h-12 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300 focus-visible:ring-offset-2",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 4px 12px rgba(221, 86, 101, 0.35))"},children:e.jsx(H.span,{animate:{rotate:T?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(Ys,{className:"h-5 w-5"})})})]})},yn=()=>{const x=Ps(),{currentCycle:i,archivedCycles:T,addOrUpdateDataPoint:$,startNewCycle:Re,isLoading:Z,updateCycleDates:_,checkCycleOverlap:_e,previewUpdateCycleDates:ee,previewStartNewCycle:O,refreshData:te,setCycleIgnoreForAutoCalculations:ae,undoCurrentCycle:q,previewUndoCurrentCycle:ne}=zs(),{toast:E}=$s(),[Le,$e]=a.useState(!1),[G,A]=a.useState(()=>i?.startDate||""),[Ne,L]=a.useState(""),[xe,Fe]=a.useState(null),[Ft,qe]=a.useState(null),[ze,re]=a.useState(null),[Ht,xt]=a.useState(!1),[se,he]=a.useState(!1),{user:D,preferences:N,savePreferences:B}=Os(),[kt,oe]=a.useState(!1),[S,Ge]=a.useState(""),[R,le]=a.useState(""),[de,me]=a.useState(""),[we,Q]=a.useState(""),[fe,Qe]=a.useState(null),[z,pe]=a.useState(null),[J,je]=a.useState(null),[V,ke]=a.useState(!1),[ie,We]=a.useState("auto"),[X,Oe]=a.useState("auto"),[ht,He]=a.useState(!1),[bt,Je]=a.useState(!1),[It,Ve]=a.useState(!1),[Tt,Ze]=a.useState(!1),[De,yt]=a.useState(""),[Se,Ie]=a.useState(""),[Ae,n]=a.useState(""),[d,f]=a.useState(""),[p,v]=a.useState(null),[j,M]=a.useState(null),[k,Me]=a.useState(null),[U,Te]=a.useState(!1),[W,Xe]=a.useState("auto"),[Y,et]=a.useState("auto"),[oa,Jt]=a.useState(!1),[Ra,gt]=a.useState(!1),[la,Xt]=a.useState(!1),[ia,ca]=a.useState([]),[_a,Et]=a.useState(!1),[La,Yt]=a.useState(!1),[Kt,ua]=a.useState(null),[qt,Pt]=a.useState(!1),tt=a.useRef(!1),at=a.useRef(!1),Gt=a.useRef(null),da=a.useRef(!1),ma=a.useRef(!1),be=a.useMemo(()=>D?.uid?`rnf_manual_cpm_${D.uid}`:null,[D?.uid]),ye=a.useMemo(()=>D?.uid?`rnf_manual_cpm_base_${D.uid}`:null,[D?.uid]),ge=a.useMemo(()=>D?.uid?`rnf_manual_t8_${D.uid}`:null,[D?.uid]),ve=a.useMemo(()=>D?.uid?`rnf_manual_t8_base_${D.uid}`:null,[D?.uid]),st=a.useMemo(()=>{if(!i?.id||i?.endDate||!i?.startDate)return null;const t=ue(i.startDate);if(!ta(t))return null;const s=Ke(Aa(t,-1),"yyyy-MM-dd"),o=T.filter(r=>r?.endDate===s);return o.length?o.sort((r,c)=>(c.startDate||"").localeCompare(r.startDate||""))[0]:null},[T,i]),Qt=a.useMemo(()=>{if(!st?.startDate||!st?.endDate)return"";const t=ue(st.startDate),s=ue(st.endDate);if(!ta(t)||!ta(s))return"";const o=r=>Ke(r,"dd MMM yy",{locale:aa}).replace(".","");return`${o(t)} - ${o(s)}`},[st]),za=a.useMemo(()=>`¿Quieres unir el ciclo actual al ciclo anterior${Qt?` (${Qt})`:""}? Esta acción no se puede deshacer.`,[Qt]),vt=a.useCallback(async t=>{if(!(!D?.uid||!B)&&["auto","manual","none"].includes(t))try{await B({cpmMode:t})}catch(s){console.error("Failed to persist CPM mode",s)}},[B,D?.uid]),Ct=a.useCallback(async t=>{if(!(!D?.uid||!B)&&["auto","manual","none"].includes(t))try{await B({t8Mode:t})}catch(s){console.error("Failed to persist T-8 mode",s)}},[B,D?.uid]);a.useEffect(()=>{tt.current=!1},[be]),a.useEffect(()=>{at.current=!1},[ge]),a.useEffect(()=>{if(!ye){pe(null);return}const t=N?.manualCpmBase;if(t!==void 0){if(typeof t=="number"&&Number.isFinite(t)){if(pe(t),typeof window<"u")try{localStorage.setItem(ye,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual CPM base value to local storage",s)}}else if(pe(null),typeof window<"u")try{localStorage.removeItem(ye)}catch(s){console.error("Failed to clear manual CPM base value from local storage",s)}return}if(!(typeof window>"u"))try{const s=localStorage.getItem(ye);if(s){const o=JSON.parse(s);o&&typeof o.value=="number"&&Number.isFinite(o.value)?pe(o.value):pe(null)}else pe(null)}catch(s){console.error("Failed to restore manual CPM base value from local storage",s)}},[ye,N?.manualCpmBase]),a.useEffect(()=>{if(!ve){M(null);return}const t=N?.manualT8Base;if(t!==void 0){if(typeof t=="number"&&Number.isFinite(t)){if(M(t),typeof window<"u")try{localStorage.setItem(ve,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual T-8 base value to local storage",s)}}else if(M(null),typeof window<"u")try{localStorage.removeItem(ve)}catch(s){console.error("Failed to clear manual T-8 base value from local storage",s)}return}if(!(typeof window>"u"))try{const s=localStorage.getItem(ve);if(s){const o=JSON.parse(s);o&&typeof o.value=="number"&&Number.isFinite(o.value)?M(o.value):M(null)}else M(null)}catch(s){console.error("Failed to restore manual T-8 base value from local storage",s)}},[ve,N?.manualT8Base]);const nt=a.useCallback(async({finalValue:t,baseValue:s})=>{if(!D?.uid||!B)return;const o=t==null?null:Number(t),r=s===void 0?void 0:s==null?null:Number(s),c={manualCpm:o};r!==void 0&&(c.manualCpmBase=r);try{await B(c),be&&typeof window<"u"&&(c.manualCpm===null?localStorage.removeItem(be):localStorage.setItem(be,JSON.stringify({value:c.manualCpm}))),r!==void 0&&ye&&typeof window<"u"&&(r===null?localStorage.removeItem(ye):localStorage.setItem(ye,JSON.stringify({value:r}))),await sa(D.uid,{manual:{cpm:{value:o,base:r===void 0?z:r}},manualUpdatedAt:new Date().toISOString()})}catch(l){throw console.error("Failed to persist manual CPM value in profile",l),l}},[ye,z,be,B,D?.uid]),rt=a.useCallback(async({finalValue:t,baseValue:s})=>{if(!D?.uid||!B)return;const o=t==null?null:Number(t),r=s===void 0?void 0:s==null?null:Number(s),c={manualT8:o};r!==void 0&&(c.manualT8Base=r);try{await B(c),ge&&typeof window<"u"&&(c.manualT8===null?localStorage.removeItem(ge):localStorage.setItem(ge,JSON.stringify({value:c.manualT8}))),r!==void 0&&ve&&typeof window<"u"&&(r===null?localStorage.removeItem(ve):localStorage.setItem(ve,JSON.stringify({value:r}))),await sa(D.uid,{manual:{t8:{value:o,riseDay:r===void 0?j:r}},manualUpdatedAt:new Date().toISOString()})}catch(l){throw console.error("Failed to persist manual T-8 value in profile",l),l}},[ve,j,ge,B,D?.uid]);a.useEffect(()=>{if(!be){je(null),ke(!1),tt.current=!1;return}const t=N?.manualCpm;if(typeof t=="number"&&Number.isFinite(t)){if(je(t),ke(!0),typeof window<"u")try{localStorage.setItem(be,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual CPM value to local storage",s)}return}if(t===null&&(je(null),ke(!1),typeof window<"u"))try{localStorage.removeItem(be)}catch(s){console.error("Failed to clear manual CPM value from local storage",s)}},[be,N?.manualCpm]),a.useEffect(()=>{if(!ge){Me(null),Te(!1),at.current=!1;return}const t=N?.manualT8;if(typeof t=="number"&&Number.isFinite(t)){if(Me(t),Te(!0),typeof window<"u")try{localStorage.setItem(ge,JSON.stringify({value:t}))}catch(s){console.error("Failed to sync manual T-8 value to local storage",s)}return}if(t===null&&(Me(null),Te(!1),typeof window<"u"))try{localStorage.removeItem(ge)}catch(s){console.error("Failed to clear manual T-8 value from local storage",s)}},[ge,N?.manualT8]),a.useEffect(()=>{if(!be||tt.current||!D?.uid)return;if(N?.manualCpm!==void 0){tt.current=!0;return}if(typeof window>"u"){tt.current=!0;return}try{const s=localStorage.getItem(be);if(s){const o=JSON.parse(s);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){je(o.value),ke(!0);let r=z;try{if(ye){const c=localStorage.getItem(ye);if(c){const l=JSON.parse(c);l&&typeof l.value=="number"&&Number.isFinite(l.value)?r=l.value:r=null}}}catch(c){console.error("Failed to read manual CPM base value from local storage",c)}pe(typeof r=="number"&&Number.isFinite(r)?r:null),nt({finalValue:o.value,baseValue:r}).catch(c=>console.error("Failed to migrate manual CPM value to profile storage",c))}}}catch(s){console.error("Failed to restore manual CPM value from local storage",s)}finally{tt.current=!0}},[ye,z,be,nt,N?.manualCpm,D?.uid]),a.useEffect(()=>{if(!ge||at.current||!D?.uid)return;if(N?.manualT8!==void 0){at.current=!0;return}if(typeof window>"u"){at.current=!0;return}try{const s=localStorage.getItem(ge);if(s){const o=JSON.parse(s);if(o&&typeof o.value=="number"&&Number.isFinite(o.value)){Me(o.value),Te(!0);let r=j;try{if(ve){const c=localStorage.getItem(ve);if(c){const l=JSON.parse(c);l&&typeof l.value=="number"&&Number.isFinite(l.value)?r=l.value:r=null}}}catch(c){console.error("Failed to read manual T-8 base value from local storage",c)}M(typeof r=="number"&&Number.isFinite(r)?r:null),rt({finalValue:o.value,baseValue:r}).catch(c=>console.error("Failed to migrate manual T-8 value to profile storage",c))}}}catch(s){console.error("Failed to restore manual T-8 value from local storage",s)}finally{at.current=!0}},[ve,j,ge,rt,N?.manualT8,D?.uid]),a.useEffect(()=>{A(i?.startDate||"")},[i?.startDate]);const Zt=a.useCallback(t=>{if(!t?.startDate)return null;try{const s=ue(t.startDate);if(Number.isNaN(s.getTime()))return null;const o=Ke(s,"dd/MM/yyyy",{locale:aa});if(!t.endDate)return`${o} - En curso`;const r=ue(t.endDate);if(Number.isNaN(r.getTime()))return o;const c=Ke(r,"dd/MM/yyyy",{locale:aa});return`${o} - ${c}`}catch{return null}},[]),$t=a.useMemo(()=>{const t=[];if(Array.isArray(T)&&T.length>0&&T.forEach((s,o)=>{const r=Zt(s);t.push({...s,displayName:s.name||r||`Ciclo archivado ${o+1}`,dateRangeLabel:r,source:"archived",ignoredForAutoCalculations:!!s.ignoredForAutoCalculations})}),i?.id){const s=Zt(i);t.push({...i,displayName:i.name||s||"Ciclo actual",dateRangeLabel:s,source:"current",ignoredForAutoCalculations:!!i.ignoredForAutoCalculations})}return t},[T,i,Zt]),C=a.useMemo(()=>{const o=[...$t.map(u=>{if(!u.startDate||!u.endDate)return null;try{const w=ue(u.startDate),F=ue(u.endDate);if(Number.isNaN(w.getTime())||Number.isNaN(F.getTime())||Ba(w,F))return null;const m=St(Mt(F),Mt(w))+1;return!Number.isFinite(m)||m<=0?null:{...u,duration:m,ignoredForAutoCalculations:!!u.ignoredForAutoCalculations}}catch(w){return console.error("Failed to compute cycle duration for CPM calculation",w),null}}).filter(Boolean)].sort((u,w)=>{const F=typeof u.duration=="number"&&Number.isFinite(u.duration)?u.duration:Number.POSITIVE_INFINITY,m=typeof w.duration=="number"&&Number.isFinite(w.duration)?w.duration:Number.POSITIVE_INFINITY;return F-m}).map(u=>{const w=!!u.ignoredForAutoCalculations;return{...u,isIgnored:w,isIncluded:!w}}),r=o.filter(u=>u.isIncluded),c=o.length-r.length,l=r.length;if(l<6)return{value:null,cycleCount:l,shortestCycle:null,deduction:null,canCompute:!1,cyclesConsidered:o,ignoredCount:c};const h=r[0]??null,g=l>=12?20:21,y=typeof h?.duration=="number"&&Number.isFinite(h.duration)?Math.max(1,h.duration-g):null;return{value:y,cycleCount:l,shortestCycle:h,deduction:g,canCompute:y!==null,cyclesConsidered:o,ignoredCount:c}},[$t]),b=a.useMemo(()=>{const t=m=>{if(m==null||m==="")return null;const I=Number.parseFloat(String(m).replace(",","."));return Number.isFinite(I)?I:null},s=m=>{if(!m)return null;const I=t(m.temperature),P=t(m.temperature_corrected);return m.use_corrected&&P!==null?P:I!==null?I:P!==null?P:null},o=m=>{const I=[m?.temperature_chart,m?.temperature_raw,m?.temperature_corrected];for(const P of I){const ce=t(P);if(ce!==null)return ce}if(Array.isArray(m?.measurements)){const ce=m.measurements.find(Pe=>Pe&&Pe.selected&&s(Pe)!==null)||m.measurements.find(Pe=>s(Pe)!==null);if(ce){const Pe=s(ce);if(Pe!==null)return Pe}}return null},r=m=>{if(!m)return null;try{const I=ue(m);return Number.isNaN(I.getTime())?null:I}catch{return null}},c=$t.filter(m=>m&&m.startDate&&Array.isArray(m.data)&&m.data.length>0).sort((m,I)=>{const P=r(m.startDate),ce=r(I.startDate);return!P&&!ce?0:P?ce?ce-P:-1:1}),l=[],h=[];for(const m of c){const I=m.data.filter(Dt=>Dt&&Dt.isoDate).map(Dt=>({...Dt,displayTemperature:o(Dt)}));if(I.length===0)continue;const{ovulationDetails:P}=Vs(I);if(!P?.confirmed)continue;const ce=Number.isInteger(P?.ovulationIndex)?P.ovulationIndex:Number.isInteger(P?.confirmationIndex)?P.confirmationIndex:null;if(ce==null||ce<0||ce>=I.length)continue;const Pe=I[ce],Bt=Number(Pe?.cycleDay);if(!Number.isFinite(Bt)||Bt<=0)continue;const Ss=Math.max(1,Bt-8),Rt=!!m.ignoredForAutoCalculations,Fa={cycleId:m.id,riseDay:Bt,t8Day:Ss,displayName:m.displayName||m.name||"Ciclo sin nombre",dateRangeLabel:m.dateRangeLabel,isIgnored:Rt,isIncluded:!Rt,ignoredForAutoCalculations:Rt};l.push(Fa),!Rt&&h.length<12&&h.push(Fa)}const g=h.length,y=l.reduce((m,I)=>m+(I.isIgnored?1:0),0);if(g===0)return{value:null,cycleCount:g,earliestCycle:null,cyclesConsidered:l,canCompute:!1,rawValue:null,ignoredCount:y};const u=h.reduce((m,I)=>I.t8Day<m.t8Day?I:m),w=u.t8Day,F=g>=6;return{value:F?w:null,cycleCount:g,earliestCycle:u,cyclesConsidered:l,canCompute:F,rawValue:w,ignoredCount:y}},[$t]);a.useEffect(()=>{if(da.current||!N)return;let t=N?.cpmMode;["auto","manual","none"].includes(t)||(t=V?"manual":C.canCompute?"auto":"none"),We(t),Oe(t),da.current=!0},[C.canCompute,V,N]),a.useEffect(()=>{if(ma.current||!N)return;let t=N?.t8Mode;["auto","manual","none"].includes(t)||(t=U?"manual":b.canCompute?"auto":"none"),Xe(t),et(t),ma.current=!0},[b.canCompute,U,N]),a.useEffect(()=>{if(!D?.uid){Gt.current=null;return}const t=l=>typeof l=="number"&&Number.isFinite(l)?l:null,s=l=>l?{id:l.id??null,name:l.name??null,displayName:l.displayName??null,startDate:l.startDate??null,endDate:l.endDate??null,duration:t(l.duration),source:l.source??null,dateRangeLabel:l.dateRangeLabel??null}:null,o=l=>l?{id:l.id??null,name:l.name??null,displayName:l.displayName??null,startDate:l.startDate??null,endDate:l.endDate??null,riseDay:t(l.riseDay),t8Day:t(l.t8Day),source:l.source??null,dateRangeLabel:l.dateRangeLabel??null}:null,r={automatic:{cpm:{value:t(C?.value),cycleCount:t(C?.cycleCount)??0,ignoredCount:t(C?.ignoredCount)??0,deduction:t(C?.deduction),canCompute:!!C?.canCompute,shortestCycle:s(C?.shortestCycle)},t8:{value:t(b?.value),cycleCount:t(b?.cycleCount)??0,ignoredCount:t(b?.ignoredCount)??0,canCompute:!!b?.canCompute,riseDay:t(b?.earliestCycle?.riseDay),earliestCycle:o(b?.earliestCycle)}}},c=JSON.stringify(r);Gt.current!==c&&(Gt.current=c,sa(D.uid,{...r,automaticUpdatedAt:new Date().toISOString()}).catch(l=>{console.error("Failed to persist automatic metrics snapshot",l)}))},[C,b,D?.uid]);const K=a.useMemo(()=>{const t=C.cycleCount??0,s=`${t} ciclo${t===1?"":"s"}`,o=6,r=["auto","manual","none"].includes(ie)?ie:"auto",c=r==="manual"&&V?"Manual":r==="auto"&&C.canCompute?"Automático":r==="none"?"Sin usar":"Automático",l=C.cyclesConsidered??[],h=!!C.canCompute,g=C.ignoredCount??0,y=typeof C.deduction=="number"&&Number.isFinite(C.deduction)?C.deduction:null,u=C.shortestCycle??null,w=typeof C.value=="number"&&Number.isFinite(C.value)?C.value:null;let F;if(t===0)F=g>0?"Todos los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos finalizados con fecha de finalización.";else if(!h)F=`Hay ${s} finalizado${t===1?"":"s"}. Se necesitan ${o} para calcular el CPM automáticamente.`,g>0&&(F+=` (${g} ciclo${g===1?"":"s"} ignorado${g===1?"":"s"}).`);else{const m=u?.dateRangeLabel||u?.displayName||u?.name||"Ciclo sin nombre",I=typeof u?.duration=="number"&&Number.isFinite(u.duration)?`${u.duration} días`:"duración desconocida",P=[`Calculado con ${s}.`,`Ciclo más corto: ${m} (${I}).`];y!==null&&P.push(`Deducción aplicada: ${y} días.`),w!==null&&P.push(`Resultado: ${w} días.`),g>0&&P.push(`${g} ciclo${g===1?"":"s"} ignorado${g===1?"":"s"}.`),F=P.join(" ")}return{sourceLabel:c,summary:F,highlightLabel:s,cycleCount:t,requiredCycles:o,canCompute:h,detailsAvailable:l.length>0,cycles:l,deduction:y,shortestCycle:u,value:w,ignoredCount:g}},[C,ie,V]),ea=a.useMemo(()=>{const t=b.cycleCount,s=`${t} ciclo${t===1?"":"s"}`,o=6,r=["auto","manual","none"].includes(W)?W:"auto",c=r==="manual"&&U?"Manual":r==="auto"&&b.canCompute?"Automático":r==="none"?"Sin usar":"Automático",l=b.ignoredCount??0,h=b.earliestCycle?.displayName||b.earliestCycle?.name||"Ciclo sin nombre",g=b.earliestCycle?.riseDay,y=typeof g=="number"&&Number.isFinite(g)?`Día ${g}`:"día desconocido",u=b.earliestCycle?.t8Day,w=typeof u=="number"&&Number.isFinite(u)?`T-8 Día ${u}`:null;let F;if(t===0)F=l>0?"Los ciclos disponibles están ignorados para el cálculo automático.":"Aún no hay ciclos con ovulación confirmada por temperatura.";else if(!b.canCompute)F=`Hay ${s} con ovulación confirmada por temperatura (se necesitan ${o}).`,l>0&&(F+=` ${l} ciclo${l===1?"":"s"} ignorado${l===1?"":"s"}.`);else{const m=[`${h} (${y}${w?` → ${w}`:""}).`];l>0&&m.push(`${l} ciclo${l===1?"":"s"} ignorado${l===1?"":"s"}.`),F=m.join(" ")}return{sourceLabel:c,summary:F,highlightLabel:s,cycleCount:t,requiredCycles:o,ignoredCount:l}},[b,U,W]),Ue=a.useCallback((t,s)=>typeof t!="number"||!Number.isFinite(t)?null:t.toLocaleString("es-ES",s),[]),Va=a.useMemo(()=>tn({computedCpmData:C,cpmSelection:ie,isManualCpm:V,manualCpmBaseValue:z,manualCpmValue:J,formatNumber:Ue}),[C,ie,Ue,V,z,J]),Ua=a.useMemo(()=>an({computedT8Data:b,t8Selection:W,isManualT8:U,manualT8BaseValue:j,manualT8Value:k,formatNumber:Ue}),[b,Ue,U,j,k,W]),Wa=Ue(K.value,{maximumFractionDigits:1})??(typeof K.value=="number"&&Number.isFinite(K.value)?`${K.value}`:"—");Ue(J,{maximumFractionDigits:1})??(typeof J=="number"&&Number.isFinite(J)&&`${J}`);const fa=["auto","manual","none"].includes(ie)?ie:"auto",ot=fa==="manual"?V?"manual":"none":fa==="auto"?"auto":"none";ot==="manual"||ot==="auto"&&C.canCompute;const Ha=ot==="manual"?"Manual":ot==="auto"?"Automático":"Sin usar",Ja=Ue(b.value,{maximumFractionDigits:0})??(typeof b.value=="number"&&Number.isFinite(b.value)?`${b.value}`:"—");Ue(k,{maximumFractionDigits:0})??(typeof k=="number"&&Number.isFinite(k)&&`${k}`);const pa=["auto","manual","none"].includes(W)?W:"auto",lt=pa==="manual"?U?"manual":"none":pa==="auto"?"auto":"none";lt==="manual"||lt==="auto"&&b.canCompute;const Xa=lt==="manual"?"Manual":lt==="auto"?"Automático":"Sin usar";a.useMemo(()=>fe||(R.trim()?"final":S.trim()?"base":null),[S,fe,R]);const xa=a.useMemo(()=>{if(X==="manual"){if(de||we)return!0;const t=S.trim()!==""&&!de,s=R.trim()!==""&&!we;return!t&&!s}return!1},[X,de,S,we,R]),Ya=a.useMemo(()=>!!(V||S.trim()||R.trim()),[V,S,R]);a.useMemo(()=>p||(Se.trim()?"final":De.trim()?"base":null),[De,p,Se]);const ha=a.useMemo(()=>{if(Y==="manual"){if(Ae||d)return!0;const t=De.trim()!==""&&!Ae,s=Se.trim()!==""&&!d;return!t&&!s}return!1},[Ae,De,d,Se,Y]),Ka=a.useMemo(()=>!!(U||De.trim()||Se.trim()),[U,De,Se]),ba=a.useCallback(t=>{if(!t)return;const s=t.cycleId||t.id;if(s){if(i?.id&&s===i.id){x("/");return}x(`/cycle/${s}`)}},[i?.id,x]),ya=a.useCallback(async(t,s)=>{if(t){ca(o=>o.includes(t)?o:[...o,t]);try{await ae(t,s),E({title:s?"Ciclo ignorado":"Ciclo incluido",description:s?"El ciclo se excluyó del cálculo automático.":"El ciclo se volvió a incluir en el cálculo automático."})}catch{}finally{ca(o=>o.filter(r=>r!==t))}}},[ae,E]),it=a.useCallback((t,s)=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),s())},[]),qa=a.useCallback(()=>{const t=typeof C.shortestCycle?.duration=="number"&&Number.isFinite(C.shortestCycle.duration)?C.shortestCycle.duration:null,s=typeof C.value=="number"&&Number.isFinite(C.value)?C.value:null,o=typeof z=="number"&&Number.isFinite(z),r=typeof J=="number"&&Number.isFinite(J),c=V&&o?z:t,l=V&&r?J:s;Ge(typeof c=="number"&&Number.isFinite(c)?String(c):""),le(typeof l=="number"&&Number.isFinite(l)?String(l):""),me(""),Q(""),Qe(null),Oe(ie),He(!1),oe(!0)},[C,ie,V,z,J]),Ot=a.useCallback(()=>{He(!1),Je(!1),Ve(!1),oe(!1)},[]),Ga=a.useCallback(t=>{const{value:s}=t.target;if(Ge(s),Qe("base"),me(""),Q(""),!s.trim()){le("");return}const o=Number.parseInt(s,10);if(!Number.isFinite(o)){me("El ciclo más corto debe ser ≥ 1"),le("");return}if(o<1){me("El día de subida debe ser ≥ 1"),le("");return}const r=Math.max(1,o-ra);le(String(r))},[]),Qa=a.useCallback(t=>{const{value:s}=t.target;if(le(s),Qe("final"),Q(""),me(""),!s.trim())return;const o=s.replace(",","."),r=Number.parseFloat(o);if(!Number.isFinite(r)){Q("Introduce un número válido.");return}if(r<1){Q("El CPM debe ser ≥ 1");return}},[]),ga=a.useCallback(async()=>{if(de||we)return!1;const t=S.trim(),s=R.trim(),o=fe??(s?"final":t?"base":null);if(!o)return Q("Introduce un valor."),!1;let r=z,c;if(o==="base"){if(!t)return me("Introduce un número entero válido."),!1;const y=Number.parseInt(t,10);if(!Number.isFinite(y))return me("Introduce un número entero válido."),!1;const u=Math.max(1,y-ra);r=y,c=u,le(String(u)),Q("")}else{if(!s)return Q("Introduce un valor."),!1;const y=s.replace(",","."),u=Number.parseFloat(y);if(!Number.isFinite(u)||u<1)return Q("El CPM debe ser ≥ 1 día"),!1;if(c=u,!t)r=null;else{const w=Number.parseInt(t,10);if(!Number.isFinite(w)||w<1)return me("Introduce un número entero válido."),!1;r=w}}const l=J,h=V,g=z;je(c),ke(!0),pe(typeof r=="number"&&Number.isFinite(r)?r:null);try{return await nt({finalValue:c,baseValue:r}),oe(!1),E({title:"CPM actualizado",description:"El CPM manual se guardó en tu perfil."}),!0}catch(y){return console.error("Failed to save manual CPM value",y),je(l),pe(g),ke(h),Q("No se pudo guardar el CPM. Inténtalo de nuevo."),!1}},[V,de,S,z,fe,we,R,J,nt,E]),va=a.useCallback(async()=>{const t=J,s=V,o=z;je(null),pe(null),ke(!1),Ge(""),le(""),me(""),Q(""),Qe(null);try{await nt({finalValue:null,baseValue:null}),E({title:"CPM borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(r){console.error("Failed to delete manual CPM value",r),je(t),pe(o),ke(s),Q("No se pudo borrar el CPM. Inténtalo de nuevo.")}},[V,z,J,nt,E]),Za=a.useCallback(async()=>{Ve(!0);try{await va(),Je(!1);const t=K.canCompute?"auto":"none";We(t),Oe(t),await vt(t)}finally{Ve(!1)}},[K.canCompute,va,vt]),ct=a.useCallback(t=>{Oe(t)},[]),es=a.useCallback(async()=>{const t=X;if(t==="manual"){if(!await ga())return;We("manual"),Oe("manual"),await vt("manual");return}const s=["auto","none"].includes(t)?t:"auto";We(s),Oe(s),await vt(s),Ot()},[X,Ot,ga,vt]),ts=a.useCallback(()=>{const t=typeof j=="number"&&Number.isFinite(j),s=typeof k=="number"&&Number.isFinite(k),o=U&&t?j:null,r=U&&s?k:null;yt(typeof o=="number"&&Number.isFinite(o)?String(o):""),Ie(typeof r=="number"&&Number.isFinite(r)?String(r):""),n(""),f(""),v(null),et(W),Jt(!1),Ze(!0)},[U,j,k,W]),At=a.useCallback(()=>{Ze(!1),Jt(!1),gt(!1),Xt(!1)},[]),as=a.useCallback(t=>{const{value:s}=t.target;if(yt(s),v("base"),n(""),f(""),!s.trim()){Ie("");return}const o=Number.parseInt(s,10);if(!Number.isFinite(o)){n("Introduce un número entero válido."),Ie("");return}if(o<1){n("Introduce un número entero válido."),Ie("");return}const r=Math.max(1,o-8);Ie(String(r))},[]),ss=a.useCallback(t=>{const{value:s}=t.target;if(Ie(s),v("final"),f(""),n(""),!s.trim())return;const o=Number.parseInt(s,10);(!Number.isFinite(o)||o<1)&&f("El T-8 debe ser ≥ 1")},[]),Ca=a.useCallback(async()=>{if(Ae||d)return!1;const t=De.trim(),s=Se.trim(),o=p??(s?"final":t?"base":null);if(!o)return f("Introduce un valor."),!1;let r=j,c;if(o==="base"){if(!t)return n("Introduce un número entero válido."),!1;const y=Number.parseInt(t,10);if(!Number.isFinite(y)||y<1)return n("Introduce un número entero válido."),!1;const u=Math.max(1,y-8);r=y,c=u,Ie(String(u)),f("")}else{if(!s)return f("Introduce un valor."),!1;const y=Number.parseInt(s,10);if(!Number.isFinite(y)||y<1)return f("El T-8 debe ser ≥ 1"),!1;if(c=y,!t)r=null;else{const u=Number.parseInt(t,10);if(!Number.isFinite(u)||u<1)return n("Introduce un número entero válido."),!1;r=u}}const l=k,h=U,g=j;Me(c),Te(!0),M(typeof r=="number"&&Number.isFinite(r)?r:null);try{return await rt({finalValue:c,baseValue:r}),Ze(!1),E({title:"T-8 actualizado",description:"El T-8 manual se guardó en tu perfil."}),!0}catch(y){return console.error("Failed to save manual T-8 value",y),Me(l),M(g),Te(h),f("No se pudo guardar el T-8. Inténtalo de nuevo."),!1}},[U,Ae,De,j,p,d,Se,k,rt,E]),Na=a.useCallback(async()=>{const t=k,s=U,o=j;Me(null),M(null),Te(!1),yt(""),Ie(""),n(""),f(""),v(null);try{await rt({finalValue:null,baseValue:null}),E({title:"T-8 borrado",description:"El valor manual se eliminó. Puedes guardar un nuevo valor o continuar con el cálculo automático."})}catch(r){console.error("Failed to delete manual T-8 value",r),Me(t),M(o),Te(s),n("No se pudo borrar el T-8. Inténtalo de nuevo.")}},[U,j,k,rt,E]),ns=a.useCallback(async()=>{Xt(!0);try{await Na(),gt(!1);const t=b.canCompute?"auto":"none";Xe(t),et(t),await Ct(t)}finally{Xt(!1)}},[b.canCompute,Na,Ct]),ut=a.useCallback(t=>{et(t)},[]),rs=a.useCallback(async()=>{const t=Y;if(t==="manual"){if(!await Ca())return;Xe("manual"),et("manual"),await Ct("manual");return}const s=["auto","none"].includes(t)?t:"auto";Xe(s),et(s),await Ct(s),At()},[At,Ca,Ct,Y]),Be=a.useCallback(()=>{Fe(null),qe(null),xt(!1),re(null)},[]),os=a.useCallback(()=>{A(i?.startDate||""),L(""),Be(),$e(!0)},[i?.startDate,Be]),Ee=a.useCallback(()=>{$e(!1),L(""),Be(),A(i?.startDate||"")},[i?.startDate,Be]),ls=a.useCallback(async()=>{if(i?.id){try{const t=await ne(i.id);if(t){ua(t),Yt(!0);return}}catch(t){console.error("Failed to preview undo cycle",t);return}Pt(!0);try{await q(i.id),Et(!1),Ee()}catch(t){console.error("Failed to undo cycle",t)}finally{Pt(!1)}}},[i?.id,Ee,q,ne]),is=a.useCallback(async()=>{if(i?.id){Pt(!0);try{await q(i.id),Yt(!1),Et(!1),Ee()}catch(t){console.error("Failed to undo cycle",t)}finally{Pt(!1)}}},[i?.id,Ee,q]),cs=a.useCallback(()=>{Be()},[Be]),us=a.useCallback(async()=>{if(!G){L("La fecha de inicio es obligatoria");return}if(i?.id){L(""),he(!0);try{const t=ee?await ee(i.id,G):null;if(t){Fe(G),qe(null),re(t),xt(!0),he(!1);return}await _(i.id,G),await te({silent:!0}),Ee()}catch(t){console.error("Error updating start date from dashboard:",t),L("No se pudo actualizar la fecha de inicio"),E({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{he(!1)}}},[G,i?.id,ee,_,te,E,Ee]),ds=a.useCallback(async()=>{if(!i?.id||!xe){Be();return}he(!0),xt(!1);try{await _(i.id,xe),await te({silent:!0}),Ee()}catch(t){console.error("Error forcing start date from dashboard:",t),L("No se pudo actualizar la fecha de inicio"),E({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{he(!1),Be()}},[i?.id,xe,_,te,E,Ee,Be]),[ms,Ye]=a.useState(!1),[fs,wa]=a.useState(!1),[ja,dt]=a.useState(!1),[Da,Nt]=a.useState(!1),[wt,jt]=a.useState(null),[ps,mt]=a.useState(null),xs=!!(wt&&String(wt.id||"").startsWith("placeholder-")),hs=a.useMemo(()=>i?.data?.find(s=>s?.peak_marker==="peak")?.isoDate||null,[i?.data]),Sa=a.useCallback(()=>{Ye(!1),jt(null),mt(null)},[]),Ma=a.useCallback(async()=>{Nt(!1),typeof B=="function"&&await B({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[B]),bs=a.useCallback(t=>{jt(t)},[]),ys=a.useCallback((t,s=null)=>{jt(t),mt(s??null),Ye(!0)},[]),gs=a.useCallback(async(t,s=!0)=>{if(!i?.id||!t?.isoDate)return;const o=c=>{if(c==null||c==="")return null;const l=parseFloat(String(c).replace(",","."));return Number.isFinite(l)?l:null},r=s??!(t.peak_marker==="peak"||t.peakStatus==="P");try{const c=t.timestamp?Ke(ue(t.timestamp),"HH:mm"):Ke(new Date,"HH:mm");let l=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:t.time??c,time_corrected:t.time_corrected??c,selected:!0,use_corrected:t.use_corrected??!1}];l.length===0&&(l=[{temperature:null,temperature_corrected:null,time:c,time_corrected:c,selected:!0,use_corrected:!1}]);const h=l.map((u,w)=>{const F=u.time||c,m=u.time_corrected||F;return{temperature:o(u.temperature??u.temperature_raw),time:F,selected:w===0?!0:!!u.selected,temperature_corrected:o(u.temperature_corrected),time_corrected:m,use_corrected:!!u.use_corrected}});h.some(u=>u.selected)||(h[0].selected=!0);const g={isoDate:t.isoDate,measurements:h,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",ignored:t.ignored??!1,peak_marker:r?"peak":null},y=t?.id&&!String(t.id).startsWith("placeholder-")?t:null;await $(g,y)}catch(c){console.error("Error toggling peak marker from dashboard:",c)}},[$,i?.id]),vs=a.useMemo(()=>{if(!i?.startDate)return null;try{return St(Mt(new Date),ue(i.startDate))+1}catch(t){return console.error("Error calculating current day:",t),null}},[i?.startDate]),Cs=a.useMemo(()=>{const t=[],s=h=>["auto","manual","none"].includes(h)?h:"auto",o=(h,g,y)=>{const u=Number(g);if(!Number.isFinite(u)||u<0)return;const w=Number(y),F=Number.isFinite(w)&&w>0,m=F?h==="CPM"?`ciclo base: ${w}`:`base ${h}: ${w}`:null;t.push({source:h,day:Math.max(1,u),reason:m?`Manual desde dashboard (${m})`:"Manual desde dashboard",kind:"calculator",isManual:!0,manualBase:F?w:null})},r=(h,g,y)=>{if(!y)return;const u=Number(g);Number.isFinite(u)&&t.push({source:h,day:Math.max(1,u),reason:"Automático desde dashboard",kind:"calculator"})},c=s(ie);c==="manual"?o("CPM",J,z):c==="auto"&&r("CPM",C?.value,C?.canCompute);const l=s(W);return l==="manual"?o("T8",k,j):l==="auto"&&r("T8",b?.value,b?.canCompute),t},[C?.canCompute,C?.value,b?.canCompute,b?.value,ie,z,J,j,k,W]),Ns=a.useMemo(()=>({calculators:{cpm:ie!=="none",t8:W!=="none"}}),[ie,W]),ws=a.useMemo(()=>{const t=[];return Array.isArray(T)&&T.length>0&&t.push(...T),i&&t.push(i),t},[T,i]);if(Us(i?.data??[],!1,"portrait",void 0,i?.id,5,!1,Ns,ws,Cs,!1),Z&&!i?.id)return e.jsx("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:e.jsx("div",{className:"w-full rounded-3xl  p-4 text-center shadow-sm",children:e.jsx("p",{className:"text-sm font-semibold text-fertiliapp-fuerte",children:"Cargando..."})})});if(!i?.id)return e.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[e.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[e.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>dt(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),e.jsx(ka,{isOpen:ja,onClose:()=>dt(!1),onPreview:t=>O?.(t,i?.id),onConfirm:async t=>{await Re(t),dt(!1),mt(null),Ye(!0),N?.fertilityStartConfig?.postpartum===!0&&Nt(!0)},currentCycleRecords:i?.data??[]}),e.jsx(Ia,{isOpen:Da,onClose:()=>Nt(!1),onConfirm:Ma})]});if(!i?.startDate)return e.jsx("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:e.jsx("div",{className:"w-full rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:e.jsx("p",{className:"text-sm font-semibold text-slate-800",children:"Cargando..."})})});const js=async(t,{keepFormOpen:s=!1}={})=>{wa(!0);try{await $(t,wt),s||(Ye(!1),jt(null),mt(null))}finally{wa(!1)}},Ds=async t=>{await Re(t),dt(!1),mt(null),Ye(!0),N?.fertilityStartConfig?.postpartum===!0&&Nt(!0)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mx-auto flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] w-full flex-col space-y-4 px-4 pb-10 pt-4",children:e.jsxs(H.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex flex-1 flex-col gap-3",children:[e.jsx(sn,{cycleData:{...i,currentDay:vs,records:i.data},onEdit:ys,onTogglePeak:gs,currentPeakIsoDate:hs,onEditStartDate:os,handleOpenCpmDialog:qa,handleOpenT8Dialog:ts,cpmMetric:Va,t8Metric:Ua}),e.jsx(ft,{open:kt,onOpenChange:t=>{t||Ot()},children:e.jsxs(pt,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col overflow-hidden rounded-3xl border border-rose-100 bg-white/95 p-0 text-gray-800 shadow-xl",children:[e.jsxs(_t,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(Lt,{children:"Editar CPM"}),e.jsx(Pa,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${ot==="manual"||ot==="auto"?"bg-rose-100 text-rose-700":"bg-gray-100 text-gray-600"}`,children:Ha})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>ct("auto"),onKeyDown:t=>it(t,()=>ct("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${X==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-fertiliapp-suave"} ${K.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:K.canCompute&&K.value!==null?`CPM automático: ${Wa} días`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${X==="auto"?"border-emerald-400 bg-emerald-400":"border-fertiliapp-suave bg-white"}`,children:X==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>He(t=>!t),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":ht,children:K.highlightLabel})]}),K.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:K.summary}),!K.detailsAvailable&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."}),ht&&K.detailsAvailable&&e.jsx("div",{className:"mt-2 space-y-2",children:K.cycles.length>0?e.jsx("ul",{className:"space-y-1",children:K.cycles.map((t,s)=>{const o=t.cycleId||t.id||`${t.displayName||t.name||t.startDate||"cycle"}-${s}`,r=typeof t.duration=="number"&&Number.isFinite(t.duration)?`${t.duration} días`:"duración desconocida",c=!!(K.shortestCycle&&K.shortestCycle===t),l=t.cycleId||t.id,h=!!(t.isIgnored||t.ignoredForAutoCalculations),g=l?ia.includes(l):!1,y=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${h?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/50"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${y} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>ba(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(na,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Duración: ",r]}),c&&e.jsx("span",{className:"rounded-full bg-rose-100 px-2 py-0.5 font-semibold text-rose-600",children:"Ciclo más corto"})]}),h&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Ce,{type:"button",variant:"outline",size:"xs",disabled:!l||g,onClick:()=>l&&ya(l,!h),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:h?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":h?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":h,children:g?e.jsxs(e.Fragment,{children:[e.jsx(Ta,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):h?e.jsx($a,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(Oa,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos finalizados con fecha de finalización."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":X==="manual",onClick:()=>ct("manual"),onKeyDown:t=>it(t,()=>ct("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${X==="manual"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${X==="manual"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:X==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Vt,{htmlFor:"manual-cpm-base",className:"text-xs text-gray-600",children:"Ciclo más corto"}),e.jsx(Ut,{id:"manual-cpm-base",type:"number",inputMode:"numeric",step:"1",min:"1",value:S,onChange:Ga,placeholder:"Introduce un entero","aria-describedby":fe?"manual-cpm-helper":void 0}),de&&e.jsx("p",{className:"text-xs text-red-500",children:de})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Vt,{htmlFor:"manual-cpm-final",className:"text-xs text-gray-600",children:"CPM obtenido"}),e.jsx(Ut,{id:"manual-cpm-final",type:"number",inputMode:"decimal",step:"0.1",min:"1",value:R,onChange:Qa,placeholder:"Introduce el valor","aria-describedby":fe?"manual-cpm-helper":void 0}),we&&e.jsx("p",{className:"text-xs text-red-500",children:we})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:[fe&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-cpm-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:fe==="base"?"Usando Ciclo más corto como base":"Usando CPM (final)"})}),e.jsx(Ce,{type:"button",variant:"outline",onClick:()=>Je(!0),disabled:!Ya,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"})]}),xa&&X==="manual"&&!V&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":X==="none",onClick:()=>ct("none"),onKeyDown:t=>it(t,()=>ct("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${X==="none"?"border-emerald-300 bg-emerald-50/60":"border-dashed border-rose-200 bg-white/70 hover:border-rose-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${X==="none"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:X==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(zt,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:Ot,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(Ce,{type:"button",onClick:es,disabled:xa,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(ft,{open:bt,onOpenChange:Je,children:e.jsxs(pt,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(_t,{children:e.jsx(Lt,{children:"¿Estás segura de que quieres borrar el valor manual de CPM?"})}),e.jsxs(zt,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:()=>Je(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(Ce,{type:"button",variant:"destructive",onClick:Za,disabled:It,className:"w-full sm:w-auto",children:It?"Borrando…":"Borrar"})]})]})}),e.jsx(ft,{open:Tt,onOpenChange:t=>{t||At()},children:e.jsxs(pt,{className:"flex max-h-[90vh] w-[90vw] max-w-sm flex-col rounded-3xl border border-rose-100 bg-white/95 text-gray-800 shadow-xl overflow-hidden p-0",children:[e.jsxs(_t,{className:"space-y-2 px-4 pt-4 text-left",children:[e.jsx(Lt,{children:"Editar T-8"}),e.jsx(Pa,{children:e.jsx("div",{className:"text-xs",children:"Puedes usar el valor calculado automáticamente o fijar un valor manual."})})]}),e.jsxs("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 pb-4",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-rose-600",children:"Estado actual"})}),e.jsx("span",{className:`rounded-full px-3 py-1 text-[11px] font-semibold ${lt==="manual"||lt==="auto"?"bg-rose-100 text-rose-700":"bg-gray-100 text-gray-600"}`,children:Xa})]})}),e.jsxs("div",{role:"radio",tabIndex:0,onClick:()=>ut("auto"),onKeyDown:t=>it(t,()=>ut("auto")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${Y==="auto"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"} ${b.canCompute?"":"opacity-70"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Cálculo automático"}),e.jsx("span",{className:"text-[11px] font-semibold text-rose-600",children:b.canCompute&&b.value!==null?`T-8 automático: Día ${Ja}`:"No disponible todavía"}),e.jsx("p",{className:"text-[10px] text-rose-600",children:"Basado en tus ciclos completados."})]}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${Y==="auto"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:Y==="auto"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-2 rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs font-semibold text-rose-700",children:[e.jsx("span",{children:"Datos disponibles"}),e.jsx("button",{type:"button",onClick:()=>Jt(t=>!t),className:"rounded-full bg-white/70 px-2 py-0.5 text-[11px] font-semibold text-rose-600 transition hover:bg-white/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70","aria-expanded":oa,children:ea.highlightLabel})]}),ea.summary&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:ea.summary}),b.cycleCount===0&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."}),oa&&b.cycleCount>0&&e.jsx("div",{className:"mt-2 space-y-2",children:b.cyclesConsidered.length>0?e.jsx("ul",{className:"space-y-1",children:b.cyclesConsidered.map((t,s)=>{const o=t.cycleId||`${t.displayName}-${t.riseDay}-${s}`,r=typeof t.riseDay=="number"&&Number.isFinite(t.riseDay)?t.riseDay:"—",c=t.cycleId||t.id,l=!!(t.isIgnored||t.ignoredForAutoCalculations),h=c?ia.includes(c):!1,g=`rounded-2xl border px-3 py-2 shadow-sm transition hover:border-rose-200 hover:bg-white ${l?"border-rose-200 bg-rose-50/80 opacity-80":"border-rose-100 bg-white/40"}`;return e.jsx("li",{children:e.jsxs("div",{className:"flex items-stretch gap-2",children:[e.jsxs("div",{className:`${g} flex-1`,children:[e.jsx("button",{type:"button",onClick:()=>ba(t),className:"block w-full rounded-2xl px-1 py-0.5 text-left transition hover:bg-white/60 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:t.dateRangeLabel||t.displayName||t.name||"Ciclo sin nombre"}),e.jsx(na,{className:"h-4 w-4 text-rose-400","aria-hidden":"true"})]})}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-rose-500",children:[e.jsxs("span",{children:["Día de subida: ",r]}),Number.isFinite(t.t8Day)&&e.jsxs("span",{children:["T-8: Día ",t.t8Day]})]}),l&&e.jsx("p",{className:"mt-1 text-[11px] text-rose-400",children:"Ignorado para el cálculo automático."})]}),e.jsx(Ce,{type:"button",variant:"outline",size:"icon",disabled:!c||h,onClick:()=>c&&ya(c,!l),className:"shrink-0 self-center h-8 w-8 p-0 bg-transparent border-transparent",title:l?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-label":l?"Incluir ciclo en el cálculo automático":"Ignorar ciclo para el cálculo automático","aria-pressed":l,children:h?e.jsxs(e.Fragment,{children:[e.jsx(Ta,{className:"h-4 w-4 animate-spin text-rose-500","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Guardando…"})]}):l?e.jsx($a,{className:"h-4 w-4 text-rose-500","aria-hidden":"true"}):e.jsx(Oa,{className:"h-4 w-4 text-green-800/70","aria-hidden":"true"})})]})},o)})}):e.jsx("p",{className:"text-[11px] text-rose-500",children:"Aún no hay ciclos con ovulación confirmada por temperatura."})})]})]}),e.jsxs("div",{role:"radio",tabIndex:0,"aria-checked":Y==="manual",onClick:()=>ut("manual"),onKeyDown:t=>it(t,()=>ut("manual")),className:`cursor-pointer rounded-2xl border px-3 py-3 shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${Y==="manual"?"border-emerald-300 bg-emerald-50/60":"border-rose-100 bg-white/80 hover:border-rose-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"Valor manual"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${Y==="manual"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:Y==="manual"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Vt,{htmlFor:"manual-t8-base",className:"text-xs text-gray-600",children:"Ciclo con subida (día)"}),e.jsx(Ut,{id:"manual-t8-base",type:"number",inputMode:"numeric",step:"1",min:"1",value:De,onChange:as,placeholder:"Día de subida","aria-describedby":p?"manual-t8-helper":void 0}),Ae&&e.jsx("p",{className:"text-xs text-red-500",children:Ae})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Vt,{htmlFor:"manual-t8-final",className:"text-xs text-gray-600",children:"T-8 manual (día)"}),e.jsx(Ut,{id:"manual-t8-final",type:"number",inputMode:"numeric",step:"1",min:"1",value:Se,onChange:ss,placeholder:"Día del T-8","aria-describedby":p?"manual-t8-helper":void 0}),d&&e.jsx("p",{className:"text-xs text-red-500",children:d})]})]}),e.jsx("div",{className:"mt-3 flex flex-wrap items-end gap-2",children:p&&e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("span",{id:"manual-t8-helper",className:"rounded-full bg-rose-50 px-3 py-1 text-xs font-medium text-rose-600",children:p==="base"?"Usando día de subida como base":"Usando T-8 manual"})})}),e.jsx(Ce,{type:"button",variant:"outline",onClick:()=>gt(!0),disabled:!Ka,className:"h-8 shrink-0 rounded-full border border-rose-200 px-3 text-xs text-rose-600 hover:bg-rose-50 hover:text-rose-700",children:"Borrar"}),ha&&Y==="manual"&&!U&&e.jsx("p",{className:"mt-2 text-[11px] text-rose-500",children:"Introduce un valor válido antes de seleccionar."})]}),e.jsx("div",{role:"radio",tabIndex:0,"aria-checked":Y==="none",onClick:()=>ut("none"),onKeyDown:t=>it(t,()=>ut("none")),className:`cursor-pointer rounded-2xl border px-3 py-2 text-left shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300/70 ${Y==="none"?"border-emerald-300 bg-emerald-50/60":"border-dashed border-rose-200 bg-white/70 hover:border-rose-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm font-semibold text-rose-900",children:"No usar ningún valor"})}),e.jsx("span",{className:`mt-0.5 flex h-5 w-5 items-center justify-center rounded-full border-2 ${Y==="none"?"border-emerald-400 bg-emerald-400":"border-rose-300 bg-white"}`,children:Y==="none"&&e.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})})]})})]}),e.jsx(zt,{className:"mt-0 flex flex-col gap-3 px-4 pb-4",children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-2",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:At,className:"h-8 rounded-full px-4 text-xs",children:"Cancelar"}),e.jsx(Ce,{type:"button",onClick:rs,disabled:ha,className:"h-8 rounded-full px-4 text-xs",children:"Guardar"})]})})]})}),e.jsx(ft,{open:Ra,onOpenChange:gt,children:e.jsxs(pt,{className:"w-[90vw] max-w-xs rounded-2xl border border-rose-100",children:[e.jsx(_t,{children:e.jsx(Lt,{children:"¿Estás segura de que quieres borrar el valor manual de T-8?"})}),e.jsxs(zt,{className:"flex flex-col gap-2 sm:flex-row sm:justify-end sm:gap-3",children:[e.jsx(Ce,{type:"button",variant:"secondary",onClick:()=>gt(!1),className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(Ce,{type:"button",variant:"destructive",onClick:ns,disabled:la,className:"w-full sm:w-auto",children:la?"Borrando…":"Borrar"})]})]})}),e.jsx(ft,{open:Le,onOpenChange:t=>{t||Ee()},children:e.jsx(pt,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(As,{cycle:i,startDate:G,endDate:i.endDate,otherCycles:[...T??[],i].filter(Boolean),onStartDateChange:t=>A(t),onSave:us,onCancel:Ee,isProcessing:se||Z||qt,dateError:Ne,includeEndDate:!1,showOverlapDialog:Ht,overlapCycle:Ft,overlapImpactPreview:ze,onConfirmOverlap:ds,onCancelOverlap:cs,onClearError:()=>L(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",onUndoCycle:st?()=>Et(!0):void 0,isUndoingCycle:qt,className:"w-full"})})})]})}),e.jsx(_s,{isOpen:_a,onClose:()=>Et(!1),onConfirm:ls,title:"Deshacer ciclo",confirmLabel:"Deshacer ciclo",cancelLabel:"Cancelar",description:za,isProcessing:qt}),e.jsx(Ls,{isOpen:La,onCancel:()=>{Yt(!1),ua(null)},onConfirm:is,title:"Este cambio ajustará otros ciclos",description:"Deshacer el ciclo actual unirá ciclos y moverá registros.",confirmLabel:"Aplicar cambios",affectedCycles:Kt?.affectedCycles||[],impactSummary:Kt?.impactSummary,adjustedCyclesPreview:Kt?.adjustedCyclesPreview||[]}),e.jsx(ft,{open:ms,onOpenChange:t=>{t?Ye(!0):Sa()},children:e.jsx(pt,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Rs,{onSubmit:js,onCancel:Sa,initialData:wt,cycleStartDate:i.startDate,cycleEndDate:i.endDate,isProcessing:fs,isEditing:!!wt&&!xs,cycleData:i.data,onDateSelect:bs,initialSectionKey:ps})})}),e.jsx(nn,{onAddRecord:()=>{jt(null),mt(null),Ye(!0)},onAddCycle:()=>dt(!0)}),e.jsx(ka,{isOpen:ja,onClose:()=>dt(!1),onPreview:t=>O?.(t,i?.id),onConfirm:Ds,currentCycleStartDate:i.startDate,currentCycleRecords:i?.data??[]}),e.jsx(Ia,{isOpen:Da,onClose:()=>Nt(!1),onConfirm:Ma})]})};export{yn as default};
