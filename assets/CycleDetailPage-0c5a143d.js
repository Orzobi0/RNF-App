import{c as Y,r as d,e as ie,a as le,u as ce,b as de,j as e,B as C,L as ue,d as me,X as fe}from"./index-7fea14b0.js";import{g as he,F as we,R as ge}from"./generatePlaceholders-d43e9126.js";import{R as pe,D as ye}from"./DeletionDialog-453a823d.js";import{D as xe}from"./DataEntryForm-ad843356.js";import{E as ve}from"./EditCycleDatesDialog-7915286f.js";import{a as De,p as g,d as V,s as z,f as _}from"./useCycleData-321f2a4b.js";import{D as Ce,a as be}from"./dialog-5eeab027.js";import{T as Ee}from"./badge-e8164852.js";import{E as ke}from"./eye-off-ec261603.js";import{E as je}from"./eye-f4dacf7c.js";import"./ChartTooltip-478e06f3.js";import"./input-eebcb0c4.js";import"./label-b7675640.js";const Ne=Y("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]),Se=Y("Maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]),X=Y("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),Fe=()=>{const[l,b]=d.useState(!1),[c,p]=d.useState("portrait"),r=d.useCallback(async(n="portrait")=>{const m=document.documentElement;try{m.requestFullscreen?await m.requestFullscreen():m.mozRequestFullScreen?await m.mozRequestFullScreen():m.webkitRequestFullscreen?await m.webkitRequestFullscreen():m.msRequestFullscreen&&await m.msRequestFullscreen(),typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.lock&&await window.screen.orientation.lock(`${n}-primary`).catch(()=>{}),p(n)}catch{}},[]),x=d.useCallback(async()=>{try{document.exitFullscreen?await document.exitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.msExitFullscreen&&await document.msExitFullscreen(),typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.unlock&&window.screen.orientation.unlock()}catch{}},[]),E=d.useCallback(async()=>{l?await x():await r(c)},[l,r,x,c]),R=d.useCallback(async()=>{const n=c==="portrait"?"landscape":"portrait";l?window.screen&&window.screen.orientation&&window.screen.orientation.lock&&await window.screen.orientation.lock(`${n}-primary`).catch(()=>{}):await r(n),p(n)},[c,l,r]);return d.useEffect(()=>{const n=()=>{const m=!!(document.fullscreenElement||document.webkitIsFullScreen||document.mozFullScreenElement||document.msFullscreenElement);b(m),!m&&typeof window<"u"&&window.screen&&window.screen.orientation&&window.screen.orientation.unlock&&window.screen.orientation.unlock()};return document.addEventListener("fullscreenchange",n),document.addEventListener("webkitfullscreenchange",n),document.addEventListener("mozfullscreenchange",n),document.addEventListener("MSFullscreenChange",n),()=>{document.removeEventListener("fullscreenchange",n),document.removeEventListener("webkitfullscreenchange",n),document.removeEventListener("mozfullscreenchange",n),document.removeEventListener("MSFullscreenChange",n)}},[]),{isFullScreen:l,orientation:c,toggleFullScreen:E,rotateScreen:R}},Z=28,Re=10,Le=({cycleData:l,addOrUpdateDataPointForCycle:b,deleteRecordForCycle:c,toggleIgnoreRecordForCycle:p,isFullScreen:r,toggleFullScreen:x,orientation:E,rotateScreen:R,showInterpretation:n,setShowInterpretation:m,onToggleInterpretation:L,chartDisplayData:B,showForm:a,setShowForm:y,editingRecord:f,setEditingRecord:v,recordToDelete:D,setRecordToDelete:O,isProcessing:k,toast:G,onEditCycleDates:$,onDeleteCycle:T})=>{const M=E==="portrait"?Re:Z,j=u=>{const S=()=>{v(u),y(!0)};r?(x(),setTimeout(S,300)):S()},U=u=>{const S=l.data.find(q=>q.id===u);O(S)},H=()=>{D&&c(D.id)},[N,I]=d.useState(!1);return d.useEffect(()=>{!r&&N&&I(!1)},[r,N]),e.jsxs("div",{className:`w-full ${r?"h-full overflow-hidden":"max-w-4xl mx-auto"}`,children:[!r&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsx(C,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:e.jsxs(ue,{to:"/archived-cycles",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"})," Mis Ciclos"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(C,{onClick:$,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:[e.jsx(X,{className:"mr-2 h-4 w-4"})," Editar Fechas"]}),e.jsxs(C,{variant:"destructive",onClick:T,children:[e.jsx(Ee,{className:"mr-2 h-4 w-4"})," Eliminar Ciclo"]})]})]}),e.jsxs("h1",{className:"text-2xl sm:text-3xl font-bold text-center",children:["Detalle de ciclo (",_(g(l.startDate),"dd/MM/yyyy")," - ",l.endDate?_(g(l.endDate),"dd/MM/yyyy"):"En curso",")"]})]}),!a&&!N&&!r&&e.jsxs("div",{className:"mb-4 flex justify-center gap-4",children:[e.jsxs(C,{onClick:()=>{I(!0),x()},className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:[e.jsx(me,{className:"mr-2 h-4 w-4"})," Gráfica"]}),e.jsxs(C,{onClick:()=>{v(null),y(!0)},className:"bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},disabled:k,children:[e.jsx(X,{className:"mr-2 h-4 w-4"})," Añadir registro en este ciclo"]})]}),!a&&(N||r)&&e.jsxs("div",{className:r?"fixed inset-0 z-50 h-[100dvh] w-[100dvw] overflow-x-auto overflow-y-auto":"p-4 sm:p-6 mb-4 bg-white/70 backdrop-blur-md ring-1 ring-[#FFB1DD]/50 shadow-2xl rounded-xl relative",style:r?{background:"linear-gradient(135deg, #FFFAFC 0%, #f7eaef 100%)"}:{boxShadow:"0 4px 8px rgba(0,0,0,0.04)"},children:[!r&&e.jsx("h2",{className:"text-xl font-medium text-slate-700 mb-4 bg-white bg-opacity-90 px-4 py-2 rounded-md",children:"Gráfica"}),e.jsx(we,{data:B,isFullScreen:r,orientation:E,onToggleIgnore:p,onEdit:j,cycleId:l.id,showInterpretation:n,visibleDays:M,reduceMotion:!0,forceLandscape:E==="landscape"}),e.jsxs(C,{onClick:L,onTouchEnd:L,variant:"ghost",size:"sm",className:`absolute ${r?"top-4 right-20":"top-2 right-20"} flex items-center font-semibold py-1 px-2 rounded-lg transition-colors ${n?"bg-[#E27DBF] text-white hover:bg-[#d46ab3]":"bg-transparent text-slate-700 hover:bg-[#E27DBF]/20"}`,children:[n?e.jsx(ke,{className:"mr-2 h-4 w-4"}):e.jsx(je,{className:"mr-2 h-4 w-4"}),n?"Ocultar":"Interpretar"]}),e.jsx(C,{onClick:R,variant:"ghost",size:"icon",className:`absolute ${r?"top-4 right-12 text-white bg-slate-700/50 hover:bg-slate-600/70":"top-2 right-12 text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:"Cambiar orientación",children:e.jsx(ge,{className:"h-5 w-5"})}),e.jsx(C,{onClick:()=>{r?(x(),I(!1)):x()},variant:"ghost",size:"icon",className:`absolute ${r?"top-4 right-4 text-white bg-slate-700/50 hover:bg-slate-600/70":"top-2 right-2 text-slate-400 hover:text-slate-200 hover:bg-slate-700/50"}`,title:r?"Salir de Pantalla Completa":"Ver en Pantalla Completa",children:r?e.jsx(fe,{className:"h-6 w-6"}):e.jsx(Se,{className:"h-5 w-5"})})]}),!r&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{records:l.data,onEdit:j,onDelete:U,isArchiveView:!0,isProcessing:k}),e.jsx(Ce,{open:a,onOpenChange:u=>{u||(y(!1),v(null))},children:e.jsx(be,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(xe,{onSubmit:b,initialData:f,onCancel:()=>{y(!1),v(null)},cycleStartDate:l.startDate,cycleEndDate:l.endDate,isProcessing:k,isEditing:!!f,cycleData:l.data})})})]}),e.jsx(ye,{isOpen:!!D,onClose:()=>O(null),onConfirm:H,recordDate:D?_(g(D.isoDate),"dd/MM/yyyy"):"",isProcessing:k})]})},Ve=()=>{const{cycleId:l}=ie(),b=le(),{user:c}=ce(),{getCycleById:p,isLoading:r,addOrUpdateDataPoint:x,deleteRecord:E,toggleIgnoreRecord:R,updateCycleDates:n,deleteCycle:m,checkCycleOverlap:L,forceUpdateCycleStart:B}=De(l),[a,y]=d.useState(null),{toast:f}=de(),[v,D]=d.useState(null),[O,k]=d.useState(!1),[G,$]=d.useState(null),[T,M]=d.useState(!1),{isFullScreen:j,toggleFullScreen:U,orientation:H,rotateScreen:N}=Fe(),[I,u]=d.useState(!1),[S,q]=d.useState(!1),K=s=>{s.preventDefault(),q(t=>!t)};d.useEffect(()=>{(async()=>{if(c){let t=await p(l);if(!t){const i=localStorage.getItem(`fertilityData_cycle_${c.uid}_${l}`);if(i){const o=JSON.parse(i);t={...o,data:J(o.data||[],o.startDate)}}}t?y(t):(f({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),b("/archived-cycles"))}})()},[l,c,p,f,b]);const Q=(s,t)=>{const i=z(g(s)),o=z(g(t));return V(i,o)+1},J=(s,t)=>!s||!Array.isArray(s)||!t?[]:[...s].sort((o,P)=>g(o.isoDate)-g(P.isoDate)).map(o=>({...o,ignored:o.ignored||!1,cycleDay:Q(o.isoDate,t)})),A=s=>{if(!c||!s||!s.id)return;const t={...s,data:s.data.map(({cycleDay:i,...o})=>o)};localStorage.setItem(`fertilityData_cycle_${c.uid}_${s.id}`,JSON.stringify(t))},ee=async s=>{if(!a||!c)return;const t=!!v;u(!0);try{await x(s,v);const i=await p(a.id);i&&(A(i),y(i)),f({title:t?"Registro actualizado":"Nuevo registro añadido",description:"Datos para el ciclo actualizados."}),k(!1),D(null)}catch(i){console.error("Error adding/updating data point:",i),f({title:"Error",description:"No se pudo guardar el registro.",variant:"destructive"})}finally{u(!1)}},te=async s=>{if(!(!a||!c)){u(!0);try{await E(s);const t=await p(a.id);t&&(A(t),y(t)),f({title:"Registro eliminado",description:"El registro ha sido eliminado del ciclo.",variant:"destructive"})}catch(t){console.error("Error deleting record:",t),f({title:"Error",description:"No se pudo eliminar el registro.",variant:"destructive"})}finally{$(null),u(!1)}}},ae=(s,t)=>{if(!a||!c||a.id!==s)return;u(!0),R(s,t),y(o=>{if(!o)return null;const P=o.data.map(w=>w.id===t?{...w,ignored:!w.ignored}:w),W=J(P,o.startDate),h={...o,data:W};return A(h),h});const i=a.data.find(o=>o.id===t);f({title:`Registro ${i&&!i.ignored?"despreciado":"restaurado"}`,description:`El registro del ${i?_(g(i.isoDate),"dd/MM/yyyy"):""} ha sido ${i&&!i.ignored?"marcado como despreciado":"restaurado"}.`}),u(!1)},se=async({startDate:s,endDate:t,force:i})=>{if(!(!a||!c)){u(!0);try{i?(await B(a.id,s),t!==void 0&&await n(a.id,void 0,t)):await n(a.id,s,t);const o=await p(a.id);o&&(A(o),y(o)),f({title:"Fechas actualizadas",description:"Las fechas del ciclo han sido modificadas."}),M(!1)}catch(o){console.error(o)}u(!1)}},oe=async()=>{if(!(!a||!c)&&window.confirm("¿Eliminar este ciclo?")){u(!0);try{await m(a.id),f({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),b("/archived-cycles")}catch(s){console.error(s)}u(!1)}},re=d.useCallback(()=>{if(!a||!a.startDate)return[];const s=g(a.startDate),t=a.data.reduce((h,w)=>{const F=g(w.isoDate);return F>h?F:h},s),i=a.endDate?g(a.endDate):null;let o;if(i)o=V(z(i),s)+1;else{const h=z(new Date),w=t>h?t:h,F=V(z(w),s);o=Math.max(Z,F+1)}return he(s,o).map(h=>{const w=a.data.find(F=>F.isoDate===h.isoDate);return w?{...w,date:h.date}:h})},[a]);if(r||!a)return e.jsx("div",{className:"text-center text-slate-300 p-8",children:"Cargando detalles del ciclo..."});const ne=re();return e.jsxs("div",{className:`min-h-[100dvh] ${j?"":"bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative"}`,children:[!j&&e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsxs("div",{className:`${j?"":"relative z-10 px-4 py-6"}`,children:[e.jsx(Le,{cycleData:a,addOrUpdateDataPointForCycle:ee,deleteRecordForCycle:te,toggleIgnoreRecordForCycle:ae,isFullScreen:j,toggleFullScreen:U,orientation:H,rotateScreen:N,showInterpretation:S,setShowInterpretation:q,onToggleInterpretation:K,chartDisplayData:ne,showForm:O,setShowForm:k,editingRecord:v,setEditingRecord:D,recordToDelete:G,setRecordToDelete:$,isProcessing:I,toast:f,onEditCycleDates:()=>M(!0),onDeleteCycle:oe}),e.jsx(ve,{isOpen:T,onClose:()=>M(!1),onConfirm:se,initialStartDate:a.startDate,initialEndDate:a.endDate,cycleId:a.id,checkOverlap:L})]})]})};export{Ve as default};
