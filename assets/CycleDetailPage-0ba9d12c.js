import{c as q,h as ce,a as de,u as ue,b as fe,r as o,j as e,B as g,L as _,f as P,p as h,g as me,s as $,d as he}from"./index-24043ae7.js";import{R as xe,D as pe}from"./DeletionDialog-8f61e9be.js";import{D as ge}from"./computePeakStatuses-a8c393d1.js";import{O as ye}from"./OverlapWarningDialog-3f38b600.js";import{u as ve,D as De,a as be}from"./useCycleData-4efbc629.js";import{T as we}from"./trash-2-f8d41441.js";import"./badge-e36f7fd8.js";import"./eye-61791957.js";import"./input-2a7ce825.js";import"./label-e033e1bb.js";import"./select-4e9e95be.js";import"./eye-off-b85355d3.js";const je=q("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]),Ce=q("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),Ne=(d,u)=>{const i=$(h(d)),l=$(h(u));return he(i,l)+1},Ee=(d,u)=>!d||!Array.isArray(d)||!u?[]:[...d].sort((l,E)=>h(l.isoDate)-h(E.isoDate)).map(l=>({...l,ignored:l.ignored||!1,cycleDay:Ne(l.isoDate,u)})),Be=()=>{const{cycleId:d}=ce(),u=de(),{user:i}=ue(),{getCycleById:l,isLoading:E,addOrUpdateDataPoint:U,deleteRecord:G,updateCycleDates:M,deleteCycle:H,checkCycleOverlap:F,forceUpdateCycleStart:J}=ve(),{toast:c}=fe(),[t,b]=o.useState(null),[w,y]=o.useState(null),[W,v]=o.useState(!1),[D,I]=o.useState(null),[f,m]=o.useState(!1),[S,k]=o.useState(!1),[x,j]=o.useState(""),[C,N]=o.useState(""),[T,p]=o.useState(""),[Z,O]=o.useState(!1),[z,R]=o.useState(null),[K,L]=o.useState(null),A=o.useCallback(a=>{if(!i||!(a!=null&&a.id))return;const s={...a,data:(a.data||[]).map(({cycleDay:n,...r})=>r)};localStorage.setItem(`fertilityData_cycle_${i.uid}_${a.id}`,JSON.stringify(s))},[i]);o.useEffect(()=>{(async()=>{if(!i)return;let s=await l(d);if(!s){const n=localStorage.getItem(`fertilityData_cycle_${i.uid}_${d}`);if(n){const r=JSON.parse(n);s={...r,data:Ee(r.data||[],r.startDate)}}}s?b(s):(c({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),u("/archived-cycles"))})()},[d,i,l,c,u]),o.useEffect(()=>{t&&(j(t.startDate||""),N(t.endDate||""))},[t]);const Q=async(a,{keepFormOpen:s=!1}={})=>{if(!t||!i)return;const n=!!w;m(!0);try{await U(a,w,t.id);const r=await l(t.id);r&&(A(r),b(r)),c({title:n?"Registro actualizado":"Nuevo registro añadido",description:"Datos para el ciclo actualizados."}),s||(v(!1),y(null))}catch(r){console.error("Error adding/updating data point:",r),c({title:"Error",description:"No se pudo guardar el registro.",variant:"destructive"})}finally{m(!1)}},V=async a=>{if(!(!t||!i)){m(!0);try{await G(a,t.id);const s=await l(t.id);s&&(A(s),b(s)),c({title:"Registro eliminado",description:"El registro ha sido eliminado."})}catch(s){console.error("Error deleting record:",s),c({title:"Error",description:"No se pudo eliminar el registro.",variant:"destructive"})}finally{m(!1)}}},X=async({startDate:a,endDate:s,force:n})=>{if(!t||!i)return!1;m(!0);try{n?(await J(t.id,a),s!==void 0&&await M(t.id,void 0,s)):await M(t.id,a,s);const r=await l(t.id);return r&&(A(r),b(r)),c({title:"Fechas actualizadas",description:"Las fechas del ciclo han sido modificadas."}),!0}catch(r){return console.error(r),c({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"}),!1}finally{m(!1)}},Y=async()=>{if(!(!t||!i)&&window.confirm("¿Eliminar este ciclo?")){m(!0);try{await H(t.id),c({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),u("/archived-cycles")}catch(a){console.error(a),c({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{m(!1)}}},ee=()=>{!S&&t&&(j(t.startDate||""),N(t.endDate||""),p("")),k(a=>!a)},te=()=>{t&&(j(t.startDate||""),N(t.endDate||"")),p(""),k(!1)},B=async a=>{await X(a)&&(k(!1),p(""))},ae=async a=>{if(a.preventDefault(),!x){p("La fecha de inicio es obligatoria");return}if(C&&C<x){p("La fecha de fin no puede ser anterior al inicio");return}p("");const s={startDate:x,endDate:C||void 0};if(F&&(t!=null&&t.id)&&x){const n=await F(t.id,x);if(n){R(s),L(n),O(!0);return}}await B(s)},se=async()=>{z&&await B({...z,force:!0}),O(!1),R(null),L(null)},re=()=>{O(!1),R(null),L(null)},oe=a=>{y(a),v(!0)},ie=()=>{y(null),v(!0)},le=a=>{if(!t)return;const s=(t.data||[]).find(n=>n.id===a);I(s||null)},ne=()=>{D&&V(D.id)};return E&&!t||!t?e.jsx("div",{className:"text-center text-slate-300 p-8",children:"Cargando detalles del ciclo..."}):e.jsxs("div",{className:"min-h-[100dvh] bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 relative",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"relative z-10 px-4 py-6",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center justify-between gap-2 mb-2",children:e.jsx(g,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",children:e.jsxs(_,{to:"/archived-cycles",children:[e.jsx(je,{className:"mr-2 h-4 w-4"})," Mis Ciclos"]})})}),e.jsx("div",{className:"text-center",children:e.jsxs("button",{type:"button",onClick:ee,className:`text-2xl sm:text-3xl font-bold px-4 py-3 rounded-xl transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2 ${S?"bg-rose-200/80 text-rose-700 shadow-inner":"bg-rose-300/40 hover:bg-rose-200/70 text-rose-700"}`,children:["Detalle de ciclo (",P(h(t.startDate),"dd/MM/yyyy")," -"," ",t.endDate?P(h(t.endDate),"dd/MM/yyyy"):"En curso",")"]})})]}),S&&e.jsxs("div",{className:"mb-6 mx-auto w-full max-w-xl rounded-2xl border border-rose-100 bg-white/90 p-5 shadow-lg",children:[e.jsx("form",{onSubmit:ae,className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-rose-700 mb-1",children:"Editar fechas del ciclo"}),e.jsx("p",{className:"text-sm text-slate-600 mb-3",children:"Actualiza las fechas de inicio y fin del ciclo. Guarda los cambios cuando termines."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("label",{className:"flex flex-col text-sm text-slate-700",children:["Inicio del ciclo",e.jsx("input",{type:"date",value:x,onChange:a=>j(a.target.value),className:"mt-1 rounded-lg border border-rose-200 bg-rose-50/60 px-3 py-2 text-slate-800 focus:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-300"})]}),e.jsxs("label",{className:"flex flex-col text-sm text-slate-700",children:["Fin del ciclo",e.jsx("input",{type:"date",value:C||"",onChange:a=>N(a.target.value),className:"mt-1 rounded-lg border border-rose-200 bg-rose-50/60 px-3 py-2 text-slate-800 focus:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-300"})]})]}),T&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:T}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2 justify-center",children:[e.jsx(g,{type:"button",variant:"outline",onClick:te,className:"border-rose-200 text-rose-600 hover:bg-rose-50",disabled:f,children:"Cancelar"}),e.jsx(g,{type:"submit",className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",disabled:f,children:"Guardar"})]})]})}),e.jsxs("div",{className:"mt-6 border-t border-rose-100 pt-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-rose-700 mb-2",children:"Eliminar ciclo"}),e.jsx("p",{className:"text-sm text-slate-600 mb-3",children:"Esta acción no se puede deshacer. Se eliminarán todos los registros asociados."}),e.jsxs(g,{variant:"destructive",onClick:Y,disabled:f,className:"w-full sm:w-auto",children:[e.jsx(we,{className:"mr-2 h-4 w-4"})," Eliminar ciclo"]})]})]}),e.jsxs("div",{className:"mb-4 flex justify-center gap-4",children:[e.jsx(g,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow hover:from-pink-600 hover:to-rose-600",disabled:f,children:e.jsxs(_,{to:`/chart/${t.id}`,children:[e.jsx(me,{className:"mr-2 h-4 w-4"})," Gráfica"]})}),e.jsxs(g,{onClick:ie,className:"bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white shadow-lg",style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},disabled:f,children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"})," Añadir registro en este ciclo"]})]}),e.jsx(xe,{records:t.data,onEdit:oe,onDelete:le,isProcessing:f}),e.jsx(De,{open:W,onOpenChange:a=>{a||(v(!1),y(null))},children:e.jsx(be,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(ge,{onSubmit:Q,initialData:w,onCancel:()=>{v(!1),y(null)},cycleStartDate:t.startDate,cycleEndDate:t.endDate,isProcessing:f,isEditing:!!w,cycleData:t.data})})}),e.jsx(pe,{isOpen:!!D,onClose:()=>I(null),onConfirm:ne,recordDate:D?P(h(D.isoDate),"dd/MM/yyyy"):"",isProcessing:f}),e.jsx(ye,{isOpen:Z,conflictCycle:K,onCancel:re,onConfirm:se})]})})]})};export{Be as default};
