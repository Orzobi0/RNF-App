import{an as m,N as g,j as h}from"./index-D1odW1ad.js";import{F as p}from"./FertilityChart-DdB9dd-i.js";import"./computePeakStatuses-BuckH43K.js";import"./useCycleData-CiVYlgIv.js";import"./peak-mode-button-BZ-YtFep.js";import"./useFertilityChart-8sBD0Slj.js";import"./badge-CmDzsC2c.js";async function y(i,n=2500){const o=performance.now();for(;performance.now()-o<n;){const e=i.querySelector("svg");if(e){const r=e.getBoundingClientRect();if(r.width>50&&r.height>50)return e}await new Promise(r=>requestAnimationFrame(r))}throw new Error("No se pudo renderizar el SVG del gráfico (timeout).")}function w(i,n){const o=["--phase-rel","--phase-fertile","--phase-post","--phase-post-abs","--phase-rel-stop","--phase-fertile-stop","--phase-post-stop","--phase-post-abs-stop","--phase-text-shadow"],e=getComputedStyle(i);o.forEach(r=>{const t=e.getPropertyValue(r);t&&t.trim()&&n.style.setProperty(r,t.trim())})}async function v(i,{widthPx:n,heightPx:o,pixelRatio:e=2,background:r="#ffffff"}){const t="http://www.w3.org/2000/svg",a=i.cloneNode(!0);a.setAttribute("width",String(n)),a.setAttribute("height",String(o)),w(i,a);const s=document.createElementNS(t,"rect");s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("width","100%"),s.setAttribute("height","100%"),s.setAttribute("fill",r),a.insertBefore(s,a.firstChild);const c=new XMLSerializer().serializeToString(a),u=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(c)}`,l=new Image;l.decoding="async",l.src=u,await l.decode();const d=document.createElement("canvas");d.width=Math.round(n*e),d.height=Math.round(o*e);const f=d.getContext("2d");return f.setTransform(e,0,0,e,0,0),f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",f.drawImage(l,0,0,n,o),d.toDataURL("image/png")}async function C(i){const n=new Image;n.src=i,await n.decode();const o=Math.min(n.width,220),e=Math.min(n.height,220),r=document.createElement("canvas");r.width=o,r.height=e;const t=r.getContext("2d");t.drawImage(n,0,0,o,e);const{data:a}=t.getImageData(0,0,o,e);for(let s=0;s<a.length;s+=100){const c=a[s],u=a[s+1],l=a[s+2];if(a[s+3]>10&&(c<245||u<245||l<245))return}throw new Error("PNG generado en blanco")}async function M({cycle:i,entries:n,widthPx:o,heightPx:e,pixelRatio:r=1.5}){if(typeof window>"u")throw new Error("renderCycleChartToPng solo está disponible en el navegador.");const t=document.createElement("div");t.style.position="fixed",t.style.left="-10000px",t.style.top="0",t.style.width=`${o}px`,t.style.height=`${e}px`,t.style.background="#ffffff",t.style.pointerEvents="none",t.style.zIndex="-1",document.body.appendChild(t);const a=m.createRoot(t);try{g.flushSync(()=>{a.render(h.jsx(p,{data:n,isFullScreen:!0,orientation:"landscape",onToggleIgnore:()=>{},onEdit:()=>{},onTogglePeak:()=>{},cycleId:i?.id??"export",initialScrollIndex:0,visibleDays:Math.max(n?.length??0,1),showInterpretation:!1,reduceMotion:!0,forceLandscape:!0,currentPeakIsoDate:null,showRelationsRow:!1,fertilityStartConfig:null,fertilityCalculatorCycles:[],fertilityCalculatorCandidates:null,onShowPhaseInfo:null,isArchivedCycle:!1,cycleEndDate:i?.endDate??null,exportMode:!0}))}),document.fonts?.ready&&await document.fonts.ready,g.flushSync(()=>{}),document.fonts?.ready&&await document.fonts.ready;const s=await y(t),c=await v(s,{widthPx:o,heightPx:e,pixelRatio:r,background:"#ffffff"});return await C(c),{dataUrl:c,widthPx:o,heightPx:e}}finally{a.unmount(),t.remove()}}export{M as renderCycleChartToPng};
