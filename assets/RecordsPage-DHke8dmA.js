import{c as xt,r as n,k as x,f as m,j as s,J as C,B as ht,V as ia,g as w,q as Oe,o as S,u as es,b as ts,l as ea,W as as,m as be}from"./index-SThGP-UZ.js";import{L as yt,T as ss,a as rs,N as ns,P as os,C as ls}from"./PostpartumExitDialog-DQiCXUxP.js";import{C as is,A as cs,D as us}from"./DataEntryForm-C6Jv8bxR.js";import{l as fe}from"./badge-NjDKYZGp.js";import{T as ds,D as ms,C as fs}from"./peak-mode-button-DESZS8hz.js";import{D as ta}from"./DeletionDialog-C6up7S7T.js";import{u as ps,i as Le,D as hs,a as ys}from"./useCycleData-DQN_kvv9.js";import{a as gs,H as xs}from"./HeaderIconButton-BTfwmpwK.js";import{m as aa,i as Pe,f as bs,P as ws,e as Ds}from"./useBackClose-B75B8Nzp.js";import{c as vs,F as sa}from"./computePeakStatuses-DuBnmQQE.js";import"./label-vmCeSukg.js";import"./eye-DAicHzhc.js";const ra=xt("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),Cs=xt("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),js=xt("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),Ns=({isoDate:c,cycleDay:D,details:l,peakStatus:b,isPeakDay:k,onEdit:p,onDelete:P,onAdd:M,onToggleRelations:ve,isProcessing:E})=>{const $e=!!l?.record,Be=n.useMemo(()=>{if(!c)return null;try{return x(m(c),"dd/MM/yyyy",{locale:fe})}catch{return null}},[c]),Ce=l?.symbolInfo?.label||"Sin símbolo",je=l?.symbolInfo?.value||"none",Q=l?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",ze=()=>{!l?.record||!p||p(l.record,null)},He=()=>{!l?.record?.id||!P||P(l.record.id)},Ve=()=>{!c||!M||M(c)},O=(r,V=null)=>{if(l?.record&&p){p(l.record,r,V);return}c&&M&&M(c,r,V)},N=()=>{!c||!ve||ve(c)},A=(r,V={})=>r&&typeof r=="string"&&r.trim().length>0||typeof r=="number"?r:V.placeholder||"—",Ue=l?.hasTemperature?`${l.displayTemp} °C`:"—",Ye=l?.timeValue||"—",Xe=!!l?.timeValue,qe=l?.hasMucusSensation?l.mucusSensation:"—",We=l?.hasMucusAppearance?l.mucusAppearance:"—",Ne=l?.observationsText?.trim(),Z=!!l?.hasRelations;let ee=null,te=null;b&&(b==="P"||k?(ee="Día pico",te="peak"):(ee=`+${b}`,te="post-peak"));const Ge=()=>{switch(je){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!c)return s.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const I="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return s.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Be,D?` · Día ${D}`:""]}),ee&&s.jsx("span",{className:C("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:ee})]}),s.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[s.jsx("button",{type:"button",onClick:()=>O("symbol","fertilitySymbol"),className:C("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ge(),Q),title:Ce,"aria-label":Ce}),$e?s.jsxs(s.Fragment,{children:[s.jsxs(ht,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:ze,disabled:E,children:[E?s.jsx(yt,{className:"h-4 w-4 animate-spin"}):s.jsx(js,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Editar registro"})]}),s.jsxs(ht,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:He,disabled:E,children:[E?s.jsx(yt,{className:"h-4 w-4 animate-spin"}):s.jsx(ss,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):s.jsxs(ht,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:Ve,disabled:E,children:[E&&s.jsx(yt,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),s.jsxs("div",{className:"mt-4 space-y-3",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>O("temperature","temperature"),className:C(I,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",l?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[s.jsx(ds,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"font-semibold",children:A(Ue)}),l?.showCorrectedIndicator&&s.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),s.jsxs("button",{type:"button",onClick:()=>O("temperature","time"),className:C(I,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Xe?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[s.jsx(is,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:A(Ye)})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>O("sensation","mucusSensation"),className:C(I,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",l?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[s.jsx(ms,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:A(qe)})]}),s.jsxs("button",{type:"button",onClick:()=>O("appearance","mucusAppearance"),className:C(I,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",l?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[s.jsx(fs,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"font-semibold",children:A(We)})]})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("button",{type:"button",onClick:()=>O("observations","observations"),className:C(I,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Ne?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[s.jsx(Cs,{className:"h-5 w-5 shrink-0 opacity-80"}),s.jsx("span",{className:"truncate",children:A(Ne,{placeholder:"-"})})]}),s.jsx("button",{type:"button",onClick:N,disabled:E,className:C("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Z?"border-rose-50 bg-rose-50":"border-slate-200 bg-white",E&&"opacity-70 cursor-not-allowed"),title:Z?"Hubo relaciones":"Sin relaciones","aria-label":Z?"Hubo relaciones":"Sin relaciones",children:s.jsx(ia,{className:C("h-4 shrink-0 w-4",Z?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},ca=c=>c.replace(".","").toLowerCase(),we=c=>ca(x(c,"MMM",{locale:fe})),Ss=c=>ca(x(c,"d MMM yyyy",{locale:fe})),ks=({startDate:c,endDate:D})=>{if(!D){if(!c)return"Mis registros";const M=m(c);return w(M)?`${Ss(M)} - actualidad`:"Mis registros"}if(!c)return"Mis registros";const l=m(c),b=m(D);if(!w(l)||!w(b))return"Mis registros";const k=l.getFullYear()===b.getFullYear();if(k&&l.getMonth()===b.getMonth())return`${l.getDate()}–${b.getDate()} ${we(l)} ${l.getFullYear()}`;if(k)return`${l.getDate()} ${we(l)} – ${b.getDate()} ${we(b)} ${l.getFullYear()}`;const P=`${l.getFullYear()}–${String(b.getFullYear()).slice(-2)}`;return`${l.getDate()} ${we(l)} – ${b.getDate()} ${we(b)} · ${P}`},Ms=({startDate:c,endDate:D,recordCount:l=0,referenceDate:b=new Date})=>{if(!c)return`${l} registros`;const k=m(c);if(!w(k))return`${l} registros`;if(!D)return`Día ${Oe(S(b),S(k))+1} · ${l} registros`;const p=m(D);return w(p)?`${Oe(S(p),S(k))+1} días · ${l} registros`:`${l} registros`},Es=c=>sa.find(D=>D.value===c)||sa[0],na=10,gt=60,oa=750,la=120,Rs=85,_s=5,De=180,As=c=>{if(c==null||c==="")return null;const D=Number(typeof c=="string"?c.replace(",","."):c);return Number.isFinite(D)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(D):null},Is=({cycle:c,headerTitle:D,headerIcon:l=ra,headerActions:b,topAccessory:k,includeEndDate:p=!1,addOrUpdateDataPoint:P,deleteRecord:M,isLoading:ve,updateCycleDates:E,checkCycleOverlap:$e,startNewCycle:Be,refreshData:Ce,afterRecordsContent:je=null,onRequestDeleteCycle:Q=null,dateEditorDeleteTitle:ze="Eliminar ciclo",dateEditorDeleteDescription:He="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:Ve="Eliminar ciclo",isDeletingCycle:O=!1}={})=>{const{currentCycle:N,archivedCycles:A,addOrUpdateDataPoint:Ue,deleteRecord:Ye,isLoading:Xe,updateCycleDates:qe,checkCycleOverlap:We,startNewCycle:Ne,refreshData:Z,getMeasurementsForEntry:ee,undoCurrentCycle:te}=ps(),{preferences:Ge,savePreferences:I}=es(),r=c??N,V=ve??Xe,Je=P||(async(e,t)=>{if(r?.id)return Ue(e,t,r.id)}),ua=M||(async e=>{if(r?.id)return Ye(e,r.id)}),Se=E||(async(e,t,a)=>qe(e??r?.id,t,a)),Ke=$e??We,da=Be??Ne,ke=Ce??Z,Qe=ee,{toast:R}=ts(),[ma,U]=n.useState(!1),[Ze,Y]=n.useState(null),[ae,et]=n.useState(null),[fa,tt]=n.useState(!1),[at,bt]=n.useState(!1),[se,re]=n.useState(!1),[pa,st]=n.useState(!1),[ha,wt]=n.useState(!1),[X,Me]=n.useState(()=>r?.startDate||""),[q,Ee]=n.useState(()=>r?.endDate||""),[ya,$]=n.useState(""),[Re,Dt]=n.useState(null),[rt,vt]=n.useState(null),[nt,Ct]=n.useState(!1),[ga,jt]=n.useState(null),[xa,ot]=n.useState(!1),[lt,pe]=n.useState(!1),[y,W]=n.useState(null),[ba,G]=n.useState(null),[wa,he]=n.useState(null),[Da,ne]=n.useState(null),[va,it]=n.useState(!1),[Ca,ct]=n.useState(!1),Nt=r?.data?.length??0,St=!r?.endDate,oe=n.useMemo(()=>{if(!N?.id||N?.endDate||!r?.id||r.id!==N.id||!N?.startDate)return null;const e=m(N.startDate);if(!w(e))return null;const t=x(ea(e,-1),"yyyy-MM-dd"),a=A.filter(o=>o?.endDate===t);return a.length?a.sort((o,i)=>(i.startDate||"").localeCompare(o.startDate||""))[0]:null},[A,N,r?.id]),ut=n.useMemo(()=>{if(!oe?.startDate||!oe?.endDate)return"";const e=m(oe.startDate),t=m(oe.endDate);if(!w(e)||!w(t))return"";const a=o=>x(o,"dd MMM yy",{locale:fe}).replace(".","");return`${a(e)} - ${a(t)}`},[oe]),ja=n.useMemo(()=>`¿Quieres unir el ciclo actual al ciclo anterior${ut?` (${ut})`:""}? Esta acción no se puede deshacer.`,[ut]),Na=n.useCallback(async()=>{ct(!1),typeof I=="function"&&await I({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[I]),Sa=n.useMemo(()=>D||ks({startDate:r?.startDate,endDate:r?.endDate}),[r?.endDate,r?.startDate,D]),kt=n.useMemo(()=>Ms({startDate:r?.startDate,endDate:r?.endDate,recordCount:Nt}),[r?.endDate,r?.startDate,Nt]),Mt=!0,_e=n.useRef(null),Et=n.useRef(null),Rt=n.useRef(0),ye=n.useRef(null),[_t,At]=n.useState(0),Ae=n.useCallback(()=>{const e=_e.current;if(!e){Rt.current=0,At(0);return}const a=e.getBoundingClientRect().height;Rt.current=a,At(o=>Math.abs(o-a)>.5?a:o)},[]);n.useLayoutEffect(()=>{let e=window.requestAnimationFrame(Ae);const t=()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(Ae)};window.addEventListener("resize",t);let a;return typeof ResizeObserver<"u"&&(a=new ResizeObserver(()=>{e&&window.cancelAnimationFrame(e),e=window.requestAnimationFrame(Ae)}),_e.current&&a.observe(_e.current)),()=>{window.removeEventListener("resize",t),a&&a.disconnect(),e&&window.cancelAnimationFrame(e)}},[Ae]);const It=n.useMemo(()=>Math.max(Math.round(_t+na),na),[_t]);n.useEffect(()=>{Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate]);const Ie=n.useMemo(()=>r?.data?.length?[...r.data].filter(e=>e?.isoDate).sort((e,t)=>{const a=m(e.isoDate);return m(t.isoDate)-a}).map(e=>e.isoDate):[],[r?.data]);n.useEffect(()=>{const e=Et.current;e&&e.scrollTo({top:0,behavior:"auto"})},[]);const le=n.useMemo(()=>r?.data?.length?r.data.map(e=>{if(!e?.isoDate)return null;const t=m(e.isoDate);return w(t)?t:null}).filter(Boolean):[],[r?.data]),Tt=n.useMemo(()=>new Set(Ie),[Ie]),J=n.useMemo(()=>vs(r?.data??[]),[r?.data]),ie=n.useMemo(()=>{const e=new Map;return r?.data?.length&&r.data.forEach(t=>{if(!t?.isoDate)return;const a=t.measurements?.find(Za=>Za?.selected)||(t.temperature_chart||t.temperature_raw?{temperature:t.temperature_chart??t.temperature_raw,temperature_corrected:t.temperature_corrected??null,time:t.timestamp?x(m(t.timestamp),"HH:mm"):null,use_corrected:t.use_corrected??!1}:null),o=a?.use_corrected??t.use_corrected??!1,i=a?.temperature_corrected??t.temperature_corrected??null,d=a?.temperature??t.temperature_chart??t.temperature_raw??null,g=As(o&&i!==null&&i!==void 0&&i!==""?i:d??i),u=g!==null,v=o&&i!==null&&i!==void 0&&i!=="";let f=null;a?.time?f=a.time:t.timestamp&&w(m(t.timestamp))&&(f=x(m(t.timestamp),"HH:mm"));const _=t.mucusSensation??t.mucus_sensation??"",de=t.mucusAppearance??t.mucus_appearance??"",me=!!_,H=!!de,pt=me||H,xe=t.observations||"",Fe=!!xe,Ja=!!(t.had_relations??t.hadRelations??!1),Zt=J[t.isoDate]||null,Ka=t.peak_marker==="peak"||Zt==="P",Qa=Es(t.fertility_symbol);e.set(t.isoDate,{record:t,symbolInfo:Qa,hasTemperature:u,displayTemp:g,showCorrectedIndicator:v,timeValue:f,hasMucus:pt,hasMucusSensation:me,hasMucusAppearance:H,mucusSensation:_,mucusAppearance:de,hasObservations:Fe,observationsText:xe,hasRelations:Ja,peakStatus:Zt,isPeakDay:Ka})}),e},[r?.data,J]),h=n.useMemo(()=>{if(!r?.startDate)return null;const e=m(r.startDate);if(!w(e))return null;let t;if(r?.endDate)t=m(r.endDate);else{const a=S(new Date),o=[e,a];le.length&&o.push(aa(le)),t=aa(o)}return w(t)?{from:e,to:t}:{from:e,to:e}},[r?.startDate,r?.endDate,le]),ka=n.useMemo(()=>{const e={};return h&&(e.outsideCycle=t=>Pe(t,h.from)||Le(t,h.to),e.insideCycleNoRecord=t=>{if(Pe(t,h.from)||Le(t,h.to))return!1;const a=x(t,"yyyy-MM-dd");return!Tt.has(a)}),le.length&&(e.hasRecord=le),e},[h,le,Tt]),Ma=n.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:C(as({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[Ft,dt]=n.useState(()=>y&&w(m(y))?m(y):h?.to?h.to:S(new Date)),ge=n.useRef(!1),T=n.useRef(null),Ea=n.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),K=n.useRef(null),Lt=n.useRef(null),Pt=n.useRef(null),Ot=n.useRef(0),[Ra,_a]=n.useState(0),[$t,Bt]=n.useState(!1),B=n.useCallback(e=>{Ot.current=e,_a(e)},[]),zt=n.useCallback(()=>new Promise(e=>{requestAnimationFrame(()=>{requestAnimationFrame(e)})}),[]),ce=n.useCallback((e,{duration:t=De}={})=>{T.current&&(cancelAnimationFrame(T.current),T.current=null);const a=Ot.current,o=e-a;return Math.abs(o)<.5||t<=0?(B(e),Promise.resolve()):new Promise(i=>{const d=u=>1-Math.pow(1-u,3),j=performance.now(),g=u=>{const v=u-j,f=Math.min(1,v/t),_=a+o*d(f);if(B(_),f<1){T.current=requestAnimationFrame(g);return}T.current=null,i()};T.current=requestAnimationFrame(g)})},[B]),Aa=n.useMemo(()=>({labelDay:e=>{const t=x(e,"yyyy-MM-dd"),a=ie.get(t),o=x(e,"d MMM",{locale:fe}),i=a?.peakStatus??J[t]??null,d=[];if(a?.hasTemperature&&a?.hasMucus?d.push("temperatura y moco"):a?.hasTemperature?d.push("temperatura"):a?.hasMucus&&d.push("moco"),a?.hasRelations&&d.push("RS"),i){const j=i==="P"?"pico ✖":`pico +${i}`;d.push(j)}return d.length?`${o}: ${d.join("; ")}`:o}}),[J,ie]),Ia=n.useCallback(({date:e,activeModifiers:t})=>{const a=x(e,"yyyy-MM-dd"),o=ie.get(a),i=o?.hasTemperature??!1,d=o?.hasMucus??!1,j=o?.hasRelations??!1,g=o?.peakStatus??J[a]??null,u=o?.symbolInfo,v=u?.value,f=t.selected,_=t.today,de=C("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",i?"bg-amber-500":"bg-transparent",i&&f?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),me=C("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",d?"bg-teal-500":"bg-transparent",d&&f?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),H=!!(v&&v!=="none"),pt=C("relative z-10 text-[1.15rem] leading-none",t.outside||t.outsideCycle?"text-slate-300":f?H?"text-white":"text-fertiliapp-fuerte":_?"text-subtitulo font-semibold":"text-slate-700"),xe=g==="P"?"✖":g?`+${g}`:null,Fe=H?C("pointer-events-none absolute inset-0 rounded-full transition-opacity",u?.color??"",u?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",v==="white"?"ring-1 ring-slate-300/70":"",f?"opacity-50":"opacity-25"):null;return s.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[s.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[_&&!f&&!(t.outside||t.outsideCycle)&&s.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),f&&s.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[2px] rounded-full bg-tarjeta border-2 border-fertiliapp-fuerte"}),Fe&&s.jsx("span",{className:Fe,"aria-hidden":"true"}),s.jsx("span",{className:pt,children:x(e,"d")}),j&&s.jsx(ia,{"aria-hidden":"true",className:"pointer-events-none absolute -bottom-[0.2px] -right-[0.2px] h-2 w-2 text-rose-500 fill-current"})]}),s.jsxs("div",{className:"mt-[0.2rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[s.jsx("span",{className:de}),s.jsx("span",{className:me})]}),xe&&s.jsx("span",{"aria-hidden":"true",className:C("pointer-events-none absolute -top-[1px] right-[0.5px] rounded-sm px-[2px] text-[0.75rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",f?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:xe})]})},[J,ie]),z=n.useMemo(()=>{if(!r?.startDate)return[];const e=m(r.startDate);if(!w(e))return[];const t=S(e),a=S(new Date);let o=h?.to?S(h.to):a;Le(o,a)&&(o=a),Pe(o,t)&&(o=t);const i=Oe(o,t)+1;if(i<=0)return[];const d=[];for(let j=i-1;j>=0;j-=1){const g=ea(t,j),u=x(g,"yyyy-MM-dd"),v=Oe(g,t)+1,f=ie.get(u)||null;d.push({isoDate:u,date:g,cycleDay:v,details:f})}return d},[r?.startDate,h,ie]),ue=n.useMemo(()=>new Set(z.map(e=>e.isoDate)),[z]),Ta=n.useMemo(()=>{const e=new Map;return z.forEach(t=>{e.set(t.isoDate,t)}),e},[z]),Ht=y&&Ta.get(y)||null,mt=Ht?.details??null,Vt=mt?.peakStatus??(y?J[y]??null:null),Fa=mt?.isPeakDay??Vt==="P",Te=n.useMemo(()=>{if(!h)return null;const e=h?.to?x(S(h.to),"yyyy-MM-dd"):null,t=h?.from?x(S(h.from),"yyyy-MM-dd"):null;if(!r?.endDate){const a=x(S(new Date),"yyyy-MM-dd");if(ue.has(a))return a}return e&&ue.has(e)?e:t&&ue.has(t)?t:Ie[0]??null},[r?.endDate,h,ue,Ie]);n.useEffect(()=>{if(!(y&&ue.has(y))){if(!Te){y!==null&&W(null);return}y!==Te&&W(Te)}},[y,ue,Te]);const Ut=n.useCallback(e=>{if(!e)return;const t=x(e,"yyyy-MM-dd");h&&(Pe(e,h.from)||Le(e,h.to))||W(t)},[h]);n.useEffect(()=>{if(!y)return;const e=m(y);w(e)&&dt(t=>t&&t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()?t:e)},[y]);const Yt=n.useCallback(e=>{dt(t=>{const a=t??h?.to??S(new Date);return bs(a,e==="next"?1:-1)})},[h]);n.useEffect(()=>{const e=Lt.current;if(!e)return;const t=e.querySelector(".records-calendar-day-grid");t&&(Pt.current=t)},[Ft,Mt,B]);const ft=n.useCallback(async e=>{if(ge.current)return;ge.current=!0;const a=Pt.current?.getBoundingClientRect()?.width??0,o=e==="next"?-la:la,i=a?e==="next"?-a:a:o,d=-i;try{await ce(i,{duration:De}),Yt(e),B(d),await zt(),await ce(0,{duration:De})}finally{ge.current=!1}},[ce,Yt,B,zt]),F=n.useCallback(()=>{Dt(null),vt(null),Ct(!1),jt(null),ot(!1)},[]);n.useEffect(()=>()=>{T.current&&(cancelAnimationFrame(T.current),T.current=null),K.current&&(K.current(),K.current=null)},[]);const Xt=n.useCallback(()=>{Me(r?.startDate||""),Ee(r?.endDate||""),$(""),F(),wt(!0)},[r?.startDate,r?.endDate,F]),L=n.useCallback(()=>{wt(!1),$(""),F(),Me(r?.startDate||""),Ee(r?.endDate||"")},[r?.startDate,r?.endDate,F]),La=n.useCallback(async()=>{if(N?.id){bt(!0);try{await te(N.id),tt(!1),L()}catch(e){console.error("Failed to undo cycle",e)}finally{bt(!1)}}},[L,N?.id,te]),Pa=n.useCallback(()=>{Q&&(L(),Q())},[L,Q]),Oa=n.useCallback(e=>{if(ge.current||e.pointerType==="mouse"&&e.button!==0)return;const t=e.target.closest(".records-calendar-day-grid");if(!t)return;const a=Ea.current;a.active=!0,a.pointerId=e.pointerId,a.startX=e.clientX,a.startTime=performance.now(),a.dragging=!1;const o=t.getBoundingClientRect().width||0;a.gridWidth=o,a.swipeThreshold=o?Math.max(gt,o*.25):gt;const i=g=>{if(!a.active||g.pointerId!==a.pointerId)return;const u=g.clientX-a.startX;if(!a.dragging&&Math.abs(u)>_s&&(a.dragging=!0,Bt(!0)),!a.dragging)return;const v=a.gridWidth?a.gridWidth*.7:Rs,f=Math.max(-v,Math.min(v,u));g.preventDefault(),B(f)},d=async g=>{if(!a.active||g.pointerId!==a.pointerId)return;K.current?.(),K.current=null,a.active=!1;const u=g.clientX-a.startX,v=performance.now()-a.startTime,f=v>0?u/v*1e3:0,_=a.swipeThreshold||gt,de=u<=-_||f<=-oa,me=u>=_||f>=oa,H=a.dragging;if(a.dragging=!1,Bt(!1),ge.current){await ce(0,{duration:De});return}if(H&&de){await ft("next");return}if(H&&me){await ft("prev");return}await ce(0,{duration:De})},j=()=>{window.removeEventListener("pointermove",i,{capture:!0}),window.removeEventListener("pointerup",d,{capture:!0}),window.removeEventListener("pointercancel",d,{capture:!0})};K.current?.(),K.current=j,window.addEventListener("pointermove",i,{capture:!0,passive:!1}),window.addEventListener("pointerup",d,{capture:!0}),window.addEventListener("pointercancel",d,{capture:!0})},[ft,ce,Mt,B]),$a=n.useCallback(()=>{F()},[F]),Ba=n.useCallback(async()=>{if(!X){$("La fecha de inicio es obligatoria");return}if(p&&q&&q<X){$("La fecha de fin no puede ser anterior al inicio");return}if(r?.id){$(""),pe(!0);try{const e=Ke?await Ke(r.id,X,p&&q||void 0):null;if(e){Dt(X),vt((p&&q||void 0)??null),Ct(!!p),jt(e),ot(!0),pe(!1);return}await Se(r.id,X,p&&q||void 0),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),L()}catch(e){console.error("Error updating start date from records page:",e),$("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{pe(!1)}}},[X,q,p,r?.id,Ke,Se,ke,R,L]),za=n.useCallback(async()=>{if(!r?.id||!Re){F();return}pe(!0),ot(!1);try{const e=r.startDate,t=r.endDate??void 0,a=Re!==e,o=nt?rt??void 0:void 0,i=nt&&rt!==null&&o!==t;await Se(r.id,a?Re:void 0,o),await ke({silent:!0}),R({title:"Fechas actualizadas",description:"El ciclo se ha ajustado a las nuevas fechas."}),L()}catch(e){console.error("Error adjusting cycle dates from records page:",e),$("No se pudieron actualizar las fechas"),R({title:"Error",description:"No se pudieron actualizar las fechas.",variant:"destructive"})}finally{pe(!1),F()}},[r?.id,r?.startDate,r?.endDate,Re,nt,rt,Se,ke,R,L,F]),qt=n.useCallback(()=>{U(!1),Y(null),G(null),he(null),ne(null),st(!1),ye.current=null},[]),Wt=n.useCallback(async(e,t=null,a=null)=>{if(!e)return;ye.current=e.id??null,Y(e),G(e.isoDate??null),he(t),ne(a??null),e.isoDate&&W(e.isoDate),U(!0);const o=e?.measurementsLoaded||Array.isArray(e?.measurements)&&e.measurements.length>0;if(Qe&&e?.id&&r?.id&&!o){st(!0);try{const i=await Qe(r.id,e.id);ye.current===e.id&&Y(d=>d?.id===e.id?{...d,measurements:i,measurementsLoaded:!0}:d)}finally{st(!1)}}},[r?.id,Qe]),Ha=n.useCallback((e,t=null,a=null)=>Wt(e,a,t),[Wt]),Va=e=>{const t=r?.data?.find(a=>a.id===e);et(t||null)},Ua=n.useCallback(e=>{Y(e)},[]),Ya=n.useCallback((e,t=null,a=null)=>{e&&(ye.current=null,W(e),Y(null),G(e),he(a),ne(t),U(!0))},[]),Gt=n.useCallback(()=>{const e=z.length?z[0].isoDate:r?.startDate||null,t=y||e||null;ye.current=null,Y(null),G(t),he(null),ne(null),t&&W(t),U(!0)},[z,r?.startDate,y]),Jt=n.useCallback((e,t={})=>{const a=r?.data?.find(u=>u.isoDate===e)||null,o=a?.timestamp&&w(m(a.timestamp))?x(m(a.timestamp),"HH:mm"):x(new Date,"HH:mm"),i=a?.temperature_raw??a?.temperature??"",d=a?.temperature_corrected??"",j=!!a?.use_corrected,g=a?.measurements?.length?a.measurements.map((u,v)=>{const f=u?.time||(u?.timestamp&&w(m(u.timestamp))?x(m(u.timestamp),"HH:mm"):o);return{temperature:u?.temperature??u?.temperature_raw??i,temperature_corrected:u?.temperature_corrected??d,time:f,time_corrected:u?.time_corrected||f,use_corrected:u?.use_corrected!==void 0?!!u?.use_corrected:j,selected:!!(u?.selected??v===0)}}):[{temperature:i,temperature_corrected:d,time:o,time_corrected:o,use_corrected:j,selected:!0}];return{isoDate:e,measurements:g,mucusSensation:a?.mucusSensation??a?.mucus_sensation??"",mucusAppearance:a?.mucusAppearance??a?.mucus_appearance??"",fertility_symbol:a?.fertility_symbol??a?.fertilitySymbol??"none",observations:a?.observations??"",peak_marker:a?.peak_marker??null,ignored:a?.ignored??!1,...t}},[r?.data]),Xa=async(e,{keepFormOpen:t=!1}={})=>{re(!0);try{await Je(e,Ze),R({title:"Guardado",duration:2e3}),t||(U(!1),Y(null),G(null),he(null),ne(null))}catch{R({title:"Error",description:"No se pudo guardar el registro",variant:"destructive"})}finally{re(!1),t&&G(e?.isoDate??null)}},qa=n.useCallback(async e=>{if(!e)return;const t=r?.data?.find(i=>i.isoDate===e)||null,a=!!(t?.had_relations??t?.hadRelations??!1),o=Jt(e,{had_relations:!a,hadRelations:!a});re(!0);try{await Je(o,t)}catch{R({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{re(!1)}},[Je,Jt,r?.data,R]),Wa=async()=>{if(ae){re(!0);try{const e=ae.isoDate;await ua(ae.id),et(null),G(null),e&&y===e&&W(e)}catch{R({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{re(!1)}}},Kt={openDateEditor:Xt,openAddRecord:Gt,isProcessing:se,isUpdatingDates:lt,cycle:r},Ga=typeof b=="function"?b(Kt):s.jsxs(s.Fragment,{children:[s.jsxs(gs,{type:"button",onClick:Xt,className:"text-subtitulo",disabled:se||lt,"aria-label":p?"Editar fechas del ciclo":"Editar fecha de inicio",children:[s.jsx(rs,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:p?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),s.jsxs(xs,{type:"button",onClick:Gt,disabled:se,"aria-label":"Añadir registro",children:[s.jsx(ws,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),Qt=typeof k=="function"?k({...Kt}):k??null;return V&&!r?.id?s.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:s.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):r?.id?s.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[s.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[s.jsx("div",{ref:_e,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:s.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:s.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[s.jsx(be.div,{className:"flex flex-col gap-2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:s.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/50 p-3 shadow-sm backdrop-blur-md",children:s.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[s.jsxs("div",{className:"flex items-center justify-between gap-2 text-[10px] uppercase tracking-[0.18em] text-base",children:[s.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[Qt&&s.jsx("div",{className:"flex items-center",children:Qt}),s.jsx("span",{children:St?"CICLO ACTUAL":"CICLO ARCHIVADO"})]}),s.jsx("div",{className:"flex shrink-0 items-center gap-2",children:Ga})]}),s.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[s.jsx(l,{className:"h-5 w-5 text-subtitulo"}),s.jsx("span",{className:C("font-semibold text-titulo leading-tight","text-[21px] sm:text-[22px]"),children:Sa})]}),kt&&s.jsx("div",{className:"text-[13px] text-base whitespace-nowrap",children:kt})]})})}),ha&&s.jsx(be.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:s.jsx(ls,{cycle:r,startDate:X,endDate:p?q:r?.endDate,otherCycles:[...A??[],N].filter(Boolean),onStartDateChange:e=>Me(e),onEndDateChange:p?e=>Ee(e):void 0,onSave:Ba,onCancel:L,isProcessing:lt||V||at,dateError:ya,includeEndDate:p,showOverlapDialog:xa,overlapCycle:ga,onConfirmOverlap:za,onCancelOverlap:$a,onClearError:()=>$(""),saveLabel:p?"Guardar fechas":"Guardar cambios",title:p?"Editar fechas del ciclo":"Editar fecha de inicio",description:p?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onUndoCycle:oe?()=>tt(!0):void 0,isUndoingCycle:at,onDeleteCycle:Q?Pa:void 0,deleteTitle:ze,deleteDescription:He,deleteLabel:Ve,isDeletingCycle:O})}),s.jsx(cs,{initial:!1,children:s.jsx(be.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:s.jsx("div",{ref:Lt,onPointerDown:Oa,"data-calendar-dragging":$t?"true":"false",className:C("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:[transform:translate3d(var(--calendar-drag-x,0px),0,0)]",$t?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${Ra}px`},children:s.jsx(Ds,{mode:"single",locale:fe,month:Ft??void 0,onMonthChange:dt,selected:y&&w(m(y))?m(y):void 0,onSelect:Ut,onDayClick:Ut,modifiers:ka,labels:Aa,components:{DayContent:Ia},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:Ma,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),s.jsxs("div",{ref:Et,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:It,maxHeight:`calc(h-app - ${It}px )`,WebkitOverflowScrolling:"touch"},children:[s.jsx(be.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:z.length===0?s.jsx(be.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:s.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[s.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:s.jsx(ra,{className:"h-9 w-9"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),s.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):s.jsx(Ns,{isoDate:y,cycleDay:Ht?.cycleDay??null,details:mt,peakStatus:Vt,isPeakDay:Fa,onEdit:Ha,onDelete:Va,onAdd:Ya,onToggleRelations:qa,isProcessing:se})}),je&&s.jsx("div",{className:"pt-4 space-y-4",children:je})]})]}),s.jsx(hs,{open:ma,onOpenChange:e=>{e?U(!0):qt()},children:s.jsx(ys,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:s.jsx(us,{onSubmit:Xa,onCancel:qt,initialData:Ze,cycleStartDate:r?.startDate,cycleEndDate:r?.endDate,isProcessing:se||pa,isEditing:!!Ze,cycleData:r?.data,onDateSelect:Ua,defaultIsoDate:ba,focusedField:wa,initialSectionKey:Da})})}),s.jsx(ta,{isOpen:fa,onClose:()=>tt(!1),onConfirm:La,title:"Deshacer ciclo",confirmLabel:"Deshacer ciclo",cancelLabel:"Cancelar",description:ja,isProcessing:at}),s.jsx(ta,{isOpen:!!ae,onClose:()=>et(null),onConfirm:Wa,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:ae?`¿Estás seguro de que quieres eliminar el registro del ${x(m(ae.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:se})]}):s.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[s.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[s.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),s.jsx("button",{onClick:()=>it(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),s.jsx(ns,{isOpen:va,onClose:()=>it(!1),onConfirm:async e=>{await da(e),it(!1),ne(null),U(!0),Ge?.fertilityStartConfig?.postpartum===!0&&ct(!0)},currentCycleRecords:r?.data??[]}),s.jsx(os,{isOpen:Ca,onClose:()=>ct(!1),onConfirm:Na})]})},Xs=()=>s.jsx(Is,{});export{Is as RecordsExperience,Xs as default};
