import{c as F,q as T,a as J,u as V,b as H,r as l,g as S,f,j as s,B as p,L as R,o as W,l as L,k as Z}from"./index-C041RoKp.js";import{D as G}from"./DeletionDialog-BtycWigc.js";import{u as K}from"./useCycleData-fUMApAkg.js";import{RecordsExperience as Q}from"./RecordsPage-rKEZsGq4.js";import{A as X}from"./arrow-left-CEy_h0Do.js";import{P as Y}from"./badge-BbO7fxzd.js";import"./NewCycleDialog-pYL8DOtB.js";import"./OverlapWarningDialog-CRNazV6l.js";import"./input-D9upNPQ0.js";import"./computePeakStatuses-Dl9gvYQS.js";import"./label-DmhTYPl7.js";import"./checkbox-DTslPdqR.js";import"./eye-fkTjB7nE.js";const ee=F("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),ae=(c,d)=>{const t=L(f(c)),r=L(f(d));return Z(t,r)+1},te=(c,d)=>!c||!Array.isArray(c)||!d?[]:[...c].sort((r,m)=>f(r.isoDate)-f(m.isoDate)).map(r=>({...r,ignored:r.ignored||!1,cycleDay:ae(r.isoDate,d)})),pe=()=>{const{cycleId:c}=T(),d=J(),{user:t}=V(),{getCycleById:r,isLoading:m,addOrUpdateDataPoint:g,deleteRecord:x,updateCycleDates:v,deleteCycle:b,checkCycleOverlap:$,forceUpdateCycleStart:w,refreshData:j}=K(),{toast:u}=H(),[a,N]=l.useState(null),[A,D]=l.useState(!1),[k,E]=l.useState(!1),y=a?`${S(f(a.startDate),"dd/MM/yyyy")} - ${a.endDate?S(f(a.endDate),"dd/MM/yyyy"):"En curso"}`:"",C=l.useCallback(e=>{if(!t||!e?.id)return;const i={...e,data:(e.data||[]).map(({cycleDay:o,...n})=>n)};localStorage.setItem(`fertilityData_cycle_${t.uid}_${e.id}`,JSON.stringify(i))},[t]),h=l.useCallback(async()=>{if(!t||!c)return null;const e=await r(c);return e&&(C(e),N(e)),e},[c,r,C,t]);l.useEffect(()=>{(async()=>{if(!t)return;let i=await r(c);if(!i){const o=localStorage.getItem(`fertilityData_cycle_${t.uid}_${c}`);if(o){const n=JSON.parse(o);i={...n,data:te(n.data||[],n.startDate)}}}i?(C(i),N(i)):(u({title:"Error",description:"No se pudo cargar el ciclo.",variant:"destructive"}),d("/archived-cycles"))})()},[c,t,r,u,d]);const O=l.useCallback(async(e,i)=>{if(!a?.id||!t)return;const o=!!i;await g(e,i,a.id),await h()&&u({title:o?"Registro actualizado":"Nuevo registro añadido",description:"Datos del ciclo actualizados."})},[a?.id,t,g,h,u]),P=l.useCallback(async e=>{!a?.id||!t||(await x(e,a.id),await h(),u({title:"Registro eliminado",description:"El registro ha sido eliminado."}))},[a?.id,t,x,h,u]),q=l.useCallback(async(e,i,o)=>{const n=e??a?.id;!t||!n||await v(n,i,o)},[a?.id,t,v]),I=l.useCallback(async(e,i)=>{const o=e??a?.id;!t||!o||await w(o,i)},[a?.id,t,w]),U=l.useCallback(async e=>{await j(e),await h()},[j,h]),z=()=>{D(!0)},M=l.useCallback(async()=>{if(!(!a?.id||!t)){E(!0);try{await b(a.id),u({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),d("/archived-cycles")}catch(e){console.error(e),u({title:"Error",description:"No se pudo eliminar el ciclo.",variant:"destructive"})}finally{E(!1),D(!1)}}},[a?.id,b,d,u,t]),_=l.useCallback(()=>s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(p,{asChild:!0,variant:"outline",size:"icon",className:"shrink-0 ml-2 rounded-full border-fertiliapp-fuerte text-fertiliapp-fuerte hover:brightness-95",children:s.jsxs(R,{to:"/archived-cycles","aria-label":"Volver a mis ciclos",children:[s.jsx(X,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Mis ciclos"})]})}),s.jsx("div",{className:"items-center justify-center px-4 py-3",children:s.jsxs("h2",{className:"text-2xl font-semibold text-titulo truncate",children:[a?.name?`${a.name} · `:"",y]})})]}),[a?.name,y]),B=l.useCallback(({openDateEditor:e,openAddRecord:i,isProcessing:o,isUpdatingDates:n})=>s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(p,{asChild:!0,variant:"outline",size:"icon",className:"border-white text-alerta bg-white rounded-full hover:brightness-95",children:s.jsx(R,{to:`/chart/${c}`,"aria-label":"Ver gráfica del ciclo",children:s.jsx(W,{className:"h-4 w-4"})})}),s.jsx(p,{type:"button",variant:"outline",size:"icon",onClick:e,"aria-pressed":n,className:"border-white text-subtitulo rounded-full hover:brightness-95",disabled:n,"aria-label":"Editar fechas del ciclo",children:s.jsx(ee,{className:"h-4 w-4"})}),s.jsx(p,{type:"button",size:"icon",onClick:i,className:"rounded-full bg-secundario hover:brightness-95 text-white shadow",disabled:o,"aria-label":"Añadir registro al ciclo",children:s.jsx(Y,{className:"h-4 w-4"})})]}),[c]);return m&&!a||!a?s.jsx("div",{className:"flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:s.jsx("p",{children:"Cargando detalles del ciclo..."})}):s.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[s.jsx(Q,{cycle:a,isLoading:m,addOrUpdateDataPoint:O,deleteRecord:P,updateCycleDates:q,checkCycleOverlap:$,forceUpdateCycleStart:I,refreshData:U,includeEndDate:!0,headerActions:B,topAccessory:_,onRequestDeleteCycle:z,isDeletingCycle:k,dateEditorDeleteDescription:y?`Se eliminará el ciclo ${y} y todos sus registros asociados.`:"Se eliminará este ciclo y todos sus registros asociados."}),s.jsx(G,{isOpen:A,onClose:()=>D(!1),onConfirm:M,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:y?`¿Estás seguro de que quieres eliminar el ciclo ${y}? Esta acción no se puede deshacer.`:"¿Estás seguro de que quieres eliminar este ciclo? Esta acción no se puede deshacer.",isProcessing:k})]})};export{pe as default};
