import{c as at,r,k as w,f as p,j as e,K as E,B as ie,W as Da,g as S,q as tt,o as L,u as ws,b as Cs,l as fa,Y as js,T as Mt,m as Be}from"./index-BrkKcvYr.js";import{L as Rt,T as Ns,a as Ss,N as ks,P as Ms,C as Rs}from"./PostpartumExitDialog-U6uUCT8H.js";import{C as Is,A as Es,D as _s}from"./DataEntryForm-BAptPWhC.js";import{l as _e}from"./badge-Bg-zWaI6.js";import{T as As,D as Ts,C as Os}from"./peak-mode-button-CxuwCOgG.js";import{D as Et}from"./DeletionDialog-vRraKZqj.js";import{D as wa,a as Ca,b as Ls,c as Fs,u as Ps,i as Je}from"./useCycleData-NykkPLt1.js";import{a as $s,H as Bs}from"./HeaderIconButton-GbTgtOMs.js";import{m as pa,i as et,f as Hs,P as zs,e as Us}from"./useBackClose-C07k0QgV.js";import{C as Vs,c as Ys,F as ha}from"./computePeakStatuses-DXv7gS4Y.js";import"./label-DG8WrZKe.js";import"./eye-DF71BUjW.js";const Xs=at("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),xa=at("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),qs=at("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]),Ws=at("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),Ks=({isoDate:c,cycleDay:d,details:o,peakStatus:b,isPeakDay:A,onEdit:y,onDelete:P,onAdd:T,onToggleRelations:J,isProcessing:O})=>{const ce=!!o?.record,Ae=r.useMemo(()=>{if(!c)return null;try{return w(p(c),"dd/MM/yyyy",{locale:_e})}catch{return null}},[c]),ee=o?.symbolInfo?.label||"Sin símbolo",z=o?.symbolInfo?.value||"none",U=o?.symbolInfo?.pattern==="spotting-pattern"?"spotting-pattern-icon":"",de=()=>{!o?.record||!y||y(o.record,null)},ue=()=>{!o?.record?.id||!P||P(o.record.id)},me=()=>{!c||!T||T(c)},F=(k,B=null)=>{if(o?.record&&y){y(o.record,k,B);return}c&&T&&T(c,k,B)},v=()=>{!c||!J||J(c)},R=(k,B={})=>k&&typeof k=="string"&&k.trim().length>0||typeof k=="number"?k:B.placeholder||"—",$=o?.hasTemperature?`${o.displayTemp} °C`:"—",Te=o?.timeValue||"—",Oe=!!o?.timeValue,fe=o?.hasMucusSensation?o.mucusSensation:"—",pe=o?.hasMucusAppearance?o.mucusAppearance:"—",he=o?.observationsText?.trim(),i=!!o?.hasRelations;let C=null,h=null;b&&(b==="P"||A?(C="Día pico",h="peak"):(C=`+${b}`,h="post-peak"));const M=()=>{switch(z){case"red":return"bg-rose-500 border-slate-300 shadow-md";case"pink":return"bg-pink-500 border-slate-300 shadow-md";case"green":return"bg-emerald-500 border-slate-300 shadow-md";case"yellow":return"bg-yellow-400 border-slate-300 shadow-md";case"spot":return"bg-rose-500 border-slate-300 shadow-md";case"white":return"bg-white border-slate-300 shadow-md";default:return"bg-slate-200 border-slate-300 shadow-md"}};if(!c)return e.jsx("div",{className:"w-full rounded-3xl border border-rose-100/80 bg-white/70 p-4 text-center text-sm text-slate-500 shadow-sm",children:"Selecciona un día en el calendario para ver o añadir un registro."});const x="flex items-center gap-2 rounded-3xl border px-3 py-2 text-sm min-h-[3rem]";return e.jsxs("div",{className:"w-full rounded-3xl border border-rose-200/80 bg-white/90 p-4 sm:p-5 shadow-md backdrop-blur-md",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"font-semibold text-subtitulo sm:text-lg",children:[Ae,d?` · Día ${d}`:""]}),C&&e.jsx("span",{className:E("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold","border-rose-300 bg-rose-50 text-rose-700"),children:C})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>F("symbol","fertilitySymbol"),className:E("flex h-7 w-7 items-center justify-center rounded-full border shadow-inner transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",M(),U),title:ee,"aria-label":ee}),ce?e.jsxs(e.Fragment,{children:[e.jsxs(ie,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:de,disabled:O,children:[O?e.jsx(Rt,{className:"h-4 w-4 animate-spin"}):e.jsx(Ws,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Editar registro"})]}),e.jsxs(ie,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full text-fertiliapp-fuerte hover:bg-rose-50",onClick:ue,disabled:O,children:[O?e.jsx(Rt,{className:"h-4 w-4 animate-spin"}):e.jsx(Ns,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Eliminar registro"})]})]}):e.jsxs(ie,{type:"button",variant:"outline",size:"sm",className:"rounded-full border-rose-200 px-3 text-xs font-semibold text-rose-500",onClick:me,disabled:O,children:[O&&e.jsx(Rt,{className:"mr-1 h-3.5 w-3.5 animate-spin"}),"Añadir registro"]})]})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>F("temperature","temperature"),className:E(x,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasTemperature?"border-orange-100 bg-orange-50 text-orange-800":"border-orange-50 bg-orange-50 text-slate-400"),children:[e.jsx(As,{className:"h-5 w-5 shrink-0 opacity-80"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold",children:R($)}),o?.showCorrectedIndicator&&e.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500","aria-label":"Temperatura corregida"})]})]}),e.jsxs("button",{type:"button",onClick:()=>F("temperature","time"),className:E(x,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",Oe?"border-slate-200 bg-slate-50 text-slate-800":"border-slate-200 bg-slate-50 text-slate-400"),children:[e.jsx(Is,{className:"h-5 w-5 shrink-0 opacity-80"}),e.jsx("span",{className:"font-semibold",children:R(Te)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>F("sensation","mucusSensation"),className:E(x,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusSensation?"border-sky-100 bg-sky-50 text-sky-800":"border-sky-50 bg-sky-50 text-slate-400"),children:[e.jsx(Ts,{className:"h-5 w-5 shrink-0 opacity-80"}),e.jsx("span",{className:"font-semibold",children:R(fe)})]}),e.jsxs("button",{type:"button",onClick:()=>F("appearance","mucusAppearance"),className:E(x,"text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",o?.hasMucusAppearance?"border-emerald-100 bg-emerald-50 text-emerald-800":"border-emerald-50 bg-emerald-50 text-slate-400"),children:[e.jsx(Os,{className:"h-5 w-5 shrink-0 opacity-80"}),e.jsx("span",{className:"font-semibold",children:R(pe)})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>F("observations","observations"),className:E(x,"flex-1 min-w-0 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",he?"border-violet-100 bg-violet-50 text-violet-800":"border-violet-100 bg-violet-50 text-slate-400"),children:[e.jsx(qs,{className:"h-5 w-5 shrink-0 opacity-80"}),e.jsx("span",{className:"truncate",children:R(he,{placeholder:"-"})})]}),e.jsx("button",{type:"button",onClick:v,disabled:O,className:E("flex h-10 w-10 items-center justify-center rounded-full border transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200",i?"border-rose-50 bg-rose-50":"border-slate-200 bg-white",O&&"opacity-70 cursor-not-allowed"),title:i?"Hubo relaciones":"Sin relaciones","aria-label":i?"Hubo relaciones":"Sin relaciones",children:e.jsx(Da,{className:E("h-4 shrink-0 w-4",i?"text-rose-500 fill-current":"text-slate-300")})})]})]})]})},ja=c=>c.replace(".","").toLowerCase(),He=c=>ja(w(c,"MMM",{locale:_e})),Gs=c=>ja(w(c,"d MMM yyyy",{locale:_e})),Zs=({startDate:c,endDate:d})=>{if(!d){if(!c)return"Mis registros";const T=p(c);return S(T)?`${Gs(T)} - actualidad`:"Mis registros"}if(!c)return"Mis registros";const o=p(c),b=p(d);if(!S(o)||!S(b))return"Mis registros";const A=o.getFullYear()===b.getFullYear();if(A&&o.getMonth()===b.getMonth())return`${o.getDate()}–${b.getDate()} ${He(o)} ${o.getFullYear()}`;if(A)return`${o.getDate()} ${He(o)} – ${b.getDate()} ${He(b)} ${o.getFullYear()}`;const P=`${o.getFullYear()}–${String(b.getFullYear()).slice(-2)}`;return`${o.getDate()} ${He(o)} – ${b.getDate()} ${He(b)} · ${P}`},Qs=({startDate:c,endDate:d,recordCount:o=0,referenceDate:b=new Date})=>{if(!c)return`${o} registros`;const A=p(c);if(!S(A))return`${o} registros`;if(!d)return`Día ${tt(L(b),L(A))+1} · ${o} registros`;const y=p(d);return S(y)?`${tt(L(y),L(A))+1} días · ${o} registros`:`${o} registros`},Js=({issues:c,onReview:d})=>c?.hasIssues?e.jsx("div",{className:"rounded-2xl border border-amber-300 bg-amber-50 px-3 py-2 text-amber-900 shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Xs,{className:"h-4 w-4"}),e.jsxs("span",{children:["Hay problemas de datos en este ciclo: ",c.summary.duplicateDaysCount," días con duplicados,"," ",c.summary.outOfRangeCount," fuera de rango."]})]}),e.jsx(ie,{type:"button",size:"sm",variant:"outline",onClick:d,children:"Revisar"})]})}):null,Ee=c=>{if(!c)return"Fecha inválida";const d=p(c);return S(d)?w(d,"dd-MM-yyyy"):c},ya=({entry:c})=>{const d=c?.preview||c?.entryPreview||{};return e.jsxs("div",{className:"rounded-xl border bg-white p-3 text-xs space-y-1",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Temp gráfica/orig/corr:"})," ",d.temperature_chart??"—"," / ",d.temperature_raw??"—"," / ",d.temperature_corrected??"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Hora:"})," ",d.timestamp&&S(p(d.timestamp))?w(p(d.timestamp),"HH:mm"):"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Moco:"})," ",d.mucus_sensation??"—"," / ",d.mucus_appearance??"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Símbolo:"})," ",d.fertility_symbol??"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Obs:"})," ",d.observations||"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"RS:"})," ",d.had_relations?"Sí":"No"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Ignorado:"})," ",d.ignored?"Sí":"No"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Día Pico:"})," ",d.peak_marker??"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"+ Mediciones:"})," ",d.measurementsCount??"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"ID:"})," ",c?.entryId]})]})},er=({open:c,onOpenChange:d,cycle:o,cycles:b,onResolveDuplicate:A,onMoveOutOfRange:y,onDeleteEntry:P})=>{const[T,J]=r.useState({}),[O,ce]=r.useState({}),[Ae,ee]=r.useState({}),[z,U]=r.useState(null),[de,ue]=r.useState({}),[me,F]=r.useState({}),[v,R]=r.useState(null),$=o?.issues,Te=r.useMemo(()=>{const i={};for(const C of $?.outOfRange||[]){const h=C.isoDateResolved,M=(b||[]).find(x=>x?.id!==o?.id&&x?.startDate&&h&&h>=x.startDate&&(!x.endDate||h<=x.endDate));M?.id&&(i[C.entryId]=M.id)}return i},[o?.id,b,$?.outOfRange]),Oe=r.useMemo(()=>(b||[]).filter(i=>i?.id!==o?.id).slice().sort((i,C)=>{const h=i?.endDate||"9999-12-31",M=C?.endDate||"9999-12-31";return h!==M?M.localeCompare(h):(i?.startDate||"").localeCompare(C?.startDate||"")}),[o?.id,b]),fe=r.useMemo(()=>($?.duplicates||[]).filter(i=>!de[i.isoDate]),[$?.duplicates,de]),pe=r.useMemo(()=>($?.outOfRange||[]).filter(i=>!me[i.entryId]),[$?.outOfRange,me]);r.useEffect(()=>{c&&(ue({}),F({}),J({}),ce({}),ee({}),R(null))},[c,o?.id]);const he=async()=>{if(!v)return;const{actionKey:i,execute:C}=v;U(i);try{await C(),R(null)}finally{U(h=>h===i?null:h)}};return e.jsxs(wa,{open:c,onOpenChange:d,children:[e.jsxs(Ca,{className:"max-w-3xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(Ls,{children:[e.jsx(Fs,{children:"Reparación manual de datos"}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Ciclo: ",e.jsx("b",{children:Ee(o?.startDate)})," -"," ",e.jsx("b",{children:o?.endDate?Ee(o.endDate):"actualidad"})]})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("section",{className:"space-y-3",children:[e.jsx("h3",{className:"font-semibold",children:"Duplicados"}),fe.length===0&&e.jsx("p",{className:"text-sm text-slate-500",children:"Sin duplicados."}),fe.map(i=>{const C=T[i.isoDate]||i.entries?.[0]?.entryId,h=O[i.isoDate]??!1,M=i.entries.map(x=>x.entryId).filter(x=>x!==C);return e.jsxs("div",{className:"rounded-xl border p-3 space-y-3 bg-slate-50",children:[e.jsx("div",{className:"text-sm font-medium",children:Ee(i.isoDate)}),e.jsx("div",{className:"grid gap-2 md:grid-cols-2",children:i.entries.map(x=>e.jsxs("label",{className:"space-y-1 cursor-pointer",children:[e.jsxs("div",{className:"text-xs",children:[e.jsx("input",{type:"radio",name:`winner-${i.isoDate}`,checked:C===x.entryId,onChange:()=>J(k=>({...k,[i.isoDate]:x.entryId}))})," ","Conservar este"]}),e.jsx(ya,{entry:x})]},x.entryId))}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Vs,{checked:h,onCheckedChange:x=>ce(k=>({...k,[i.isoDate]:x!==!1}))}),"Mover mediciones de los descartados al conservado"]}),e.jsx(ie,{type:"button",onClick:()=>{const x=`resolve-${i.isoDate}`;R({actionKey:x,title:"Resolver duplicado",description:"¿Confirmas resolver este duplicado? Esta acción elimina registros duplicados.",confirmLabel:"Resolver duplicado",execute:async()=>{await A({cycleId:o.id,isoDate:i.isoDate,winnerEntryId:C,loserEntryIds:M,moveMeasurements:h}),ue(k=>({...k,[i.isoDate]:!0}))}})},disabled:!M.length||z===`resolve-${i.isoDate}`,children:"Aplicar"})]},i.isoDate)})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsx("h3",{className:"font-semibold",children:"Fuera de rango"}),pe.length===0&&e.jsx("p",{className:"text-sm text-slate-500",children:"Sin registros fuera de rango."}),pe.map(i=>{const C=Ae[i.entryId]||Te[i.entryId]||"";return e.jsxs("div",{className:"rounded-xl border p-3 space-y-2 bg-slate-50",children:[e.jsxs("div",{className:"text-sm",children:["Fecha: ",e.jsx("b",{children:i.isoDateResolved?Ee(i.isoDateResolved):"inválida"})]}),e.jsx(ya,{entry:i}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"border rounded-3xl h-9 px-2 text-sm",value:C,onChange:h=>ee(M=>({...M,[i.entryId]:h.target.value})),children:[e.jsx("option",{value:"",children:"Seleccionar ciclo destino…"}),Oe.map(h=>e.jsxs("option",{value:h.id,children:[Ee(h.startDate)," - ",h.endDate?Ee(h.endDate):"actualidad"]},h.id))]}),e.jsx(ie,{type:"button",variant:"outline",disabled:!C||!i.isoDateResolved||z===`move-${i.entryId}`,onClick:()=>{const h=`move-${i.entryId}`;R({actionKey:h,title:"Mover registro",description:"¿Mover este registro al ciclo seleccionado?",confirmLabel:"Mover",execute:async()=>{await y({fromCycleId:o.id,toCycleId:C,entryId:i.entryId,isoDate:i.isoDateResolved}),F(M=>({...M,[i.entryId]:!0}))}})},children:"Mover"}),e.jsx(ie,{type:"button",variant:"destructive",disabled:z===`delete-${i.entryId}`,onClick:()=>{const h=`delete-${i.entryId}`;R({actionKey:h,title:"Eliminar registro",description:"¿Eliminar este registro y sus mediciones?",confirmLabel:"Eliminar",execute:async()=>{await P({cycleId:o.id,entryId:i.entryId}),F(M=>({...M,[i.entryId]:!0}))}})},children:"Eliminar este registro"})]})]},i.entryId)})]})]})]}),e.jsx(Et,{isOpen:!!v,onClose:()=>R(null),onConfirm:he,title:v?.title,description:v?.description,confirmLabel:v?.confirmLabel,isProcessing:!!v?.actionKey&&z===v?.actionKey})]})},tr=c=>ha.find(d=>d.value===c)||ha[0],ga=10,It=60,ba=750,va=120,ar=85,sr=5,ze=180,rr=c=>{if(c==null||c==="")return null;const d=Number(typeof c=="string"?c.replace(",","."):c);return Number.isFinite(d)?new Intl.NumberFormat("es-ES",{minimumFractionDigits:1,maximumFractionDigits:2}).format(d):null},nr=({cycle:c,headerTitle:d,headerIcon:o=xa,headerActions:b,topAccessory:A,includeEndDate:y=!1,addOrUpdateDataPoint:P,deleteRecord:T,isLoading:J,updateCycleDates:O,checkCycleOverlap:ce,startNewCycle:Ae,refreshData:ee,afterRecordsContent:z=null,onRequestDeleteCycle:U=null,dateEditorDeleteTitle:de="Eliminar ciclo",dateEditorDeleteDescription:ue="Esta acción no se puede deshacer. Se eliminarán todos los registros asociados.",dateEditorDeleteLabel:me="Eliminar ciclo",isDeletingCycle:F=!1}={})=>{const{currentCycle:v,archivedCycles:R,addOrUpdateDataPoint:$,deleteRecord:Te,isLoading:Oe,updateCycleDates:fe,checkCycleOverlap:pe,previewUpdateCycleDates:he,previewStartNewCycle:i,startNewCycle:C,refreshData:h,getMeasurementsForEntry:M,undoCurrentCycle:x,repairDialogState:k,openDataRepairDialog:B,closeDataRepairDialog:Na,resolveDuplicateIssue:_t,moveOutOfRangeEntry:At,deleteIssueEntry:Tt,getPublicError:xe}=Ps(),{preferences:Sa,savePreferences:st}=ws(),n=c??v,Ot=J??Oe,rt=P||(async(t,a)=>{if(n?.id)return $(t,a,n.id)}),ka=T||(async t=>{if(n?.id)return Te(t,n.id)}),Ue=O||(async(t,a,s)=>fe(t??n?.id,a,s)),nt=ce??pe,ot=he,Ma=i,Ra=Ae??C,te=ee??h,lt=M,{toast:V}=Cs(),[Ia,ae]=r.useState(!1),[it,se]=r.useState(null),[ye,ct]=r.useState(null),[Ea,dt]=r.useState(!1),[ut,Lt]=r.useState(!1),[ge,be]=r.useState(!1),[_a,mt]=r.useState(!1),[Aa,Ft]=r.useState(!1),[Y,Ve]=r.useState(()=>n?.startDate||""),[ve,Ye]=r.useState(()=>n?.endDate||""),[Ta,K]=r.useState(""),[Xe,ft]=r.useState(null),[pt,ht]=r.useState(null),[xt,yt]=r.useState(!1),[Oa,gt]=r.useState(null),[La,bt]=r.useState(null),[Fa,qe]=r.useState(!1),[vt,De]=r.useState(!1),[j,re]=r.useState(null),[Pa,ne]=r.useState(null),[$a,Le]=r.useState(null),[Ba,we]=r.useState(null),[Ha,Dt]=r.useState(!1),[za,wt]=r.useState(!1),Pt=n?.data?.length??0,$t=!n?.endDate,Ce=r.useMemo(()=>{if(!v?.id||v?.endDate||!n?.id||n.id!==v.id||!v?.startDate)return null;const t=p(v.startDate);if(!S(t))return null;const a=w(fa(t,-1),"yyyy-MM-dd"),s=R.filter(l=>l?.endDate===a);return s.length?s.sort((l,u)=>(u.startDate||"").localeCompare(l.startDate||""))[0]:null},[R,v,n?.id]),Ct=r.useMemo(()=>{if(!Ce?.startDate||!Ce?.endDate)return"";const t=p(Ce.startDate),a=p(Ce.endDate);if(!S(t)||!S(a))return"";const s=l=>w(l,"dd MMM yy",{locale:_e}).replace(".","");return`${s(t)} - ${s(a)}`},[Ce]),Ua=r.useMemo(()=>`¿Quieres unir el ciclo actual al ciclo anterior${Ct?` (${Ct})`:""}? Esta acción no se puede deshacer.`,[Ct]),Va=r.useCallback(async()=>{wt(!1),typeof st=="function"&&await st({fertilityStartConfig:{postpartum:!1,calculators:{cpm:!0,t8:!0}}})},[st]),je=r.useCallback(async()=>{!c?.id||!te||await te({silent:!0})},[c?.id,te]),Ya=r.useCallback(async t=>{await _t(t),await je()},[je,_t]),Xa=r.useCallback(async t=>{await At(t),await je()},[At,je]),qa=r.useCallback(async t=>{await Tt(t),await je()},[Tt,je]),Wa=r.useMemo(()=>d||Zs({startDate:n?.startDate,endDate:n?.endDate}),[n?.endDate,n?.startDate,d]),Bt=r.useMemo(()=>Qs({startDate:n?.startDate,endDate:n?.endDate,recordCount:Pt}),[n?.endDate,n?.startDate,Pt]),Ht=!0,We=r.useRef(null),zt=r.useRef(null),Ut=r.useRef(0),Fe=r.useRef(null),[Vt,Yt]=r.useState(0),Ke=r.useCallback(()=>{const t=We.current;if(!t){Ut.current=0,Yt(0);return}const s=t.getBoundingClientRect().height;Ut.current=s,Yt(l=>Math.abs(l-s)>.5?s:l)},[]);r.useLayoutEffect(()=>{let t=window.requestAnimationFrame(Ke);const a=()=>{t&&window.cancelAnimationFrame(t),t=window.requestAnimationFrame(Ke)};window.addEventListener("resize",a);let s;return typeof ResizeObserver<"u"&&(s=new ResizeObserver(()=>{t&&window.cancelAnimationFrame(t),t=window.requestAnimationFrame(Ke)}),We.current&&s.observe(We.current)),()=>{window.removeEventListener("resize",a),s&&s.disconnect(),t&&window.cancelAnimationFrame(t)}},[Ke]);const Xt=r.useMemo(()=>Math.max(Math.round(Vt+ga),ga),[Vt]);r.useEffect(()=>{Ve(n?.startDate||""),Ye(n?.endDate||"")},[n?.startDate,n?.endDate]);const Ge=r.useMemo(()=>n?.data?.length?[...n.data].filter(t=>t?.isoDate).sort((t,a)=>{const s=p(t.isoDate);return p(a.isoDate)-s}).map(t=>t.isoDate):[],[n?.data]);r.useEffect(()=>{const t=zt.current;t&&t.scrollTo({top:0,behavior:"auto"})},[]);const Ne=r.useMemo(()=>n?.data?.length?n.data.map(t=>{if(!t?.isoDate)return null;const a=p(t.isoDate);return S(a)?a:null}).filter(Boolean):[],[n?.data]),qt=r.useMemo(()=>new Set(Ge),[Ge]),oe=r.useMemo(()=>Ys(n?.data??[]),[n?.data]),Se=r.useMemo(()=>{const t=new Map;return n?.data?.length&&n.data.forEach(a=>{if(!a?.isoDate)return;const s=a.measurements?.find(Ds=>Ds?.selected)||(a.temperature_chart||a.temperature_raw?{temperature:a.temperature_chart??a.temperature_raw,temperature_corrected:a.temperature_corrected??null,time:a.timestamp?w(p(a.timestamp),"HH:mm"):null,use_corrected:a.use_corrected??!1}:null),l=s?.use_corrected??a.use_corrected??!1,u=s?.temperature_corrected??a.temperature_corrected??null,f=s?.temperature??a.temperature_chart??a.temperature_raw??null,N=rr(l&&u!==null&&u!==void 0&&u!==""?u:f??u),m=N!==null,I=l&&u!==null&&u!==void 0&&u!=="";let g=null;s?.time?g=s.time:a.timestamp&&S(p(a.timestamp))&&(g=w(p(a.timestamp),"HH:mm"));const H=a.mucusSensation??a.mucus_sensation??"",Re=a.mucusAppearance??a.mucus_appearance??"",Ie=!!H,Q=!!Re,kt=Ie||Q,$e=a.observations||"",Qe=!!$e,gs=!!(a.had_relations??a.hadRelations??!1),ma=oe[a.isoDate]||null,bs=a.peak_marker==="peak"||ma==="P",vs=tr(a.fertility_symbol);t.set(a.isoDate,{record:a,symbolInfo:vs,hasTemperature:m,displayTemp:N,showCorrectedIndicator:I,timeValue:g,hasMucus:kt,hasMucusSensation:Ie,hasMucusAppearance:Q,mucusSensation:H,mucusAppearance:Re,hasObservations:Qe,observationsText:$e,hasRelations:gs,peakStatus:ma,isPeakDay:bs})}),t},[n?.data,oe]),D=r.useMemo(()=>{if(!n?.startDate)return null;const t=p(n.startDate);if(!S(t))return null;let a;if(n?.endDate)a=p(n.endDate);else{const s=L(new Date),l=[t,s];Ne.length&&l.push(pa(Ne)),a=pa(l)}return S(a)?{from:t,to:a}:{from:t,to:t}},[n?.startDate,n?.endDate,Ne]),Ka=r.useMemo(()=>{const t={};return D&&(t.outsideCycle=a=>et(a,D.from)||Je(a,D.to),t.insideCycleNoRecord=a=>{if(et(a,D.from)||Je(a,D.to))return!1;const s=w(a,"yyyy-MM-dd");return!qt.has(s)}),Ne.length&&(t.hasRecord=Ne),t},[D,Ne,qt]),Ga=r.useMemo(()=>({months:"flex flex-col items-center sm:flex-row sm:items-center sm:justify-center space-y-3 sm:space-x-4 sm:space-y-0",month:"space-y-3",table:"records-calendar-day-grid w-full border-collapse space-y-0.5",row:"flex w-full mt-1.5",head_cell:"text-muted-foreground rounded-md w-11 font-medium text-[0.8rem]",cell:"relative h-11 w-11 text-center text-sm p-0 focus-within:relative focus-within:z-20",day:E(js({variant:"ghost",size:"icon"}),"relative flex !h-11 !w-11 rounded-3xl flex-col items-center justify-center !p-0 font-medium text-slate-700 aria-selected:opacity-100"),day_selected:"",day_today:""}),[]),[Wt,jt]=r.useState(()=>j&&S(p(j))?p(j):D?.to?D.to:L(new Date)),Pe=r.useRef(!1),X=r.useRef(null),Za=r.useRef({active:!1,startX:0,pointerId:null,startTime:0,dragging:!1,gridWidth:0,swipeThreshold:0}),le=r.useRef(null),Kt=r.useRef(null),Gt=r.useRef(null),Zt=r.useRef(0),[Qa,Ja]=r.useState(0),[Qt,Jt]=r.useState(!1),G=r.useCallback(t=>{Zt.current=t,Ja(t)},[]),ea=r.useCallback(()=>new Promise(t=>{requestAnimationFrame(()=>{requestAnimationFrame(t)})}),[]),ke=r.useCallback((t,{duration:a=ze}={})=>{X.current&&(cancelAnimationFrame(X.current),X.current=null);const s=Zt.current,l=t-s;return Math.abs(l)<.5||a<=0?(G(t),Promise.resolve()):new Promise(u=>{const f=m=>1-Math.pow(1-m,3),_=performance.now(),N=m=>{const I=m-_,g=Math.min(1,I/a),H=s+l*f(g);if(G(H),g<1){X.current=requestAnimationFrame(N);return}X.current=null,u()};X.current=requestAnimationFrame(N)})},[G]),es=r.useMemo(()=>({labelDay:t=>{const a=w(t,"yyyy-MM-dd"),s=Se.get(a),l=w(t,"d MMM",{locale:_e}),u=s?.peakStatus??oe[a]??null,f=[];if(s?.hasTemperature&&s?.hasMucus?f.push("temperatura y moco"):s?.hasTemperature?f.push("temperatura"):s?.hasMucus&&f.push("moco"),s?.hasRelations&&f.push("RS"),u){const _=u==="P"?"pico ✖":`pico +${u}`;f.push(_)}return f.length?`${l}: ${f.join("; ")}`:l}}),[oe,Se]),ts=r.useCallback(({date:t,activeModifiers:a})=>{const s=w(t,"yyyy-MM-dd"),l=Se.get(s),u=l?.hasTemperature??!1,f=l?.hasMucus??!1,_=l?.hasRelations??!1,N=l?.peakStatus??oe[s]??null,m=l?.symbolInfo,I=m?.value,g=a.selected,H=a.today,Re=E("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",u?"bg-amber-500":"bg-transparent",u&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),Ie=E("h-[0.5rem] w-[0.5rem] rounded-full transition-shadow",f?"bg-teal-500":"bg-transparent",f&&g?"shadow-[0_0_0_0.75px_rgba(255,255,255,0.95)]":""),Q=!!(I&&I!=="none"),kt=E("relative z-10 text-[1.15rem] leading-none",a.outside||a.outsideCycle?"text-slate-300":g?Q?"text-white":"text-fertiliapp-fuerte":H?"text-subtitulo font-semibold":"text-slate-700"),$e=N==="P"?"✖":N?`+${N}`:null,Qe=Q?E("pointer-events-none absolute inset-0 rounded-full transition-opacity",m?.color??"",m?.pattern==="spotting-pattern"?"calendar-spotting-dot":"",I==="white"?"ring-1 ring-slate-300/70":"",g?"opacity-50":"opacity-25"):null;return e.jsxs("div",{className:"relative flex h-full w-full flex-col items-center justify-center",children:[e.jsxs("span",{className:"relative inline-flex h-8 w-8 items-center justify-center leading-none -mt-[1px]",children:[H&&!g&&!(a.outside||a.outsideCycle)&&e.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[4px] rounded-full border border-fertiliapp-fuerte"}),g&&e.jsx("span",{"aria-hidden":"true",className:"pointer-events-none absolute -inset-[2px] rounded-full bg-tarjeta border-2 border-fertiliapp-fuerte"}),Qe&&e.jsx("span",{className:Qe,"aria-hidden":"true"}),e.jsx("span",{className:kt,children:w(t,"d")}),_&&e.jsx(Da,{"aria-hidden":"true",className:"pointer-events-none absolute -bottom-[0.2px] -right-[0.2px] h-2 w-2 text-rose-500 fill-current"})]}),e.jsxs("div",{className:"mt-[0.2rem] flex h-[0.3rem] items-center justify-center gap-[0.18rem]","aria-hidden":"true",children:[e.jsx("span",{className:Re}),e.jsx("span",{className:Ie})]}),$e&&e.jsx("span",{"aria-hidden":"true",className:E("pointer-events-none absolute -top-[1px] right-[0.5px] rounded-sm px-[2px] text-[0.75rem] font-semibold leading-none text-fertiliapp-fuerte shadow-[0_0_0_1px_rgba(255,255,255,0.9)]",g?"bg-rose-100/90 text-fertiliapp-fuerte":"bg-white/90"),children:$e})]})},[oe,Se]),Z=r.useMemo(()=>{if(!n?.startDate)return[];const t=p(n.startDate);if(!S(t))return[];const a=L(t),s=L(new Date);let l=D?.to?L(D.to):s;Je(l,s)&&(l=s),et(l,a)&&(l=a);const u=tt(l,a)+1;if(u<=0)return[];const f=[];for(let _=u-1;_>=0;_-=1){const N=fa(a,_),m=w(N,"yyyy-MM-dd"),I=tt(N,a)+1,g=Se.get(m)||null;f.push({isoDate:m,date:N,cycleDay:I,details:g})}return f},[n?.startDate,D,Se]),Me=r.useMemo(()=>new Set(Z.map(t=>t.isoDate)),[Z]),as=r.useMemo(()=>{const t=new Map;return Z.forEach(a=>{t.set(a.isoDate,a)}),t},[Z]),ta=j&&as.get(j)||null,Nt=ta?.details??null,aa=Nt?.peakStatus??(j?oe[j]??null:null),ss=Nt?.isPeakDay??aa==="P",Ze=r.useMemo(()=>{if(!D)return null;const t=D?.to?w(L(D.to),"yyyy-MM-dd"):null,a=D?.from?w(L(D.from),"yyyy-MM-dd"):null;if(!n?.endDate){const s=w(L(new Date),"yyyy-MM-dd");if(Me.has(s))return s}return t&&Me.has(t)?t:a&&Me.has(a)?a:Ge[0]??null},[n?.endDate,D,Me,Ge]);r.useEffect(()=>{if(!(j&&Me.has(j))){if(!Ze){j!==null&&re(null);return}j!==Ze&&re(Ze)}},[j,Me,Ze]);const sa=r.useCallback(t=>{if(!t)return;const a=w(t,"yyyy-MM-dd");D&&(et(t,D.from)||Je(t,D.to))||re(a)},[D]);r.useEffect(()=>{if(!j)return;const t=p(j);S(t)&&jt(a=>a&&a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()?a:t)},[j]);const ra=r.useCallback(t=>{jt(a=>{const s=a??D?.to??L(new Date);return Hs(s,t==="next"?1:-1)})},[D]);r.useEffect(()=>{const t=Kt.current;if(!t)return;const a=t.querySelector(".records-calendar-day-grid");a&&(Gt.current=a)},[Wt,Ht,G]);const St=r.useCallback(async t=>{if(Pe.current)return;Pe.current=!0;const s=Gt.current?.getBoundingClientRect()?.width??0,l=t==="next"?-va:va,u=s?t==="next"?-s:s:l,f=-u;try{await ke(u,{duration:ze}),ra(t),G(f),await ea(),await ke(0,{duration:ze})}finally{Pe.current=!1}},[ke,ra,G,ea]),q=r.useCallback(()=>{ft(null),ht(null),yt(!1),gt(null),bt(null),qe(!1)},[]);r.useEffect(()=>()=>{X.current&&(cancelAnimationFrame(X.current),X.current=null),le.current&&(le.current(),le.current=null)},[]);const na=r.useCallback(()=>{Ve(n?.startDate||""),Ye(n?.endDate||""),K(""),q(),Ft(!0)},[n?.startDate,n?.endDate,q]),W=r.useCallback(()=>{Ft(!1),K(""),q(),Ve(n?.startDate||""),Ye(n?.endDate||"")},[n?.startDate,n?.endDate,q]),rs=r.useCallback(async()=>{if(v?.id){Lt(!0);try{await x(v.id),dt(!1),W()}catch(t){console.error("Failed to undo cycle",t)}finally{Lt(!1)}}},[W,v?.id,x]),ns=r.useCallback(()=>{U&&(W(),U())},[W,U]),os=r.useCallback(t=>{if(Pe.current||t.pointerType==="mouse"&&t.button!==0)return;const a=t.target.closest(".records-calendar-day-grid");if(!a)return;const s=Za.current;s.active=!0,s.pointerId=t.pointerId,s.startX=t.clientX,s.startTime=performance.now(),s.dragging=!1;const l=a.getBoundingClientRect().width||0;s.gridWidth=l,s.swipeThreshold=l?Math.max(It,l*.25):It;const u=N=>{if(!s.active||N.pointerId!==s.pointerId)return;const m=N.clientX-s.startX;if(!s.dragging&&Math.abs(m)>sr&&(s.dragging=!0,Jt(!0)),!s.dragging)return;const I=s.gridWidth?s.gridWidth*.7:ar,g=Math.max(-I,Math.min(I,m));N.preventDefault(),G(g)},f=async N=>{if(!s.active||N.pointerId!==s.pointerId)return;le.current?.(),le.current=null,s.active=!1;const m=N.clientX-s.startX,I=performance.now()-s.startTime,g=I>0?m/I*1e3:0,H=s.swipeThreshold||It,Re=m<=-H||g<=-ba,Ie=m>=H||g>=ba,Q=s.dragging;if(s.dragging=!1,Jt(!1),Pe.current){await ke(0,{duration:ze});return}if(Q&&Re){await St("next");return}if(Q&&Ie){await St("prev");return}await ke(0,{duration:ze})},_=()=>{window.removeEventListener("pointermove",u,{capture:!0}),window.removeEventListener("pointerup",f,{capture:!0}),window.removeEventListener("pointercancel",f,{capture:!0})};le.current?.(),le.current=_,window.addEventListener("pointermove",u,{capture:!0,passive:!1}),window.addEventListener("pointerup",f,{capture:!0}),window.addEventListener("pointercancel",f,{capture:!0})},[St,ke,Ht,G]),ls=r.useCallback(()=>{q()},[q]),is=r.useCallback(async()=>{if(!Y){K("La fecha de inicio es obligatoria");return}if(y&&ve&&ve<Y){K("La fecha de fin no puede ser anterior al inicio");return}if(n?.id){K(""),De(!0);try{const t=y&&ve||void 0,a=ot?await ot(n.id,Y,t):null;if(a){ft(Y),ht(t??null),yt(!!y),gt(null),bt(a),qe(!0),De(!1);return}const s=nt?await nt(n.id,Y,t):null;if(s){ft(Y),ht(t??null),yt(!!y),gt(s),bt(null),qe(!0),De(!1);return}await Ue(n.id,Y,y&&ve||void 0),await te({silent:!0}),W()}catch(t){const a=xe?xe(t):null;console.error("Error updating start date from records page:",t),K(a?.message||"No se pudieron actualizar las fechas"),V({title:a?.title||"Error",description:a?.message||"No se pudieron actualizar las fechas.",variant:"destructive",action:a?.action?.label==="Revisar"?e.jsx(Mt,{altText:"Revisar",onClick:()=>B?.(n?.id),children:"Revisar"}):void 0})}finally{De(!1)}}},[Y,ve,y,n?.id,nt,ot,Ue,te,V,W]),cs=r.useCallback(async()=>{if(!n?.id||!Xe){q();return}De(!0),qe(!1);try{const t=n.startDate,a=n.endDate??void 0,s=Xe!==t,l=xt?pt??void 0:void 0,u=xt&&pt!==null&&l!==a;await Ue(n.id,s?Xe:void 0,l),await te({silent:!0}),W()}catch(t){const a=xe?xe(t):null;console.error("Error adjusting cycle dates from records page:",t),K(a?.message||"No se pudieron actualizar las fechas"),V({title:a?.title||"Error",description:a?.message||"No se pudieron actualizar las fechas.",variant:"destructive",action:a?.action?.label==="Revisar"?e.jsx(Mt,{altText:"Revisar",onClick:()=>B?.(n?.id),children:"Revisar"}):void 0})}finally{De(!1),q()}},[n?.id,n?.startDate,n?.endDate,Xe,xt,pt,Ue,te,V,W,q]),oa=r.useCallback(()=>{ae(!1),se(null),ne(null),Le(null),we(null),mt(!1),Fe.current=null},[]),la=r.useCallback(async(t,a=null,s=null)=>{if(!t)return;Fe.current=t.id??null,se(t),ne(t.isoDate??null),Le(a),we(s??null),t.isoDate&&re(t.isoDate),ae(!0);const l=t?.measurementsLoaded||Array.isArray(t?.measurements)&&t.measurements.length>0;if(lt&&t?.id&&n?.id&&!l){mt(!0);try{const u=await lt(n.id,t.id);Fe.current===t.id&&se(f=>f?.id===t.id?{...f,measurements:u,measurementsLoaded:!0}:f)}finally{mt(!1)}}},[n?.id,lt]),ds=r.useCallback((t,a=null,s=null)=>la(t,s,a),[la]),us=t=>{const a=n?.data?.find(s=>s.id===t);ct(a||null)},ms=r.useCallback(t=>{se(t)},[]),fs=r.useCallback((t,a=null,s=null)=>{t&&(Fe.current=null,re(t),se(null),ne(t),Le(s),we(a),ae(!0))},[]),ia=r.useCallback(()=>{const t=Z.length?Z[0].isoDate:n?.startDate||null,a=j||t||null;Fe.current=null,se(null),ne(a),Le(null),we(null),a&&re(a),ae(!0)},[Z,n?.startDate,j]),ca=r.useCallback((t,a={})=>{const s=n?.data?.find(m=>m.isoDate===t)||null,l=s?.timestamp&&S(p(s.timestamp))?w(p(s.timestamp),"HH:mm"):w(new Date,"HH:mm"),u=s?.temperature_raw??s?.temperature??"",f=s?.temperature_corrected??"",_=!!s?.use_corrected,N=s?.measurements?.length?s.measurements.map((m,I)=>{const g=m?.time||(m?.timestamp&&S(p(m.timestamp))?w(p(m.timestamp),"HH:mm"):l);return{temperature:m?.temperature??m?.temperature_raw??u,temperature_corrected:m?.temperature_corrected??f,time:g,time_corrected:m?.time_corrected||g,use_corrected:m?.use_corrected!==void 0?!!m?.use_corrected:_,selected:!!(m?.selected??I===0)}}):[{temperature:u,temperature_corrected:f,time:l,time_corrected:l,use_corrected:_,selected:!0}];return{isoDate:t,measurements:N,mucusSensation:s?.mucusSensation??s?.mucus_sensation??"",mucusAppearance:s?.mucusAppearance??s?.mucus_appearance??"",fertility_symbol:s?.fertility_symbol??s?.fertilitySymbol??"none",observations:s?.observations??"",peak_marker:s?.peak_marker??null,ignored:s?.ignored??!1,...a}},[n?.data]),ps=async(t,{keepFormOpen:a=!1}={})=>{be(!0);try{await rt(t,it),V({title:"Guardado",duration:2e3}),a||(ae(!1),se(null),ne(null),Le(null),we(null))}catch(s){const l=xe?xe(s):null,u=["duplicate-iso-date","entry-out-of-range"].includes(l?.code);V({title:l?.title||"Error",description:l?.message||"No se pudo guardar el registro",variant:"destructive",action:u?e.jsx(Mt,{altText:"Revisar",onClick:()=>B?.(n?.id),children:"Revisar"}):void 0})}finally{be(!1),a&&ne(t?.isoDate??null)}},hs=r.useCallback(async t=>{if(!t)return;const a=n?.data?.find(u=>u.isoDate===t)||null,s=!!(a?.had_relations??a?.hadRelations??!1),l=ca(t,{had_relations:!s,hadRelations:!s});be(!0);try{await rt(l,a)}catch{V({title:"Error",description:"No se pudo actualizar RS",variant:"destructive"})}finally{be(!1)}},[rt,ca,n?.data,V]),xs=async()=>{if(ye){be(!0);try{const t=ye.isoDate;await ka(ye.id),ct(null),ne(null),t&&j===t&&re(t)}catch{V({title:"Error",description:"No se pudo eliminar el registro",variant:"destructive"})}finally{be(!1)}}},da={openDateEditor:na,openAddRecord:ia,isProcessing:ge,isUpdatingDates:vt,cycle:n},ys=typeof b=="function"?b(da):e.jsxs(e.Fragment,{children:[e.jsxs($s,{type:"button",onClick:na,className:"text-subtitulo",disabled:ge||vt,"aria-label":y?"Editar fechas del ciclo":"Editar fecha de inicio",children:[e.jsx(Ss,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:y?"Editar fechas del ciclo":"Editar fecha de inicio"})]}),e.jsxs(Bs,{type:"button",onClick:ia,disabled:ge,"aria-label":"Añadir registro",children:[e.jsx(zs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Añadir registro"})]})]}),ua=typeof A=="function"?A({...da}):A??null;return Ot&&!n?.id?e.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:e.jsx("p",{className:"text-center text-titulo text-lg",children:"Cargando..."})}):n?.id?e.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden",children:[e.jsxs("div",{className:"mx-auto grid w-full max-w-6xl grid-cols-1 gap-6 px-4 relative z-10",children:[e.jsx("div",{ref:We,className:"sticky top-1 z-50 w-full max-w-lg mx-auto",children:e.jsx("div",{className:"relative overflow-hidden rounded-2xl",children:e.jsxs("div",{className:"space-y-1.5 p-2 sm:p-2.5 relative z-10",children:[e.jsx(Be.div,{className:"flex flex-col gap-2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/50 p-3 shadow-sm backdrop-blur-md",children:e.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 text-[10px] uppercase tracking-[0.18em] text-base",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[ua&&e.jsx("div",{className:"flex items-center",children:ua}),e.jsx("span",{children:$t?"CICLO ACTUAL":"CICLO ARCHIVADO"})]}),e.jsx("div",{className:"flex shrink-0 items-center gap-2",children:ys})]}),e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[e.jsx(o,{className:"h-5 w-5 text-subtitulo"}),e.jsx("span",{className:E("font-semibold text-titulo leading-tight","text-[21px] sm:text-[22px]"),children:Wa})]}),Bt&&e.jsx("div",{className:"text-[13px] text-base whitespace-nowrap",children:Bt})]})})}),e.jsx(Js,{issues:n?.issues,onReview:()=>B?.(n?.id)}),Aa&&e.jsx(Be.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.4},children:e.jsx(Rs,{cycle:n,startDate:Y,endDate:y?ve:n?.endDate,otherCycles:[...R??[],v].filter(Boolean),onStartDateChange:t=>Ve(t),onEndDateChange:y?t=>Ye(t):void 0,onSave:is,onCancel:W,isProcessing:vt||Ot||ut,dateError:Ta,includeEndDate:y,showOverlapDialog:Fa,overlapCycle:Oa,overlapImpactPreview:La,onConfirmOverlap:cs,onCancelOverlap:ls,onClearError:()=>K(""),saveLabel:y?"Guardar fechas":"Guardar cambios",title:y?"Editar fechas del ciclo":"Editar fecha de inicio",description:y?"Actualiza las fechas del ciclo. Los registros se reorganizarán automáticamente.":"Actualiza la fecha de inicio del ciclo actual. Los registros se reorganizarán automáticamente.",onUndoCycle:Ce?()=>dt(!0):void 0,isUndoingCycle:ut,onDeleteCycle:U?ns:void 0,deleteTitle:de,deleteDescription:ue,deleteLabel:me,isDeletingCycle:F})}),e.jsx(Es,{initial:!1,children:e.jsx(Be.div,{id:"records-calendar",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"flex justify-center",children:e.jsx("div",{ref:Kt,onPointerDown:os,"data-calendar-dragging":Qt?"true":"false",className:E("w-full max-w-sm rounded-3xl bg-white/80 mx-auto backdrop-blur-sm overflow-hidden [&_.records-calendar-day-grid]:will-change-transform [&_.records-calendar-day-grid]:[transform:translate3d(var(--calendar-drag-x,0px),0,0)]",Qt?"cursor-grabbing select-none":"cursor-grab"),style:{touchAction:"pan-y","--calendar-drag-x":`${Qa}px`},children:e.jsx(Us,{mode:"single",locale:_e,month:Wt??void 0,onMonthChange:jt,selected:j&&S(p(j))?p(j):void 0,onSelect:sa,onDayClick:sa,modifiers:Ka,labels:es,components:{DayContent:ts},className:"w-full !p-2.5 [&_button]:text-slate-900 [&_button:hover]:bg-tarjeta [&_button[aria-selected=true]]:bg-transparent",classNames:Ga,modifiersClassNames:{hasRecord:"font-semibold text-slate-900",outsideCycle:"text-slate-300 opacity-50 hover:text-slate-300 hover:bg-transparent",insideCycleNoRecord:"text-slate-900 hover:text-slate-900 hover:bg-rose-50"}})})},"records-calendar")})]})})}),e.jsxs("div",{ref:zt,className:"sticky overflow-y-auto overscroll-contain w-full max-w-4xl mx-auto",style:{top:Xt,maxHeight:`calc(h-app - ${Xt}px )`,WebkitOverflowScrolling:"touch"},children:[e.jsx(Be.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},className:"relative space-y-2 px-1.5 pt-2 sm:px-2 lg:px-4",children:Z.length===0?e.jsx(Be.div,{className:"py-12 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsxs("div",{className:"mx-auto max-w-md rounded-3xl border border-rose-100 bg-white/80 p-8 shadow-lg backdrop-blur-sm",children:[e.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-fertiliapp-fuerte shadow-inner",children:e.jsx(xa,{className:"h-9 w-9"})}),e.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Aún no hay días para mostrar"}),e.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Actualiza la fecha de inicio del ciclo o añade tu primer registro para comenzar a ver el historial."})]})}):e.jsx(Ks,{isoDate:j,cycleDay:ta?.cycleDay??null,details:Nt,peakStatus:aa,isPeakDay:ss,onEdit:ds,onDelete:us,onAdd:fs,onToggleRelations:hs,isProcessing:ge})}),z&&e.jsx("div",{className:"pt-4 space-y-4",children:z})]})]}),e.jsx(wa,{open:Ia,onOpenChange:t=>{t?ae(!0):oa()},children:e.jsx(Ca,{hideClose:!0,className:"bg-white border-pink-100 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto p-4 sm:p-6 rounded-2xl",children:e.jsx(_s,{onSubmit:ps,onCancel:oa,initialData:it,cycleStartDate:n?.startDate,cycleEndDate:n?.endDate,isProcessing:ge||_a,isEditing:!!it,cycleData:n?.data,onDateSelect:ms,defaultIsoDate:Pa,focusedField:$a,initialSectionKey:Ba})})}),e.jsx(Et,{isOpen:Ea,onClose:()=>dt(!1),onConfirm:rs,title:"Deshacer ciclo",confirmLabel:"Deshacer ciclo",cancelLabel:"Cancelar",description:Ua,isProcessing:ut}),e.jsx(er,{open:k?.open&&k?.cycleId===n?.id,onOpenChange:t=>{t?B?.(n?.id):Na?.()},cycle:n,cycles:[...R||[],v].filter(Boolean),onResolveDuplicate:Ya,onMoveOutOfRange:Xa,onDeleteEntry:qa}),e.jsx(Et,{isOpen:!!ye,onClose:()=>ct(null),onConfirm:xs,title:"Eliminar registro",confirmLabel:"Eliminar registro",description:ye?`¿Estás seguro de que quieres eliminar el registro del ${w(p(ye.isoDate),"dd/MM/yyyy")}? Esta acción no se puede deshacer.`:"",isProcessing:ge})]}):e.jsxs("div",{className:"mx-auto flex min-h-screen max-w-md items-center justify-center px-4 py-4",children:[e.jsxs("div",{className:"w-full space-y-4 rounded-3xl border border-rose-100/70 bg-white/80 p-4 text-center shadow-sm",children:[e.jsx("p",{className:"text-[15px] font-semibold text-slate-800",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>Dt(!0),className:"h-11 w-full rounded-full bg-fertiliapp-fuerte px-4 text-sm font-semibold text-white shadow-sm transition hover:brightness-95",children:"Iniciar ciclo"})]}),e.jsx(ks,{isOpen:Ha,onClose:()=>Dt(!1),onPreview:t=>Ma?.(t,n?.id),onConfirm:async t=>{await Ra(t),Dt(!1),we(null),ae(!0),Sa?.fertilityStartConfig?.postpartum===!0&&wt(!0)},currentCycleRecords:n?.data??[]}),e.jsx(Ms,{isOpen:za,onClose:()=>wt(!1),onConfirm:Va})]})},gr=()=>e.jsx(nr,{});export{nr as RecordsExperience,gr as default};
