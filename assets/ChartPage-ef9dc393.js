import{c as Gt,m as je,j as e,r as b,h as Ze,p as it,i as Ut,f as gt,g as Lt,l as zt,G as Vt,u as Yt,M as wt,B as lt,L as St,X as qt}from"./index-8c1bb4d0.js";import{g as Kt,i as Xt,b as Jt,D as Zt}from"./computePeakStatuses-347fa954.js";import{u as Qt,C as es,O as ts}from"./useFertilityChart-9a56e2e7.js";import{u as ss,D as rs,a as as}from"./useCycleData-a1f868e4.js";import{C as jt,S as ns,a as os,b as ls,c as is,d as cs}from"./checkbox-a510d285.js";import{L as ds}from"./label-60015da2.js";import{A as us}from"./arrow-left-078474d7.js";import{E as hs,a as fs}from"./eye-5bd09b1b.js";import"./input-6cdf51b4.js";import"./badge-6bd7af9d.js";const ps=Gt("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),xs=Gt("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),ms=({padding:r,chartWidth:i,chartHeight:l,tempMin:u,tempMax:C,tempRange:h,getY:j,getX:M,allDataPoints:y=[],responsiveFontSize:x,isFullScreen:G,showLeftLabels:H=!1,reduceMotion:U=!1,graphBottomY:E,chartAreaHeight:w,rowsZoneHeight:B})=>{const c={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.3,ease:"easeOut"}}},F=[];if(h>0){const I=h<=2.5?.1:.5;for(let v=u;v<=C+1e-9;v+=I)F.push(parseFloat(v.toFixed(1)))}else for(let I=35.8;I<=37.2+1e-9;I+=.1)F.push(parseFloat(I.toFixed(1)));const K=U?"g":je.g;return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"bgGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#fffbfc"}),e.jsx("stop",{offset:"50%",stopColor:"#fff5f7"}),e.jsx("stop",{offset:"100%",stopColor:"#fff1f3"})]}),e.jsxs("linearGradient",{id:"dataZoneGradient",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255, 255, 255, 0.6)"}),e.jsx("stop",{offset:"20%",stopColor:"rgba(255, 250, 252, 0.75)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(254, 242, 244, 0.85)"})]}),e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsxs("filter",{id:"softShadow",children:[e.jsx("feGaussianBlur",{in:"SourceAlpha",stdDeviation:"2"}),e.jsx("feOffset",{dx:"0",dy:"1",result:"offsetblur"}),e.jsx("feComponentTransfer",{children:e.jsx("feFuncA",{type:"linear",slope:"0.2"})}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"pointGlow",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsx("filter",{id:"textShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.8)"})}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]})]}),e.jsx("rect",{x:r.left,y:r.top,width:i-r.left-r.right,height:w,fill:"url(#bgGradientChart)",opacity:2,rx:12,style:{filter:"drop-shadow(0 4px 12px rgba(244, 114, 182, 0.1))"}}),e.jsx("rect",{x:r.left,y:r.top,width:i-r.left-r.right,height:w,fill:"white",stroke:"url(#tempLineGradientChart)",strokeWidth:"1",strokeOpacity:"0.2",rx:"12",style:{filter:"url(#softShadow)"}}),e.jsx("rect",{x:r.left,y:E,width:i-r.left-r.right,height:B,fill:"url(#dataZoneGradient)",rx:"8",style:{filter:"drop-shadow(0 -1px 2px rgba(244, 114, 182, 0.05))"}}),F.map((I,v)=>{const Q=j(I),A=I.toFixed(1).endsWith(".0")||I.toFixed(1).endsWith(".5"),de=A?I.toFixed(1):`.${I.toFixed(1).split(".")[1]}`;return e.jsxs(K,{...U?{}:{variants:c},children:[e.jsx("line",{x1:r.left,y1:Q,x2:i-r.right,y2:Q,stroke:A?"#f9a8d4":"#fce7f3",strokeWidth:A?1.5:1,opacity:A?.5:.3,strokeDasharray:A?"0":"4,4",style:{filter:A?"drop-shadow(0 1px 3px rgba(244, 114, 182, 0.15))":"none",opacity:A?1:.7}}),H&&e.jsx("text",{x:r.left-x(1),y:Q+x(.35),textAnchor:"end",fontSize:x(A?1.1:1),fontWeight:A?"700":"600",fill:A?"#be185d":"#db2777",opacity:A?.9:.7,style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:de}),e.jsx("text",{x:i-r.right+x(1),y:Q+x(.35),textAnchor:"start",fontSize:x(A?1.1:1),fontWeight:A?"700":"600",fill:A?"#be185d":"#db2777",opacity:A?.9:.7,style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:de})]},`temp-tick-${v}`)}),y.map((I,v)=>{const Q=M(v);return e.jsx("line",{x1:Q,y1:r.top,x2:Q,y2:E,stroke:"#fce7f3",strokeWidth:"1",opacity:"0.6",style:{filter:"drop-shadow(0 0 1px rgba(244, 114, 182, 0.05))"}},`day-grid-${v}`)}),e.jsx("rect",{x:r.left,y:r.top,width:i-r.left-r.right,height:w,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"2",strokeOpacity:"0.4",rx:"12"}),e.jsx("rect",{x:r.left+1,y:r.top+1,width:i-r.left-r.right-2,height:w-2,fill:"none",stroke:"white",strokeWidth:"0.5",rx:"11",opacity:"0.9"}),H&&e.jsx(K,{...U?{}:{variants:c},children:e.jsx("text",{x:r.left+x(1.2),y:r.top+x(1.5),textAnchor:"middle",fontSize:x(1.4),fontWeight:"800",fill:"#be185d",style:{filter:"url(#textShadow)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:"°C"})})]})},gs=({data:r,allDataPoints:i,getX:l,getY:u,baselineY:C,temperatureField:h="temperature",reduceMotion:j=!1})=>{if(!r||r.length<2)return null;let M="",y=null;const x=[];if(i.forEach((U,E)=>{const w=r.find(B=>B.id===U.id);if(w&&w[h]!==null&&w[h]!==void 0&&!w.ignored){const B=l(E),c=u(w[h]);x.push({x:B,y:c}),y!==null&&E===y+1?M+=` L ${B} ${c}`:M+=`${M?" ":""}M ${B} ${c}`,y=E}}),x.length<2)return null;const G=M.includes("L"),H=x.length>1?x.map(({x:U,y:E},w)=>`${w===0?"M":"L"} ${U} ${E}`).join(" "):"";return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#f472b6"}),e.jsx("stop",{offset:"30%",stopColor:"#ec4899"}),e.jsx("stop",{offset:"70%",stopColor:"#db2777"}),e.jsx("stop",{offset:"100%",stopColor:"#be185d"})]}),e.jsx("filter",{id:"lineShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"3",floodColor:"rgba(244, 114, 182, 0.4)"})})]}),G&&(j?e.jsx("path",{d:M,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"}}):e.jsx(je.path,{d:M,fill:"none",stroke:"url(#tempLineGradientChartGlow)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:.4,style:{filter:"url(#lineGlow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.4},transition:{duration:.8,ease:"easeInOut",delay:.2}})),H&&(j?e.jsx("path",{d:H,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65}):e.jsx(je.path,{d:H,fill:"none",stroke:"#d587b1",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",opacity:.65,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.65},transition:{duration:.8,ease:"easeInOut"}})),G&&(j?e.jsx("path",{d:M,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"}}):e.jsx(je.path,{d:M,fill:"none",stroke:"url(#tempLineGradientChart)",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"url(#lineShadow)"},initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1,ease:"easeInOut",delay:.4}}))]})},Ot="#1565C0",Tt="#2E7D32",Bt="#6A1B9A",ys="rgba(148, 163, 184, 0.35)",bs="rgba(226, 232, 240, 0.6)",ws="rgba(148, 163, 184, 0.5)",Dt="✖",Mt="#7f1d1d",Nt="#ec4899",Pt="drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))",js="#be185d",Cs="#2563eb",ks="#be185d",Is=r=>{if(!r)return"";const[i,l]=r.split("/");return`${parseInt(i,10)}/${parseInt(l,10)}`},vt=(r="",i,l,u="–")=>{if(!r)return[u,""];if(r.length<=i)return[r,""];if(l){const y=r.slice(0,i),x=r.slice(i,i*2);return[y,x]}const C=y=>{if(!y)return["",""];if(y.length<=i)return[y,""];const x=y.indexOf(" ",i);return x===-1?[y.slice(0,i),y.slice(i)]:[y.slice(0,x),y.slice(x+1)]},[h,j]=C(r),[M]=C(j.trimStart());return[h,M]},Rt=(r="",i,l="–")=>r?r.split(/\s+/).slice(0,i).join(" "):l,Ss=({data:r,getX:i,getY:l,isFullScreen:u,orientation:C,responsiveFontSize:h,onPointInteraction:j,clearActivePoint:M,activePoint:y,padding:x,chartHeight:G,chartWidth:H,temperatureField:U="temperature_chart",textRowHeight:E,compact:w=!1,reduceMotion:B=!1,showInterpretation:c=!1,ovulationDetails:F=null,firstHighIndex:K=null,baselineIndices:I=[],graphBottomLift:v=0,graphBottomY:Q,rowsZoneHeight:A})=>{const de={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},le={hidden:{opacity:0,scale:.3},visible:{opacity:1,scale:1,transition:{duration:.6,ease:[.34,1.56,.64,1],type:"spring",stiffness:120,damping:12}}},me=Q,Ve=Math.max(1,Math.floor(A/((u?9:7.5)+(u?1:.75)))),Y=Math.max(E,Ve),Ye=me+Y*1,T=me+Y*2,ge=me+Y*3,ne=me+Y*(u?5:4.5),W=me+Y*(u?7:6),ct=me+Y*(u?9:7.5),We=H-x.left-x.right,ue=Y*(u?2:1.5),Be=B?"g":je.g,Ce=Array.isArray(r)?r.length:0,pt=b.useMemo(()=>Ze(new Date),[]),Qe=b.useMemo(()=>{if(!c)return new Map;const s=Array.isArray(F==null?void 0:F.highSequenceIndices)?F.highSequenceIndices:[],d=new Map;return s.forEach((k,X)=>{const D=Number(k);Number.isInteger(D)&&D>=0&&D<Ce&&!d.has(D)&&d.set(D,X+1)}),d},[c,F,Ce]),qe=b.useMemo(()=>{if(!c)return new Map;const s=Array.isArray(I)?I:[];if(!s.length)return new Map;const d=new Set,k=[],X=P=>{const O=Number(P);Number.isInteger(O)&&O>=0&&O<Ce&&!d.has(O)&&(d.add(O),k.push(O))};if(s.forEach(P=>{X(P)}),K!=null){const P=Number(K);Number.isInteger(P)&&X(P-1)}if(!k.length)return new Map;const D=[...k].sort((P,O)=>P-O),ye=new Map;let ke=1;for(let P=D.length-1;P>=0&&!(ke>6);P-=1)ye.set(D[P],ke),ke+=1;return ye},[c,I,Ce,K]);return e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsx("filter",{id:"rowShadowChart",x:"-10%",y:"-10%",width:"120%",height:"120%",children:e.jsx("feDropShadow",{dx:"0",dy:"2",stdDeviation:"4",floodColor:"rgba(244, 114, 182, 0.2)"})}),e.jsxs("filter",{id:"pointGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("radialGradient",{id:"tempPointGradientChart",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FDF2F8"}),e.jsx("stop",{offset:"50%",stopColor:"#F9A8D4"}),e.jsx("stop",{offset:"85%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#DB2777"})]}),e.jsxs("radialGradient",{id:"tempPointIgnoredGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#FFFFFF"}),e.jsx("stop",{offset:"80%",stopColor:"#F8FAFC"}),e.jsx("stop",{offset:"100%",stopColor:"#E2E8F0"})]}),e.jsxs("radialGradient",{id:"ovulationPointGradient",cx:"30%",cy:"30%",children:[e.jsx("stop",{offset:"0%",stopColor:"#dbeafe"}),e.jsx("stop",{offset:"50%",stopColor:"#93c5fd"}),e.jsx("stop",{offset:"85%",stopColor:"#3b82f6"}),e.jsx("stop",{offset:"100%",stopColor:"#2563eb"})]})]}),!w&&e.jsxs("g",{children:[e.jsx("rect",{x:x.left,y:ne-ue/2,width:We,height:ue,fill:"rgba(239, 246, 255, 0.4)",stroke:"rgba(59, 130, 246, 0.08)",strokeWidth:.5,rx:3,style:{filter:"drop-shadow(0 1px 1px rgba(59, 130, 246, 0.03))"}}),e.jsx("rect",{x:x.left,y:W-ue/2,width:We,height:ue,fill:"rgba(236, 253, 245, 0.4)",stroke:"rgba(16, 185, 129, 0.08)",strokeWidth:.5,rx:3,style:{filter:"drop-shadow(0 1px 1px rgba(16, 185, 129, 0.03))"}}),e.jsx("rect",{x:x.left,y:ct-ue/2,width:We,height:ue,fill:"rgba(245, 243, 255, 0.4)",stroke:"rgba(139, 92, 246, 0.08)",strokeWidth:.5,rx:3,style:{filter:"drop-shadow(0 1px 1px rgba(139, 92, 246, 0.03))"}})]}),u&&C!=="portrait"&&e.jsx(je.g,{variants:de,children:[{label:"Fecha",row:1,color:u?"#374151":"#6B7280"},{label:"Día",row:2,color:u?"#374151":"#6B7280"},{label:"Símbolo",row:3,color:u?"#374151":"#6B7280"},{label:"Sens.",row:u?5:4.5,color:Ot},{label:"Apar.",row:u?7:6,color:Tt},{label:"Observ.",row:u?9:7.5,color:Bt}].map(({label:s,row:d,color:k})=>e.jsx("text",{x:x.left-h(.5),y:me+Y*d,textAnchor:"end",fontSize:h(1.05),fontWeight:"700",fill:k,style:{filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:s},s))}),r.map((s,d)=>{const k=i(d),X=s[U]!=null?l(s[U]):me,D=s.temperature_raw,ye=s.temperature_corrected,ke=s.use_corrected&&D!=null&&ye!=null&&Math.abs(ye-D)>.01,P=ke?l(D):null,O="#60666f",J=s[U]!=null,he=!!(s.had_relations??s.hadRelations);J||s.mucus_sensation||s.mucus_appearance||s.fertility_symbol;const Re=String(s.id||"").startsWith("placeholder-"),De=F==null?void 0:F.peakDayIndex,ie=c&&De!=null&&!s.ignored&&J&&d===De,be=Kt(s.fertility_symbol);let Ee="transparent";if(be!=null&&be.color){const xe=be.color.replace(/^bg-/,"");xe==="red-500"?Ee="#ef4444":xe==="white"?Ee="#ffffff":xe==="green-500"?Ee="#22c55e":xe==="pink-300"?Ee="#f9a8d4":xe==="yellow-400"&&(Ee="#facc15")}const Pe=s.isoDate?Xt(Ze(it(s.isoDate)),Ze(new Date)):!1,_=h(u?1.8:2),et=ge-_*.75+_/2+2,fe=s.peakStatus?String(s.peakStatus).toUpperCase():null,ee=fe==="P"||fe==="X",Ge=fe&&!ee,Ie=ee?Dt:fe||"–",tt=ee||["1","2","3"].includes(fe),dt=!Re&&be.value!=="none",ut=!!s.isoDate&&!Pe?{pointerEvents:"all",style:{cursor:"pointer"},onClick:xe=>j(s,d,xe)}:{},Le=(s.isoDate?Jt(it(s.isoDate),pt):!1)?ks:O,Ae=Qe.has(d),Oe=Ae?Qe.get(d):null,He=qe.has(d),Ue=He?qe.get(d):null,Se=h(u?.75:1.2),pe=Math.max(.5,Se*.18),oe=X-Se*(u?2.6:1.8),st=X+Se*(u?1.9:1.6),_e=u?4:7,Me=2,[ze,R]=vt(u?Rt(s.mucus_sensation,Me,Pe?"":"–"):s.mucus_sensation,_e,!1,Pe?"":"–"),[rt,Ke]=vt(u?Rt(s.mucus_appearance,Me,Pe?"":"–"):s.mucus_appearance,_e,!1,Pe?"":"–"),[at,nt]=vt(u?Rt(s.observations,Me,""):s.observations,_e,!1,"");return e.jsxs(Be,{...B?{}:{variants:de},...ut,children:[J&&e.jsxs(Be,{...B?{}:{variants:le},children:[ke&&P!==null&&e.jsxs("g",{pointerEvents:"none",children:[e.jsx("line",{x1:k,y1:P,x2:k,y2:X,stroke:ys,strokeWidth:1,strokeDasharray:"4 4"}),e.jsx("circle",{cx:k,cy:P,r:3,fill:bs,stroke:ws,strokeWidth:1}),e.jsx("circle",{cx:k,cy:P,r:1,fill:"rgba(255, 255, 255, 0.6)"})]}),e.jsx("circle",{cx:k,cy:X,r:ie?3.5:2.8,fill:s.ignored?"url(#tempPointIgnoredGradient)":ie?"url(#ovulationPointGradient)":"url(#tempPointGradientChart)",stroke:s.use_corrected?"#941616":s.ignored?"#94A3B8":ie?"#1d4ed8":"#E91E63",strokeWidth:s.ignored?1.5:ie?2.2:2,style:{filter:ie?"drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3))":"drop-shadow(0 2px 3px rgba(244, 114, 182, 0.25))",cursor:"pointer"},pointerEvents:"all",onClick:xe=>j(s,d,xe)}),!s.ignored&&e.jsx("circle",{cx:k,cy:X,r:ie?1.2:.9,fill:ie?"rgba(239, 246, 255, 0.95)":"rgba(255, 255, 255, 0.9)",style:{filter:ie?"drop-shadow(0 1px 3px rgba(37, 99, 235, 0.45))":"drop-shadow(0 1px 2px rgba(244, 114, 182, 0.3))"}}),c&&J&&!s.ignored&&Ae&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:k,y:oe,textAnchor:"middle",fontSize:Se,fontWeight:"900",fill:js,strokeWidth:pe,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Oe})}),c&&J&&!s.ignored&&He&&e.jsx("g",{pointerEvents:"none",children:e.jsx("text",{x:k,y:st,textAnchor:"middle",fontSize:Se,fontWeight:"800",fill:Cs,stroke:"#ffffff",strokeWidth:pe,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',paintOrder:"stroke",filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.85))"},children:Ue})})]}),e.jsx("text",{x:k,y:Ye,textAnchor:"middle",fontSize:h(1.05),fontWeight:"900",fill:Le,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Is(s.date)}),e.jsx("text",{x:k,y:T,textAnchor:"middle",fontSize:h(1),fontWeight:"900",fill:Le,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:s.cycleDay}),dt?e.jsxs("g",{children:[e.jsx("rect",{x:k-_/2+1,y:ge-_*.75+1,width:_,height:_,fill:"rgba(0, 0, 0, 0.1)",rx:_*.3,opacity:.5}),e.jsx("rect",{x:k-_/2-4,y:ge-_*.75,width:_*1.4,height:_,fill:be.pattern==="spotting-pattern"?"url(#spotting-pattern-chart)":Ee,stroke:be.value==="white"?"#CBD5E1":"rgba(233, 30, 99, 0.4)",strokeWidth:be.value==="white"?2:1,rx:_*.2,style:{filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.25))"}}),fe&&e.jsx("g",{pointerEvents:"none",children:ee?e.jsx("text",{x:k,y:et,textAnchor:"middle",fontSize:h(1.35),fontWeight:"900",fill:Nt,stroke:"#fff",strokeWidth:1.5,paintOrder:"stroke",style:{filter:Pt},children:Dt}):e.jsx("text",{x:k,y:et,textAnchor:"middle",fontSize:h(fe?1.1:1),fontWeight:"800",fill:Mt,style:{filter:"drop-shadow(0 1px 1px rgba(255,255,255,0.9))"},children:fe})})]}):e.jsxs("g",{children:[tt&&e.jsx("rect",{x:k-_/2-4,y:ge-_*.75,width:_*1.4,height:_,fill:"transparent",stroke:ee?Nt:Mt,strokeWidth:1,rx:_*.2}),e.jsx("text",{x:k,y:et,textAnchor:"middle",fontSize:h(ee?1.35:Ge?1.1:1),fill:ee?Nt:Ge?Mt:O,fontWeight:ee?"900":Ge?"800":"500",style:{filter:ee?Pt:Ge?"drop-shadow(0 1px 1px rgba(255,255,255,0.9))":"drop-shadow(0 1px 1px rgba(255, 255, 255, 0.8))"},children:Ie})]}),!w&&e.jsxs("text",{x:k,y:ne,textAnchor:"middle",fontSize:h(.9),fontWeight:"700",fill:Ot,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x:k,dy:0,children:ze}),R&&e.jsx("tspan",{x:k,dy:h(1.1),children:R})]}),!w&&e.jsxs("text",{x:k,y:W,textAnchor:"middle",fontSize:h(.9),fontWeight:"700",fill:Tt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x:k,dy:0,children:rt}),Ke&&e.jsx("tspan",{x:k,dy:h(1.1),children:Ke})]}),!w&&e.jsxs("text",{x:k,y:ct,textAnchor:"middle",fontSize:h(.9),fontWeight:"700",fill:Bt,style:{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',filter:"drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9))"},children:[e.jsx("tspan",{x:k,dy:0,children:at}),nt&&e.jsx("tspan",{x:k,dy:h(1.1),children:nt})]})]},`pt-${d}-${s.isoDate||s.timestamp}`)})]})},Ms="#1565C0",Ns="#2E7D32",vs="#6A1B9A",Rs=({padding:r,chartHeight:i,tempMin:l,tempMax:u,tempRange:C,getY:h,responsiveFontSize:j,textRowHeight:M,isFullScreen:y,graphBottomY:x,rowsZoneHeight:G})=>{const H={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}},U=[];if(C>0){const I=C<=2.5?.1:.5;for(let v=l;v<=u+1e-9;v+=I)U.push(parseFloat(v.toFixed(1)))}else for(let I=35.8;I<=37.2+1e-9;I+=.1)U.push(parseFloat(I.toFixed(1)));const E=x,c=Math.max(1,Math.floor(G/((y?9:7.5)+(y?1:.75)))),F=Math.max(M,c),K=b.useMemo(()=>[{label:"Fecha",row:1,color:"#374151",icon:null},{label:"Día",row:2,color:"#374151",icon:null},{label:"Símbolo",row:3,color:"#374151",icon:null},{label:"Sens.",row:y?5:4.5,color:Ms,icon:"◊"},{label:"Apar.",row:y?7:6,color:Ns,icon:"○"},{label:"Observ.",row:y?9:7.5,color:vs,icon:"✦"}],[y]);return e.jsxs("svg",{width:r.left,height:i,className:"font-sans pointer-events-none",children:[e.jsx("defs",{children:e.jsx("filter",{id:"textShadowLegend",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"1",floodColor:"rgba(255, 255, 255, 0.9)"})})}),U.map((I,v)=>{const Q=h(I),A=I.toFixed(1).endsWith(".0")||I.toFixed(1).endsWith(".5"),de=A?I.toFixed(1):`.${I.toFixed(1).split(".")[1]}`;return e.jsx(je.g,{variants:H,children:e.jsx("text",{x:r.left-j(1.2),y:Q+j(.35),textAnchor:"end",fontSize:j(A?1.15:1),fontWeight:A?"800":"700",fill:A?"#be185d":"#db2777",opacity:A?1:.85,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:de})},`temp-tick-fixed-${v}`)}),e.jsx(je.g,{variants:H,children:K.map(({label:I,row:v,color:Q,icon:A})=>e.jsxs("g",{children:[A&&e.jsx("text",{x:r.left-j(2.8),y:E+F*v,textAnchor:"middle",fontSize:j(.8),fontWeight:"600",fill:Q,opacity:.7,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:A}),e.jsx("text",{x:r.left-j(.8),y:E+F*v,textAnchor:"end",fontSize:j(1.05),fontWeight:"800",fill:Q,style:{filter:"url(#textShadowLegend)",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},children:I})]},I))})]})},_t="#be123c",Es="rgba(252, 231, 243, 0.40)",Ls="rgba(244, 114, 182, 0.08)",As="0 1px 1px rgba(244, 114, 182, 0.03)",Os=({allDataPoints:r=[],getX:i,padding:l,chartWidth:u,textRowHeight:C,isFullScreen:h,responsiveFontSize:j})=>{const M=(h?2:1.5)*C,y=Math.max(M,28),x=l||{left:0,right:0},G=Number.isFinite(u)&&u>0?u:0,H=Math.min(Math.max(y*.46,14),15),U=G>0?{width:G,minWidth:G}:{width:"100%",minWidth:"100%"},E=b.useMemo(()=>!Array.isArray(r)||!i?[]:r.map((w,B)=>{if(!!!((w==null?void 0:w.had_relations)??(w==null?void 0:w.hadRelations)))return null;const F=i(B)-((l==null?void 0:l.left)??0);if(!Number.isFinite(F))return null;const K=(w==null?void 0:w.isoDate)||`day-${B}`;return{key:`${K}-${B}`,x:F,isoDate:K}}).filter(Boolean),[r,i]);return e.jsxs("div",{className:"relative w-full",style:{height:y,minHeight:y,...U,flexShrink:0,position:"relative",marginTop:-7},children:[e.jsx("div",{className:"absolute inset-y-0",style:{width:x.left,left:0},children:e.jsx("div",{className:"h-full flex items-center justify-end pr-3",children:e.jsx("span",{className:"font-sans font-bold select-none",style:{fontSize:j(1.05),fontWeight:"800",color:_t},children:"RS"})})}),e.jsx("div",{className:"absolute inset-y-0 rounded-xl",style:{left:x.left,right:x.right,backgroundColor:Es,border:`0.5px solid ${Ls}`,borderRadius:6,boxShadow:As}}),e.jsx("div",{className:"absolute inset-y-0",style:{left:x.left,right:x.right},children:E.map(({key:w,x:B,isoDate:c})=>e.jsx("span",{className:"absolute font-semibold select-none",style:{left:B,top:"50%",transform:"translate(-50%, -50%)",fontSize:H,color:_t,textShadow:"0 1px 1px rgba(0, 0, 0, 0.05)",lineHeight:1},role:"img","aria-label":`Relación registrada el ${c}`,children:"❤"},w))})]})},Ts=({data:r,isFullScreen:i,orientation:l,onToggleIgnore:u,onEdit:C,onTogglePeak:h,cycleId:j,initialScrollIndex:M=0,visibleDays:y=5,showInterpretation:x=!1,reduceMotion:G=!1,forceLandscape:H=!1,currentPeakIsoDate:U=null,showRelationsRow:E=!1,fertilityStartConfig:w=null,fertilityCalculatorCycles:B=[],fertilityCalculatorCandidates:c=null,onShowPhaseInfo:F=null,isArchivedCycle:K=!1,cycleEndDate:I=null})=>{const{chartRef:v,tooltipRef:Q,dimensions:A,activePoint:de,activeIndex:le,tooltipPosition:me,allDataPoints:N,validDataForLine:ve,tempMin:Ve,tempMax:Y,tempRange:Ye,padding:T,textRowHeight:ge,getY:ne,getX:W,handlePointInteraction:ct,handleToggleIgnore:We,responsiveFontSize:ue,clearActivePoint:Be,baselineTemp:Ce,baselineStartIndex:pt,baselineIndices:Qe,firstHighIndex:qe,ovulationDetails:s,fertilityStart:d,hasTemperatureData:k,hasAnyObservation:X,graphBottomInset:D,todayIndex:ye}=Qt(r,i,l,u,j,y,H,w,B,c),ke=b.useRef(null);if(!ke.current){const a=Math.random().toString(36).slice(2,10);ke.current=`fertility-chart-${j??"default"}-${a}`}const P=ke.current;if(!N||N.length===0)return e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-pink-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),e.jsx("p",{className:"text-slate-400 font-medium",children:"No hay datos para mostrar en el gráfico"})]});const O=A.width,J=A.height,he=J-T.bottom-(D||0),Re=Math.max(J-he,0),De=Ce!=null?ne(Ce):null,ie=!!(s!=null&&s.confirmed),be=Ce!=null,Ee=W(0),Pe=N.length>0?W(N.length-1):O-T.right,_=ie?"#F59E0B":"#94A3B8",et=ie?"6 4":"4 4",fe=ie?1:.7,ee=3,Ge=O===0,Ie=le!=null?W(le):null,tt=le!=null?le>0?W(le-1):Ie:null,dt=le!=null?le<N.length-1?W(le+1):Ie:null,xt=Math.max((O-T.left-T.right)/Math.max(N.length,1),0),ut=le!=null?Math.max((dt!=null&&tt!=null?dt-tt:0)||xt,xt,0):0,mt=b.useMemo(()=>{const a=new Map;return ve.forEach(m=>{m&&m.id!=null&&a.set(m.id,m)}),a},[ve]),Le=b.useMemo(()=>s!=null&&s.confirmed&&Number.isFinite(s==null?void 0:s.infertileStartIndex)?s.infertileStartIndex:null,[s]),Ae=b.useMemo(()=>Number.isFinite(s==null?void 0:s.peakInfertilityStartIndex)?s.peakInfertilityStartIndex:null,[s]);b.useMemo(()=>Le==null||Ae==null?null:Math.max(Le,Ae),[Le,Ae]);const Oe=b.useMemo(()=>Number.isInteger(d==null?void 0:d.fertileStartFinalIndex)?d.fertileStartFinalIndex:null,[d]),He=Math.max(J-T.top-T.bottom-(D||0),0),Ue=b.useCallback(a=>!Number.isFinite(a)||!N.length||a<=0?T.left:W(a),[N,W,T.left]),Se=b.useCallback(a=>!Number.isFinite(a)||!N.length||a>=N.length-1?O-T.right:W(a+1),[N,O,W,T.right]),pe=b.useCallback((a,m,{inclusiveEnd:g=!0}={})=>{if(!Number.isFinite(a)||!Number.isFinite(m)||N.length===0)return null;const L=we=>Math.max(0,Math.min(N.length-1,Math.floor(we))),z=we=>Math.max(0,Math.min(N.length-1,Math.floor(we))),q=we=>Math.max(0,Math.min(N.length,Math.floor(we))),Z=L(a),V=g?z(m):q(m),te=Z<=0?T.left:Ue(Z);let ce;g?ce=V>=N.length-1?O-T.right:Se(V):V<=0?ce=T.left:V>=N.length?ce=O-T.right:ce=Ue(V);const Ne=Math.max(ce-te,0);return Ne<=0?null:{x:te,width:Ne}},[N,O,Ue,Se,T.left,T.right]),oe=N.length>0?N.length-1:null,st=b.useMemo(()=>{var g;if(!K||!I||oe==null)return null;const a=typeof I=="string"?I:null;if(!a)return null;const m=N.findIndex(L=>(L==null?void 0:L.isoDate)===a);if(m>=0)return Math.min(m,oe);for(let L=N.length-1;L>=0;L-=1){const z=(g=N[L])==null?void 0:g.isoDate;if(typeof z=="string"&&z<=a)return Math.min(L,oe)}return null},[K,I,N,oe]),_e=b.useMemo(()=>oe==null?null:K?Number.isInteger(st)?Math.min(st,oe):oe:Number.isInteger(ye)?Math.min(ye,oe):oe,[st,K,ye,oe]),Me=He>0?T.top+He*.5:null,ze=Me!=null?Math.max(he-Me,0):0,R=b.useMemo(()=>{if(!x||!X)return null;const a={confirmed:!!(s!=null&&s.confirmed),rule:(s==null?void 0:s.rule)??null,baselineTemp:(s==null?void 0:s.baselineTemp)??null,baselineIndices:Array.isArray(s==null?void 0:s.baselineIndices)?s.baselineIndices:[],firstHighIndex:Number.isInteger(s==null?void 0:s.firstHighIndex)?s.firstHighIndex:null,highSequenceIndices:Array.isArray(s==null?void 0:s.highSequenceIndices)?s.highSequenceIndices:[],confirmationIndex:Number.isInteger(s==null?void 0:s.confirmationIndex)?s.confirmationIndex:null,startIndex:Number.isInteger(Le)?Le:null},m={peakDayIndex:Number.isInteger(s==null?void 0:s.peakDayIndex)?s.peakDayIndex:null,thirdDayIndex:Number.isInteger(s==null?void 0:s.thirdDayIndex)?s.thirdDayIndex:null,startIndex:Number.isInteger(Ae)?Ae:null},g=a.startIndex!=null,L=m.startIndex!=null;if(!g&&!L)return null;let z=null,q="pending",Z="",V="Postovulatoria (pendiente)",te="Postovulatoria pendiente, a la espera del segundo criterio.";if(g&&L)z=Math.max(a.startIndex,m.startIndex),q="absolute",V="Infertilidad absoluta",te="Infertilidad absoluta (postovulatoria con doble criterio alcanzado)",Z="Infertilidad absoluta";else if(g){z=a.startIndex;const ce=a.rule||"regla desconocida",Ne=a.confirmationIndex!=null?`D${a.confirmationIndex+1}`:"—";Z=`Postovulatoria (pendiente): falta moco. Temperatura con regla ${ce} confirmada en ${Ne}.`,te=Z,V="Postovulatoria (temperatura)"}else z=m.startIndex,Z=`Postovulatoria (pendiente): falta temperatura (método moco alcanzado vía ${m.thirdDayIndex!=null?"3° día":"P+4"}).`,te=Z,V="Postovulatoria (moco)";return{phase:"postOvulatory",status:q,startIndex:z,reasons:{type:"post",status:q,mucus:m,temperature:a},message:Z,label:V,tooltip:te}},[x,X,s,Le,Ae]),rt=b.useMemo(()=>{var ce,Ne,we,Xe,bt;if(!x||He<=0||Me==null||ze<=0||N.length===0)return[];const a=[],m=N.length-1,g=Number.isInteger(_e)&&_e>=0?Math.min(_e,m):m,L=Number.isInteger(Oe),z=Number.isFinite(R==null?void 0:R.startIndex);if(!L&&!z){const se=Math.min(g,m);if(se<0)return a;const re=pe(0,se);return re&&a.push({key:"relative-default",phase:"relativeInfertile",status:"default",bounds:re,startIndex:0,endIndex:se,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (preovulatoria: sin día fértil por CPM/T-8 ni signos de moco fértil)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:null,aggregate:(d==null?void 0:d.aggregate)??null,bipScore:((ce=d==null?void 0:d.debug)==null?void 0:ce.bipScore)??null}}),a}if(!L&&z){const se=R.startIndex,re=Math.min(se-1,g);if(re>=0){const $e=pe(0,re);$e&&a.push({key:"no-fertile-window",phase:"nodata",status:"no-fertile-window",bounds:$e,startIndex:0,endIndex:re,displayLabel:"Sin ventana fértil identificable",tooltip:"Sin ventana fértil identificable",message:"Sin ventana fértil identificable",reasons:{type:"nofertile",status:"no-fertile-window",message:"No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."}})}if(Number.isFinite(R.startIndex)&&R.startIndex<=m){const $e=R.status==="absolute"?m:Math.min(m,g),ot=pe(R.startIndex,$e);ot&&a.push({key:"post",phase:R.phase,status:R.status,bounds:ot,startIndex:R.startIndex,endIndex:$e,displayLabel:R.label,tooltip:R.tooltip,message:R.message,reasons:R.reasons})}return a}if(L&&Oe>0){const se=Math.min(Oe-1,g);if(se>=0){const re=pe(0,se);re&&a.push({key:"relative",phase:"relativeInfertile",status:"default",bounds:re,startIndex:0,endIndex:se,displayLabel:"Relativamente infértil",tooltip:"Relativamente infértil (fase relativamente infértil preovulatoria)",message:"Relativamente infértil",reasons:{type:"relative",fertileStartFinalIndex:Oe,aggregate:(d==null?void 0:d.aggregate)??null,bipScore:((Ne=d==null?void 0:d.debug)==null?void 0:Ne.bipScore)??null}})}}const q=L?Math.max(Oe,0):0,Z=R==null?void 0:R.startIndex,V=Number.isFinite(Z)&&Z!=null?Math.min(Z-1,m):m,te=Math.min(V,g);if(te>=q){const se=pe(q,te);if(se){const re=Number.isInteger((we=d==null?void 0:d.debug)==null?void 0:we.explicitStartDay)?d.debug.explicitStartDay:null,$e=((Xe=d==null?void 0:d.aggregate)==null?void 0:Xe.usedCandidates)??[],ot=$e.some(Je=>(Je==null?void 0:Je.kind)==="profile"),It=$e.some(Je=>(Je==null?void 0:Je.kind)==="calculator");let ae=null;L&&re!=null&&re===Oe?ae="marker":ot?ae="profiles":It&&(ae="calculator"),a.push({key:"fertile",phase:"fertile",status:"default",bounds:se,startIndex:q,endIndex:te,displayLabel:"Fértil",tooltip:"Fértil",message:"Fértil",reasons:{type:"fertile",startIndex:q,endIndex:te,source:ae,details:(d==null?void 0:d.debug)??null,notes:((bt=d==null?void 0:d.aggregate)==null?void 0:bt.notes)??[],statusSummary:(d==null?void 0:d.currentAssessment)??null,dailyAssessments:(d==null?void 0:d.dailyAssessments)??[],window:(d==null?void 0:d.fertileWindow)??null,aggregate:(d==null?void 0:d.aggregate)??null}})}}if(R&&Number.isFinite(R.startIndex)&&R.startIndex<=m){const se=R.status==="absolute"?m:Math.min(m,g),re=pe(R.startIndex,se);re&&a.push({key:"post",phase:R.phase,status:R.status,bounds:re,startIndex:R.startIndex,endIndex:se,displayLabel:R.label,tooltip:R.tooltip,message:R.message,reasons:R.reasons})}return a},[x,He,Me,ze,N.length,Oe,d,R,X,pe,_e]),Ke=`${P}-phase-relative-gradient`,at=`${P}-phase-fertile-gradient`,nt=`${P}-phase-post-pending-gradient`,xe=`${P}-phase-post-absolute-gradient`,kt=a=>a.phase==="relativeInfertile"?"#065F46":a.phase==="fertile"?"#9D174D":a.phase==="postOvulatory"?a.status==="pending"?"#075985":"#1E3A8A":a.phase==="nodata"?"#475569":"hsl(var(--foreground))",yt="0 1px 1px var(--phase-text-shadow, rgba(15, 23, 42, 0.2))",t=b.useMemo(()=>{if(!x||!(s!=null&&s.confirmed))return null;const a=Array.isArray(s==null?void 0:s.highSequenceIndices)?s.highSequenceIndices:[];if(a.length<2)return null;const m=a.map(g=>{if(g==null||g<0||g>=N.length)return null;const L=N[g],z=mt.get(L==null?void 0:L.id);return!z||!Number.isFinite(z.displayTemperature)?null:{x:W(g),y:ne(z.displayTemperature)}}).filter(Boolean);return m.length<2?null:m.map(({x:g,y:L},z)=>`${z===0?"M":"L"} ${g} ${L}`).join(" ")},[x,s,N,mt,W,ne]),[o,n]=b.useState({w:typeof window<"u"?window.innerWidth:0,h:typeof window<"u"?window.innerHeight:0}),f=o.w<o.h;b.useEffect(()=>{const a=()=>n({w:window.innerWidth,h:window.innerHeight});return window.addEventListener("resize",a),window.addEventListener("orientationchange",a),()=>{window.removeEventListener("resize",a),window.removeEventListener("orientationchange",a)}},[]),b.useEffect(()=>{if(!v.current)return;const a=v.current.clientWidth/y;v.current.scrollLeft=Math.max(0,a*M)},[M,y,A.width,l]);const p=H&&f,S=p,$="w-full h-full bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",Te=i?`${$} min-h-full ${S?"overflow-y-auto overflow-x-hidden":"overflow-x-auto overflow-y-visible"}`:`${$} overflow-x-auto overflow-y-visible border border-pink-100/50`,Fe=!i||l==="portrait";return e.jsx(je.div,{className:"relative w-full h-full",initial:!1,children:e.jsxs(je.div,{ref:v,className:`relative p-0 ${i?"":"rounded-2xl"} ${Te}`,style:{touchAction:"auto",boxShadow:i?"inset 0 1px 3px rgba(244, 114, 182, 0.1)":"0 8px 32px rgba(244, 114, 182, 0.12), 0 2px 8px rgba(244, 114, 182, 0.08)",...p?{position:"absolute",top:0,left:0,width:`${o.h}px`,height:`${o.w}px`,transform:"rotate(90deg) translateY(-100%)",transformOrigin:"top left"}:{}},initial:!1,children:[Ge&&e.jsx("div",{className:"flex items-center justify-center w-full h-full text-slate-400",children:"Cargando..."}),e.jsxs("div",{className:"inline-block",style:{width:O,height:J},children:[Fe&&e.jsx("div",{className:"absolute left-0 top-0 h-full bg-transparent pointer-events-none z-10",style:{width:T.left},children:e.jsx(Rs,{padding:T,chartHeight:J,tempMin:Ve,tempMax:Y,tempRange:Ye,getY:ne,responsiveFontSize:ue,textRowHeight:ge,isFullScreen:i,graphBottomY:he,rowsZoneHeight:Re})}),e.jsxs(je.svg,{width:O,height:J,className:"font-sans flex-shrink-0",viewBox:`0 0 ${O} ${J}`,preserveAspectRatio:"xMidYMid meet",initial:!1,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"tempLineGradientChart",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#F472B6"}),e.jsx("stop",{offset:"50%",stopColor:"#EC4899"}),e.jsx("stop",{offset:"100%",stopColor:"#E91E63"})]}),e.jsxs("linearGradient",{id:"tempAreaGradientChart",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(244, 114, 182, 0.18)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(244, 114, 182, 0.02)"})]}),e.jsxs("linearGradient",{id:Ke,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-rel)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-rel)",stopOpacity:"var(--phase-rel-stop, 0.28)"})]}),e.jsxs("linearGradient",{id:at,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-fertile)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-fertile)",stopOpacity:"var(--phase-fertile-stop, 0.27)"})]}),e.jsxs("linearGradient",{id:nt,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post)",stopOpacity:"var(--phase-post-stop, 0.45)"})]}),e.jsxs("linearGradient",{id:xe,x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--phase-post-abs)",stopOpacity:"0"}),e.jsx("stop",{offset:"100%",stopColor:"var(--phase-post-abs)",stopOpacity:"var(--phase-post-abs-stop, 0.7)"})]}),e.jsxs("pattern",{id:"spotting-pattern-chart",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("filter",{id:"chartShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]}),e.jsxs("filter",{id:"baselineGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("rect",{width:"100%",height:"100%",fill:"transparent"}),e.jsx(ms,{padding:T,chartWidth:O,chartHeight:J,tempMin:Ve,tempMax:Y,tempRange:Ye,getY:ne,getX:W,allDataPoints:N,responsiveFontSize:ue,isFullScreen:i,showLeftLabels:!Fe,reduceMotion:G,graphBottomY:he,chartAreaHeight:Math.max(J-T.top-T.bottom-(D||0),0),rowsZoneHeight:Re}),x&&rt.length>0&&Me!=null&&ze>0&&e.jsx("g",{children:rt.map(a=>{const m=Me,g=ze,z=(()=>a.phase==="postOvulatory"?a.status==="pending"?`url(#${nt})`:`url(#${xe})`:a.phase==="relativeInfertile"?`url(#${Ke})`:a.phase==="fertile"?`url(#${at})`:a.phase==="nodata"?"rgba(203, 213, 225, 0.2)":`url(#${at})`)(),q=i?14:13,Z=Math.max(ue(1.1),q),V=a.bounds.width<120,te=Math.max(a.bounds.width-16,0),ce=Math.max(Z*.58,1),Ne=Math.max(1,Math.floor(te/ce)),we=a.tooltip??a.displayLabel??a.message??"";let Xe=a.displayLabel??a.message??"";if(V&&Xe.length>Ne){const ae=Math.max(Ne-1,1);Xe=`${Xe.slice(0,ae).trimEnd()}${Xe.length>ae?"…":""}`}const bt=V?a.bounds.x+8:a.bounds.x+a.bounds.width/2,se=V?"start":"middle",re=m+g/2,$e=kt(a),ot=ae=>{typeof(ae==null?void 0:ae.stopPropagation)=="function"&&ae.stopPropagation(),typeof F=="function"&&F({phase:a.phase,status:a.status,reasons:a.reasons,message:a.message,startIndex:a.startIndex,endIndex:a.endIndex,label:a.displayLabel??a.message??null})},It=ae=>{(ae.key==="Enter"||ae.key===" ")&&(ae.preventDefault(),ot(ae))};return e.jsxs("g",{children:[e.jsx("rect",{x:a.bounds.x,y:m,width:a.bounds.width,height:g,fill:z,pointerEvents:"none"}),e.jsxs("text",{x:bt,y:re,fill:$e,fontSize:Z,fontWeight:600,dominantBaseline:"middle",textAnchor:se,role:"button","aria-label":we,tabIndex:0,onClick:ot,onKeyDown:It,style:{cursor:"pointer",userSelect:"none",lineHeight:1.2,textShadow:yt},pointerEvents:"auto",children:[e.jsx("title",{children:we}),Xe]})]},a.key)})}),x&&be&&De!==null&&(G?e.jsx("line",{x1:Ee,y1:De,x2:Pe,y2:De,stroke:_,strokeWidth:ee,strokeDasharray:et,opacity:fe}):e.jsx(je.path,{d:`M ${Ee} ${De} L ${Pe} ${De}`,stroke:_,strokeWidth:ee,strokeDasharray:et,opacity:fe,initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:fe},transition:{duration:4,ease:"easeInOut",delay:.5}})),e.jsx(gs,{data:ve,allDataPoints:N,getX:W,getY:ne,baselineY:he,temperatureField:"displayTemperature",reduceMotion:G}),t&&e.jsx("g",{pointerEvents:"none",children:e.jsx("path",{d:t,fill:"none",stroke:"#cc0e93",strokeWidth:4,strokeLinecap:"round",strokeLinejoin:"round",opacity:.9})}),le!==null&&Ie!==null&&ut>0&&e.jsx("g",{pointerEvents:"none",children:(()=>{const a=he,m=Math.max(3,Math.min(14,ut*.4)),g=Math.max(m*2,ge*.85);return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:Ie,y1:0,x2:Ie,y2:a,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:m}),e.jsx("line",{x1:Ie,y1:a,x2:Ie,y2:J,stroke:"rgba(235, 171, 204,0.15)",strokeWidth:g})]})})()}),e.jsx(Ss,{data:N,getX:W,getY:ne,isFullScreen:i,orientation:l,responsiveFontSize:ue,onPointInteraction:ct,clearActivePoint:Be,activePoint:de,padding:T,chartHeight:J,chartWidth:O,temperatureField:"displayTemperature",textRowHeight:ge,graphBottomY:he,rowsZoneHeight:Re,compact:!1,reduceMotion:G,showInterpretation:x,ovulationDetails:s,baselineStartIndex:pt,firstHighIndex:qe,baselineIndices:Qe,graphBottomLift:D})]})]}),E&&e.jsx(Os,{allDataPoints:N,getX:W,padding:T,chartWidth:O,textRowHeight:ge,isFullScreen:i,responsiveFontSize:ue}),de&&e.jsx(je.div,{ref:Q,initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:10},transition:{duration:.12,ease:"easeOut"},children:e.jsx(es,{point:de,position:me,chartWidth:O,chartHeight:J,onToggleIgnore:We,onEdit:C,onClose:Be,onTogglePeak:h,currentPeakIsoDate:U})})]})})};function Bs(r,i){if(!r||!i)return[];const l=typeof r=="string"?it(r):r;return[...Array(i)].map((u,C)=>{const h=Ut(l,C),j=gt(h,"yyyy-MM-dd"),M=gt(h,"dd/MM"),y=Lt(Ze(h),Ze(l))+1;return{date:M,isoDate:j,cycleDay:y,temperature:null,mucusSensation:null,mucusAppearance:null,had_relations:!1,hadRelations:!1,id:`placeholder-${j}`,ignored:!1,peak_marker:null}})}const Ft="fertility-chart-settings",ft=r=>Number.isFinite(r)?Math.round(r):null,Ht=(r,i)=>{if(!Array.isArray(r)||r.length===0)return null;if(i==null)return r[0];const l=ft(i);return r.find(C=>ft(C==null?void 0:C.day)===l)||r[0]},Ct=r=>r?String(r).toUpperCase().replace(/-/g,""):"",$t=r=>{const i=Ct(r);return i==="T8"?"T-8":i==="CPM"?"CPM":r??""},Ds=r=>{if(!r)return"por cambio en sensación/moco";const i=Array.isArray(r.usedCandidates)?r.usedCandidates:[],l=ft(r.selectedDay);return i.some(h=>{if(!h)return!1;const j=ft(h.day);if(l!=null&&j!==l)return!1;const M=String(h.source??"").toUpperCase();return h.kind==="calculator"&&(M==="T8"||M==="T-8")})||i.some(h=>{if(!h)return!1;const j=ft(h.day);return l!=null&&j!==l?!1:h.kind==="calculator"})?"por T−8":"por cambio en sensación/moco"},Ps=(r={})=>{const i=r.statusSummary??null,l=(i==null?void 0:i.reasonParts)??{};if(l.symbol==="white")return"marcador white";if(l.sensation)return"cambio en sensación";if(l.appearance)return"cambio en moco";const u=r.aggregate??null,C=Array.isArray(u==null?void 0:u.usedCandidates)?u.usedCandidates:[],h=ft(u==null?void 0:u.selectedDay),j=r.details??{},M=Number.isFinite(j==null?void 0:j.explicitStartDay)?j.explicitStartDay+1:null;if((u==null?void 0:u.selectedMode)==="marcador"||M!=null&&M===h)return"marcador white";const y=Ht(C,h),x=C.some(E=>{if(!E)return!1;const w=String(E.source??"").toUpperCase();return E.kind==="calculator"&&(w==="T8"||w==="T-8")});if((y==null?void 0:y.kind)==="calculator"||x)return"T−8";const G=String((y==null?void 0:y.reason)??"").toUpperCase();return G.includes("WHITE")?"marcador white":G.includes("M")?"cambio en moco":G.includes("S")||G.includes("BIP")?"cambio en sensación":C.some(E=>String((E==null?void 0:E.reason)??"").toUpperCase().includes("M"))?"cambio en moco":C.some(E=>{const w=String((E==null?void 0:E.reason)??"").toUpperCase();return w.includes("S")||w.includes("BIP")})?"cambio en sensación":null},_s=(r={})=>{const i=r.mucus??{},l=r.temperature??{},u=Number.isInteger(i.startIndex),C=Number.isInteger(l.startIndex),h=i.thirdDayIndex!=null?"P+3":"P+4",j=typeof l.rule=="string"?l.rule:"",M=j.toLowerCase();if(u&&C){if(M.includes("oms"))return`${h} y T+3 (OMS)`;if(M.includes("aleman"))return`${h} y T+3 (Alemanas)`;const y=j?` (${j})`:"";return`${h} y T+3${y}`}return C?M.includes("oms")||M.includes("aleman")?`T+3 (${j})`:`T+3 (${j||"temperatura"})`:u?`${h} (moco)`:"criterio indeterminado"},ht=()=>({methods:{alemanas:!0,oms:!0,creighton:!0},calculators:{cpm:!0,t8:!0},postpartum:!1,combineMode:"conservador"}),Wt={showRelationsRow:!1,fertilityStartConfig:ht()},Fs=[{key:"alemanas",label:"Alemanas"},{key:"oms",label:"OMS"},{key:"creighton",label:"Creighton"}],$s=[{key:"cpm",label:"CPM"},{key:"t8",label:"T-8"}],At={conservador:"Conservador",consenso:"Consenso",permisivo:"Permisivo"},Et=r=>{const i=ht(),l={methods:{...i.methods},calculators:{...i.calculators},postpartum:i.postpartum,combineMode:i.combineMode};if(r&&typeof r=="object"){Object.keys(l.methods).forEach(C=>{var h;typeof((h=r==null?void 0:r.methods)==null?void 0:h[C])=="boolean"&&(l.methods[C]=r.methods[C])});let u=!1;if(Object.keys(l.calculators).forEach(C=>{var h;typeof((h=r==null?void 0:r.calculators)==null?void 0:h[C])=="boolean"&&(l.calculators[C]=r.calculators[C],u=!0)}),Object.prototype.hasOwnProperty.call(At,r.combineMode)&&(l.combineMode=r.combineMode),typeof r.postpartum=="boolean"?l.postpartum=r.postpartum:r.postpartum!=null&&(l.postpartum=!!r.postpartum),!u){const{alemanas:C,oms:h,creighton:j}=l.methods;C?(l.calculators.cpm=!0,l.calculators.t8=!0):(h||j)&&(l.calculators.cpm=!1,l.calculators.t8=!1)}}else{const{alemanas:u,oms:C,creighton:h}=l.methods;u?(l.calculators.cpm=!0,l.calculators.t8=!0):(C||h)&&(l.calculators.cpm=!1,l.calculators.t8=!1)}return l},Js=()=>{var yt;const{cycleId:r}=zt(),i=Vt(),{currentCycle:l,archivedCycles:u,isLoading:C,addOrUpdateDataPoint:h,toggleIgnoreRecord:j,getCycleById:M}=ss(),[y,x]=b.useState(null),[G,H]=b.useState(!1),[U,E]=b.useState(!1),w=!r||r===l.id,B=w?null:u.find(t=>t.id===r);b.useEffect(()=>{if(w){x(null),H(!1),E(!1);return}if(B){x(null),H(!1),E(!1);return}let t=!0;return H(!0),M(r).then(o=>{t&&(o?(x(o),E(!1)):(x(null),E(!0)))}).catch(()=>{t&&(x(null),E(!0))}).finally(()=>{t&&H(!1)}),()=>{t=!1}},[w,B,M,r]);const c=w?l:B||y,F=!w&&!B,K=!w&&(c==null?void 0:c.id),I=w?C&&!(l!=null&&l.id):G||C&&!B&&!y,{preferences:v}=Yt(),Q=v==null?void 0:v.manualCpm,A=v==null?void 0:v.manualCpmBase,de=v==null?void 0:v.manualT8,le=v==null?void 0:v.manualT8Base,me=b.useMemo(()=>{if(!K||!(c!=null&&c.startDate))return"";const t=f=>{if(!f)return null;try{return gt(it(f),"dd/MM/yyyy")}catch(p){return console.error("Error formatting cycle date",p),f}},o=t(c.startDate),n=t(c.endDate)??"Sin fecha de fin";return o?`Ciclo ${o} - ${n}`:""},[K,c==null?void 0:c.startDate,c==null?void 0:c.endDate]),N=b.useMemo(()=>{const t=[];return Array.isArray(u)&&u.length>0&&t.push(...u),l!=null&&l.id&&t.push(l),c!=null&&c.id&&!t.some(o=>(o==null?void 0:o.id)===c.id)&&t.push(c),t},[u,l,c]),[ve,Ve]=b.useState(typeof window<"u"&&window.innerWidth>window.innerHeight?"landscape":"portrait"),[Y,Ye]=b.useState(!1),[T,ge]=b.useState(!1),[ne,W]=b.useState(null),[ct,We]=b.useState(null),[ue,Be]=b.useState(!1),[Ce,pt]=b.useState(!1),[Qe,qe]=b.useState(!1),[s,d]=b.useState(null),[k,X]=b.useState(()=>{const t={showRelationsRow:Wt.showRelationsRow,fertilityStartConfig:Et(Wt.fertilityStartConfig)};if(typeof window>"u")return t;try{const o=window.localStorage.getItem(Ft);if(o){const n=JSON.parse(o),f={...t,...n};return typeof(n==null?void 0:n.showRelationsRow)=="boolean"?f.showRelationsRow=n.showRelationsRow:(n==null?void 0:n.showRelationsRow)!=null&&(f.showRelationsRow=!!n.showRelationsRow),f.fertilityStartConfig=Et(n==null?void 0:n.fertilityStartConfig),f}}catch(o){console.warn("No se pudieron cargar los ajustes del gráfico.",o)}return t}),D=b.useMemo(()=>Et(k.fertilityStartConfig),[k.fertilityStartConfig]);b.useEffect(()=>{if(!(typeof window>"u"))try{const t={...k,fertilityStartConfig:D};window.localStorage.setItem(Ft,JSON.stringify(t))}catch(t){console.warn("No se pudieron guardar los ajustes del gráfico.",t)}},[k,D]);const ye=b.useRef(!1),ke=!!(ne&&String(ne.id||"").startsWith("placeholder-"));if(b.useEffect(()=>{const t=async()=>{var n,f;const o=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);if(Ye(o),!o){try{const p=typeof window<"u"?(n=window.screen)==null?void 0:n.orientation:null;await((f=p==null?void 0:p.unlock)==null?void 0:f.call(p))}catch{}Ve("portrait")}};return document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("MSFullscreenChange",t),()=>{document.removeEventListener("fullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.removeEventListener("MSFullscreenChange",t)}},[]),b.useLayoutEffect(()=>{window.dispatchEvent(new Event("resize"))},[ve,Y]),I)return e.jsx(wt,{children:e.jsx("div",{className:"flex h-full flex-col items-center justify-center space-y-4 bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100 px-4 py-8 text-center text-pink-600",children:e.jsx("p",{children:"Cargando…"})})});if(!(c!=null&&c.id))return r&&U?e.jsx(wt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-pink-600",children:[e.jsx("p",{children:"No se encontró el ciclo solicitado."}),e.jsx(lt,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow",children:e.jsx(St,{to:"/archived-cycles",children:"Volver a Mis Ciclos"})})]})}):e.jsx(wt,{children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 px-4 py-8 text-center text-pink-600",children:[e.jsx("p",{children:"No hay ciclo activo."}),e.jsx(lt,{asChild:!0,className:"bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow",children:e.jsx(St,{to:"/records",children:"Ir a Mis Registros"})})]})});const P=28,O=10,J=25,he=it(c.startDate),Re=c.data||[],De=b.useMemo(()=>{const t=Array.isArray(Re)?Re.find(o=>(o==null?void 0:o.peak_marker)==="peak"):null;return(t==null?void 0:t.isoDate)||null},[Re]),ie=Re.reduce((t,o)=>{const n=it(o.isoDate);return n>t?n:t},he),be=Ze(new Date),Ee=ie>be?ie:be,Pe=Lt(Ze(Ee),he),_=Math.max(P,Pe+1),fe=Bs(he,_).map(t=>{const o=Re.find(n=>n.isoDate===t.isoDate);return o?{...o,date:t.date}:t}),ee=Y?ve==="portrait"?O:J:ve==="portrait"?O:P;let Ge=0;if(ve!=="landscape"){const t=Lt(new Date,Ze(he)),o=Math.min(Math.max(t,0),_-1);let n=Math.min(_,o+1);o<ee-1&&(n=Math.min(_,ee)),Ge=Math.max(0,n-ee)}const Ie={background:"linear-gradient(to br, #fff1f2 0%, #fce7f3 50%, #ffe4e6 100%)"},tt="var(--bottom-nav-safe)",dt=Y?{...Ie,height:"100dvh",maxHeight:"100dvh",paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"}:{...Ie,height:`calc(100dvh - ${tt})`,maxHeight:`calc(100dvh - ${tt})`,paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"},xt=(t,o=null)=>{W(t),We(o??null),ge(!0)},ut=async(t,o)=>{try{if(await j(t,o),F){const n=await M(t);n&&x(n)}}catch(n){console.error("Error toggling ignore state:",n)}},mt=t=>{X(o=>({...o,showRelationsRow:t===!0}))},Le=(t,o)=>{X(n=>{var $;const f=n.fertilityStartConfig??ht(),p=o===!0;if((($=f.methods)==null?void 0:$[t])===p)return n;const S={...f,methods:{...f.methods,[t]:p}};return t==="alemanas"&&p&&(S.calculators={...f.calculators,cpm:!0,t8:!0}),{...n,fertilityStartConfig:S}})},Ae=(t,o)=>{X(n=>{var S;const f=n.fertilityStartConfig??ht(),p=o===!0;return((S=f.calculators)==null?void 0:S[t])===p?n:{...n,fertilityStartConfig:{...f,calculators:{...f.calculators,[t]:p}}}})},Oe=t=>{Object.prototype.hasOwnProperty.call(At,t)&&X(o=>{const n=o.fertilityStartConfig??ht();return n.combineMode===t?o:{...o,fertilityStartConfig:{...n,combineMode:t}}})},He=t=>{X(o=>{const n=o.fertilityStartConfig??ht(),f=t===!0;return n.postpartum===f?o:{...o,fertilityStartConfig:{...n,postpartum:f}}})},Ue=(yt=i==null?void 0:i.state)==null?void 0:yt.fertilityCalculatorCandidates,Se=c==null?void 0:c.fertilityCalculatorCandidates,pe=b.useMemo(()=>{const t=[Array.isArray(Ue)?Ue:null,Array.isArray(Se)?Se:null].find(o=>Array.isArray(o)&&o.length>0);return t?t.map(o=>{if(!o)return null;const{source:n,day:f,reason:p}=o;if(n!=="CPM"&&n!=="T8")return null;const S=Number(f);return Number.isFinite(S)?{source:n,day:S,reason:typeof p=="string"?p:""}:null}).filter(Boolean):null},[Ue,Se]),oe=b.useMemo(()=>{const t=[],o=(n,f,p)=>{const S=Number(f);if(!Number.isFinite(S)||S<=0)return;const $=Number(p),Te=Number.isFinite($)&&$>0,Fe=Te?Number.isInteger($)?`${$}`:`${Number($.toFixed(2))}`:null,a=Te?n==="CPM"?`ciclo base: ${Fe} días`:`base ${$t(n)}: ${Fe}`:null,m=a?`Manual desde dashboard (${a})`:"Manual desde dashboard";t.push({source:n,day:Math.max(1,S),reason:m,kind:"calculator",isManual:!0,manualBase:Te?$:null})};return o("CPM",Q,A),o("T8",de,le),t},[Q,A,de,le]),st=b.useMemo(()=>{const t=Array.isArray(pe)?pe:null;if(!oe.length)return t;const o=new Map;oe.forEach(f=>{const p=Ct(f==null?void 0:f.source);p&&o.set(p,f)});const n=[];return Array.isArray(t)&&t.forEach(f=>{const p=Ct(f==null?void 0:f.source);p&&o.has(p)?(n.push(o.get(p)),o.delete(p)):n.push(f)}),o.forEach(f=>{n.push(f)}),n.length>0?n:t},[pe,oe]),_e=async(t,o=!0)=>{if(!(c!=null&&c.id)||!(t!=null&&t.isoDate))return;const n=p=>{if(p==null||p==="")return null;const S=parseFloat(String(p).replace(",","."));return Number.isFinite(S)?S:null},f=o??!(t.peak_marker==="peak"||t.peakStatus==="P");Be(!0);try{const p=t.timestamp?gt(it(t.timestamp),"HH:mm"):gt(new Date,"HH:mm");let S=Array.isArray(t.measurements)&&t.measurements.length>0?t.measurements:[{temperature:t.temperature_chart??t.temperature_raw??null,temperature_corrected:t.temperature_corrected??null,time:p,time_corrected:t.time_corrected??p,selected:!0,use_corrected:t.use_corrected??!1}];S.length===0&&(S=[{temperature:null,temperature_corrected:null,time:p,time_corrected:p,selected:!0,use_corrected:!1}]);const $=S.map((a,m)=>{const g=a.time||p,L=a.time_corrected||g;return{temperature:n(a.temperature??a.temperature_raw),time:g,selected:m===0?!0:!!a.selected,temperature_corrected:n(a.temperature_corrected),time_corrected:L,use_corrected:!!a.use_corrected}});$.some(a=>a.selected)||($[0].selected=!0);const Te={isoDate:t.isoDate,measurements:$,mucusSensation:t.mucus_sensation??t.mucusSensation??"",mucusAppearance:t.mucus_appearance??t.mucusAppearance??"",fertility_symbol:t.fertility_symbol??"none",observations:t.observations??"",had_relations:t.had_relations??t.hadRelations??!1,ignored:t.ignored??!1,peak_marker:f?"peak":null},Fe=t!=null&&t.id&&!String(t.id).startsWith("placeholder-")?t:null;await h(Te,Fe,c.id)}catch(p){console.error("Error toggling peak marker:",p)}finally{Be(!1)}},Me=async(t,{keepFormOpen:o=!1}={})=>{if(c!=null&&c.id){Be(!0);try{if(await h(t,ne,c.id),F){const n=await M(c.id);n&&x(n)}o||(ge(!1),W(null),We(null))}finally{Be(!1)}}},ze=()=>{ge(!1),W(null),We(null)},R=t=>{W(t)},rt=()=>{pt(t=>!t)},Ke=b.useCallback(()=>{d(null)},[]),at=t=>{if(t.preventDefault(),ye.current){ye.current=!1;return}rt()},nt=t=>{t.pointerType==="touch"&&(t.preventDefault(),ye.current=!0,rt())},xe=b.useCallback((t={})=>{var Fe,a;if(!t)return;const o=t.phase??null,n=t.reasons??{};let f=null,p="",S="",$=[],Te=null;if(o==="relativeInfertile"){p="Inicio de fase relativamente infértil",S="Inicio de ciclo; a la espera de cambio en sensación, moco o cálculo.";const m=(n==null?void 0:n.aggregate)??null,g=Ds(m);g&&($=[g])}else if(o==="fertile"){p="Inicio de fase fértil";const m=Ps(n);S=m?`Inicio de fase fértil por ${m}.`:"Inicio de fase fértil.";const g=(n==null?void 0:n.statusSummary)??null;Array.isArray(g==null?void 0:g.reasonsList)&&g.reasonsList.length>0?$=g.reasonsList:m&&($=[`Motivo principal: ${m}.`]),g!=null&&g.note&&(Te=g.note),typeof(g==null?void 0:g.header)=="string"&&g.header.trim().length>0&&(f=g.header);const L=(n==null?void 0:n.aggregate)??null;if(L){const z=Array.isArray(L.usedCandidates)?L.usedCandidates:[],q=Ht(z,L.selectedDay),Z=(()=>{if(!q)return null;const V=Ct(q.source??q.originalSource),te=q.kind==="calculator",ce=!!q.isManual,Ne=String(q.reason??"").toLowerCase(),we=ce||te&&V&&Ne.includes("manual");return!te||!we?null:$t(q.source??q.originalSource??V)})();if(Z){const V=`Selección ajustada manualmente (${Z}).`;S=S?`${S} ${V}`:V,$=[...$,`Valor manual activo en ${Z}.`]}}}else if(o==="postOvulatory"){const m=Number.isInteger((Fe=n==null?void 0:n.temperature)==null?void 0:Fe.startIndex),g=Number.isInteger((a=n==null?void 0:n.mucus)==null?void 0:a.startIndex);p=m&&g?"Infertilidad absoluta":"Infertilidad",S=`Alcanzada la fase de infertilidad por ${_s(n)}.`,t!=null&&t.message&&($=[t.message]),(n==null?void 0:n.status)==="pending"&&(Te="Pendiente completar el segundo criterio.")}else if(o==="nodata")((n==null?void 0:n.status)??(t==null?void 0:t.status)??null)==="no-fertile-window"?(p="Sin ventana fértil identificable",S="No se ha identificado un inicio fértil claro en este ciclo (ni por moco, ni por calculadora, ni por marcador explícito)."):(p="Sin datos suficientes",S="Añade registros de sensación, moco o temperatura para interpretar el ciclo.");else if(t!=null&&t.message)p=t.message;else return;p&&(!f&&typeof(t==null?void 0:t.message)=="string"&&t.message.trim().length>0&&(f=t.message),d({header:f,title:p,body:S,reasons:$,note:Te}))},[d]),kt=async()=>{var n;const t=document.documentElement,o=typeof window<"u"?(n=window.screen)==null?void 0:n.orientation:null;if(Y){if(o!=null&&o.unlock)try{await o.unlock()}catch(f){console.error(f)}try{const f=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen,p=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;f&&p&&await f.call(document)}catch(f){console.error(f)}Ve("portrait"),Ye(!1)}else{let f=!1,p=!1;try{const S=t.requestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullscreen;p=!!S,S&&(await S.call(t),f=!0)}catch(S){console.error(S)}if(o!=null&&o.lock)try{await o.lock("landscape")}catch(S){console.error(S)}Ve("landscape"),Ye(f||!p)}};return e.jsx(wt,{hideBottomNav:Y,children:e.jsxs("div",{className:Y?"fixed inset-0 z-50 h-[100dvh] w-[100dvw] overflow-y-auto overflow-x-hidden":"relative w-full h-full overflow-y-auto overflow-x-hidden",style:dt,children:[K&&!Y&&e.jsx(lt,{asChild:!0,variant:"ghost",className:"absolute top-4 left-4 z-10 bg-white/80 text-slate-700 hover:bg-[#E27DBF]/20",children:e.jsxs(St,{to:`/cycle/${c.id}`,className:"flex items-center gap-1",children:[e.jsx(us,{className:"h-4 w-4"}),me&&e.jsx("span",{className:"ml-1 text-xs font-semibold text-slate-700 sm:text-sm",children:me})]})}),e.jsx(lt,{onClick:()=>qe(t=>!t),variant:"ghost",size:"icon",className:"absolute top-16 right-4 z-10 p-2 rounded-full bg-white/80 shadow-lg shadow-slate-300/50 text-slate-700 hover:bg-[#E27DBF]/20","aria-label":"Ajustes del gráfico",children:e.jsx(xs,{className:"h-4 w-4"})}),e.jsx(lt,{onClick:at,onPointerUp:nt,variant:"ghost",size:"icon",className:`absolute top-4 right-20 z-10 p-2 rounded-full transition-colors ${Ce?"bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg shadow-pink-300/50 border-pink-400":"bg-white/80 text-slate-600 hover:bg-pink-50/80 shadow-md border-pink-200/50"}`,children:Ce?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(fs,{className:"h-4 w-4"})}),e.jsx(lt,{onClick:kt,className:"absolute top-4 right-4 z-10 bg-white/80 rounded-full text-slate-600 hover:bg-pink-50/80 shadow-md border border-pink-200/50 backdrop-blur-sm","aria-label":Y?"Salir de pantalla completa":"Rotar gráfico",children:e.jsx(ps,{className:"w-4 h-4"})}),e.jsx(Ts,{data:fe,isFullScreen:Y,orientation:ve,onToggleIgnore:ut,onEdit:xt,onTogglePeak:_e,cycleId:c.id,initialScrollIndex:Ge,visibleDays:ee,showInterpretation:Ce,reduceMotion:!0,forceLandscape:ve==="landscape",currentPeakIsoDate:De,showRelationsRow:k.showRelationsRow,fertilityStartConfig:D,fertilityCalculatorCycles:N,fertilityCalculatorCandidates:st,onShowPhaseInfo:xe,isArchivedCycle:!w,cycleEndDate:(c==null?void 0:c.endDate)??null}),Qe&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/30",onClick:()=>qe(!1),"aria-hidden":"true"}),e.jsx("div",{className:`fixed top-0 right-0 z-50 h-dvh w-72 sm:w-80 transform transition-transform duration-300 ease-in-out ${Qe?"translate-x-0":"translate-x-full"}`,role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col gap-6 border-l border-rose-100/60 bg-white p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-700",children:"Ajustes del gráfico"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Personaliza la visualización de filas adicionales en la gráfica."})]}),e.jsx(lt,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-slate-600",onClick:()=>qe(!1),"aria-label":"Cerrar ajustes del gráfico",children:"×"})]}),e.jsxs("div",{className:"space-y-4 overflow-y-auto pr-1",children:[e.jsxs("div",{className:"rounded-xl border border-rose-100/70 bg-rose-50/40 p-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"max-w-xs",children:[e.jsx(ds,{htmlFor:"toggle-relations-row",className:"text-sm font-semibold text-slate-700",children:"Mostrar fila de Relaciones (RS)"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Añade una fila dedicada a las relaciones sexuales debajo de la gráfica."})]}),e.jsx(jt,{id:"toggle-relations-row",checked:k.showRelationsRow,onCheckedChange:mt,className:"mt-1"})]}),e.jsxs("div",{className:"rounded-xl border border-purple-100/70 bg-purple-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Perfiles sintotérmicos"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Activa los métodos que quieras considerar para detectar el inicio fértil."})]}),e.jsx("div",{className:"space-y-2",children:Fs.map(t=>{var o;return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-sm text-slate-700",children:t.label}),e.jsx(jt,{checked:!!((o=D.methods)!=null&&o[t.key]),onCheckedChange:n=>Le(t.key,n)})]},t.key)})})]}),e.jsxs("div",{className:"rounded-xl border border-amber-100/70 bg-amber-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Calculadoras complementarias"}),e.jsx("p",{className:"text-xs text-slate-500",children:"CPM y T-8 se combinan con los perfiles activos, salvo que actives el modo posparto."})]}),D.postpartum&&e.jsx("p",{className:"text-xs font-medium text-rose-500",children:"El modo posparto está activo: CPM y T-8 se omiten del cálculo final."}),e.jsx("div",{className:"space-y-2",children:$s.map(t=>{var o;return e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"text-sm text-slate-700",children:t.label}),e.jsx(jt,{checked:!!((o=D.calculators)!=null&&o[t.key]),onCheckedChange:n=>Ae(t.key,n)})]},t.key)})})]}),e.jsxs("div",{className:"rounded-xl border border-sky-100/70 bg-sky-50/40 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Modo de combinación"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Determina cómo se elige el inicio fértil a partir de los candidatos disponibles."})]}),e.jsxs(ns,{value:D.combineMode,onValueChange:Oe,children:[e.jsx(os,{className:"w-full bg-white/80 border-slate-200 text-sm text-slate-700",children:e.jsx(ls,{placeholder:"Selecciona un modo"})}),e.jsx(is,{className:"bg-white border-slate-200 text-slate-700",children:Object.entries(At).map(([t,o])=>e.jsx(cs,{value:t,className:"text-sm",children:o},t))})]}),e.jsxs("div",{className:"flex items-start justify-between gap-3 pt-1",children:[e.jsxs("div",{className:"max-w-[65%]",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-700",children:"Modo posparto"}),e.jsx("p",{className:"text-xs text-slate-500",children:"Ignora automáticamente CPM y T-8."})]}),e.jsx(jt,{checked:!!D.postpartum,onCheckedChange:He,className:"mt-1"})]})]})]})]})}),e.jsx(ts,{isOpen:!!s,onClose:Ke,ariaLabel:"Detalle de interpretación del ciclo",containerClassName:"p-6",children:s&&e.jsxs("div",{className:"space-y-4 text-left",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[s.header&&e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-pink-600",children:s.header}),e.jsx("h2",{className:"text-lg font-semibold text-slate-800",children:s.title})]}),e.jsx("button",{type:"button",onClick:Ke,className:"rounded-full p-1 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pink-200","aria-label":"Cerrar detalle de interpretación",children:e.jsx(qt,{className:"h-5 w-5"})})]}),s.body&&e.jsx("p",{className:"text-sm leading-relaxed text-slate-600",children:s.body}),Array.isArray(s.reasons)&&s.reasons.length>0&&e.jsx("ul",{className:"list-disc space-y-1 pl-5 text-sm text-slate-600",children:s.reasons.map((t,o)=>e.jsx("li",{children:t},`${t}-${o}`))}),s.note&&e.jsx("p",{className:"text-xs text-slate-500",children:s.note})]})}),e.jsx(rs,{open:T,onOpenChange:t=>{t||ze()},children:e.jsx(as,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Zt,{onSubmit:Me,onCancel:ze,initialData:ne,cycleStartDate:c.startDate,cycleEndDate:c.endDate,isProcessing:ue,isEditing:!!ne&&!ke,cycleData:c.data,onDateSelect:R,initialSectionKey:ct})})})]})})};export{Js as default};
