import{c as Re,r,f as K,j as e,B as me,b as qe,u as Je,p as te,d as Me,s as pe,m as x,e as Ke}from"./index-c55d5272.js";import{C as Qe}from"./CycleDatesEditor-71225023.js";import{i as He,D as Ze,c as et,C as tt,a as at}from"./computePeakStatuses-31c2acae.js";import{u as st,P as rt}from"./badge-537eb28b.js";import{D as De,a as Se,b as We,c as Xe,d as Be,e as $e,u as nt}from"./useCycleData-5dcb71a4.js";import{I as Ye}from"./input-e74c5c89.js";import{C as lt}from"./ChartTooltip-eaa4a487.js";import{L as ot}from"./label-43470110.js";import{P as ze}from"./pen-square-91301378.js";import"./OverlapWarningDialog-c9e8ec86.js";import"./checkbox-423022af.js";import"./eye-eb92638a.js";const it=Re("CalendarPlus",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"19",x2:"19",y1:"16",y2:"22",key:"1ttwzi"}],["line",{x1:"16",x2:"22",y1:"19",y2:"19",key:"1g9955"}]]),ct=Re("FilePlus",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"12",x2:"12",y1:"18",y2:"12",key:"1tsf04"}],["line",{x1:"9",x2:"15",y1:"15",y2:"15",key:"110plj"}]]),ut=Re("HelpCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),Le=({isOpen:a,onClose:M,onConfirm:F,currentCycleStartDate:P})=>{const[Q,ae]=r.useState(K(new Date,"yyyy-MM-dd"));st(a,M);const T=!P,se=()=>{F(Q)},D=T?"":K(new Date(P),"dd/MM/yyyy"),f=(()=>{if(T)return"";const g=new Date(Q);return g.setDate(g.getDate()-1),K(g,"dd/MM/yyyy")})();return e.jsx(De,{open:a,onOpenChange:M,children:e.jsxs(Se,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(We,{children:[e.jsx(Xe,{children:"Iniciar nuevo ciclo"}),e.jsx(Be,{className:"text-gray-600",children:T?"Este será tu primer ciclo. Selecciona la fecha de inicio.":`¿Estás seguro de que quieres iniciar un nuevo ciclo? Los datos del ciclo actual (${D} - ${f}) serán archivados.`})]}),e.jsxs("div",{className:"my-4 space-y-2",children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Fecha de inicio del nuevo ciclo"}),e.jsx(Ye,{id:"startDate",type:"date",value:Q,onChange:g=>ae(g.target.value),max:K(new Date,"yyyy-MM-dd"),min:T?void 0:K(new Date(P),"yyyy-MM-dd"),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),e.jsxs($e,{className:"sm:justify-end",children:[e.jsx(me,{variant:"outline",onClick:M,className:"border-gray-300 text-gray-700 hover:bg-gray-100",children:"Cancelar"}),e.jsx(me,{variant:"primary",onClick:se,className:"bg-pink-600 hover:bg-pink-700 text-white",children:T?"Iniciar ciclo":"Confirmar nuevo ciclo"})]})]})})},dt=({cycleData:a,onEdit:M,onTogglePeak:F,currentPeakIsoDate:P,onEditStartDate:Q=()=>{},formattedCpmValue:ae="-",cpmInfoText:T="Sin datos",handleOpenCpmDialog:se=()=>{}})=>{var ve,we;const D=a.records||[],[f,g]=r.useState(null),[fe,G]=r.useState({clientX:0,clientY:0}),[j,re]=r.useState(0),I=r.useRef(!1),B=r.useRef(null),R=r.useRef(null),A=a.startDate?te(a.startDate):null,he=pe(new Date),Pe=r.useMemo(()=>et(D),[D]),y=28,q=140,o=q+15,h=o*2,le=r.useMemo(()=>{const t=D.reduce((n,l)=>{const d=(l==null?void 0:l.cycleDay)??null;if(d)return Math.max(n,d);if(!A||!(l!=null&&l.isoDate))return n;try{const i=te(l.isoDate),w=Me(i,A)+1;return Number.isFinite(w)?Math.max(n,w):n}catch(i){return console.error("Error calculating record day for wheel:",i),n}},0);return Math.max(a.currentDay,t,y)},[a.currentDay,D,A,y]),z=Math.max(le-y,0),p=z>0;r.useEffect(()=>{if(!p){I.current=!0,re(0);return}re(t=>{const n=Math.min(t,z),l=Math.max(0,Math.min(Math.max(a.currentDay-y,0),z)),d=a.currentDay>=n+1&&a.currentDay<=n+y;return I.current?d?n!==t?n:t:l:(I.current=!0,l)})},[p,z,a.currentDay,y]);const Z=r.useCallback(t=>Math.max(0,Math.min(t,z)),[z]),L=r.useCallback(t=>{!p||t===0||re(n=>Z(n+t))},[Z,p]),xe=r.useCallback(t=>{if(!p)return;t.preventDefault();const n=Math.abs(t.deltaY)>Math.abs(t.deltaX)?t.deltaY:t.deltaX;n!==0&&L(n>0?1:-1)},[L,p]),$=r.useCallback(t=>{var n,l;p&&(B.current=((l=(n=t.touches)==null?void 0:n[0])==null?void 0:l.clientX)??null)},[p]),H=r.useCallback(t=>{var d,i;if(!p||B.current===null)return;const n=((i=(d=t.touches)==null?void 0:d[0])==null?void 0:i.clientX)??null;if(n===null)return;const l=n-B.current;Math.abs(l)<24||(L(l<0?1:-1),B.current=n)},[L,p]),W=r.useCallback(()=>{B.current=null},[]),N=t=>{switch(t){case"red":return{main:"#ef4444",light:"#fee2e2",glow:"rgba(239, 68, 68, 0.3)",border:"none"};case"white":return{main:"#f8fafc",light:"#ffe4e6",glow:"rgba(248, 250, 252, 0.3)",border:"none"};case"green":return{main:"#22c55e",light:"#22c55e",glow:"rgba(34, 197, 94, 0.3)",border:"none"};case"yellow":return{main:"#facc15",light:"#fef08a",glow:"rgba(250, 204, 21, 0.3)",border:"none"};case"spot":return{main:"#ef4444",light:"#ef4444",glow:"rgba(239, 68, 68, 0.3)",border:"#fee2e2",pattern:"url(#spotting-pattern-dashboard)"};default:return{main:"#d1d5db",light:"#f8fafc",glow:"rgba(209, 213, 219, 0.3)",border:"none"}}},X=r.useMemo(()=>D.reduce((t,n)=>{if(!n)return t;const l=Number(n.cycleDay);if(Number.isFinite(l)&&l>0)return t.has(l)||t.set(l,n),t;if(!A||!n.isoDate)return t;try{const d=te(n.isoDate),i=Me(d,A)+1;Number.isFinite(i)&&i>0&&!t.has(i)&&t.set(i,{...n,cycleDay:i})}catch(d){console.error("Error mapping record by day for wheel:",d)}return t},new Map),[D,A]),b=(()=>Array.from({length:y},(t,n)=>{const l=j+n+1,d=X.get(l)??null,i=A?Ke(A,l-1):null,w=i?K(i,"yyyy-MM-dd"):null,k=i?He(pe(i),he):!1,V=d?{...d,cycleDay:d.cycleDay??l}:null,ke=(n+j)/y*2*Math.PI-Math.PI/2,je=o+q*Math.cos(ke),Oe=o+q*Math.sin(ke);let ue=l<=a.currentDay&&V?N(V.fertility_symbol):{main:"#b5b6ba",light:"#c8cacf",glow:"rgba(229, 231, 235, 0.3)"};const Ne=l===a.currentDay;Ne&&(V?ue={...N(V.fertility_symbol),border:"rgba(251, 113, 133, 0.8)"}:ue={main:"transparent",light:"transparent",glow:"rgba(251, 113, 133, 0.4)",border:"rgba(251, 113, 133, 0.8)"});const Te=w&&Pe[w]||null;return{x:je,y:Oe,day:l,colors:ue,isActive:l<=a.currentDay,isToday:Ne,hasRecord:!!V,record:V,isoDate:w,canShowPlaceholder:!!(!V&&w&&!k),peakStatus:Te}}))(),Y=j*360/y,v=-Y*Math.PI/180,ce=Math.cos(v),oe=Math.sin(v),Ee=r.useCallback((t,n)=>{const l=t-o,d=n-o;return{x:o+l*ce-d*oe,y:o+l*oe+d*ce}},[o,ce,oe]),ge=2*Math.PI/y,ie=-Math.PI/2-ge/2,ye=q-18,be=q+10,_=o+ye*Math.cos(ie),Fe=o+ye*Math.sin(ie),J=o+be*Math.cos(ie),Ie=o+be*Math.sin(ie);r.useEffect(()=>{p&&g(null)},[j,p]);const _e=(t,n)=>{if(n.stopPropagation(),!R.current){g(null);return}const l=R.current.getBoundingClientRect();let d,i;n.touches&&n.touches[0]?(d=n.touches[0].clientX,i=n.touches[0].clientY):(d=n.clientX,i=n.clientY);const w=t.canShowPlaceholder&&t.isoDate?{id:`placeholder-${t.isoDate}`,isoDate:t.isoDate,cycleDay:t.day,fertility_symbol:null,mucus_sensation:"",mucusSensation:"",mucus_appearance:"",mucusAppearance:"",observations:"",temperature_chart:null,displayTemperature:null,ignored:!1,peakStatus:t.peakStatus,peak_marker:t.peakStatus==="P"?"peak":null}:null,k=t.record?{...t.record,cycleDay:t.record.cycleDay??t.day,peakStatus:t.peakStatus,peak_marker:t.record.peak_marker??(t.peakStatus==="P"?"peak":null)}:w;if(k&&P&&k.isoDate===P&&(k.peak_marker="peak",k.peakStatus=k.peakStatus||"P"),!k){g(null);return}G({clientX:d-l.left,clientY:i-l.top}),g(k)};return r.useEffect(()=>{if(!f)return;const t=n=>{R.current&&!R.current.contains(n.target)&&g(null)};return document.addEventListener("mousedown",t),document.addEventListener("touchstart",t),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("touchstart",t)}},[f]),e.jsxs("div",{className:"relative flex flex-1 flex-col overflow-y-hidden",children:[e.jsxs(x.div,{className:"px-4 pt-4 pb-3 text-center flex-shrink-0",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 mb-1",children:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("button",{type:"button",onClick:Q,className:"text-sm font-medium text-pink-700 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1.5 inline-flex items-center gap-1.5 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 focus:ring-offset-transparent hover:bg-white/40",title:"Editar fecha de inicio del ciclo",children:[e.jsx(ze,{className:"w-4 h-4"}),"Ciclo actual"]})]}),e.jsxs(x.div,{className:"px-4 flex-grow flex flex-col justify-start mt-2",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:[e.jsxs("div",{className:"text-center mb-3 flex-shrink-0",children:[e.jsxs(x.div,{ref:R,className:"relative inline-flex items-center justify-center mb-4",style:{width:h,height:h},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15,delay:.3},onWheel:xe,onTouchStart:$,onTouchMove:H,onTouchEnd:W,children:[e.jsxs("svg",{className:"w-full h-full",viewBox:`0 0 ${h} ${h}`,onClick:()=>g(null),children:[e.jsxs("defs",{children:[e.jsxs("pattern",{id:"spotting-pattern-dashboard",patternUnits:"userSpaceOnUse",width:"6",height:"6",children:[e.jsx("rect",{width:"6",height:"6",fill:"#ef4444"}),e.jsx("circle",{cx:"3",cy:"3",r:"1.5",fill:"rgba(255,255,255,0.85)"})]}),e.jsxs("radialGradient",{id:"ringGlow",cx:"50%",cy:"50%",r:"50%",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(255,255,255,0.0)"}),e.jsx("stop",{offset:"60%",stopColor:"rgba(244,114,182,0.12)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(190,24,93,0.10)"})]})]}),e.jsx("circle",{cx:o,cy:o,r:q-30,fill:"url(#ringGlow)",stroke:"rgba(255,255,255,0.35)",strokeWidth:"0.5"}),p&&e.jsx("line",{x1:_,y1:Fe,x2:J,y2:Ie,stroke:"rgba(244,63,94,0.55)",strokeWidth:5,strokeLinecap:"round",opacity:.8}),e.jsx(x.g,{transition:{type:"spring",stiffness:100,damping:22},initial:!1,animate:{rotate:-Y},style:{transformOrigin:"center",transformBox:"view-box"},children:b.map((t,n)=>e.jsxs("g",{children:[!(t.isToday&&!t.hasRecord)&&t.isActive&&e.jsx("circle",{cx:t.x+.3,cy:t.y+.3,r:t.isToday?11:10,fill:"rgba(0, 0, 0, 0.2)",opacity:1}),t.isToday&&e.jsx("circle",{cx:t.x,cy:t.y,r:8.5,fill:"none",stroke:"rgba(244,63,94,0.8)",strokeWidth:3,className:"animate-pulse",style:{pointerEvents:"none"}}),e.jsx(x.circle,{cx:t.x,cy:t.y,r:t.isToday?11:10,fill:t.colors.pattern||(t.isActive&&t.hasRecord?t.colors.main:"rgba(255,255,255,0.001)"),stroke:t.colors.border==="none"?"none":t.colors.border||"rgba(158,158,158,0.4)",strokeWidth:t.colors.border==="none"?0:t.isToday?1.8:t.colors.border?.6:.8,onClick:l=>_e(t,l),initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.2,delay:.1,type:"tween",stiffness:400,damping:25},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.2))",cursor:"pointer"}})]},n))}),b.map((t,n)=>{if(!t.peakStatus)return null;const{x:l,y:d}=Ee(t.x,t.y),i={key:`peak-${n}`,x:l,y:d+4,textAnchor:"middle",initial:{scale:.2,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.95+n*.02,type:"spring",stiffness:320,damping:22}};return t.peakStatus==="P"?e.jsx(x.text,{...i,fontSize:"14",fontWeight:"900",fill:"#ec4899",style:{pointerEvents:"none",filter:"drop-shadow(0 2px 4px rgba(244, 114, 182, 0.35))"},children:"✖"}):e.jsx(x.text,{...i,fontSize:"12",fontWeight:"800",fill:"#7f1d1d",style:{pointerEvents:"none"},children:t.peakStatus})})]}),f&&e.jsx("div",{onClick:t=>t.stopPropagation(),children:e.jsx(lt,{point:f,position:fe,chartWidth:((ve=R.current)==null?void 0:ve.clientWidth)||0,chartHeight:((we=R.current)==null?void 0:we.clientHeight)||0,onEdit:M,onClose:()=>g(null),onTogglePeak:F,currentPeakIsoDate:P})}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[e.jsxs(x.div,{className:"text-center  backdrop-blur-md rounded-full p-4",initial:{opacity:0,scale:.5},animate:{opacity:1,scale:1},transition:{delay:1,type:"spring",stiffness:200},style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.1))"},children:[e.jsx("span",{className:"text-5xl font-bold text-pink-700 block",children:a.currentDay}),e.jsx("span",{className:"text-800 text-pink-700 font-medium mt-0.5 block",children:"día del ciclo"})]}),e.jsx(x.div,{className:"mt-2 px-2.5 py-1  backdrop-blur-sm rounded-full border border-pink-200",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.3},style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.1))"},children:e.jsx("span",{className:"text-md font-medium text-pink-900",children:a.currentDay<=7?"Menstrual":a.currentDay<=14?"Folicular":a.currentDay<=21?"Ovulatoria":"Lútea"})})]})]}),p&&e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>L(-1),disabled:j===0,children:e.jsx(tt,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",j+1]}),e.jsx("span",{className:"text-xs text-rose-400",children:"•"}),e.jsxs("span",{className:"text-xs font-medium text-rose-500",children:["Día ",Math.min(j+y,le)]})]}),e.jsx("input",{type:"range",min:0,max:z,value:j,onChange:t=>re(Z(Number(t.target.value))),className:"w-44 accent-rose-500"})]}),e.jsx("button",{type:"button",className:"p-2 rounded-full bg-white/60 text-rose-500 shadow-sm border border-rose-200/60 transition hover:bg-white",onClick:()=>L(1),disabled:j===z,children:e.jsx(at,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mx-2 mb-6 mt-2 flex-shrink-0",children:[e.jsxs(x.div,{className:"relative bg-gradient-to-br from-pink-50/90 to-rose-50/90 backdrop-blur-md rounded-3xl p-4 border border-pink-200/30",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.5},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.08))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.7)"},children:[e.jsx("h3",{className:"font-bold mb-4 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Símbolos"}),e.jsx("div",{className:"grid grid-cols-2 gap-2.5",children:[{label:"Menstrual",color:"#ef4444"},{label:"Moco (Fértil)",color:"#f8fafc",stroke:"#c2c6cc"},{label:"Seco (Rel. Infértil)",color:"#22c55e"},{label:"Moco (No fértil)",color:"#facc15",stroke:"#fef08a"},{label:"Spotting",color:"#ef4444",stroke:"#fee2e2",pattern:!0},{label:"Hoy",isToday:!0}].map(t=>e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[t.isToday?e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border border-rose-400/80 bg-transparent"}),e.jsx("div",{className:"absolute inset-0 -m-1 rounded-full border-[3px] border-rose-500/80 animate-pulse"})]}):e.jsx("div",{className:`w-4 h-4 rounded-full border ${t.pattern?"pattern-bg":""}`,style:{backgroundColor:t.color,borderColor:t.stroke||"transparent"}}),e.jsx("span",{className:`text-xs font-medium text-center leading-none ${t.isToday?"text-gray-700 font-semibold":"text-gray-700"}`,children:t.label})]},t.label))}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-300/40 to-rose-400/40 rounded-full"})]}),e.jsxs(x.div,{className:"relative bg-gradient-to-br from-pink-50/70 to-rose-50/50 backdrop-blur-md rounded-3xl p-4 border border-pink-200/40",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.4,delay:.6},style:{filter:"drop-shadow(0 8px 25px rgba(236,72,153,0.1))",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.8)"},children:[e.jsx("h3",{className:"font-bold mb-3 text-gray-800 flex items-center gap-2 justify-center text-xs tracking-wide uppercase",children:"Cálculo"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"CPM"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"flex w-full items-center justify-center gap-4",children:e.jsxs("button",{type:"button",onClick:se,className:"group relative flex h-16 w-16 flex-col items-center justify-center rounded-full bg-gradient-to-br from-white via-pink-50/30 to-rose-50/40 text-pink-700 shadow-lg backdrop-blur-xl transition-all duration-300 hover:shadow-xl hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2 focus:ring-offset-transparent border border-pink-200/40",children:[e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-pink-300/0 group-hover:border-pink-300/30 transition-all duration-300 animate-pulse"}),e.jsx(ze,{className:"absolute top-1 right-1 w-2.5 h-2.5 text-pink-400/60 group-hover:text-pink-500/80 transition-colors"}),e.jsx("span",{className:"text-lg font-bold group-hover:scale-110 transition-transform duration-200",children:ae})]})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:[e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"}),e.jsx("div",{className:"font-bold text-pink-800 text-xs",children:"T-8"}),e.jsx("div",{className:"w-1 h-1 bg-pink-400 rounded-full"})]}),e.jsx("div",{className:"bg-white/60 backdrop-blur-sm px-3 py-1.5 rounded-full border border-gray-200/50 shadow-sm",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"Sin datos"})})]})]}),e.jsx("div",{className:"absolute top-3 right-4 w-2 h-2 bg-gradient-to-br from-pink-500/40 to-rose-400/40 rounded-full"})]})]})]})]})},mt=({onAddRecord:a,onAddCycle:M})=>{const[F,P]=r.useState(!1);return e.jsxs("div",{className:"fixed bottom-[calc(var(--bottom-nav-height)+1rem)] right-6 flex flex-col items-end space-y-3 z-50",children:[F&&e.jsxs(e.Fragment,{children:[e.jsxs(x.button,{onClick:M,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white shadow-lg",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(147, 51, 234, 0.3))"},children:[e.jsx(it,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Nuevo ciclo"})]}),e.jsxs(x.button,{onClick:a,className:"flex items-center gap-3 px-4 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg",whileTap:{scale:.8},whileHover:{scale:1.05},initial:{opacity:0,y:20,scale:.8},animate:{opacity:1,y:0,scale:1},style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(ct,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium tracking-tight",children:"Añadir registro"})]})]}),e.jsx(x.button,{onClick:()=>P(!F),className:"w-14 h-14 bg-gradient-to-br from-pink-500 to-rose-500 text-white rounded-full shadow-lg flex items-center justify-center",whileTap:{scale:.95},whileHover:{scale:1.05},initial:{scale:0},animate:{scale:1},style:{filter:"drop-shadow(0 6px 16px rgba(236, 72, 153, 0.4))"},children:e.jsx(x.span,{animate:{rotate:F?135:0},transition:{type:"spring",stiffness:260,damping:20},children:e.jsx(rt,{className:"h-6 w-6"})})})]})},Ct=()=>{const{currentCycle:a,archivedCycles:M,addOrUpdateDataPoint:F,startNewCycle:P,isLoading:Q,updateCycleDates:ae,checkCycleOverlap:T,forceUpdateCycleStart:se,refreshData:D}=nt(),{toast:f}=qe(),[g,fe]=r.useState(!1),[G,j]=r.useState(()=>(a==null?void 0:a.startDate)||""),[re,I]=r.useState(""),[B,R]=r.useState(null),[A,he]=r.useState(null),[Pe,y]=r.useState(!1),[q,ne]=r.useState(!1),{user:o,preferences:h,savePreferences:le}=Je(),[z,p]=r.useState(!1),[Z,L]=r.useState(""),[xe,$]=r.useState(""),[H,W]=r.useState(null),[N,X]=r.useState(!1),ee=r.useRef(!1),b=r.useMemo(()=>o!=null&&o.uid?`rnf_manual_cpm_${o.uid}`:null,[o==null?void 0:o.uid]);r.useEffect(()=>{ee.current=!1},[b]);const Y=r.useCallback(async s=>{if(!(o!=null&&o.uid)||!le)return;const c=s==null?{manualCpm:null}:{manualCpm:Number(s)};try{await le(c),b&&typeof window<"u"&&(c.manualCpm===null?localStorage.removeItem(b):localStorage.setItem(b,JSON.stringify({value:c.manualCpm})))}catch(u){throw console.error("Failed to persist manual CPM value in profile",u),u}},[b,le,o==null?void 0:o.uid]);r.useEffect(()=>{if(!b){W(null),X(!1),ee.current=!1;return}const s=h==null?void 0:h.manualCpm;if(typeof s=="number"&&Number.isFinite(s)){if(W(s),X(!0),typeof window<"u")try{localStorage.setItem(b,JSON.stringify({value:s}))}catch(c){console.error("Failed to sync manual CPM value to local storage",c)}return}if(s===null&&(W(null),X(!1),typeof window<"u"))try{localStorage.removeItem(b)}catch(c){console.error("Failed to clear manual CPM value from local storage",c)}},[b,h==null?void 0:h.manualCpm]),r.useEffect(()=>{if(!b||ee.current||!(o!=null&&o.uid))return;if((h==null?void 0:h.manualCpm)!==void 0){ee.current=!0;return}if(typeof window>"u"){ee.current=!0;return}try{const c=localStorage.getItem(b);if(c){const u=JSON.parse(c);u&&typeof u.value=="number"&&Number.isFinite(u.value)&&(W(u.value),X(!0),Y(u.value).catch(U=>console.error("Failed to migrate manual CPM value to profile storage",U)))}}catch(c){console.error("Failed to restore manual CPM value from local storage",c)}finally{ee.current=!0}},[b,Y,h==null?void 0:h.manualCpm,o==null?void 0:o.uid]),r.useEffect(()=>{j((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate]);const v=r.useMemo(()=>{const s=[];Array.isArray(M)&&M.length>0&&M.forEach((E,O)=>{s.push({...E,displayName:E.name||`Ciclo archivado ${O+1}`,source:"archived"})}),a!=null&&a.id&&s.push({...a,displayName:a.name||"Ciclo actual",source:"current"});const c=s.map(E=>{if(!E.startDate||!E.endDate)return null;try{const O=te(E.startDate),S=te(E.endDate);if(Number.isNaN(O.getTime())||Number.isNaN(S.getTime())||He(O,S))return null;const de=Me(pe(S),pe(O))+1;return!Number.isFinite(de)||de<=0?null:{...E,duration:de}}catch(O){return console.error("Failed to compute cycle duration for CPM calculation",O),null}}).filter(Boolean),u=c.length;if(u<6)return{value:null,cycleCount:u,shortestCycle:null,deduction:null};const m=[...c].sort((E,O)=>E.duration-O.duration)[0],C=u>=12?20:21;return{value:m.duration-C,cycleCount:u,shortestCycle:m,deduction:C}},[M,a]),ce=r.useMemo(()=>{const s=N?H:v.value;return typeof s!="number"||!Number.isFinite(s)?"-":s.toLocaleString("es-ES",{maximumFractionDigits:2})},[v.value,N,H]),oe=r.useMemo(()=>{var U,m,C;if(N)return"Incorporado manualmente";if(v.cycleCount<6)return"Sin ciclos suficientes";const s=((U=v.shortestCycle)==null?void 0:U.displayName)||((m=v.shortestCycle)==null?void 0:m.name)||"Ciclo sin nombre",c=(C=v.shortestCycle)==null?void 0:C.duration,u=typeof c=="number"&&Number.isFinite(c)?`${c} días`:"duración desconocida";return`Calculado con ${v.cycleCount} ciclos. ${s} (${u}).`},[v,N]),Ee=r.useCallback(()=>{const s=N?H:typeof v.value=="number"&&Number.isFinite(v.value)?v.value:"";L(s===""?"":String(s)),$(""),p(!0)},[v.value,N,H]),ge=r.useCallback(()=>{p(!1)},[]),ie=r.useCallback(s=>{L(s.target.value),$("")},[]),ye=r.useCallback(async()=>{const s=Z.trim();if(!s){$("Introduce un valor numérico válido.");return}const c=s.replace(",","."),u=Number.parseFloat(c);if(!Number.isFinite(u)||u<0){$("Introduce un valor numérico válido mayor o igual a 0.");return}const U=H,m=N;W(u),X(!0);try{await Y(u),p(!1),f({title:"CPM actualizado",description:"El CPM manual se guardó en tu perfil."})}catch(C){console.error("Failed to save manual CPM value",C),W(U),X(m),$("No se pudo guardar el CPM. Inténtalo de nuevo.")}},[N,Z,H,Y,f]),be=r.useCallback(async()=>{const s=H,c=N;W(null),X(!1),L(""),$("");try{await Y(null),p(!1),f({title:"CPM restablecido",description:"El cálculo automático volverá a mostrarse."})}catch(u){console.error("Failed to reset manual CPM value",u),W(s),X(c),$("No se pudo restablecer el CPM. Inténtalo de nuevo.")}},[N,H,Y,f]),_=r.useCallback(()=>{R(null),he(null),y(!1)},[]),Fe=r.useCallback(()=>{j((a==null?void 0:a.startDate)||""),I(""),_(),fe(!0)},[a==null?void 0:a.startDate,_]),J=r.useCallback(()=>{fe(!1),I(""),_(),j((a==null?void 0:a.startDate)||"")},[a==null?void 0:a.startDate,_]),Ie=r.useCallback(()=>{_()},[_]),_e=r.useCallback(async()=>{if(!G){I("La fecha de inicio es obligatoria");return}if(a!=null&&a.id){I(""),ne(!0);try{const s=T?await T(a.id,G):null;if(s){R(G),he(s),y(!0),ne(!1);return}await ae(a.id,G),await D({silent:!0}),f({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),J()}catch(s){console.error("Error updating start date from dashboard:",s),I("No se pudo actualizar la fecha de inicio"),f({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{ne(!1)}}},[G,a==null?void 0:a.id,T,ae,D,f,J]),ve=r.useCallback(async()=>{if(!(a!=null&&a.id)||!B){_();return}ne(!0),y(!1);try{await se(a.id,B),await D({silent:!0}),f({title:"Fecha de inicio actualizada",description:"El ciclo se ha ajustado a la nueva fecha de inicio."}),J()}catch(s){console.error("Error forcing start date from dashboard:",s),I("No se pudo actualizar la fecha de inicio"),f({title:"Error",description:"No se pudo actualizar la fecha de inicio.",variant:"destructive"})}finally{ne(!1),_()}},[a==null?void 0:a.id,B,se,D,f,J,_]),[we,t]=r.useState(!1),[n,l]=r.useState(!1),[d,i]=r.useState(!1),[w,k]=r.useState(null),V=!!(w&&String(w.id||"").startsWith("placeholder-")),ke=r.useMemo(()=>{var c;const s=(c=a==null?void 0:a.data)==null?void 0:c.find(u=>(u==null?void 0:u.peak_marker)==="peak");return(s==null?void 0:s.isoDate)||null},[a==null?void 0:a.data]),je=r.useCallback(()=>{t(!1),k(null)},[]),Oe=r.useCallback(s=>{k(s)},[]),ue=r.useCallback(s=>{k(s),t(!0)},[]),Ne=r.useCallback(async(s,c=!0)=>{if(!(a!=null&&a.id)||!(s!=null&&s.isoDate))return;const u=m=>{if(m==null||m==="")return null;const C=parseFloat(String(m).replace(",","."));return Number.isFinite(C)?C:null},U=c??!(s.peak_marker==="peak"||s.peakStatus==="P");try{const m=s.timestamp?K(te(s.timestamp),"HH:mm"):K(new Date,"HH:mm");let C=Array.isArray(s.measurements)&&s.measurements.length>0?s.measurements:[{temperature:s.temperature_chart??s.temperature_raw??null,temperature_corrected:s.temperature_corrected??null,time:s.time??m,time_corrected:s.time_corrected??m,selected:!0,use_corrected:s.use_corrected??!1}];C.length===0&&(C=[{temperature:null,temperature_corrected:null,time:m,time_corrected:m,selected:!0,use_corrected:!1}]);const Ce=C.map((S,de)=>{const Ae=S.time||m,Ge=S.time_corrected||Ae;return{temperature:u(S.temperature??S.temperature_raw),time:Ae,selected:de===0?!0:!!S.selected,temperature_corrected:u(S.temperature_corrected),time_corrected:Ge,use_corrected:!!S.use_corrected}});Ce.some(S=>S.selected)||(Ce[0].selected=!0);const E={isoDate:s.isoDate,measurements:Ce,mucusSensation:s.mucus_sensation??s.mucusSensation??"",mucusAppearance:s.mucus_appearance??s.mucusAppearance??"",fertility_symbol:s.fertility_symbol??"none",observations:s.observations??"",ignored:s.ignored??!1,peak_marker:U?"peak":null},O=s!=null&&s.id&&!String(s.id).startsWith("placeholder-")?s:null;await F(E,O)}catch(m){console.error("Error toggling peak marker from dashboard:",m)}},[F,a==null?void 0:a.id]);if(Q&&!(a!=null&&a.id))return e.jsx("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:e.jsx("p",{className:"text-center text-gray-600 text-lg",children:"Cargando..."})});if(!(a!=null&&a.id))return e.jsxs("div",{className:"flex h-full flex-col items-center justify-center bg-gradient-to-br ffrom-rose-100 via-pink-100 to-rose-100",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-gray-600 text-lg",children:"No hay ciclo activo."}),e.jsx("button",{onClick:()=>i(!0),className:"px-6 py-3 rounded-lg bg-pink-600 hover:bg-pink-700 text-white shadow",children:"Iniciar ciclo"})]}),e.jsx(Le,{isOpen:d,onClose:()=>i(!1),onConfirm:async s=>{await P(s),i(!1),t(!0)}})]});const Te=Me(pe(new Date),te(a.startDate))+1,Ve=async(s,{keepFormOpen:c=!1}={})=>{l(!0);try{await F(s,w),c||(t(!1),k(null))}finally{l(!1)}},Ue=async s=>{await P(s),i(!1),t(!0)};return e.jsxs("div",{className:"relative flex h-full flex-col overflow-hidden bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"max-w-md mx-auto flex w-full flex-1 flex-col",children:e.jsxs(x.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"flex flex-1 flex-col",children:[e.jsx(dt,{cycleData:{...a,currentDay:Te,records:a.data},onEdit:ue,onTogglePeak:Ne,currentPeakIsoDate:ke,onEditStartDate:Fe,formattedCpmValue:ce,cpmInfoText:oe,handleOpenCpmDialog:Ee}),e.jsx(De,{open:z,onOpenChange:s=>{s||ge()},children:e.jsxs(Se,{className:"w-[90vw] max-w-sm rounded-3xl border border-pink-100 bg-white/95 text-gray-800 shadow-xl",children:[e.jsxs(We,{className:"space-y-2 text-left",children:[e.jsx(Xe,{children:"Editar CPM"}),e.jsx(Be,{children:"Personaliza el CPM introduciendo un valor manual. Si no se establece, se calculará automáticamente"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"rounded-2xl border border-rose-100 bg-rose-50/70 px-3 py-2.5 text-[11px] text-rose-900",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ut,{className:"mt-0.5 h-4 w-4 text-rose-500"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-rose-700",children:"Origen del dato"}),e.jsx("p",{className:"leading-snug text-rose-600",children:oe})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ot,{htmlFor:"manual-cpm-input",className:"text-xs text-gray-600",children:"CPM manual"}),e.jsx(Ye,{id:"manual-cpm-input",type:"number",inputMode:"decimal",min:"0",step:"0.1",value:Z,onChange:ie,placeholder:"Introduce un valor"}),xe&&e.jsx("p",{className:"text-xs text-red-500",children:xe})]})]}),e.jsxs($e,{className:"sm:flex-row sm:items-center sm:justify-between",children:[e.jsx(me,{type:"button",variant:"ghost",onClick:be,disabled:!N,className:"text-pink-600 hover:text-pink-700 disabled:text-gray-400",children:"Restablecer automático"}),e.jsxs("div",{className:"flex w-full items-center justify-end gap-2 sm:w-auto",children:[e.jsx(me,{type:"button",variant:"secondary",onClick:ge,children:"Cancelar"}),e.jsx(me,{type:"button",onClick:ye,children:"Guardar"})]})]})]})}),e.jsx(De,{open:g,onOpenChange:s=>{s||J()},children:e.jsx(Se,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Qe,{cycle:a,startDate:G,endDate:a.endDate,onStartDateChange:s=>j(s),onSave:_e,onCancel:J,isProcessing:q,dateError:re,includeEndDate:!1,showOverlapDialog:Pe,overlapCycle:A,onConfirmOverlap:ve,onCancelOverlap:Ie,onClearError:()=>I(""),saveLabel:"Guardar cambios",title:"Editar fecha de inicio",description:"Selecciona una nueva fecha de inicio para el ciclo actual. Los registros se reorganizarán automáticamente.",className:"w-full"})})})]})}),e.jsx(De,{open:we,onOpenChange:s=>{s?t(!0):je()},children:e.jsx(Se,{hideClose:!0,className:"bg-transparent border-none p-0 text-gray-800 w-[90vw] sm:w-auto max-w-md sm:max-w-lg md:max-w-xl max-h-[85vh] overflow-y-auto",children:e.jsx(Ze,{onSubmit:Ve,onCancel:je,initialData:w,cycleStartDate:a.startDate,cycleEndDate:a.endDate,isProcessing:n,isEditing:!!w&&!V,cycleData:a.data,onDateSelect:Oe})})}),e.jsx(mt,{onAddRecord:()=>{k(null),t(!0)},onAddCycle:()=>i(!0)}),e.jsx(Le,{isOpen:d,onClose:()=>i(!1),onConfirm:Ue,currentCycleStartDate:a.startDate})]})};export{Ct as default};
