import{c as fe,r,j as e,B as I,g as S,f as o,b as he,a as me,m as G,A as se,L as pe,C as te,o as ge}from"./index-2f41c8cd.js";import{D as ye,a as ve,b as je,c as be,d as Ne,e as we,u as Ce}from"./useCycleData-9f76d19f.js";import{u as De,P as ae,e as re,B as Se}from"./badge-4c7d2230.js";import{I as le}from"./input-c95d25ec.js";import{O as Me}from"./OverlapWarningDialog-038e0dd4.js";import{D as ke}from"./DeletionDialog-31da8265.js";const Ae=fe("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),X=({isOpen:N,onClose:w,onConfirm:R,initialStartDate:M,initialEndDate:g,includeEndDate:f=!0,title:H="Editar Fechas del Ciclo",description:V,cycleId:q,checkOverlap:B,errorMessage:k,conflictCycle:h,onResetError:y})=>{const[t,A]=r.useState(M||""),[i,C]=r.useState(g||""),[$,v]=r.useState(""),[n,j]=r.useState(null),[x,D]=r.useState(null),[E,T]=r.useState(!1);De(N,w),r.useEffect(()=>{A(M||""),C(g||"")},[M,g]);const W=()=>{if(!h)return null;const l=F=>{if(!F)return null;try{return S(o(F),"dd/MM/yyyy")}catch(K){return console.error("Error formatting conflict date",K),F}},m=l(h.startDate)??"sin fecha de inicio",z=h.endDate?l(h.endDate):"en curso";return`Conflicto con el ciclo del ${m} al ${z}.`},J=()=>{v(""),y&&y()},u=l=>{A(l),J()},O=l=>{C(l),v(""),y&&y()},b=W(),Y=async()=>{if(f&&!i){v("La fecha de fin es obligatoria");return}if(f&&t&&i&&i<t){v("La fecha de fin no puede ser anterior al inicio");return}const l=f?{startDate:t,endDate:i}:{startDate:t};if(B&&q&&t){const m=await B(q,t,f&&i||void 0);if(m){j(m),D(l),T(!0);return}}R(l)};return e.jsxs(e.Fragment,{children:[e.jsx(ye,{open:N,onOpenChange:w,children:e.jsxs(ve,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(je,{children:[e.jsx(be,{children:H}),e.jsx(Ne,{className:"text-gray-600",children:V??(f?"Modifica la fecha de inicio y fin del ciclo.":"Modifica la fecha de inicio del ciclo.")})]}),(k||h)&&e.jsxs("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[e.jsx("p",{className:"font-semibold text-red-800",children:"No se pudo guardar el ciclo"}),k&&e.jsx("p",{className:"mt-1",children:k}),b&&e.jsx("p",{className:"mt-1",children:b}),e.jsx("p",{className:"mt-3 text-xs text-red-600",children:"Ajusta las fechas para que no se superpongan con ciclos existentes."})]}),e.jsxs("div",{className:"my-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Inicio del ciclo"}),e.jsx(le,{id:"startDate",type:"date",value:t,onChange:l=>u(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"})]}),f&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"text-gray-700 text-sm",children:"Fin del ciclo"}),e.jsx(le,{id:"endDate",type:"date",value:i||"",onChange:l=>O(l.target.value),className:"bg-gray-50 border-gray-200 text-gray-800"}),$&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:$})]})]}),e.jsxs(we,{className:"sm:justify-end",children:[e.jsx(I,{variant:"outline",onClick:w,className:"border-gray-300 text-titulo hover:bg-gray-100",children:"Cancelar"}),e.jsx(I,{variant:"primary",onClick:Y,className:"bg-pink-600 hover:bg-pink-700 text-white",children:"Guardar"})]})]})}),e.jsx(Me,{isOpen:E,conflictCycle:n,onCancel:()=>T(!1),onConfirm:()=>{T(!1),x&&R({...x,force:!0})}})]})},Ie=()=>{const{currentCycle:N,archivedCycles:w,isLoading:R,addArchivedCycle:M,updateCycleDates:g,deleteCycle:f,checkCycleOverlap:H,forceUpdateCycleStart:V,forceShiftNextCycleStart:q}=Ce(),{toast:B}=he(),k=me(),[h,y]=r.useState(!1),[t,A]=r.useState(null),[i,C]=r.useState(null),[$,v]=r.useState(!1),[n,j]=r.useState(null),[x,D]=r.useState(null),[E,T]=r.useState("all"),[W,J]=r.useState(!1),u=r.useRef(null),O=r.useRef(!1),b=r.useRef(!1),Y=s=>{if(!s)return"Las fechas ingresadas se superponen con otro ciclo.";const a=p=>{if(!p)return null;try{return S(o(p),"dd/MM/yyyy")}catch(U){return console.error("Error parsing conflict date",U),p}},d=a(s.startDate)??"sin fecha de inicio",c=s.endDate?a(s.endDate):"en curso";return`Las fechas ingresadas se superponen con el ciclo del ${d} al ${c}.`},l=()=>{j(null),y(!0)},m=()=>{y(!1),j(null)},z=async({startDate:s,endDate:a})=>{try{await M(s,a),m()}catch(d){const c=d.code==="cycle-overlap"?Y(d.conflictCycle):"No se pudo crear el ciclo.";j({message:c,conflictCycle:d.conflictCycle||null})}},F=async({startDate:s,endDate:a,force:d})=>{if(t)try{const c=t.startDate,p=t.endDate,U=s!==void 0&&s!==c,de=a!==void 0&&a!==p,ue=U&&c&&s&&o(s)<o(c),xe=U?s:c,ee=de?a:p;d&&ue?(await V(t.id,s),a!==void 0&&await g(t.id,void 0,a)):d&&ee?(await q(t.id,ee,xe),await g(t.id,s,a)):await g(t.id,s,a),A(null),D(null)}catch(c){const p=c.code==="cycle-overlap"?Y(c.conflictCycle):"No se pudieron actualizar las fechas.";D({message:p,conflictCycle:c.conflictCycle||null})}},K=s=>{C(s)},ie=async()=>{if(i){v(!0);try{await f(i.id),B({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),C(null)}catch(s){console.error("Error deleting archived cycle:",s)}finally{v(!1)}}},ne=s=>{k(s.isCurrent?"/":`/cycle/${s.id}`)},Z=s=>{O.current=!1,u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{O.current=!0,K(s)},1500)},L=(s,a=!0)=>{u.current&&(clearTimeout(u.current),u.current=null),!O.current&&a&&ne(s)};r.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]);const P=N.id?[{...N,isCurrent:!0,needsCompletion:!N.endDate},...w]:w,oe=P&&P.length>0;if(R&&!oe)return e.jsx("div",{className:"relative flex h-full flex-col items-center justify-center overflow-hidden",children:e.jsx("div",{className:"text-center text-slate-600 p-8",children:"Cargando ciclos archivados..."})});if(!P||P.length===0)return e.jsxs("div",{className:"relative flex h-full flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"flex flex-1 items-center justify-center px-4",children:e.jsx(G.div,{className:"text-center text-slate-600 flex flex-col items-center max-w-md",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"bg-white/70 mt-6 backdrop-blur-md rounded-3xl p-8 border border-pink-200/50 shadow-sm",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center",children:e.jsx(se,{className:"w-10 h-10 text-subtitulo"})}),e.jsx("h2",{className:"text-2xl font-semibold text-subtitulo mb-4",children:"No hay ciclos archivados"}),e.jsx("p",{className:"text-subtitulo mb-8",children:"Cuando inicies un nuevo ciclo, el anterior aparecerá aquí."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(I,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl hover:brightness-95 text-white shadow-sm",children:e.jsx(pe,{to:"/",children:"Volver al Ciclo Actual"})}),e.jsxs(I,{onClick:l,className:"bg-fertiliapp-fuerte hover:brightness-95 rounded-3xl text-white shadow-sm",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"})," Crear Ciclo"]})]})]})})}),e.jsx(X,{isOpen:h,onClose:m,onConfirm:z,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:n==null?void 0:n.message,conflictCycle:n==null?void 0:n.conflictCycle,onResetError:()=>j(null)})]});const Q=[...P].sort((s,a)=>o(a.startDate)-o(s.startDate)),ce=Array.from(new Set(Q.map(s=>{try{return o(s.startDate).getFullYear()}catch(a){return console.error("Error parsing startDate for year filter",a),null}}).filter(Boolean))).sort((s,a)=>a-s),_=E==="all"?Q:Q.filter(s=>{try{return o(s.startDate).getFullYear()===Number(E)}catch(a){return console.error("Error filtering cycle by year",a),!1}});return e.jsxs("div",{className:"relative flex min-h-screen flex-col overflow-hidden",children:[e.jsx("div",{className:"relative z-10 flex flex-1",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 py-6 flex flex-col h-full",children:[e.jsxs(G.div,{className:"flex items-center justify-between gap-3 mb-6",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-subtitulo flex items-center",children:[e.jsx(se,{className:"mr-3 h-8 w-8 text-subtitulo"}),"Mis Ciclos"]}),e.jsxs("div",{className:"flex flex-row items-center gap-3",children:[e.jsxs(I,{onClick:l,className:"flex-shrink-0 text-md font-semibold rounded-full bg-white/90 border border-secundario hover:brightness-95 text-secundario shadow-sm px-2",style:{filter:"drop-shadow(0 6px 12px rgba(236, 72, 153, 0.3))"},children:[e.jsx(ae,{className:"mr-1 h-4 w-4"})," Ciclo"]}),e.jsx("button",{type:"button",onClick:()=>J(s=>!s),className:"inline-flex h-10 w-10 items-center justify-center rounded-full border border-fertiliapp-fuerte bg-white/90 shadow-sm hover:bg-white","aria-label":"Filtrar por año",children:e.jsx(Ae,{className:"h-5 w-5 text-fertiliapp-fuerte"})})]})]}),W&&e.jsx("div",{className:"mb-4 flex w-full justify-center",children:e.jsxs("div",{className:"flex w-full max-w-md items-center gap-2 rounded-3xl border border-fertiliapp-suave bg-white/90 px-3 py-2 shadow-sm",children:[e.jsx("span",{className:"text-xs font-medium text-slate-700",children:"Año"}),e.jsxs("select",{id:"year-filter",value:E,onChange:s=>T(s.target.value),className:"flex-1 rounded-3xl border border-pink-100 bg-white px-3 py-2 text-sm text-slate-700 shadow-inner focus:outline-none focus:ring-2 focus:ring-pink-300",children:[e.jsx("option",{value:"all",children:"Todos"}),ce.map(s=>e.jsx("option",{value:s,children:s},s))]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-1 sm:pr-0 pb-6",children:e.jsxs(G.div,{className:"space-y-4 px-1",variants:{hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"show",children:[_.map(s=>{const a=s.endDate?S(o(s.endDate),"dd/MM/yyyy",{locale:re}):"En curso",d=s.data?s.data.length:0;return e.jsx(G.button,{type:"button",className:"w-full max-w-[480px] mx-auto bg-white/80 backdrop-blur-md border border-fertiliapp-suave shadow-sm hover:shadow-sm transition-all duration-300 hover:bg-white/90 rounded-3xl active:scale-[0.98] cursor-pointer select-none",variants:{hidden:{opacity:0,y:20},show:{opacity:1,y:0}},onMouseDown:()=>Z(s),onMouseUp:()=>L(s),onMouseLeave:()=>L(s,!1),onTouchStart:()=>{b.current=!1,Z(s)},onTouchMove:()=>{b.current=!0,L(s,!1)},onTouchEnd:()=>{b.current?(b.current=!1,L(s,!1)):L(s,!0)},children:e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"w-12 h-12 bg-fertiliapp-suave rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(te,{className:"w-6 h-6 text-fertiliapp-fuerte"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center flex-wrap gap-2 mb-1.5",children:e.jsxs("h2",{className:"text-lg font-semibold text-slate-700",children:[S(o(s.startDate),"dd/MM/yyyy",{locale:re})," - ",a]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-2 text-sm text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ge,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[d," registro",d!==1?"s":""]})]}),s.endDate&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(te,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[Math.ceil((o(s.endDate)-o(s.startDate))/(1e3*60*60*24))+1," días"]})]}),s.isCurrent&&e.jsx(Se,{className:"bg-fertiliapp-fuerte text-white text-xs",children:"Ciclo actual"})]})]})]})})},s.id)}),_.length===0&&e.jsx("div",{className:"mt-6 rounded-3xl border border-dashed border-fertiliapp-suave bg-white/70 p-6 text-center text-slate-600 shadow-inner",children:"No hay ciclos para el año seleccionado."})]})})]})}),e.jsx(X,{isOpen:h,onClose:m,onConfirm:z,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",errorMessage:n==null?void 0:n.message,conflictCycle:n==null?void 0:n.conflictCycle,onResetError:()=>j(null)}),e.jsx(X,{isOpen:!!t,onClose:()=>{A(null),D(null)},onConfirm:F,initialStartDate:t==null?void 0:t.startDate,initialEndDate:t==null?void 0:t.endDate,cycleId:t==null?void 0:t.id,checkOverlap:H,title:"Editar Fechas del Ciclo",description:"Actualiza las fechas del ciclo.",errorMessage:x==null?void 0:x.message,conflictCycle:x==null?void 0:x.conflictCycle,onResetError:()=>D(null)}),e.jsx(ke,{isOpen:!!i,onClose:()=>C(null),onConfirm:ie,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:i?`¿Estás seguro de que quieres eliminar el ciclo ${S(o(i.startDate),"dd/MM/yyyy")} - ${i.endDate?S(o(i.endDate),"dd/MM/yyyy"):"En curso"}? Esta acción no se puede deshacer.`:"",isProcessing:$})]})};export{Ie as default};
