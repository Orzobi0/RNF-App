import{c as ye,r as l,j as e,B as L,k as C,C as ae,o as ie,f as c,g as pe,b as ge,a as ve,m as ee,A as Ce,L as je,q as be,t as Ne}from"./index-Do8Ydwb3.js";import{D as we,a as De,b as Se,c as Ee,d as Me,e as Ae,i as ke,u as Oe}from"./useCycleData-Dq0sFEDe.js";import{H as Pe,a as Te}from"./HeaderIconButton-B7WKOykb.js";import{l as J,i as te,B as Re}from"./badge-DykpjFnT.js";import{u as Be,b as de,c as ue,d as fe,e as he,i as Fe,P as xe}from"./useBackClose-CETyKRQ2.js";import{O as Le,D as Ie}from"./DeletionDialog-eRV-pJhK.js";const $e=ye("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),ce=({isOpen:E,onClose:M,onConfirm:K,initialStartDate:I,initialEndDate:$,includeEndDate:j=!0,title:se="Editar Fechas del Ciclo",description:re,cycleId:A,checkOverlap:q,errorMessage:k,conflictCycle:n,onResetError:w,cycleData:y=[],otherCycles:O=[]})=>{const[p,H]=l.useState(I||""),[u,g]=l.useState($||""),[z,x]=l.useState(""),[Y,le]=l.useState(null),[Q,ne]=l.useState(null),[m,D]=l.useState(!1);Be(E,M),l.useEffect(()=>{H(I||""),g($||"")},[I,$]);const P=()=>{if(!n)return null;const t=d=>{if(!d)return null;try{return C(c(d),"dd/MM/yyyy")}catch(F){return console.error("Error formatting conflict date",F),d}},s=t(n.startDate)??"sin fecha de inicio",o=n.endDate?t(n.endDate):"en curso";return`Conflicto con el ciclo del ${s} al ${o}.`},X=()=>{x(""),w&&w()},Z=t=>{H(t),X()},U=t=>{g(t),x(""),w&&w()},V=P(),v=t=>{if(!t)return null;const s=c(t);return pe(s)?ie(s):null},T=v(p),R=v(u),_=(y??[]).map(t=>v(t?.isoDate)).filter(Boolean),G=O.find(t=>t?.id===A),f=v(G?.startDate),h=v(G?.endDate),b=f?{from:f,to:h??f}:void 0,N=(t,s)=>!!(s?.from&&te(t,s.from)),B=(t,s)=>s?.to?te(t,s.to)&&!te(s.from,s.to):!1,S=(t,s)=>!s?.from||!s?.to||te(s.from,s.to)?!1:ke(t,s.from)&&Fe(t,s.to),a=(t,s,o)=>s.some(d=>o(t,d)),r=(O??[]).filter(t=>t?.id&&t.id!==A).map(t=>{const s=v(t?.startDate),o=v(t?.endDate);return s?{from:s,to:o??s}:null}).filter(Boolean),i=async()=>{if(j&&!u){x("La fecha de fin es obligatoria");return}if(j&&p&&u&&u<p){x("La fecha de fin no puede ser anterior a la fecha de inicio.");return}const t=j?{startDate:p,endDate:u}:{startDate:p};if(q&&A&&p){const s=await q(A,p,j&&u||void 0);if(s){le(s),ne(t),D(!0);return}}K(t)};return e.jsxs(e.Fragment,{children:[e.jsx(we,{open:E,onOpenChange:M,children:e.jsxs(De,{className:"bg-white border-pink-100 text-gray-800",children:[e.jsxs(Se,{children:[e.jsx(Ee,{children:se}),e.jsx(Me,{className:"text-gray-600",children:re??(j?"Modifica la fecha de inicio y fin del ciclo.":"Modifica la fecha de inicio del ciclo.")})]}),(k||n)&&e.jsxs("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[e.jsx("p",{className:"font-semibold text-red-800",children:"No se pudo guardar el ciclo"}),k&&e.jsx("p",{className:"mt-1",children:k}),V&&e.jsx("p",{className:"mt-1",children:V}),e.jsx("p",{className:"mt-3 text-xs text-red-600",children:"Ajusta las fechas para que no se superpongan con ciclos existentes."})]}),e.jsxs("div",{className:"my-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"text-gray-700 text-sm",children:"Inicio del ciclo"}),e.jsxs(de,{children:[e.jsx(ue,{asChild:!0,children:e.jsxs(L,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-gray-200 bg-gray-50 text-left font-normal text-gray-800",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),T?C(T,"PPP",{locale:J}):"Selecciona una fecha"]})}),e.jsx(fe,{className:"w-auto p-0",align:"start",children:e.jsx(he,{mode:"single",selected:T,onSelect:t=>{t&&Z(C(ie(t),"yyyy-MM-dd"))},locale:J,initialFocus:!0,defaultMonth:T??f??new Date,enableSwipeNavigation:!0,modifiers:{hasRecord:_,inActiveCycleStart:t=>N(t,b),inActiveCycleMiddle:t=>S(t,b),inActiveCycleEnd:t=>B(t,b),inOtherCycleStart:t=>a(t,r,N),inOtherCycleMiddle:t=>a(t,r,S),inOtherCycleEnd:t=>a(t,r,B)},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycleStart:"in-cycle-range-start",inActiveCycleMiddle:"in-cycle-range-middle",inActiveCycleEnd:"in-cycle-range-end",inOtherCycleStart:"in-other-cycle-range-start",inOtherCycleMiddle:"in-other-cycle-range-middle",inOtherCycleEnd:"in-other-cycle-range-end"}})})]})]}),j&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"text-gray-700 text-sm",children:"Fin del ciclo"}),e.jsxs(de,{children:[e.jsx(ue,{asChild:!0,children:e.jsxs(L,{type:"button",variant:"outline",className:"mt-1 w-full justify-start border-gray-200 bg-gray-50 text-left font-normal text-gray-800",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),R?C(R,"PPP",{locale:J}):"Selecciona una fecha"]})}),e.jsx(fe,{className:"w-auto p-0",align:"start",children:e.jsx(he,{mode:"single",selected:R,onSelect:t=>{t&&U(C(ie(t),"yyyy-MM-dd"))},locale:J,initialFocus:!0,defaultMonth:R??h??f??new Date,enableSwipeNavigation:!0,modifiers:{hasRecord:_,inActiveCycleStart:t=>N(t,b),inActiveCycleMiddle:t=>S(t,b),inActiveCycleEnd:t=>B(t,b),inOtherCycleStart:t=>a(t,r,N),inOtherCycleMiddle:t=>a(t,r,S),inOtherCycleEnd:t=>a(t,r,B)},modifiersClassNames:{hasRecord:'relative after:content-[""] after:absolute after:inset-x-0 after:bottom-1 after:mx-auto after:h-1.5 after:w-1.5 after:rounded-full after:bg-fertiliapp-fuerte',inActiveCycleStart:"in-cycle-range-start",inActiveCycleMiddle:"in-cycle-range-middle",inActiveCycleEnd:"in-cycle-range-end",inOtherCycleStart:"in-other-cycle-range-start",inOtherCycleMiddle:"in-other-cycle-range-middle",inOtherCycleEnd:"in-other-cycle-range-end"}})})]}),z&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:z})]})]}),e.jsxs(Ae,{className:"sm:justify-end",children:[e.jsx(L,{variant:"outline",onClick:M,className:"border-gray-300 text-titulo hover:bg-gray-100",children:"Cancelar"}),e.jsx(L,{variant:"primary",onClick:i,className:"bg-pink-600 hover:bg-pink-700 text-white",children:"Guardar"})]})]})}),e.jsx(Le,{isOpen:m,conflictCycle:Y,onCancel:()=>D(!1),onConfirm:()=>{D(!1),Q&&K({...Q,force:!0})}})]})},Ge=()=>{const{currentCycle:E,archivedCycles:M,isLoading:K,addArchivedCycle:I,updateCycleDates:$,deleteCycle:j,checkCycleOverlap:se}=Oe(),{toast:re}=ge(),A=ve(),[q,k]=l.useState(!1),[n,w]=l.useState(null),[y,O]=l.useState(null),[p,H]=l.useState(!1),[u,g]=l.useState(null),[z,x]=l.useState(null),[Y,le]=l.useState("all"),[Q,ne]=l.useState(!1),m=l.useRef(null),D=l.useRef(!1),P=l.useRef(!1),X=a=>{if(!a)return"Las fechas ingresadas se superponen con otro ciclo.";const r=s=>{if(!s)return null;try{return C(c(s),"dd/MM/yyyy")}catch(o){return console.error("Error parsing conflict date",o),s}},i=r(a.startDate)??"sin fecha de inicio",t=a.endDate?r(a.endDate):"en curso";return`Las fechas ingresadas se superponen con el ciclo del ${i} al ${t}.`},Z=()=>{g(null),k(!0)},U=()=>{k(!1),g(null)},V=async({startDate:a,endDate:r})=>{if(a&&r&&c(r)<c(a)){g({message:"La fecha de fin no puede ser anterior a la fecha de inicio.",conflictCycle:null});return}try{await I(a,r),U()}catch(i){const t=i.code==="cycle-overlap"?X(i.conflictCycle):"No se pudo crear el ciclo.";g({message:t,conflictCycle:i.conflictCycle||null})}},v=async({startDate:a,endDate:r,force:i})=>{if(n)try{const t=n.startDate,s=n.endDate,o=a!==void 0&&a!==t,d=r!==void 0&&r!==s,F=o?a:t,W=d?r:s;if(F&&W&&c(W)<c(F)){x({message:"La fecha de fin no puede ser anterior a la fecha de inicio.",conflictCycle:null});return}await $(n.id,a,r),w(null),x(null)}catch(t){const s=t.code==="cycle-overlap"?X(t.conflictCycle):"No se pudieron actualizar las fechas.";x({message:s,conflictCycle:t.conflictCycle||null})}},T=a=>{O(a)},R=async()=>{if(y){H(!0);try{await j(y.id),re({title:"Ciclo eliminado",description:"El ciclo ha sido eliminado."}),O(null)}catch(a){console.error("Error deleting archived cycle:",a)}finally{H(!1)}}},_=a=>{A(a.isCurrent?"/":`/cycle/${a.id}`)},G=a=>{D.current=!1,m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{D.current=!0,T(a)},1500)},f=(a,r=!0)=>{m.current&&(clearTimeout(m.current),m.current=null),!D.current&&r&&_(a)};l.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]);const h=E.id?[{...E,isCurrent:!0,needsCompletion:!E.endDate},...M]:M,b=h&&h.length>0;if(K&&!b)return e.jsx("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col items-center justify-center overflow-hidden",children:e.jsx("div",{className:"text-center text-slate-600 p-8",children:"Cargando ciclos archivados..."})});if(!h||h.length===0)return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col bg-gradient-to-br from-rose-100 via-pink-100 to-rose-100",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",style:{background:"radial-gradient(65% 55% at 50% 32%, rgba(244,114,182,0.18) 0%, rgba(244,114,182,0.12) 35%, rgba(244,114,182,0.06) 60%, rgba(244,114,182,0) 100%)"}}),e.jsx("div",{className:"flex flex-1 items-center justify-center px-4",children:e.jsx(ee.div,{className:"text-center text-slate-600 flex flex-col items-center max-w-md",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"bg-white/70 mt-6 backdrop-blur-md rounded-3xl p-8 border border-pink-200/50 shadow-sm",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center",children:e.jsx(Ce,{className:"w-10 h-10 text-subtitulo"})}),e.jsx("h2",{className:"text-2xl font-semibold text-subtitulo mb-4",children:"No hay ciclos archivados"}),e.jsx("p",{className:"text-subtitulo mb-8",children:"Cuando inicies un nuevo ciclo, el anterior aparecerá aquí."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(L,{asChild:!0,className:"bg-fertiliapp-fuerte rounded-3xl hover:brightness-95 text-white shadow-sm",children:e.jsx(je,{to:"/",children:"Volver al Ciclo Actual"})}),e.jsxs(L,{onClick:Z,className:"bg-fertiliapp-fuerte hover:brightness-95 rounded-3xl text-white shadow-sm",children:[e.jsx(xe,{className:"mr-2 h-4 w-4"})," Crear Ciclo"]})]})]})})}),e.jsx(ce,{isOpen:q,onClose:U,onConfirm:V,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",otherCycles:h,errorMessage:u?.message,conflictCycle:u?.conflictCycle,onResetError:()=>g(null)})]});const N=[...h].sort((a,r)=>c(r.startDate)-c(a.startDate)),B=Array.from(new Set(N.map(a=>{try{return c(a.startDate).getFullYear()}catch(r){return console.error("Error parsing startDate for year filter",r),null}}).filter(Boolean))).sort((a,r)=>r-a),S=Y==="all"?N:N.filter(a=>{try{return c(a.startDate).getFullYear()===Number(Y)}catch(r){return console.error("Error filtering cycle by year",r),!1}});return e.jsxs("div",{className:"relative flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col overflow-hidden",children:[e.jsx("div",{className:"relative z-10 flex flex-1",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 py-6 flex h-[calc(var(--app-vh,1vh)*100 - var(--bottom-nav-safe))] flex-col",children:[e.jsx(ee.div,{className:"mb-4",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsx("div",{className:"rounded-3xl border border-fertiliapp-suave bg-white/80 p-3 shadow-sm backdrop-blur-md",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1",children:[e.jsx("div",{className:"flex min-w-0 items-center gap-2",children:e.jsx("span",{className:"truncate text-[21px] font-semibold leading-tight text-titulo",children:"Mis ciclos"})}),e.jsx("div",{className:"truncate text-[13px] text-base",children:"Historial de ciclos"})]}),e.jsxs("div",{className:"flex shrink-0 items-center gap-2",children:[e.jsxs(Pe,{type:"button",onClick:Z,"aria-label":"Añadir ciclo",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Añadir ciclo"})]}),e.jsx(Te,{type:"button",onClick:()=>ne(a=>!a),"aria-label":"Filtrar por año",children:e.jsx($e,{className:"h-5 w-5"})})]})]})})}),Q&&e.jsx("div",{className:"mb-4 flex w-full justify-center",children:e.jsxs("div",{className:"flex w-full max-w-md items-center gap-2 rounded-3xl border border-fertiliapp-suave bg-white/90 px-3 py-2 shadow-sm",children:[e.jsx("span",{className:"text-xs font-medium text-slate-700",children:"Año"}),e.jsxs("select",{id:"year-filter",value:Y,onChange:a=>le(a.target.value),className:"flex-1 rounded-3xl border border-pink-100 bg-white px-3 py-2 text-sm text-slate-700 shadow-inner focus:outline-none focus:ring-2 focus:ring-fertiliapp",children:[e.jsx("option",{value:"all",children:"Todos"}),B.map(a=>e.jsx("option",{value:a,children:a},a))]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-1 sm:pr-0 pb-6",children:e.jsxs(ee.div,{className:"space-y-3 px-1",variants:{hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"show",children:[S.map(a=>{const r=me=>C(me,"dd MMM yy",{locale:J}),i=a.startDate?c(a.startDate):null,t=a.endDate?c(a.endDate):null,s=!!t,o=i&&t&&t<i?t:i,d=i&&t&&t<i?i:t,F=s&&d?r(d):"En curso",W=a.data?a.data.length:0,oe=o&&d?Math.max(1,be(d,o)+1):null;return e.jsx(ee.button,{type:"button",className:"w-full max-w-[480px] mx-auto bg-white/80 backdrop-blur-md border border-fertiliapp-suave shadow-md hover:shadow-sm transition-all duration-300 hover:bg-white/90 rounded-3xl active:scale-[0.98] cursor-pointer select-none",variants:{hidden:{opacity:0,y:20},show:{opacity:1,y:0}},onMouseDown:()=>G(a),onMouseUp:()=>f(a),onMouseLeave:()=>f(a,!1),onTouchStart:()=>{P.current=!1,G(a)},onTouchMove:()=>{P.current=!0,f(a,!1)},onTouchEnd:()=>{P.current?(P.current=!1,f(a,!1)):f(a,!0)},children:e.jsx("div",{className:"p-2.5",children:e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"w-10 h-10 bg-fertiliapp-fuerte rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ae,{className:"w-5 h-5 text-white"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsxs("h2",{className:"truncate text-[15px] font-semibold text-slate-700",children:[o?r(o):""," - ",F]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 text-[12px] text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Ne,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[W," registro",W!==1?"s":""]})]}),a.endDate&&oe&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ae,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{children:[oe," días"]})]}),a.isCurrent&&e.jsx(Re,{className:"rounded-full bg-fertiliapp-fuerte px-2 py-0.5 text-[11px] text-white",children:"Ciclo actual"})]})]})]})})},a.id)}),S.length===0&&e.jsx("div",{className:"mt-6 rounded-3xl border border-dashed border-fertiliapp-suave bg-white/70 p-6 text-center text-slate-600 shadow-inner",children:"No hay ciclos para el año seleccionado."})]})})]})}),e.jsx(ce,{isOpen:q,onClose:U,onConfirm:V,title:"Añadir Ciclo Anterior",description:"Ingresa las fechas de un ciclo previo para añadir registros.",otherCycles:h,errorMessage:u?.message,conflictCycle:u?.conflictCycle,onResetError:()=>g(null)}),e.jsx(ce,{isOpen:!!n,onClose:()=>{w(null),x(null)},onConfirm:v,initialStartDate:n?.startDate,initialEndDate:n?.endDate,cycleId:n?.id,checkOverlap:se,title:"Editar Fechas del Ciclo",description:"Actualiza las fechas del ciclo.",cycleData:n?.data??[],otherCycles:h,errorMessage:z?.message,conflictCycle:z?.conflictCycle,onResetError:()=>x(null)}),e.jsx(Ie,{isOpen:!!y,onClose:()=>O(null),onConfirm:R,title:"Eliminar ciclo",confirmLabel:"Eliminar ciclo",description:y?`¿Estás seguro de que quieres eliminar el ciclo ${C(c(y.startDate),"dd/MM/yyyy")} - ${y.endDate?C(c(y.endDate),"dd/MM/yyyy"):"En curso"}? Esta acción no se puede deshacer.`:"",isProcessing:p})]})};export{Ge as default};
